<!DOCTYPE html>
<html lang="tr">
<head>
  <!-- ... head içeriği aynı kalacak ... -->
</head>
<body class="bg-gray-50 text-gray-800 p-4">

<!-- Kullanıcı Bilgileri -->
<div class="user-info-container">
  <div class="flex items-center">
    <div class="user-status user-status-online"></div>
    <div class="user-avatar">
      <i class="fas fa-user"></i>
    </div>
  </div>
  <div class="user-details">
    <div id="userName" class="user-name">Yükleniyor...</div>
    <div id="userRole" class="user-role">Rol: Yükleniyor...</div>
  </div>
</div>

<!-- ... diğer HTML içeriği aynı kalacak ... -->

<script>
  // Supabase yapılandırması
  const SUPABASE_URL = "https://xliutvspwodhoaxvysks.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsaXV0dnNwd29kaG9heHZ5c2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTgyOTksImV4cCI6MjA3MjkzNDI5OX0.Zodisa_ifP8t2Q4X0ecnB56RiR_Bg4QS5gvPn5ZLK_w";
  
  // Supabase'i başlat
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  // DOM elementlerini seçme
  const $ = id => document.getElementById(id);
  
  // Kullanıcı ve satıcı bilgileri
  let currentUser = null;
  let currentUserRole = null;
  let currentUserData = null;
  let sellers = [];
  let selectedSellerId = null;
  let imageFiles = [];
  let existingImages = [];
  let gtipData = [];
  let allProducts = [];
  let currentEditingProductId = null;
  
  // Yükleniyor
  document.addEventListener("DOMContentLoaded", async () => {
    // Oturum kontrolü
    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
    
    if (sessionError) {
      console.error("Oturum kontrolü hatası:", sessionError);
      showToast("Oturum kontrolü sırasında hata oluştu", "error");
      return;
    }
    
    if (!session) {
      window.location.href = "login.html";
      return;
    }
    
    currentUser = session.user;
    
    try {
      // Kullanıcı bilgilerini veritabanından al
      const { data: userData, error: userError } = await supabase
        .from('users')
        .select('*')
        .eq('id', currentUser.id)
        .single();
      
      if (userError) {
        console.error("Kullanıcı bilgileri alınamadı:", userError);
        showToast("Kullanıcı bilgileri alınamadı", "error");
        return;
      }
      
      currentUserRole = userData.role;
      currentUserData = userData;
      
      // Kullanıcı bilgilerini arayüzde göster
      $('userName').textContent = userData.name || userData.email;
      $('userRole').textContent = `Rol: ${currentUserRole === 'admin' ? 'Yönetici' : 'Satıcı'}`;
      
      // Kullanıcı bilgilerini localStorage'a kaydet
      localStorage.setItem('userInfo', JSON.stringify(userData));
      
      // Veritabanı şemasını kontrol et ve gerekli tabloları oluştur
      await checkAndCreateTables();
      
      // Admin ise satıcı filtreleme alanını göster
      if (currentUserRole === 'admin') {
        $('adminSellerFilter').classList.remove('hidden');
        $('adminSellerContainer').classList.remove('hidden');
        await loadSellers();
      }
      
      // GTIP verilerini yükle
      await loadGtipData();
      
      // Ürünleri yükle
      await loadProducts();
      
      // Event listener'ları ekle
      setupEventListeners();
      
    } catch (error) {
      console.error("Başlatma hatası:", error);
      showToast("Sistem başlatılırken hata oluştu", "error");
    }
  });

  // ... diğer fonksiyonlar aynı kalacak ...

  // Ürünleri yükle
  async function loadProducts() {
    try {
      let query = supabase.from('products').select('*');
      
      if (selectedSellerId) {
        // Belirli bir satıcının ürünlerini getir
        query = query.eq('seller_id', selectedSellerId);
      } else if (currentUserRole === 'admin') {
        // Admin ise tüm ürünleri getir
        // Hiçbir filtre uygulanmaz
      } else {
        // Satıcı ise sadece kendi ürünlerini getir
        query = query.eq('seller_id', currentUser.id);
      }
      
      const { data, error } = await query;
      
      if (error) {
        console.error('Ürünler yüklenirken hata:', error);
        showToast('Ürünler yüklenirken hata oluştu', 'error');
        return;
      }
      
      const productsList = $('productsList');
      productsList.innerHTML = '';
      allProducts = data || [];
      
      // Ürün sayacını güncelle
      $('productCount').textContent = allProducts.length;
      
      if (allProducts.length === 0) {
        productsList.innerHTML = `
          <tr>
            <td colspan="9" class="p-4 text-center text-gray-500">
              Henüz ürün bulunmamaktadır
            </td>
          </tr>
        `;
        return;
      }
      
      allProducts.forEach(product => {
        const seller = sellers.find(s => s.id === product.seller_id) || {};
        
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        
        // Görsel hücresi - ilk görseli küçük resim olarak göster
        let imageCellContent = '';
        if (product.images && product.images.length > 0) {
          imageCellContent = `
            <img src="${product.images[0]}" class="product-image" 
                 alt="${product.name || ''}"
                 onclick="openImageModal('${product.images[0]}')">
          `;
        } else {
          imageCellContent = `
            <div class="w-16 h-16 bg-gray-200 rounded flex items-center justify-center">
              <i class="fas fa-image text-gray-400"></i>
            </div>
          `;
        }
        
        tr.innerHTML = `
          <td class="p-3">${imageCellContent}</td>
          <td class="p-3 font-medium">${product.name || ''}</td>
          <td class="p-3">${seller.company_name || seller.name || 'Bilinmiyor'}</td>
          <td class="p-3">${product.barcod_no || ''}</td>
          <td class="p-3">${product.gtipno || ''}</td>
          <td class="p-3">${product.price || 0} ${product.currency || 'TL'}</td>
          <td class="p-3">${product.stock || 0}</td>
          <td class="p-3">
            <span class="status-badge ${product.is_active ? 'status-active' : 'status-inactive'}">
              ${product.is_active ? 'Aktif' : 'Pasif'}
            </span>
          </td>
          <td class="p-3">
            <div class="flex space-x-2">
              <button class="btn btn-secondary btn-sm btnEditProduct">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-danger btn-sm btnDeleteProduct">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        `;
        
        // Düzenleme butonuna event listener ekle
        tr.querySelector('.btnEditProduct').addEventListener('click', () => {
          openProductModal(product);
        });
        
        // Silme butonuna event listener ekle
        tr.querySelector('.btnDeleteProduct').addEventListener('click', () => {
          deleteProduct(product.id);
        });
        
        productsList.appendChild(tr);
      });
      
    } catch (error) {
      console.error('Ürünler yüklenirken hata:', error);
      showToast('Ürünler yüklenirken hata oluştu', 'error');
    }
  }

  // ... diğer fonksiyonlar aynı kalacak ...

  // Ürün kaydet
  async function saveProduct() {
    // Form doğrulama
    if (!validateForm()) {
      showToast('Lütfen gerekli alanları doldurun', 'error');
      return;
    }
    
    // Doğru sellerId'yi belirle
    let sellerId, sellerName;
    if (currentUserRole === 'admin') {
      sellerId = $('modalSellerSelect').value;
      if (!sellerId) {
        showToast('Lütfen bir satıcı seçin', 'error');
        return;
      }
      
      // Seçilen satıcının bilgilerini al
      const selectedSeller = sellers.find(s => s.id === sellerId);
      sellerName = selectedSeller?.company_name || selectedSeller?.name || '';
    } else {
      sellerId = currentUser.id;
      sellerName = currentUserData?.company_name || currentUserData?.name || currentUser.email;
    }
    
    // Kaydet butonunu devre dışı bırak
    $('saveProductBtn').disabled = true;
    $('saveProductBtn').innerHTML = '<div class="loading-spinner"></div> Kaydediliyor...';
    
    try {
      // Görselleri yükle (bu örnekte mevcut görselleri koruyoruz, gerçek uygulamada yükleme yapılmalı)
      const imageUrls = [...existingImages];
      
      // Yeni görselleri yükleme işlemi buraya eklenmeli
      // Örnek: imageUrls.push(await uploadImage(file));
      
      let productData = {
        name: $('p_name').value.trim(),
        barcod_no: $('p_barcod_no').value.trim(),
        gtipno: $('p_gtipno').value.trim(),
        sku: $('p_sku').value.trim(),
        brand: $('p_brand').value.trim(),
        categories: $('p_categories').value.trim(),
        price: parseFloat($('p_price').value) || 0,
        currency: $('p_currency').value,
        stock: parseInt($('p_stock').value) || 0,
        vat: parseFloat($('p_vat').value) || 0,
        description: $('p_description').value.trim(),
        is_active: $('p_isActive').value === 'true',
        seller_id: sellerId,
        seller_name: sellerName,
        images: imageUrls,
        updated_at: new Date().toISOString()
      };
      
      if (currentEditingProductId) {
        // Mevcut ürünü güncelle
        const { error } = await supabase
          .from('products')
          .update(productData)
          .eq('id', currentEditingProductId);
        
        if (error) {
          throw new Error('Ürün güncellenemedi: ' + error.message);
        }
        
        showToast('Ürün başarıyla güncellendi', 'success');
      } else {
        // Yeni ürün ekle
        productData.created_at = new Date().toISOString();
        
        const { error } = await supabase
          .from('products')
          .insert([productData]);
        
        if (error) {
          throw new Error('Ürün eklenemedi: ' + error.message);
        }
        
        showToast('Ürün başarıyla eklendi', 'success');
      }
      
      closeProductModal();
      loadProducts();
    } catch (error) {
      console.error('Ürün kaydedilirken hata:', error);
      showToast('Ürün kaydedilirken hata oluştu: ' + error.message, 'error');
    } finally {
      // Kaydet butonunu tekrar etkinleştir
      $('saveProductBtn').disabled = false;
      $('saveProductBtn').innerHTML = '<i class="fas fa-save mr-1"></i>Kaydet';
    }
  }
</script>
</body>
</html>