<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel — Gelişmiş Ürün Yönetimi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Supabase entegrasyonu -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* CSS stilleri aynı kalacak */
    :root {
      --primary-color: #4f46e5;
      --primary-hover: #4338ca;
      --success-color: #10b981;
      --danger-color: #ef4444;
      --warning-color: #f59e0b;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ... diğer stiller aynı ... */
  </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4">

<!-- Kullanıcı Bilgileri -->
<div class="user-info-container">
  <div class="flex items-center">
    <div class="user-status user-status-online"></div>
    <div class="user-avatar">
      <i class="fas fa-user"></i>
    </div>
  </div>
  <div class="user-details">
    <div id="userName" class="user-name">Yükleniyor...</div>
    <div id="userRole" class="user-role">Rol: Yükleniyor...</div>
  </div>
</div>

<!-- ... HTML içeriği aynı ... -->

<script>
  // Supabase yapılandırması
  const SUPABASE_URL = "https://xliutvspwodhoaxvysks.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsaXV0dnNwd29kaG9heHZ5c2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTgyOTksImV4cCI6MjA3MjkzNDI5OX0.Zodisa_ifP8t2Q4X0ecnB56RiR_Bg4QS5gvPn5ZLK_w";
  
  // Supabase'i başlat
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  // DOM elementlerini seçme
  const $ = id => document.getElementById(id);
  
  // Kullanıcı ve satıcı bilgileri
  let currentUser = null;
  let currentUserRole = null;
  let currentUserData = null;
  let sellers = [];
  let selectedSellerId = null;
  let imageFiles = [];
  let existingImages = [];
  let gtipData = [];
  let allProducts = [];
  let currentEditingProductId = null;
  
  // Yükleniyor
  document.addEventListener("DOMContentLoaded", async () => {
    console.log("Sayfa yükleniyor...");
    
    try {
      // Önce oturumu kontrol et
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      
      if (sessionError) {
        console.error("Oturum kontrolü hatası:", sessionError);
        showToast("Oturum kontrolü sırasında hata oluştu", "error");
        setTimeout(() => window.location.href = "login.html", 2000);
        return;
      }
      
      if (!session) {
        console.log("Oturum bulunamadı, login sayfasına yönlendiriliyor...");
        window.location.href = "login.html";
        return;
      }
      
      currentUser = session.user;
      console.log("Oturum açık, kullanıcı:", currentUser);
      
      // Kullanıcı bilgilerini al
      await getUserData();
      
      // Admin ise satıcı filtreleme alanını göster
      if (currentUserRole === 'admin') {
        $('adminSellerFilter').classList.remove('hidden');
        $('adminSellerContainer').classList.remove('hidden');
        await loadSellers();
      }
      
      // GTIP verilerini yükle
      await loadGtipData();
      
      // Ürünleri yükle
      await loadProducts();
      
      // Event listener'ları ekle
      setupEventListeners();
      
      console.log("Sayfa başarıyla yüklendi");
      
    } catch (error) {
      console.error("Başlatma hatası:", error);
      showToast("Sistem başlatılırken hata oluştu: " + error.message, "error");
    }
  });

  // Kullanıcı verilerini alma fonksiyonu - YENİ DÜZENLENMİŞ VERSİYON
  async function getUserData() {
    try {
      console.log("Kullanıcı verileri alınıyor...");
      
      // Önce localStorage'dan kontrol et
      const storedUserInfo = localStorage.getItem('userInfo');
      if (storedUserInfo) {
        try {
          const userInfo = JSON.parse(storedUserInfo);
          if (userInfo && userInfo.id) {
            console.log("Kullanıcı bilgileri localStorage'dan alındı:", userInfo);
            currentUserRole = userInfo.role;
            currentUserData = userInfo;
            
            // Kullanıcı bilgilerini arayüzde göster
            $('userName').textContent = userInfo.name || userInfo.email;
            $('userRole').textContent = `Rol: ${currentUserRole === 'admin' ? 'Yönetici' : 'Satıcı'}`;
            return;
          }
        } catch (e) {
          console.warn("LocalStorage verisi bozuk, yeniden alınıyor...");
        }
      }
      
      console.log("Veritabanından kullanıcı bilgileri alınıyor...");
      
      // users tablosundan kullanıcı bilgilerini al
      const { data: userData, error: userError } = await supabase
        .from('users')
        .select('*')
        .eq('id', currentUser.id)
        .single();
      
      if (userError) {
        console.error("Users tablosundan kullanıcı bilgileri alınamadı:", userError);
        
        // Auth tablosundan temel bilgileri al
        const { data: authUser, error: authError } = await supabase.auth.getUser();
        
        if (authError) {
          console.error("Auth kullanıcı bilgileri alınamadı:", authError);
          throw new Error("Kullanıcı bilgileri alınamadı");
        }
        
        // Temel kullanıcı bilgilerini oluştur
        currentUserRole = 'seller'; // Varsayılan rol
        currentUserData = {
          id: authUser.user.id,
          email: authUser.user.email,
          name: authUser.user.email.split('@')[0], // E-posta'dan isim oluştur
          role: 'seller'
        };
        
        console.log("Auth'dan temel kullanıcı bilgileri alındı:", currentUserData);
        
        // Kullanıcı bilgilerini arayüzde göster
        $('userName').textContent = currentUserData.name;
        $('userRole').textContent = `Rol: Satıcı`;
        
        // Basit kullanıcı bilgilerini localStorage'a kaydet
        localStorage.setItem('userInfo', JSON.stringify(currentUserData));
        return;
      }
      
      // Users tablosundan başarıyla veri alındı
      currentUserRole = userData.role;
      currentUserData = userData;
      
      console.log("Kullanıcı bilgileri users tablosundan alındı:", userData);
      
      // Kullanıcı bilgilerini arayüzde göster
      $('userName').textContent = userData.name || userData.email;
      $('userRole').textContent = `Rol: ${currentUserRole === 'admin' ? 'Yönetici' : 'Satıcı'}`;
      
      // Kullanıcı bilgilerini localStorage'a kaydet
      localStorage.setItem('userInfo', JSON.stringify(userData));
      
    } catch (error) {
      console.error("Kullanıcı verileri alınırken hata:", error);
      
      // Hata durumunda bile temel bilgileri göster
      if (currentUser) {
        $('userName').textContent = currentUser.email || "Kullanıcı";
        $('userRole').textContent = "Rol: Bilinmiyor";
        
        // Acil durum bilgilerini kaydet
        currentUserRole = 'seller';
        currentUserData = {
          id: currentUser.id,
          email: currentUser.email,
          name: currentUser.email?.split('@')[0] || 'Kullanıcı',
          role: 'seller'
        };
        
        localStorage.setItem('userInfo', JSON.stringify(currentUserData));
      }
    }
  }

  // GTIP verilerini yükle
  async function loadGtipData() {
    try {
      console.log("GTIP verileri yükleniyor...");
      const { data, error } = await supabase
        .from('gtip_codes')
        .select('*')
        .limit(100);
      
      if (error) {
        console.error('GTIP verileri yüklenirken hata:', error);
        // Hata durumunda örnek GTIP verileri oluştur
        createSampleGtipData();
        return;
      }
      
      gtipData = data || [];
      console.log(`${gtipData.length} GTIP kodu yüklendi`);
      
      if (gtipData.length === 0) {
        createSampleGtipData();
      }
      
    } catch (error) {
      console.error('GTIP verileri yüklenirken hata:', error);
      createSampleGtipData();
    }
  }
  
  // Örnek GTIP verileri oluştur
  function createSampleGtipData() {
    console.log("Örnek GTIP verileri oluşturuluyor...");
    gtipData = [
      { code: "0101210000", name: "Canlı at, eşek, katır ve bardolar" },
      { code: "0101290000", name: "Canlı at, eşek, katır ve bardolar (diğer)" },
      { code: "0102210000", name: "Canlı sığırlar (saf ırk damızlık)" },
      { code: "0102290000", name: "Canlı sığırlar (diğer)" },
      { code: "0103100000", name: "Canlı domuzlar (saf ırk damızlık)" },
      { code: "0104100000", name: "Canlı koyunlar (saf ırk damızlık)" },
      { code: "0105100000", name: "Canlı keçiler (saf ırk damızlık)" },
      { code: "0201100000", name: "Sığır eti (taze/soğutulmuş)" },
      { code: "0201200000", name: "Sığır eti (dondurulmuş)" },
      { code: "0202100000", name: "Domuz eti (taze/soğutulmuş)" },
      { code: "0202200000", name: "Domuz eti (dondurulmuş)" },
      { code: "0203110000", name: "Koyun eti (taze/soğutulmuş)" },
      { code: "0203210000", name: "Koyun eti (dondurulmuş)" },
      { code: "0302110000", name: "Alabalık (canlı)" },
      { code: "0302120000", name: "Alabalık (taze/soğutulmuş)" },
      { code: "0302130000", name: "Alabalık (dondurulmuş)" },
      { code: "0302710000", name: "Somon (canlı)" },
      { code: "0302720000", name: "Somon (taze/soğutulmuş)" },
      { code: "0302730000", name: "Somon (dondurulmuş)" },
      { code: "0303790000", name: "Diğer balıklar (canlı)" },
      { code: "0401100000", name: "Süt (yağ oranı %1'den az)" },
      { code: "0401200000", name: "Süt (yağ oranı %1-6 arası)" },
      { code: "0401300000", name: "Süt (yağ oranı %6'dan fazla)" },
      { code: "0402100000", name: "Süt tozu (yağ oranı %1.5'ten az)" },
      { code: "0402210000", name: "Süt tozu (yağ oranı %1.5-27 arası)" },
      { code: "0402290000", name: "Süt tozu (yağ oranı %27'den fazla)" },
      { code: "0402910000", name: "Diğer süt ürünleri" },
      { code: "0405100000", name: "Tereyağı" },
      { code: "0405200000", name: "Süt yağı" },
      { code: "0405900000", name: "Diğer yağlar" },
      { code: "0406100000", name: "Peynir (taze)" },
      { code: "0406200000", name: "Peynir (rendelenmiş)" },
      { code: "0406300000", name: "Peynir (işlenmiş)" },
      { code: "0406400000", name: "Peynir (mavi küflü)" },
      { code: "0406900000", name: "Diğer peynirler" },
      { code: "0504000000", name: "Hayvan bağırsakları, mesaneleri ve mideleri" },
      { code: "0505100000", name: "Kuş tüyü ve kuş tüyündan yastık" },
      { code: "0505900000", name: "Diğer hayvansal ürünler" },
      { code: "0601100000", name: "Soğan, sarımsak, pırasa ve diğer soğanlı sebzeler" },
      { code: "0601200000", name: "Havuç, şalgam, pancar ve diğer kök sebzeler" },
      { code: "0602100000", name: "Yapraklı sebzeler (taze)" },
      { code: "0602200000", name: "Yapraklı sebzeler (soğutulmuş)" },
      { code: "0602300000", name: "Yapraklı sebzeler (dondurulmuş)" },
      { code: "0602400000", name: "Yapraklı sebzeler (konserve)" },
      { code: "0602900000", name: "Diğer sebzeler" },
      { code: "0603100000", name: "Meyveler (taze)" },
      { code: "0603200000", name: "Meyveler (kurutulmuş)" },
      { code: "0603300000", name: "Meyveler (dondurulmuş)" },
      { code: "0603400000", name: "Meyveler (konserve)" },
      { code: "0603900000", name: "Diğer meyveler" },
      { code: "0604100000", name: "Kahve (kavrulmamış)" },
      { code: "0604200000", name: "Kahve (kavrulmuş)" },
      { code: "0604300000", name: "Kahve ekstraktları ve esansları" },
      { code: "0604400000", name: "Çay" },
      { code: "0604500000", name: "Kakao" },
      { code: "0604600000", name: "Baharatlar" },
      { code: "0604700000", name: "Şeker ve şekerlemeler" },
      { code: "0604800000", name: "Çikolata ve kakao ürünleri" },
      { code: "0604900000", name: "Diğer gıda ürünleri" },
      { code: "0701000000", name: "Hububat" },
      { code: "0702000000", name: "Sebzeler" },
      { code: "0703000000", name: "Meyveler" },
      { code: "0704000000", name: "Kahve, çay, kakao ve baharatlar" },
      { code: "0705000000", name: "Hayvansal ve bitkisel yağlar" },
      { code: "0706000000", name: "Şeker ve şekerlemeler" },
      { code: "0707000000", name: "Kakao ve kakao ürünleri" },
      { code: "0708000000", name: "Hazır yemekler" },
      { code: "0709000000", name: "İçecekler" },
      { code: "0710000000", name: "Tütün ve tütün ürünleri" },
      { code: "0801000000", name: "Deri ve kösele" },
      { code: "0802000000", name: "Deri eşya" },
      { code: "0803000000", name: "Kürk ve kürk eşya" },
      { code: "0804000000", name: "Ağaç ve ahşap eşya" },
      { code: "0805000000", name: "Mantar ve mantar eşya" },
      { code: "0806000000", name: "Kağıt ve karton" },
      { code: "0807000000", name: "Kağıt hamuru" },
      { code: "0808000000", name: "Kağıt ve karton eşya" },
      { code: "0809000000", name: "Basılı materyaller" },
      { code: "0810000000", name: "İpek" },
      { code: "0811000000", name: "Yün ve ince kıllar" },
      { code: "0812000000", name: "Pamuk" },
      { code: "0813000000", name: "Dokumaya elverişli bitkisel lifler" },
      { code: "0814000000", name: "Dokumaya elverişli suni lifler" },
      { code: "0815000000", name: "Dokumaya elverişli sentetik lifler" },
      { code: "0816000000", name: "Dokunmuş mensucat" },
      { code: "0817000000", name: "Örme mensucat" },
      { code: "0818000000", name: "Dantel, işleme vb." },
      { code: "0819000000", name: "Dokunmuş halılar ve diğer yer kaplamaları" },
      { code: "0820000000", name: "Özel dokunmuş mensucat" },
      { code: "0821000000", name: "İplik" },
      { code: "0822000000", name: "Dokuma ürünleri" },
      { code: "0823000000", name: "Örme ürünleri" },
      { code: "0824000000", name: "Giyim eşyası ve aksesuarları" },
      { code: "0825000000", name: "Diğer dokuma ürünleri" },
      { code: "0826000000", name: "Demir ve çelik" },
      { code: "0827000000", name: "Demir veya çelikten eşya" },
      { code: "0828000000", name: "Bakır ve bakırdan eşya" },
      { code: "0829000000", name: "Nikel ve nikelden eşya" },
      { code: "0830000000", name: "Aluminyum ve aluminyumdan eşya" },
      { code: "0831000000", name: "Kurşun ve kurşundan eşya" },
      { code: "0832000000", name: "Çinko ve çinkodan eşya" },
      { code: "0833000000", name: "Kalay ve kalaydan eşya" },
      { code: "0834000000", name: "Diğer adi metaller" },
      { code: "0835000000", name: "Adi metal alaşımları" },
      { code: "0836000000", name: "Adi metalden eşya" },
      { code: "0837000000", name: "Makina ve mekanik cihazlar" },
      { code: "0838000000", name: "Elektrikli makina ve cihazlar" },
      { code: "0839000000", name: "Demiryolu ve tramvay araçları" },
      { code: "0840000000", name: "Motorlu kara taşıtları" },
      { code: "0841000000", name: "Hava taşıtları" },
      { code: "0842000000", name: "Su taşıtları" },
      { code: "0843000000", name: "Optik, fotoğraf, sinema, ölçü, kontrol cihazları" },
      { code: "0844000000", name: "Tıbbi cihazlar" },
      { code: "0845000000", name: "Çalar saatler ve bunların aksam ve parçaları" },
      { code: "0846000000", name: "Müzik aletleri" },
      { code: "0847000000", name: "Silahlar ve mühimmat" },
      { code: "0848000000", name: "Mobilyalar" },
      { code: "0849000000", name: "Oyuncaklar, oyun ve spor malzemeleri" },
      { code: "0850000000", name: "Çeşitli mamul eşya" },
      { code: "0851000000", name: "Sanat eserleri, koleksiyon eşyası ve antikalar" }
    ];
    console.log(`${gtipData.length} örnek GTIP kodu oluşturuldu`);
  }

  // Ürünleri yükle
  async function loadProducts() {
    try {
      console.log("Ürünler yükleniyor...");
      
      let query = supabase.from('products').select('*');
      
      if (selectedSellerId) {
        query = query.eq('seller_id', selectedSellerId);
      } else if (currentUserRole === 'admin') {
        // Admin tüm ürünleri görür
      } else {
        query = query.eq('seller_id', currentUser.id);
      }
      
      const { data, error } = await query;
      
      if (error) {
        console.error('Ürünler yüklenirken hata:', error);
        showToast('Ürünler yüklenirken hata oluştu', 'error');
        displayEmptyProducts();
        return;
      }
      
      const productsList = $('productsList');
      productsList.innerHTML = '';
      allProducts = data || [];
      
      $('productCount').textContent = allProducts.length;
      
      if (allProducts.length === 0) {
        displayEmptyProducts();
        return;
      }
      
      allProducts.forEach(product => {
        const seller = sellers.find(s => s.id === product.seller_id) || {};
        
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        
        let imageCellContent = '';
        if (product.images && product.images.length > 0) {
          imageCellContent = `
            <img src="${product.images[0]}" class="product-image" 
                 alt="${product.name || ''}"
                 onclick="openImageModal('${product.images[0]}')">
          `;
        } else {
          imageCellContent = `
            <div class="w-16 h-16 bg-gray-200 rounded flex items-center justify-center">
              <i class="fas fa-image text-gray-400"></i>
            </div>
          `;
        }
        
        tr.innerHTML = `
          <td class="p-3">${imageCellContent}</td>
          <td class="p-3 font-medium">${product.name || ''}</td>
          <td class="p-3">${seller.company_name || seller.name || 'Bilinmiyor'}</td>
          <td class="p-3">${product.barcod_no || ''}</td>
          <td class="p-3">${product.gtipno || ''}</td>
          <td class="p-3">${product.price || 0} ${product.currency || 'TL'}</td>
          <td class="p-3">${product.stock || 0}</td>
          <td class="p-3">
            <span class="status-badge ${product.is_active ? 'status-active' : 'status-inactive'}">
              ${product.is_active ? 'Aktif' : 'Pasif'}
            </span>
          </td>
          <td class="p-3">
            <div class="flex space-x-2">
              <button class="btn btn-secondary btn-sm btnEditProduct">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-danger btn-sm btnDeleteProduct">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        `;
        
        tr.querySelector('.btnEditProduct').addEventListener('click', () => {
          openProductModal(product);
        });
        
        tr.querySelector('.btnDeleteProduct').addEventListener('click', () => {
          deleteProduct(product.id);
        });
        
        productsList.appendChild(tr);
      });
      
    } catch (error) {
      console.error('Ürünler yüklenirken hata:', error);
      showToast('Ürünler yüklenirken hata oluştu', 'error');
      displayEmptyProducts();
    }
  }

  // Boş ürün listesi göster
  function displayEmptyProducts() {
    const productsList = $('productsList');
    productsList.innerHTML = `
      <tr>
        <td colspan="9" class="p-4 text-center text-gray-500">
          Henüz ürün bulunmamaktadır
        </td>
      </tr>
    `;
    $('productCount').textContent = '0';
  }

  // Toast bildirimi gösterme
  function showToast(message, type = 'info', duration = 3000) {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    
    let iconClass = 'fa-info-circle';
    if (type === 'success') iconClass = 'fa-check-circle';
    if (type === 'error') iconClass = 'fa-exclamation-circle';
    if (type === 'warning') iconClass = 'fa-exclamation-triangle';
    
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
      <i class="toast-icon fas ${iconClass}"></i>
      <span>${message}</span>
    `;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
      if (toast.parentNode) {
        toast.remove();
      }
    }, duration);
  }

  // Diğer fonksiyonlar (setupEventListeners, openProductModal, saveProduct, vs.) önceki gibi kalacak
  // Sadece gerekli düzenlemeleri yapacağız...

  // Satıcıları yükle
  async function loadSellers() {
    try {
      const { data, error } = await supabase
        .from('users')
        .select('*')
        .eq('role', 'seller');
      
      if (error) {
        console.error('Satıcılar yüklenirken hata:', error);
        showToast('Satıcılar yüklenirken hata oluştu', 'error');
        return;
      }
      
      sellers = data || [];
      populateSellerDropdowns();
      
    } catch (error) {
      console.error('Satıcılar yüklenirken hata:', error);
      showToast('Satıcılar yüklenirken hata oluştu', 'error');
    }
  }

  // Satıcı dropdown'larını doldur
  function populateSellerDropdowns() {
    const sellerSelect = $('sellerSelect');
    const modalSellerSelect = $('modalSellerSelect');
    
    sellerSelect.innerHTML = '<option value="">Tüm Satıcılar</option>';
    modalSellerSelect.innerHTML = '<option value="" selected disabled>Satıcı Seçin</option>';
    
    sellers.forEach(seller => {
      const option1 = document.createElement('option');
      option1.value = seller.id;
      option1.textContent = seller.company_name || seller.name || seller.email;
      sellerSelect.appendChild(option1);
      
      const option2 = document.createElement('option');
      option2.value = seller.id;
      option2.textContent = seller.company_name || seller.name || seller.email;
      modalSellerSelect.appendChild(option2);
    });
  }

  // Event listener'ları kur
  function setupEventListeners() {
    // Yeni ürün butonuna event listener ekle
    $('btnNewProduct').addEventListener('click', () => {
      openProductModal();
    });
    
    // GTIP arama işlevselliği
    $('p_gtipno').addEventListener('input', function() {
      searchGtip(this.value);
    });
    
    // GTIP alanına odaklanınca dropdown'u göster
    $('p_gtipno').addEventListener('focus', function() {
      if (this.value.length >= 2) {
        searchGtip(this.value);
      }
    });
    
    // Ürün arama işlevselliği
    $('p_name').addEventListener('input', function() {
      searchProducts(this.value);
    });
    
    // GTIP dropdown dışına tıklanınca kapat
    document.addEventListener('click', function(e) {
      if (!e.target.closest('#p_gtipno') && !e.target.closest('.gtip-results')) {
        $('gtipDropdown').classList.add('hidden');
      }
      if (!e.target.closest('#p_name') && !e.target.closest('.product-results')) {
        $('productSearchResults').classList.add('hidden');
      }
    });
    
    // Satıcı filtreleme temizleme butonu
    $('clearSellerFilter')?.addEventListener('click', function() {
      $('sellerSelect').value = '';
      selectedSellerId = null;
      loadProducts();
    });
    
    // Görsel yükleme işlemi
    $('p_images').addEventListener('change', (e) => {
      const files = e.target.files;
      if (!files || files.length === 0) return;
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (file.type.startsWith('image/')) {
          imageFiles.push(file);
          createImagePreview(file, imageFiles.length - 1);
        }
      }
      
      updateImageInputText();
      $('p_images').value = '';
    });
    
    // Satıcı seçim dropdown'u değiştiğinde
    $('sellerSelect').addEventListener('change', (e) => {
      selectedSellerId = e.target.value || null;
      loadProducts();
    });
    
    // Satıcı arama kutusu
    $('sellerSearch').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const options = $('sellerSelect').options;
      
      for (let i = 1; i < options.length; i++) {
        const option = options[i];
        const text = option.textContent.toLowerCase();
        option.style.display = text.includes(searchTerm) ? '' : 'none';
      }
    });
    
    // Modal satıcı arama kutusu
    $('modalSellerSearch').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const options = $('modalSellerSelect').options;
      
      for (let i = 1; i < options.length; i++) {
        const option = options[i];
        const text = option.textContent.toLowerCase();
        option.style.display = text.includes(searchTerm) ? '' : 'none';
      }
    });
    
    // Modal kapatma düğmeleri
    $('closeModalProduct').addEventListener('click', () => closeProductModal());
    $('cancelProductBtn').addEventListener('click', () => closeProductModal());
    $('closeImageViewModal').addEventListener('click', () => {
      $('#imageViewModal').classList.remove('active');
    });
    
    // Yenile butonu
    $('refreshProducts').addEventListener('click', () => {
      if (currentUserRole === 'admin') {
        loadSellers().then(() => loadProducts());
      } else {
        loadProducts();
      }
      showToast('Ürün listesi yenileniyor...', 'info');
    });
    
    // Form gönderme
    $('formProduct').addEventListener('submit', async (e) => {
      e.preventDefault();
      await saveProduct();
    });
    
    // Ürün silme butonu
    $('deleteProductBtn').addEventListener('click', () => {
      if (currentEditingProductId) {
        deleteProduct(currentEditingProductId);
      }
    });
  }

  // GTIP arama fonksiyonu
  function searchGtip(searchTerm) {
    if (!searchTerm || searchTerm.length < 2) {
      $('gtipDropdown').classList.add('hidden');
      return;
    }
    
    const isNumeric = /^\d+$/.test(searchTerm);
    
    const results = gtipData.filter(item => {
      if (isNumeric) {
        return item.code && item.code.startsWith(searchTerm);
      } else {
        return item.name && item.name.toLowerCase().includes(searchTerm.toLowerCase());
      }
    }).slice(0, 10);
    
    displayGtipResults(results);
  }
  
  // GTIP sonuçlarını göster
  function displayGtipResults(results) {
    const dropdown = $('gtipDropdown');
    dropdown.innerHTML = '';
    
    if (results.length === 0) {
      dropdown.innerHTML = '<div class="gtip-item">Sonuç bulunamadı</div>';
    } else {
      results.forEach(item => {
        const div = document.createElement('div');
        div.className = 'gtip-item';
        div.innerHTML = `
          <div class="gtip-code">${item.code || ''}</div>
          <div class="gtip-name">${item.name || ''}</div>
        `;
        div.addEventListener('click', () => {
          $('p_gtipno').value = item.code || '';
          dropdown.classList.add('hidden');
        });
        dropdown.appendChild(div);
      });
    }
    
    dropdown.classList.remove('hidden');
  }

  // Ürün modalını aç
  function openProductModal(product = null) {
    if (!currentUser) {
      showToast('Lütfen önce giriş yapın', 'error');
      return;
    }
    
    const adminContainer = $('adminSellerContainer');
    
    document.querySelectorAll('.error-message').forEach(el => {
      el.style.display = 'none';
    });
    
    if (currentUserRole === 'admin') {
      adminContainer.classList.remove('hidden');
    } else {
      adminContainer.classList.add('hidden');
    }
    
    imageFiles = [];
    existingImages = [];
    $('imagePreview').innerHTML = '';
    updateImageInputText();
    
    if (product) {
      fillFormWithProductData(product);
    } else {
      $('modalProductTitle').textContent = 'Yeni Ürün Ekle';
      $('deleteProductBtn').classList.add('hidden');
      $('formProduct').reset();
      
      if (currentUserRole === 'admin') {
        $('modalSellerSelect').value = selectedSellerId || '';
      }
      
      currentEditingProductId = null;
    }
    
    $('#modalProduct').classList.add('active');
  }

  // Formu ürün verileriyle doldur
  function fillFormWithProductData(product) {
    $('p_name').value = product.name || '';
    $('p_barcod_no').value = product.barcod_no || '';
    $('p_gtipno').value = product.gtipno || '';
    $('p_sku').value = product.sku || '';
    $('p_brand').value = product.brand || '';
    $('p_categories').value = product.categories || '';
    $('p_price').value = product.price || '';
    $('p_currency').value = product.currency || 'TRY';
    $('p_stock').value = product.stock || '';
    $('p_vat').value = product.vat || '';
    $('p_description').value = product.description || '';
    $('p_isActive').value = product.is_active ? 'true' : 'false';
    
    if (product.images && product.images.length > 0) {
      existingImages = product.images;
      $('imagePreview').innerHTML = '';
      product.images.forEach((url, index) => {
        createImagePreview(null, index, true, url);
      });
      updateImageInputText();
    }
    
    if (currentUserRole === 'admin') {
      $('modalSellerSelect').value = product.seller_id || '';
    }
    
    currentEditingProductId = product.id;
    $('modalProductTitle').textContent = 'Ürünü Düzenle';
    $('deleteProductBtn').classList.remove('hidden');
  }

  // Ürün kaydet
  async function saveProduct() {
    if (!validateForm()) {
      showToast('Lütfen gerekli alanları doldurun', 'error');
      return;
    }
    
    let sellerId, sellerName;
    if (currentUserRole === 'admin') {
      sellerId = $('modalSellerSelect').value;
      if (!sellerId) {
        showToast('Lütfen bir satıcı seçin', 'error');
        return;
      }
      
      const selectedSeller = sellers.find(s => s.id === sellerId);
      sellerName = selectedSeller?.company_name || selectedSeller?.name || '';
    } else {
      sellerId = currentUser.id;
      sellerName = currentUserData?.company_name || currentUserData?.name || currentUser.email;
    }
    
    $('saveProductBtn').disabled = true;
    $('saveProductBtn').innerHTML = '<div class="loading-spinner"></div> Kaydediliyor...';
    
    try {
      const imageUrls = [...existingImages];
      
      let productData = {
        name: $('p_name').value.trim(),
        barcod_no: $('p_barcod_no').value.trim(),
        gtipno: $('p_gtipno').value.trim(),
        sku: $('p_sku').value.trim(),
        brand: $('p_brand').value.trim(),
        categories: $('p_categories').value.trim(),
        price: parseFloat($('p_price').value) || 0,
        currency: $('p_currency').value,
        stock: parseInt($('p_stock').value) || 0,
        vat: parseFloat($('p_vat').value) || 0,
        description: $('p_description').value.trim(),
        is_active: $('p_isActive').value === 'true',
        seller_id: sellerId,
        seller_name: sellerName,
        images: imageUrls,
        updated_at: new Date().toISOString()
      };
      
      if (currentEditingProductId) {
        const { error } = await supabase
          .from('products')
          .update(productData)
          .eq('id', currentEditingProductId);
        
        if (error) throw new Error('Ürün güncellenemedi: ' + error.message);
        
        showToast('Ürün başarıyla güncellendi', 'success');
      } else {
        productData.created_at = new Date().toISOString();
        
        const { error } = await supabase
          .from('products')
          .insert([productData]);
        
        if (error) throw new Error('Ürün eklenemedi: ' + error.message);
        
        showToast('Ürün başarıyla eklendi', 'success');
      }
      
      closeProductModal();
      loadProducts();
    } catch (error) {
      console.error('Ürün kaydedilirken hata:', error);
      showToast('Ürün kaydedilirken hata oluştu: ' + error.message, 'error');
    } finally {
      $('saveProductBtn').disabled = false;
      $('saveProductBtn').innerHTML = '<i class="fas fa-save mr-1"></i>Kaydet';
    }
  }

  // Ürün sil
  async function deleteProduct(productId) {
    if (!confirm('Bu ürünü silmek istediğinize emin misiniz? Bu işlem geri alınamaz.')) return;
    
    try {
      const { error } = await supabase
        .from('products')
        .delete()
        .eq('id', productId);
      
      if (error) throw new Error('Ürün silinemedi: ' + error.message);
      
      showToast('Ürün başarıyla silindi', 'success');
      loadProducts();
    } catch (error) {
      console.error('Ürün silinirken hata:', error);
      showToast('Ürün silinirken hata oluştu: ' + error.message, 'error');
    }
  }

  // Ürün modalını kapat
  function closeProductModal() {
    $('#modalProduct').classList.remove('active');
    currentEditingProductId = null;
    imageFiles = [];
    existingImages = [];
  }

  // Görsel önizleme oluştur
  function createImagePreview(file, index, isExisting = false, url = null) {
    const previewContainer = document.createElement('div');
    previewContainer.className = 'image-preview';
    
    const img = document.createElement('img');
    if (isExisting) {
      img.src = url;
      img.onclick = () => openImageModal(url);
    } else {
      img.src = URL.createObjectURL(file);
    }
    img.alt = 'Ürün görseli';
    img.className = 'cursor-pointer';
    
    const removeBtn = document.createElement('div');
    removeBtn.className = 'remove-image';
    removeBtn.innerHTML = '<i class="fas fa-times text-red-500"></i>';
    removeBtn.onclick = () => {
      if (isExisting) {
        existingImages = existingImages.filter(img => img !== url);
      } else {
        imageFiles.splice(index, 1);
      }
      previewContainer.remove();
      updateImageInputText();
    };
    
    previewContainer.appendChild(img);
    previewContainer.appendChild(removeBtn);
    
    $('imagePreview').appendChild(previewContainer);
  }

  // Görsel modalını aç
  function openImageModal(imageUrl) {
    $('imageViewImg').src = imageUrl;
    $('#imageViewModal').classList.add('active');
  }

  // Dosya input metnini güncelle
  function updateImageInputText() {
    const totalImages = imageFiles.length + existingImages.length;
    const label = $('p_images').nextElementSibling;
    if (totalImages > 0) {
      label.querySelector('p:first-child').textContent = `Görseller (${totalImages} seçili) - yeni eklemek için tıklayın`;
    } else {
      label.querySelector('p:first-child').textContent = 'Görselleri sürükleyip bırakın veya tıklayarak seçin';
    }
  }

</script>
</body>
</html>