<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Voiza Sim√ºlasyon v2 ‚Äî Market & Restaurant (Demo)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; background: linear-gradient(180deg,#f8fafc,#eef2ff); }
  .container { max-width:1100px; margin:24px auto; }
  .card { background:#fff; border-radius:12px; box-shadow:0 8px 30px rgba(2,6,23,0.06); overflow:hidden; }
  .hero { padding:22px; display:flex; align-items:center; justify-content:space-between; gap:16px; }
  .btn { padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
  .btn-prim { background:#0ea5a4; color:white; }
  .btn-voice { background:#2563eb; color:white; }
  .stage { padding:18px; display:grid; grid-template-columns: 1fr 360px; gap:16px; }
  .scene { background: linear-gradient(180deg,#fff,#f8fafc); border-radius:10px; padding:12px; min-height:520px; position:relative; overflow:hidden; }
  .panel { background:#fff; border-radius:10px; padding:12px; box-shadow:0 6px 18px rgba(2,6,23,0.06); }
  .shelf { background:linear-gradient(180deg,#fff,#f1f5f9); border-radius:10px; padding:8px; margin-bottom:12px; box-shadow:0 6px 18px rgba(2,6,23,0.05); display:flex; gap:8px; align-items:center; }
  .prod-thumb { width:62px; height:62px; border-radius:8px; object-fit:cover; }
  .price { font-weight:700; color:#0f172a; }
  .price-tag { position:absolute; right:12px; top:12px; background:#111827; color:#fff; padding:6px 10px; border-radius:8px; transform-origin:center; transition: transform .25s ease; }
  .price-tag.pulse { transform:scale(1.3); }
  .cart-floating { position:fixed; right:18px; bottom:18px; background:#0ea5a4; color:#fff; padding:12px 16px; border-radius:12px; box-shadow:0 12px 30px rgba(2,6,23,0.12); z-index:3000; }
  .floating { position:fixed; right:120px; bottom:120px; width:120px; transition: transform .6s cubic-bezier(.2,.9,.25,1); z-index:3001; display:none; }
  .overlay { position:fixed; left:50%; transform:translateX(-50%); top:18px; background:#fff; padding:10px 14px; border-radius:8px; box-shadow:0 8px 30px rgba(2,6,23,0.08); display:none; z-index:3002;}
  .speech-ind { font-size:13px; color:#334155; }
  .mode-badge { display:inline-block; padding:6px 10px; border-radius:999px; background:#f1f5f9; font-weight:600; }
  .note-pill { display:inline-block; padding:4px 8px; background:#f8fafc; border-radius:999px; font-size:12px; margin-right:6px; border:1px solid #e6eef0; }
  .muted { color:#64748b; font-size:13px; }
  .hidden { display:none; }
  .input { padding:8px; border:1px solid #e6eef0; border-radius:8px; width:100%; }
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="hero">
        <div>
          <h1 class="text-2xl font-bold">Voiza Sim√ºlasyon v2 ‚Äî Market & Restaurant (Demo)</h1>
          <p class="text-sm text-slate-500">Geli≈ümi≈ü sesli komut: reyon a√ßma, fiyat sorgu, i√ßerik √ßƒ±karma, ekstra/gram ekleme, i√ßecek upsell.</p>
        </div>
        <div class="flex gap-3 items-center">
          <div id="greeting" class="text-sm text-slate-600">Merhaba Ay≈üe Teyze (demo)</div>
          <button id="btnMarket" class="btn btn-prim">Market</button>
          <button id="btnRestaurant" class="btn btn-prim">Restaurant</button>
          <button id="btnVoice" class="btn btn-voice">üé§ Sesle</button>
        </div>
      </div>

      <div class="stage">
        <!-- Scene -->
        <div class="scene" id="scene">
          <div id="welcomeScreen">
            <img src="https://images.unsplash.com/photo-1507476299244-0a3e9ff9899f?auto=format&fit=crop&w=1400&q=60" alt="" style="width:100%; height:220px; object-fit:cover; border-radius:8px; margin-bottom:12px;">
            <div style="padding:8px 6px;">
              <div class="text-lg font-semibold">Ho≈ügeldiniz! Market veya Restaurant se√ßin, sonra sesi kullanƒ±n.</div>
              <div class="text-sm text-slate-500 mt-2">√ñrnek komutlar: "Manav reyonu", "Domates ka√ß para", "1 kilo ver", "D√∂ner istiyorum", "Et olsun", "tur≈üu olmasƒ±n", "25 gr tavuk ekle".</div>
            </div>
          </div>

          <!-- Market view -->
          <div id="marketView" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <div><h3 class="text-lg font-semibold">Market ‚Äî Reyonlar</h3><div class="text-xs text-slate-500">Sesle reyon a√ß, √ºr√ºn sor, sepet eklensin.</div></div>
              <div class="mode-badge" id="currentMode">Mode: Market</div>
            </div>
            <div id="marketShelves" style="max-height:360px; overflow:auto;">
              <!-- dynamic shelves -->
            </div>
          </div>

          <!-- Restaurant view -->
          <div id="restaurantView" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <div><h3 class="text-lg font-semibold">Restaurant ‚Äî Men√º</h3><div class="text-xs text-slate-500">Sesle sipari≈ü ver, et/tavuk se√ß, porsiyon belirt. Not: "tur≈üusuz", "ket√ßapsƒ±z" vb. komutlar i≈ülenir.</div></div>
              <div class="mode-badge">Mode: Restaurant</div>
            </div>

            <div id="menuList" style="max-height:360px; overflow:auto;">
              <!-- dynamic menu -->
            </div>
          </div>

          <div class="price-tag hidden" id="priceTag">0‚Ç∫</div>
        </div>

        <!-- Right panel -->
        <div class="panel">
          <div class="mb-3">
            <div class="flex justify-between items-center">
              <div><strong>Durum</strong></div>
              <div class="speech-ind" id="speechState">Ses: Hazƒ±r</div>
            </div>
            <div class="text-xs text-slate-500 mt-2">Tu≈üla veya sesle komut verin. Komut √∂rnekleri √ºstte.</div>
          </div>

          <div class="mb-3">
            <div class="flex gap-2">
              <input id="manualInput" class="input" placeholder="Komut yaz (√∂r: domates ka√ß para; tur≈üusuz; 25 gr tavuk ekle)" />
              <button id="btnManual" class="btn btn-prim">Ara</button>
            </div>
          </div>

          <div class="mb-3">
            <h4 class="font-semibold">Sepet</h4>
            <ul id="cartList" class="mt-2 text-sm"></ul>
            <div class="mt-2 flex justify-between items-center">
              <div>Toplam: <span id="cartTotal">0‚Ç∫</span></div>
              <div><button id="checkout" class="btn btn-prim">Sipari≈üi G√∂nder</button></div>
            </div>
          </div>

          <div>
            <h4 class="font-semibold">Kƒ±sa Komutlar & ƒ∞pu√ßlarƒ±</h4>
            <div class="text-xs text-slate-500 mt-2">
              Market: "Manav reyonu", "S√ºt reyonu", "Sal√ßa fiyatƒ± ka√ß"<br>
              Restaurant: "D√∂ner istiyorum", "Et olsun", "25 gr tavuk ekle", "tur≈üusuz", "ket√ßapsƒ±z"<br>
              Genel: "Sepeti g√∂ster", "ƒ∞√ßecek ister misin?"
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- floating UI -->
    <div class="cart-floating" id="cartBtn">üõí Sepet (<span id="cartCount">0</span>)</div>
    <img class="floating" id="floatingImg" src="" alt="floating">

    <div class="overlay" id="overlay"></div>
  </div>

<script>
/* ----------------- Config & Data ----------------- */
const localUser = { name: 'Ay≈üe Teyze' }; // demo personalization

const PRODUCTS = {
  tomato: { id:'tomato', name:'Domates', price:40, unit:'kg', img:'https://images.unsplash.com/photo-1572441710260-e8aa3ca5f0a6?auto=format&fit=crop&w=200&q=60', aisle:'manav' },
  onion: { id:'onion', name:'Soƒüan', price:9, unit:'kg', img:'https://images.unsplash.com/photo-1580711200959-7b1a0b6be5d8?auto=format&fit=crop&w=200&q=60', aisle:'manav' },
  cheese: { id:'cheese', name:'Beyaz Peynir', price:120, unit:'kg', img:'https://images.unsplash.com/photo-1563431986-7b3d5b8a27b4?auto=format&fit=crop&w=200&q=60', aisle:'sut' },
  paste: { id:'paste', name:'Domates Sal√ßasƒ±', price:95, unit:'2kg', img:'https://images.unsplash.com/photo-1542444459-db8a60b0b96f?auto=format&fit=crop&w=200&q=60', aisle:'kiler' }
};

const MENU = {
  doner: { id:'doner', name:'D√∂ner', basePrice:85, variants: ['Et','Tavuk'], img:'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=400&q=60',
          extras: [ { code:'25gr_tavuk', label:'25 gr Tavuk', price:50 }, { code:'extra_cheese', label:'Peynir +', price:20 } ] },
  pizza: { id:'pizza', name:'Pizza', basePrice:150, variants: ['Klasik','Peynirli'], img:'https://images.unsplash.com/photo-1604908177522-6f4591a9a7e5?auto=format&fit=crop&w=400&q=60',
           extras: [ { code:'extra_spice', label:'Baharat +', price:5 } ] }
};

/* ----------------- State ----------------- */
let mode = null; // 'market' | 'restaurant'
let cart = [];
const $ = id => document.getElementById(id);

/* ----------------- UI init ----------------- */
function showWelcome() {
  $('welcomeScreen').classList.remove('hidden');
  $('marketView').classList.add('hidden');
  $('restaurantView').classList.add('hidden');
  $('priceTag').classList.add('hidden');
}
function openMarket() {
  mode = 'market';
  $('welcomeScreen').classList.add('hidden');
  $('marketView').classList.remove('hidden');
  $('restaurantView').classList.add('hidden');
  $('currentMode').innerText = 'Mode: Market';
  renderMarketShelves();
  speak(`${localUser.name} market se√ßtiniz. Hangi reyon?`);
}
function openRestaurant() {
  mode = 'restaurant';
  $('welcomeScreen').classList.add('hidden');
  $('marketView').classList.add('hidden');
  $('restaurantView').classList.remove('hidden');
  renderMenu();
  speak(`${localUser.name} restaurant se√ßtiniz. Ne istersiniz?`);
}
showWelcome();

/* ----------------- Render functions ----------------- */
function renderMarketShelves() {
  const container = $('marketShelves');
  container.innerHTML = '';
  // group by aisle
  const aisles = {};
  Object.values(PRODUCTS).forEach(p => {
    if (!aisles[p.aisle]) aisles[p.aisle] = [];
    aisles[p.aisle].push(p);
  });
  for (const [aisle, items] of Object.entries(aisles)) {
    const sec = document.createElement('div');
    sec.className = 'shelf';
    sec.dataset.aisle = aisle;
    sec.innerHTML = `<div style="flex:1"><strong style="text-transform:capitalize">${aisle}</strong><div class="text-xs text-slate-500">Tƒ±klayƒ±n veya sesle a√ßƒ±n</div></div>`;
    const list = document.createElement('div');
    list.style.display = 'flex'; list.style.flexDirection='column'; list.style.gap='6px';
    items.forEach(it => {
      const row = document.createElement('div');
      row.className = 'prod-row';
      row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center';
      row.innerHTML = `<img src="${it.img}" class="prod-thumb" alt=""><div><div style="font-weight:600">${it.name}</div><div class="text-xs text-slate-500">${it.unit}</div></div><div style="margin-left:auto" class="price">${it.price}‚Ç∫</div>`;
      row.dataset.prodId = it.id;
      row.onclick = ()=> { addToCart(it.id,1); animatePrice(it.id); };
      list.appendChild(row);
    });
    sec.appendChild(list);
    container.appendChild(sec);
  }
}

function renderMenu() {
  const list = $('menuList');
  list.innerHTML = '';
  Object.values(MENU).forEach(m => {
    const div = document.createElement('div');
    div.className = 'shelf';
    div.style.display='flex'; div.style.alignItems='center';
    div.innerHTML = `<img src="${m.img}" class="prod-thumb" style="width:72px;height:72px"><div style="margin-left:10px"><div style="font-weight:700">${m.name}</div><div class="text-xs text-slate-500">Se√ßenek: ${m.variants.join(', ')} ‚Äî ${m.basePrice}‚Ç∫</div></div><div style="margin-left:auto" class="price">${m.basePrice}‚Ç∫</div>`;
    div.onclick = ()=> { startMenuFlow(m); };
    // extras listing small
    const extrasHtml = m.extras.map(e=>`<div class="note-pill">${e.label} +${e.price}‚Ç∫</div>`).join(' ');
    const extrasDiv = document.createElement('div'); extrasDiv.style.marginTop='8px'; extrasDiv.innerHTML = extrasHtml;
    div.appendChild(extrasDiv);
    list.appendChild(div);
  });
}

/* ----------------- Cart ----------------- */
function addToCart(productId, qty, opts={}) {
  // opts: { variant, notes:[], extras:[] }
  if (PRODUCTS[productId]) {
    const p = PRODUCTS[productId];
    cart.push({ id:p.id, name:p.name, qty, unit:p.unit, price:p.price, notes: opts.notes||[], extras: opts.extras||[] });
    updateCartUI();
    showFloating(p.img);
    speak(`${qty} ${p.unit} ${p.name} sepete eklendi efendim`);
  } else {
    // menu
    const m = MENU[productId];
    if (m) {
      const variant = opts.variant || m.variants[0];
      let price = m.basePrice;
      // extras price
      const extrasArr = opts.extras || [];
      extrasArr.forEach(ex => {
        const exObj = m.extras.find(x=>x.code===ex);
        if (exObj) price += exObj.price;
      });
      cart.push({ id:m.id, name: m.name + ' - ' + variant, qty, unit:'porsiyon', price, notes: opts.notes||[], extras: extrasArr });
      updateCartUI();
      showFloating(m.img);
      speak(`${qty} porsiyon ${m.name} (${variant}) sepete eklendi efendim`);
    }
  }
}

function updateCartUI() {
  const ul = $('cartList'); ul.innerHTML='';
  let total = 0;
  cart.forEach((it,idx)=>{
    total += it.qty * it.price;
    const li = document.createElement('li'); li.style.display='flex'; li.style.flexDirection='column'; li.style.padding='8px 0';
    li.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center">
                      <div><strong>${it.qty} x ${it.name}</strong><div class="muted">${it.unit}</div></div>
                      <div style="text-align:right">${(it.qty*it.price).toFixed(2)}‚Ç∫</div>
                    </div>`;
    if (it.extras && it.extras.length>0) {
      const exs = it.extras.map(code => {
        const m = MENU[it.id] || null;
        if (m) { const e = m.extras.find(x=>x.code===code); return e ? `<span class="note-pill">${e.label}</span>` : ''; }
        // product-level extras (rare)
        return '';
      }).join(' ');
      li.innerHTML += `<div style="margin-top:6px">${exs}</div>`;
    }
    if (it.notes && it.notes.length>0) {
      const notesHtml = it.notes.map(n=>`<span class="note-pill">${n}</span>`).join(' ');
      li.innerHTML += `<div style="margin-top:6px">${notesHtml}</div>`;
    }
    // remove button
    const rem = document.createElement('button'); rem.textContent='Sil'; rem.className='btn'; rem.style.marginTop='8px'; rem.onclick=()=>{ cart.splice(idx,1); updateCartUI(); };
    li.appendChild(rem);
    ul.appendChild(li);
  });
  $('cartTotal').innerText = total.toFixed(2) + '‚Ç∫';
  $('cartCount').innerText = cart.length;
}

/* ----------------- Animations ----------------- */
function animatePrice(prodId) {
  const prod = Object.values(PRODUCTS).find(p=>p.id===prodId);
  if (!prod) return;
  const tag = $('priceTag');
  tag.innerText = `${prod.price}‚Ç∫`;
  tag.classList.remove('hidden');
  tag.classList.add('pulse');
  setTimeout(()=> tag.classList.remove('pulse'),800);
  setTimeout(()=> tag.classList.add('hidden'),1800);
}

function showFloating(src) {
  const f = $('floatingImg'); f.src = src; f.style.display='block';
  f.style.transform='translateY(0)';
  setTimeout(()=> { f.style.transform='translateY(-220px)'; setTimeout(()=> { f.style.display='none'; f.style.transform='translateY(0)'; },700); }, 300);
}

/* ----------------- Voice Recognition ----------------- */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;
let menuFlow = { item:null, awaitingVariant:false, awaitingQty:false, selectedVariant:null, pendingExtras:[], pendingNotes:[], pendingQty:1 };
if (SpeechRecognition) {
  recognition = new SpeechRecognition();
  recognition.lang = 'tr-TR';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.onstart = ()=> { $('speechState').innerText = 'Ses: Dinleniyor...'; };
  recognition.onend = ()=> { $('speechState').innerText = 'Ses: Hazƒ±r'; };
  recognition.onerror = (e)=> { $('speechState').innerText = 'Ses hatasƒ±'; speak('Anlamadƒ±m, tekrar eder misiniz?'); };
  recognition.onresult = (ev)=> {
    const text = ev.results[0][0].transcript.toLowerCase();
    $('speechState').innerText = 'Duydu: ' + text;
    handleVoice(text);
  };
}

/* start voice */
$('btnVoice').addEventListener('click', ()=> {
  if (!mode) { speak('√ñnce Market veya Restaurant se√ßin l√ºtfen'); return; }
  if (!recognition) { alert('Tarayƒ±cƒ±nƒ±z konu≈üma tanƒ±mayƒ± desteklemiyor'); return; }
  try { recognition.start(); } catch(e){ console.log(e); speak('Mikrofon ba≈ülatƒ±lamadƒ±'); }
});

/* manual */
$('btnManual').addEventListener('click', ()=> { handleVoice($('manualInput').value.toLowerCase()); $('manualInput').value=''; });

/* mode buttons */
$('btnMarket').addEventListener('click', openMarket);
$('btnRestaurant').addEventListener('click', openRestaurant);

/* checkout */
$('checkout').addEventListener('click', ()=> {
  if (cart.length===0) { alert('Sepet bo≈ü'); return; }
  // demo: show payload
  const payload = { user: localUser, cart };
  console.log('ORDER PAYLOAD', payload);
  alert('Sipari≈ü demo: konsola yazƒ±ldƒ±. Sunucu endpoint ile kaydedilebilir.');
  speak('Sipari≈üiniz kayƒ±t altƒ±na alƒ±ndƒ±. Te≈üekk√ºrler.');
});

/* ----------------- Voice Command Handler ----------------- */
function handleVoice(text) {
  // direct control
  if (text.includes('sepet') && text.includes('g√∂ster')) { updateCartUI(); speak('Sepetiniz g√∂steriliyor'); return; }
  if (text.includes('√ßƒ±kƒ±≈ü') || text.includes('geri') ) { showWelcome(); speak('Ana ekrana d√∂n√ºld√º'); return; }

  // Market-specific commands
  if (mode==='market') {
    // aisle selection
    if (text.includes('manav') || text.includes('sebze')) { highlightAisle('manav'); speak('Manav reyonu a√ßƒ±ldƒ± efendim'); return; }
    if (text.includes('s√ºt') || text.includes('peynir')) { highlightAisle('sut'); speak('S√ºt reyonu a√ßƒ±ldƒ± efendim'); return; }
    if (text.includes('kiler') || text.includes('sal√ßa') || text.includes('konserve')) { highlightAisle('kiler'); speak('Kiler reyonu a√ßƒ±ldƒ± efendim'); return; }

    // price ask
    if (text.includes('ka√ß') || text.includes('fiyat')) {
      const found = findProductByName(text);
      if (found) { animatePrice(found.id); speak(`${found.name} ≈üu anda ${found.price} lira efendim`); return; }
      speak('Hangi √ºr√ºn√ºn fiyatƒ±nƒ± √∂ƒürenmek istiyorsunuz?'); return;
    }

    // add by quantity or weight: "1 kilo domates", "2 domates" "domates 1 kilo"
    const qtyMatch = text.match(/(\d+)\s*(kilo|kg|adet|tane)?/);
    let qty = qtyMatch ? parseInt(qtyMatch[1]) : null;
    const found = findProductByName(text);
    if (found && qty) {
      addToCart(found.id, qty);
      animatePrice(found.id);
      return;
    }
    if (found && !qty) { addToCart(found.id, 1); animatePrice(found.id); return; }

    // fallback
    speak('Markette aradƒ±ƒüƒ±nƒ±zƒ± bulamadƒ±m, tekrar deneyin l√ºtfen');
    return;
  }

  // Restaurant-specific (more complex) flow
  if (mode==='restaurant') {
    // If in the middle of menuFlow, route accordingly
    if (menuFlow.awaitingVariant) {
      // parse variant
      if (text.includes('et')) { menuFlow.selectedVariant='Et'; menuFlow.awaitingVariant=false; menuFlow.awaitingQty=true; speak('Ka√ß porsiyon olsun efendim?'); return; }
      if (text.includes('tavuk')) { menuFlow.selectedVariant='Tavuk'; menuFlow.awaitingVariant=false; menuFlow.awaitingQty=true; speak('Ka√ß porsiyon olsun efendim?'); return; }
      // also allow direct quantity like "1 porsiyon"
    }
    if (menuFlow.awaitingQty) {
      const q = text.match(/(\d+)\s*(porsiyon|adet|tane)?/);
      const qty = q ? parseInt(q[1]) : 1;
      menuFlow.pendingQty = qty;
      // look for extras or notes within the same utterance
      const extras = parseExtrasFromText(text, menuFlow.item);
      const notes = parseRemovalsFromText(text);
      addToCart(menuFlow.item.id, qty, { variant: menuFlow.selectedVariant, extras, notes });
      // reset
      menuFlow = { item:null, awaitingVariant:false, awaitingQty:false, selectedVariant:null, pendingExtras:[], pendingNotes:[], pendingQty:1 };
      // after adding, ask for drink upsell if no drink in cart
      setTimeout(()=> maybeAskDrink(), 300);
      return;
    }

    // Start new menu if user said a menu item
    const menuItem = findMenuByName(text);
    if (menuItem) {
      menuFlow.item = menuItem;
      // ask variant (Et/Tavuk) if available
      if (menuItem.variants && menuItem.variants.length>0) {
        menuFlow.awaitingVariant = true;
        speak(`${menuItem.name} se√ßtiniz. Et mi tavuk mu olsun efendim?`);
        return;
      } else {
        menuFlow.awaitingQty = true;
        speak('Ka√ß porsiyon olsun efendim?');
        return;
      }
    }

    // Price ask for menu
    if (text.includes('ka√ß') || text.includes('fiyat')) {
      const f = Object.values(MENU).find(m=> text.includes(m.name.toLowerCase()) || text.includes('d√∂ner'));
      if (f) { speak(`${f.name} fiyatƒ± ${f.basePrice} lira efendim`); return; }
    }

    // Removal commands applied to last added item: "tur≈üusuz" etc.
    const rems = parseRemovalsFromText(text);
    if (rems.length>0 && cart.length>0) {
      cart[cart.length-1].notes = Array.from(new Set((cart[cart.length-1].notes || []).concat(rems)));
      updateCartUI();
      speak(`${rems.join(', ')} notu eklendi efendim`);
      return;
    }

    // Extras direct: "25 gr tavuk ekle" or "25 gram tavuk ekle"
    const extrasDirect = parseExtrasFromText(text);
    if (extrasDirect.length>0 && menuFlow.item) {
      menuFlow.pendingExtras = menuFlow.pendingExtras.concat(extrasDirect);
      speak(`${extrasDirect.map(e=>e).join(', ')} ekstrasƒ± eklendi. Ka√ß porsiyon olsun?`);
      menuFlow.awaitingQty = true;
      return;
    }

    // fallback
    speak('Restoranda sizi tam olarak anlayamadƒ±m, tekrar eder misiniz?');
    return;
  }

  // if mode not set
  speak('L√ºtfen √∂nce Market veya Restaurant se√ßin.');
}

/* ----------------- Parsers ----------------- */
function findProductByName(text) {
  for (const k in PRODUCTS) {
    const p = PRODUCTS[k];
    if (text.includes(p.name.toLowerCase()) || text.includes(k)) return p;
  }
  return null;
}
function findMenuByName(text) {
  for (const k in MENU) {
    const m = MENU[k];
    if (text.includes(m.name.toLowerCase()) || text.includes(k)) return m;
  }
  return null;
}
function parseRemovalsFromText(text) {
  // match "tur≈üusuz", "tur≈üu olmasƒ±n", "ket√ßapsƒ±z", "ket√ßap olmasƒ±n", "soƒüansƒ±z", "soƒüan olmasƒ±n"
  const removals = [];
  if (text.match(/tur≈üu(siz)?|tur≈üu olmasƒ±n|tur≈üu yok|tur≈üu istemiyorum/)) removals.push('tur≈üusuz');
  if (text.match(/ket√ßap(sƒ±z)?|ket√ßap olmasƒ±n|ket√ßap yok|ket√ßap istemiyorum/)) removals.push('ket√ßapsƒ±z');
  if (text.match(/soƒüan(sƒ±z)?|soƒüan olmasƒ±n|soƒüan yok|soƒüan istemiyorum/)) removals.push('soƒüansƒ±z');
  if (text.match(/mayonez olmasƒ±n|mayonez istemiyorum/)) removals.push('mayonezsiz');
  return removals;
}
function parseExtrasFromText(text, menuItem=null) {
  const extras = [];
  // look for "25 gr tavuk" or "25 gram tavuk" pattern
  const g = text.match(/(\d+)\s*(gr|gram)\s*(tavuk|et)?/);
  if (g) {
    // map to known extra codes if exists in menuItem
    const grams = parseInt(g[1]);
    const meat = g[3] || 'tavuk';
    // if menuItem has extras that match 25gr_tavuk, pick that
    if (menuItem && menuItem.extras) {
      const match = menuItem.extras.find(e => e.code.includes('25gr') && e.label.toLowerCase().includes(meat));
      if (match) extras.push(match.code);
    } else {
      // fallback generic code
      extras.push(`${grams}gr_${meat}`);
    }
  }
  // detect "peynir" extra words
  if (text.includes('peynir') && menuItem && menuItem.extras) {
    const ex = menuItem.extras.find(e=> e.label.toLowerCase().includes('peynir'));
    if (ex) extras.push(ex.code);
  }
  return extras;
}

/* ----------------- Helpers ----------------- */
function highlightAisle(aisle) {
  const shelf = Array.from(document.querySelectorAll('.shelf')).find(s=>s.dataset.aisle===aisle);
  if (!shelf) { speak('O reyon bulunamadƒ±'); return; }
  shelf.style.boxShadow = '0 18px 40px rgba(14,165,164,0.12)';
  setTimeout(()=> shelf.style.boxShadow = '', 2500);
}

function maybeAskDrink() {
  // if cart has no drink-like item (we treat items with name including 'su'|'kola'|'ayran' as drinks)
  const hasDrink = cart.some(it => /su|kola|ayran|icecek|i√ßecek/i.test(it.name));
  if (!hasDrink) {
    // ask the user
    speak('ƒ∞√ßecek ister misiniz Ay≈üe Teyze?');
    // set temporary recognition to capture yes/no
    if (!recognition) return;
    // we'll listen once and process yes/no
    const tmp = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    tmp.lang = 'tr-TR';
    tmp.interimResults = false;
    tmp.maxAlternatives = 1;
    tmp.onresult = (e) => {
      const t = e.results[0][0].transcript.toLowerCase();
      if (t.includes('evet') || t.includes('isterim') || t.includes('var')) {
        // present drink options via TTS and manual fallback
        speak('Hangi i√ßecek istersiniz? Su, kola, ayran?');
        // start a new recognition to capture which drink
        const tmp2 = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        tmp2.lang = 'tr-TR';
        tmp2.interimResults = false;
        tmp2.maxAlternatives = 1;
        tmp2.onresult = (ev2) => {
          const drink = ev2.results[0][0].transcript.toLowerCase();
          let drinkKey = null;
          if (drink.includes('su')) drinkKey = { id:'su', name:'Su', price:5 };
          else if (drink.includes('kola')) drinkKey = { id:'kola', name:'Kola', price:20 };
          else if (drink.includes('ayran')) drinkKey = { id:'ayran', name:'Ayran', price:8 };
          if (drinkKey) {
            cart.push({ id:drinkKey.id, name:drinkKey.name, qty:1, unit:'adet', price:drinkKey.price, notes:[], extras:[] });
            updateCartUI(); speak(`${drinkKey.name} sepete eklendi efendim`);
          } else {
            speak('ƒ∞√ßecek se√ßilmedi, tamamdƒ±r efendim');
          }
        };
        tmp2.onend = ()=> {};
        tmp2.onerror = ()=> {};
        try { tmp2.start(); } catch(e){ console.log('tmp2 err', e); }
      } else {
        speak('Tamam efendim, i√ßecek eklemiyoruz.');
      }
    };
    tmp.onerror = ()=>{};
    try { tmp.start(); } catch(e){ console.log('tmp err', e); }
  }
}

/* ----------------- Menu flow starter ----------------- */
function startMenuFlow(menuItem) {
  // set flow and ask variant if exists
  menuFlow.item = menuItem;
  menuFlow.pendingExtras = [];
  menuFlow.pendingNotes = [];
  menuFlow.pendingQty = 1;
  if (menuItem.variants && menuItem.variants.length>0) {
    menuFlow.awaitingVariant = true;
    speak(`${menuItem.name} se√ßtiniz. Et mi tavuk mu olsun efendim?`);
  } else {
    menuFlow.awaitingQty = true;
    speak('Ka√ß porsiyon olsun efendim?');
  }
}

/* ----------------- Parsers test helpers ----------------- */
function testParse(text) {
  console.log('parseRemovals:', parseRemovalsFromText(text));
  console.log('parseExtras:', parseExtrasFromText(text));
}

/* initial greeting */
speak('Demo v2 ye ho≈ügeldiniz. Market veya Restaurant se√ßin, sonra sesle komut verin.');

</script>
</body>
</html>
