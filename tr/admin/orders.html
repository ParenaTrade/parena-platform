<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sipariş Yönetimi - Paket Kapında</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
        }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: #f8fafc;
        }
        
        .card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #059669;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .form-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-draft {
            background-color: #f3f4f6;
            color: #374151;
        }
        
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-confirmed {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-shipped {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .status-completed {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .status-cancelled {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .data-table th {
            background-color: #f9fafb;
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .data-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
        }
        
        .data-table tr:last-child td {
            border-bottom: none;
        }
        
        .data-table tr:hover {
            background-color: #f9fafb;
        }
        
        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            z-index: 1000;
            animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
            max-width: 350px;
        }
        
        .toast-success {
            background-color: var(--success-color);
        }
        
        .toast-error {
            background-color: var(--danger-color);
        }
        
        .toast-icon {
            margin-right: 0.75rem;
            font-size: 1.25rem;
        }
        
        @keyframes toastIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes toastOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-container {
            background-color: white;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: auto;
            padding: 0;
            transform: translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .modal-overlay.active .modal-container {
            transform: translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .modal-close:hover {
            color: #374151;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .loader {
            border: 3px solid #f3f4f6;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #d1d5db;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 0.5rem;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .stat-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.75rem;
            font-size: 1.5rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        @media (max-width: 768px) {
            .data-table {
                font-size: 0.75rem;
            }
            
            .data-table th,
            .data-table td {
                padding: 0.5rem;
            }
            
            .modal-container {
                width: 95%;
                margin: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <!-- Başlık ve Kullanıcı Bilgisi -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-shopping-cart mr-2 text-indigo-600"></i> Sipariş Yönetimi
                </h1>
                <p class="text-gray-600 mt-1">Tüm siparişlerinizi görüntüleyin ve yönetin</p>
            </div>
            
            <div class="mt-4 md:mt-0 bg-white p-3 rounded-lg shadow-sm flex items-center">
                <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                <span id="userName" class="font-medium">Yükleniyor...</span>
                <span class="bg-indigo-100 text-indigo-800 text-xs font-medium ml-2 px-2.5 py-0.5 rounded" id="userRole"></span>
            </div>
        </div>
        
        <!-- İstatistik Kartları -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon bg-indigo-100 text-indigo-600">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">Toplam Sipariş</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon bg-yellow-100 text-yellow-600">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-value" id="pendingOrders">0</div>
                <div class="stat-label">Bekleyen Sipariş</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon bg-blue-100 text-blue-600">
                    <i class="fas fa-truck"></i>
                </div>
                <div class="stat-value" id="shippedOrders">0</div>
                <div class="stat-label">Kargodaki Sipariş</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon bg-green-100 text-green-600">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-value" id="completedOrders">0</div>
                <div class="stat-label">Tamamlanan Sipariş</div>
            </div>
        </div>
        
        <!-- Filtreler ve Arama -->
        <div class="card mb-6">
            <div class="p-5">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Durum</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">Tüm Durumlar</option>
                            <option value="draft">Taslak</option>
                            <option value="pending">Beklemede</option>
                            <option value="confirmed">Onaylandı</option>
                            <option value="shipped">Kargoda</option>
                            <option value="completed">Tamamlandı</option>
                            <option value="cancelled">İptal Edildi</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Başlangıç Tarihi</label>
                        <input type="date" class="form-input" id="dateFrom">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bitiş Tarihi</label>
                        <input type="date" class="form-input" id="dateTo">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Müşteri</label>
                        <select class="form-select" id="customerFilter">
                            <option value="">Tüm Müşteriler</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <div class="relative flex-1">
                        <input type="text" id="searchOrder" placeholder="Sipariş no, müşteri adı veya ürün ara..." class="form-input pl-10">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    
                    <button class="btn btn-primary" id="newOrderBtn">
                        <i class="fas fa-plus mr-2"></i> Yeni Sipariş
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Sipariş Listesi -->
        <div class="card">
            <div class="p-5 border-b border-gray-200">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <h2 class="text-xl font-semibold text-gray-800">Sipariş Listesi</h2>
                    <div class="text-sm text-gray-600 mt-2 md:mt-0">
                        Toplam <span class="font-medium" id="filteredOrdersCount">0</span> sipariş
                    </div>
                </div>
            </div>
            
            <div class="p-5">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Sipariş No</th>
                                <th>Müşteri</th>
                                <th>Oluşturulma</th>
                                <th>Teslim Tarihi</th>
                                <th>Tutar</th>
                                <th>Durum</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <tr>
                                <td colspan="7" class="text-center py-8">
                                    <div class="flex justify-center">
                                        <div class="loader"></div>
                                    </div>
                                    <p class="mt-2 text-gray-500">Siparişler yükleniyor...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="flex items-center justify-between border-t border-gray-200 pt-4 mt-4">
                    <div class="text-sm text-gray-700" id="paginationInfo">
                        0 sonuçtan 0-0 gösteriliyor
                    </div>
                    <div class="flex space-x-2" id="paginationControls">
                        <button class="btn btn-secondary btn-sm" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="btn btn-secondary btn-sm" disabled>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Yeni Sipariş Modal -->
    <div class="modal-overlay" id="newOrderModal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">Yeni Sipariş Oluştur</h3>
                <button class="modal-close" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="newOrderForm" class="modal-body">
                <div class="grid grid-cols-1 gap-4 mb-4">
                    <!-- Admin için Satıcı Seçimi -->
                    <div id="sellerSelectionRow" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Satıcı Seçin <span class="text-red-500">*</span></label>
                        <select class="form-select" id="sellerSelect">
                            <option value="">Satıcı seçin</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Müşteri Seçin <span class="text-red-500">*</span></label>
                            <select class="form-select" id="customerSelect" required>
                                <option value="">Müşteri seçin</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Teslim Tarihi <span class="text-red-500">*</span></label>
                            <input type="date" class="form-input" id="deliveryDate" required>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ürünler <span class="text-red-500">*</span></label>
                    <div class="card p-4">
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-2 mb-3">
                            <div class="md:col-span-5">
                                <select class="form-select" id="productSelect">
                                    <option value="">Ürün seçin</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <input type="number" class="form-input" id="productQuantity" placeholder="Miktar" min="1" value="1">
                            </div>
                            <div class="md:col-span-3">
                                <input type="number" class="form-input" id="productPrice" placeholder="Birim Fiyat" step="0.01">
                            </div>
                            <div class="md:col-span-2">
                                <button type="button" class="btn btn-primary w-full" id="addProductBtn">
                                    <i class="fas fa-plus"></i> Ekle
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="data-table" id="selectedProductsTable">
                                <thead>
                                    <tr>
                                        <th>Ürün</th>
                                        <th>Miktar</th>
                                        <th>Birim Fiyat</th>
                                        <th>KDV</th>
                                        <th>Tutar</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="4" class="text-right">Ara Toplam:</th>
                                        <th id="subtotalAmount">0.00 ₺</th>
                                        <th></th>
                                    </tr>
                                    <tr>
                                        <th colspan="4" class="text-right">KDV Toplam:</th>
                                        <th id="taxAmount">0.00 ₺</th>
                                        <th></th>
                                    </tr>
                                    <tr class="font-bold">
                                        <th colspan="4" class="text-right">Genel Toplam:</th>
                                        <th id="totalAmount">0.00 ₺</th>
                                        <th></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notlar</label>
                    <textarea class="form-input" id="orderNotes" rows="3" placeholder="Sipariş ile ilgili notlar..."></textarea>
                </div>
            </form>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelBtn">İptal</button>
                <button class="btn btn-primary" id="saveOrderBtn">
                    <span id="saveButtonText">Siparişi Kaydet</span>
                    <div class="loader" id="saveLoader" style="display: none;"></div>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast Bildirimi Konteyneri -->
    <div id="toastContainer"></div>

    <script>
        // Supabase bağlantı bilgileri
        const SUPABASE_URL = "https://xliutvspwodhoaxvysks.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsaXV0dnNwd29kaG9heHZ5c2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTgyOTksImV4cCI6MjA3MjkzNDI5OX0.Zodisa_ifP8t2Q4X0ecnB56RiR_Bg4QS5gvPn5ZLK_w";
        
        // Supabase istemcisini oluştur
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global değişkenler
        let currentUser = null;
        let currentUserId = null;
        let currentUserRole = null;
        let selectedProducts = [];
        let selectedSellerId = null;
        let allOrders = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        
        // DOM yüklendikten sonra
        document.addEventListener("DOMContentLoaded", async () => {
            // Oturum kontrolü
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            
            if (sessionError) {
                console.error("Oturum kontrolü hatası:", sessionError);
                showToast("Oturum kontrolü sırasında hata oluştu", "error");
                return;
            }
            
            if (!session) {
                window.location.href = "..login.html";
                return;
            }
            
            currentUser = session.user;
            currentUserId = session.user.id;
            
            try {
                // Veritabanı şemasını kontrol et ve gerekli tabloları oluştur
                await checkAndCreateTables();
                
                // Kullanıcı bilgilerini al
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', currentUserId)
                    .single();
                
                if (userError) {
                    console.error("Kullanıcı bilgileri alınamadı:", userError);
                    showToast("Kullanıcı bilgileri alınamadı", "error");
                    return;
                }
                
                currentUserRole = userData.role;
                
                // Kullanıcı bilgilerini arayüzde göster
                document.getElementById("userName").textContent = userData.name || userData.email;
                document.getElementById("userRole").textContent = currentUserRole === 'admin' ? 'Yönetici' : 'Satıcı';
                
                // Müşterileri yükle
                await loadCustomers();
                
                // Admin ise satıcıları yükle
                if (currentUserRole === 'admin') {
                    document.getElementById("sellerSelectionRow").classList.remove("hidden");
                    await loadSellers();
                } else {
                    // Satıcı ise doğrudan kendi ürünlerini yükle
                    await loadProducts(currentUserId);
                }
                
                // Siparişleri yükle
                await loadOrders();
                
                // Event listener'ları ekle
                setupEventListeners();
                
            } catch (error) {
                console.error("Başlatma hatası:", error);
                showToast("Sistem başlatılırken hata oluştu", "error");
            }
        });
        
        // Veritabanı şemasını kontrol et ve gerekli tabloları oluştur
        async function checkAndCreateTables() {
            try {
                // Orders tablosunu kontrol et
                const { error: ordersError } = await supabase
                    .from('orders')
                    .select('id')
                    .limit(1);
                
                // Eğer orders tablosu yoksa veya erişim hatası varsa
                if (ordersError && ordersError.code === '42P01') {
                    console.log("Orders tablosu bulunamadı, oluşturuluyor...");
                    // Tablo oluşturma işlemi için RPC çağrısı yapılabilir
                    // Veya manuel olarak tabloyu oluşturmak gerekir
                    showToast("Veritabanı hazırlanıyor...", "info");
                    
                    // Bu noktada manuel olarak tabloları oluşturmanız gerekebilir
                    // Aşağıdaki SQL'i Supabase SQL Editor'de çalıştırın:
                    /*
                    CREATE TABLE orders (
                        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                        order_number TEXT,
                        customer_id UUID REFERENCES users(id),
                        customer_name TEXT,
                        items JSONB,
                        subtotal NUMERIC,
                        total_tax NUMERIC,
                        total_amount NUMERIC,
                        status TEXT DEFAULT 'draft',
                        notes TEXT,
                        seller_id UUID REFERENCES users(id),
                        delivery_date TIMESTAMP,
                        created_at TIMESTAMP DEFAULT NOW(),
                        updated_at TIMESTAMP DEFAULT NOW()
                    );
                    */
                }
                
                // Diğer tablolar için benzer kontroller yapılabilir
                
            } catch (error) {
                console.error("Tablo kontrol hatası:", error);
                throw error;
            }
        }
        
        // Event listener'ları kur
        function setupEventListeners() {
            // Filtre değişikliklerini dinle
            document.getElementById("statusFilter").addEventListener("change", loadOrders);
            document.getElementById("customerFilter").addEventListener("change", loadOrders);
            document.getElementById("dateFrom").addEventListener("change", loadOrders);
            document.getElementById("dateTo").addEventListener("change", loadOrders);
            
            // Arama kutusu
            document.getElementById("searchOrder").addEventListener("input", debounce(loadOrders, 300));
            
            // Yeni sipariş butonu
            document.getElementById("newOrderBtn").addEventListener("click", () => {
                openNewOrderModal();
            });
            
            // Modal kapatma butonu
            document.getElementById("closeModal").addEventListener("click", () => {
                closeNewOrderModal();
            });
            
            // İptal butonu
            document.getElementById("cancelBtn").addEventListener("click", () => {
                closeNewOrderModal();
            });
            
            // Ürün ekleme butonu
            document.getElementById("addProductBtn").addEventListener("click", addProductToOrder);
            
            // Sipariş kaydetme butonu
            document.getElementById("saveOrderBtn").addEventListener("click", saveNewOrder);
            
            // Satıcı seçimini dinle (sadece admin için)
            if (document.getElementById("sellerSelect")) {
                document.getElementById("sellerSelect").addEventListener("change", () => {
                    selectedSellerId = document.getElementById("sellerSelect").value;
                    loadProducts(selectedSellerId);
                });
            }
        }
        
        // Müşterileri yükle
        async function loadCustomers() {
            try {
                let query = supabase
                    .from('users')
                    .select('*')
                    .eq('role', 'buyer')
                    .eq('confirm', true);
                
                // Eğer kullanıcı seller ise, sadece kendi müşterilerini göster
                if (currentUserRole === 'seller') {
                    query = query.eq('seller_id', currentUserId);
                }
                
                const { data: customers, error } = await query;
                
                if (error) {
                    console.error("Müşteriler yüklenirken hata oluştu:", error);
                    showToast("Müşteriler yüklenirken hata oluştu", "error");
                    return;
                }
                
                const customerFilter = document.getElementById("customerFilter");
                const customerSelect = document.getElementById("customerSelect");
                
                customerFilter.innerHTML = '<option value="">Tüm Müşteriler</option>';
                customerSelect.innerHTML = '<option value="">Müşteri seçin</option>';
                
                customers.forEach(customer => {
                    const option = `<option value="${customer.id}">${customer.company_name || customer.name}</option>`;
                    customerFilter.innerHTML += option;
                    customerSelect.innerHTML += option;
                });
            } catch (error) {
                console.error("Müşteriler yüklenirken hata oluştu:", error);
                showToast("Müşteriler yüklenirken hata oluştu", "error");
            }
        }
        
        // Satıcıları yükle (sadece admin için)
        async function loadSellers() {
            try {
                const { data: sellers, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('role', 'seller')
                    .eq('confirm', true);
                
                if (error) {
                    console.error("Satıcılar yüklenirken hata oluştu:", error);
                    showToast("Satıcılar yüklenirken hata oluştu", "error");
                    return;
                }
                
                const sellerSelect = document.getElementById("sellerSelect");
                sellerSelect.innerHTML = '<option value="">Satıcı seçin</option>';
                
                sellers.forEach(seller => {
                    sellerSelect.innerHTML += `<option value="${seller.id}">${seller.company_name || seller.name}</option>`;
                });
            } catch (error) {
                console.error("Satıcılar yüklenirken hata oluştu:", error);
                showToast("Satıcılar yüklenirken hata oluştu", "error");
            }
        }
        
        // Ürünleri yükle
        async function loadProducts(sellerId = null) {
            try {
                // Eğer sellerId belirtilmemişse, mevcut kullanıcıyı kullan
                if (!sellerId && currentUserRole === 'seller') {
                    sellerId = currentUserId;
                }
                
                let query = supabase
                    .from('products')
                    .select('*');
                
                // Eğer sellerId belirtilmişse, o satıcının ürünlerini filtrele
                if (sellerId) {
                    query = query.eq('seller_id', sellerId);
                }
                
                const { data: products, error } = await query;
                
                if (error) {
                    console.error("Ürünler yüklenirken hata oluştu:", error);
                    showToast("Ürünler yüklenirken hata oluştu", "error");
                    return;
                }
                
                const productSelect = document.getElementById("productSelect");
                productSelect.innerHTML = '<option value="">Ürün seçin</option>';
                
                if (!products || products.length === 0) {
                    productSelect.innerHTML += '<option value="" disabled>Ürün bulunamadı</option>';
                    return;
                }
                
                products.forEach(product => {
                    productSelect.innerHTML += `
                        <option value="${product.id}" data-price="${product.price}" data-tax="${product.vat || 0}">
                            ${product.name} - ${product.price} ₺
                        </option>
                    `;
                });
            } catch (error) {
                console.error("Ürünler yüklenirken hata oluştu:", error);
                showToast("Ürünler yüklenirken hata oluştu", "error");
            }
        }
        
        // Siparişleri yükle
        async function loadOrders() {
            try {
                const ordersTableBody = document.getElementById("ordersTableBody");
                ordersTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8">
                            <div class="flex justify-center">
                                <div class="loader"></div>
                            </div>
                            <p class="mt-2 text-gray-500">Siparişler yükleniyor...</p>
                        </td>
                    </tr>
                `;
                
                let query = supabase
                    .from('orders')
                    .select('*');
                
                // Eğer kullanıcı admin değilse, sadece kendi siparişlerini çek
                if (currentUserRole === 'seller') {
                    query = query.eq('seller_id', currentUserId);
                }
                
                // Durum filtresi
                const statusFilter = document.getElementById("statusFilter").value;
                if (statusFilter) {
                    query = query.eq('status', statusFilter);
                }
                
                // Müşteri filtresi
                const customerFilter = document.getElementById("customerFilter").value;
                if (customerFilter) {
                    query = query.eq('customer_id', customerFilter);
                }
                
                // Tarih filtreleri
                const dateFrom = document.getElementById("dateFrom").value;
                const dateTo = document.getElementById("dateTo").value;
                
                if (dateFrom) {
                    query = query.gte('created_at', dateFrom);
                }
                
                if (dateTo) {
                    // Bitiş tarihine 1 gün ekleyerek o günü de dahil et
                    const endDate = new Date(dateTo);
                    endDate.setDate(endDate.getDate() + 1);
                    query = query.lt('created_at', endDate.toISOString().split('T')[0]);
                }
                
                // Sıralama
                query = query.order('created_at', { ascending: false });
                
                // Verileri çek
                const { data: orders, error } = await query;
                
                if (error) {
                    console.error("Siparişler yüklenirken hata oluştu:", error);
                    showToast("Siparişler yüklenirken hata oluştu", "error");
                    
                    ordersTableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-8 text-red-600">
                                <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                                <p>Siparişler yüklenirken bir hata oluştu</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                if (!orders || orders.length === 0) {
                    ordersTableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-8">
                                <div class="empty-state">
                                    <i class="fas fa-shopping-cart"></i>
                                    <h3 class="text-lg font-medium text-gray-900 mt-2">Henüz sipariş bulunmamaktadır</h3>
                                    <p class="text-gray-500">Yeni bir sipariş oluşturmak için "Yeni Sipariş" butonuna tıklayın.</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    
                    updateOrderStats([]);
                    return;
                }
                
                // Müşteri isimlerini al
                const customerIds = [...new Set(orders.map(order => order.customer_id))];
                const { data: customers, error: customersError } = await supabase
                    .from('users')
                    .select('id, name, company_name')
                    .in('id', customerIds);
                
                if (!customersError) {
                    const customerMap = {};
                    customers.forEach(customer => {
                        customerMap[customer.id] = customer.company_name || customer.name;
                    });
                    
                    // Müşteri isimlerini siparişlere ekle
                    orders.forEach(order => {
                        order.customer_name = customerMap[order.customer_id] || 'Bilinmeyen Müşteri';
                    });
                }
                
                // Arama terimi
                const searchTerm = document.getElementById("searchOrder").value.toLowerCase();
                
                // Arama terimi ile filtrele
                const filteredOrders = searchTerm 
                    ? orders.filter(order => 
                          (order.order_number && order.order_number.toLowerCase().includes(searchTerm)) ||
                          (order.customer_name && order.customer_name.toLowerCase().includes(searchTerm))
                      )
                    : orders;
                
                allOrders = filteredOrders;
                updateOrderStats(filteredOrders);
                renderOrdersTable(filteredOrders);
                
            } catch (error) {
                console.error("Siparişler yüklenirken hata oluştu:", error);
                showToast("Siparişler yüklenirken hata oluştu", "error");
                
                document.getElementById("ordersTableBody").innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8 text-red-600">
                            <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                            <p>Siparişler yüklenirken bir hata oluştu</p>
                        </td>
                    </tr>
                `;
            }
        }
        
        // Sipariş istatistiklerini güncelle
        function updateOrderStats(orders) {
            const totalOrders = orders.length;
            const pendingOrders = orders.filter(order => order.status === 'pending').length;
            const shippedOrders = orders.filter(order => order.status === 'shipped').length;
            const completedOrders = orders.filter(order => order.status === 'completed').length;
            
            document.getElementById("totalOrders").textContent = totalOrders;
            document.getElementById("pendingOrders").textContent = pendingOrders;
            document.getElementById("shippedOrders").textContent = shippedOrders;
            document.getElementById("completedOrders").textContent = completedOrders;
            document.getElementById("filteredOrdersCount").textContent = totalOrders;
        }
        
        // Siparişler tablosunu render et
        function renderOrdersTable(orders) {
            const ordersTableBody = document.getElementById("ordersTableBody");
            
            if (orders.length === 0) {
                ordersTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8">
                            <div class="empty-state">
                                <i class="fas fa-search"></i>
                                <h3 class="text-lg font-medium text-gray-900 mt-2">Sipariş bulunamadı</h3>
                                <p class="text-gray-500">Filtre kriterlerinize uygun sipariş bulunamadı.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sayfalama
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedOrders = orders.slice(startIndex, endIndex);
            
            // Sayfalama bilgilerini güncelle
            updatePaginationInfo(orders.length);
            
            // Tabloyu doldur
            ordersTableBody.innerHTML = paginatedOrders.map(order => {
                // Tarih formatlama
                const createdDate = order.created_at ? new Date(order.created_at).toLocaleDateString('tr-TR') : '-';
                const deliveryDate = order.delivery_date ? new Date(order.delivery_date).toLocaleDateString('tr-TR') : '-';
                
                // Durum badge'i
                let statusClass = '';
                let statusText = '';
                
                switch(order.status) {
                    case 'draft':
                        statusClass = 'status-draft';
                        statusText = 'Taslak';
                        break;
                    case 'pending':
                        statusClass = 'status-pending';
                        statusText = 'Beklemede';
                        break;
                    case 'confirmed':
                        statusClass = 'status-confirmed';
                        statusText = 'Onaylandı';
                        break;
                    case 'shipped':
                        statusClass = 'status-shipped';
                        statusText = 'Kargoda';
                        break;
                    case 'completed':
                        statusClass = 'status-completed';
                        statusText = 'Tamamlandı';
                        break;
                    case 'cancelled':
                        statusClass = 'status-cancelled';
                        statusText = 'İptal Edildi';
                        break;
                    default:
                        statusClass = 'status-draft';
                        statusText = 'Taslak';
                }
                
                return `
                    <tr>
                        <td class="font-medium">${order.order_number || order.id}</td>
                        <td>${order.customer_name || 'Bilinmeyen Müşteri'}</td>
                        <td>${createdDate}</td>
                        <td>${deliveryDate}</td>
                        <td>${order.total_amount ? order.total_amount.toFixed(2) + ' ₺' : '0.00 ₺'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <div class="flex space-x-2">
                                <button class="btn btn-secondary btn-sm view-order" data-id="${order.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-secondary btn-sm edit-order" data-id="${order.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm delete-order" data-id="${order.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join("");
            
            // Sipariş görüntüleme ve düzenleme butonlarına event listener ekle
            document.querySelectorAll('.view-order').forEach(button => {
                button.addEventListener('click', () => {
                    const orderId = button.getAttribute('data-id');
                    viewOrder(orderId);
                });
            });
            
            document.querySelectorAll('.edit-order').forEach(button => {
                button.addEventListener('click', () => {
                    const orderId = button.getAttribute('data-id');
                    editOrder(orderId);
                });
            });
            
            document.querySelectorAll('.delete-order').forEach(button => {
                button.addEventListener('click', () => {
                    const orderId = button.getAttribute('data-id');
                    deleteOrder(orderId);
                });
            });
        }
        
        // Sayfalama bilgilerini güncelle
        function updatePaginationInfo(totalItems) {
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(startIndex + itemsPerPage - 1, totalItems);
            
            document.getElementById("paginationInfo").textContent = 
                `${totalItems} sonuçtan ${startIndex}-${endIndex} gösteriliyor`;
                
            // Önceki ve sonraki butonlarını güncelle
            const paginationControls = document.getElementById("paginationControls");
            paginationControls.innerHTML = `
                <button class="btn btn-secondary btn-sm" id="prevPage" ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="btn btn-secondary btn-sm" id="nextPage" ${endIndex >= totalItems ? 'disabled' : ''}>
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            // Buton event listener'larını ekle
            document.getElementById("prevPage").addEventListener("click", () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderOrdersTable(allOrders);
                }
            });
            
            document.getElementById("nextPage").addEventListener("click", () => {
                if (currentPage * itemsPerPage < allOrders.length) {
                    currentPage++;
                    renderOrdersTable(allOrders);
                }
            });
        }
        
        // Yeni sipariş modalını aç
        function openNewOrderModal() {
            document.getElementById("newOrderModal").classList.add("active");
            document.getElementById("newOrderForm").reset();
            selectedProducts = [];
            updateSelectedProductsTable();
        }
        
        // Yeni sipariş modalını kapat
        function closeNewOrderModal() {
            document.getElementById("newOrderModal").classList.remove("active");
        }
        
        // Siparişe ürün ekle
        function addProductToOrder() {
            const productSelect = document.getElementById("productSelect");
            const productId = productSelect.value;
            
            if (!productId) {
                showToast("Lütfen bir ürün seçin", "error");
                return;
            }
            
            const quantity = parseInt(document.getElementById("productQuantity").value) || 1;
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const price = parseFloat(document.getElementById("productPrice").value) || parseFloat(selectedOption.getAttribute("data-price"));
            const taxRate = parseFloat(selectedOption.getAttribute("data-tax")) || 0;
            const productName = selectedOption.text.split(' - ')[0];
            
            const subtotal = price * quantity;
            const taxAmount = subtotal * (taxRate / 100);
            const total = subtotal + taxAmount;
            
            // Ürünü selectedProducts dizisine ekle
            selectedProducts.push({
                productId,
                productName,
                quantity,
                unitPrice: price,
                taxRate,
                lineTotal: total
            });
            
            // Tabloyu güncelle
            updateSelectedProductsTable();
            
            // Ürün ekleme formunu sıfırla
            productSelect.value = "";
            document.getElementById("productQuantity").value = "1";
            document.getElementById("productPrice").value = "";
        }
        
        // Seçili ürünler tablosunu güncelle
        function updateSelectedProductsTable() {
            const tableBody = document.getElementById("selectedProductsTable").querySelector("tbody");
            tableBody.innerHTML = "";
            
            let subtotal = 0;
            let totalTax = 0;
            
            selectedProducts.forEach((product, index) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${product.productName}</td>
                    <td>${product.quantity}</td>
                    <td>${product.unitPrice.toFixed(2)} ₺</td>
                    <td>${product.taxRate}%</td>
                    <td>${product.lineTotal.toFixed(2)} ₺</td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm remove-product" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
                
                subtotal += product.unitPrice * product.quantity;
                totalTax += (product.unitPrice * product.quantity) * (product.taxRate / 100);
            });
            
            const total = subtotal + totalTax;
            
            document.getElementById("subtotalAmount").textContent = subtotal.toFixed(2) + " ₺";
            document.getElementById("taxAmount").textContent = totalTax.toFixed(2) + " ₺";
            document.getElementById("totalAmount").textContent = total.toFixed(2) + " ₺";
            
            // Ürün kaldırma butonlarına event listener ekle
            document.querySelectorAll(".remove-product").forEach(button => {
                button.addEventListener("click", () => {
                    const index = parseInt(button.getAttribute("data-index"));
                    selectedProducts.splice(index, 1);
                    updateSelectedProductsTable();
                });
            });
        }
        
        // Yeni sipariş kaydet
        async function saveNewOrder() {
            const customerId = document.getElementById("customerSelect").value;
            const deliveryDate = document.getElementById("deliveryDate").value;
            const notes = document.getElementById("orderNotes").value;
            
            if (!customerId) {
                showToast("Lütfen bir müşteri seçin", "error");
                return;
            }
            
            if (selectedProducts.length === 0) {
                showToast("Lütfen en az bir ürün ekleyin", "error");
                return;
            }
            
            if (!deliveryDate) {
                showToast("Lütfen teslim tarihini belirtin", "error");
                return;
            }
            
            // Satıcı ID'sini belirle (admin ise seçileni, değilse mevcut kullanıcıyı kullan)
            let sellerId = currentUserId;
            if (currentUserRole === 'admin') {
                sellerId = document.getElementById("sellerSelect").value;
                if (!sellerId) {
                    showToast("Lütfen bir satıcı seçin", "error");
                    return;
                }
            }
            
            // Butonu yükleniyor durumuna getir
            document.getElementById("saveButtonText").textContent = "Kaydediliyor...";
            document.getElementById("saveLoader").style.display = "inline-block";
            document.getElementById("saveOrderBtn").disabled = true;
            
            try {
                // Müşteri bilgilerini al
                const { data: customer, error: customerError } = await supabase
                    .from('users')
                    .select('name, company_name')
                    .eq('id', customerId)
                    .single();
                
                if (customerError) {
                    throw new Error("Müşteri bilgileri alınamadı: " + customerError.message);
                }
                
                const customerName = customer.company_name || customer.name;
                
                // Toplamları hesapla
                let subtotal = 0;
                let totalTax = 0;
                
                selectedProducts.forEach(product => {
                    subtotal += product.unitPrice * product.quantity;
                    totalTax += (product.unitPrice * product.quantity) * (product.taxRate / 100);
                });
                
                const totalAmount = subtotal + totalTax;
                
                // Sipariş numarası oluştur (YYYYMMDD-XXXX formatında)
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10).replace(/-/g, "");
                const randomNum = Math.floor(1000 + Math.random() * 9000);
                const orderNumber = `${dateStr}-${randomNum}`;
                
                // Sipariş nesnesi oluştur
                const newOrder = {
                    order_number: orderNumber,
                    customer_id: customerId,
                    customer_name: customerName,
                    items: selectedProducts,
                    subtotal,
                    total_tax: totalTax,
                    total_amount: totalAmount,
                    status: 'draft',
                    notes,
                    seller_id: sellerId,
                    delivery_date: deliveryDate
                };
                
                // Supabase'e kaydet
                const { data, error } = await supabase
                    .from('orders')
                    .insert([newOrder])
                    .select();
                
                if (error) {
                    throw new Error("Sipariş kaydedilemedi: " + error.message);
                }
                
                showToast("Sipariş başarıyla oluşturuldu!", "success");
                closeNewOrderModal();
                
                // Sipariş listesini yenile
                await loadOrders();
                
            } catch (error) {
                console.error("Sipariş kaydedilirken hata oluştu: ", error);
                showToast(error.message, "error");
            } finally {
                // Butonu eski haline getir
                document.getElementById("saveButtonText").textContent = "Siparişi Kaydet";
                document.getElementById("saveLoader").style.display = "none";
                document.getElementById("saveOrderBtn").disabled = false;
            }
        }
        
        // Sipariş görüntüle
        function viewOrder(orderId) {
            // Sipariş detaylarını göster
            alert(orderId + " numaralı sipariş görüntülenecek");
            // Burada sipariş detay sayfasına yönlendirme yapılabilir
        }
        
        // Sipariş düzenle
        function editOrder(orderId) {
            // Sipariş düzenleme modülünü aç
            alert(orderId + " numaralı sipariş düzenlenecek");
            // Burada sipariş düzenleme modal'ını açılabilir
        }
        
        // Sipariş sil
        async function deleteOrder(orderId) {
            if (!confirm("Bu siparişi silmek istediğinize emin misiniz? Bu işlem geri alınamaz!")) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('orders')
                    .delete()
                    .eq('id', orderId);
                
                if (error) {
                    throw new Error("Sipariş silinemedi: " + error.message);
                }
                
                showToast("Sipariş başarıyla silindi!", "success");
                await loadOrders(); // Listeyi yenile
            } catch (error) {
                console.error("Sipariş silinirken hata oluştu: ", error);
                showToast(error.message, "error");
            }
        }
        
        // Toast bildirimi göster
        function showToast(message, type) {
            const toastContainer = document.getElementById("toastContainer");
            const toast = document.createElement("div");
            
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="toast-icon ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            toastContainer.appendChild(toast);
            
            // 3 saniye sonra toast'ı kaldır
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Debounce fonksiyonu
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>

</html>
