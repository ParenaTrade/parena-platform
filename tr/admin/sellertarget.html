<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satıcı Hedefleri Yönetimi - Paket Kapında</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
        }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: #f8fafc;
        }
        
        .card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #059669;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .form-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .badge-warning {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .badge-danger {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .badge-info {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .data-table th {
            background-color: #f9fafb;
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .data-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
        }
        
        .data-table tr:last-child td {
            border-bottom: none;
        }
        
        .data-table tr:hover {
            background-color: #f9fafb;
        }
        
        .progress-bar {
            height: 0.5rem;
            background-color: #e5e7eb;
            border-radius: 0.25rem;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 0.25rem;
            transition: width 0.3s ease;
        }
        
        .progress-success {
            background-color: var(--success-color);
        }
        
        .progress-warning {
            background-color: var(--warning-color);
        }
        
        .progress-danger {
            background-color: var(--danger-color);
        }
        
        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            z-index: 1000;
            animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
            max-width: 350px;
        }
        
        .toast-success {
            background-color: var(--success-color);
        }
        
        .toast-error {
            background-color: var(--danger-color);
        }
        
        .toast-icon {
            margin-right: 0.75rem;
            font-size: 1.25rem;
        }
        
        @keyframes toastIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes toastOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-container {
            background-color: white;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: auto;
            padding: 0;
            transform: translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .modal-overlay.active .modal-container {
            transform: translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .modal-close:hover {
            color: #374151;
        }
        
        .modal-body {
            padding: 1.5rem;
            max-height: calc(90vh - 130px);
            overflow-y: auto;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #d1d5db;
        }
        
        @media (max-width: 768px) {
            .data-table {
                font-size: 0.75rem;
            }
            
            .data-table th,
            .data-table td {
                padding: 0.5rem;
            }
            
            .modal-container {
                width: 95%;
                margin: 1rem;
            }
        }

        

.status-completed {
    background-color: var(--success-color);
    color: white;
}

.progress-bar-container {
    width: 100%;
    height: 8px;
    background-color: #e5e7eb;
    border-radius: 4px;
    margin-top: 5px;
}

.progress-bar-fill {
    height: 100%;
    background-color: var(--primary-color);
    border-radius: 4px;
    transition: width 0.3s ease;
}

    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <!-- Başlık ve Kullanıcı Bilgisi -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-bullseye mr-2 text-indigo-600"></i> Satıcı Hedefleri Yönetimi
                </h1>
                <p class="text-gray-600 mt-1">Satıcıların performans hedeflerini takip edin ve yönetin</p>
            </div>
            
             <div class="flex items-center space-x-3">
      <span id="userName" class="font-semibold text-sm">Yükleniyor...</span>
      <span id="userRole" class="text-gray-500 text-xs">Rol: Yükleniyor...</span>
      <span id="userStatus" class="w-3 h-3 rounded-full bg-gray-400 animate-pulse"></span>
      <button id="signOut" class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">Çıkış</button>
    </div>
    </div>    
        <!-- İstatistik Kartları -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="statsContainer">
            <div class="card p-4">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Toplam Hedef</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="totalTargets">0</h3>
                    </div>
                    <div class="bg-indigo-100 p-3 rounded-full">
                        <i class="fas fa-bullseye text-indigo-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="card p-4">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Toplam Ciro Hedefi</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="totalRevenue">0 USD</h3>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="card p-4">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Ortalama Büyüme</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="avgGrowth">0%</h3>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i class="fas fa-chart-line text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="card p-4">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Tamamlanan Hedefler</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="completedTargets">0</h3>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-full">
                        <i class="fas fa-check-circle text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hedefler Listesi -->
        <div class="card">
            <div class="p-5 border-b border-gray-200">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <h2 class="text-xl font-semibold text-gray-800">Hedefler Listesi</h2>
                    <button class="btn btn-primary mt-3 md:mt-0" id="newTargetBtn">
                        <i class="fas fa-plus mr-2"></i> Yeni Hedef
                    </button>
                </div>
            </div>
            
            <div class="p-5">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                    <div class="relative w-full sm:w-64 mb-3 sm:mb-0">
                        <input type="text" id="searchInput" placeholder="Hedef ara..." class="form-input pl-10">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    
                    <div class="flex space-x-2">
                        <select id="filterSeller" class="form-select">
                            <option value="">Tüm Satıcılar</option>
                        </select>
                        <select id="filterStatus" class="form-select">
                            <option value="">Tüm Durumlar</option>
                            <option value="active">Aktif</option>
                            <option value="completed">Tamamlandı</option>
                            <option value="expired">Süresi Dolmuş</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Satıcı</th>
                                <th>Hedef Ürün</th>
                                <th>Hedef Miktar</th>
                                <th>Hedef Ciro (USD)</th>
                                <th>Büyüme %</th>
                                <th>Süre (Ay)</th>
                                <th>Durum</th>
                                <th>İlerleme</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody id="targetsTableBody">
                            <tr>
                                <td colspan="9" class="text-center py-8">
                                    <div class="flex justify-center">
                                        <div class="loader"></div>
                                    </div>
                                    <p class="mt-2 text-gray-500">Hedefler yükleniyor...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="flex items-center justify-between border-t border-gray-200 pt-4 mt-4">
                    <div class="text-sm text-gray-700" id="paginationInfo">
                        0 sonuçtan 0-0 gösteriliyor
                    </div>
                    <div class="flex space-x-2" id="paginationControls">
                        <button class="btn btn-secondary btn-sm" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="btn btn-secondary btn-sm" disabled>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hedef Modal -->
    <div class="modal-overlay" id="targetModal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Yeni Hedef</h3>
                <button class="modal-close" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="targetForm" class="modal-body">
                <div class="grid grid-cols-1 gap-4">
                    <div id="sellerSelectRow">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Satıcı <span class="text-red-500">*</span></label>
                        <select class="form-select" id="sellerSelect" required>
                            <option value="">Seçin</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Hedef Ürün <span class="text-red-500">*</span></label>
                        <input type="text" class="form-input" id="productName" placeholder="Ürün adı" required>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Hedef Miktar <span class="text-red-500">*</span></label>
                            <input type="number" class="form-input" id="targetQuantity" placeholder="0" min="0" step="0.01" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Birim</label>
                            <select class="form-select" id="quantityUnit">
                                <option value="ton">Ton</option>
                                <option value="adet" selected>Adet</option>
                                <option value="litre">Litre</option>
                                <option value="kg">Kilogram</option>
                                <option value="m2">m²</option>
                                <option value="m3">m³</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Hedef Ciro (USD) <span class="text-red-500">*</span></label>
                        <input type="number" class="form-input" id="targetRevenue" placeholder="0" min="0" step="0.01" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Yıllık Büyüme Oranı (%) <span class="text-red-500">*</span></label>
                        <input type="number" class="form-input" id="growthRate" placeholder="0" min="0" step="0.01" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Hedef Süresi (Ay) <span class="text-red-500">*</span></label>
                        <input type="number" class="form-input" id="targetDuration" placeholder="0" min="1" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Başlangıç Tarihi</label>
                        <input type="date" class="form-input" id="startDate">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Açıklama</label>
                        <textarea class="form-input" id="description" rows="3" placeholder="Hedefle ilgili açıklama"></textarea>
                    </div>
                </div>
                
                <input type="hidden" id="editTargetId">
            </form>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelBtn">İptal</button>
                <button class="btn btn-primary" id="saveTargetBtn">
                    <span id="saveButtonText">Kaydet</span>
                    <div class="loader" id="saveLoader" style="display: none;"></div>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 flex flex-col space-y-2"></div>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabaseUrl = "https://xliutvspwodhoaxvysks.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsaXV0dnNwd29kaG9heHZ5c2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTgyOTksImV4cCI6MjA3MjkzNDI5OX0.Zodisa_ifP8t2Q4X0ecnB56RiR_Bg4QS5gvPn5ZLK_w";
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  // DOM elementlerini seçme
  const $ = id => document.getElementById(id);

  let currentUser = null;
  let currentUserRole = null;
  let allTargets = [];
  let currentPage = 1;
  let isAdmin = false;
  const itemsPerPage = 10;

  // DOM yüklendikten sonra
  document.addEventListener("DOMContentLoaded", async () => {
      // Kullanıcı bilgilerini yükle
      await loadUserInfo();
      
      // Satıcıları yükle
      await loadSellers();
      
      // Hedefleri yükle
      await loadTargets();
      
      // Event listener'ları ekle
      setupEventListeners();
  });

  // Kullanıcı bilgilerini ve rolünü yükle
  async function loadUserInfo() {
    try {
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      
      if (sessionError) {
        console.error('Oturum kontrol hatası:', sessionError);
        return;
      }
      
      if (session && session.user) {
        currentUser = session.user;
        
        // Kullanıcı bilgilerini Supabase'den çek
        const { data: userData, error: userError } = await supabase
          .from('profiles')
          .select('full_name, role')
          .eq('id', session.user.id)
          .single();
          
        if (userError) {
          console.error('Kullanıcı bilgileri getirme hatası:', userError);
          return;
        }
        
        if (userData) {
          isAdmin = userData.role === "admin";
          currentUserRole = userData.role;
          
          // Kullanıcı bilgilerini göster
          if ($('userName')) {
            $('userName').textContent = userData.full_name || 'Kullanıcı';
          }
          
          if ($('userRole')) {
            $('userRole').textContent = 'Rol: ' + (userData.role || 'Belirtilmemiş');
          }
          
          if ($('userStatus')) {
            $('userStatus').classList.remove('bg-gray-400', 'animate-pulse');
            $('userStatus').classList.add('bg-green-500');
          }
          
          // Çıkış butonu event listener
          $('signOut').addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = "login.html";
          });
          
          return { user: currentUser, role: userData.role, isAdmin };
        }
      } else {
        window.location.href = "login.html";
      }
    } catch (error) {
      console.error('Kullanıcı bilgileri yüklenirken hata:', error);
    }
    
    return null;
  }

  // Satıcıları yükle
  async function loadSellers() {
      const sellerSelect = document.getElementById("sellerSelect");
      const filterSeller = document.getElementById("filterSeller");
      
      sellerSelect.innerHTML = '<option value="">Seçin</option>';
      filterSeller.innerHTML = '<option value="">Tüm Satıcılar</option>';
      
      if (currentUserRole === "admin") {
          // Admin tüm satıcıları görür
          const { data: sellers, error } = await supabase
              .from("profiles")
              .select("id, full_name")
              .eq("role", "seller");
              
          if (error) {
              console.error("Satıcılar yüklenirken hata:", error);
              return;
          }
          
          if (sellers) {
              sellers.forEach(seller => {
                  sellerSelect.innerHTML += `<option value="${seller.id}">${seller.full_name}</option>`;
                  filterSeller.innerHTML += `<option value="${seller.id}">${seller.full_name}</option>`;
              });
          }
      } else {
          // Satıcı sadece kendisini görür
          sellerSelect.innerHTML = `<option value="${currentUser.id}" selected>${document.getElementById("userName").textContent}</option>`;
          document.getElementById("sellerSelectRow").style.display = "none";
      }
  }
  
  // Hedefleri yükle
  async function loadTargets() {
      const tableBody = document.getElementById("targetsTableBody");
      tableBody.innerHTML = `
          <tr>
              <td colspan="9" class="text-center py-8">
                  <div class="flex justify-center">
                      <div class="loader"></div>
                  </div>
                  <p class="mt-2 text-gray-500">Hedefler yükleniyor...</p>
              </td>
          </tr>
      `;
      
      let query = supabase.from("seller_targets").select("*");
      
      // Satıcı ise sadece kendi hedeflerini görür
      if (currentUserRole === "seller") {
          query = query.eq("seller_id", currentUser.id);
      }
      
      const { data, error } = await query;
      
      if (error) {
          console.error("Hedefler yüklenirken hata:", error);
          showToast("Hedefler yüklenirken hata oluştu", "error");
          tableBody.innerHTML = `
              <tr>
                  <td colspan="9" class="text-center py-8 text-red-600">
                      <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                      <p>Hedefler yüklenirken bir hata oluştu</p>
                  </td>
              </tr>
          `;
          return;
      }
      
      allTargets = data || [];
      updateStatistics(data || []);
      renderTargetsTable(data || []);
  }
  
  // İstatistikleri güncelle
  function updateStatistics(targets) {
      // Toplam hedef sayısı
      document.getElementById("totalTargets").textContent = targets.length;
      
      // Toplam ciro hedefi
      const totalRevenue = targets.reduce((sum, target) => sum + (target.target_revenue || 0), 0);
      document.getElementById("totalRevenue").textContent = formatCurrency(totalRevenue);
      
      // Ortalama büyüme oranı
      const avgGrowth = targets.length > 0 
          ? targets.reduce((sum, target) => sum + (target.growth_rate || 0), 0) / targets.length 
          : 0;
      document.getElementById("avgGrowth").textContent = avgGrowth.toFixed(1) + "%";
      
      // Tamamlanan hedef sayısı (basit bir örnek)
      const completedTargets = targets.filter(target => {
          return target.progress >= 100;
      }).length;
      document.getElementById("completedTargets").textContent = completedTargets;
  }
  
  // Hedefler tablosunu render et
  function renderTargetsTable(targets) {
      const tableBody = document.getElementById("targetsTableBody");
      
      if (targets.length === 0) {
          tableBody.innerHTML = `
              <tr>
                  <td colspan="9" class="text-center py-8">
                      <div class="empty-state">
                          <i class="fas fa-bullseye"></i>
                          <h3 class="text-lg font-medium text-gray-900 mt-2">Henüz hedef bulunmamaktadır</h3>
                          <p class="text-gray-500">Yeni bir hedef eklemek için "Yeni Hedef" butonuna tıklayın.</p>
                      </div>
                  </td>
              </tr>
          `;
          return;
      }
      
      // Sayfalama
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedTargets = targets.slice(startIndex, endIndex);
      
      // Sayfalama bilgilerini güncelle
      updatePaginationInfo(targets.length);
      
      // Tabloyu doldur
      tableBody.innerHTML = paginatedTargets.map(target => {
          const progress = target.progress || 0;
          let progressClass = "progress-danger";
          if (progress >= 70) progressClass = "progress-success";
          else if (progress >= 30) progressClass = "progress-warning";
          
          let statusBadge = "";
          if (progress >= 100) {
              statusBadge = '<span class="status-badge badge-success">Tamamlandı</span>';
          } else if (target.status === "active") {
              statusBadge = '<span class="status-badge badge-info">Aktif</span>';
          } else {
              statusBadge = '<span class="status-badge badge-warning">Beklemede</span>';
          }
          
          return `
              <tr>
                  <td class="font-medium">${target.seller_name || "Bilinmiyor"}</td>
                  <td>${target.product_name || "Bilinmiyor"}</td>
                  <td>${target.target_quantity || 0} ${target.quantity_unit || "adet"}</td>
                  <td>${formatCurrency(target.target_revenue || 0)}</td>
                  <td>${target.growth_rate || 0}%</td>
                  <td>${target.duration || 0}</td>
                  <td>${statusBadge}</td>
                  <td>
                      <div class="flex items-center">
                          <div class="progress-bar w-full mr-2">
                              <div class="progress-fill ${progressClass}" style="width: ${progress}%"></div>
                          </div>
                          <span class="text-xs">${progress}%</span>
                      </div>
                  </td>
                  <td>
                      <div class="flex space-x-2">
                          <button class="btn btn-secondary btn-sm edit-btn" data-id="${target.id}">
                              <i class="fas fa-edit"></i>
                          </button>
                          <button class="btn btn-danger btn-sm delete-btn" data-id="${target.id}">
                              <i class="fas fa-trash"></i>
                          </button>
                      </div>
                  </td>
              </tr>
          `;
      }).join("");
      
      // Edit ve delete butonları için event listener ekle
      document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
              const targetId = e.currentTarget.getAttribute('data-id');
              editTarget(targetId);
          });
      });
      
      document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
              const targetId = e.currentTarget.getAttribute('data-id');
              deleteTarget(targetId);
          });
      });
  }
  
  // Sayfalama bilgilerini güncelle
  function updatePaginationInfo(totalItems) {
      const startIndex = (currentPage - 1) * itemsPerPage + 1;
      const endIndex = Math.min(startIndex + itemsPerPage - 1, totalItems);
      
      document.getElementById("paginationInfo").textContent = 
          `${totalItems} sonuçtan ${startIndex}-${endIndex} gösteriliyor`;
          
      // Önceki ve sonraki butonlarını güncelle
      const prevButton = document.querySelector("#paginationControls button:first-child");
      const nextButton = document.querySelector("#paginationControls button:last-child");
      
      prevButton.disabled = currentPage === 1;
      nextButton.disabled = endIndex >= totalItems;
      
      // Buton event listener'larını ekle
      prevButton.onclick = () => {
          if (currentPage > 1) {
              currentPage--;
              renderTargetsTable(allTargets);
          }
      };
      
      nextButton.onclick = () => {
          if (currentPage * itemsPerPage < allTargets.length) {
              currentPage++;
              renderTargetsTable(allTargets);
          }
      };
  }
  
  // Event listener'ları kur
  function setupEventListeners() {
      // Yeni hedef butonu
      document.getElementById("newTargetBtn").addEventListener("click", () => {
          openTargetModal();
      });
      
      // Modal kapatma butonu
      document.getElementById("closeModal").addEventListener("click", () => {
          closeTargetModal();
      });
      
      // İptal butonu
      document.getElementById("cancelBtn").addEventListener("click", () => {
          closeTargetModal();
      });
      
      // Kaydet butonu
      document.getElementById("saveTargetBtn").addEventListener("click", async () => {
          await saveTarget();
      });
      
      // Arama kutusu
      document.getElementById("searchInput").addEventListener("input", (e) => {
          filterTargets(e.target.value);
      });
      
      // Filtreler
      document.getElementById("filterSeller").addEventListener("change", () => {
          filterTargets();
      });
      
      document.getElementById("filterStatus").addEventListener("change", () => {
          filterTargets();
      });
  }
  
  // Hedefleri filtrele
  function filterTargets(searchTerm = "") {
      let filteredTargets = allTargets;
      
      // Arama terimi ile filtrele
      if (searchTerm) {
          const term = searchTerm.toLowerCase();
          filteredTargets = filteredTargets.filter(target => 
              (target.product_name && target.product_name.toLowerCase().includes(term)) || 
              (target.seller_name && target.seller_name.toLowerCase().includes(term))
          );
      }
      
      // Satıcı filtresi
      const sellerFilter = document.getElementById("filterSeller").value;
      if (sellerFilter) {
          filteredTargets = filteredTargets.filter(target => target.seller_id === sellerFilter);
      }
      
      // Durum filtresi
      const statusFilter = document.getElementById("filterStatus").value;
      if (statusFilter) {
          // Basit bir durum filtresi
          filteredTargets = filteredTargets.filter(target => {
              if (statusFilter === "completed") return (target.progress || 0) >= 100;
              if (statusFilter === "active") return target.status === "active";
              if (statusFilter === "expired") return target.status === "expired";
              return true;
          });
      }
      
      // Filtrelenmiş hedefleri render et
      currentPage = 1;
      renderTargetsTable(filteredTargets);
  }
  
  // Hedef modalını aç
  function openTargetModal(targetId = null) {
      const modal = document.getElementById("targetModal");
      const modalTitle = document.getElementById("modalTitle");
      
      if (targetId) {
          modalTitle.textContent = "Hedefi Düzenle";
          loadTargetData(targetId);
      } else {
          modalTitle.textContent = "Yeni Hedef";
          document.getElementById("targetForm").reset();
          document.getElementById("editTargetId").value = "";
      }
      
      modal.classList.add("active");
  }
  
  // Hedef modalını kapat
  function closeTargetModal() {
      document.getElementById("targetModal").classList.remove("active");
  }
  
  // Hedef verilerini yükle (düzenleme için)
  async function loadTargetData(targetId) {
      const { data, error } = await supabase
          .from("seller_targets")
          .select("*")
          .eq("id", targetId)
          .single();
          
      if (error) {
          console.error("Hedef verileri yüklenirken hata:", error);
          showToast("Hedef verileri yüklenirken hata oluştu", "error");
          return;
      }
      
      document.getElementById("editTargetId").value = data.id;
      document.getElementById("sellerSelect").value = data.seller_id;
      document.getElementById("productName").value = data.product_name;
      document.getElementById("targetQuantity").value = data.target_quantity;
      document.getElementById("quantityUnit").value = data.quantity_unit || "adet";
      document.getElementById("targetRevenue").value = data.target_revenue;
      document.getElementById("growthRate").value = data.growth_rate;
      document.getElementById("targetDuration").value = data.duration;
      document.getElementById("startDate").value = data.start_date || "";
      document.getElementById("description").value = data.description || "";
  }
  
  // Hedef kaydet
  async function saveTarget() {
      const targetId = document.getElementById("editTargetId").value;
      const sellerId = document.getElementById("sellerSelect").value;
      const productName = document.getElementById("productName").value;
      const targetQuantity = parseFloat(document.getElementById("targetQuantity").value);
      const quantityUnit = document.getElementById("quantityUnit").value;
      const targetRevenue = parseFloat(document.getElementById("targetRevenue").value);
      const growthRate = parseFloat(document.getElementById("growthRate").value);
      const targetDuration = parseInt(document.getElementById("targetDuration").value);
      const startDate = document.getElementById("startDate").value;
      const description = document.getElementById("description").value;
      
      // Validasyon
      if (!sellerId || !productName || isNaN(targetQuantity) || isNaN(targetRevenue) || 
          isNaN(growthRate) || isNaN(targetDuration)) {
          showToast("Lütfen zorunlu alanları doldurun", "error");
          return;
      }
      
      // Butonu yükleniyor durumuna getir
      document.getElementById("saveButtonText").textContent = "Kaydediliyor...";
      document.getElementById("saveLoader").style.display = "inline-block";
      document.getElementById("saveTargetBtn").disabled = true;
      
      try {
          const sellerName = document.getElementById("sellerSelect").selectedOptions[0].text;
          const targetData = {
              seller_id: sellerId,
              seller_name: sellerName,
              product_name: productName,
              target_quantity: targetQuantity,
              quantity_unit: quantityUnit,
              target_revenue: targetRevenue,
              growth_rate: growthRate,
              duration: targetDuration,
              start_date: startDate || null,
              description: description || null,
              updated_at: new Date()
          };
          
          if (targetId) {
              // Düzenleme
              const { error } = await supabase
                  .from("seller_targets")
                  .update(targetData)
                  .eq("id", targetId);
                  
              if (error) throw error;
              
              showToast("Hedef başarıyla güncellendi", "success");
          } else {
              // Yeni kayıt
              targetData.created_at = new Date();
              targetData.status = "active";
              targetData.progress = 0;
              
              const { error } = await supabase
                  .from("seller_targets")
                  .insert([targetData]);
                  
              if (error) throw error;
              
              showToast("Hedef başarıyla oluşturuldu", "success");
          }
          
          // Modalı kapat ve listeyi yenile
          closeTargetModal();
          await loadTargets();
          
      } catch (error) {
          console.error("Hedef kaydedilirken hata:", error);
          showToast("Hedef kaydedilirken hata oluştu: " + error.message, "error");
      } finally {
          // Butonu eski haline getir
          document.getElementById("saveButtonText").textContent = "Kaydet";
          document.getElementById("saveLoader").style.display = "none";
          document.getElementById("saveTargetBtn").disabled = false;
      }
  }
  
  // Hedef düzenle
  async function editTarget(targetId) {
      openTargetModal(targetId);
  }
  
  // Hedef sil
  async function deleteTarget(targetId) {
      if (!confirm("Bu hedefi silmek istediğinize emin misiniz? Bu işlem geri alınamaz.")) {
          return;
      }
      
      try {
          const { error } = await supabase
              .from("seller_targets")
              .delete()
              .eq("id", targetId);
              
          if (error) throw error;
          
          showToast("Hedef başarıyla silindi", "success");
          await loadTargets();
          
      } catch (error) {
          console.error("Hedef silinirken hata:", error);
          showToast("Hedef silinirken hata oluştu: " + error.message, "error");
      }
  }

    // Tablo satırında gösterim
function createTargetRow(target) {
    const isCompleted = isTargetCompleted(target);
    const statusBadge = displayCompletionStatus(target);
    
    return `
        <tr class="${isCompleted ? 'bg-green-50' : ''}">
            <td class="p-3">${target.product_name}</td>
            <td class="p-3">${target.target_quantity} ${target.quantity_unit}</td>
            <td class="p-3">${target.target_revenue} TL</td>
            <td class="p-3">
                ${statusBadge}
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" style="width: ${target.progress || 0}%"></div>
                </div>
            </td>
            <td class="p-3">
                ${isCompleted ? 
                    '<i class="fas fa-check text-green-500"></i>' : 
                    '<i class="fas fa-clock text-yellow-500"></i>'
                }
            </td>
        </tr>
    `;
}
  // Para birimi formatı
  function formatCurrency(amount) {
      return new Intl.NumberFormat('tr-TR', { 
          style: 'currency', 
          currency: 'USD',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
      }).format(amount);
  }
// Hedef durumunu ve progress'ini hesapla (DÜZELTİLMİŞ)
function calculateTargetStatus(target) {
    const now = new Date();
    const startDate = new Date(target.start_date);
    const endDate = new Date(startDate);
    endDate.setMonth(endDate.getMonth() + (target.duration || 1));
    
    console.log('Hedef analizi:', {
        şimdi: now.toLocaleDateString('tr-TR'),
        başlangıç: startDate.toLocaleDateString('tr-TR'),
        bitiş: endDate.toLocaleDateString('tr-TR'),
        süre: target.duration + ' ay'
    });

    // Başlama tarihi gelecekte ise (13.09.2024 gibi)
    if (startDate > now) {
        return {
            status: 'pending',
            progress: 0,
            statusText: 'Beklemede',
            endDate: endDate
        };
    }
    
    // Süre dolmuşsa (bitiş tarihi geçmişse)
    if (endDate < now) {
        // Mevcut progress'i koru, %100 yapma!
        const finalProgress = Math.min(target.progress || 0, 100);
        return {
            status: finalProgress >= 100 ? 'completed' : 'expired',
            progress: finalProgress,
            statusText: finalProgress >= 100 ? 'Tamamlandı' : 'Süresi Doldu',
            endDate: endDate
        };
    }
    
    // Devam ediyorsa zaman bazlı progress hesapla
    const totalDuration = endDate - startDate;
    const elapsedTime = now - startDate;
    const timeBasedProgress = Math.min((elapsedTime / totalDuration) * 100, 100);
    
    // Mevcut progress ile zaman bazlı progress'in maksimumunu al
    const currentProgress = target.progress || 0;
    const overallProgress = Math.max(currentProgress, timeBasedProgress);
    
    return {
        status: 'active',
        progress: overallProgress,
        statusText: `Devam Ediyor (${Math.round(overallProgress)}%)`,
        endDate: endDate
    };
}

    // Tarihin geçmiş mi gelecek mi olduğunu kontrol et
function isPastDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    return date < now;
}

// Tarihin bugünden ne kadar süre önce/sonra olduğunu hesapla
function getDateStatus(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = date - now;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays > 0) {
        return `${diffDays} gün sonra`;
    } else if (diffDays < 0) {
        return `${Math.abs(diffDays)} gün önce`;
    } else {
        return 'Bugün';
    }
}

    // UI'da detaylı durum göster
function displayTargetStatus(target) {
    const statusInfo = calculateTargetStatus(target);
    
    let statusClass = '';
    let icon = '';
    let details = '';
    
    switch(statusInfo.status) {
        case 'pending':
            statusClass = 'status-pending';
            icon = '<i class="fas fa-clock mr-1"></i>';
            details = `Başlama: ${formatDate(target.start_date)}`;
            break;
        case 'active':
            statusClass = 'status-active';
            icon = '<i class="fas fa-spinner mr-1"></i>';
            details = `Bitiş: ${formatDate(statusInfo.endDate)}`;
            break;
        case 'completed':
            statusClass = 'status-completed';
            icon = '<i class="fas fa-check-circle mr-1"></i>';
            details = `Tamamlandı: ${formatDate(statusInfo.endDate)}`;
            break;
        case 'expired':
            statusClass = 'status-expired';
            icon = '<i class="fas fa-exclamation-triangle mr-1"></i>';
            details = `Süre doldu: ${formatDate(statusInfo.endDate)}`;
            break;
    }
    
    return `
        <div class="mb-2">
            <span class="status-badge ${statusClass}">
                ${icon}${statusInfo.statusText}
            </span>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar-fill" style="width: ${statusInfo.progress}%"></div>
        </div>
        <div class="text-xs text-gray-500 mt-1">${details}</div>
        <div class="text-xs text-gray-400">İlerleme: ${Math.round(statusInfo.progress)}%</div>
    `;
}

    // Test senaryoları
const testTargets = [
    {
        start_date: '2024-09-13', // Gelecek tarih
        duration: 12,
        progress: 0
    },
    {
        start_date: '2023-09-13', // Geçmiş tarih (süre dolmuş)
        duration: 12,
        progress: 75 // %75 ilerleme
    },
    {
        start_date: '2023-09-13', // Geçmiş tarih (süre dolmuş)
        duration: 12,
        progress: 100 // %100 ilerleme
    },
    {
        start_date: '2024-01-01', // Devam eden
        duration: 12,
        progress: 30
    }
];

testTargets.forEach((target, index) => {
    const status = calculateTargetStatus(target);
    console.log(`Senaryo ${index + 1}:`, status);
});

    // Satış verilerine göre gerçek ilerleme hesapla
async function calculateRealProgress(target) {
    try {
        // Bu hedefe ait satışları getir
        const { data: sales, error } = await supabase
            .from('sales')
            .select('quantity, revenue, sale_date')
            .eq('target_id', target.id)
            .gte('sale_date', target.start_date);
        
        if (error) return target.progress || 0;
        
        let quantityProgress = 0;
        let revenueProgress = 0;
        
        if (target.target_quantity > 0) {
            const totalQuantity = sales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
            quantityProgress = (totalQuantity / target.target_quantity) * 100;
        }
        
        if (target.target_revenue > 0) {
            const totalRevenue = sales.reduce((sum, sale) => sum + (sale.revenue || 0), 0);
            revenueProgress = (totalRevenue / target.target_revenue) * 100;
        }
        
        // İki progress'ten yüksek olanı al veya ortalamasını al
        const realProgress = Math.max(quantityProgress, revenueProgress);
        
        return Math.min(realProgress, 100);
        
    } catch (error) {
        console.error('İlerleme hesaplama hatası:', error);
        return target.progress || 0;
    }
}

    // Tüm hedeflerin ilerlemesini güncelle
async function updateAllTargetsProgress() {
    try {
        const { data: targets, error } = await supabase
            .from('seller_targets')
            .select('*');
        
        if (error) throw error;
        
        for (const target of targets) {
            const realProgress = await calculateRealProgress(target);
            const statusInfo = calculateTargetStatus({
                ...target,
                progress: realProgress
            });
            
            await supabase
                .from('seller_targets')
                .update({
                    progress: realProgress,
                    status: statusInfo.status,
                    updated_at: new Date().toISOString()
                })
                .eq('id', target.id);
        }
        
        console.log('Tüm hedefler güncellendi');
        loadTargets();
        
    } catch (error) {
        console.error('Hedef güncelleme hatası:', error);
    }
}

// Her gün otomatik güncelle
setInterval(updateAllTargetsProgress, 24 * 60 * 60 * 1000);
    
  // Toast bildirimi göster
  function showToast(message, type) {
      const toastContainer = document.getElementById("toastContainer");
      const toast = document.createElement("div");
      
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
          <i class="toast-icon ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
          <span>${message}</span>
      `;
      
      toastContainer.appendChild(toast);
      
      // 3 saniye sonra toast'ı kaldır
      setTimeout(() => {
          toast.remove();
      }, 3000);
  }
</script>
</body>
</html>
