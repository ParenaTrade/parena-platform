<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Müşteri Profilleri Yönetimi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-active {
            background-color: var(--success-color);
            color: white;
        }
        
        .status-inactive {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        .btn-secondary {
            background-color: white;
            color: #374151;
            border-color: #d1d5db;
        }
        
        .btn-secondary:hover {
            background-color: #f9fafb;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #059669;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            z-index: 1000;
            animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
            max-width: 350px;
        }
        
        .toast-success {
            background-color: var(--success-color);
        }
        
        .toast-error {
            background-color: var(--danger-color);
        }
        
        .toast-icon {
            margin-right: 0.75rem;
            font-size: 1.25rem;
        }
        
        @keyframes toastIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes toastOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .data-table th {
            background-color: #f9fafb;
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .data-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
        }
        
        .data-table tr:last-child td {
            border-bottom: none;
        }
        
        .data-table tr:hover {
            background-color: #f9fafb;
        }
        
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-container {
            background-color: white;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: auto;
            padding: 0;
            transform: translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .modal-overlay.active .modal-container {
            transform: translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .modal-close:hover {
            color: #374151;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        
        .form-control {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .error-message {
            color: var(--danger-color);
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none;
        }
        
        .detail-view {
            background-color: #f9fafb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 0.5rem;
        }
        
        .detail-label {
            font-weight: 600;
            min-width: 120px;
        }
        
        .search-container {
            position: relative;
            margin-bottom: 1rem;
        }
        
        .search-input {
            padding-left: 2.5rem;
        }
        
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 0.5rem;
            color: #6b7280;
        }
        
        .user-info-container {
            display: flex;
            align-items: center;
            background-color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .user-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
            flex-shrink: 0;
        }
        
        .user-details {
            margin-left: 0.75rem;
            text-align: right;
            flex-grow: 1;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 0.875rem;
            color: #1f2937;
        }
        
        .user-role {
            color: #6b7280;
            font-size: 0.75rem;
        }
        
        .user-status {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            margin-right: 0.5rem;
            flex-shrink: 0;
        }
        
        .user-status-online {
            background-color: var(--success-color);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4">

<!-- Kullanıcı Bilgileri -->
<div class="user-info-container">
  <div class="flex items-center">
    <div class="user-status user-status-online"></div>
    <div class="user-avatar">
      <i class="fas fa-user"></i>
    </div>
  </div>
  <div class="user-details">
    <div id="userName" class="user-name">Yükleniyor...</div>
    <div id="userRole" class="user-role">Rol: Yükleniyor...</div>
  </div>
</div>

<div class="max-w-7xl mx-auto">
    <!-- Başlık ve Butonlar -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-indigo-700">Müşteri Profilleri</h1>
        <button id="btnNewCustomer" class="btn btn-primary">
            <i class="fas fa-plus mr-2"></i>Yeni Müşteri
        </button>
    </div>

    <!-- Arama Kutusu -->
    <div class="card mb-6">
        <div class="card-body">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="searchInput" class="form-control search-input" placeholder="Müşteri ara...">
            </div>
        </div>
    </div>

    <!-- Müşteri Listesi -->
    <div class="card">
        <div class="card-header">
            <h2 class="text-xl font-semibold">Müşteri Listesi</h2>
        </div>
        <div class="card-body p-0">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Müşteri Adı</th>
                            <th>E-posta</th>
                            <th>Telefon</th>
                            <th>Şehir</th>
                            <th>Durum</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="customersList">
                        <tr>
                            <td colspan="6" class="text-center py-8 text-gray-500">
                                <div class="loading-spinner mx-auto mb-2"></div>
                                Müşteriler yükleniyor...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Müşteri Düzenleme Modal -->
<div id="modalCustomer" class="modal-overlay">
    <div class="modal-container">
        <div class="modal-header">
            <h3 class="modal-title" id="modalCustomerTitle">Yeni Müşteri Ekle</h3>
            <button class="modal-close" id="closeModalCustomer">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="formCustomer" class="modal-body">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label for="c_name">Müşteri Adı *</label>
                    <input type="text" id="c_name" class="form-control" placeholder="Müşteri adı">
                    <div id="c_nameError" class="error-message">Müşteri adı gereklidir</div>
                </div>
                <div class="form-group">
                    <label for="c_email">E-posta *</label>
                    <input type="email" id="c_email" class="form-control" placeholder="E-posta adresi">
                    <div id="c_emailError" class="error-message">Geçerli bir e-posta adresi giriniz</div>
                </div>
                <div class="form-group">
                    <label for="c_phone">Telefon</label>
                    <input type="tel" id="c_phone" class="form-control" placeholder="Telefon numarası">
                </div>
                <div class="form-group">
                    <label for="c_city">Şehir</label>
                    <input type="text" id="c_city" class="form-control" placeholder="Şehir">
                </div>
                <div class="form-group">
                    <label for="c_country">Ülke</label>
                    <input type="text" id="c_country" class="form-control" placeholder="Ülke">
                </div>
                <div class="form-group">
                    <label for="c_taxnumber">Vergi No</label>
                    <input type="text" id="c_taxnumber" class="form-control" placeholder="Vergi numarası">
                </div>
                <div class="form-group">
                    <label for="c_taxoffice">Vergi Dairesi</label>
                    <input type="text" id="c_taxoffice" class="form-control" placeholder="Vergi dairesi">
                </div>
                <div class="form-group">
                    <label for="c_sector">Sektör</label>
                    <input type="text" id="c_sector" class="form-control" placeholder="Sektör">
                </div>
                <div class="form-group md:col-span-2">
                    <label for="c_address">Adres</label>
                    <textarea id="c_address" class="form-control" rows="3" placeholder="Adres"></textarea>
                </div>
                <div class="form-group">
                    <label for="c_status">Durum</label>
                    <select id="c_status" class="form-control">
                        <option value="Active">Aktif</option>
                        <option value="Inactive">Pasif</option>
                    </select>
                </div>
            </div>
        </form>
        <div class="modal-footer">
            <button id="deleteCustomerBtn" class="btn btn-danger hidden">
                <i class="fas fa-trash mr-1"></i> Sil
            </button>
            <button id="cancelCustomerBtn" class="btn btn-secondary">İptal</button>
            <button id="saveCustomerBtn" class="btn btn-primary">Kaydet</button>
        </div>
    </div>
</div>

<!-- Müşteri Detay Modal -->
<div id="modalCustomerDetail" class="modal-overlay">
    <div class="modal-container">
        <div class="modal-header">
            <h3 class="modal-title">Müşteri Detayları</h3>
            <button class="modal-close" id="closeModalCustomerDetail">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="customerDetailContent">
                <!-- Müşteri detayları buraya dinamik olarak yüklenecek -->
            </div>
        </div>
        <div class="modal-footer">
            <button id="closeDetailBtn" class="btn btn-secondary">Kapat</button>
        </div>
    </div>
</div>

<!-- Toast bildirimi konteyneri -->
<div id="toastContainer"></div>

<script>
    // Supabase yapılandırması
    const SUPABASE_URL = "https://xliutvspwodhoavysks.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsaXV0dnNwd29kaG9hdnlza3MiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTY5ODk1OTY2MSwiZXhwIjoyMDE0NTM1NjYxfQ.owq-1_SnTbJ7yN6yM2v7VH6M6V6T0Vk6Z6Z6Z6Z6Z6Z";
    
    // Supabase istemcisini oluştur
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // DOM elementlerini seçme
    const $ = id => document.getElementById(id);
    
    // Kullanıcı ve müşteri verileri
    let currentUser = null;
    let currentUserRole = null;
    let customers = [];
    let filteredCustomers = [];
    let currentEditingCustomerId = null;
  let currentPage = 1;
  let isAdmin = false;
  const itemsPerPage = 10;

	    

  // DOM yüklendikten sonra
  document.addEventListener("DOMContentLoaded", async () => {
      // Kullanıcı bilgilerini yükle
      await loadUserInfo();
      
      // Satıcıları yükle
      await loadSellers();
      
      // Hedefleri yükle
      await loadTargets();
      
      // Event listener'ları ekle
      setupEventListeners();
  });

  // Kullanıcı bilgilerini ve rolünü yükle
  async function loadUserInfo() {
    try {
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      
      if (sessionError) {
        console.error('Oturum kontrol hatası:', sessionError);
        return;
      }
      
      if (session && session.user) {
        currentUser = session.user;
        
        // Kullanıcı bilgilerini Supabase'den çek
        const { data: userData, error: userError } = await supabase
          .from('profiles')
          .select('full_name, role')
          .eq('id', session.user.id)
          .single();
          
        if (userError) {
          console.error('Kullanıcı bilgileri getirme hatası:', userError);
          return;
        }
        
        if (userData) {
          isAdmin = userData.role === "admin";
          currentUserRole = userData.role;
          
          // Kullanıcı bilgilerini göster
          if ($('userName')) {
            $('userName').textContent = userData.full_name || 'Kullanıcı';
          }
          
          if ($('userRole')) {
            $('userRole').textContent = 'Rol: ' + (userData.role || 'Belirtilmemiş');
          }
          
          if ($('userStatus')) {
            $('userStatus').classList.remove('bg-gray-400', 'animate-pulse');
            $('userStatus').classList.add('bg-green-500');
          }
          
          // Çıkış butonu event listener
          $('signOut').addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = "login.html";
          });
          
          return { user: currentUser, role: userData.role, isAdmin };
        }
      } else {
        window.location.href = "login.html";
      }
    } catch (error) {
      console.error('Kullanıcı bilgileri yüklenirken hata:', error);
    }
    
    return null;
  }

    // Event listener'ları kur
    function setupEventListeners() {
        // Yeni müşteri butonu
        $('btnNewCustomer').addEventListener('click', () => {
            openCustomerModal();
        });
        
        // Modal kapatma butonları
        $('closeModalCustomer').addEventListener('click', () => {
            closeCustomerModal();
        });
        
        $('closeModalCustomerDetail').addEventListener('click', () => {
            closeCustomerDetailModal();
        });
        
        $('cancelCustomerBtn').addEventListener('click', () => {
            closeCustomerModal();
        });
        
        $('closeDetailBtn').addEventListener('click', () => {
            closeCustomerDetailModal();
        });
        
        // Müşteri kaydetme butonu
        $('saveCustomerBtn').addEventListener('click', () => {
            saveCustomer();
        });
        
        // Müşteri silme butonu
        $('deleteCustomerBtn').addEventListener('click', () => {
            deleteCustomer();
        });
        
        // Arama kutusu
        $('searchInput').addEventListener('input', (e) => {
            filterCustomers(e.target.value);
        });
    }
    
    // Müşterileri yükle
    async function loadCustomers() {
        try {
            let query = supabase
                .from('buyer_profiles')
                .select('*');
            
            // Admin değilse sadece kendi müşterilerini göster
            if (currentUserRole !== 'admin') {
                query = query.eq('seller_id', currentUser.id);
            }
            
            const { data, error } = await query;
            
            if (error) {
                throw error;
            }
            
            customers = data || [];
            filteredCustomers = [...customers];
            renderCustomers();
            
        } catch (error) {
            console.error('Müşteriler yüklenirken hata:', error);
            showToast('Müşteriler yüklenirken hata oluştu', 'error');
        }
    }
    
    // Müşterileri filtrele
    function filterCustomers(searchTerm) {
        if (!searchTerm) {
            filteredCustomers = [...customers];
        } else {
            const term = searchTerm.toLowerCase();
            filteredCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(term) ||
                customer.email.toLowerCase().includes(term) ||
                (customer.phone && customer.phone.includes(term)) ||
                (customer.city && customer.city.toLowerCase().includes(term))
            );
        }
        renderCustomers();
    }
    
    // Müşterileri listele
    function renderCustomers() {
        const customersList = $('customersList');
        customersList.innerHTML = '';
        
        if (filteredCustomers.length === 0) {
            customersList.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-8 text-gray-500">
                        Arama kriterlerine uygun müşteri bulunamadı
                    </td>
                </tr>
            `;
            return;
        }
        
        filteredCustomers.forEach(customer => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            tr.innerHTML = `
                <td class="p-3 font-medium">${customer.name}</td>
                <td class="p-3">${customer.email}</td>
                <td class="p-3">${customer.phone || '-'}</td>
                <td class="p-3">${customer.city || '-'}</td>
                <td class="p-3">
                    <span class="status-badge ${customer.status === 'Active' ? 'status-active' : 'status-inactive'}">
                        ${customer.status === 'Active' ? 'Aktif' : 'Pasif'}
                    </span>
                </td>
                <td class="p-3">
                    <div class="flex space-x-2">
                        <button class="btn-view btn btn-secondary btn-sm" data-id="${customer.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-edit btn btn-primary btn-sm" data-id="${customer.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-delete btn btn-danger btn-sm" data-id="${customer.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            
            // Butonlara event listener ekle
            tr.querySelector('.btn-view').addEventListener('click', (e) => {
                const id = e.currentTarget.getAttribute('data-id');
                viewCustomer(id);
            });
            
            tr.querySelector('.btn-edit').addEventListener('click', (e) => {
                const id = e.currentTarget.getAttribute('data-id');
                editCustomer(id);
            });
            
            tr.querySelector('.btn-delete').addEventListener('click', (e) => {
                const id = e.currentTarget.getAttribute('data-id');
                confirmDeleteCustomer(id);
            });
            
            customersList.appendChild(tr);
        });
    }
    
    // Müşteri detaylarını görüntüle
    function viewCustomer(id) {
        const customer = customers.find(c => c.id == id);
        if (!customer) return;
        
        const detailContent = `
            <div class="detail-view">
                <h4 class="font-semibold text-lg mb-4">${customer.name}</h4>
                <div class="detail-row">
                    <span class="detail-label">E-posta:</span>
                    <span>${customer.email}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Telefon:</span>
                    <span>${customer.phone || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Şehir:</span>
                    <span>${customer.city || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Ülke:</span>
                    <span>${customer.country || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Adres:</span>
                    <span>${customer.address || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Vergi No:</span>
                    <span>${customer.taxnumber || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Vergi Dairesi:</span>
                    <span>${customer.taxoffice || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Sektör:</span>
                    <span>${customer.sector || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Durum:</span>
                    <span class="status-badge ${customer.status === 'Active' ? 'status-active' : 'status-inactive'}">
                        ${customer.status === 'Active' ? 'Aktif' : 'Pasif'}
                    </span>
                </div>
            </div>
        `;
        
        $('customerDetailContent').innerHTML = detailContent;
        $('#modalCustomerDetail').classList.add('active');
    }
    
    // Müşteri düzenleme modalını aç
    function editCustomer(id) {
        const customer = customers.find(c => c.id == id);
        if (!customer) return;
        
        // Kullanıcı yetkisini kontrol et (sadece admin veya müşterinin sahibi düzenleyebilir)
        if (currentUserRole !== 'admin' && customer.seller_id !== currentUser.id) {
            showToast('Bu müşteriyi düzenleme yetkiniz yok', 'error');
            return;
        }
        
        // Formu doldur
        $('c_name').value = customer.name;
        $('c_email').value = customer.email;
        $('c_phone').value = customer.phone || '';
        $('c_city').value = customer.city || '';
        $('c_country').value = customer.country || '';
        $('c_address').value = customer.address || '';
        $('c_taxnumber').value = customer.taxnumber || '';
        $('c_taxoffice').value = customer.taxoffice || '';
        $('c_sector').value = customer.sector || '';
        $('c_status').value = customer.status;
        
        // Modalı ayarla
        $('modalCustomerTitle').textContent = 'Müşteriyi Düzenle';
        $('deleteCustomerBtn').classList.remove('hidden');
        currentEditingCustomerId = id;
        
        // Modalı aç
        $('#modalCustomer').classList.add('active');
    }
    
    // Müşteri silme onayı
    function confirmDeleteCustomer(id) {
        const customer = customers.find(c => c.id == id);
        if (!customer) return;
        
        // Kullanıcı yetkisini kontrol et (sadece admin veya müşterinin sahibi silebilir)
        if (currentUserRole !== 'admin' && customer.seller_id !== currentUser.id) {
            showToast('Bu müşteriyi silme yetkiniz yok', 'error');
            return;
        }
        
        if (confirm(`"${customer.name}" müşterisini silmek istediğinize emin misiniz? Bu işlem geri alınamaz.`)) {
            deleteCustomer(id);
        }
    }
    
    // Müşteri sil
    async function deleteCustomer(id) {
        try {
            const { error } = await supabase
                .from('buyer_profiles')
                .delete()
                .eq('id', id);
            
            if (error) {
                throw error;
            }
            
            // Yerel listeden de kaldır
            customers = customers.filter(c => c.id != id);
            filteredCustomers = filteredCustomers.filter(c => c.id != id);
            
            renderCustomers();
            showToast('Müşteri başarıyla silindi', 'success');
            
            // Eğer modal açıksa kapat
            if (currentEditingCustomerId == id) {
                closeCustomerModal();
            }
            
        } catch (error) {
            console.error('Müşteri silinirken hata:', error);
            showToast('Müşteri silinirken hata oluştu', 'error');
        }
    }
    
    // Müşteri modalını aç
    function openCustomerModal() {
        // Formu temizle
        $('formCustomer').reset();
        
        // Modalı ayarla
        $('modalCustomerTitle').textContent = 'Yeni Müşteri Ekle';
        $('deleteCustomerBtn').classList.add('hidden');
        currentEditingCustomerId = null;
        
        // Modalı aç
        $('#modalCustomer').classList.add('active');
    }
    
    // Müşteri modalını kapat
    function closeCustomerModal() {
        $('#modalCustomer').classList.remove('active');
        currentEditingCustomerId = null;
        
        // Hata mesajlarını temizle
        document.querySelectorAll('.error-message').forEach(el => {
            el.style.display = 'none';
        });
    }
    
    // Müşteri detay modalını kapat
    function closeCustomerDetailModal() {
        $('#modalCustomerDetail').classList.remove('active');
    }
    
    // Form doğrulama
    function validateForm() {
        let isValid = true;
        
        // İsim doğrulama
        if (!$('c_name').value.trim()) {
            $('c_nameError').style.display = 'block';
            isValid = false;
        } else {
            $('c_nameError').style.display = 'none';
        }
        
        // E-posta doğrulama
        const email = $('c_email').value;
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email || !emailPattern.test(email)) {
            $('c_emailError').style.display = 'block';
            isValid = false;
        } else {
            $('c_emailError').style.display = 'none';
        }
        
        return isValid;
    }
    
    // Müşteri kaydet
    async function saveCustomer() {
        if (!validateForm()) {
            showToast('Lütfen gerekli alanları doldurun', 'error');
            return;
        }
        
        const customerData = {
            name: $('c_name').value.trim(),
            email: $('c_email').value.trim(),
            phone: $('c_phone').value.trim(),
            city: $('c_city').value.trim(),
            country: $('c_country').value.trim(),
            address: $('c_address').value.trim(),
            taxnumber: $('c_taxnumber').value.trim(),
            taxoffice: $('c_taxoffice').value.trim(),
            sector: $('c_sector').value.trim(),
            status: $('c_status').value,
            seller_id: currentUser.id,
            updated_at: new Date().toISOString()
        };
        
        try {
            if (currentEditingCustomerId) {
                // Mevcut müşteriyi güncelle
                const { error } = await supabase
                    .from('buyer_profiles')
                    .update(customerData)
                    .eq('id', currentEditingCustomerId);
                
                if (error) {
                    throw error;
                }
                
                // Yerel listeyi güncelle
                const index = customers.findIndex(c => c.id == currentEditingCustomerId);
                if (index !== -1) {
                    customers[index] = { ...customers[index], ...customerData };
                    
                    // Filtrelenmiş listeyi de güncelle
                    const filteredIndex = filteredCustomers.findIndex(c => c.id == currentEditingCustomerId);
                    if (filteredIndex !== -1) {
                        filteredCustomers[filteredIndex] = { ...filteredCustomers[filteredIndex], ...customerData };
                    }
                }
                
                showToast('Müşteri başarıyla güncellendi', 'success');
            } else {
                // Yeni müşteri ekle
                customerData.created_at = new Date().toISOString();
                
                const { data, error } = await supabase
                    .from('buyer_profiles')
                    .insert([customerData])
                    .select();
                
                if (error) {
                    throw error;
                }
                
                // Yerel listeye ekle
                if (data && data.length > 0) {
                    customers.push(data[0]);
                    filteredCustomers.push(data[0]);
                }
                
                showToast('Müşteri başarıyla eklendi', 'success');
            }
            
            renderCustomers();
            closeCustomerModal();
            
        } catch (error) {
            console.error('Müşteri kaydedilirken hata:', error);
            showToast('Müşteri kaydedilirken hata oluştu', 'error');
        }
    }
    
    // Toast bildirimi göster
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <i class="toast-icon ${type === 'success' ? 'fas fa-check-circle' : type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-info-circle'}"></i>
            <span>${message}</span>
        `;
        
        $('toastContainer').appendChild(toast);
        
        // 3 saniye sonra toast'ı kaldır
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 3000);
    }
</script>
</body>
</html>