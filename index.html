<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParenaTrade – Gürcistan Yatırım ve Pazar Analiz Platformu</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-orange: #ea580c;
            --primary-orange-dark: #c2410c;
            --primary-orange-light: #fdba74;
            --secondary-red: #dc2626;
            --accent-amber: #f59e0b;
            --gray-50: #fafafa;
            --gray-100: #f4f4f5;
            --gray-200: #e4e4e7;
            --gray-300: #d4d4d8;
            --gray-400: #a1a1aa;
            --gray-500: #71717a;
            --gray-600: #52525b;
            --gray-700: #3f3f46;
            --gray-800: #27272a;
            --gray-900: #18181b;
            --text-dark: #18181b;
            --text-light: #71717a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-dark);
            line-height: 1.6;
            font-size: 16px;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            line-height: 1.2;
            color: var(--text-dark);
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 700;
        }

        h2 {
            font-size: 2.5rem;
        }

        h3 {
            font-size: 1.5rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-orange), var(--secondary-red));
            color: white;
            box-shadow: 0 1px 3px rgba(234, 88, 12, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(234, 88, 12, 0.3);
        }

        .btn-secondary {
            background: white;
            color: var(--text-dark);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            border-color: var(--primary-orange);
            color: var(--primary-orange);
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--gray-200);
            z-index: 1000;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 70px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            font-size: 18px;
            color: var(--text-dark);
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary-orange), var(--secondary-red));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg {
            width: 16px;
            height: 16px;
            color: white;
        }

        .nav {
            display: flex;
            gap: 32px;
        }

        .nav a {
            color: var(--gray-600);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .nav a:hover {
            color: var(--primary-orange);
        }

        /* Hero Section - GÜNCELLENDİ */
        .hero {
            padding: 180px 0 100px;
            background: linear-gradient(135deg, #fef7f0 0%, #fef2f2 100%);
            position: relative;
            overflow: hidden;
        }

        .hero-content {
            text-align: center;
            max-width: 800px;
            margin: 0 auto 60px;
        }

        .hero h1 {
            margin-bottom: 24px;
            background: linear-gradient(135deg, var(--text-dark), var(--primary-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero p {
            font-size: 20px;
            color: var(--gray-600);
            margin-bottom: 40px;
            line-height: 1.6;
        }

        .hero-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-bottom: 60px;
        }

        /* Georgia Map Animation */
        .georgia-map {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            height: 400px;
        }

        .map-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--gray-200);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        }

        .city-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, var(--primary-orange), var(--secondary-red));
            border-radius: 50%;
            cursor: pointer;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
            box-shadow: 0 0 0 rgba(234, 88, 12, 0.4);
        }

        .city-marker:hover {
            transform: translate(-50%, -50%) scale(1.3);
            box-shadow: 0 0 20px rgba(234, 88, 12, 0.6);
        }

        .city-info {
            position: absolute;
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 10;
            border: 1px solid var(--gray-200);
        }

        .city-marker:hover .city-info {
            opacity: 1;
            transform: translateY(0);
        }

        .tbilisi { top: 40%; left: 60%; }
        .batumi { top: 20%; left: 25%; }
        .kutaisi { top: 45%; left: 50%; }
        .poti { top: 25%; left: 30%; }
        .hualing { top: 35%; left: 55%; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(234, 88, 12, 0); }
            100% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0); }
        }

        /* Features Grid */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 32px;
            margin-bottom: 60px;
        }

        .feature-card {
            padding: 32px;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .feature-card:hover {
            border-color: var(--primary-orange);
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        .feature-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .feature-icon.orange { background: #fef3f2; }
        .feature-icon.red { background: #fef2f2; }
        .feature-icon.amber { background: #fffbeb; }
        .feature-icon.emerald { background: #f0fdf4; }
        .feature-icon.purple { background: #faf5ff; }
        .feature-icon.blue { background: #eff6ff; }

        .feature-icon svg {
            width: 20px;
            height: 20px;
        }

        .feature-icon.orange svg { color: #ea580c; }
        .feature-icon.red svg { color: #dc2626; }
        .feature-icon.amber svg { color: #d97706; }
        .feature-icon.emerald svg { color: #059669; }
        .feature-icon.purple svg { color: #7c3aed; }
        .feature-icon.blue svg { color: #2563eb; }

        /* Free Zones Section */
        .free-zones {
            padding: 100px 0;
            background: var(--gray-50);
        }

        .zones-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 32px;
        }

        .zone-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .zone-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-orange);
        }

        .zone-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--primary-orange), var(--secondary-red));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .zone-icon svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        .zone-advantage {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
            font-size: 14px;
            color: var(--gray-600);
        }

        .zone-advantage .check {
            color: #059669;
            flex-shrink: 0;
        }

        /* Batum Construction Section */
        .batum-construction {
            padding: 100px 0;
            background: white;
            position: relative;
            overflow: hidden;
        }

        .construction-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
            align-items: center;
        }

        .construction-animation {
            position: relative;
            height: 400px;
            border-radius: 16px;
            overflow: hidden;
        }

        .construction-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .building {
            position: absolute;
            bottom: 0;
            width: 60px;
            background: linear-gradient(to top, #475569, #64748b);
            transition: all 0.5s ease;
        }

        .building-1 { left: 20%; height: 150px; animation: grow-1 3s ease-in-out infinite alternate; }
        .building-2 { left: 35%; height: 200px; animation: grow-2 4s ease-in-out infinite alternate; }
        .building-3 { left: 50%; height: 250px; animation: grow-3 5s ease-in-out infinite alternate; }
        .building-4 { left: 65%; height: 180px; animation: grow-4 3.5s ease-in-out infinite alternate; }
        .building-5 { left: 80%; height: 220px; animation: grow-5 4.5s ease-in-out infinite alternate; }

        @keyframes grow-1 {
            0% { height: 150px; }
            100% { height: 180px; }
        }

        @keyframes grow-2 {
            0% { height: 200px; }
            100% { height: 240px; }
        }

        @keyframes grow-3 {
            0% { height: 250px; }
            100% { height: 300px; }
        }

        @keyframes grow-4 {
            0% { height: 180px; }
            100% { height: 220px; }
        }

        @keyframes grow-5 {
            0% { height: 220px; }
            100% { height: 260px; }
        }

        .advantages-list {
            list-style: none;
        }

        .advantages-list li {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            font-size: 16px;
            color: var(--gray-600);
        }

        .advantages-list .check {
            color: #059669;
            flex-shrink: 0;
        }

        /* Services Section */
        .services {
            padding: 100px 0;
            background: var(--gray-50);
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 32px;
        }

        .service-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 32px;
            transition: all 0.2s ease;
        }

        .service-card:hover {
            border-color: var(--primary-orange);
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        .service-card h3 {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .service-card .icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-orange), var(--secondary-red));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .service-card .icon svg {
            width: 20px;
            height: 20px;
            color: white;
        }

        /* Reports Section - Güncellendi */
        .reports {
            padding: 100px 0;
            background: white;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 32px;
        }

        .report-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .report-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-orange);
        }

        .report-badge {
            background: var(--primary-orange);
            color: white;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            border-bottom-right-radius: 8px;
            display: inline-block;
        }

        .report-content {
            padding: 24px;
        }

        .report-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 16px 0;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: var(--gray-50);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* CTA Section */
        .cta {
            padding: 100px 0;
            background: linear-gradient(135deg, var(--primary-orange), var(--secondary-red));
            color: white;
            text-align: center;
        }

        .cta h2 {
            color: white;
            margin-bottom: 16px;
        }

        .cta p {
            font-size: 18px;
            margin-bottom: 32px;
            opacity: 0.9;
        }

        .cta-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
        }

        /* Footer */
        .footer {
            background: var(--gray-900);
            color: var(--gray-400);
            padding: 60px 0 40px;
        }

        .footer-content {
            text-align: center;
        }

        .footer-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
            color: white;
            font-weight: 600;
            font-size: 18px;
        }

        .footer-logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary-orange), var(--secondary-red));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .footer-logo-icon svg {
            width: 16px;
            height: 16px;
            color: white;
        }

        .footer p {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .footer-disclaimer {
            border-top: 1px solid var(--gray-800);
            margin-top: 40px;
            padding-top: 32px;
            font-size: 12px;
            color: var(--gray-500);
        }

        /* AI Analysis Section Styles */
        .ai-analysis {
            padding: 100px 0;
            background: white;
        }

        .ai-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 48px;
        }

        .ai-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        }

        .chat-container {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: var(--gray-50);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--gray-200);
        }

        .chat-bubble {
            background: white;
            border-radius: 18px;
            padding: 12px 18px;
            margin-bottom: 12px;
            max-width: 80%;
            border: 1px solid var(--gray-200);
        }

        .chat-bubble.user {
            background: linear-gradient(135deg, var(--primary-orange), var(--secondary-red));
            color: white;
            margin-left: auto;
            border: none;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }
            
            h1 {
                font-size: 2.5rem;
            }
            
            h2 {
                font-size: 2rem;
            }
            
            .hero-actions,
            .cta-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .nav {
                display: none;
            }
            
            .ai-grid,
            .construction-content {
                grid-template-columns: 1fr;
            }
            
            .features-grid,
            .zones-grid,
            .services-grid,
            .reports-grid {
                grid-template-columns: 1fr;
            }
            
            .georgia-map {
                height: 300px;
            }
        }

        /* Responsive için */
@media (max-width: 768px) {
    .contact-section .container > div {
        grid-template-columns: 1fr;
        gap: 40px;
    }
    
    #contact-form {
        padding: 24px;
    }
    
    .contact-section .section-header {
        margin-bottom: 40px;
    }
    
    .contact-section h2 {
        font-size: 2rem;
    }
}
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                    ParenaTrade
                </div>
                
                <nav class="nav">
                    <a href="#analysis">AI Analiz</a>
                    <a href="#zones">Serbest Bölgeler</a>
                    <a href="#batum">Batum Avantajları</a>
                    <a href="#services">Hizmetlerimiz</a>
                    <a href="#reports">Raporlar</a>
                    <a href="#contact">İletişim</a>
                </nav>
                
                <a href="#analysis" class="btn btn-primary">Ücretsiz Analiz</a>
            </div>
        </div>
    </header>

    <!-- Hero Section - Güncellendi -->
    <section class="hero">
        <div class="container">
            <div class="hero-content">
                <h1>Gürcistan'da Yatırım Fırsatlarını Keşfedin</h1>
                <p>AI destekli analizler, vergi avantajları ve serbest bölgelerde yatırım rehberiniz</p>
                
                <div class="hero-actions">
                    <a href="#analysis" class="btn btn-primary">AI Analiz Başlat</a>
                    <a href="#zones" class="btn btn-secondary">Serbest Bölgeleri İncele</a>
                </div>
            </div>
            
            <!-- Gürcistan Haritası -->
            <div class="georgia-map">
                <div class="map-container">
                    <div class="city-marker tbilisi">
                        <div class="city-info">
                            <h4>Tiflis Serbest Bölgesi</h4>
                            <p>%0 vergi avantajı<br>Sanal ofis hizmeti<br>Uzaktan kayıt</p>
                        </div>
                    </div>
                    <div class="city-marker batumi">
                        <div class="city-info">
                            <h4>Batum</h4>
                            <p>Deniz iklimi<br>Yatırım fırsatları<br>Turizm merkezi</p>
                        </div>
                    </div>
                    <div class="city-marker kutaisi">
                        <div class="city-info">
                            <h4>Kutaisi Serbest Bölgesi</h4>
                            <p>Sanayi odaklı<br>%100 yabancı mülkiyet<br>Fabrika alanları</p>
                        </div>
                    </div>
                    <div class="city-marker poti">
                        <div class="city-info">
                            <h4>Poti Serbest Bölgesi</h4>
                            <p>Liman erişimi<br>Uluslararası ticaret<br>Lojistik merkez</p>
                        </div>
                    </div>
                    <div class="city-marker hualing">
                        <div class="city-info">
                            <h4>Hualing Serbest Bölgesi</h4>
                            <p>Ahşap işleme<br>Mobilya üretimi<br>İnşaat sektörü</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- AI Analysis Section - Üste Taşındı -->
    <section id="analysis" class="ai-analysis">
        <div class="container">
            <div class="section-header" style="text-align: center; margin-bottom: 60px;">
                <h2>AI Destekli Yatırım Analizi</h2>
                <p style="color: var(--gray-600); font-size: 18px;">Gürcistan'da yatırım fırsatlarınızı AI ile analiz edin</p>
            </div>
            
            <div class="ai-grid">
                <!-- Firma Analiz Sohbeti -->
                <div class="ai-card">
                    <h3 style="margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                        <div class="feature-icon orange">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg>
                        </div>
                        Firma Analiz Sohbeti
                    </h3>
                    
                    <div class="chat-container" id="chat-container">
                        <div class="chat-bubble">
                            <p>Merhaba! Gürcistan'da hangi sektörde yatırım yapmayı düşünüyorsunuz?</p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <select class="form-select" id="service-select">
                            <option value="">Yatırım türü seçin</option>
                            <option value="manufacturing">Üretim/İmalat</option>
                            <option value="tourism">Turizm</option>
                            <option value="agriculture">Tarım</option>
                            <option value="technology">Teknoloji</option>
                            <option value="logistics">Lojistik</option>
                        </select>
                    </div>
                    
                    <div id="chat-input-area" class="hidden">
                        <div class="form-group">
                            <input type="text" id="chat-input" class="form-input" placeholder="Cevabınızı yazın...">
                        </div>
                        <button id="send-text" class="btn btn-primary" style="width: 100%;">
                            Gönder
                        </button>
                    </div>
                </div>
                
                <!-- Hızlı Pazar Sorgulama -->
                <div class="ai-card">
                    <h3 style="margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                        <div class="feature-icon red">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </div>
                        Hızlı Pazar Sorgulama
                    </h3>
                    
                    <div class="form-group">
                        <label class="form-label">Rapor Türü</label>
                        <select class="form-select" id="report-template-select">
                            <option value="">Rapor türü seçin</option>
                            <option value="georgia-market">Gürcistan Pazar Analizi</option>
                            <option value="free-zone">Serbest Bölge Karşılaştırması</option>
                            <option value="sector-report">Sektörel Yatırım Raporu</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Hedef Bölge</label>
                        <select class="form-select" id="target-region">
                            <option value="">Bölge seçin</option>
                            <option value="tbilisi">Tiflis Serbest Bölgesi</option>
                            <option value="kutaisi">Kutaisi Serbest Bölgesi</option>
                            <option value="poti">Poti Serbest Bölgesi</option>
                            <option value="hualing">Hualing Serbest Bölgesi</option>
                            <option value="batumi">Batum</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Yatırım Alanı</label>
                        <input type="text" class="form-input" id="investment-area" placeholder="Örn: Tekstil, Gıda, Teknoloji...">
                    </div>
                    
                    <button id="generate-report-btn" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-search mr-2"></i> Rapor Oluştur
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Serbest Bölgeler Section -->
    <section id="zones" class="free-zones">
        <div class="container">
            <div class="section-header" style="text-align: center; margin-bottom: 60px;">
                <h2>Gürcistan Serbest Bölgeleri</h2>
                <p style="color: var(--gray-600); font-size: 18px;">%0 vergi avantajları ile yatırım fırsatları</p>
            </div>
            
            <div class="zones-grid">
                <!-- Tiflis Serbest Bölgesi -->
                <div class="zone-card">
                    <div class="zone-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                    </div>
                    <h3 style="margin-bottom: 16px;">Tiflis Serbest Bölgesi</h3>
                    <p style="color: var(--gray-600); margin-bottom: 20px; font-size: 14px;">Sanal ofis, uzaktan kayıt, düşük elektrik maliyetleri</p>
                    
                    <div style="text-align: left;">
                        <div class="zone-advantage">
                            <svg class="check" width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            %0 Kurumlar Vergisi
                        </div>
                        <div class="zone-advantage">
                            <svg class="check" width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            %0 KDV
                        </div>
                        <div class="zone-advantage">
                            <svg class="check" width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            %0 Gelir Vergisi
                        </div>
                    </div>
                </div>
                
                <!-- Kutaisi Serbest Bölgesi -->
                <div class="zone-card">
                    <div class="zone-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                    </div>
                    <h3 style="margin-bottom: 16px;">Kutaisi Serbest Bölgesi</h3>
                    <p style="color: var(--gray-600); margin-bottom: 20px; font-size: 14px;">Sanayi ve ticaret odaklı, %100 yabancı mülkiyet</p>
                    
                    <div style="text-align: left;">
                        <div class="zone-advantage">
                            <svg class="check" width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            Sanayi Alanları
                        </div>
                        <div class="zone-advantage">
                            <svg class="check" width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            %100 Yabancı Mülkiyet
                        </div>
                        <div class="zone-advantage">
                            <svg class="check" width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            Vergi Avantajları
                        </div>
                    </div>
                </div>
                
                <!-- Poti Serbest Bölgesi -->
                <div class="zone-card">
                    <div class="zone-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                    </div>
                    <h3 style="margin-bottom: 16px;">Poti Serbest Bölgesi</h3>
                    <p style="color: var(--gray-600); margin-bottom: 20px; font-size: 14px;">Liman erişimi, uluslararası ticaret merkezi</p>
                    
                    <div style="text-align: left;">
                        <div class="zone-advantage">
                            <svg class="check" width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            Liman Erişimi
                        </div>
                        <div class="zone-advantage">
                            <svg class="check" width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            Lojistik Merkez
                        </div>
                        <div class="zone-advantage">
                            <svg class="check" width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            %0 Vergi Avantajı
                        </div>
                    </div>
                </div>
                
                <!-- Hualing Serbest Bölgesi -->
                <div class="zone-card">
                    <div class="zone-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                    </div>
                    <h3 style="margin-bottom: 16px;">Hualing Serbest Bölgesi</h3>
                    <p style="color: var(--gray-600); margin-bottom: 20px; font-size: 14px;">Ahşap işleme, mobilya üretimi, inşaat sektörü</p>
                    
                    <div style="text-align: left;">
                        <div class="zone-advantage">
                            <svg class="check" width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            Ahşap İşleme
                        </div>
                        <div class="zone-advantage">
                            <svg class="check" width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            Mobilya Üretimi
                        </div>
                        <div class="zone-advantage">
                            <svg class="check" width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            İnşaat Sektörü
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Batum Construction Section -->
    <section id="batum" class="batum-construction">
        <div class="container">
            <div class="section-header" style="text-align: center; margin-bottom: 60px;">
                <h2>Batum: Yükselen Yatırım Merkezi</h2>
                <p style="color: var(--gray-600); font-size: 18px;">Deniz iklimi ve gelişen inşaat sektörü ile fırsatlar şehri</p>
            </div>
            
            <div class="construction-content">
                <div class="construction-animation">
                    <div class="construction-placeholder">
                        <div class="building building-1"></div>
                        <div class="building building-2"></div>
                        <div class="building building-3"></div>
                        <div class="building building-4"></div>
                        <div class="building building-5"></div>
                    </div>
                </div>
                
                <div>
                    <h3 style="margin-bottom: 24px;">Batum Yatırım Avantajları</h3>
                    <ul class="advantages-list">
                        <li>
                            <svg class="check" width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            <span>Akdeniz iklimi ile yıl boyu turizm potansiyeli</span>
                        </li>
                        <li>
                            <svg class="check" width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            <span>Gelişen inşaat sektörü ve emlak yatırımları</span>
                        </li>
                        <li>
                            <svg class="check" width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            <span>Kumarhane ve eğlence sektöründe lider bölge</span>
                        </li>
                        <li>
                            <svg class="check" width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            <span>Deniz turizmi ve marina yatırımları</span>
                        </li>
                        <li>
                            <svg class="check" width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            <span>Türkiye sınırına yakınlık avantajı</span>
                        </li>
                    </ul>
                    
                    <a href="#analysis" class="btn btn-primary" style="margin-top: 32px;">
                        <i class="fas fa-chart-line mr-2"></i> Batum Yatırım Analizi
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- SERVICES SECTION - GÜNCELLENMİŞ HALİ -->
<section id="services" class="services">
    <div class="container">
        <div class="section-header" style="text-align: center; margin-bottom: 60px;">
            <h2>Hizmetlerimiz</h2>
            <p style="color: var(--gray-600); font-size: 18px;">Gürcistan'da yatırım yolculuğunuzda yanınızdayız</p>
        </div>
        
        <div class="services-grid">
            <!-- Pazar Analizi Kartı -->
            <div class="service-card">
                <h3>
                    <div class="icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                    </div>
                    Pazar Analizi
                </h3>
                <p style="color: var(--gray-600); margin-bottom: 20px; font-size: 14px;">Gürcistan pazarında detaylı sektörel analiz ve raporlama</p>
                <ul style="color: var(--gray-600); font-size: 14px; list-style-type: none; padding-left: 0;">
                    <li style="margin-bottom: 8px;">• Rakip analizi</li>
                    <li style="margin-bottom: 8px;">• Fiyat trendleri</li>
                    <li style="margin-bottom: 8px;">• Pazar büyüklüğü</li>
                </ul>
            </div>
            
            <!-- Şirket Kuruluşu Kartı -->
            <div class="service-card">
                <h3>
                    <div class="icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                    </div>
                    Şirket Kuruluşu
                </h3>
                <p style="color: var(--gray-600); margin-bottom: 20px; font-size: 14px;">Serbest bölgelerde şirket kurulumu ve kayıt işlemleri</p>
                <ul style="color: var(--gray-600); font-size: 14px; list-style-type: none; padding-left: 0;">
                    <li style="margin-bottom: 8px;">• Hızlı kayıt</li>
                    <li style="margin-bottom: 8px;">• Yasal danışmanlık</li>
                    <li style="margin-bottom: 8px;">• Belge hazırlama</li>
                </ul>
            </div>
            
            <!-- Vergi Danışmanlığı Kartı -->
            <div class="service-card">
                <h3>
                    <div class="icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    Vergi Danışmanlığı
                </h3>
                <p style="color: var(--gray-600); margin-bottom: 20px; font-size: 14px;">Gürcistan vergi sistemi ve serbest bölge avantajları</p>
                <ul style="color: var(--gray-600); font-size: 14px; list-style-type: none; padding-left: 0;">
                    <li style="margin-bottom: 8px;">• Vergi optimizasyonu</li>
                    <li style="margin-bottom: 8px;">• Raporlama</li>
                    <li style="margin-bottom: 8px;">• Uyumluluk</li>
                </ul>
            </div>
            
            <!-- GÜNCELLENMİŞ 1. Kart: İş Geliştirme & Operasyon -->
<div class="service-card">
    <h3>
        <div class="icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
            </svg>
        </div>
        İş Geliştirme & Operasyon
    </h3>
    <p style="color: var(--gray-600); margin-bottom: 20px; font-size: 14px;">
        Fiziksel altyapı kurulumu ve ticari operasyonların başlatılması
    </p>
    
    <!-- Fiziksel Altyapı Vurgusu -->
    <div style="margin-bottom: 16px; padding: 12px; background: #f0fdf4; border-radius: 8px; border-left: 3px solid #059669;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
            <svg width="16" height="16" fill="#059669" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/>
            </svg>
            <span style="font-size: 13px; font-weight: 600; color: var(--text-dark);">Fiziksel Yatırım Yönetimi</span>
        </div>
        <p style="font-size: 11px; color: var(--gray-600); margin: 0; line-height: 1.4;">
            Arsa/fabrika seçimi, proje yönetimi, inşaat süreç takibi
        </p>
    </div>
    
    <ul style="color: var(--gray-600); font-size: 14px; list-style-type: none; padding-left: 0;">
        <li style="margin-bottom: 10px; display: flex; align-items: flex-start;">
            <span style="color: var(--primary-orange); margin-right: 8px; flex-shrink: 0;">•</span>
            <span>
                <strong>Depo & Fabrika Kurulumu:</strong> 
                <span style="display: block; font-size: 12px; color: var(--gray-500); margin-top: 2px;">
                    Yer seçimi, mimari proje, inşaat izinleri, donanım temini
                </span>
            </span>
        </li>
        <li style="margin-bottom: 10px; display: flex; align-items: flex-start;">
            <span style="color: var(--primary-orange); margin-right: 8px; flex-shrink: 0;">•</span>
            <span>
                <strong>Pazar Giriş Stratejisi:</strong>
                <span style="display: block; font-size: 12px; color: var(--gray-500); margin-top: 2px;">
                    Gürcistan ve Orta Asya pazarlarına entegrasyon planı
                </span>
            </span>
        </li>
        <li style="margin-bottom: 10px; display: flex; align-items: flex-start;">
            <span style="color: var(--primary-orange); margin-right: 8px; flex-shrink: 0;">•</span>
            <span>
                <strong>Tedarik Zinciri Kurulumu:</strong>
                <span style="display: block; font-size: 12px; color: var(--gray-500); margin-top: 2px;">
                    Yerel tedarikçi bulma, anlaşma yönetimi, kalite kontrol
                </span>
            </span>
        </li>
        <li style="display: flex; align-items: flex-start;">
            <span style="color: var(--primary-orange); margin-right: 8px; flex-shrink: 0;">•</span>
            <span>
                <strong>Distribütör Ağı Oluşturma:</strong>
                <span style="display: block; font-size: 12px; color: var(--gray-500); margin-top: 2px;">
                    Yerel satış kanalları ve distribütör networkü kurulumu
                </span>
            </span>
        </li>
    </ul>
    
    <!-- Serbest Bölge Avantajları -->
    <div style="margin-top: 16px; padding: 12px; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--gray-200);">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <div style="width: 20px; height: 20px; background: var(--primary-orange); border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                <svg width="10" height="10" fill="white" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                </svg>
            </div>
            <span style="font-size: 12px; font-weight: 600; color: var(--text-dark);">Serbest Bölge Avantajları</span>
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 8px; font-size: 10px; color: var(--gray-600);">
            <span style="padding: 4px 8px; background: #fef3c7; border-radius: 4px; border: 1px solid #fbbf24;">
                ⚡ 3 Gün Şirket Kurma
            </span>
            <span style="padding: 4px 8px; background: #dbeafe; border-radius: 4px; border: 1px solid #60a5fa;">
                📦 Gümrük Muafiyeti
            </span>
            <span style="padding: 4px 8px; background: #dcfce7; border-radius: 4px; border: 1px solid #34d399;">
                💰 %0 Vergi
            </span>
        </div>
    </div>
</div>

<!-- GÜNCELLENMİŞ 2. Kart: İşletme Yönetimi -->
<div class="service-card">
    <h3>
        <div class="icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
            </svg>
        </div>
        İşletme Yönetimi
    </h3>
    <p style="color: var(--gray-600); margin-bottom: 20px; font-size: 14px;">
        Operasyonel süreçlerin profesyonel yönetimi ve optimizasyonu
    </p>
    
    <!-- Operasyonel Mükemmellik Vurgusu -->
    <div style="margin-bottom: 16px; padding: 12px; background: #e0f2fe; border-radius: 8px; border-left: 3px solid #0ea5e9;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
            <svg width="16" height="16" fill="#0ea5e9" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span style="font-size: 13px; font-weight: 600; color: var(--text-dark);">Operasyonel Mükemmellik</span>
        </div>
        <p style="font-size: 11px; color: var(--gray-600); margin: 0; line-height: 1.4;">
            Departman kurulumu, süreç optimizasyonu, performans yönetimi
        </p>
    </div>
    
    <ul style="color: var(--gray-600); font-size: 14px; list-style-type: none; padding-left: 0;">
        <li style="margin-bottom: 10px; display: flex; align-items: flex-start;">
            <span style="color: var(--primary-orange); margin-right: 8px; flex-shrink: 0;">•</span>
            <span>
                <strong>Departman Kurulumu:</strong> 
                <span style="display: block; font-size: 12px; color: var(--gray-500); margin-top: 2px;">
                    İ.K., üretim, satış, muhasebe, finans departmanlarının yapılandırılması
                </span>
            </span>
        </li>
        <li style="margin-bottom: 10px; display: flex; align-items: flex-start;">
            <span style="color: var(--primary-orange); margin-right: 8px; flex-shrink: 0;">•</span>
            <span>
                <strong>Lojistik & Operasyon:</strong>
                <span style="display: block; font-size: 12px; color: var(--gray-500); margin-top: 2px;">
                    Gümrük, nakliye, depolama ve dağıtım zinciri optimizasyonu
                </span>
            </span>
        </li>
        <li style="margin-bottom: 10px; display: flex; align-items: flex-start;">
            <span style="color: var(--primary-orange); margin-right: 8px; flex-shrink: 0;">•</span>
            <span>
                <strong>İnsan Kaynakları Yönetimi:</strong>
                <span style="display: block; font-size: 12px; color: var(--gray-500); margin-top: 2px;">
                    Personel bulma, eğitim, performans ve ücret yönetimi
                </span>
            </span>
        </li>
        <li style="margin-bottom: 10px; display: flex; align-items: flex-start;">
            <span style="color: var(--primary-orange); margin-right: 8px; flex-shrink: 0;">•</span>
            <span>
                <strong>Pazarlama & İhracat:</strong>
                <span style="display: block; font-size: 12px; color: var(--gray-500); margin-top: 2px;">
                    Pazarlama stratejileri, ihracat operasyonları, müşteri ilişkileri
                </span>
            </span>
        </li>
        <li style="display: flex; align-items: flex-start;">
            <span style="color: var(--primary-orange); margin-right: 8px; flex-shrink: 0;">•</span>
            <span>
                <strong>Denetim & Raporlama:</strong>
                <span style="display: block; font-size: 12px; color: var(--gray-500); margin-top: 2px;">
                    Performans ölçümleme, denetim raporları, yönetim bilgi sistemi
                </span>
            </span>
        </li>
    </ul>
    
    <!-- Performans Metrikleri -->
    <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 8px; border: 1px solid #fbbf24;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <div style="width: 20px; height: 20px; background: #f59e0b; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                <svg width="10" height="10" fill="white" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd"/>
                </svg>
            </div>
            <span style="font-size: 12px; font-weight: 600; color: var(--text-dark);">Performans Hedefleri</span>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--gray-700);">
            <div style="text-align: center;">
                <div style="font-weight: 700; color: #059669;">+25%</div>
                <div>Verimlilik</div>
            </div>
            <div style="text-align: center;">
                <div style="font-weight: 700; color: #059669;">-30%</div>
                <div>Operasyon Maliyeti</div>
            </div>
            <div style="text-align: center;">
                <div style="font-weight: 700; color: #059669;">+40%</div>
                <div>İhracat Hacmi</div>
            </div>
        </div>
    </div>
</div>
            <!-- OPTİMİZE EDİLMİŞ Kredi & Finansman Kartı -->
<div class="service-card">
    <h3>
        <div class="icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
        </div>
        Finansman Çözümleri
    </h3>
    <p style="color: var(--gray-600); margin-bottom: 20px; font-size: 14px;">
        Yatırım projeleriniz için optimize edilmiş finansman yapılandırması
    </p>
    
    <!-- ÖZET KARŞILAŞTIRMA -->
    <div style="margin-bottom: 20px; border: 1px solid var(--gray-200); border-radius: 12px; overflow: hidden;">
        <!-- Tablo Başlıkları -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; background: var(--gray-50);">
            <div style="padding: 8px; text-align: center; border-right: 1px solid var(--gray-200);">
                <div style="font-size: 12px; font-weight: 600; color: #52525b;">Finansman Türü</div>
            </div>
            <div style="padding: 8px; text-align: center;">
                <div style="font-size: 12px; font-weight: 600; color: #52525b;">Avantajları</div>
            </div>
        </div>
        
        <!-- Teminatlı Yatırım Kredisi -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; border-top: 1px solid var(--gray-100);">
            <div style="padding: 12px 8px; border-right: 1px solid var(--gray-100); background: white;">
                <div style="font-size: 11px; font-weight: 700; color: #059669; margin-bottom: 4px;">Teminatlı Yatırım Kredisi</div>
                <div style="font-size: 9px; color: var(--gray-500);">Türkiye varlıkları teminat</div>
            </div>
            <div style="padding: 12px 8px; background: white;">
                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                    <span style="font-size: 9px; padding: 2px 6px; background: #f0fdf4; color: #059669; border-radius: 10px; border: 1px solid #86efac;">
                        %8-12 Faiz
                    </span>
                    <span style="font-size: 9px; padding: 2px 6px; background: #f0f9ff; color: #0ea5e9; border-radius: 10px; border: 1px solid #7dd3fc;">
                        3-10 Yıl
                    </span>
                    <span style="font-size: 9px; padding: 2px 6px; background: #fef3c7; color: #d97706; border-radius: 10px; border: 1px solid #fcd34d;">
                        USD/Euro
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Proje Finansmanı -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; border-top: 1px solid var(--gray-100);">
            <div style="padding: 12px 8px; border-right: 1px solid var(--gray-100); background: white;">
                <div style="font-size: 11px; font-weight: 700; color: #7c3aed; margin-bottom: 4px;">Proje Finansmanı</div>
                <div style="font-size: 9px; color: var(--gray-500);">Nakit akışı temelli</div>
            </div>
            <div style="padding: 12px 8px; background: white;">
                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                    <span style="font-size: 9px; padding: 2px 6px; background: #faf5ff; color: #7c3aed; border-radius: 10px; border: 1px solid #d8b4fe;">
                        Yapılandırılmış
                    </span>
                    <span style="font-size: 9px; padding: 2px 6px; background: #f0f9ff; color: #0ea5e9; border-radius: 10px; border: 1px solid #7dd3fc;">
                        Risk Paylaşımı
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Trade Finance -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; border-top: 1px solid var(--gray-100);">
            <div style="padding: 12px 8px; border-right: 1px solid var(--gray-100); background: white;">
                <div style="font-size: 11px; font-weight: 700; color: #dc2626; margin-bottom: 4px;">Trade Finance</div>
                <div style="font-size: 9px; color: var(--gray-500);">İhracat/ithalat destek</div>
            </div>
            <div style="padding: 12px 8px; background: white;">
                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                    <span style="font-size: 9px; padding: 2px 6px; background: #fef2f2; color: #dc2626; border-radius: 10px; border: 1px solid #fecaca;">
                        LC & Garantiler
                    </span>
                    <span style="font-size: 9px; padding: 2px 6px; background: #fef3c7; color: #d97706; border-radius: 10px; border: 1px solid #fcd34d;">
                        İhracat Öncesi
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- NEDEN GÜRCİSTAN'DAN FİNANSMAN? -->
    <div style="margin-bottom: 16px; padding: 14px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 10px; border: 1px solid #fbbf24;">
        <div style="display: flex; align-items: flex-start; gap: 10px;">
            <div style="width: 20px; height: 20px; background: #d97706; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <svg width="10" height="10" fill="white" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
            </div>
            <div>
                <div style="font-size: 12px; font-weight: 700; color: #92400e; margin-bottom: 6px;">
                    Yatırım Finansmanında Stratejik Avantaj
                </div>
                <div style="font-size: 10px; color: #92400e; line-height: 1.4;">
                    • Türkiye'deki varlıklarınız teminat gösterilir<br>
                    • Gürcistan'daki yatırım projeniz finanse edilir<br>
                    • Düşük faiz, uzun vade, döviz cinsi imkanlar<br>
                    • İhracat odaklı iş modelinize uygun yapı
                </div>
            </div>
        </div>
    </div>
    
    <!-- HIZLI REFERANS BADGELER -->
    <div style="margin-bottom: 16px;">
        <div style="font-size: 11px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px; text-align: center;">
            Finansman Sürecimiz
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 9px; color: var(--gray-600);">
            <div style="text-align: center; flex: 1;">
                <div style="width: 24px; height: 24px; background: #fef3c7; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 4px; border: 2px solid #fbbf24;">
                    <span style="font-size: 10px; font-weight: 700; color: #d97706;">1</span>
                </div>
                <div>Analiz</div>
                <div style="font-size: 8px; color: var(--gray-500);">1-3 gün</div>
            </div>
            <div style="text-align: center; flex: 1;">
                <div style="width: 24px; height: 24px; background: #dbeafe; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 4px; border: 2px solid #60a5fa;">
                    <span style="font-size: 10px; font-weight: 700; color: #1d4ed8;">2</span>
                </div>
                <div>Yapılandırma</div>
                <div style="font-size: 8px; color: var(--gray-500);">3-7 gün</div>
            </div>
            <div style="text-align: center; flex: 1;">
                <div style="width: 24px; height: 24px; background: #dcfce7; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 4px; border: 2px solid #34d399;">
                    <span style="font-size: 10px; font-weight: 700; color: #059669;">3</span>
                </div>
                <div>Onay & Kullanım</div>
                <div style="font-size: 8px; color: var(--gray-500);">10-20 gün</div>
            </div>
        </div>
    </div>
    
    <!-- DESTEK ALANLARI -->
    <div style="padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
        <div style="font-size: 11px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
            <svg width="12" height="12" fill="#475569" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/>
            </svg>
            Kapsamlı Destek
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
            <span style="font-size: 9px; padding: 4px 8px; background: white; color: var(--gray-700); border-radius: 6px; border: 1px solid #e2e8f0;">
                Banka Dosyası Hazırlığı
            </span>
            <span style="font-size: 9px; padding: 4px 8px; background: white; color: var(--gray-700); border-radius: 6px; border: 1px solid #e2e8f0;">
                Teminat Değerleme
            </span>
            <span style="font-size: 9px; padding: 4px 8px; background: white; color: var(--gray-700); border-radius: 6px; border: 1px solid #e2e8f0;">
                Proje Finans Modeli
            </span>
            <span style="font-size: 9px; padding: 4px 8px; background: white; color: var(--gray-700); border-radius: 6px; border: 1px solid #e2e8f0;">
                Risk Analizi
            </span>
        </div>
    </div>
</div>
</section>            
    <!-- Reports Section - Güncellendi -->
    <section id="reports" class="reports">
        <div class="container">
            <div class="section-header" style="text-align: center; margin-bottom: 60px;">
                <h2>Gürcistan Yatırım Raporları</h2>
                <p style="color: var(--gray-600); font-size: 18px;">AI destekli detaylı sektörel analiz raporları</p>
            </div>
            
           <!-- Plastik Ambalaj Sektörü Raporu - Güncellenmiş -->
<div class="report-card">
    <div class="report-badge" style="background: #2563eb;">Plastik Ambalaj</div>
    <div class="report-content">
        <h3 style="margin-bottom: 16px;">Gürcistan Plastik Ambalaj İthalatı</h3>
        <p style="color: var(--gray-600); margin-bottom: 20px; font-size: 14px;">
            Şişe, kap, poşet ve diğer plastik ürünler ithalat analizi<br>
            <small style="color: #2563eb; font-weight: 500;">Toplam İthalat: 461.64 Milyon USD</small>
        </p>
        
        <div class="report-stats">
            <div class="stat-item" style="background: #eff6ff;">
                <div class="stat-value">$461M</div>
                <div class="stat-label">Toplam İthalat</div>
                <small style="font-size: 10px; color: var(--gray-500);">yıllık</small>
            </div>
            <div class="stat-item" style="background: #eff6ff;">
                <div class="stat-value">%45</div>
                <div class="stat-label">Türkiye Payı</div>
                <small style="font-size: 10px; color: var(--gray-500);">Gıda ambalajında</small>
            </div>
        </div>
        
        <!-- Fırsat Tablosu -->
        <div style="margin: 16px 0; padding: 12px; background: #f8fafc; border-radius: 8px; border-left: 3px solid #2563eb;">
            <div style="font-size: 12px; color: var(--gray-700); margin-bottom: 8px;">
                <strong>📊 Fırsat Sıralaması:</strong>
            </div>
            
            <div style="font-size: 11px; color: var(--gray-600);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px; padding: 4px; background: #e0f2fe; border-radius: 4px;">
                    <span><strong>1. Gıda Ambalajı</strong></span>
                    <span>$150M</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px; padding: 4px; background: #f0f9ff; border-radius: 4px;">
                    <span>2. Ev Tipi Ürünler</span>
                    <span>$90M</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px; padding: 4px; background: #f8fafc; border-radius: 4px;">
                    <span>3. Tarımsal Plastik</span>
                    <span>$40M</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 4px; background: #f8fafc; border-radius: 4px;">
                    <span>4. İnşaat Plastik</span>
                    <span>$55M</span>
                </div>
            </div>
            
            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed #cbd5e1; font-size: 10px; color: var(--gray-500);">
                <strong>🎯 En Yüksek Fırsat:</strong> Gıda ambalajında %45 Türkiye bağımlılığı
            </div>
        </div>
        
        <button class="btn btn-primary" style="width: 100%; margin-top: 16px; background: linear-gradient(135deg, #2563eb, #1d4ed8);">
            <i class="fas fa-chart-pie mr-2"></i> Detaylı Rapor İncele
        </button>
    </div>
</div>                
               <!-- Tekstil Sektörü Raporu - Güncellenmiş -->
<div class="report-card">
    <div class="report-badge" style="background: #7c3aed;">Tekstil</div>
    <div class="report-content">
        <h3 style="margin-bottom: 16px;">Gürcistan Tekstil Üretimi</h3>
        <p style="color: var(--gray-600); margin-bottom: 20px; font-size: 14px;">
            Kutaisi serbest bölgesi tekstil yatırım fırsatları<br>
            <small style="color: #7c3aed; font-weight: 500;">İhracat: 180 Milyon USD</small>
        </p>
        
        <div class="report-stats">
            <div class="stat-item" style="background: #faf5ff;">
                <div class="stat-value">42</div>
                <div class="stat-label">Aktif Fabrika</div>
                <small style="font-size: 10px; color: var(--gray-500);">Kutaisi'nde 28</small>
            </div>
            <div class="stat-item" style="background: #faf5ff;">
                <div class="stat-value">+15%</div>
                <div class="stat-label">İhracat Artışı</div>
                <small style="font-size: 10px; color: var(--gray-500);">yıllık</small>
            </div>
        </div>
        
        <!-- Tekstil Detayları -->
        <div style="margin: 16px 0; padding: 12px; background: #f8fafc; border-radius: 8px; border-left: 3px solid #7c3aed;">
            <div style="font-size: 12px; color: var(--gray-700); margin-bottom: 8px;">
                <strong>📈 Sektör Detayları:</strong>
            </div>
            
            <div style="font-size: 11px; color: var(--gray-600);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span>• İstihdam:</span>
                    <span><strong>8,500 kişi</strong></span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span>• Avrupa İhracatı:</span>
                    <span><strong>65%</strong></span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span>• Türkiye İthalatı:</span>
                    <span><strong>45%</strong></span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>• Ortalama ROI:</span>
                    <span><strong>3-5 yıl</strong></span>
                </div>
            </div>
        </div>
        
        <button class="btn btn-primary" style="width: 100%; margin-top: 16px; background: linear-gradient(135deg, #7c3aed, #6d28d9);">
            <i class="fas fa-tshirt mr-2"></i> Tekstil Raporu İncele
        </button>
    </div>
</div>                
                <!-- Turizm Raporu -->
                <div class="report-card">
                    <div class="report-badge">Turizm</div>
                    <div class="report-content">
                        <h3 style="margin-bottom: 16px;">Batum Turizm Yatırımları</h3>
                        <p style="color: var(--gray-600); margin-bottom: 20px; font-size: 14px;">Otel, marina ve eğlence sektörü analizi</p>
                        
                        <div class="report-stats">
                            <div class="stat-item">
                                <div class="stat-value">1.2M</div>
                                <div class="stat-label">Yıllık Turist</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">%30</div>
                                <div class="stat-label">Doluluk Oranı</div>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" style="width: 100%; margin-top: 16px;">
                            Raporu İncele
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- CTA Section -->
    <section class="cta">
        <div class="container">
            <h2>Gürcistan'da Yatırım Fırsatını Kaçırmayın</h2>
            <p>AI destekli analizlerimizle size en uygun yatırım alanını belirleyelim</p>
            <div class="cta-actions">
                <a href="#analysis" class="btn" style="background: white; color: var(--primary-orange);">Ücretsiz Analiz Başlat</a>
                <a href="#contact" class="btn" style="background: transparent; color: white; border: 1px solid white;">İletişime Geç</a>
            </div>
        </div>
    </section>

    <!-- Footer üstüne İletişim Bölümü Ekleyelim -->
<section id="contact" class="contact-section" style="padding: 80px 0; background: white;">
    <div class="container">
        <div class="section-header" style="text-align: center; margin-bottom: 60px;">
            <h2>Bizimle İletişime Geçin</h2>
            <p style="color: var(--gray-600); font-size: 18px;">Gürcistan yatırım fırsatları hakkında detaylı bilgi alın</p>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 60px;">
            <!-- İletişim Bilgileri -->
            <div>
                <h3 style="margin-bottom: 30px; color: var(--text-dark);">İletişim Bilgilerimiz</h3>
                
                <!-- Adres -->
                <div style="display: flex; align-items: flex-start; gap: 16px; margin-bottom: 30px;">
                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary-orange), var(--secondary-red)); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <svg width="20" height="20" fill="white" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 8px; color: var(--text-dark); font-size: 16px;">Adres</h4>
                        <p style="color: var(--gray-600); line-height: 1.6; font-size: 15px;">
                            <strong>Gürcistan Ofis:</strong><br>
                            Angisa Street 1 line No:61<br>
                            Batum, Gürcistan
                        </p>
                    </div>
                </div>
                
                <!-- Telefon -->
                <div style="display: flex; align-items: flex-start; gap: 16px; margin-bottom: 30px;">
                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #059669, #10b981); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <svg width="20" height="20" fill="white" viewBox="0 0 20 20">
                            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                        </svg>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 8px; color: var(--text-dark); font-size: 16px;">Telefon</h4>
                        <p style="color: var(--gray-600); line-height: 1.6; font-size: 15px;">
                            <strong>Gürcistan:</strong><br>
                            +995 568 63 40 91
                        </p>
                        <div style="margin-top: 12px;">
                            <a href="tel:+995568634091" class="btn" style="background: #059669; color: white; padding: 8px 16px; font-size: 14px; border-radius: 6px; text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                                </svg>
                                Hemen Ara
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- WhatsApp -->
                <div style="display: flex; align-items: flex-start; gap: 16px;">
                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #25D366, #128C7E); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <svg width="20" height="20" fill="white" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 8px; color: var(--text-dark); font-size: 16px;">WhatsApp</h4>
                        <p style="color: var(--gray-600); line-height: 1.6; font-size: 15px;">
                            <strong>WhatsApp Üzerinden:</strong><br>
                            7/24 iletişime açığız
                        </p>
                        <div style="margin-top: 12px;">
                            <a href="https://wa.me/995568634091" target="_blank" class="btn" style="background: #25D366; color: white; padding: 8px 16px; font-size: 14px; border-radius: 6px; text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                                </svg>
                                WhatsApp'tan Yazın
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Çalışma Saatleri -->
                <div style="margin-top: 40px; padding: 20px; background: var(--gray-50); border-radius: 12px; border-left: 4px solid var(--primary-orange);">
                    <h4 style="margin-bottom: 8px; color: var(--text-dark); font-size: 16px;">Çalışma Saatleri</h4>
                    <p style="color: var(--gray-600); font-size: 14px; line-height: 1.6;">
                        <strong>Pazartesi - Cuma:</strong> 09:00 - 18:00<br>
                        <strong>Cumartesi:</strong> 10:00 - 16:00<br>
                        <strong>Pazar:</strong> Kapalı<br>
                        <small style="color: var(--gray-500);">Gürcistan saati ile (GMT+4)</small>
                    </p>
                </div>
            </div>
            
            <!-- İletişim Formu -->
            <div>
                <h3 style="margin-bottom: 30px; color: var(--text-dark);">Hızlı İletişim Formu</h3>
                
                <form id="contact-form" action="https://formspree.io/f/xblnkkgo" method="POST" 
      style="background: var(--gray-50); padding: 32px; border-radius: 16px; border: 1px solid var(--gray-200);">
    
    <!-- Hidden Input - Formspree için -->
    <input type="hidden" name="_subject" value="ParenaTrade - Yeni İletişim Formu">
    <input type="hidden" name="_language" value="tr">
    
    <!-- Ad Soyad -->
    <div style="margin-bottom: 24px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark); font-size: 14px;">
            Ad Soyad *
        </label>
        <input type="text" name="name" required 
               style="width: 100%; padding: 12px 16px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;"
               placeholder="Adınız ve soyadınız">
    </div>
    
    <!-- Email -->
    <div style="margin-bottom: 24px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark); font-size: 14px;">
            E-posta Adresi *
        </label>
        <input type="email" name="email" required 
               style="width: 100%; padding: 12px 16px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;"
               placeholder="ornek@email.com">
    </div>
    
    <!-- Telefon -->
    <div style="margin-bottom: 24px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark); font-size: 14px;">
            Telefon Numarası
        </label>
        <input type="tel" name="phone"
               style="width: 100%; padding: 12px 16px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;"
               placeholder="+90 (5__) ___ __ __">
    </div>
    
    <!-- Konu -->
    <div style="margin-bottom: 24px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark); font-size: 14px;">
            İlgilendiğiniz Konu *
        </label>
        <select name="subject" required 
                style="width: 100%; padding: 12px 16px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; background: white;">
            <option value="">Konu seçin</option>
            <option value="investment">Gürcistan'da Yatırım</option>
            <option value="company">Şirket Kuruluşu</option>
            <option value="finance">Finansman ve Kredi</option>
            <option value="tax">Vergi Danışmanlığı</option>
            <option value="freezone">Serbest Bölge</option>
            <option value="other">Diğer</option>
        </select>
    </div>
    
    <!-- Mesaj -->
    <div style="margin-bottom: 32px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark); font-size: 14px;">
            Mesajınız *
        </label>
        <textarea name="message" required rows="5"
                  style="width: 100%; padding: 12px 16px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; resize: vertical;"
                  placeholder="Gürcistan'daki yatırım planlarınız hakkında bilgi verin..."></textarea>
    </div>
    
    <!-- Gönder Butonu -->
    <button type="submit" 
            style="width: 100%; padding: 14px; background: linear-gradient(135deg, var(--primary-orange), var(--secondary-red)); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 15px; cursor: pointer;">
        <svg width="18" height="18" fill="currentColor" viewBox="0 0 20 20" style="vertical-align: middle; margin-right: 8px;">
            <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
        Mesajı Gönder
    </button>
</form>

<!-- Başarı Mesajı -->
<div id="form-success" style="display: none; margin-top: 20px; padding: 20px; background: #dcfce7; border-radius: 12px; border: 1px solid #86efac;">
    <div style="display: flex; align-items: center; gap: 12px;">
        <div style="width: 40px; height: 40px; background: #059669; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <svg width="20" height="20" fill="white" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
        </div>
        <div>
            <h4 style="color: #065f46; margin-bottom: 4px;">Mesajınız Gönderildi!</h4>
            <p style="color: #065f46; font-size: 14px;">En kısa sürede sizinle iletişime geçeceğiz.</p>
        </div>
    </div>
</div>
</section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <div class="footer-logo-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                    ParenaTrade
                </div>
                <p>Gürcistan Yatırım ve Pazar Analiz Platformu</p>
                <p>AI destekli analizler, serbest bölge danışmanlığı, yatırım rehberliği</p>
                
                <div class="footer-disclaimer">
                    <p>Gürcistan'da yatırım danışmanlığı ve pazar analiz hizmetleri</p>
                    <p style="margin-top: 8px;">© 2024 ParenaTrade. Tüm hakları saklıdır.</p>
                </div>
            </div>
        </div>
    </footer>

<script>
// Formspree gönderim sonrası yönlendirme
document.getElementById('contact-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form);
    
    try {
        // Butonu devre dışı bırak
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Gönderiliyor...';
        
        // Formspree'ye gönder
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'Accept': 'application/json'
            }
        });
        
        if (response.ok) {
            // Formu gizle
            form.style.display = 'none';
            
            // Başarı mesajını göster
            document.getElementById('form-success').style.display = 'block';
            
            // Formu resetle (5 saniye sonra)
            setTimeout(function() {
                form.style.display = 'block';
                document.getElementById('form-success').style.display = 'none';
                form.reset();
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg width="18" height="18" fill="currentColor" viewBox="0 0 20 20" style="vertical-align: middle; margin-right: 8px;"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"/></svg> Mesajı Gönder';
            }, 5000);
        } else {
            alert('Bir hata oluştu. Lütfen tekrar deneyin.');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<svg width="18" height="18" fill="currentColor" viewBox="0 0 20 20" style="vertical-align: middle; margin-right: 8px;"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"/></svg> Mesajı Gönder';
        }
    } catch (error) {
        alert('Bağlantı hatası. Lütfen internet bağlantınızı kontrol edin.');
        console.error(error);
    }
});
        
        // Basit interaktif özellikler için ek kodlar
        document.addEventListener('DOMContentLoaded', function() {
            // Harita marker'larına tıklama
            document.querySelectorAll('.city-marker').forEach(marker => {
                marker.addEventListener('click', function() {
                    const cityName = this.classList[1]; // tbilisi, batumi, etc.
                    alert(cityName + ' bölgesi hakkında daha fazla bilgi için AI analiz başlatın!');
                });
            });
            
            // Rapor butonları
            document.querySelectorAll('.report-card .btn').forEach(button => {
                button.addEventListener('click', function() {
                    const reportTitle = this.closest('.report-card').querySelector('h3').textContent;
                    alert(reportTitle + ' raporu için AI analiz başlatılıyor...');
                    document.getElementById('analysis').scrollIntoView({ behavior: 'smooth' });
                });
            });
        });
 
        // Supabase bağlantısı
        const supabaseUrl = "https://xliutvspwodhoaxvysks.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsaXV0dnNwd29kaG9heHZ5c2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTgyOTksImV4cCI6MjA3MjkzNDI5OX0.Zodisa_ifP8t2Q4X0ecnB56RiR_Bg4QS5gvPn5ZLK_w";
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Global değişkenler
        let aiReportTemplates = [];
        let selectedTemplate = null;
        let formData = {};
        let serviceCart = [];
        let currentService = null;
        let currentQuestionIndex = 0;
        let companyProfile = {};
        let serviceQuestions = [];
        let isInitialized = false;
        let activeAccordion = null;


// Değişken çıkarma fonksiyonunu güncelle
function extractVariables(prompt) {
    if (!prompt || typeof prompt !== 'string') {
        console.warn('⚠️ Geçersiz prompt:', prompt);
        return [];
    }
    
    console.log('🔍 Prompt analiz ediliyor:', prompt.substring(0, 100) + '...');
    
    const regexPatterns = [
        /\{\{(\w+)\}\}/g,        // {{degisken}}
        /%(\w+)%/g,              // %degisken%
    ];
    
    const matches = [];
    
    regexPatterns.forEach(pattern => {
        let match;
        while ((match = pattern.exec(prompt)) !== null) {
            // current_year'i filtrele
            if (match[1] !== 'current_year') {
                matches.push(match[1]);
            }
        }
    });
    
    // Firma bazlı rapor için özel değişkenler
    const knownVariables = ['dil', 'ulke', 'sektor', 'urun', 'firma_adi', 'bolge', 'gtip', 'zaman', 'amac', 'derinlik', 'rapor_turu'];
    knownVariables.forEach(variable => {
        if (prompt.includes(variable) && !matches.includes(variable)) {
            matches.push(variable);
        }
    });
    
    const uniqueVariables = [...new Set(matches)];
    console.log('🔍 Çıkarılan değişkenler:', uniqueVariables);
    
    return uniqueVariables;
}
        
// Sepete ekle fonksiyonunu düzelt - DYNAMIC ÇÖZÜM
function addToAICart(item) {
    console.log('➕ Sepete ekleniyor:', item);
    
    // TEMPLATE BULMA - DYNAMIC YAKLAŞIM
    let template = null;
    
    // 1. Önce item içinden template bul
    if (item.template_data) {
        template = item.template_data;
    } 
    // 2. Sonra selectedTemplate'den
    else if (window.selectedTemplate) {
        template = window.selectedTemplate;
    }
    // 3. Sonra global reportTemplates'den ara
    else if (window.reportTemplates && item.id) {
        template = window.reportTemplates.find(t => t.id === item.id);
    }
    // 4. En son item'ın kendisi template olabilir
    else if (item.report_name || item.report_price) {
        template = item;
    }

    console.log('🔍 Bulunan template:', template);

    // FİYAT HESAPLAMA - TEMPLATE ÖNCELİKLİ
    let price = 0;
    if (template && template.report_price !== undefined && template.report_price !== null && !isNaN(parseFloat(template.report_price))) {
        price = parseFloat(template.report_price);
    } else if (item.price !== undefined && item.price !== null && !isNaN(parseFloat(item.price))) {
        price = parseFloat(item.price);
    } else {
        // Varsayılan fiyatlar - sadece fallback olarak
        const defaultPrices = {
            'Kapsamlı Pazar Raporu': 199,
            'Firma Bazlı Pazar Raporu': 129, 
            'GTIP Bazlı Ticaret Raporu': 159
        };
        price = defaultPrices[item.name] || defaultPrices[item.report_name] || defaultPrices[template?.report_name] || 99;
    }

    // PARA BİRİMİ - TEMPLATE ÖNCELİKLİ
    let currency = 'USD';
    if (template && template.report_currency) {
        currency = template.report_currency;
    } else if (item.currency && item.currency !== 'undefined') {
        currency = item.currency;
    }

    // İSİM - TEMPLATE ÖNCELİKLİ
    let name = 'İsimsiz Ürün';
    if (template && template.report_name) {
        name = template.report_name;
    } else if (item.name && item.name !== 'undefined') {
        name = item.name;
    }

    // ID - TEMPLATE ÖNCELİKLİ
    let id = '';
    if (template && template.id) {
        id = template.id;
    } else if (item.id && item.id !== 'undefined') {
        id = item.id;
    } else {
        id = 'unknown_' + Date.now();
    }

    const validatedItem = {
        id: id,
        name: name,
        price: price,
        currency: currency,
        type: item.type || 'report',
        quantity: parseInt(item.quantity) || 1,
        profile: item.profile || null,
        service_type: item.service_type || null,
        reportId: item.reportId || null,
        template_data: template, // Template verisini sakla
        created_at: item.created_at || new Date().toISOString()
    };

    console.log('✅ Doğrulanmış öğe:', validatedItem);
    
    // Çift eklemeyi önle
    const existingIndex = serviceCart.findIndex(cartItem => 
        cartItem.id === validatedItem.id && cartItem.type === validatedItem.type
    );
    
    if (existingIndex === -1) {
        serviceCart.push(validatedItem);
    } else {
        serviceCart[existingIndex] = validatedItem;
    }
    
    updateAICart();
}

function updateAICart() {
    console.log('🛒 Sepet güncelleniyor:', serviceCart);
    
    const cartItems = document.getElementById('ai-report-cart-items');
    const cartTotal = document.getElementById('ai-report-cart-total');
    const completeBtn = document.getElementById('complete-ai-report-order');

    if (!cartItems) {
        console.error('❌ Sepet elementi bulunamadı');
        return;
    }

    if (serviceCart.length === 0) {
        cartItems.innerHTML = '<p class="text-gray-500 text-center py-4">Sepetinizde ürün bulunmamaktadır</p>';
        if (cartTotal) cartTotal.textContent = '0 USD';
        if (completeBtn) completeBtn.disabled = true;
        return;
    }

    let cartHTML = '';
    let total = 0;

    serviceCart.forEach((item, index) => {
        // GÜVENLİ DEĞER ALMA
        const itemName = item.name || 'İsimsiz Ürün';
        const itemPrice = parseFloat(item.price) || 0;
        const itemCurrency = item.currency || 'USD';
        const itemQuantity = parseInt(item.quantity) || 1;
        
        const itemTotal = itemPrice * itemQuantity;
        total += itemTotal;

        const isService = item.type === 'service';
        
        cartHTML += `
            <div class="cart-item border-b border-gray-200 pb-4 mb-4">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800">${itemName}</h4>
                        <p class="text-gray-600 text-sm mt-1">
                            ${itemPrice} ${itemCurrency} 
                        </p>
                        ${isService ? `
                            <p class="text-blue-600 text-xs mt-1">
                                <i class="fas fa-cog mr-1"></i>Hizmet
                            </p>
                        ` : `
                            <p class="text-green-600 text-xs mt-1">
                                <i class="fas fa-file-pdf mr-1"></i>Rapor
                            </p>
                        `}
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-bold text-gray-900">${itemTotal.toFixed(2)} ${itemCurrency}</span>
                        <button class="text-red-500 remove-ai-item hover:text-red-700 transition duration-200" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                ${isService && item.profile ? `
                    <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-100">
                        <strong class="text-blue-800 text-sm">Toplanan Bilgiler:</strong>
                        <div class="mt-2 space-y-1">
                            ${Object.entries(item.profile).map(([question, answer]) => 
                                `<div class="text-xs text-blue-700">• ${question}: ${answer}</div>`
                            ).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    });

    cartItems.innerHTML = cartHTML;
    
    // TOPLAM GÖSTERİMİ - GÜVENLİ
    const displayTotal = isNaN(total) ? 0 : total;
    const displayCurrency = serviceCart[0]?.currency || 'USD';
    
    if (cartTotal) cartTotal.textContent = `${displayTotal.toFixed(2)} ${displayCurrency}`;
    if (completeBtn) completeBtn.disabled = false;

    // Kaldırma butonları
    document.querySelectorAll('.remove-ai-item').forEach(button => {
        button.addEventListener('click', function() {
            const itemIndex = parseInt(this.getAttribute('data-index'));
            if (!isNaN(itemIndex) && itemIndex >= 0 && itemIndex < serviceCart.length) {
                serviceCart.splice(itemIndex, 1);
                updateAICart();
            }
        });
    });
}


        
// ÖNCE: Tüm yardımcı fonksiyonları tanımla
// ==============================================

// Hata modal'ı göster
function showErrorModal(title, message) {
    // Modal HTML'i
    const errorHTML = `
        <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <div class="flex items-center mb-4">
                    <div class="bg-red-100 p-3 rounded-full mr-4">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-red-700">${title}</h3>
                </div>
                <div class="mb-6">
                    <div class="prose prose-sm max-w-none">
                        ${message}
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeErrorModal()" class="bg-gray-300 text-gray-700 font-semibold px-4 py-2 rounded-lg hover:bg-gray-400 transition duration-300">
                        Kapat
                    </button>
                    <button onclick="contactSupport()" class="bg-red-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-700 transition duration-300">
                        Destek Al
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Eğer zaten bir hata modal'ı varsa kaldır
    const existingModal = document.getElementById('error-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Yeni modal'ı ekle
    document.body.insertAdjacentHTML('beforeend', errorHTML);
}

// Hata modal'ını kapat
function closeErrorModal() {
    const errorModal = document.getElementById('error-modal');
    if (errorModal) {
        errorModal.remove();
    }
}       

// Destek butonu fonksiyonu
function contactSupport() {
    window.location.href = 'mailto:info@parenatrade.com?subject=ParenaTrade Destek&body=Merhaba, AI rapor servisi ile ilgili yardıma ihtiyacım var.';
}
        
async function testAPIEndpoint() {
    try {
        console.log('🧪 API test ediliyor...');
        
        // Sadece HEAD isteği gönder - daha hızlı
        const response = await fetch('https://parenatrade.vercel.app/api/generate-report', {
            method: 'HEAD',
            signal: AbortSignal.timeout(3000) // 3 saniye
        });
        
        console.log('📡 API erişilebilir');
        return true;
        
    } catch (error) {
        if (error.name === 'AbortError') {
            console.log('⏰ API timeout (3s)');
        } else {
            console.log('❌ API erişilemiyor:', error.message);
        }
        return false;
    }
}
        
// API durumuna göre uyarı göster
async function showAPIStatusAlert() {
    const apiStatus = await testAPIEndpoint();
    
    if (!apiStatus) {
        // Sadece bir kere göster (spam'ı önle)
        if (!localStorage.getItem('api_alert_shown')) {
            setTimeout(() => {
                showErrorModal(
                    'AI Servisi Geçici Olarak Kullanılamıyor',
                    'AI rapor oluşturma servisi şu an teknik bir sorun nedeniyle kullanılamıyor.<br><br>' +
                    '• Lütfen birkaç dakika sonra tekrar deneyin<br>' +
                    '• Rapor oluşturma butonuna tıkladığınızda bu uyarıyı tekrar göreceksiniz<br>' +
                    '• Acil ihtiyaçlarınız için: info@parenatrade.com<br><br>' +
                    '<small>Bu mesaj sadece bir kere gösterilecektir.</small>'
                );
                localStorage.setItem('api_alert_shown', 'true');
            }, 2000);
        }
    } else {
        console.log('✅ API çalışıyor, normal işleme devam');
        // Çalışıyorsa alert kaydını temizle
        localStorage.removeItem('api_alert_shown');
    }
    
    return apiStatus;
}

        
// API uyarı sistemini iyileştir
function setupReportWarning() {
    const generateBtn = document.getElementById('generate-report-btn');
    if (generateBtn && !document.getElementById('api-warning')) {
        generateBtn.insertAdjacentHTML('beforebegin', `
            <div id="api-warning" class="bg-orange-50 border border-orange-200 rounded-lg p-3 mb-4">
                <div class="flex items-center">
                    <i class="fas fa-sync-alt text-orange-600 mr-2 animate-spin"></i>
                    <span class="text-orange-800 text-sm">
                        <strong>Servis Kontrolü:</strong> AI servisi test ediliyor...
                    </span>
                </div>
            </div>
        `);
        
        // API durumunu kontrol et ve uyarıyı güncelle
        setTimeout(async () => {
            const apiStatus = await checkAPIStatus();
            const warningElement = document.getElementById('api-warning');
            
            if (warningElement) {
                if (apiStatus) {
                    warningElement.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-600 mr-2"></i>
                            <span class="text-green-800 text-sm">
                                <strong>Servis Hazır:</strong> AI rapor oluşturma aktif
                            </span>
                        </div>
                    `;
                    warningElement.className = 'bg-green-50 border border-green-200 rounded-lg p-3 mb-4';
                } else {
                    warningElement.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                            <span class="text-red-800 text-sm">
                                <strong>Servis Bakımda:</strong> AI servisi geçici olarak kullanılamıyor
                            </span>
                        </div>
                    `;
                    warningElement.className = 'bg-red-50 border border-red-200 rounded-lg p-3 mb-4';
                }
            }
        }, 1000);
    }
}

// Eksik fonksiyonları ekleyelim
async function checkAPIStatus() {
    return await testAPIEndpoint();
}
        
// Rapor butonunu kur - hata düzeltmeli
function setupReportButton() {
    const generateBtn = document.getElementById('generate-report-btn');
    if (generateBtn) {
        // Butonun orijinal halini sakla
        if (!generateBtn.dataset.originalText) {
            generateBtn.dataset.originalText = generateBtn.innerHTML;
        }
        
        // API durumunu kontrol et ve butonu ayarla
        checkAPIStatus().then(apiStatus => {
            if (!apiStatus) {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i> Servis Bakımda';
                generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
                generateBtn.title = 'AI servisi şu an kullanılamıyor. Lütfen daha sonra tekrar deneyin.';
            } else {
                generateBtn.disabled = false;
                generateBtn.innerHTML = generateBtn.dataset.originalText;
                generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                generateBtn.title = 'AI raporu oluştur';
            }
        }).catch(error => {
            console.error('API kontrol hatası:', error);
            // Hata durumunda butonu devre dışı bırak
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i> Servis Kontrol Edilemiyor';
            generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
        });
    }
}
        
// Debug fonksiyonlarını basitleştirelim
async function debugServiceTypes() {
    try {
        const { data: services, error } = await supabase
            .from('ai_service_type')
            .select('id, service_name')
            .limit(3);
        
        if (!error && services) {
            console.log('🔍 ai_service_type tablosu:', services);
        }
    } catch (error) {
        console.error('Debug hatası:', error);
    }
}

async function debugServiceMatching() {
    try {
        const { data: questions, error } = await supabase
            .from('ai_question')
            .select('id, question, service_type_id, service_type')
            .limit(5);
            
        if (!error && questions) {
            console.log('🔍 ai_question tablosu:', questions);
        }
    } catch (error) {
        console.error('Debug hatası:', error);
    }
}

        
        // Modal İşlevselliği
function setupModalFunctionality() {
    // Modal kapatma
    const closeServiceModal = document.getElementById('close-service-modal');
    const cancelServiceOrder = document.getElementById('cancel-service-order');
    const submitServiceOrder = document.getElementById('submit-service-order');
    const closeConfirmation = document.getElementById('close-confirmation');

    if (closeServiceModal) {
        closeServiceModal.addEventListener('click', closeModal);
    }
    
    if (cancelServiceOrder) {
        cancelServiceOrder.addEventListener('click', closeModal);
    }

    // Sipariş gönderme
    if (submitServiceOrder) {
        submitServiceOrder.addEventListener('click', function() {
            // Burada ödeme sayfasına yönlendirme yapılacak
            window.location.href = 'https://parenatrade.vercel.app/ai/login.html';
        });
    }

    // Onay kapatma
    if (closeConfirmation) {
        closeConfirmation.addEventListener('click', closeModal);
    }
}

function closeModal() {
    const modal = document.getElementById('service-order-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Ana uygulama başlatma - FORM DATA INITIALIZATION EKLENDİ
// Ayrıca, initializeApp fonksiyonunu da güvenli hale getirelim:
async function initializeApp() {
    if (isInitialized) {
        console.log('ℹ️ Uygulama zaten başlatılmış');
        return;
    }
    isInitialized = true;
    
    try {
        console.log('🔧 Temel sistemler başlatılıyor...');
        
        // 0. ÖNCE CRITICAL GLOBAL DEĞİŞKENLERİ INITIALIZE ET
        initializeGlobalVariables();
        
        // 1. ÖNCE verileri yükle
        console.log('📥 Veriler yükleniyor...');
        await loadDropdownData();
        await loadServiceTypesSimple();
        await loadReportTemplates();
        
        // 2. SONRA UI bileşenlerini kur (elementlerin yüklendiğinden emin ol)
        console.log('🎨 UI bileşenleri kuruluyor...');
        
        // Önce elementlerin yüklendiğinden emin ol
        await waitForElement('#service-select');
        await waitForElement('#report-template-select');
        
        setupCompanyAnalysisChat();
        setupQuickReportForm();
        setupCartFunctionality();
        setupModalFunctionality();
        
        // 3. FORM ALANLARI OLUŞTUKTAN SONRA listener'ları kur
        console.log('🔧 Event listenerlar kuruluyor...');
        setTimeout(() => {
            setupAccordionListeners();
            setupFieldEventListeners();
        }, 500);
        
        // 4. Diğer sistemler
        initializeAuthSystem();
        setupProfileTabs();
        setupReportWarning();
        setupReportButton();
        checkChatSession();
        
        console.log('✅ ParenaTrade uygulaması başarıyla başlatıldı');
        
    } catch (error) {
        console.error('❌ Uygulama başlatma hatası:', error);
        // Hata durumunda kritik olmayan işlemleri yapmaya devam et
        try {
            initializeAuthSystem();
            setupProfileTabs();
        } catch (e) {
            console.error('İkincil sistemlerde hata:', e);
        }
    }
}

// Yardımcı fonksiyon: Element yüklenmesini bekle
function waitForElement(selector, timeout = 5000) {
    return new Promise((resolve, reject) => {
        const startTime = Date.now();
        
        function checkElement() {
            const element = document.querySelector(selector);
            if (element) {
                console.log(`✅ Element bulundu: ${selector}`);
                resolve(element);
            } else if (Date.now() - startTime >= timeout) {
                console.warn(`⚠️ Element bulunamadı: ${selector} (timeout)`);
                resolve(null);
            } else {
                setTimeout(checkElement, 100);
            }
        }
        
        checkElement();
    });
}

// DOMContentLoaded event listener'ını da güvenli hale getirelim:
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 ParenaTrade - Uygulama başlatılıyor...');
    
    // ÖNCE global değişkenleri initialize et
    initializeGlobalVariables();
    
    // Ana uygulamayı başlat (hata yakalama ile)
    try {
        initializeApp();
    } catch (error) {
        console.error('❌ Ana uygulama başlatma hatası:', error);
    }
    
    // Debug ve kontrol işlemleri - sıralı ve gecikmeli
    const debugTasks = [
        { fn: checkTableStatus, delay: 500, name: 'Tablo durumu' },
        { fn: debugServiceTypes, delay: 1000, name: 'Servis tipleri' },
        { fn: debugServiceMatching, delay: 1500, name: 'Servis eşleşmesi' },
        { fn: checkSystemStatus, delay: 2000, name: 'Sistem durumu' },
        { 
            fn: () => checkAPIStatus().then(status => {
                if (!status) {
                    console.warn('⚠️ API servisi kullanılamıyor');
                } else {
                    console.log('✅ API servisi çalışıyor');
                }
            }), 
            delay: 2500, 
            name: 'API durumu' 
        }
    ];
    
    debugTasks.forEach(task => {
        setTimeout(() => {
            try {
                console.log(`🔍 ${task.name} kontrolü...`);
                task.fn();
            } catch (e) {
                console.error(`${task.name} kontrol hatası:`, e);
            }
        }, task.delay);
    });
    
    // EXTRA: Sayfa yüklendikten sonra formData kontrolü
    setTimeout(() => {
        console.log('🔍 Final FormData Check:', {
            formData: window.formData,
            formDataType: typeof window.formData,
            selectedTemplate: window.selectedTemplate,
            serviceCart: window.serviceCart
        });
    }, 3000);
});

// Double initialization koruması
if (window.parenaTradeInitialized) {
    console.log('ℹ️ ParenaTrade zaten yüklenmiş');
} else {
    window.parenaTradeInitialized = true;
}

// GLOBAL DEĞİŞKENLERİ INITIALIZE ET
function initializeGlobalVariables() {
    console.log('🔧 Global değişkenler initialize ediliyor...');
    
    // FORM DATA - CRITICAL
    if (!window.formData || typeof window.formData !== 'object') {
        window.formData = {};
        console.log('✅ window.formData initialized:', window.formData);
    }
    
    // SELECTED TEMPLATE
    if (!window.selectedTemplate) {
        window.selectedTemplate = null;
        console.log('✅ window.selectedTemplate initialized');
    }
    
    // SERVICE CART
    if (!window.serviceCart || !Array.isArray(window.serviceCart)) {
        window.serviceCart = [];
        console.log('✅ window.serviceCart initialized:', window.serviceCart);
    }
    
    // CURRENT USER
    if (!window.currentUser) {
        window.currentUser = null;
        console.log('✅ window.currentUser initialized');
    }
    
    // REPORT TEMPLATES
    if (!window.reportTemplates) {
        window.reportTemplates = [];
        console.log('✅ window.reportTemplates initialized');
    }
    
    console.log('🎯 Global değişkenler başarıyla initialize edildi');
}

// FORM DATA INITIALIZATION İÇİN EXTRA GÜVENLİK
function initializeFormData() {
    // Mevcut formData'yı koru, yoksa oluştur
    if (!window.formData || typeof window.formData !== 'object') {
        window.formData = {};
    }
    
    // Required fields için default değerler
    const defaultFields = ['ulke', 'sektor', 'urun', 'dil', 'bolge', 'gtip', 'zaman', 'amac', 'derinlik'];
    
    defaultFields.forEach(field => {
        if (window.formData[field] === undefined) {
            window.formData[field] = '';
        }
    });
    
    console.log('✅ FormData güvenli initialize edildi:', window.formData);
    return window.formData;
}

function setupQuickReportForm() {
    const templateSelect = document.getElementById('report-template-select');
    const generateBtn = document.getElementById('generate-report-btn');
    
    if (!templateSelect) {
        console.error('❌ Template select bulunamadı');
        return;
    }
    
    // Template select'i boşsa, doldurmayı dene
    if (templateSelect.options.length <= 1 && window.reportTemplates && window.reportTemplates.length > 0) {
        console.log('🔄 Template select dolduruluyor...');
        templateSelect.innerHTML = '<option value="">Rapor türü seçin</option>';
        
        window.reportTemplates.forEach(template => {
            const option = document.createElement('option');
            option.value = template.id;
            option.textContent = `${template.report_name} - $${template.report_price || 0} ${template.report_currency || 'USD'}`;
            option.setAttribute('data-description', template.report_description);
            templateSelect.appendChild(option);
        });
    }
    
    // Template değişim event'i
    templateSelect.addEventListener('change', function() {
        const templateId = this.value;
        console.log('🎯 Seçilen template:', templateId);
        
        if (!templateId) {
            // Temizleme
            window.selectedTemplate = null;
            const dynamicForm = document.getElementById('dynamic-form-fields');
            const criteriaList = document.getElementById('criteria-list');
            if (dynamicForm) dynamicForm.classList.add('hidden');
            if (criteriaList) criteriaList.classList.add('hidden');
            if (generateBtn) generateBtn.classList.add('hidden');
            return;
        }
        
        // Global selectedTemplate'i güncelle
        window.selectedTemplate = window.reportTemplates?.find(t => t.id === templateId);
        console.log('🎯 Global selectedTemplate güncellendi:', window.selectedTemplate);
        
        if (window.selectedTemplate) {
            console.log('📊 Seçilen rapor:', window.selectedTemplate.report_name);
            
            // Template açıklamasını göster
            const descriptionElement = document.getElementById('template-description');
            if (descriptionElement && window.selectedTemplate.report_description) {
                descriptionElement.textContent = window.selectedTemplate.report_description;
                descriptionElement.classList.remove('hidden');
            }
            
            // FormData'yı temizle ve yeniden başlat
            initializeFormData();
            
            // Değişkenleri çıkar ve form oluştur
            const variables = extractVariables(window.selectedTemplate.report_prompt);
            createDynamicFormFields(variables);
            
            // Butonu göster
            if (generateBtn) {
                generateBtn.classList.remove('hidden');
                // Event listener'ı temizle ve yeniden ekle
                generateBtn.onclick = null;
                generateBtn.addEventListener('click', generateAIReport);
            }
            
        } else {
            console.error('❌ Template bulunamadı:', templateId);
        }
    });
    
    // Generate butonuna event listener ekle
    if (generateBtn) {
        generateBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Son formData kontrolü
            if (!window.formData) {
                initializeFormData();
            }
            
            generateAIReport();
        });
    }
    
    console.log('✅ Quick report form kuruldu');
}
// Tüm başlatma işlemleri tek bir DOMContentLoaded içinde
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 ParenaTrade - Uygulama başlatılıyor...');
    
    // ÖNCE global değişkenleri initialize et
    initializeGlobalVariables();
    
    // Ana uygulamayı başlat
    initializeApp();
    
    // Debug ve kontrol işlemleri - sıralı ve gecikmeli
    setTimeout(() => {
        checkTableStatus();
    }, 500);
    
    setTimeout(() => {
        debugServiceTypes();
    }, 1000);
    
    setTimeout(() => {
        debugServiceMatching();
    }, 1500);
    
    setTimeout(() => {
        checkSystemStatus();
    }, 2000);
    
    // API durum kontrolü
    setTimeout(() => {
        checkAPIStatus().then(status => {
            if (!status) {
                console.warn('⚠️ API servisi kullanılamıyor');
                // API uyarısını göster
                const apiWarning = document.getElementById('api-warning');
                if (apiWarning) {
                    apiWarning.classList.remove('hidden');
                }
            } else {
                console.log('✅ API servisi çalışıyor');
            }
        });
    }, 2500);
    
    // EXTRA: Sayfa yüklendikten sonra formData kontrolü
    setTimeout(() => {
        console.log('🔍 Final FormData Check:', {
            formData: window.formData,
            formDataType: typeof window.formData,
            selectedTemplate: window.selectedTemplate,
            serviceCart: window.serviceCart
        });
    }, 3000);
});

// ACİL DÜZELTME - Konsolda çalıştırılabilir
function emergencyFormDataFix() {
    console.log('🔄 Acil FormData düzeltmesi uygulanıyor...');
    
    window.formData = {};
    window.selectedTemplate = window.selectedTemplate || null;
    window.serviceCart = window.serviceCart || [];
    
    console.log('✅ Acil düzeltme tamamlandı:', {
        formData: window.formData,
        selectedTemplate: window.selectedTemplate,
        serviceCart: window.serviceCart
    });
    
    return 'FormData başarıyla initialize edildi!';
}

// Konsolda test için
function testFormData() {
    console.log('🧪 FormData Test:');
    console.log('- formData:', window.formData);
    console.log('- selectedTemplate:', window.selectedTemplate);
    console.log('- serviceCart:', window.serviceCart);
    console.log('- reportTemplates:', window.reportTemplates);
    
    if (!window.formData || typeof window.formData !== 'object') {
        console.log('❌ FormData hatalı! emergencyFormDataFix() çalıştırın.');
        return false;
    }
    
    console.log('✅ FormData testi başarılı!');
    return true;
}
    

        
// Sistem durumunu kontrol et - GÜNCELLENMİŞ
async function checkSystemStatus() {
    console.log('=== 🔍 SİSTEM DURUM KONTROLÜ ===');
    
    try {
        // 1. Service types kontrolü
        const { data: services, error: servicesError } = await supabase
            .from('ai_service_type')
            .select('id, service_name')
            .limit(5);
        
        console.log('📋 Service Types:', servicesError ? '❌ HATA' : `✅ ${services?.length} hizmet`);
        
        // 2. Questions kontrolü  
        const { data: questions, error: questionsError } = await supabase
            .from('ai_question')
            .select('id, question, service_type_id, service_type')
            .limit(5);
            
        console.log('📝 Questions:', questionsError ? '❌ HATA' : `✅ ${questions?.length} soru`);
        
        // 3. Tablo yapısı
        await detectTableStructure();
        
        console.log('✅ Sistem durumu: STABIL');
        
    } catch (error) {
        console.error('❌ Sistem kontrol hatası:', error);
    }
}

// Basit tablo yapısı kontrolü
async function detectTableStructure() {
    try {
        console.log('🔍 Tablo yapısı kontrol ediliyor...');
        
        // Basit bir test sorgusu
        const { data, error } = await supabase
            .from('ai_question')
            .select('service_type_id, service_type')
            .limit(1);
        
        if (error) {
            console.warn('Tablo yapısı kontrol edilemedi:', error);
            return 'service_type';
        }
        
        return 'service_type_id'; // Varsayılan olarak service_type_id kullan
        
    } catch (error) {
        console.error('Tablo yapısı kontrol hatası:', error);
        return 'service_type';
    }
}        

// Tablo durumunu kontrol et - GÜNCELLENMİŞ
async function checkTableStatus() {
    try {
        console.log('=== 📊 TABLO DURUM KONTROLÜ ===');
        
        // 1. ai_service_type kontrolü
        const { data: services, count: serviceCount, error: serviceError } = await supabase
            .from('ai_service_type')
            .select('*', { count: 'exact' });
        
        console.log('📋 ai_service_type:');
        console.log('- Count:', serviceCount);
        console.log('- Error:', serviceError);
        console.log('- Status:', serviceError ? '❌' : '✅');
        
        // 2. ai_question kontrolü
        const { data: questions, count: questionCount, error: questionError } = await supabase
            .from('ai_question')
            .select('*', { count: 'exact' })
            .limit(5);
            
        console.log('📝 ai_question:');
        console.log('- Count:', questionCount);
        console.log('- Error:', questionError);
        console.log('- Status:', questionError ? '❌' : '✅');
        
        // 3. Eşleşme kontrolü
        if (services && questions) {
            const serviceIds = services.map(s => s.id);
            const matchingQuestions = questions.filter(q => 
                serviceIds.includes(q.service_type_id)
            );
            console.log('🔗 Eşleşen sorular:', matchingQuestions.length);
        }
        
    } catch (error) {
        console.error('❌ Tablo kontrol hatası:', error);
    }
}

// Çift yüklenmeyi önlemek için global kontrol
if (window.parenaTradeInitialized) {
    console.log('ℹ️ ParenaTrade zaten yüklenmiş');
} else {
    window.parenaTradeInitialized = true;
    // Yukarıdaki tek DOMContentLoaded listener burada olacak
}            
                
        // Global değişken - veri yüklendi mi takip et
        let serviceTypesLoaded = false;

        // En basit ve güvenli yöntem
        async function loadServiceTypesSimple() {
            try {
                console.log('🔍 Hizmet türleri yükleniyor...');
                
                const { data, error } = await supabase
                    .from('ai_service_type')
                    .select('id, service_name, sort_code')
                    .order('sort_code');
                
                if (error) throw error;
                
                // EN BASİT YOL: data varsa işle
                if (!data || data.length === 0) {
                    console.error('❌ Tablo boş');
                    return false;
                }
                
                const serviceSelect = document.getElementById('service-select');
                serviceSelect.innerHTML = '<option value="">Hizmet seçin</option>';
                
                data.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.id;
                    option.textContent = service.service_name;
                    serviceSelect.appendChild(option);
                });
                
                console.log(`✅ ${data.length} hizmet türü yüklendi`);
                return true;
                
            } catch (error) {
                console.error('❌ Hizmet türleri yüklenirken hata:', error);
                return false;
            }
        }
                
        // 2. SELECT DEĞİŞİMİ için - farklı fonksiyon
        async function handleServiceQuestions(selectedServiceId) {
            try {
                console.log('🔍 Sorular yükleniyor, serviceId:', selectedServiceId);
                
                if (!selectedServiceId) {
                    throw new Error('Geçersiz service ID');
                }
                
                // Konsola göre: hem service_type_id HEM service_type var
                // service_type_id: UUID (f3c8c3b7-5cd9-4579-b26d-3b757334fc3b)
                // service_type: string ('hedef_ulke_rapor')
                
                let query = supabase
                    .from('ai_question')
                    .select('id, question, flow_number, service_type_id, service_type')
                    .eq('is_active', true)
                    .order('flow_number');
                
                // ÖNCE: UUID ile eşleştirmeyi dene (gerçek ID)
                query = query.eq('service_type_id', selectedServiceId);
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    serviceQuestions = data;
                    console.log(`✅ ${data.length} soru yüklendi (UUID eşleşmesi)`);
                    return data;
                }
                
                // Eğer UUID ile eşleşme yoksa, FALLBACK ID'ler için string eşleştirme yap
                console.log('UUID eşleşmesi bulunamadı, fallback deneniyor...');
                
                const fallbackQuery = supabase
                    .from('ai_question')
                    .select('id, question, flow_number, service_type_id, service_type')
                    .eq('service_type', selectedServiceId)
                    .eq('is_active', true)
                    .order('flow_number');
                    
                const { data: fallbackData, error: fallbackError } = await fallbackQuery;
                
                if (fallbackError) throw fallbackError;
                
                if (fallbackData && fallbackData.length > 0) {
                    serviceQuestions = fallbackData;
                    console.log(`✅ ${fallbackData.length} soru yüklendi (string eşleşmesi)`);
                    return fallbackData;
                }
                
                throw new Error('Bu hizmet için soru bulunamadı');
                
            } catch (error) {
                console.error('❌ Sorular yüklenemedi:', error);
                throw error;
            }
        }
                
        // Varsayılan hizmet türleri - SADECE GERÇEK İHTİYAÇ DURUMUNDA
        function loadDefaultServices() {
            const serviceSelect = document.getElementById('service-select');
            
            // Sadece boşsa ekle
            if (serviceSelect.children.length > 1) {
                console.log('Fallback: Hizmet türleri zaten var, eklenmedi');
                return;
            }
            
            const defaultServices = [
                { id: 'hedef_ulke_rapor', service_name: 'Hedef Ülke Kapsamlı Rapor' },
                { id: 'firma_kurulus', service_name: 'Firma Kuruluşu' },
                { id: 'banka_hesap', service_name: 'Banka Hesabı Açılışı' },
                { id: 'muhasebe', service_name: 'Muhasebe İşlemleri' },
                { id: 'ihracat_kredileri', service_name: 'İhracat Kredileri' }
            ];
            
            defaultServices.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id;
                option.textContent = service.service_name;
                serviceSelect.appendChild(option);
            });
            
            console.log('⚠️ Fallback hizmet türleri yüklendi');
        }        
  

async function generateAIReport() {
    console.log('🚀 Rapor oluşturma başlatılıyor...');
    
    // Validasyon
    if (!window.selectedTemplate) {
        alert('❌ Lütfen rapor türü seçin.');
        return;
    }
    
    if (!window.formData || typeof window.formData !== 'object') {
        console.error('❌ FormData tanımlı değil:', window.formData);
        alert('❌ Form verileri yüklenemedi. Lütfen sayfayı yenileyin.');
        return;
    }
    
    // Template'e özel validasyon (gtip_required kontrolü)
    if (window.selectedTemplate.gtip_required && 
        (!window.formData.gtip || String(window.formData.gtip).trim() === '')) {
        alert('❌ Bu rapor için GTIP kodu zorunludur. Lütfen GTIP kodu seçin.');
        return;
    }
    
    const requiredFields = ['ulke', 'sektor', 'urun'];
    if (window.selectedTemplate.gtip_required) {
        requiredFields.push('gtip');
    }
    
    const missingFields = [];
    requiredFields.forEach(field => {
        if (!window.formData[field] || String(window.formData[field]).trim() === '') {
            missingFields.push(getFieldTitle(field));
        }
    });
    
    if (missingFields.length > 0) {
        alert(`Lütfen aşağıdaki alanları doldurun:\n${missingFields.join('\n')}`);
        return;
    }
    
    const generateBtn = document.getElementById('generate-report-btn');
    const progressSection = document.getElementById('report-progress');
    
    // UI durumunu güncelle
    if (generateBtn) {
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Oluşturuluyor...';
    }
    if (progressSection) progressSection.classList.remove('hidden');
    updateProgress(20);

    try {
        // 1. Template prompt'unu doldur
        const finalPrompt = await getTemplatePrompt(
            window.selectedTemplate.id, 
            prepareVariables(window.selectedTemplate, window.formData)
        );
        
        console.log('📝 Template promptu hazırlandı, ilk 200 karakter:', finalPrompt.substring(0, 200));
        
        if (!finalPrompt) {
            throw new Error('Prompt oluşturulamadı.');
        }
        
        updateProgress(40);

        // 2. API'ye gönder (GÜNCELLENDİ - YENİ REQUEST BODY)
        console.log('🌐 API çağrısı yapılıyor...');
        
        // API request body'sini hazırla
        const requestBody = {
            prompt: finalPrompt,
            template: window.selectedTemplate.report_name,
            template_code: window.selectedTemplate.report_code, // ✅ YENİ
            parameters: window.formData, // ✅ Tüm form verileri
            sector: window.selectedTemplate.sector_code || window.formData.sektor, // ✅ YENİ
            country: window.formData.ulke || window.selectedTemplate.target_country || 'Gürcistan', // ✅ YENİ
            gtip: window.formData.gtip || '' // ✅ YENİ
        };
        
        console.log('📤 API Request Body:', {
            template_code: requestBody.template_code,
            country: requestBody.country,
            gtip: requestBody.gtip,
            parameters_count: Object.keys(requestBody.parameters).length
        });
        
        const response = await fetch('https://parenatrade.vercel.app/api/generate-report', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-Request-Source': 'parenatrade-web'
            },
            body: JSON.stringify(requestBody) // ✅ YENİ JSON BODY
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`API hatası: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        console.log('📨 API cevabı:', { 
            success: result.success, 
            template_used: result.template_used,
            has_pdf_url: !!result.pdf_url 
        });
        
        if (!result.success) {
            throw new Error(result.error || 'Rapor oluşturulamadı');
        }

        updateProgress(60);

        // 3. SUPABASE'E KAYDET (GÜNCELLENDİ)
        console.log('💾 Supabase\'e kaydediliyor...');
        const reportData = {
            template_id: window.selectedTemplate.id,
            report_title: `${window.selectedTemplate.report_name} - ${window.formData.urun || ''}`,
            report_code: window.selectedTemplate.report_code, // ✅ YENİ
            report_prompt: finalPrompt,
            report_content: result.result,
            country: window.formData.ulke || null,
            sector: window.selectedTemplate.sector_code || window.formData.sektor || null, // ✅ YENİ
            product: window.formData.urun || null,
            region: window.formData.bolge || null,
            gtip: window.formData.gtip || null,
            hs_code: window.formData.gtip || null,
            period: window.formData.zaman || null,
            purpose: window.formData.amac || null,
            language: window.formData.dil || 'tr',
            depth: window.formData.derinlik || null,
            report_type: window.selectedTemplate.report_type,
            status: 'completed',
            user_id: window.currentUser?.id || null,
            report_price: window.selectedTemplate.report_price,
            currency: window.selectedTemplate.report_currency,
            pdf_url: result.pdf_url || null, // ✅ PDF URL'sini ekle
            template_data: window.selectedTemplate, // ✅ Tüm template verisini sakla
            created_at: new Date().toISOString()
        };

        console.log('📊 Kaydedilecek rapor verisi:', {
            report_title: reportData.report_title,
            report_code: reportData.report_code,
            sector: reportData.sector,
            gtip: reportData.gtip
        });

        const { data: report, error } = await supabase
            .from('ai_reports')
            .insert(reportData)
            .select()
            .single();

        if (error) {
            console.error('❌ Supabase kayıt hatası:', error);
            // Hata durumunda bile devam et (kullanıcıya raporu göster)
        } else {
            console.log('✅ Rapor Supabase\'e kaydedildi, ID:', report?.id);
        }

        updateProgress(80);

        // 4. SEPETE EKLE (GÜNCELLENDİ)
        const itemPrice = window.selectedTemplate.report_price !== undefined && 
                         window.selectedTemplate.report_price !== null && 
                         !isNaN(parseFloat(window.selectedTemplate.report_price)) 
            ? parseFloat(window.selectedTemplate.report_price) 
            : 199;

        const cartItem = {
            id: window.selectedTemplate.id,
            name: `${window.selectedTemplate.report_name} - ${window.formData.urun || ''}`,
            price: itemPrice,
            currency: window.selectedTemplate.report_currency || 'USD',
            reportId: report?.id,
            type: 'report',
            template_data: window.selectedTemplate,
            sector: window.selectedTemplate.sector_code,
            gtip: window.formData.gtip,
            pdf_url: result.pdf_url // ✅ PDF linkini sepete de ekle
        };

        console.log('🛒 Sepete eklenecek öğe:', {
            name: cartItem.name,
            price: cartItem.price,
            gtip: cartItem.gtip
        });
        
        addToAICart(cartItem);
        updateProgress(100);

        // 5. Sonuçları göster (GÜNCELLENDİ)
        const quickResult = document.getElementById('quick-analysis-result');
        if (quickResult) {
            quickResult.classList.remove('hidden');
            
            // PDF linkini göster
            if (result.pdf_url) {
                quickResult.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            <h4 class="font-bold text-green-800">Rapor Hazır!</h4>
                        </div>
                        <p class="text-green-700 mb-2">"${window.selectedTemplate.report_name}" raporunuz başarıyla oluşturuldu.</p>
                        <div class="flex space-x-2">
                            ${result.pdf_url ? `
                                <a href="${result.pdf_url}" target="_blank" 
                                   class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition inline-flex items-center">
                                    <i class="fas fa-download mr-1"></i> PDF İndir
                                </a>
                            ` : ''}
                            <button onclick="viewCart()" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700 transition inline-flex items-center">
                                <i class="fas fa-shopping-cart mr-1"></i> Sepeti Görüntüle
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        // Başarı mesajı
        setTimeout(() => {
            if (progressSection) progressSection.classList.add('hidden');
            if (generateBtn) {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-search mr-2"></i> Rapor Oluştur';
            }
            
            console.log('✅ Rapor oluşturma işlemi tamamlandı');
            
        }, 2000);

    } catch (error) {
        console.error('❌ Rapor oluşturma hatası:', error);
        
        // UI'ı eski haline getir
        if (generateBtn) {
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="fas fa-search mr-2"></i> Rapor Oluştur';
        }
        if (progressSection) progressSection.classList.add('hidden');
        
        // Hata mesajını göster
        let errorMessage = 'Rapor oluşturulurken hata: ' + error.message;
        
        if (error.message.includes('API hatası: 405')) {
            errorMessage = 'API endpoint\'i geçici olarak kullanılamıyor. Lütfen daha sonra tekrar deneyin.';
        } else if (error.message.includes('Failed to fetch')) {
            errorMessage = 'İnternet bağlantınızı kontrol edin ve tekrar deneyin.';
        } else if (error.message.includes('GTIP kodu zorunludur')) {
            errorMessage = 'Bu rapor için GTIP kodu zorunludur. Lütfen GTIP kodu seçin.';
        }
        
        showError(errorMessage);
    }
}       


// Değişkenleri hazırla
function prepareVariables(template, formData) {
    return {
        dil: formData.dil || 'Türkçe',
        ulke: formData.ulke || template.target_country || 'Gürcistan',
        sektor: formData.sektor || template.report_category || 'Belirtilmemiş',
        urun: formData.urun || 'Belirtilmemiş',
        bolge: formData.bolge || 'Tüm Bölgeler',
        gtip: formData.gtip || '',
        zaman: formData.zaman || '2020-2025 ve güncel veriler',
        amac: formData.amac || 'pazar analizi ve yatırım değerlendirmesi',
        derinlik: formData.derinlik || 'yatırımcı sunumuna uygun detaylı rapor',
        rapor_turu: template.report_name,
        yatirim_tutari: formData.yatirim_tutari || '',
        yatirim_turu: formData.yatirim_turu || '',
        hedef_musteri: formData.hedef_musteri || ''
    };
}        

// Template prompt'u getir
async function getTemplatePrompt(templateId, variables) {
    try {
        console.log(`🔍 Template promptu aranıyor: ${templateId}`);
        
        // Template'i veritabanından getir
        const { data: template, error } = await supabase
            .from('ai_report_templates')
            .select('report_prompt, report_name, sample_data')
            .eq('id', templateId)
            .single();
        
        if (error) {
            console.error('Template getirme hatası:', error);
            throw new Error('Template bulunamadı');
        }
        
        if (!template || !template.report_prompt) {
            console.error('Template promptu bulunamadı');
            throw new Error('Template promptu bulunamadı');
        }
        
        console.log(`✅ Template bulundu: ${template.report_name}`);
        
        // Prompt'u doldur
        let filledPrompt = template.report_prompt;
        const currentYear = new Date().getFullYear();
        
        // Değişkenleri yerleştir
        Object.entries(variables).forEach(([key, value]) => {
            if (value && value.trim() !== '') {
                const patterns = [
                    `{{${key}}}`,
                    `%${key}%`,
                    `\\[${key}\\]`
                ];
                
                patterns.forEach(pattern => {
                    const regex = new RegExp(pattern, 'g');
                    filledPrompt = filledPrompt.replace(regex, value.trim());
                });
            }
        });
        
        // current_year'i ekle
        filledPrompt = filledPrompt.replace(/\{\{current_year\}\}/g, currentYear);
        filledPrompt = filledPrompt.replace(/\%current_year\%/g, currentYear);
        
        // Sample data ekle
        if (template.sample_data) {
            try {
                const sampleData = JSON.parse(template.sample_data);
                let sampleText = '\n\n**GERÇEK SEKTÖR VERİLERİ (2024):**\n';
                
                Object.entries(sampleData).forEach(([key, value]) => {
                    if (typeof value === 'number') {
                        if (value >= 1000000) {
                            sampleText += `- ${key}: $${(value / 1000000).toFixed(1)}M\n`;
                        } else if (value >= 1000) {
                            sampleText += `- ${key}: $${(value / 1000).toFixed(1)}K\n`;
                        } else {
                            sampleText += `- ${key}: $${value}\n`;
                        }
                    } else {
                        sampleText += `- ${key}: ${value}\n`;
                    }
                });
                
                filledPrompt += sampleText;
            } catch (e) {
                console.error('Sample data parse hatası:', e);
            }
        }
        
        // Eksik değişkenleri temizle
        filledPrompt = filledPrompt.replace(/\{\{\w+\}\}/g, 'Belirtilmemiş');
        filledPrompt = filledPrompt.replace(/\%\w+\%/g, 'Belirtilmemiş');
        
        console.log('✅ Template promptu hazırlandı');
        return filledPrompt;
        
    } catch (error) {
        console.error('❌ Template promptu alınamadı:', error);
        throw error;
    }
}


        
// Rapor şablonlarını yükle - GÜNCELLENDİ
async function loadReportTemplates() {
    try {
        console.log('📊 Rapor şablonları yükleniyor...');
        
        const { data: templates, error } = await supabase
            .from('ai_report_templates')
            .select('*')
            .eq('active', true)
            .order('report_name');
        
        if (error) {
            console.error('❌ Rapor şablonları yüklenemedi:', error);
            return;
        }
        
        if (!templates || templates.length === 0) {
            console.error('❌ Rapor şablonu bulunamadı');
            return;
        }
        
        aiReportTemplates = templates;
        window.reportTemplates = templates;
        
        // Template select'i doldur
        const templateSelect = document.getElementById('report-template-select');
        templateSelect.innerHTML = '<option value="">Rapor türü seçin</option>';
        
        // Sektörlere göre grupla
        const categories = {};
        
        templates.forEach(template => {
            const category = template.report_category || 'genel';
            if (!categories[category]) {
                categories[category] = [];
            }
            categories[category].push(template);
        });
        
        // Her kategori için optgroup oluştur
        Object.entries(categories).forEach(([category, categoryTemplates]) => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = category.toUpperCase();
            
            categoryTemplates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = `${template.report_name} - $${template.report_price} ${template.report_currency}`;
                option.setAttribute('data-category', category);
                option.setAttribute('data-gtip-required', template.gtip_required || false);
                optgroup.appendChild(option);
            });
            
            templateSelect.appendChild(optgroup);
        });
        
        console.log(`✅ ${templates.length} rapor şablonu yüklendi`);
        
        // Paketleri de güncelle
        loadServicePackages();
        
    } catch (error) {
        console.error('❌ Rapor şablonları yüklenirken hata:', error);
    }
}        
// Hizmet paketlerini yükle - GÜNCELLENMİŞ
function loadServicePackages() {
    const packagesContainer = document.getElementById('ai-report-templates');
    
    if (!packagesContainer) {
        console.error('❌ Packages container bulunamadı');
        return;
    }

    // Eğer zaten yüklenmişse temizle
    packagesContainer.innerHTML = '';
    
    aiReportTemplates.forEach(template => {
        const packageHTML = `
            <div class="bg-white rounded-xl shadow-md service-card">
                <div class="p-6 border-b border-gray-200">
                    <div class="sector-icon text-center">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2 text-center">${template.report_name}</h3>
                    <p class="text-gray-600 text-center mb-4">${template.report_description}</p>
                    <div class="text-center mb-4">
                        <span class="text-3xl font-bold text-indigo-600">$${template.report_price}</span>
                        <span class="text-gray-500">${template.report_currency}</span>
                    </div>
                </div>
                <div class="p-6">
                    <ul class="space-y-3 mb-6">
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            <span>AI destekli analiz</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            <span>Detaylı pazar verileri</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            <span>Rakip analizi</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            <span>Fiyat trendleri</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            <span>Stratejik öneriler</span>
                        </li>
                    </ul>
                    <button class="w-full bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300 add-ai-report" 
                            data-id="${template.id}" 
                            data-name="${template.report_name}" 
                            data-price="${template.report_price}">
                        Sepete Ekle
                    </button>
                </div>
            </div>
        `;
        packagesContainer.innerHTML += packageHTML;
    });

    console.log('✅ Hizmet paketleri yüklendi');
}


        
        // Mesajı sohbete ekle
        function addMessageToChat(message, isUser = false) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-bubble ${isUser ? 'user' : ''}`;
            messageDiv.innerHTML = `<p>${message}</p>`;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

 // setupCompanyAnalysisChat fonksiyonunu düzelt
function setupCompanyAnalysisChat() {
    const serviceSelect = document.getElementById('service-select');
    const chatInput = document.getElementById('chat-input');
    const sendTextButton = document.getElementById('send-text');
    const goBackBtn = document.getElementById('go-back-btn');
    const chatInputArea = document.getElementById('chat-input-area');
    
    // Elementlerin var olduğunu kontrol et
    if (!serviceSelect || !chatInput || !sendTextButton || !chatInputArea) {
        console.error('❌ Sohbet elementi bulunamadı:', {
            serviceSelect: !!serviceSelect,
            chatInput: !!chatInput,
            sendTextButton: !!sendTextButton,
            chatInputArea: !!chatInputArea
        });
        return; // Elementler yoksa fonksiyondan çık
    }
    
    console.log('✅ Sohbet elementleri bulundu, listenerlar kuruluyor...');
    
    // Event listener'ları temizle ve yeniden ekle
    serviceSelect.addEventListener('change', handleServiceChange);
    sendTextButton.addEventListener('click', handleAnswerSubmit);
    
    if (goBackBtn) {
        goBackBtn.addEventListener('click', handleGoBack);
    }
    
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            handleAnswerSubmit();
        }
    });

    async function handleServiceChange() {
        const selectedServiceId = this.value;
        
        if (!selectedServiceId) {
            chatInputArea.classList.add('hidden');
            addMessageToChat("Lütfen ilgilendiğiniz hizmeti seçin.");
            return;
        }

        try {
            currentService = selectedServiceId;
            currentQuestionIndex = 0;
            companyProfile[selectedServiceId] = {};
            
            // Sohbeti temizle (ilk mesaj hariç)
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) {
                const initialMessage = chatContainer.querySelector('.chat-bubble:first-child');
                chatContainer.innerHTML = '';
                if (initialMessage) chatContainer.appendChild(initialMessage);
            }
            
            const selectedServiceName = this.options[this.selectedIndex].text;
            addMessageToChat(`"${selectedServiceName}" hizmeti için analiz başlatılıyor...`);
            
            // Soruları yükle
            await loadServiceQuestionsAdvanced(selectedServiceId);
            
            if (serviceQuestions.length > 0) {
                setTimeout(() => {
                    addMessageToChat(serviceQuestions[0].question);
                    chatInputArea.classList.remove('hidden');
                    if (goBackBtn) goBackBtn.classList.add('hidden');
                }, 1000);
            }
            
        } catch (error) {
            console.error('❌ Hizmet değişim hatası:', error);
            addMessageToChat("❌ " + error.message);
        }
    }
    
     function handleGoBack() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            const previousQuestion = serviceQuestions[currentQuestionIndex].question;
            
            // Sohbeti düzenle
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) {
                const messages = chatContainer.querySelectorAll('.chat-bubble');
                if (messages.length >= 2) {
                    chatContainer.removeChild(messages[messages.length - 1]);
                    chatContainer.removeChild(messages[messages.length - 2]);
                }
                
                // Önceki soruyu tekrar sor
                addMessageToChat(previousQuestion);
                if (goBackBtn) goBackBtn.classList.toggle('hidden', currentQuestionIndex === 0);
                
                // Form alanını temizle
                if (chatInput) chatInput.value = '';
            }
        }
    }
}
        // 4. Tablo verisini debug için göster
             
          // Hizmet sorularını yükle - TABLO YAPISINA UYGUN
        async function loadServiceQuestions(serviceId) {
            try {
                console.log('🔍 Sorular yükleniyor, serviceId:', serviceId);
                
                if (!serviceId) {
                    throw new Error('Geçersiz service ID');
                }
                
                // ÖNEMLİ: Tablo yapınıza göre sorguyu ayarlayın
                let query = supabase
                    .from('ai_question')
                    .select('id, question, flow_number, service_type_id, service_type')
                    .eq('is_active', true)
                    .order('flow_number');
                
                // HANGİ ALAN İLE EŞLEŞTİRME YAPACAĞIZ?
                // Seçenek 1: service_type_id kullan
                query = query.eq('service_type_id', serviceId);
                
                // VEYA Seçenek 2: service_type kullan (string eşleşme)
                // query = query.eq('service_type', serviceId);
                
                const { data, error } = await query;
                
                if (error) {
                    console.error('❌ Sorular yüklenemedi:', error);
                    throw error;
                }
                
                if (!data || data.length === 0) {
                    console.warn(`⚠️ ${serviceId} için soru bulunamadı`);
                    throw new Error('Bu hizmet için henüz soru bulunmamaktadır');
                }
                
                serviceQuestions = data;
                console.log(`✅ ${data.length} soru yüklendi:`, data);
                
            } catch (error) {
                console.error('❌ Sorular yüklenirken hata:', error);
                throw error; // Hata yukarı fırlatılsın
            }
        }
   
        // Güncellenmiş soru yükleme fonksiyonu
        let tableStructure = null;

        // Hizmet sorularını yükle - GÜNCELLENMİŞ (debug ekle)
async function loadServiceQuestionsAdvanced(serviceId) {
    try {
        console.log('🔍 Sorular yükleniyor, serviceId:', serviceId);
        
        if (!serviceId) throw new Error('Geçersiz service ID');
        
        // Hizmet detaylarını da al
        const { data: serviceDetails, error: serviceError } = await supabase
            .from('ai_service_type')
            .select('service_name, sort_code, service_price, currency')
            .eq('id', serviceId)
            .single();
            
        if (serviceError) throw serviceError;
        
        console.log('📋 Hizmet detayları:', serviceDetails);
        
        // Soruları yükle
        let { data, error } = await supabase
            .from('ai_question')
            .select('id, question, flow_number, service_type_id, service_type')
            .eq('service_type_id', serviceId)
            .eq('is_active', true)
            .order('flow_number');
        
        if (error) throw error;
        
        // Eğer soru bulunamazsa, hizmet türüne göre demo sorular oluştur
        if (!data || data.length === 0) {
            console.warn(`⚠️ ${serviceId} için soru bulunamadı, demo sorular oluşturuluyor`);
            data = generateDemoQuestions(serviceDetails.sort_code || serviceId);
        }
        
        serviceQuestions = data;
        console.log(`✅ ${data.length} soru yüklendi`);
        return data;
        
    } catch (error) {
        console.error('❌ Sorular yüklenemedi:', error);
        throw error;
    }
}


        // Demo sorular oluştur - GÜNCELLENMİŞ
function generateDemoQuestions(serviceType) {
    const serviceDemoQuestions = {
        'hedef_ulke_rapor': [
            "Hangi ülkelerde pazar araştırması yapmak istiyorsunuz?",
            "Hangi sektörde faaliyet gösteriyorsunuz?",
            "Hedef pazar büyüklüğünüz nedir?",
            "Rakip analizi yapmak istediğiniz firmalar var mı?",
            "Raporun hangi dilde hazırlanmasını istersiniz?"
        ],
        'firma_kurulus': [
            "Firmanızın adı ne olacak?",
            "Hangi ülkede firma kurmak istiyorsunuz?",
            "Firma türünüz ne olacak? (Limited, A.Ş., vb.)",
            "Sermaye miktarınız nedir?",
            "Faaliyet konunuz nedir?"
        ],
        'banka_hesap': [
            "Hangi ülkede banka hesabı açmak istiyorsunuz?",
            "Hesap türü ne olacak? (Bireysel/Kurumsal)",
            "Hangi para birimlerinde hesap gerekiyor?",
            "Aylık ortalama işlem hacminiz nedir?",
            "Öncelikli banka tercihleriniz nelerdir?"
        ],
        'muhasebe': [
            "Hangi ülkede muhasebe hizmeti almak istiyorsunuz?",
            "Firma türünüz nedir?",
            "Aylık ortalama işlem sayınız nedir?",
            "Özel muhasebe gereksinimleriniz var mı?",
            "Tercih ettiğiniz muhasebe programı var mı?"
        ],
        'ihracat_kredileri': [
            "İhracat yapmayı planladığınız ülke nedir?",
            "İhracat tutarı ne kadar olacak?",
            "İhracat ürününüz nedir?",
            "Vade süresi tercihiniz nedir?",
            "Teminat imkanlarınız nelerdir?"
        ]
    };
    
    const questions = serviceDemoQuestions[serviceType] || [
        "Lütfen ihtiyaçlarınızı detaylandırın:",
        "Hedefleriniz nelerdir?",
        "Bütçe aralığınız nedir?",
        "Zaman planlamanız nasıl?",
        "Ek notlarınız var mı?"
    ];
    
    return questions.map((question, index) => ({
        id: `demo-${serviceType}-${index}`,
        question: question,
        flow_number: index + 1,
        service_type_id: serviceType,
        service_type: serviceType,
        is_demo: true
    }));
}
                
    // Firma Analiz Sohbeti - GÜNCELLENMİŞ
    function setupCompanyAnalysisChat() {
    const serviceSelect = document.getElementById('service-select');
    const chatInput = document.getElementById('chat-input');
    const sendTextButton = document.getElementById('send-text');
    const goBackBtn = document.getElementById('go-back-btn');
    const chatInputArea = document.getElementById('chat-input-area');

    // Event listener'ları temizle ve yeniden ekle
    serviceSelect.addEventListener('change', handleServiceChange);
    sendTextButton.addEventListener('click', handleAnswerSubmit);
    goBackBtn.addEventListener('click', handleGoBack);
    
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            handleAnswerSubmit();
        }
    });

    async function handleServiceChange() {
        const selectedServiceId = this.value;
        const chatInputArea = document.getElementById('chat-input-area');
        const goBackBtn = document.getElementById('go-back-btn');
        
        if (!selectedServiceId) {
            chatInputArea.classList.add('hidden');
            addMessageToChat("Lütfen ilgilendiğiniz hizmeti seçin.");
            return;
        }

        try {
            currentService = selectedServiceId;
            currentQuestionIndex = 0;
            companyProfile[selectedServiceId] = {};
            
            // Sohbeti temizle (ilk mesaj hariç)
            const chatContainer = document.getElementById('chat-container');
            const initialMessage = chatContainer.querySelector('.chat-bubble:first-child');
            chatContainer.innerHTML = '';
            if (initialMessage) chatContainer.appendChild(initialMessage);
            
            const selectedServiceName = this.options[this.selectedIndex].text;
            addMessageToChat(`"${selectedServiceName}" hizmeti için analiz başlatılıyor...`);
            
            // Soruları yükle
            await loadServiceQuestionsAdvanced(selectedServiceId);
            
            if (serviceQuestions.length > 0) {
                setTimeout(() => {
                    addMessageToChat(serviceQuestions[0].question);
                    chatInputArea.classList.remove('hidden');
                    goBackBtn.classList.add('hidden');
                }, 1000);
            }
            
        } catch (error) {
            console.error('❌ Hizmet değişim hatası:', error);
            addMessageToChat("❌ " + error.message);
        }
    }
    
    function handleGoBack() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            const previousQuestion = serviceQuestions[currentQuestionIndex].question;
            
            // Sohbeti düzenle
            const chatContainer = document.getElementById('chat-container');
            const messages = chatContainer.querySelectorAll('.chat-bubble');
            if (messages.length >= 2) {
                chatContainer.removeChild(messages[messages.length - 1]);
                chatContainer.removeChild(messages[messages.length - 2]);
            }
            
            // Önceki soruyu tekrar sor
            addMessageToChat(previousQuestion);
            goBackBtn.classList.toggle('hidden', currentQuestionIndex === 0);
            
            // Form alanını temizle
            chatInput.value = '';
        }
    }
}

// Hizmet türlerine göre özel son sorular ve fiyat bilgisi
const serviceEndQuestions = {
       'firma_kurulus': {
        question: "Şirket kuruluş işleminizi hemen başlatmak ister misiniz?",
        actionText: "Kuruluşu Başlat"
    },
    'banka_hesap': {
        question: "Banka hesabı açılış işleminizi başlatmak ister misiniz?",
        actionText: "Hesap Açılışını Başlat"
    },
    'muhasebe': {
        question: "Muhasebe işlemlerinizi başlatmak ister misiniz?",
        actionText: "Muhasebe Başlat"
    },
    'ihracat_kredileri': {
        question: "İhracat kredisi başvurunuzu başlatmak ister misiniz?",
        actionText: "Kredi Başvurusu Başlat"
    }
};

// Cevap gönderme - DÜZELTİLMİŞ
function handleAnswerSubmit() {
    const chatInput = document.getElementById('chat-input');
    const message = chatInput.value.trim();
    const goBackBtn = document.getElementById('go-back-btn');
    
    if (!message) return;

    // Kullanıcı mesajını ekle
    addMessageToChat(message, true);

    // Şirket profilini güncelle
    const currentQuestion = serviceQuestions[currentQuestionIndex].question;
    companyProfile[currentService][currentQuestion] = message;

    chatInput.value = '';

    // Son soruya gelindi mi kontrol et
    if (currentQuestionIndex < serviceQuestions.length - 1) {
        // Normal soru devam et
        currentQuestionIndex++;
        const nextQuestion = serviceQuestions[currentQuestionIndex].question;
        setTimeout(() => {
            addMessageToChat(nextQuestion);
            goBackBtn.classList.remove('hidden');
        }, 500);
    } else {
        // SON SORU - Hizmete özel teklifi göster
        setTimeout(() => {
            showServiceSpecificOffer();
        }, 1000);
    }
}

// Sepeti görüntüle fonksiyonu
function viewCart() {
    // Sepet modal'ını aç veya sepete yönlendir
    const cartSection = document.getElementById('services');
    if (cartSection) {
        cartSection.scrollIntoView({ behavior: 'smooth' });
    }
}        

// Rapor teklifi göster
function showReportOffer() {
    const offerHTML = `
        <div class="chat-bubble">
            <p>Kapsamlı Pazar Analizi Raporunuzu hazırlamamızı ister misiniz?</p>
            <div class="flex space-x-4 mt-4">
                <button id="accept-offer" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300">
                    ✅ Evet
                </button>
                <button id="decline-offer" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-300">
                    ❌ Hayır
                </button>
            </div>
        </div>
    `;
    
    const chatContainer = document.getElementById('chat-container');
    chatContainer.insertAdjacentHTML('beforeend', offerHTML);
    
    // Input alanını gizle
    document.getElementById('chat-input-area').classList.add('hidden');
    
    // Event listener'ları ekle
    document.getElementById('accept-offer').addEventListener('click', handleOfferAccept);
    document.getElementById('decline-offer').addEventListener('click', handleOfferDecline);
}

// Hizmete özel teklifi göster - YENİ FONKSİYON
async function showServiceSpecificOffer() {
    try {
        // Hizmet detaylarını veritabanından al
        const { data: serviceDetails, error } = await supabase
            .from('ai_service_type')
            .select('service_name, service_price, currency, sort_code')
            .eq('id', currentService)
            .single();
        
        if (error) throw error;

        // Hizmet türüne göre son soruyu belirle
        const serviceType = serviceDetails.sort_code || currentService;
        const endConfig = serviceEndQuestions[serviceType] || {
            question: "Hizmetinizi başlatmak ister misiniz?",
            actionText: "Hizmeti Başlat"
        };

        const offerHTML = `
            <div class="chat-bubble">
                <p>${endConfig.question}</p>
                <div class="mt-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold">${serviceDetails.service_name}</span>
                        <span class="text-green-600 font-bold">
                            ${serviceDetails.service_price} ${serviceDetails.currency}
                        </span>
                    </div>
                    <div class="text-sm text-gray-600 mt-1">
                        Hizmet Bedeli
                    </div>
                </div>
                <div class="flex space-x-4 mt-4">
                    <button id="accept-offer" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300 flex items-center">
                        <i class="fas fa-check mr-2"></i>
                        ${endConfig.actionText}
                    </button>
                    <button id="decline-offer" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-300 flex items-center">
                        <i class="fas fa-times mr-2"></i>
                        Hayır
                    </button>
                </div>
            </div>
        `;
        
        const chatContainer = document.getElementById('chat-container');
        chatContainer.insertAdjacentHTML('beforeend', offerHTML);
        
        // Input alanını gizle
        document.getElementById('chat-input-area').classList.add('hidden');
        
        // Event listener'ları ekle
        document.getElementById('accept-offer').addEventListener('click', () => handleOfferAccept(serviceDetails));
        document.getElementById('decline-offer').addEventListener('click', handleOfferDecline);
        
    } catch (error) {
        console.error('Hizmet detayları yüklenirken hata:', error);
        // Fallback mesaj
        addMessageToChat("Hizmet bilgileri alınırken bir hata oluştu. Lütfen daha sonra tekrar deneyin.");
    }
}
// GÜNCELLENMİŞ - BU KULLANILACAK
function addToAICart(item) {
    // Eğer item bir template ise (rapor)
    if (item.template_id) {
        const existingItem = serviceCart.find(cartItem => 
            cartItem.id === item.template_id && cartItem.type !== 'service'
        );
        
        if (!existingItem) {
            serviceCart.push({
                id: item.template_id,
                name: item.report_title || item.report_name,
                price: item.report_price,
                currency: item.report_currency,
                reportId: item.id,
                type: 'report',
                quantity: 1
            });
        }
    } 
    // Eğer item bir hizmet ise
    else if (item.type === 'service') {
        const existingItem = serviceCart.find(cartItem => 
            cartItem.id === item.id && cartItem.type === 'service'
        );
        
        if (!existingItem) {
            serviceCart.push({
                id: item.id,
                name: item.name,
                price: item.price,
                currency: item.currency,
                type: 'service',
                profile: item.profile,
                service_type: item.service_type,
                quantity: 1
            });
        }
    }
    // Eğer sadece template bilgisi var (eski sistem)
    else {
        const existingItem = serviceCart.find(cartItem => cartItem.id === item.id);
        
        if (!existingItem) {
            serviceCart.push({
                id: item.id,
                name: item.name,
                price: item.price,
                currency: item.currency,
                reportId: item.reportId,
                quantity: 1
            });
        }
    }
    
    updateAICart();
}
        
// handleOfferAccept fonksiyonunu düzelt
async function handleOfferAccept(serviceDetails) {
    try {
        console.log('🛒 Servis sepete ekleniyor:', serviceDetails);
        
        // Fiyat kontrolü - serviceDetails doğru mu?
        const servicePrice = serviceDetails.service_price || serviceDetails.price || 0;
        const serviceCurrency = serviceDetails.currency || 'USD';
        const serviceName = serviceDetails.service_name || serviceDetails.name || 'Bilinmeyen Servis';
        
        // Sepete ekle
        const cartItem = {
            id: currentService,
            name: serviceName,
            price: servicePrice,
            currency: serviceCurrency,
            type: 'service',
            profile: companyProfile[currentService],
            service_type: serviceDetails.sort_code || currentService
        };
        
        console.log('✅ Sepet öğesi:', cartItem);
        addToAICart(cartItem);
        
        // Kullanıcıya bilgi ver
        addMessageToChat(`
            ✅ "${serviceName}" hizmeti sepete eklendi! 
            <br>Fiyat: ${servicePrice} ${serviceCurrency}
            <br><br>
            <button onclick="viewCart()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300 mt-2">
                Sepeti Görüntüle
            </button>
        `);
        
        // Butonları kaldır
        document.getElementById('accept-offer').style.display = 'none';
        document.getElementById('decline-offer').style.display = 'none';
        
    } catch (error) {
        console.error('❌ Teklif kabul hatası:', error);
        addMessageToChat('❌ Hizmet sepete eklenirken bir hata oluştu. Lütfen tekrar deneyin.');
    }
}
        
// Rapor teklifi göster
function showReportOffer() {
    const offerHTML = `
        <div class="chat-bubble">
            <p>Kapsamlı Pazar Analizi Raporunuzu hazırlamamızı ister misiniz?</p>
            <div class="flex space-x-4 mt-4">
                <button id="accept-offer" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300">
                    ✅ Evet
                </button>
                <button id="decline-offer" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-300">
                    ❌ Hayır
                </button>
            </div>
        </div>
    `;
    
    const chatContainer = document.getElementById('chat-container');
    chatContainer.insertAdjacentHTML('beforeend', offerHTML);
    
    // Input alanını gizle
    document.getElementById('chat-input-area').classList.add('hidden');
    
    // Event listener'ları ekle
    document.getElementById('accept-offer').addEventListener('click', handleOfferAccept);
    document.getElementById('decline-offer').addEventListener('click', handleOfferDecline);
}
// Teklifi reddet
function handleOfferDecline() {
    addMessageToChat('Anlıyorum. İstediğiniz zaman hizmetlerimizden faydalanabilirsiniz. Size nasıl yardımcı olabilirim?');
    
    // Butonları kaldır
    document.getElementById('accept-offer').style.display = 'none';
    document.getElementById('decline-offer').style.display = 'none';
    
    // Oturum verisini sakla (kullanıcı çıkış yapana kadar)
    saveChatSession();
}

// Oturum verisini sakla
function saveChatSession() {
    const sessionData = {
        serviceId: currentService,
        profile: companyProfile[currentService],
        timestamp: new Date().getTime()
    };
    sessionStorage.setItem('chat_session', JSON.stringify(sessionData));
}

// Oturum verisini temizle
function clearChatSession() {
    sessionStorage.removeItem('chat_session');
    companyProfile = {};
    currentService = null;
    currentQuestionIndex = 0;
    serviceQuestions = [];
}

// Sayfa yüklendiğinde oturum kontrolü
function checkChatSession() {
    const savedSession = sessionStorage.getItem('chat_session');
    if (savedSession) {
        const sessionData = JSON.parse(savedSession);
        const now = new Date().getTime();
        const sessionAge = now - sessionData.timestamp;
        
        // 1 saatten eski oturumları temizle
        if (sessionAge > 60 * 60 * 1000) {
            clearChatSession();
        } else {
            // Oturumu geri yükle
            console.log('📝 Kayıtlı sohbet oturumu bulundu');
        }
    }
}        
          // Şirket Analizi Oluştur - DOMAIN DÜZELTİLDİ
        async function generateCompanyAnalysis() {
            try {
                addMessageToChat("🔍 Bilgileriniz analiz ediliyor...");
                
                // DOMAIN DÜZELTME: parena-platform.app -> parenatrade.vercel.app
                const response = await fetch('https://parenatrade.vercel.app/api/analyze-company', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        service: currentService,
                        profile: companyProfile[currentService],
                        service_name: document.getElementById('service-select').selectedOptions[0]?.text
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API hatası: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    addMessageToChat(result.result);
                    addMessageToChat("💼 Size özel hazırladığım hizmet paketlerini sepete ekleyebilirsiniz.");
                } else {
                    throw new Error(result.error || 'Analiz oluşturulamadı');
                }

            } catch (error) {
                console.error('❌ Analiz oluşturma hatası:', error);
                addMessageToChat("❌ Üzgünüm, analiz oluşturulamadı: " + error.message);
                
                // Fallback: Mock analiz göster
                const mockAnalysis = generateMockAnalysis(currentService, companyProfile[currentService]);
                addMessageToChat("📋 Demo analiz:");
                addMessageToChat(mockAnalysis);
                addMessageToChat("💼 Size özel hazırladığım hizmet paketlerini sepete ekleyebilirsiniz.");
            }
        }

        
// Template seçiminde global değişkeni güncelle - TAM KOD
function setupQuickReportForm() {
    const templateSelect = document.getElementById('report-template-select');
    const generateBtn = document.getElementById('generate-report-btn');
    
    if (!templateSelect) {
        console.error('❌ Template select bulunamadı');
        return;
    }
    
    // Template değişim event'i
    templateSelect.addEventListener('change', function() {
        const templateId = this.value;
        console.log('🎯 Seçilen template:', templateId);
        
        if (!templateId) {
            // Temizleme
            window.selectedTemplate = null;
            document.getElementById('dynamic-form-fields').classList.add('hidden');
            document.getElementById('criteria-list').classList.add('hidden');
            if (generateBtn) generateBtn.classList.add('hidden');
            return;
        }
        
        // Global selectedTemplate'i güncelle
        window.selectedTemplate = window.reportTemplates?.find(t => t.id === templateId);
        console.log('🎯 Global selectedTemplate güncellendi:', window.selectedTemplate);
        
        if (window.selectedTemplate) {
            console.log('📊 Seçilen rapor:', window.selectedTemplate.report_name);
            
            // Template açıklamasını göster
            const descriptionElement = document.getElementById('template-description');
            if (descriptionElement && window.selectedTemplate.report_description) {
                descriptionElement.textContent = window.selectedTemplate.report_description;
                descriptionElement.classList.remove('hidden');
            }
            
            // Değişkenleri çıkar ve form oluştur
            const variables = extractVariables(window.selectedTemplate.report_prompt);
            createDynamicFormFields(variables);
            
            // Butonu göster
            if (generateBtn) {
                generateBtn.classList.remove('hidden');
                // Event listener'ı temizle ve yeniden ekle
                generateBtn.onclick = null;
                generateBtn.addEventListener('click', generateAIReport);
            }
            
        } else {
            console.error('❌ Template bulunamadı:', templateId);
            // Hata durumunda UI'ı temizle
            document.getElementById('dynamic-form-fields').classList.add('hidden');
            document.getElementById('criteria-list').classList.add('hidden');
            if (generateBtn) generateBtn.classList.add('hidden');
        }
    });
    
    // Generate butonuna event listener ekle
    if (generateBtn) {
        generateBtn.addEventListener('click', function(e) {
            e.preventDefault();
            generateAIReport();
        });
    }
    
    // Sayfa yüklendiğinde mevcut seçimi kontrol et
    setTimeout(() => {
        if (templateSelect.value && window.reportTemplates) {
            const currentTemplate = window.reportTemplates.find(t => t.id === templateSelect.value);
            if (currentTemplate) {
                window.selectedTemplate = currentTemplate;
                console.log('🔄 Mevcut template yüklendi:', window.selectedTemplate);
            }
        }
    }, 1000);
    
    console.log('✅ Quick report form kuruldu');
}
        
// Template detaylarını Supabase'den çek
async function getTemplateDetails(templateId) {
    try {
        const { data, error } = await supabase
            .from('ai_report_templates')
            .select('*')
            .eq('id', templateId)
            .single();
        
        if (error) throw error;
        return data;
        
    } catch (error) {
        console.error('❌ Template detayları yüklenemedi:', error);
        return null;
    }
}

function fillPromptTemplate(template, formData) {
    if (!template || !template.report_prompt) {
        console.error('❌ Geçersiz template veya prompt');
        return '';
    }
    
    let filledPrompt = template.report_prompt;
    
    console.log('🔍 FormData durumu:', formData);
    
    // current_year'i otomatik ekle
    const currentYear = new Date().getFullYear();
    filledPrompt = filledPrompt.replace(/\{\{current_year\}\}/g, currentYear);
    filledPrompt = filledPrompt.replace(/%current_year%/g, currentYear);
    
    // Tüm değişkenleri işle
    Object.entries(formData).forEach(([key, value]) => {
        if (value && value.trim() !== '') {
            // Tüm olası formatlarda değiştir
            const patterns = [
                `{{${key}}}`,
                `%${key}%`
            ];
            
            patterns.forEach(pattern => {
                const regex = new RegExp(pattern, 'g');
                filledPrompt = filledPrompt.replace(regex, value.trim());
            });
        }
    });
    
    // Eksik değişkenleri temizle
    filledPrompt = filledPrompt.replace(/\{\{\w+\}\}/g, 'Bilgi verilmemiş');
    filledPrompt = filledPrompt.replace(/%\w+%/g, 'Bilgi verilmemiş');
    
    console.log('✅ Prompt dolduruldu, ilk 200 karakter:', filledPrompt.substring(0, 200));
    return filledPrompt;
}
        
// Dropdown verilerini düzeltelim - tablo isimleri yanlış
async function loadDropdownData() {
    try {
        console.log('📊 Dropdown verileri yükleniyor...');
        
        // 1. Dilleri yükle - EĞER languages tablosu yoksa, sabit veri kullan
        try {
            const { data: languages, error: langError } = await supabase
                .from('languages')
                .select('id, name, iso_code')
                .order('name');
            
            if (!langError && languages) {
                window.languages = languages;
                console.log(`✅ ${languages.length} dil yüklendi`);
            } else {
                // Fallback: Sabit dil listesi
                window.languages = [
                { id: 1, name: 'Türkçe', iso_code: 'tr' },
                { id: 2, name: 'İngilizce', iso_code: 'en' },
                { id: 3, name: 'Almanca', iso_code: 'de' },
                { id: 4, name: 'Fransızca', iso_code: 'fr' },
                { id: 5, name: 'Rusça', iso_code: 'ru' }
                ];
                console.log('✅ Varsayılan diller yüklendi');
            }
        } catch (error) {
           window.languages = [
            { id: 1, name: 'Türkçe', iso_code: 'tr' },
            { id: 2, name: 'İngilizce', iso_code: 'en' },
            { id: 3, name: 'Almanca', iso_code: 'de' },
            { id: 4, name: 'Fransızca', iso_code: 'fr' },
            { id: 5, name: 'Rusça', iso_code: 'ru' }
        ];
        }
        
        // 2. Ülkeleri yükle - EĞER country tablosu yoksa, sabit veri kullan
        try {
            const { data: countries, error: countryError } = await supabase
                .from('country')
                .select('id, name, iso_code')
                .order('name');
            
            if (!countryError && countries) {
                window.countries = countries;
                console.log(`✅ ${countries.length} ülke yüklendi`);
            } else {
                // Fallback: Sabit ülke listesi
                window.countries = [
                    { id: 1, name: 'Türkiye', iso_code: 'TR' },
                    { id: 2, name: 'Almanya', iso_code: 'DE' },
                    { id: 3, name: 'Fransa', iso_code: 'FR' },
                    { id: 4, name: 'Romanya', iso_code: 'RO' },
                    { id: 5, name: 'Bulgaristan', iso_code: 'BG' }
                ];
                console.log('✅ Varsayılan ülkeler yüklendi');
            }
        } catch (error) {
            window.countries = [
                { id: 1, name: 'Türkiye', iso_code: 'TR' },
                { id: 2, name: 'Almanya', iso_code: 'DE' }
            ];
        }
        
        // 3. Sektörleri yükle - EĞER sector tablosu yoksa, sabit veri kullan
        try {
            const { data: sectors, error: sectorError } = await supabase
                .from('sector')
                .select('id, name, code')
                .order('name');
            
            if (!sectorError && sectors) {
                window.sectors = sectors;
                console.log(`✅ ${sectors.length} sektör yüklendi`);
            } else {
                // Fallback: Sabit sektör listesi
                window.sectors = [
                    { id: 1, name: 'Gıda', code: 'FOOD' },
                    { id: 2, name: 'Tekstil', code: 'TEXTILE' },
                    { id: 3, name: 'Kimya', code: 'CHEMICAL' },
                    { id: 4, name: 'Otomotiv', code: 'AUTO' },
                    { id: 5, name: 'Teknoloji', code: 'TECH' }
                ];
                console.log('✅ Varsayılan sektörler yüklendi');
            }
        } catch (error) {
            window.sectors = [
                { id: 1, name: 'Gıda', code: 'FOOD' },
                { id: 2, name: 'Tekstil', code: 'TEXTILE' }
            ];
        }
        
        // 4. GTIP kodlarını yükle - EĞER gtip tablosu yoksa, sabit veri kullan
        try {
            const { data: gtipCodes, error: gtipError } = await supabase
                .from('gtip')
                .select('id, name, code')
                .order('code');
            
            if (!gtipError && gtipCodes) {
                window.gtipCodes = gtipCodes;
                console.log(`✅ ${gtipCodes.length} GTIP kodu yüklendi`);
            } else {
                // Fallback: Sabit GTIP listesi
                window.gtipCodes = [
                    { id: 1, code: '2002.10', name: 'Domates Salçası'},
                    { id: 2, code: '2002.90', name: 'Diğer Sebze Salçaları'},
                    { id: 3, code: '5208', name: 'Pamuklu Dokumalar'},
                    { id: 4, code: '6109', name: 'Tişört ve Atlet'}
                ];
                console.log('✅ Varsayılan GTIP kodları yüklendi');
            }
        } catch (error) {
            window.gtipCodes = [
                { id: 1, code: '2002.10', name: 'Domates Salçası'},
                { id: 2, code: '5208', name: 'Pamuklu Dokumalar'}
            ];
        }
        
        // 5. Rapor şablonlarını yükle - ai_report_templates yerine mevcut sistemi kullan
        try {
            const { data: reportTemplates, error: templateError } = await supabase
                .from('ai_report_templates')
                .select('id, report_name, report_type, report_description, report_price, report_currency')
                .order('report_name');
            
            if (!templateError && reportTemplates) {
                window.reportTemplates = reportTemplates;
                console.log(`✅ ${reportTemplates.length} rapor şablonu yüklendi`);
            } else {
                // Fallback: Mevcut rapor şablonlarını kullan
                window.reportTemplates = aiReportTemplates;
                console.log('✅ Mevcut rapor şablonları kullanılıyor');
            }
        } catch (error) {
            window.reportTemplates = aiReportTemplates;
        }
        
    } catch (error) {
        console.error('❌ Dropdown verileri yüklenirken hata:', error);
        // Hata durumunda varsayılan verileri yükle
        loadDefaultDropdownData();
    }
}

// Varsayılan dropdown verileri
function loadDefaultDropdownData() {
    window.languages = [
        { id: 1, name: 'Türkçe', iso_code: 'tr' },
        { id: 2, name: 'İngilizce', iso_code: 'en' },
        { id: 3, name: 'Gürcüce', iso_code: 'ka' }
    ];
    
    window.countries = [
        { id: 1, name: 'Türkiye', code: 'TR' },
        { id: 2, name: 'Gürcistan', code: 'KA' },
        { id: 3, name: 'İngiltere', code: 'EN' },
        { id: 4, name: 'Almanya', code: 'DE' },
        { id: 5, name: 'Fransa', code: 'FR' }
        
    ];
    
    window.sectors = [
        { id: 1, name: 'Gıda', code: 'FOOD' },
        { id: 2, name: 'Tekstil', code: 'TEXTILE' },
        { id: 3, name: 'Kimya', code: 'CHEMICAL' }
    ];
    
    window.gtipCodes = [
        { id: 1, code: '2002.10', name: 'Domates Salçası'},
        { id: 2, code: '5208', name: 'Pamuklu Dokumalar'}
    ];
    
    window.reportTemplates = aiReportTemplates;
}
// Akordiyon event listener'larını ekle - EKSİK KISIM
// Akordiyon listener'larını kur - DÜZELTİLMİŞ
function setupAccordionListeners() {
    const accordionHeaders = document.querySelectorAll('.accordion-header');
    
    console.log('🔧 Akordiyon listenerları kuruluyor, eleman sayısı:', accordionHeaders.length);
    
    if (accordionHeaders.length === 0) {
        console.warn('⚠️ Akordiyon header bulunamadı - form alanları henüz oluşmamış olabilir');
        return;
    }
    
    accordionHeaders.forEach(header => {
        // Önceki event listener'ları temizle
        header.replaceWith(header.cloneNode(true));
    });
    
    // Yeni listener'ları ekle
    document.querySelectorAll('.accordion-header').forEach(header => {
        header.addEventListener('click', function() {
            const content = this.nextElementSibling;
            
            if (this.classList.contains('active')) {
                // Kapat
                this.classList.remove('active');
                content.classList.remove('open');
                activeAccordion = null;
            } else {
                // Öncekini kapat
                if (activeAccordion) {
                    activeAccordion.classList.remove('active');
                    activeAccordion.nextElementSibling.classList.remove('open');
                }
                // Yeni aç
                this.classList.add('active');
                content.classList.add('open');
                activeAccordion = this;
            }
        });
    });
    
    console.log('✅ Akordiyon listenerları kuruldu');
}

        
// Dinamik form alanlarını oluştur - TAM BİRLEŞTİRİLMİŞ
function createDynamicFormFields(variables) {
    const container = document.getElementById('dynamic-form-fields');
    if (!container) {
        console.error('❌ Form container bulunamadı');
        return;
    }
    
     container.innerHTML = '';
    
    // FORM DATA INITIALIZATION - BURAYA DA EKLE
    if (!window.formData) {
        window.formData = {};
        console.log('✅ window.formData createDynamicFormFields içinde initialize edildi');
    }
    
    // Field konfigürasyonları - GERÇEK (ÜSTTEKİ KODDAN)
    const fieldConfigs = {
        dil: {
            title: 'Rapor Dili',
            type: 'dropdown',
            data: window.languages || [
                { id: 1, name: 'Türkçe', iso_code: 'tr' },
                { id: 2, name: 'İngilizce', iso_code: 'en' }
            ],
            displayField: 'name',
            valueField: 'iso_code'
        },
        ulke: {
            title: 'Hedef Ülke',
            type: 'dropdown',
            data: window.countries || [
                { id: 1, name: 'Türkiye', iso_code: 'TR' },
                { id: 2, name: 'Almanya', iso_code: 'DE' }
            ],
            displayField: 'name',
            valueField: 'name'
        },
        sektor: {
            title: 'Sektör',
            type: 'dropdown',
            data: window.sectors || [
                { id: 1, name: 'Gıda', code: 'FOOD' },
                { id: 2, name: 'Tekstil', code: 'TEXTILE' }
            ],
            displayField: 'name',
            valueField: 'name'
        },
        firma_adi: {
        title: 'Firma Adı',
        type: 'text',
        placeholder: 'Analiz edilecek firma veya marka adı...'
    },
        urun: {
            title: 'Ürün/Hizmet',
            type: 'text',
            placeholder: 'Örn: Domates Salçası, Tekstil Ürünleri...'
        },
        bolge: {
            title: 'Bölge',
            type: 'dropdown',
            data: [
                { id: 'all', name: 'Tüm Bölgeler' },
                { id: 'east', name: 'Doğu' },
                { id: 'west', name: 'Batı' },
                { id: 'north', name: 'Kuzey' },
                { id: 'south', name: 'Güney' }
            ],
            displayField: 'name',
            valueField: 'name'
        },
        gtip: {
            title: 'GTIP Kodu',
            type: 'text',
            placeholder: 'Örn: 2002.10, 5208.11...'
        },
        zaman: {
            title: 'Zaman Aralığı',
            type: 'text',
            placeholder: 'Örn: 2020-2024, Son 5 yıl...'
        },
        amac: {
            title: 'Analiz Amacı',
            type: 'textarea',
            placeholder: 'Raporu hangi amaçla kullanacaksınız?'
        },
        derinlik: {
            title: 'Analiz Derinliği',
            type: 'dropdown',
            data: [
                { id: 1, name: 'Özet Rapor' },
                { id: 2, name: 'Detaylı Analiz' },
                { id: 3, name: 'Kapsamlı Araştırma' }
            ],
            displayField: 'name',
            valueField: 'name'
        },
        rapor_turu: {
            title: 'Rapor Türü',
            type: 'hidden'
        }
    };
    
    // ALTTAKİ KODDAN GELEN MANTIK:
    if (!variables || variables.length === 0) {
        container.innerHTML = '<p class="text-gray-500 p-4">Bu rapor için ek bilgi gerekmemektedir.</p>';
        container.classList.remove('hidden');
        return;
    }
    
     variables.forEach(variable => {
        const config = fieldConfigs[variable];
        if (!config) {
            console.warn(`⚠️ ${variable} için config bulunamadı`);
            return;
        }
        
        if (config.type === 'hidden') {
            window.formData[variable] = window.selectedTemplate?.report_name || ''; // formData -> window.formData
            return;
        }
        
        const fieldHTML = `
            <div class="accordion-item">
                <div class="accordion-header" data-field="${variable}">
                    <span>${config.title}</span>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </div>
                <div class="accordion-content">
                    ${createFieldHTML(variable, config)}
                </div>
            </div>
        `;
        
        container.innerHTML += fieldHTML;
        window.formData[variable] = ''; // formData -> window.formData // Başlangıç değeri
    });
    
    // ALTTAKİ KODDAN GELEN İYİLEŞTİRME:
    if (selectedTemplate) {
        formData.rapor_turu = selectedTemplate.report_name;
    }
    
    container.classList.remove('hidden');
    
    // İKİ KODDAN GELEN LISTENER'LAR:
    setTimeout(() => {
        setupAccordionListeners();
        setupFieldEventListeners(); // YENİ TAM FONKSİYON
        updateCriteriaList();       // ALTTAKİ KODDAN GELEN
    }, 100);
    
    console.log('✅ Form alanları oluşturuldu');
}
// Form alanı oluştur
function createFieldHTML(field, config) {
    const baseClasses = "w-full px-4 py-2 border border-gray-300 rounded-lg form-field";
    
    switch (config.type) {
        case 'dropdown':
            return `
                <select class="${baseClasses}" data-field="${field}">
                    <option value="">Seçiniz</option>
                    ${config.data.map(item => 
                        `<option value="${item[config.valueField]}">${item[config.displayField]}</option>`
                    ).join('')}
                </select>
            `;
        
        case 'searchable-dropdown':
            return `
                <div class="searchable-dropdown relative">
                    <input type="text" 
                           class="${baseClasses} search-input"
                           placeholder="${config.placeholder || 'Arama yapın...'}"
                           data-field="${field}"
                           id="${field}-search-input">
                    <div class="dropdown-results hidden absolute z-50 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-60 overflow-y-auto shadow-xl"></div>
                </div>
                <div class="selected-value mt-2 hidden">
                    <span class="text-sm text-gray-600">Seçilen: </span>
                    <span class="selected-text font-medium"></span>
                    <button class="text-red-500 hover:text-red-700 clear-selection ml-2" data-field="${field}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        
        case 'textarea':
            return `
                <textarea class="${baseClasses}" 
                          data-field="${field}" 
                          placeholder="${config.placeholder || ''}"
                          rows="3"></textarea>
            `;
        
        default:
            return `
                <input type="text" 
                       class="${baseClasses}"
                       data-field="${field}"
                       placeholder="${config.placeholder || ''}">
            `;
    }
}
// Field HTML oluştur - YENİ FONKSİYON
function createFieldHTML(field, config) {
    switch (config.type) {
        case 'dropdown':
            return `
                <select class="w-full px-4 py-2 border border-gray-300 rounded-lg form-field" data-field="${field}">
                    <option value="">Seçiniz</option>
                    ${config.data.map(item => 
                        `<option value="${item[config.valueField]}">${item[config.displayField]}</option>`
                    ).join('')}
                </select>
            `;
        
        case 'textarea':
            return `
                <textarea class="w-full px-4 py-2 border border-gray-300 rounded-lg form-field" 
                          data-field="${field}" 
                          placeholder="${config.placeholder || ''}"
                          rows="3"></textarea>
            `;
        
        default: // text
            return `
                <input type="text" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg form-field"
                       data-field="${field}"
                       placeholder="${config.placeholder || ''}">
            `;
    }
}
        

// Dropdown alanı oluştur
function createDropdownField(field, config) {
    return `
        <div class="accordion-item">
            <div class="accordion-header" data-field="${field}">
                <span>${config.title}</span>
                <i class="fas fa-chevron-down accordion-icon"></i>
            </div>
            <div class="accordion-content">
                <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 form-field dropdown-field"
                        data-field="${field}">
                    <option value="">Seçiniz</option>
                    ${config.data ? config.data.map(item => 
                        `<option value="${item[config.valueField]}">${item[config.displayField]}</option>`
                    ).join('') : ''}
                </select>
            </div>
        </div>
    `;
}

// Arama yapılabilir dropdown (GTIP için) - MEVCUT FONKSİYONU DÜZELTELİM
// Arama yapılabilir dropdown (GTIP için) - MEVCUT FONKSİYONU DÜZELTELİM
function createSearchableDropdownField(field, config) {
    return `
        <div class="accordion-item">
            <div class="accordion-header" data-field="${field}">
                <span>${config.title}</span>
                <i class="fas fa-chevron-down accordion-icon"></i>
            </div>
            <div class="accordion-content">
                <div class="searchable-dropdown relative">
                    <input type="text" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 search-input"
                           placeholder="${field === 'gtip' ? 'GTIP kodu yazın (örn: 2002.90) veya ürün adı arayın...' : 'Arama yapın...'}"
                           data-field="${field}"
                           id="${field}-search-input">
                    <div class="dropdown-results hidden absolute z-50 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-60 overflow-y-auto shadow-xl"></div>
                </div>
                ${field === 'gtip' ? `
                <div class="selected-value mt-3 p-3 bg-green-50 rounded-lg border border-green-200 hidden">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-sm text-green-700 font-medium">Seçilen GTIP:</span>
                            <div class="selected-text font-semibold text-green-800"></div>
                        </div>
                        <button class="text-red-500 hover:text-red-700 clear-selection" data-field="${field}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                ` : `
                <div class="selected-value mt-2 hidden">
                    <span class="text-sm text-gray-600">Seçilen: </span>
                    <span class="selected-text font-medium"></span>
                </div>
                `}
            </div>
        </div>
    `;
}
        
// Rapor şablonu dropdown
function createTemplateDropdownField(field, config) {
    return `
        <div class="accordion-item">
            <div class="accordion-header" data-field="${field}">
                <span>${config.title}</span>
                <i class="fas fa-chevron-down accordion-icon"></i>
            </div>
            <div class="accordion-content">
                <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 form-field template-field"
                        data-field="${field}">
                    <option value="">Rapor türü seçin</option>
                    ${config.data ? config.data.map(item => 
                        `<option value="${item[config.valueField]}" 
                                data-description="${item.report_description}"
                                data-price="${item.report_price}"
                                data-currency="${item.report_currency}">
                            ${item[config.displayField]} - $${item.report_price} ${item.report_currency}
                        </option>`
                    ).join('') : ''}
                </select>
                <div class="template-description mt-2 text-sm text-gray-600 hidden"></div>
            </div>
        </div>
    `;
}

// Text alanı oluştur
function createTextField(field, config) {
    return `
        <div class="accordion-item">
            <div class="accordion-header" data-field="${field}">
                <span>${config.title}</span>
                <i class="fas fa-chevron-down accordion-icon"></i>
            </div>
            <div class="accordion-content">
                <input type="text" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 form-field"
                       data-field="${field}"
                       placeholder="${config.placeholder || ''}">
            </div>
        </div>
    `;
}

// Field event listener'larını KESİN ÇÖZÜM - SADECE GEREKLİ DÜZELTMELER
function setupFieldEventListeners() {
    console.log('🔧 Field event listenerları kuruluyor...');
    
    // FORM DATA INITIALIZATION - SADECE BURAYA EKLE
    if (!window.formData) {
        window.formData = {};
        console.log('✅ window.formData setupFieldEventListeners içinde initialize edildi');
    }
    
    // 1. TÜM select elementlerini dinle - KESİN ÇÖZÜM
    document.addEventListener('change', function(e) {
        const target = e.target;
        
        if (target.tagName === 'SELECT') {
            const fieldName = target.getAttribute('data-field');
            if (fieldName) {
                window.formData[fieldName] = target.value; // SADECE formData -> window.formData
                console.log(`✅ SELECT ${fieldName} seçildi:`, target.value);
                updateCriteriaList();
            }
        }
    });
    
    // 2. TÜM input ve textarea'ları dinle
    document.addEventListener('input', function(e) {
        const target = e.target;
        
        if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') {
            const fieldName = target.getAttribute('data-field');
            if (fieldName && !target.classList.contains('search-input')) {
                window.formData[fieldName] = target.value; // SADECE formData -> window.formData
                console.log(`✅ INPUT ${fieldName} değişti:`, target.value);
                updateCriteriaList();
            }
        }
    });
    
    // 3. Arama yapılabilir dropdown'lar (mevcut kodunuz - DEĞİŞİKLİK YOK)
    document.querySelectorAll('.search-input').forEach(input => {
        input.addEventListener('input', debounce(function() {
            const field = this.getAttribute('data-field');
            const searchTerm = this.value.trim();
            const resultsContainer = this.parentElement.querySelector('.dropdown-results');
            const selectedContainer = this.closest('.accordion-content').querySelector('.selected-value');
            
            console.log(`🔍 ${field} arama:`, searchTerm);
            
            if (searchTerm.length < 2) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            let filteredResults = [];
            
            if (field === 'gtip') {
                if (!window.gtipCodes || window.gtipCodes.length === 0) {
                    resultsContainer.innerHTML = '<div class="p-3 text-red-500">GTIP verileri yüklenemedi</div>';
                    resultsContainer.classList.remove('hidden');
                    return;
                }
                
                filteredResults = window.gtipCodes.filter(item => 
                    item.code.toString().includes(searchTerm) || 
                    item.name.toLowerCase().includes(searchTerm.toLowerCase())
                ).slice(0, 8);
                
            } else if (field === 'amac' || field === 'derinlik') {
                const config = getFieldConfig(field);
                if (config && config.data) {
                    filteredResults = config.data.filter(item => 
                        item.name.toLowerCase().includes(searchTerm.toLowerCase())
                    ).slice(0, 6);
                }
            }
            
            if (filteredResults.length > 0) {
                resultsContainer.innerHTML = filteredResults.map(item => {
                    if (field === 'gtip') {
                        return `
                            <div class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 search-result-item" 
                                 data-value="${item.code}" 
                                 data-display="${item.code} - ${item.name}">
                                <div class="font-bold text-blue-700">${item.code}</div>
                                <div class="text-sm text-gray-700">${item.name}</div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 search-result-item" 
                                 data-value="${item.name}" 
                                 data-display="${item.name}">
                                <div class="font-medium">${item.name}</div>
                            </div>
                        `;
                    }
                }).join('');
                resultsContainer.classList.remove('hidden');
            } else {
                resultsContainer.innerHTML = '<div class="p-3 text-gray-500">Sonuç bulunamadı</div>';
                resultsContainer.classList.remove('hidden');
            }
        }, 300));
        
        input.addEventListener('focus', function() {
            const resultsContainer = this.parentElement.querySelector('.dropdown-results');
            if (this.value.trim().length > 0) {
                resultsContainer.classList.remove('hidden');
            }
        });
    });
    
    // 4. Dropdown sonuç tıklama (mevcut kodunuz - SADECE formData -> window.formData)
    document.addEventListener('click', function(e) {
        if (e.target.closest('.search-result-item')) {
            const resultItem = e.target.closest('.search-result-item');
            const value = resultItem.getAttribute('data-value');
            const display = resultItem.getAttribute('data-display');
            const resultsContainer = resultItem.closest('.dropdown-results');
            const input = resultsContainer.previousElementSibling;
            const field = input.getAttribute('data-field');
            const selectedContainer = input.closest('.accordion-content').querySelector('.selected-value');
            
            console.log(`✅ ${field} seçildi:`, value);
            
            window.formData[field] = value; // SADECE formData -> window.formData
            input.value = display;
            
            if (selectedContainer) {
                selectedContainer.querySelector('.selected-text').textContent = display;
                selectedContainer.classList.remove('hidden');
            }
            
            resultsContainer.classList.add('hidden');
            updateCriteriaList();
        }
        
        if (e.target.closest('.clear-selection')) {
            const button = e.target.closest('.clear-selection');
            const field = button.getAttribute('data-field');
            const input = document.getElementById(`${field}-search-input`);
            const selectedContainer = button.closest('.selected-value');
            
            window.formData[field] = ''; // SADECE formData -> window.formData
            if (input) input.value = '';
            if (selectedContainer) selectedContainer.classList.add('hidden');
            updateCriteriaList();
        }
        
        if (!e.target.closest('.search-input') && !e.target.closest('.dropdown-results')) {
            document.querySelectorAll('.dropdown-results').forEach(container => {
                container.classList.add('hidden');
            });
        }
    });
    
    console.log('✅ Tüm field listenerları kuruldu');
}
        
// Debounce fonksiyonu
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
        // Field config getter
function getFieldConfig(field) {
    const fieldConfigs = {
        amac: {
            data: [
                { id: 1, name: 'Yeni bir girişim pazara giriş stratejisi için kullanacağım' },
                { id: 2, name: 'Mevcut ürün/hizmeti geliştirmek için pazar analizi' },
                { id: 3, name: 'Yatırım kararı ve risk değerlendirmesi' },
                { id: 4, name: 'Rekabet analizi ve stratejik pozisyon belirleme' },
                { id: 5, name: 'Ürün fiyatlandırma ve pazarlama stratejisi geliştirme' }
            ]
        },
        derinlik: {
            data: [
                { id: 1, name: 'Çıktıyı yönetim sunumuna uygun şekilde 5-6 başlık altında rapor formatında hazırla' },
                { id: 2, name: 'Stratejik yönetim için detaylı analiz ve öneriler' },
                { id: 3, name: 'Yatırımcı sunumu için özet rapor ve finansal projeksiyonlar' },
                { id: 4, name: 'Operasyonel ekip için detaylı pazar ve rekabet analizi' }
            ]
        }
    };
    return fieldConfigs[field];
}

        // Field konfigürasyonları
const fieldConfigs = {
    dil: {
        title: 'Rapor Dili',
        type: 'dropdown',
        data: window.languages || [
            { id: 1, name: 'Türkçe', iso_code: 'tr' },
            { id: 2, name: 'İngilizce', iso_code: 'en' }
        ],
        displayField: 'name',
        valueField: 'iso_code'
    },
    ulke: {
        title: 'Hedef Ülke',
        type: 'dropdown',
        data: window.countries || [
            { id: 1, name: 'Türkiye', iso_code: 'TR' },
            { id: 2, name: 'Almanya', iso_code: 'DE' }
        ],
        displayField: 'name',
        valueField: 'name'
    },
    sektor: {
        title: 'Sektör',
        type: 'dropdown',
        data: window.sectors || [
            { id: 1, name: 'Gıda', code: 'FOOD' },
            { id: 2, name: 'Tekstil', code: 'TEXTILE' }
        ],
        displayField: 'name',
        valueField: 'name'
    },
    urun: {
        title: 'Ürün/Hizmet',
        type: 'text',
        placeholder: 'Örn: Domates Salçası, Tekstil Ürünleri...'
    },
    bolge: {
        title: 'Bölge',
        type: 'dropdown',
        data: [
            { name: 'Tüm Bölgeler' },
            { name: 'Doğu' },
            { name: 'Batı' },
            { name: 'Kuzey' },
            { name: 'Güney' }
        ],
        displayField: 'name',
        valueField: 'name'
    },
    gtip: {
        title: 'GTIP Kodu',
        type: 'searchable-dropdown',
        data: window.gtipCodes || [],
        displayField: 'name',
        valueField: 'code'
    },
    zaman: {
        title: 'Zaman Aralığı',
        type: 'text',
        placeholder: 'Örn: 2020-2024, Son 5 yıl...'
    },
    amac: {
        title: 'Analiz Amacı',
        type: 'searchable-dropdown',
        data: [
            { id: 1, name: 'Yeni bir girişim pazara giriş stratejisi için kullanacağım' },
            { id: 2, name: 'Mevcut ürün/hizmeti geliştirmek için pazar analizi' },
            { id: 3, name: 'Yatırım kararı ve risk değerlendirmesi' }
        ],
        displayField: 'name',
        valueField: 'name'
    },
    derinlik: {
        title: 'Analiz Derinliği',
        type: 'searchable-dropdown',
        data: [
            { id: 1, name: 'Çıktıyı yönetim sunumuna uygun şekilde 5-6 başlık altında rapor formatında hazırla' },
            { id: 2, name: 'Stratejik yönetim için detaylı analiz ve öneriler' },
            { id: 3, name: 'Yatırımcı sunumu için özet rapor ve finansal projeksiyonlar' }
        ],
        displayField: 'name',
        valueField: 'name'
    },
    rapor_turu: {
        title: 'Rapor Türü',
        type: 'hidden'
    }
};

 // Kriter listesini güncelle - DEBUG için
// Kriter listesini güncelle - DEBUG için
function updateCriteriaList() {
    const criteriaContainer = document.getElementById('criteria-items');
    const criteriaList = document.getElementById('criteria-list');
    
    if (!criteriaContainer || !criteriaList) {
        console.error('❌ Kriter containerları bulunamadı');
        return;
    }
    
    criteriaContainer.innerHTML = '';
    
    console.log('🔍 DEBUG - FormData durumu:', window.formData);
    console.log('🔍 DEBUG - dil değeri:', window.formData?.dil);
    
    let hasData = false;
    
    // GÜVENLİ ERİŞİM - window.formData kullan
    if (window.formData && typeof window.formData === 'object') {
        Object.entries(window.formData).forEach(([key, value]) => {
            if (value !== undefined && value !== null && value.toString().trim() !== '') {
                hasData = true;
                const title = getFieldTitle(key);
                criteriaContainer.innerHTML += `
                    <div class="criteria-item">
                        <strong>${title}:</strong> ${value}
                    </div>
                `;
                console.log(`✅ Kriter eklendi: ${title} = ${value}`);
            }
        });
    }
    
    if (hasData) {
        criteriaList.classList.remove('hidden');
        console.log('✅ Kriter listesi güncellendi');
    } else {
        criteriaList.classList.add('hidden');
        console.log('ℹ️ Kriter listesi boş');
    }
}
        // Field title'ları güncelle
function getFieldTitle(field) {
    const titles = {
        dil: 'Rapor Dili',
        ulke: 'Hedef Pazar Ülkesi', // Güncellendi
        sektor: 'Sektör',
        urun: 'Ürün/Hizmet',
        firma_adi: 'Firma Adı', // Eklendi
        bolge: 'Bölge',
        gtip: 'GTIP Kodu',
        zaman: 'Zaman Aralığı',
        amac: 'Analiz Amacı',
        derinlik: 'Analiz Derinliği',
        rapor_turu: 'Rapor Türü'
    };
    return titles[field] || field;
}
// Kullanıcı yönetimi değişkenleri
let currentUser = null;
let authToken = null;

// Kullanıcı yönetim sistemini başlat
function initializeAuthSystem() {
    checkExistingSession();
    setupAuthModals();
    setupProfileTabs();
}

c
        
// Kayıt işlemi
async function handleRegister(e) {
    e.preventDefault();
    
    const name = document.getElementById('register-name').value;
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const passwordConfirm = document.getElementById('register-password-confirm').value;
    
    if (password !== passwordConfirm) {
        alert('Şifreler eşleşmiyor!');
        return;
    }
    
    try {
        const { data, error } = await supabase.auth.signUp({
            email: email,
            password: password,
            options: {
                data: {
                    full_name: name
                }
            }
        });
        
        if (error) throw error;
        
        if (data.user) {
            // E-posta doğrulama göster
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('email-verification').classList.remove('hidden');
        }
        
    } catch (error) {
        alert('Kayıt hatası: ' + error.message);
    }
}
        
// Çıkış işlemi
function handleLogout() {
    supabase.auth.signOut();
    localStorage.removeItem('parenatrade_token');
    localStorage.removeItem('parenatrade_user');
    currentUser = null;
    authToken = null;
    updateUIForLoggedOutUser();
    document.getElementById('profile-modal').classList.add('hidden');
}

// UI güncelleme - Giriş yapılmış
function updateUIForLoggedInUser() {
    // Navbar'ı güncelle
    const navButtons = document.querySelector('.flex.space-x-3');
    if (navButtons) {
        navButtons.innerHTML = `
            <button id="profile-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm">
                <i class="fas fa-user mr-1"></i> Profilim
            </button>
            <button id="logout-nav-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 text-sm">
                Çıkış
            </button>
        `;
        
        document.getElementById('profile-btn').addEventListener('click', () => {
            document.getElementById('profile-modal').classList.remove('hidden');
        });
        
        document.getElementById('logout-nav-btn').addEventListener('click', handleLogout);
    }
}

// UI güncelleme - Çıkış yapılmış
function updateUIForLoggedOutUser() {
    const navButtons = document.querySelector('.flex.space-x-3');
    if (navButtons) {
        navButtons.innerHTML = `
            <a href="#" id="login-nav-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm">Giriş Yap</a>
            <a href="#" id="register-nav-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 text-sm">Kayıt Ol</a>
        `;
        
        document.getElementById('login-nav-btn').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('login-modal').classList.remove('hidden');
        });
        
        document.getElementById('register-nav-btn').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
        });
    }
}
        

// Profil tab'larını kur
function setupProfileTabs() {
    const tabs = document.querySelectorAll('.profile-tab');
    if (tabs.length === 0) {
        console.log('Profil tabları bulunamadı');
        return;
    }
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // Aktif tab'ı güncelle
            document.querySelectorAll('.profile-tab').forEach(t => {
                t.classList.remove('bg-indigo-100', 'text-indigo-700');
                t.classList.add('hover:bg-gray-100', 'text-gray-700');
            });
            
            this.classList.add('bg-indigo-100', 'text-indigo-700');
            this.classList.remove('hover:bg-gray-100', 'text-gray-700');
            
            // İçeriği göster
            const tabName = this.getAttribute('data-tab');
            document.querySelectorAll('.profile-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            const targetTab = document.getElementById(`tab-${tabName}`);
            if (targetTab) {
                targetTab.classList.remove('hidden');
                
                // Raporlar sekmesine tıklandığında raporları yükle
                if (tabName === 'reports') {
                    loadUserReports();
                }
            }
        });
    });
}
        
// Kullanıcı raporlarını yükle - SADE VE TEMİZ
async function loadUserReports() {
    if (!currentUser) {
        console.log('Kullanıcı girişi yok');
        return;
    }
    
    const reportsList = document.getElementById('user-reports-list');
    if (!reportsList) {
        console.log('reportsList elementi bulunamadı');
        return;
    }
    
    try {
        console.log('Kullanıcı raporları yükleniyor:', currentUser.id);
        
        const { data: reports, error } = await supabase
            .from('ai_reports')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });
        
        if (error) {
            console.error('Rapor yükleme hatası:', error);
            reportsList.innerHTML = '<p class="text-red-500 text-center py-4">Raporlar yüklenirken hata oluştu.</p>';
            return;
        }
        
        console.log('Yüklenen rapor sayısı:', reports?.length);
        
        if (!reports || reports.length === 0) {
            reportsList.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-file-pdf text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Henüz raporunuz bulunmamaktadır.</p>
                    <p class="text-gray-400 text-sm mt-2">Ödeme yaptıktan sonra raporlarınız burada görünecektir.</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        reports.forEach(report => {
            const createdDate = new Date(report.created_at).toLocaleDateString('tr-TR');
            const isPaid = report.status === 'completed' || report.status === 'paid';
            const canDownload = isPaid && report.pdf_url;
            
            html += `
                <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h5 class="font-semibold text-gray-800">${report.report_title || 'İsimsiz Rapor'}</h5>
                            <p class="text-sm text-gray-600 mt-1">
                                <i class="far fa-calendar mr-1"></i>${createdDate}
                            </p>
                            <div class="flex space-x-2 mt-2">
                                <span class="inline-block ${isPaid ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'} text-xs px-2 py-1 rounded">
                                    ${isPaid ? '✅ Ödeme Tamam' : '⏳ Beklemede'}
                                </span>
                                ${report.is_mock ? `
                                    <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">
                                        Demo Rapor
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                        <div class="flex space-x-2 ml-4">
                            ${canDownload ? `
                                <a href="${report.pdf_url}" target="_blank" 
                                   class="bg-green-500 text-white px-3 py-2 rounded text-sm hover:bg-green-600 transition flex items-center">
                                    <i class="fas fa-download mr-1"></i> PDF İndir
                                </a>
                            ` : `
                                <button class="bg-gray-300 text-gray-500 px-3 py-2 rounded text-sm cursor-not-allowed flex items-center" disabled>
                                    <i class="fas fa-download mr-1"></i> Ödeme Gerekli
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        });
        
        reportsList.innerHTML = html;
        
    } catch (error) {
        console.error('Raporlar yüklenirken hata:', error);
        reportsList.innerHTML = '<p class="text-red-500 text-center py-4">Raporlar yüklenirken hata oluştu.</p>';
    }
}
    

// Giriş sonrası siparişe devam et
function proceedWithOrder() {
    const pendingOrder = sessionStorage.getItem('pending_order');
    if (pendingOrder) {
        serviceCart = JSON.parse(pendingOrder);
        sessionStorage.removeItem('pending_order');
        updateAICart();
        proceedToPayment();
    }
}

// Ödeme sayfasına git
function proceedToPayment() {
    // Sepetteki raporları veritabanına kaydet
    saveReportsToDatabase().then(() => {
        // Ödeme sayfasına yönlendir
        window.location.href = '/ai/payment.html?cart=' + encodeURIComponent(JSON.stringify(serviceCart));
    });
}
        




// PDF indirme
function downloadPDF() {
    const pdfUrl = document.getElementById('pdf-iframe').src;
    if (pdfUrl) {
        const a = document.createElement('a');
        a.href = pdfUrl;
        a.download = `rapor_${Date.now()}.pdf`;
        a.click();
    }
}



// Örnek rapor kartlarına görüntüleme butonu ekle
function setupExampleReports() {
    document.querySelectorAll('#reports .bg-gray-50 button').forEach((button, index) => {
        button.addEventListener('click', function() {
            // Örnek rapor verisi
            const exampleReports = [
                {
                    id: 'example-1',
                    report_title: 'Romanya Domates Salçası Pazar Analizi',
                    report_content: `# Romanya Domates Salçası Pazar Analizi\n\n## Özet\nRomanya domates salçası pazarı büyüme potansiyeli yüksek bir pazardır...`,
                    created_at: new Date().toISOString(),
                    pdf_url: null
                },
                {
                    id: 'example-2', 
                    report_title: 'Bulgaristan Tekstil Ürünleri Pazar Analizi',
                    report_content: `# Bulgaristan Tekstil Ürünleri Pazar Analizi\n\n## Özet\nBulgaristan tekstil pazarı rekabetçi bir yapıya sahiptir...`,
                    created_at: new Date().toISOString(),
                    pdf_url: null
                }
            ];
            
            showExampleReport(exampleReports[index]);
        });
    });
}

// Örnek rapor göster
function showExampleReport(report) {
    document.getElementById('report-view-title').textContent = report.report_title;
    document.getElementById('report-content-display').innerHTML = formatReportContent(report.report_content);
    document.getElementById('report-created-date').textContent = new Date(report.created_at).toLocaleDateString('tr-TR');
    document.getElementById('report-status').textContent = 'Örnek Rapor';
    
    document.getElementById('download-pdf-btn').classList.add('hidden');
    document.getElementById('view-pdf-btn').classList.add('hidden');
    
    showContentView();
}

        
// Raporları veritabanına kaydet - GÜNCELLENDİ
async function saveReportsToDatabase() {
    if (!currentUser) return;
    
    for (const item of serviceCart) {
        if (!item.reportId) continue; // reportId yoksa atla
        
        try {
            const { error } = await supabase
                .from('ai_reports')
                .update({
                    user_id: currentUser.id,
                    status: 'pending_payment'
                })
                .eq('id', item.reportId);
            
            if (error) throw error;
            
        } catch (error) {
            console.error('Rapor güncelleme hatası:', error);
        }
    }
}


// ✅ YENİ - Gelişmiş prompt hazırlama (Sizin tasarımınıza uygun)
function prepareAdvancedPrompt(template, formData) {
    console.log('🎯 Gelişmiş prompt hazırlanıyor:', { template: template.report_name, formData });
    
    // Değişken mapping
    const variables = {
        dil: formData.dil?.trim() || 'Türkçe',
        ulke: formData.ulke?.trim() || 'Belirtilmemiş',
        sektor: formData.sektor?.trim() || 'Belirtilmemiş',
        urun: formData.urun?.trim() || 'Belirtilmemiş',
        bolge: formData.bolge?.trim() || 'Tüm Bölgeler',
        gtip: formData.gtip?.trim() || 'Belirtilmemiş',
        zaman: formData.zaman?.trim() || '2020-2025 ve güncel yıl',
        amac: formData.amac?.trim() || 'pazar analizi ve yatırım değerlendirmesi',
        derinlik: formData.derinlik?.trim() || 'yönetim sunumuna uygun şekilde hazırla',
        rapor_turu: formData.rapor_turu?.trim() || template.report_name
    };

    // ✅ SİZİN TASARIMINIZA UYGUN PROFESYONEL PROMPT
    const advancedPrompt = `
Sen bir uluslararası ticaret ve pazar araştırma uzmanısın. Benimle birlikte ${variables.urun} için detaylı pazar araştırması yapmak istiyorum.

Aşağıdaki başlıklar kapsamında derinlemesine analiz yapmanı istiyorum:

## Pazar Tanımı ve Genel Görünüm: 
Pazarın boyutu, büyüme oranları, tarihsel gelişimi ve geleceğe yönelik projeksiyonlar.

## Pazar Segmentasyonu: 
Coğrafi, demografik, psikografik ve davranışsal segmentler.

## Hedef Müşteri Profilleri (Buyer Persona): 
Temel ihtiyaçlar, karar alma davranışları, satın alma kriterleri.

## Rakip Analizi: 
Ana rakipler, pazardaki konumları, güçlü/zayıf yönleri, fiyatlama, dağıtım kanalları, farklılaştırıcı stratejiler.

## Trendler ve Fırsatlar: 
Teknolojik gelişmeler, regülasyon değişiklikleri, kültür/sosyal eğilimler, yeni iş modelleri.

## Tehditler ve Giriş Engelleri: 
Regülasyonlar, rekabet yoğunluğu, ikame ürünler, müşteri sadakati.

## Fiyatlandırma Dinamikleri: 
Ortalama fiyat aralıkları, fiyatlandırma modelleri, müşteri ödeme istekliliği.

## SWOT Analizi: 
Genel pazar için güçlü yönler, zayıf yönler, fırsatlar ve tehditler.

## Sonuç ve Öneriler: 
Stratejik pozisyonlama, potansiyel giriş stratejileri, farklılaşma noktaları.

**Araştırma Parametreleri:**
- Ülke/Bölge: ${variables.ulke} / ${variables.bolge}
- Sektör: ${variables.sektor}
- Ürün: ${variables.urun}
- GTIP: ${variables.gtip}
- Zaman Aralığı: ${variables.zaman}
- Analiz Amacı: ${variables.amac}
- Derinlik Düzeyi: ${variables.derinlik}

**Önemli Talimatlar:**
- Bilgileri mümkün olduğunca güncel kaynaklara dayanarak hazırla
- Gerektiğinde tablo ve madde işaretleri kullan
- Profesyonel, veri odaklı ve rapor formatında yaz
- Kullanılan kaynakları ve veri yıllarını belirt
- ${variables.derinlik}
    `.trim();

    console.log('✅ Gelişmiş Prompt Hazırlandı');
    return advancedPrompt;
}

async function generateAIReport() {
    console.log('🚀 Rapor oluşturma başlatılıyor...');
    
    // Validasyon - GÜVENLİ FORM DATA KONTROLÜ
    if (!window.selectedTemplate) {
        alert('❌ Lütfen rapor türü seçin.');
        return;
    }
    
    // Form data kontrolü - KESİN ÇÖZÜM
    if (!window.formData || typeof window.formData !== 'object') {
        console.error('❌ FormData tanımlı değil:', window.formData);
        alert('❌ Form verileri yüklenemedi. Lütfen sayfayı yenileyin.');
        return;
    }
    
    // Form validasyonu - GÜVENLİ
    const requiredFields = ['ulke', 'sektor', 'urun'];
    const missingFields = [];
    
    requiredFields.forEach(field => {
        // Güvenli erişim
        if (!window.formData[field] || String(window.formData[field]).trim() === '') {
            missingFields.push(getFieldTitle(field));
        }
    });
    
    if (missingFields.length > 0) {
        alert(`Lütfen aşağıdaki alanları doldurun:\n${missingFields.join('\n')}`);
        return;
    }
    
    const generateBtn = document.getElementById('generate-report-btn');
    const progressSection = document.getElementById('report-progress');
    
    // UI durumunu güncelle
    if (generateBtn) {
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Oluşturuluyor...';
    }
    if (progressSection) progressSection.classList.remove('hidden');
    updateProgress(20);

    try {
        // 1. Prompt'u doldur - GÜVENLİ
        const finalPrompt = fillPromptTemplate(window.selectedTemplate, window.formData);
        console.log('📝 Doldurulmuş prompt:', finalPrompt);
        
        if (!finalPrompt) {
            throw new Error('Prompt oluşturulamadı.');
        }
        
        updateProgress(40);

        // 2. API'ye gönder
        console.log('🌐 API çağrısı yapılıyor...');
        const response = await fetch('https://parenatrade.vercel.app/api/generate-report', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                prompt: finalPrompt,
                template: window.selectedTemplate.report_name,
                parameters: window.formData
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`API hatası: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        console.log('📨 API cevabı:', result);
        
        if (!result.success) {
            throw new Error(result.error || 'Rapor oluşturulamadı');
        }

        updateProgress(60);

        // 3. SUPABASE'E KAYDET - GÜVENLİ
        console.log('💾 Supabase\'e kaydediliyor...');
        const reportData = {
            template_id: window.selectedTemplate.id,
            report_title: window.selectedTemplate.report_name,
            report_prompt: finalPrompt,
            report_content: result.result,
            country: window.formData.ulke || null,
            sector: window.formData.sektor || null,
            product: window.formData.urun || null,
            region: window.formData.bolge || null,
            gtip: window.formData.gtip || null,
            period: window.formData.zaman || null,
            purpose: window.formData.amac || null,
            language: window.formData.dil || 'tr',
            depth: window.formData.derinlik || null,
            report_type: window.selectedTemplate.report_type,
            status: 'completed',
            user_id: window.currentUser?.id || null,
            report_price: window.selectedTemplate.report_price,
            currency: window.selectedTemplate.report_currency,
            created_at: new Date().toISOString()
        };

        console.log('📊 Kaydedilecek rapor verisi:', reportData);

        const { data: report, error } = await supabase
            .from('ai_reports')
            .insert(reportData)
            .select()
            .single();

        if (error) {
            console.error('❌ Supabase kayıt hatası:', error);
            // Hata durumunda bile devam et
        } else {
            console.log('✅ Rapor Supabase\'e kaydedildi:', report);
        }

        updateProgress(80);

        // 4. SEPETE EKLE - GÜVENLİ
        console.log('🎯 Selected Template Detayları:', {
            id: window.selectedTemplate.id,
            name: window.selectedTemplate.report_name,
            price: window.selectedTemplate.report_price,
            currency: window.selectedTemplate.report_currency
        });

        // Fiyat kontrolü - kesin çözüm
        const itemPrice = window.selectedTemplate.report_price !== undefined && 
                         window.selectedTemplate.report_price !== null && 
                         !isNaN(parseFloat(window.selectedTemplate.report_price)) 
            ? parseFloat(window.selectedTemplate.report_price) 
            : 199;

        const itemCurrency = window.selectedTemplate.report_currency || 'USD';
        const itemName = window.selectedTemplate.report_name || 'Pazar Raporu';

        const cartItem = {
            id: window.selectedTemplate.id,
            name: itemName,
            price: itemPrice,
            currency: itemCurrency,
            reportId: report?.id,
            type: 'report',
            template_data: window.selectedTemplate
        };

        console.log('🛒 Sepete eklenecek öğe:', cartItem);
        addToAICart(cartItem);

        updateProgress(100);

        // 5. Sonuçları göster
        const quickResult = document.getElementById('quick-analysis-result');
        if (quickResult) quickResult.classList.remove('hidden');
        
        // Başarı mesajı
        setTimeout(() => {
            if (progressSection) progressSection.classList.add('hidden');
            if (generateBtn) {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-search mr-2"></i> Rapor Oluştur';
            }
            
            console.log('✅ Rapor oluşturma işlemi tamamlandı');
            
        }, 2000);

    } catch (error) {
        console.error('❌ Rapor oluşturma hatası:', error);
        
        // UI'ı eski haline getir
        if (generateBtn) {
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="fas fa-search mr-2"></i> Rapor Oluştur';
        }
        if (progressSection) progressSection.classList.add('hidden');
        
        // Hata mesajını göster
        let errorMessage = 'Rapor oluşturulurken hata: ' + error.message;
        
        if (error.message.includes('API hatası: 405')) {
            errorMessage = 'API endpoint\'i geçici olarak kullanılamıyor. Lütfen daha sonra tekrar deneyin.';
        } else if (error.message.includes('Failed to fetch')) {
            errorMessage = 'İnternet bağlantınızı kontrol edin ve tekrar deneyin.';
        }
        
        alert('❌ ' + errorMessage);
    }
}
        
// Hata göster
function showError(message) {
    // Özel hata modal'ı veya alert
    alert('❌ ' + message);
}

// Başarı göster - BASİT  
function showSuccess(message) {
    alert('✅ ' + message);
}
        
// Hata loglama fonksiyonu
async function logError(error, context = {}) {
    try {
        await supabase
            .from('error_logs')
            .insert({
                error_message: error.message,
                error_stack: error.stack,
                context: context,
                user_id: window.currentUser?.id,
                url: window.location.href,
                created_at: new Date().toISOString()
            });
    } catch (logError) {
        console.error('Hata loglama başarısız:', logError);
    }
}
        
// Giriş işlemi - GÜNCELLENMİŞ
async function handleLogin(e) {
    e.preventDefault();
    
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    try {
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (error) throw error;
        
        if (data.user) {
            currentUser = data.user;
            authToken = data.session.access_token;
            
            // LocalStorage'a kaydet
            localStorage.setItem('parenatrade_token', authToken);
            localStorage.setItem('parenatrade_user', JSON.stringify(currentUser));
            
            // UI güncelle
            updateUIForLoggedInUser();
            
            // Modal'ı kapat
            document.getElementById('login-modal').classList.add('hidden');
            
            // BEKLEYEN RAPOR VARSA TAMAMLA
            const pendingReport = sessionStorage.getItem('pending_report_data');
            if (pendingReport) {
                const reportData = JSON.parse(pendingReport);
                sessionStorage.removeItem('pending_report_data');
                
                // Kullanıcıya bilgi ver
                alert('Giriş başarılı! Rapor oluşturma işlemini tamamlıyorum...');
                
                // Rapor oluşturma işlemini başlat
                await completePendingReport(reportData);
            } else {
                alert('Başarıyla giriş yapıldı!');
            }
        }
        
    } catch (error) {
        alert('Giriş hatası: ' + error.message);
    }
}

// Bekleyen raporu tamamla - TESTLİ
async function completePendingReport(reportData) {
    const { template, formData, finalPrompt } = reportData;
    
    // ÖNCE: API durumunu kontrol et
    const apiStatus = await testAPIEndpoint();
    
    if (!apiStatus) {
        showErrorModal(
            'Rapor Tamamlanamadı',
            'Önceden başlattığınız rapor oluşturma işlemi tamamlanamıyor.<br><br>' +
            'AI servisi geçici olarak kullanılamıyor. Lütfen daha sonra "Raporlarım" bölümünden tekrar deneyin.'
        );
        return;
    }

    try {
        // API çağrısı
        const response = await fetch('https://parenatrade.vercel.app/api/generate-report', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                prompt: finalPrompt,
                template: template.report_name,
                parameters: formData
            })
        });

        if (!response.ok) throw new Error(`API hatası: ${response.status}`);

        const result = await response.json();
        
        if (!result.success) throw new Error(result.error);

        // Supabase'e kaydet
        const reportDbData = {
            template_id: template.id,
            report_title: template.report_name,
            report_prompt: finalPrompt,
            report_content: result.result,
            country: formData.ulke || null,
            sector: formData.sektor || null,
            product: formData.urun || null,
            region: formData.bolge || null,
            gtip: formData.gtip || null,
            period: formData.zaman || null,
            purpose: formData.amac || null,
            language: formData.dil || null,
            depth: formData.derinlik || null,
            report_type: template.report_type,
            status: 'completed',
            user_id: currentUser.id,
            created_at: new Date().toISOString()
        };

        const { data: report, error } = await supabase
            .from('ai_reports')
            .insert(reportDbData)
            .select()
            .single();

        if (error) throw error;

        // Sepete ekle
        addToAICart(template, report.id);
        
        alert('✅ Rapor başarıyla oluşturuldu ve sepete eklendi!');

    } catch (error) {
        console.error('Bekleyen rapor tamamlama hatası:', error);
        showErrorModal(
            'Rapor Tamamlanamadı',
            'Giriş yaptınız ancak rapor oluşturma işlemi tamamlanamadı:<br><br>' +
            '• Hata: ' + error.message + '<br>' +
            '• Lütfen daha sonra "Raporlarım" bölümünden tekrar deneyin<br>' +
            '• Sorun devam ederse müşteri hizmetleri ile iletişime geçin'
        );
    }
}
        

                        
// Yardımcı fonksiyonlar
// İlerleme güncelle
function updateProgress(percent) {
    const progressFill = document.getElementById('progress-fill');
    const progressPercent = document.getElementById('progress-percent');
    
    if (progressFill && progressPercent) {
        progressFill.style.width = `${percent}%`;
        progressPercent.textContent = `${percent}%`;
    }
}
        

        // AI Raporunu Sepete Ekle
        function addToAICart(template, reportId) {
            const existingItem = serviceCart.find(item => item.id === template.id);
            
            if (!existingItem) {
                serviceCart.push({
                    id: template.id,
                    name: template.report_name,
                    price: template.report_price,
                    currency: template.report_currency,
                    reportId: reportId,
                    quantity: 1
                });
            }
            
            updateAICart();
        }

        function setupCartFunctionality() {
    // AI Rapor sepete ekleme
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-ai-report')) {
            const button = e.target;
            const template = aiReportTemplates.find(t => t.id === button.getAttribute('data-id'));
            
            if (template) {
                addToAICart(template);
            }
        }
    });

    // Sepeti tamamlama - GÜNCELLENMİŞ
document.getElementById('complete-ai-report-order').addEventListener('click', function() {
    if (serviceCart.length === 0) return;
    
    if (!currentUser) {
        // Kullanıcı giriş yapmamışsa login modal aç
        alert('Lütfen önce giriş yapın!');
        document.getElementById('login-modal').classList.remove('hidden');
        return;
    }
    
    // Kullanıcı giriş yapmışsa direkt ödeme
    proceedToPayment();
});

            // Hata ayıklama için Supabase bağlantısını kontrol et
        async function checkSupabaseConnection() {
            try {
                const { data, error } = await supabase
                    .from('ai_service_type')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    console.error('Supabase bağlantı hatası:', error);
                    return false;
                }
                
                console.log('Supabase bağlantısı başarılı');
                return true;
            } catch (error) {
                console.error('Supabase bağlantı testi hatası:', error);
                return false;
            }
        }

        // Sayfa yüklendiğinde bağlantıyı test et - GÜNCELLENDİ
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM yüklendi, uygulama başlatılıyor...');
            const isConnected = await checkSupabaseConnection();
            if (!isConnected) {
                console.warn('Supabase bağlantısı sorunlu, fallback modunda çalışılıyor');
            }
            
            // Sadece bir kere initialize et
            await initializeApp();
        });

        // Çift yüklenmeyi önlemek için ayrıca bir kontrol
        let initializationStarted = false;

        // Alternatif başlatma yöntemi
        if (!initializationStarted) {
            initializationStarted = true;
            document.addEventListener('DOMContentLoaded', initializeApp);
        }
        
        // İletişim formu
        document.getElementById('contact-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Burada Supabase'e iletişim formu kaydedilecek
            // Şimdilik sadece alert gösteriyoruz
            
            alert('Mesajınız başarıyla gönderildi. En kısa sürede size dönüş yapacağız.');
            this.reset();
        });
}
            
    </script>
</body>
</html>
