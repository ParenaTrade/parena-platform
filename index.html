<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParenaTrade – Akıllı Pazar & Finans Analiz Platformu</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            scroll-behavior: smooth;
            background-color: white;
        }
        .hero-gradient {
            background: linear-gradient(120deg, #1a56db 0%, #7c3aed 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .sector-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: #4f46e5;
        }
        .ai-feature {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .testimonial-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-left: 4px solid #4f46e5;
        }
        .partner-logo {
            filter: grayscale(100%);
            opacity: 0.7;
            transition: all 0.3s ease;
        }
        .partner-logo:hover {
            filter: grayscale(0%);
            opacity: 1;
        }
        .order-step {
            position: relative;
            padding-left: 3rem;
        }
        .order-step:before {
            content: attr(data-step);
            position: absolute;
            left: 0;
            top: 0;
            width: 2.5rem;
            height: 2.5rem;
            background: #4f46e5;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .order-summary-item {
            border-bottom: 1px solid #e2e8f0;
            padding: 0.75rem 0;
        }
        #order-confirmation {
            display: none;
        }
        .category-btn.active {
            background-color: #4f46e5;
            color: white;
        }
        .product-card {
            transition: all 0.3s ease;
        }
        .cart-item {
            border-bottom: 1px solid #e2e8f0;
            padding: 0.75rem 0;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .service-card {
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
        }
        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .voice-recorder {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
        }
        .voice-recorder:hover {
            transform: scale(1.05);
        }
        .voice-recorder.recording {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(79, 70, 229, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }
        .chat-bubble {
            background: #f8fafc;
            border-radius: 18px;
            padding: 12px 18px;
            margin: 10px 0;
            max-width: 80%;
            color: #1f2937;
            font-weight: 500;
            border: 1px solid #e5e7eb;
        }
        .chat-bubble.user {
            background: #4f46e5;
            color: white;
            margin-left: auto;
            font-weight: normal;
            border: none;
        }
        #chat-input {
            background: white;
            color: #1f2937;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }
        #chat-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        #ai-analysis .bg-white\\/10 {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #1f2937;
        }
        #chat-container {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            color: #1f2937;
        }
        #service-select {
            background: white;
            color: #1f2937;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }
        #service-select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        .form-field {
            background: white;
            color: #1f2937;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }
        .form-field:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        label {
            color: #374151;
            font-weight: 500;
        }
        .criteria-item {
            background: #f9fafb;
            border-left: 3px solid #4f46e5;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
            color: #1f2937;
        }
        .report-card {
            border-left: 4px solid #4f46e5;
            transition: all 0.3s ease;
        }
        .report-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            transition: width 0.3s ease;
        }
        
        /* YENİ EKLENEN STİLLER */
        .accordion-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        .accordion-header {
            background-color: #f9fafb;
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
        }
        .accordion-header:hover {
            background-color: #f3f4f6;
        }
        .accordion-header.active {
            background-color: #eef2ff;
            border-bottom: 1px solid #e5e7eb;
        }
        .accordion-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .accordion-content.open {
            padding: 16px;
            max-height: 500px;
        }
        .accordion-icon {
            transition: transform 0.3s ease;
        }
        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }
        .dynamic-form-fields {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
        }
        .dynamic-form-fields::-webkit-scrollbar {
            width: 6px;
        }
        .dynamic-form-fields::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .dynamic-form-fields::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }
        .dynamic-form-fields::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .prose {
    line-height: 1.6;
    color: #374151;
}

.prose h1 {
    font-size: 1.5rem;
    font-weight: bold;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
    color: #1f2937;
}

.prose h2 {
    font-size: 1.25rem;
    font-weight: bold;
    margin-top: 1.25rem;
    margin-bottom: 0.75rem;
    color: #1f2937;
}

.prose h3 {
    font-size: 1.125rem;
    font-weight: bold;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    color: #1f2937;
}

.prose ul {
    list-style-type: disc;
    margin-left: 1.5rem;
    margin-bottom: 1rem;
}

.prose li {
    margin-bottom: 0.25rem;
}

.prose strong {
    font-weight: bold;
    color: #1f2937;
}

.prose em {
    font-style: italic;
}
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <!-- Navbar -->
    <header class="bg-white shadow-md fixed w-full z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-blue-700 flex items-center">
                        <i class="fas fa-brain mr-2 text-indigo-600"></i>ParenaTrade
                    </h1>
                </div>
                
                <!-- Desktop Navigation -->
                <nav class="hidden md:flex space-x-8 items-center">
                    <a href="#ai-analysis" class="hover:text-blue-600 font-medium">AI Pazar Analizi</a>
                    <a href="#services" class="hover:text-blue-600 font-medium">Hizmet Paketleri</a>
                    <a href="#sectors" class="hover:text-blue-600 font-medium">Sektörler</a>
                    <a href="#reports" class="hover:text-blue-600 font-medium">Raporlar</a>
                    <a href="#partners" class="hover:text-blue-600 font-medium">Partnerler</a>
                    <a href="#contact" class="hover:text-blue-600 font-medium">İletişim</a>
                    <div class="flex space-x-3">
                        <a href="/ai/login.html" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm">Giriş Yap</a>
                        <a href="/ai/register.html" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 text-sm">Kayıt Ol</a>
                    </div>
                </nav>
                
                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button type="button" class="text-gray-500 hover:text-indigo-600 focus:outline-none" id="mobile-menu-button">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Mobile Navigation -->
            <div class="hidden py-4 border-t border-gray-200" id="mobile-menu">
                <div class="flex flex-col space-y-4">
                    <a href="#ai-analysis" class="hover:text-blue-600 font-medium">AI Pazar Analizi</a>
                    <a href="#services" class="hover:text-blue-600 font-medium">Hizmet Paketleri</a>
                    <a href="#sectors" class="hover:text-blue-600 font-medium">Sektörler</a>
                    <a href="#reports" class="hover:text-blue-600 font-medium">Raporlar</a>
                    <a href="#partners" class="hover:text-blue-600 font-medium">Partnerler</a>
                    <a href="#contact" class="hover:text-blue-600 font-medium">İletişim</a>
                    <div class="flex space-x-3 pt-2">
                        <a href="/ai/login.html" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm flex-1 text-center">Giriş Yap</a>
                        <a href="/ai/register.html" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 text-sm flex-1 text-center">Kayıt Ol</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- AI Analysis Section - GÜNCELLENDİ -->
    <section id="ai-analysis" class="pt-24 pb-16 hero-gradient text-white">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12">
                <h2 class="text-4xl md:text-5xl font-bold mb-6">AI Destekli Pazar Analizi</h2>
                <p class="text-xl mb-8">Firmanızı analiz ediyor, hedef pazarlarınız için detaylı raporlar oluşturuyoruz.</p>
            </div>
            
            <div class="grid md:grid-cols-2 gap-12">
                <!-- Firma Analiz Sohbeti Bölümü -->
                <div>
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-6">
                        <h3 class="text-2xl font-bold mb-4">Firma Analiz Sohbeti</h3>
                        
                        <!-- Hizmet Seçimi -->
                        <div class="mb-4">
                            <label class="block text-white mb-2">Firma Profili ve Hedefler</label>
                            <select id="service-select" class="w-full px-4 py-2 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">Hizmet seçin</option>
                                <!-- Hizmet türleri buraya dinamik olarak yüklenecek -->
                            </select>
                        </div>
                        
                        <div id="chat-container" class="h-80 overflow-y-auto mb-4 p-4 bg-black/20 rounded-lg">
                            <div class="chat-bubble">
                                <p>Merhaba, Parena Trade'e hoş geldiniz! Lütfen ilgilendiğiniz hizmeti seçin.</p>
                            </div>
                        </div>
                        
                        <div id="chat-input-area" class="hidden">
                            <div class="flex items-center justify-between mb-2">
                                <input type="text" id="chat-input" placeholder="Cevabınızı yazın..." class="flex-1 px-4 py-2 rounded-l-lg text-gray-900 focus:outline-none">
                                <button id="send-text" class="bg-indigo-600 px-4 py-2 text-white rounded-r-lg hover:bg-indigo-700">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                            <button id="go-back-btn" class="text-blue-300 hover:text-white text-sm mb-2 hidden">
                                ← Önceki soruya geri dön
                            </button>
                        </div>
                        
                        <div class="flex justify-center mt-4">
                            <div id="voice-recorder" class="voice-recorder">
                                <i class="fas fa-microphone text-white text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hızlı Pazar Sorgulama Bölümü - GÜNCELLENDİ -->
                <div>
                    <div class="bg-white rounded-2xl shadow-xl p-6 text-gray-900">
                        <h3 class="text-xl font-bold mb-4">Hızlı Pazar Sorgulama</h3>
                        
                        <!-- Rapor Türü Seçimi -->
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">Rapor Türü</label>
                            <select id="report-template-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                <option value="">Rapor türü seçin</option>
                                <!-- Dinamik olarak yüklenecek -->
                            </select>
                            <p id="template-description" class="text-sm text-gray-600 mt-2 hidden"></p>
                        </div>
                        
                        <!-- Dinamik Form Alanları - AKORDİYON MENÜ -->
                        <div id="dynamic-form-fields" class="dynamic-form-fields mb-4 hidden">
                            <!-- Akordiyon menü buraya dinamik olarak eklenecek -->
                        </div>
                        
                        <!-- Kriter Listesi -->
                        <div id="criteria-list" class="mb-4 hidden">
                            <h4 class="font-semibold mb-2">Sorgu Kriterleri:</h4>
                            <div id="criteria-items" class="space-y-2">
                                <!-- Kriterler buraya eklenecek -->
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div id="report-progress" class="mb-4 hidden">
                            <div class="flex justify-between text-sm mb-1">
                                <span>Rapor hazırlanıyor</span>
                                <span id="progress-percent">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <button id="generate-report-btn" class="w-full bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300 flex items-center justify-center hidden">
                            <i class="fas fa-search mr-2"></i> Rapor Oluştur
                        </button>
                        
                        <div id="quick-analysis-result" class="mt-6 hidden">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <h4 class="font-bold text-green-800 mb-2">Rapor Hazır!</h4>
                                <p class="text-green-700 mb-2">Raporunuz başarıyla oluşturuldu ve sepete eklendi.</p>
                                <button id="view-report-btn" class="bg-green-600 text-white px-4 py-1 rounded text-sm hover:bg-green-700">
                                    Raporu Görüntüle
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Stats Section -->
    <section class="py-12 bg-white">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8 text-center">
                <div>
                    <div class="stats-number">500+</div>
                    <p class="text-gray-600">Analiz Edilen Firma</p>
                </div>
                <div>
                    <div class="stats-number">80+</div>
                    <p class="text-gray-600">Hedef Ülke</p>
                </div>
                <div>
                    <div class="stats-number">1200+</div>
                    <p class="text-gray-600">Oluşturulan Rapor</p>
                </div>
                <div>
                    <div class="stats-number">15</div>
                    <p class="text-gray-600">Partner Kuruluş</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Services Section - GÜNCELLENDİ -->
    <section id="services" class="py-16 bg-gray-100">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12">
                <h2 class="text-3xl md:text-4xl font-bold mb-4">AI Rapor Paketlerimiz</h2>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">OpenAI destekli akıllı pazar analiz raporları</p>
            </div>
            
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8" id="ai-report-templates">
                <!-- Rapor şablonları buraya dinamik olarak yüklenecek -->
            </div>
            
            <!-- AI Rapor Sepeti -->
            <div class="mt-12 bg-white rounded-xl shadow-md p-6 max-w-2xl mx-auto">
                <h3 class="text-2xl font-bold mb-6 flex items-center">
                    <i class="fas fa-shopping-cart mr-3 text-indigo-600"></i> AI Rapor Sepetiniz
                </h3>
                
                <div id="ai-report-cart-items" class="mb-6">
                    <p class="text-gray-500 text-center py-4">Sepetinizde rapor bulunmamaktadır</p>
                </div>
                
                <div class="border-t border-gray-200 pt-4 mb-6">
                    <div class="flex justify-between text-lg font-bold">
                        <span>Toplam</span>
                        <span id="ai-report-cart-total" class="text-indigo-600">0 USD</span>
                    </div>
                </div>
                
                <button id="complete-ai-report-order" class="w-full bg-indigo-600 text-white font-semibold px-4 py-3 rounded-lg hover:bg-indigo-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Başvuruyu Tamamla
                </button>
            </div>
        </div>
    </section>

    <!-- Reports Section - EKLENDİ -->
    <section id="reports" class="py-16 bg-white">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12">
                <h2 class="text-3xl md:text-4xl font-bold mb-4">Örnek Pazar Raporları</h2>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">AI analizimizle oluşturduğumuz detaylı pazar raporlarından örnekler</p>
            </div>
            
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="bg-gray-50 p-6 rounded-xl report-card">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold">Romanya Domates Salçası</h3>
                            <p class="text-gray-600 text-sm">Gıda Sektörü</p>
                        </div>
                        <span class="bg-indigo-100 text-indigo-800 text-xs font-semibold px-2 py-1 rounded">Yeni</span>
                    </div>
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Rakip Sayısı:</span>
                            <span class="font-semibold">22</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ortalama İthalat Fiyatı:</span>
                            <span class="font-semibold">1.45 USD/kg</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Market Satış Fiyatı:</span>
                            <span class="font-semibold">2.99-3.60 USD/kg</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Tahmini Kar Marjı:</span>
                            <span class="font-semibold text-green-600">%40</span>
                        </div>
                    </div>
                    <button class="w-full bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300">
                        Raporu Görüntüle
                    </button>
                </div>
                
                <div class="bg-gray-50 p-6 rounded-xl report-card">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold">Bulgaristan Tekstil Ürünleri</h3>
                            <p class="text-gray-600 text-sm">Tekstil Sektörü</p>
                        </div>
                        <span class="bg-green-100 text-green-800 text-xs font-semibold px-2 py-1 rounded">Popüler</span>
                    </div>
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Rakip Sayısı:</span>
                            <span class="font-semibold">18</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ortalama İthalat Fiyatı:</span>
                            <span class="font-semibold">8.75 USD/m²</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Market Satış Fiyatı:</span>
                            <span class="font-semibold">12.50-15.00 USD/m²</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Tahmini Kar Marjı:</span>
                            <span class="font-semibold text-green-600">%35</span>
                        </div>
                    </div>
                    <button class="w-full bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300">
                        Raporu Görüntüle
                    </button>
                </div>
                
                <div class="bg-gray-50 p-6 rounded-xl report-card">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold">Gürcistan Plastik Ambalaj</h3>
                            <p class="text-gray-600 text-sm">Ambalaj Sektörü</p>
                        </div>
                        <span class="bg-yellow-100 text-yellow-800 text-xs font-semibold px-2 py-1 rounded">Fırsat</span>
                    </div>
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Rakip Sayısı:</span>
                            <span class="font-semibold">9</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ortalama İthalat Fiyatı:</span>
                            <span class="font-semibold">0.85 USD/kg</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Market Satış Fiyatı:</span>
                            <span class="font-semibold">1.45-1.80 USD/kg</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Tahmini Kar Marjı:</span>
                            <span class="font-semibold text-green-600">%52</span>
                        </div>
                    </div>
                    <button class="w-full bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300">
                        Raporu Görüntüle
                    </button>
                </div>
            </div>
            
            <div class="text-center mt-12">
                <a href="#ai-analysis" class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700 transition duration-300 inline-flex items-center">
                    <i class="fas fa-chart-line mr-2"></i> Kendi Pazar Analizinizi Yapın
                </a>
            </div>
        </div>
    </section>

    <!-- Partners Section - EKLENDİ -->
    <section id="partners" class="py-16 bg-gray-100">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12">
                <h2 class="text-3xl md:text-4xl font-bold mb-4">Partner Ağımız</h2>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">Küresel ticaret ağımıza dahil olan sektör liderleri</p>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-8 items-center">
                <div class="partner-logo flex justify-center">
                    <div class="h-16 w-32 bg-gray-200 rounded-lg flex items-center justify-center">
                        <span class="font-bold text-gray-500">DRIP CAPITAL</span>
                    </div>
                </div>
                <div class="partner-logo flex justify-center">
                    <div class="h-16 w-32 bg-gray-200 rounded-lg flex items-center justify-center">
                        <span class="font-bold text-gray-500">IMC GLOBAL</span>
                    </div>
                </div>
                <div class="partner-logo flex justify-center">
                    <div class="h-16 w-32 bg-gray-200 rounded-lg flex items-center justify-center">
                        <span class="font-bold text-gray-500">IBCCS</span>
                    </div>
                </div>
                <div class="partner-logo flex justify-center">
                    <div class="h-16 w-32 bg-gray-200 rounded-lg flex items-center justify-center">
                        <span class="font-bold text-gray-500">FIDULINK</span>
                    </div>
                </div>
                <div class="partner-logo flex justify-center">
                    <div class="h-16 w-32 bg-gray-200 rounded-lg flex items-center justify-center">
                        <span class="font-bold text-gray-500">CLEVVER</span>
                    </div>
                </div>
                <div class="partner-logo flex justify-center">
                    <div class="h-16 w-32 bg-gray-200 rounded-lg flex items-center justify-center">
                        <span class="font-bold text-gray-500">PANJIVA</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Contact Section - EKLENDİ -->
    <section id="contact" class="py-16 bg-white">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12">
                <h2 class="text-3xl md:text-4xl font-bold mb-4">İletişim</h2>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">Size özel çözümlerimiz hakkında bilgi almak için bizimle iletişime geçin</p>
            </div>
            
            <div class="grid md:grid-cols-2 gap-12">
                <div>
                    <h3 class="text-2xl font-bold mb-6">İletişim Bilgilerimiz</h3>
                    
                    <div class="flex items-start mb-6">
                        <div class="bg-indigo-100 p-3 rounded-lg mr-4">
                            <i class="fas fa-map-marker-alt text-indigo-600"></i>
                        </div>
                        <div>
                            <h4 class="font-bold">Adres</h4>
                            <p class="text-gray-600">Angisa Street 1 Line No: 59 <br> Batum</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start mb-6">
                        <div class="bg-indigo-100 p-3 rounded-lg mr-4">
                            <i class="fas fa-phone text-indigo-600"></i>
                        </div>
                        <div>
                            <h4 class="font-bold">Telefon</h4>
                            <p class="text-gray-600">+995 568 63 40 91</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start mb-6">
                        <div class="bg-indigo-100 p-3 rounded-lg mr-4">
                            <i class="fas fa-envelope text-indigo-600"></i>
                        </div>
                        <div>
                            <h4 class="font-bold">E-posta</h4>
                            <p class="text-gray-600">info@prenatrade.com</p>
                        </div>
                    </div>
                    
                    <div class="flex space-x-4 mt-8">
                        <a href="#" class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition duration-300">
                            <i class="fab fa-linkedin-in"></i>
                        </a>
                        <a href="#" class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition duration-300">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="#" class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition duration-300">
                            <i class="fab fa-instagram"></i>
                        </a>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-2xl font-bold mb-6">Mesaj Gönderin</h3>
                    
                    <form id="contact-form">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-gray-700 mb-2">Adınız</label>
                                <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">Soyadınız</label>
                                <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">E-posta</label>
                            <input type="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">Konu</label>
                            <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">Mesajınız</label>
                            <textarea rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required></textarea>
                        </div>
                        
                        <button type="submit" class="w-full bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300">
                            Mesajı Gönder
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Login Modal -->
<div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold">Giriş Yap</h3>
            <button id="close-login-modal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="login-form">
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">E-posta</label>
                <input type="email" id="login-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required autocomplete="email">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Şifre</label>
                <input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required autocomplete="current-password">

            </div>
            
            <div class="flex justify-between items-center mb-6">
                <label class="flex items-center">
                    <input type="checkbox" class="form-checkbox text-indigo-600">
                    <span class="ml-2 text-gray-700 text-sm">Beni hatırla</span>
                </label>
                <a href="#" class="text-indigo-600 text-sm hover:text-indigo-800">Şifremi unuttum</a>
            </div>
            
            <button type="submit" class="w-full bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300 mb-4">
                Giriş Yap
            </button>
            
            <div class="text-center">
                <span class="text-gray-600 text-sm">Hesabınız yok mu? </span>
                <a href="#" id="show-register" class="text-indigo-600 text-sm hover:text-indigo-800 font-semibold">Kayıt Ol</a>
            </div>
        </form>
        
        <form id="register-form" class="hidden">
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Ad Soyad</label>
                <input type="text" id="register-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required autocomplete="name">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">E-posta</label>
                <input type="email" id="register-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required autocomplete="email">
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Şifre</label>
                <input type="password" id="register-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required autocomplete="new-password">
            </div>
            
            <div class="mb-6">
                <label class="block text-gray-700 mb-2">Şifre Tekrar</label>
                <input type="password" id="register-password-confirm" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required autocomplete="new-password">
            </div>
            
            <button type="submit" class="w-full bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300 mb-4">
                Kayıt Ol
            </button>
            
            <div class="text-center">
                <span class="text-gray-600 text-sm">Zaten hesabınız var mı? </span>
                <a href="#" id="show-login" class="text-indigo-600 text-sm hover:text-indigo-800 font-semibold">Giriş Yap</a>
            </div>
        </form>
        
        <div id="email-verification" class="hidden text-center py-4">
            <div class="text-green-500 text-5xl mb-4">
                <i class="fas fa-envelope"></i>
            </div>
            <h3 class="text-xl font-bold mb-2">E-posta Doğrulama Gönderildi</h3>
            <p class="text-gray-600 mb-4">E-postanıza doğrulama linki gönderildi. Lütfen e-postanızı kontrol edin.</p>
            <button id="close-verification" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300">
                Tamam
            </button>
        </div>
    </div>
</div>

<!-- User Profile Modal -->
<div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold">Profilim</h3>
            <button id="close-profile-modal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="grid md:grid-cols-4 gap-6">
            <!-- Sidebar Menu -->
            <div class="md:col-span-1">
                <nav class="space-y-2">
                    <button class="w-full text-left px-4 py-2 rounded-lg bg-indigo-100 text-indigo-700 font-semibold profile-tab" data-tab="info">
                        <i class="fas fa-user mr-2"></i>Bilgilerim
                    </button>
                    <button class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-100 text-gray-700 profile-tab" data-tab="reports">
                        <i class="fas fa-chart-bar mr-2"></i>Raporlarım
                    </button>
                    <button class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-100 text-gray-700 profile-tab" data-tab="applications">
                        <i class="fas fa-file-alt mr-2"></i>Başvurularım
                    </button>
                    <button class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-100 text-gray-700 profile-tab" data-tab="payments">
                        <i class="fas fa-credit-card mr-2"></i>Ödemelerim
                    </button>
                    <button id="logout-btn" class="w-full text-left px-4 py-2 rounded-lg hover:bg-red-100 text-red-600 mt-4">
                        <i class="fas fa-sign-out-alt mr-2"></i>Çıkış
                    </button>
                </nav>
            </div>
            
            <!-- Content Area -->
            <div class="md:col-span-3">
                <!-- Bilgilerim -->
                <div id="tab-info" class="profile-tab-content">
                    <h4 class="text-lg font-semibold mb-4">Kişisel Bilgiler</h4>
                    <form id="profile-form">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-gray-700 mb-2">Ad</label>
                                <input type="text" id="profile-firstname" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">Soyad</label>
                                <input type="text" id="profile-lastname" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">E-posta</label>
                            <input type="email" id="profile-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" readonly>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">Telefon</label>
                            <input type="tel" id="profile-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">Firma Adı</label>
                            <input type="text" id="profile-company" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <button type="submit" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300">
                            Bilgileri Güncelle
                        </button>
                    </form>
                </div>
                
                <!-- Raporlarım -->
                <div id="tab-reports" class="profile-tab-content hidden">
                    <h4 class="text-lg font-semibold mb-4">Raporlarım</h4>
                    <div id="user-reports-list">
                        <div class="text-center py-8">
                            <i class="fas fa-file-pdf text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">Raporlarınız yükleniyor...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Başvurularım -->
                <div id="tab-applications" class="profile-tab-content hidden">
                    <h4 class="text-lg font-semibold mb-4">Başvurularım</h4>
                    <div class="text-center py-8">
                        <i class="fas fa-file-alt text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">Henüz başvurunuz bulunmamaktadır.</p>
                    </div>
                </div>
                
                <!-- Ödemelerim -->
                <div id="tab-payments" class="profile-tab-content hidden">
                    <h4 class="text-lg font-semibold mb-4">Ödemelerim</h4>
                    <div class="text-center py-8">
                        <i class="fas fa-credit-card text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">Henüz ödeme kaydınız bulunmamaktadır.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    <!-- Footer - EKLENDİ -->
    <footer class="bg-gray-800 text-white py-12">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-brain mr-2"></i>ParenaTrade
                    </h3>
                    <p class="text-gray-400">Türkiye üreticileri ve global yatırımcılar için veri, analiz ve finansmanı tek panelde birleştiren akıllı sistem.</p>
                </div>
                
                <div>
                    <h4 class="text-lg font-bold mb-4">Hızlı Bağlantılar</h4>
                    <ul class="space-y-2">
                        <li><a href="#ai-analysis" class="text-gray-400 hover:text-white transition duration-300">AI Pazar Analizi</a></li>
                        <li><a href="#services" class="text-gray-400 hover:text-white transition duration-300">Hizmet Paketleri</a></li>
                        <li><a href="#reports" class="text-gray-400 hover:text-white transition duration-300">Örnek Raporlar</a></li>
                        <li><a href="#partners" class="text-gray-400 hover:text-white transition duration-300">Partnerler</a></li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="text-lg font-bold mb-4">Hizmetlerimiz</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white transition duration-300">Lead Intelligence</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition duration-300">Şirket Kuruluşu</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition duration-300">İhracat Finansmanı</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition duration-300">Gümrük Veri API</a></li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="text-lg font-bold mb-4">Bültenimize Abone Olun</h4>
                    <p class="text-gray-400 mb-4">En son pazar analizleri ve fırsatlardan haberdar olun.</p>
                    <div class="flex">
                        <input type="email" placeholder="E-posta adresiniz" class="flex-1 px-4 py-2 rounded-l-lg text-gray-900 focus:outline-none">
                        <button class="bg-indigo-600 px-4 py-2 rounded-r-lg hover:bg-indigo-700 transition duration-300">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
                <p>&copy; 2023 ParenaTrade. Tüm hakları saklıdır.</p>
            </div>
        </div>
    </footer>

    <!-- Service Order Modal -->
    <div id="service-order-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">AI Rapor Başvurusu</h3>
                <button id="close-service-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="service-order-form">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Ad Soyad</label>
                    <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">E-posta</label>
                    <input type="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Telefon</label>
                    <input type="tel" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Firma Adı</label>
                    <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">Ek Notlar (Opsiyonel)</label>
                    <textarea rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
                
                <div class="flex space-x-3">
                    <button id="cancel-service-order" class="flex-1 bg-gray-200 text-gray-800 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300 transition duration-300">
                        İptal
                    </button>
                    <button id="submit-service-order" class="flex-1 bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300">
                        Ödemeye Geç
                    </button>
                </div>
            </div>
            
            <div id="order-confirmation" class="text-center py-4 hidden">
                <div class="text-green-500 text-5xl mb-4">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">Başvurunuz Alındı!</h3>
                <p class="text-gray-600 mb-4">En kısa sürede sizinle iletişime geçeceğiz.</p>
                <button id="close-confirmation" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300">
                    Tamam
                </button>
            </div>
        </div>
    </div>

    <script>
        // Supabase bağlantısı
        const supabaseUrl = "https://xliutvspwodhoaxvysks.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsaXV0dnNwd29kaG9heHZ5c2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTgyOTksImV4cCI6MjA3MjkzNDI5OX0.Zodisa_ifP8t2Q4X0ecnB56RiR_Bg4QS5gvPn5ZLK_w";
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Global değişkenler
        let aiReportTemplates = [];
        let selectedTemplate = null;
        let formData = {};
        let serviceCart = [];
        let currentService = null;
        let currentQuestionIndex = 0;
        let companyProfile = {};
        let serviceQuestions = [];
        let isInitialized = false;
        let activeAccordion = null;


// Değişken çıkarma fonksiyonunu güncelle
function extractVariables(prompt) {
    if (!prompt || typeof prompt !== 'string') {
        console.warn('⚠️ Geçersiz prompt:', prompt);
        return [];
    }
    
    console.log('🔍 Prompt analiz ediliyor:', prompt.substring(0, 100) + '...');
    
    const regexPatterns = [
        /\{\{(\w+)\}\}/g,        // {{degisken}}
        /%(\w+)%/g,              // %degisken%
    ];
    
    const matches = [];
    
    regexPatterns.forEach(pattern => {
        let match;
        while ((match = pattern.exec(prompt)) !== null) {
            // current_year'i filtrele
            if (match[1] !== 'current_year') {
                matches.push(match[1]);
            }
        }
    });
    
    // Firma bazlı rapor için özel değişkenler
    const knownVariables = ['dil', 'ulke', 'sektor', 'urun', 'firma_adi', 'bolge', 'gtip', 'zaman', 'amac', 'derinlik', 'rapor_turu'];
    knownVariables.forEach(variable => {
        if (prompt.includes(variable) && !matches.includes(variable)) {
            matches.push(variable);
        }
    });
    
    const uniqueVariables = [...new Set(matches)];
    console.log('🔍 Çıkarılan değişkenler:', uniqueVariables);
    
    return uniqueVariables;
}
        
// Sepete ekle fonksiyonunu düzelt - DYNAMIC ÇÖZÜM
function addToAICart(item) {
    console.log('➕ Sepete ekleniyor:', item);
    
    // TEMPLATE BULMA - DYNAMIC YAKLAŞIM
    let template = null;
    
    // 1. Önce item içinden template bul
    if (item.template_data) {
        template = item.template_data;
    } 
    // 2. Sonra selectedTemplate'den
    else if (window.selectedTemplate) {
        template = window.selectedTemplate;
    }
    // 3. Sonra global reportTemplates'den ara
    else if (window.reportTemplates && item.id) {
        template = window.reportTemplates.find(t => t.id === item.id);
    }
    // 4. En son item'ın kendisi template olabilir
    else if (item.report_name || item.report_price) {
        template = item;
    }

    console.log('🔍 Bulunan template:', template);

    // FİYAT HESAPLAMA - TEMPLATE ÖNCELİKLİ
    let price = 0;
    if (template && template.report_price !== undefined && template.report_price !== null && !isNaN(parseFloat(template.report_price))) {
        price = parseFloat(template.report_price);
    } else if (item.price !== undefined && item.price !== null && !isNaN(parseFloat(item.price))) {
        price = parseFloat(item.price);
    } else {
        // Varsayılan fiyatlar - sadece fallback olarak
        const defaultPrices = {
            'Kapsamlı Pazar Raporu': 199,
            'Firma Bazlı Pazar Raporu': 129, 
            'GTIP Bazlı Ticaret Raporu': 159
        };
        price = defaultPrices[item.name] || defaultPrices[item.report_name] || defaultPrices[template?.report_name] || 99;
    }

    // PARA BİRİMİ - TEMPLATE ÖNCELİKLİ
    let currency = 'USD';
    if (template && template.report_currency) {
        currency = template.report_currency;
    } else if (item.currency && item.currency !== 'undefined') {
        currency = item.currency;
    }

    // İSİM - TEMPLATE ÖNCELİKLİ
    let name = 'İsimsiz Ürün';
    if (template && template.report_name) {
        name = template.report_name;
    } else if (item.name && item.name !== 'undefined') {
        name = item.name;
    }

    // ID - TEMPLATE ÖNCELİKLİ
    let id = '';
    if (template && template.id) {
        id = template.id;
    } else if (item.id && item.id !== 'undefined') {
        id = item.id;
    } else {
        id = 'unknown_' + Date.now();
    }

    const validatedItem = {
        id: id,
        name: name,
        price: price,
        currency: currency,
        type: item.type || 'report',
        quantity: parseInt(item.quantity) || 1,
        profile: item.profile || null,
        service_type: item.service_type || null,
        reportId: item.reportId || null,
        template_data: template, // Template verisini sakla
        created_at: item.created_at || new Date().toISOString()
    };

    console.log('✅ Doğrulanmış öğe:', validatedItem);
    
    // Çift eklemeyi önle
    const existingIndex = serviceCart.findIndex(cartItem => 
        cartItem.id === validatedItem.id && cartItem.type === validatedItem.type
    );
    
    if (existingIndex === -1) {
        serviceCart.push(validatedItem);
    } else {
        serviceCart[existingIndex] = validatedItem;
    }
    
    updateAICart();
}

function updateAICart() {
    console.log('🛒 Sepet güncelleniyor:', serviceCart);
    
    const cartItems = document.getElementById('ai-report-cart-items');
    const cartTotal = document.getElementById('ai-report-cart-total');
    const completeBtn = document.getElementById('complete-ai-report-order');

    if (!cartItems) {
        console.error('❌ Sepet elementi bulunamadı');
        return;
    }

    if (serviceCart.length === 0) {
        cartItems.innerHTML = '<p class="text-gray-500 text-center py-4">Sepetinizde ürün bulunmamaktadır</p>';
        if (cartTotal) cartTotal.textContent = '0 USD';
        if (completeBtn) completeBtn.disabled = true;
        return;
    }

    let cartHTML = '';
    let total = 0;

    serviceCart.forEach((item, index) => {
        // GÜVENLİ DEĞER ALMA
        const itemName = item.name || 'İsimsiz Ürün';
        const itemPrice = parseFloat(item.price) || 0;
        const itemCurrency = item.currency || 'USD';
        const itemQuantity = parseInt(item.quantity) || 1;
        
        const itemTotal = itemPrice * itemQuantity;
        total += itemTotal;

        const isService = item.type === 'service';
        
        cartHTML += `
            <div class="cart-item border-b border-gray-200 pb-4 mb-4">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800">${itemName}</h4>
                        <p class="text-gray-600 text-sm mt-1">
                            ${itemPrice} ${itemCurrency} 
                        </p>
                        ${isService ? `
                            <p class="text-blue-600 text-xs mt-1">
                                <i class="fas fa-cog mr-1"></i>Hizmet
                            </p>
                        ` : `
                            <p class="text-green-600 text-xs mt-1">
                                <i class="fas fa-file-pdf mr-1"></i>Rapor
                            </p>
                        `}
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-bold text-gray-900">${itemTotal.toFixed(2)} ${itemCurrency}</span>
                        <button class="text-red-500 remove-ai-item hover:text-red-700 transition duration-200" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                ${isService && item.profile ? `
                    <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-100">
                        <strong class="text-blue-800 text-sm">Toplanan Bilgiler:</strong>
                        <div class="mt-2 space-y-1">
                            ${Object.entries(item.profile).map(([question, answer]) => 
                                `<div class="text-xs text-blue-700">• ${question}: ${answer}</div>`
                            ).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    });

    cartItems.innerHTML = cartHTML;
    
    // TOPLAM GÖSTERİMİ - GÜVENLİ
    const displayTotal = isNaN(total) ? 0 : total;
    const displayCurrency = serviceCart[0]?.currency || 'USD';
    
    if (cartTotal) cartTotal.textContent = `${displayTotal.toFixed(2)} ${displayCurrency}`;
    if (completeBtn) completeBtn.disabled = false;

    // Kaldırma butonları
    document.querySelectorAll('.remove-ai-item').forEach(button => {
        button.addEventListener('click', function() {
            const itemIndex = parseInt(this.getAttribute('data-index'));
            if (!isNaN(itemIndex) && itemIndex >= 0 && itemIndex < serviceCart.length) {
                serviceCart.splice(itemIndex, 1);
                updateAICart();
            }
        });
    });
}


        
// ÖNCE: Tüm yardımcı fonksiyonları tanımla
// ==============================================

// Hata modal'ı göster
function showErrorModal(title, message) {
    // Modal HTML'i
    const errorHTML = `
        <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <div class="flex items-center mb-4">
                    <div class="bg-red-100 p-3 rounded-full mr-4">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-red-700">${title}</h3>
                </div>
                <div class="mb-6">
                    <div class="prose prose-sm max-w-none">
                        ${message}
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeErrorModal()" class="bg-gray-300 text-gray-700 font-semibold px-4 py-2 rounded-lg hover:bg-gray-400 transition duration-300">
                        Kapat
                    </button>
                    <button onclick="contactSupport()" class="bg-red-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-700 transition duration-300">
                        Destek Al
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Eğer zaten bir hata modal'ı varsa kaldır
    const existingModal = document.getElementById('error-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Yeni modal'ı ekle
    document.body.insertAdjacentHTML('beforeend', errorHTML);
}

// Hata modal'ını kapat
function closeErrorModal() {
    const errorModal = document.getElementById('error-modal');
    if (errorModal) {
        errorModal.remove();
    }
}       

// Destek butonu fonksiyonu
function contactSupport() {
    window.location.href = 'mailto:info@parenatrade.com?subject=ParenaTrade Destek&body=Merhaba, AI rapor servisi ile ilgili yardıma ihtiyacım var.';
}
        
async function testAPIEndpoint() {
    try {
        console.log('🧪 API test ediliyor...');
        
        // Sadece HEAD isteği gönder - daha hızlı
        const response = await fetch('https://parenatrade.vercel.app/api/generate-report', {
            method: 'HEAD',
            signal: AbortSignal.timeout(3000) // 3 saniye
        });
        
        console.log('📡 API erişilebilir');
        return true;
        
    } catch (error) {
        if (error.name === 'AbortError') {
            console.log('⏰ API timeout (3s)');
        } else {
            console.log('❌ API erişilemiyor:', error.message);
        }
        return false;
    }
}
        
// API durumuna göre uyarı göster
async function showAPIStatusAlert() {
    const apiStatus = await testAPIEndpoint();
    
    if (!apiStatus) {
        // Sadece bir kere göster (spam'ı önle)
        if (!localStorage.getItem('api_alert_shown')) {
            setTimeout(() => {
                showErrorModal(
                    'AI Servisi Geçici Olarak Kullanılamıyor',
                    'AI rapor oluşturma servisi şu an teknik bir sorun nedeniyle kullanılamıyor.<br><br>' +
                    '• Lütfen birkaç dakika sonra tekrar deneyin<br>' +
                    '• Rapor oluşturma butonuna tıkladığınızda bu uyarıyı tekrar göreceksiniz<br>' +
                    '• Acil ihtiyaçlarınız için: info@parenatrade.com<br><br>' +
                    '<small>Bu mesaj sadece bir kere gösterilecektir.</small>'
                );
                localStorage.setItem('api_alert_shown', 'true');
            }, 2000);
        }
    } else {
        console.log('✅ API çalışıyor, normal işleme devam');
        // Çalışıyorsa alert kaydını temizle
        localStorage.removeItem('api_alert_shown');
    }
    
    return apiStatus;
}

        
// API uyarı sistemini iyileştir
function setupReportWarning() {
    const generateBtn = document.getElementById('generate-report-btn');
    if (generateBtn && !document.getElementById('api-warning')) {
        generateBtn.insertAdjacentHTML('beforebegin', `
            <div id="api-warning" class="bg-orange-50 border border-orange-200 rounded-lg p-3 mb-4">
                <div class="flex items-center">
                    <i class="fas fa-sync-alt text-orange-600 mr-2 animate-spin"></i>
                    <span class="text-orange-800 text-sm">
                        <strong>Servis Kontrolü:</strong> AI servisi test ediliyor...
                    </span>
                </div>
            </div>
        `);
        
        // API durumunu kontrol et ve uyarıyı güncelle
        setTimeout(async () => {
            const apiStatus = await checkAPIStatus();
            const warningElement = document.getElementById('api-warning');
            
            if (warningElement) {
                if (apiStatus) {
                    warningElement.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-600 mr-2"></i>
                            <span class="text-green-800 text-sm">
                                <strong>Servis Hazır:</strong> AI rapor oluşturma aktif
                            </span>
                        </div>
                    `;
                    warningElement.className = 'bg-green-50 border border-green-200 rounded-lg p-3 mb-4';
                } else {
                    warningElement.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                            <span class="text-red-800 text-sm">
                                <strong>Servis Bakımda:</strong> AI servisi geçici olarak kullanılamıyor
                            </span>
                        </div>
                    `;
                    warningElement.className = 'bg-red-50 border border-red-200 rounded-lg p-3 mb-4';
                }
            }
        }, 1000);
    }
}

// Eksik fonksiyonları ekleyelim
async function checkAPIStatus() {
    return await testAPIEndpoint();
}
        
// Rapor butonunu kur - hata düzeltmeli
function setupReportButton() {
    const generateBtn = document.getElementById('generate-report-btn');
    if (generateBtn) {
        // Butonun orijinal halini sakla
        if (!generateBtn.dataset.originalText) {
            generateBtn.dataset.originalText = generateBtn.innerHTML;
        }
        
        // API durumunu kontrol et ve butonu ayarla
        checkAPIStatus().then(apiStatus => {
            if (!apiStatus) {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i> Servis Bakımda';
                generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
                generateBtn.title = 'AI servisi şu an kullanılamıyor. Lütfen daha sonra tekrar deneyin.';
            } else {
                generateBtn.disabled = false;
                generateBtn.innerHTML = generateBtn.dataset.originalText;
                generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                generateBtn.title = 'AI raporu oluştur';
            }
        }).catch(error => {
            console.error('API kontrol hatası:', error);
            // Hata durumunda butonu devre dışı bırak
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i> Servis Kontrol Edilemiyor';
            generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
        });
    }
}
        
// Debug fonksiyonlarını basitleştirelim
async function debugServiceTypes() {
    try {
        const { data: services, error } = await supabase
            .from('ai_service_type')
            .select('id, service_name')
            .limit(3);
        
        if (!error && services) {
            console.log('🔍 ai_service_type tablosu:', services);
        }
    } catch (error) {
        console.error('Debug hatası:', error);
    }
}

async function debugServiceMatching() {
    try {
        const { data: questions, error } = await supabase
            .from('ai_question')
            .select('id, question, service_type_id, service_type')
            .limit(5);
            
        if (!error && questions) {
            console.log('🔍 ai_question tablosu:', questions);
        }
    } catch (error) {
        console.error('Debug hatası:', error);
    }
}

        
        // Modal İşlevselliği
function setupModalFunctionality() {
    // Modal kapatma
    const closeServiceModal = document.getElementById('close-service-modal');
    const cancelServiceOrder = document.getElementById('cancel-service-order');
    const submitServiceOrder = document.getElementById('submit-service-order');
    const closeConfirmation = document.getElementById('close-confirmation');

    if (closeServiceModal) {
        closeServiceModal.addEventListener('click', closeModal);
    }
    
    if (cancelServiceOrder) {
        cancelServiceOrder.addEventListener('click', closeModal);
    }

    // Sipariş gönderme
    if (submitServiceOrder) {
        submitServiceOrder.addEventListener('click', function() {
            // Burada ödeme sayfasına yönlendirme yapılacak
            window.location.href = 'https://parenatrade.vercel.app/ai/login.html';
        });
    }

    // Onay kapatma
    if (closeConfirmation) {
        closeConfirmation.addEventListener('click', closeModal);
    }
}

function closeModal() {
    const modal = document.getElementById('service-order-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Ana uygulama başlatma - FORM DATA INITIALIZATION EKLENDİ
async function initializeApp() {
    if (isInitialized) return;
    isInitialized = true;
    
    try {
        console.log('🔧 Temel sistemler başlatılıyor...');
        
        // 0. ÖNCE CRITICAL GLOBAL DEĞİŞKENLERİ INITIALIZE ET
        initializeGlobalVariables();
        
        // 1. ÖNCE verileri yükle
        await loadDropdownData();
        await loadServiceTypesSimple();
        await loadReportTemplates();
        
        // 2. SONRA UI bileşenlerini kur
        console.log('🎨 UI bileşenleri kuruluyor...');
        setupCompanyAnalysisChat();
        setupQuickReportForm();        // ✅ Bu form alanlarını oluşturur
        setupCartFunctionality();
        setupModalFunctionality();
        
        // 3. FORM ALANLARI OLUŞTUKTAN SONRA listener'ları kur
        console.log('🔧 Event listenerlar kuruluyor...');
        setupAccordionListeners();     // ✅ Artık çalışacak
        setupFieldEventListeners();    // ✅ Bu da çalışacak
        
        // 4. Diğer sistemler
        initializeAuthSystem();
        setupProfileTabs();
        setupReportWarning();
        setupReportButton();
        checkChatSession();
        
        console.log('✅ ParenaTrade uygulaması başarıyla başlatıldı');
        
    } catch (error) {
        console.error('❌ Uygulama başlatma hatası:', error);
    }
}

// GLOBAL DEĞİŞKENLERİ INITIALIZE ET
function initializeGlobalVariables() {
    console.log('🔧 Global değişkenler initialize ediliyor...');
    
    // FORM DATA - CRITICAL
    if (!window.formData || typeof window.formData !== 'object') {
        window.formData = {};
        console.log('✅ window.formData initialized:', window.formData);
    }
    
    // SELECTED TEMPLATE
    if (!window.selectedTemplate) {
        window.selectedTemplate = null;
        console.log('✅ window.selectedTemplate initialized');
    }
    
    // SERVICE CART
    if (!window.serviceCart || !Array.isArray(window.serviceCart)) {
        window.serviceCart = [];
        console.log('✅ window.serviceCart initialized:', window.serviceCart);
    }
    
    // CURRENT USER
    if (!window.currentUser) {
        window.currentUser = null;
        console.log('✅ window.currentUser initialized');
    }
    
    // REPORT TEMPLATES
    if (!window.reportTemplates) {
        window.reportTemplates = [];
        console.log('✅ window.reportTemplates initialized');
    }
    
    console.log('🎯 Global değişkenler başarıyla initialize edildi');
}

// FORM DATA INITIALIZATION İÇİN EXTRA GÜVENLİK
function initializeFormData() {
    // Mevcut formData'yı koru, yoksa oluştur
    if (!window.formData || typeof window.formData !== 'object') {
        window.formData = {};
    }
    
    // Required fields için default değerler
    const defaultFields = ['ulke', 'sektor', 'urun', 'dil', 'bolge', 'gtip', 'zaman', 'amac', 'derinlik'];
    
    defaultFields.forEach(field => {
        if (window.formData[field] === undefined) {
            window.formData[field] = '';
        }
    });
    
    console.log('✅ FormData güvenli initialize edildi:', window.formData);
    return window.formData;
}

// SETUP QUICK REPORT FORM'U GÜNCELLE
function setupQuickReportForm() {
    // Önce formData'yı initialize et
    initializeFormData();
    
    const templateSelect = document.getElementById('report-template-select');
    const generateBtn = document.getElementById('generate-report-btn');
    
    if (!templateSelect) {
        console.error('❌ Template select bulunamadı');
        return;
    }
    
    // Template değişim event'i
    templateSelect.addEventListener('change', function() {
        const templateId = this.value;
        console.log('🎯 Seçilen template:', templateId);
        
        if (!templateId) {
            // Temizleme
            window.selectedTemplate = null;
            document.getElementById('dynamic-form-fields').classList.add('hidden');
            document.getElementById('criteria-list').classList.add('hidden');
            if (generateBtn) generateBtn.classList.add('hidden');
            return;
        }
        
        // Global selectedTemplate'i güncelle
        window.selectedTemplate = window.reportTemplates?.find(t => t.id === templateId);
        console.log('🎯 Global selectedTemplate güncellendi:', window.selectedTemplate);
        
        if (window.selectedTemplate) {
            console.log('📊 Seçilen rapor:', window.selectedTemplate.report_name);
            
            // Template açıklamasını göster
            const descriptionElement = document.getElementById('template-description');
            if (descriptionElement && window.selectedTemplate.report_description) {
                descriptionElement.textContent = window.selectedTemplate.report_description;
                descriptionElement.classList.remove('hidden');
            }
            
            // FormData'yı temizle ve yeniden başlat
            initializeFormData();
            
            // Değişkenleri çıkar ve form oluştur
            const variables = extractVariables(window.selectedTemplate.report_prompt);
            createDynamicFormFields(variables);
            
            // Butonu göster
            if (generateBtn) {
                generateBtn.classList.remove('hidden');
                // Event listener'ı temizle ve yeniden ekle
                generateBtn.onclick = null;
                generateBtn.addEventListener('click', generateAIReport);
            }
            
        } else {
            console.error('❌ Template bulunamadı:', templateId);
        }
    });
    
    // Generate butonuna event listener ekle
    if (generateBtn) {
        generateBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Son formData kontrolü
            if (!window.formData) {
                initializeFormData();
            }
            
            generateAIReport();
        });
    }
    
    console.log('✅ Quick report form kuruldu');
}

// Tüm başlatma işlemleri tek bir DOMContentLoaded içinde
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 ParenaTrade - Uygulama başlatılıyor...');
    
    // ÖNCE global değişkenleri initialize et
    initializeGlobalVariables();
    
    // Ana uygulamayı başlat
    initializeApp();
    
    // Debug ve kontrol işlemleri - sıralı ve gecikmeli
    setTimeout(() => {
        checkTableStatus();
    }, 500);
    
    setTimeout(() => {
        debugServiceTypes();
    }, 1000);
    
    setTimeout(() => {
        debugServiceMatching();
    }, 1500);
    
    setTimeout(() => {
        checkSystemStatus();
    }, 2000);
    
    // API durum kontrolü
    setTimeout(() => {
        checkAPIStatus().then(status => {
            if (!status) {
                console.warn('⚠️ API servisi kullanılamıyor');
                // API uyarısını göster
                const apiWarning = document.getElementById('api-warning');
                if (apiWarning) {
                    apiWarning.classList.remove('hidden');
                }
            } else {
                console.log('✅ API servisi çalışıyor');
            }
        });
    }, 2500);
    
    // EXTRA: Sayfa yüklendikten sonra formData kontrolü
    setTimeout(() => {
        console.log('🔍 Final FormData Check:', {
            formData: window.formData,
            formDataType: typeof window.formData,
            selectedTemplate: window.selectedTemplate,
            serviceCart: window.serviceCart
        });
    }, 3000);
});

// ACİL DÜZELTME - Konsolda çalıştırılabilir
function emergencyFormDataFix() {
    console.log('🔄 Acil FormData düzeltmesi uygulanıyor...');
    
    window.formData = {};
    window.selectedTemplate = window.selectedTemplate || null;
    window.serviceCart = window.serviceCart || [];
    
    console.log('✅ Acil düzeltme tamamlandı:', {
        formData: window.formData,
        selectedTemplate: window.selectedTemplate,
        serviceCart: window.serviceCart
    });
    
    return 'FormData başarıyla initialize edildi!';
}

// Konsolda test için
function testFormData() {
    console.log('🧪 FormData Test:');
    console.log('- formData:', window.formData);
    console.log('- selectedTemplate:', window.selectedTemplate);
    console.log('- serviceCart:', window.serviceCart);
    console.log('- reportTemplates:', window.reportTemplates);
    
    if (!window.formData || typeof window.formData !== 'object') {
        console.log('❌ FormData hatalı! emergencyFormDataFix() çalıştırın.');
        return false;
    }
    
    console.log('✅ FormData testi başarılı!');
    return true;
}
    

        
// Sistem durumunu kontrol et - GÜNCELLENMİŞ
async function checkSystemStatus() {
    console.log('=== 🔍 SİSTEM DURUM KONTROLÜ ===');
    
    try {
        // 1. Service types kontrolü
        const { data: services, error: servicesError } = await supabase
            .from('ai_service_type')
            .select('id, service_name')
            .limit(5);
        
        console.log('📋 Service Types:', servicesError ? '❌ HATA' : `✅ ${services?.length} hizmet`);
        
        // 2. Questions kontrolü  
        const { data: questions, error: questionsError } = await supabase
            .from('ai_question')
            .select('id, question, service_type_id, service_type')
            .limit(5);
            
        console.log('📝 Questions:', questionsError ? '❌ HATA' : `✅ ${questions?.length} soru`);
        
        // 3. Tablo yapısı
        await detectTableStructure();
        
        console.log('✅ Sistem durumu: STABIL');
        
    } catch (error) {
        console.error('❌ Sistem kontrol hatası:', error);
    }
}

// Basit tablo yapısı kontrolü
async function detectTableStructure() {
    try {
        console.log('🔍 Tablo yapısı kontrol ediliyor...');
        
        // Basit bir test sorgusu
        const { data, error } = await supabase
            .from('ai_question')
            .select('service_type_id, service_type')
            .limit(1);
        
        if (error) {
            console.warn('Tablo yapısı kontrol edilemedi:', error);
            return 'service_type';
        }
        
        return 'service_type_id'; // Varsayılan olarak service_type_id kullan
        
    } catch (error) {
        console.error('Tablo yapısı kontrol hatası:', error);
        return 'service_type';
    }
}        

// Tablo durumunu kontrol et - GÜNCELLENMİŞ
async function checkTableStatus() {
    try {
        console.log('=== 📊 TABLO DURUM KONTROLÜ ===');
        
        // 1. ai_service_type kontrolü
        const { data: services, count: serviceCount, error: serviceError } = await supabase
            .from('ai_service_type')
            .select('*', { count: 'exact' });
        
        console.log('📋 ai_service_type:');
        console.log('- Count:', serviceCount);
        console.log('- Error:', serviceError);
        console.log('- Status:', serviceError ? '❌' : '✅');
        
        // 2. ai_question kontrolü
        const { data: questions, count: questionCount, error: questionError } = await supabase
            .from('ai_question')
            .select('*', { count: 'exact' })
            .limit(5);
            
        console.log('📝 ai_question:');
        console.log('- Count:', questionCount);
        console.log('- Error:', questionError);
        console.log('- Status:', questionError ? '❌' : '✅');
        
        // 3. Eşleşme kontrolü
        if (services && questions) {
            const serviceIds = services.map(s => s.id);
            const matchingQuestions = questions.filter(q => 
                serviceIds.includes(q.service_type_id)
            );
            console.log('🔗 Eşleşen sorular:', matchingQuestions.length);
        }
        
    } catch (error) {
        console.error('❌ Tablo kontrol hatası:', error);
    }
}

// Çift yüklenmeyi önlemek için global kontrol
if (window.parenaTradeInitialized) {
    console.log('ℹ️ ParenaTrade zaten yüklenmiş');
} else {
    window.parenaTradeInitialized = true;
    // Yukarıdaki tek DOMContentLoaded listener burada olacak
}            
                
        // Global değişken - veri yüklendi mi takip et
        let serviceTypesLoaded = false;

        // En basit ve güvenli yöntem
        async function loadServiceTypesSimple() {
            try {
                console.log('🔍 Hizmet türleri yükleniyor...');
                
                const { data, error } = await supabase
                    .from('ai_service_type')
                    .select('id, service_name, sort_code')
                    .order('sort_code');
                
                if (error) throw error;
                
                // EN BASİT YOL: data varsa işle
                if (!data || data.length === 0) {
                    console.error('❌ Tablo boş');
                    return false;
                }
                
                const serviceSelect = document.getElementById('service-select');
                serviceSelect.innerHTML = '<option value="">Hizmet seçin</option>';
                
                data.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.id;
                    option.textContent = service.service_name;
                    serviceSelect.appendChild(option);
                });
                
                console.log(`✅ ${data.length} hizmet türü yüklendi`);
                return true;
                
            } catch (error) {
                console.error('❌ Hizmet türleri yüklenirken hata:', error);
                return false;
            }
        }
                
        // 2. SELECT DEĞİŞİMİ için - farklı fonksiyon
        async function handleServiceQuestions(selectedServiceId) {
            try {
                console.log('🔍 Sorular yükleniyor, serviceId:', selectedServiceId);
                
                if (!selectedServiceId) {
                    throw new Error('Geçersiz service ID');
                }
                
                // Konsola göre: hem service_type_id HEM service_type var
                // service_type_id: UUID (f3c8c3b7-5cd9-4579-b26d-3b757334fc3b)
                // service_type: string ('hedef_ulke_rapor')
                
                let query = supabase
                    .from('ai_question')
                    .select('id, question, flow_number, service_type_id, service_type')
                    .eq('is_active', true)
                    .order('flow_number');
                
                // ÖNCE: UUID ile eşleştirmeyi dene (gerçek ID)
                query = query.eq('service_type_id', selectedServiceId);
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    serviceQuestions = data;
                    console.log(`✅ ${data.length} soru yüklendi (UUID eşleşmesi)`);
                    return data;
                }
                
                // Eğer UUID ile eşleşme yoksa, FALLBACK ID'ler için string eşleştirme yap
                console.log('UUID eşleşmesi bulunamadı, fallback deneniyor...');
                
                const fallbackQuery = supabase
                    .from('ai_question')
                    .select('id, question, flow_number, service_type_id, service_type')
                    .eq('service_type', selectedServiceId)
                    .eq('is_active', true)
                    .order('flow_number');
                    
                const { data: fallbackData, error: fallbackError } = await fallbackQuery;
                
                if (fallbackError) throw fallbackError;
                
                if (fallbackData && fallbackData.length > 0) {
                    serviceQuestions = fallbackData;
                    console.log(`✅ ${fallbackData.length} soru yüklendi (string eşleşmesi)`);
                    return fallbackData;
                }
                
                throw new Error('Bu hizmet için soru bulunamadı');
                
            } catch (error) {
                console.error('❌ Sorular yüklenemedi:', error);
                throw error;
            }
        }
                
        // Varsayılan hizmet türleri - SADECE GERÇEK İHTİYAÇ DURUMUNDA
        function loadDefaultServices() {
            const serviceSelect = document.getElementById('service-select');
            
            // Sadece boşsa ekle
            if (serviceSelect.children.length > 1) {
                console.log('Fallback: Hizmet türleri zaten var, eklenmedi');
                return;
            }
            
            const defaultServices = [
                { id: 'hedef_ulke_rapor', service_name: 'Hedef Ülke Kapsamlı Rapor' },
                { id: 'firma_kurulus', service_name: 'Firma Kuruluşu' },
                { id: 'banka_hesap', service_name: 'Banka Hesabı Açılışı' },
                { id: 'muhasebe', service_name: 'Muhasebe İşlemleri' },
                { id: 'ihracat_kredileri', service_name: 'İhracat Kredileri' }
            ];
            
            defaultServices.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id;
                option.textContent = service.service_name;
                serviceSelect.appendChild(option);
            });
            
            console.log('⚠️ Fallback hizmet türleri yüklendi');
        }        
  

// Rapor şablonlarını yükle - FİYAT KONTROLÜ
async function loadReportTemplates() {
    try {
        console.log('📊 Rapor şablonları yükleniyor...');
        
        const { data: templates, error } = await supabase
            .from('ai_report_templates')
            .select('*')
            .order('report_name');
        
        if (error) {
            console.error('❌ Rapor şablonları yüklenemedi:', error);
            return;
        }
        
        if (!templates || templates.length === 0) {
            console.error('❌ Rapor şablonu bulunamadı');
            return;
        }
        
        aiReportTemplates = templates;
        window.reportTemplates = templates;
        
        // Template select'i doldur
        const templateSelect = document.getElementById('report-template-select');
        templateSelect.innerHTML = '<option value="">Rapor türü seçin</option>';
        
        templates.forEach(template => {
            const option = document.createElement('option');
            option.value = template.id;
            option.textContent = `${template.report_name} - $${template.report_price || 0} ${template.report_currency || 'USD'}`;
            option.setAttribute('data-description', template.report_description);
            templateSelect.appendChild(option);
        });
        
        console.log(`✅ ${templates.length} rapor şablonu yüklendi:`, templates.map(t => ({
            name: t.report_name,
            price: t.report_price,
            currency: t.report_currency
        })));
        
    } catch (error) {
        console.error('❌ Rapor şablonları yüklenirken hata:', error);
    }
}
        
// Hizmet paketlerini yükle - GÜNCELLENMİŞ
function loadServicePackages() {
    const packagesContainer = document.getElementById('ai-report-templates');
    
    if (!packagesContainer) {
        console.error('❌ Packages container bulunamadı');
        return;
    }

    // Eğer zaten yüklenmişse temizle
    packagesContainer.innerHTML = '';
    
    aiReportTemplates.forEach(template => {
        const packageHTML = `
            <div class="bg-white rounded-xl shadow-md service-card">
                <div class="p-6 border-b border-gray-200">
                    <div class="sector-icon text-center">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2 text-center">${template.report_name}</h3>
                    <p class="text-gray-600 text-center mb-4">${template.report_description}</p>
                    <div class="text-center mb-4">
                        <span class="text-3xl font-bold text-indigo-600">$${template.report_price}</span>
                        <span class="text-gray-500">${template.report_currency}</span>
                    </div>
                </div>
                <div class="p-6">
                    <ul class="space-y-3 mb-6">
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            <span>AI destekli analiz</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            <span>Detaylı pazar verileri</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            <span>Rakip analizi</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            <span>Fiyat trendleri</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            <span>Stratejik öneriler</span>
                        </li>
                    </ul>
                    <button class="w-full bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300 add-ai-report" 
                            data-id="${template.id}" 
                            data-name="${template.report_name}" 
                            data-price="${template.report_price}">
                        Sepete Ekle
                    </button>
                </div>
            </div>
        `;
        packagesContainer.innerHTML += packageHTML;
    });

    console.log('✅ Hizmet paketleri yüklendi');
}


        
        // Mesajı sohbete ekle
        function addMessageToChat(message, isUser = false) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-bubble ${isUser ? 'user' : ''}`;
            messageDiv.innerHTML = `<p>${message}</p>`;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Firma Analiz Sohbeti - GÜNCELLENMİŞ
function setupCompanyAnalysisChat() {
    const serviceSelect = document.getElementById('service-select');
    const chatInput = document.getElementById('chat-input');
    const sendTextButton = document.getElementById('send-text');
    const goBackBtn = document.getElementById('go-back-btn');
    const chatInputArea = document.getElementById('chat-input-area');

    // Event listener'ları temizle ve yeniden ekle
    serviceSelect.addEventListener('change', handleServiceChange);
    sendTextButton.addEventListener('click', handleAnswerSubmit);
    goBackBtn.addEventListener('click', handleGoBack);
    
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            handleAnswerSubmit();
        }
    });

    async function handleServiceChange() {
        const selectedServiceId = this.value;
        const chatInputArea = document.getElementById('chat-input-area');
        const goBackBtn = document.getElementById('go-back-btn');
        
        if (!selectedServiceId) {
            chatInputArea.classList.add('hidden');
            addMessageToChat("Lütfen ilgilendiğiniz hizmeti seçin.");
            return;
        }

        try {
            currentService = selectedServiceId;
            currentQuestionIndex = 0;
            companyProfile[selectedServiceId] = {};
            
            // Sohbeti temizle (ilk mesaj hariç)
            const chatContainer = document.getElementById('chat-container');
            const initialMessage = chatContainer.querySelector('.chat-bubble:first-child');
            chatContainer.innerHTML = '';
            if (initialMessage) chatContainer.appendChild(initialMessage);
            
            const selectedServiceName = this.options[this.selectedIndex].text;
            addMessageToChat(`"${selectedServiceName}" hizmeti için analiz başlatılıyor...`);
            
            // Soruları yükle
            await loadServiceQuestionsAdvanced(selectedServiceId);
            
            if (serviceQuestions.length > 0) {
                setTimeout(() => {
                    addMessageToChat(serviceQuestions[0].question);
                    chatInputArea.classList.remove('hidden');
                    goBackBtn.classList.add('hidden');
                }, 1000);
            }
            
        } catch (error) {
            console.error('❌ Hizmet değişim hatası:', error);
            addMessageToChat("❌ " + error.message);
        }
    }
    
    function handleGoBack() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            const previousQuestion = serviceQuestions[currentQuestionIndex].question;
            
            // Sohbeti düzenle
            const chatContainer = document.getElementById('chat-container');
            const messages = chatContainer.querySelectorAll('.chat-bubble');
            if (messages.length >= 2) {
                chatContainer.removeChild(messages[messages.length - 1]);
                chatContainer.removeChild(messages[messages.length - 2]);
            }
            
            // Önceki soruyu tekrar sor
            addMessageToChat(previousQuestion);
            goBackBtn.classList.toggle('hidden', currentQuestionIndex === 0);
            
            // Form alanını temizle
            chatInput.value = '';
        }
    }
}
        // 4. Tablo verisini debug için göster
             
          // Hizmet sorularını yükle - TABLO YAPISINA UYGUN
        async function loadServiceQuestions(serviceId) {
            try {
                console.log('🔍 Sorular yükleniyor, serviceId:', serviceId);
                
                if (!serviceId) {
                    throw new Error('Geçersiz service ID');
                }
                
                // ÖNEMLİ: Tablo yapınıza göre sorguyu ayarlayın
                let query = supabase
                    .from('ai_question')
                    .select('id, question, flow_number, service_type_id, service_type')
                    .eq('is_active', true)
                    .order('flow_number');
                
                // HANGİ ALAN İLE EŞLEŞTİRME YAPACAĞIZ?
                // Seçenek 1: service_type_id kullan
                query = query.eq('service_type_id', serviceId);
                
                // VEYA Seçenek 2: service_type kullan (string eşleşme)
                // query = query.eq('service_type', serviceId);
                
                const { data, error } = await query;
                
                if (error) {
                    console.error('❌ Sorular yüklenemedi:', error);
                    throw error;
                }
                
                if (!data || data.length === 0) {
                    console.warn(`⚠️ ${serviceId} için soru bulunamadı`);
                    throw new Error('Bu hizmet için henüz soru bulunmamaktadır');
                }
                
                serviceQuestions = data;
                console.log(`✅ ${data.length} soru yüklendi:`, data);
                
            } catch (error) {
                console.error('❌ Sorular yüklenirken hata:', error);
                throw error; // Hata yukarı fırlatılsın
            }
        }
   
        // Güncellenmiş soru yükleme fonksiyonu
        let tableStructure = null;

        // Hizmet sorularını yükle - GÜNCELLENMİŞ (debug ekle)
async function loadServiceQuestionsAdvanced(serviceId) {
    try {
        console.log('🔍 Sorular yükleniyor, serviceId:', serviceId);
        
        if (!serviceId) throw new Error('Geçersiz service ID');
        
        // Hizmet detaylarını da al
        const { data: serviceDetails, error: serviceError } = await supabase
            .from('ai_service_type')
            .select('service_name, sort_code, service_price, currency')
            .eq('id', serviceId)
            .single();
            
        if (serviceError) throw serviceError;
        
        console.log('📋 Hizmet detayları:', serviceDetails);
        
        // Soruları yükle
        let { data, error } = await supabase
            .from('ai_question')
            .select('id, question, flow_number, service_type_id, service_type')
            .eq('service_type_id', serviceId)
            .eq('is_active', true)
            .order('flow_number');
        
        if (error) throw error;
        
        // Eğer soru bulunamazsa, hizmet türüne göre demo sorular oluştur
        if (!data || data.length === 0) {
            console.warn(`⚠️ ${serviceId} için soru bulunamadı, demo sorular oluşturuluyor`);
            data = generateDemoQuestions(serviceDetails.sort_code || serviceId);
        }
        
        serviceQuestions = data;
        console.log(`✅ ${data.length} soru yüklendi`);
        return data;
        
    } catch (error) {
        console.error('❌ Sorular yüklenemedi:', error);
        throw error;
    }
}


        // Demo sorular oluştur - GÜNCELLENMİŞ
function generateDemoQuestions(serviceType) {
    const serviceDemoQuestions = {
        'hedef_ulke_rapor': [
            "Hangi ülkelerde pazar araştırması yapmak istiyorsunuz?",
            "Hangi sektörde faaliyet gösteriyorsunuz?",
            "Hedef pazar büyüklüğünüz nedir?",
            "Rakip analizi yapmak istediğiniz firmalar var mı?",
            "Raporun hangi dilde hazırlanmasını istersiniz?"
        ],
        'firma_kurulus': [
            "Firmanızın adı ne olacak?",
            "Hangi ülkede firma kurmak istiyorsunuz?",
            "Firma türünüz ne olacak? (Limited, A.Ş., vb.)",
            "Sermaye miktarınız nedir?",
            "Faaliyet konunuz nedir?"
        ],
        'banka_hesap': [
            "Hangi ülkede banka hesabı açmak istiyorsunuz?",
            "Hesap türü ne olacak? (Bireysel/Kurumsal)",
            "Hangi para birimlerinde hesap gerekiyor?",
            "Aylık ortalama işlem hacminiz nedir?",
            "Öncelikli banka tercihleriniz nelerdir?"
        ],
        'muhasebe': [
            "Hangi ülkede muhasebe hizmeti almak istiyorsunuz?",
            "Firma türünüz nedir?",
            "Aylık ortalama işlem sayınız nedir?",
            "Özel muhasebe gereksinimleriniz var mı?",
            "Tercih ettiğiniz muhasebe programı var mı?"
        ],
        'ihracat_kredileri': [
            "İhracat yapmayı planladığınız ülke nedir?",
            "İhracat tutarı ne kadar olacak?",
            "İhracat ürününüz nedir?",
            "Vade süresi tercihiniz nedir?",
            "Teminat imkanlarınız nelerdir?"
        ]
    };
    
    const questions = serviceDemoQuestions[serviceType] || [
        "Lütfen ihtiyaçlarınızı detaylandırın:",
        "Hedefleriniz nelerdir?",
        "Bütçe aralığınız nedir?",
        "Zaman planlamanız nasıl?",
        "Ek notlarınız var mı?"
    ];
    
    return questions.map((question, index) => ({
        id: `demo-${serviceType}-${index}`,
        question: question,
        flow_number: index + 1,
        service_type_id: serviceType,
        service_type: serviceType,
        is_demo: true
    }));
}
                
    // Firma Analiz Sohbeti - GÜNCELLENMİŞ
    function setupCompanyAnalysisChat() {
    const serviceSelect = document.getElementById('service-select');
    const chatInput = document.getElementById('chat-input');
    const sendTextButton = document.getElementById('send-text');
    const goBackBtn = document.getElementById('go-back-btn');
    const chatInputArea = document.getElementById('chat-input-area');

    // Event listener'ları temizle ve yeniden ekle
    serviceSelect.addEventListener('change', handleServiceChange);
    sendTextButton.addEventListener('click', handleAnswerSubmit);
    goBackBtn.addEventListener('click', handleGoBack);
    
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            handleAnswerSubmit();
        }
    });

    async function handleServiceChange() {
        const selectedServiceId = this.value;
        const chatInputArea = document.getElementById('chat-input-area');
        const goBackBtn = document.getElementById('go-back-btn');
        
        if (!selectedServiceId) {
            chatInputArea.classList.add('hidden');
            addMessageToChat("Lütfen ilgilendiğiniz hizmeti seçin.");
            return;
        }

        try {
            currentService = selectedServiceId;
            currentQuestionIndex = 0;
            companyProfile[selectedServiceId] = {};
            
            // Sohbeti temizle (ilk mesaj hariç)
            const chatContainer = document.getElementById('chat-container');
            const initialMessage = chatContainer.querySelector('.chat-bubble:first-child');
            chatContainer.innerHTML = '';
            if (initialMessage) chatContainer.appendChild(initialMessage);
            
            const selectedServiceName = this.options[this.selectedIndex].text;
            addMessageToChat(`"${selectedServiceName}" hizmeti için analiz başlatılıyor...`);
            
            // Soruları yükle
            await loadServiceQuestionsAdvanced(selectedServiceId);
            
            if (serviceQuestions.length > 0) {
                setTimeout(() => {
                    addMessageToChat(serviceQuestions[0].question);
                    chatInputArea.classList.remove('hidden');
                    goBackBtn.classList.add('hidden');
                }, 1000);
            }
            
        } catch (error) {
            console.error('❌ Hizmet değişim hatası:', error);
            addMessageToChat("❌ " + error.message);
        }
    }
    
    function handleGoBack() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            const previousQuestion = serviceQuestions[currentQuestionIndex].question;
            
            // Sohbeti düzenle
            const chatContainer = document.getElementById('chat-container');
            const messages = chatContainer.querySelectorAll('.chat-bubble');
            if (messages.length >= 2) {
                chatContainer.removeChild(messages[messages.length - 1]);
                chatContainer.removeChild(messages[messages.length - 2]);
            }
            
            // Önceki soruyu tekrar sor
            addMessageToChat(previousQuestion);
            goBackBtn.classList.toggle('hidden', currentQuestionIndex === 0);
            
            // Form alanını temizle
            chatInput.value = '';
        }
    }
}

// Hizmet türlerine göre özel son sorular ve fiyat bilgisi
const serviceEndQuestions = {
    'hedef_ulke_rapor': {
        question: "Kapsamlı Pazar Analizi Raporunuzu hazırlamamızı ister misiniz?",
        actionText: "Raporu Hazırla"
    },
    'firma_kurulus': {
        question: "Şirket kuruluş işleminizi hemen başlatmak ister misiniz?",
        actionText: "Kuruluşu Başlat"
    },
    'banka_hesap': {
        question: "Banka hesabı açılış işleminizi başlatmak ister misiniz?",
        actionText: "Hesap Açılışını Başlat"
    },
    'muhasebe': {
        question: "Muhasebe işlemlerinizi başlatmak ister misiniz?",
        actionText: "Muhasebe Başlat"
    },
    'ihracat_kredileri': {
        question: "İhracat kredisi başvurunuzu başlatmak ister misiniz?",
        actionText: "Kredi Başvurusu Başlat"
    }
};

// Cevap gönderme - DÜZELTİLMİŞ
function handleAnswerSubmit() {
    const chatInput = document.getElementById('chat-input');
    const message = chatInput.value.trim();
    const goBackBtn = document.getElementById('go-back-btn');
    
    if (!message) return;

    // Kullanıcı mesajını ekle
    addMessageToChat(message, true);

    // Şirket profilini güncelle
    const currentQuestion = serviceQuestions[currentQuestionIndex].question;
    companyProfile[currentService][currentQuestion] = message;

    chatInput.value = '';

    // Son soruya gelindi mi kontrol et
    if (currentQuestionIndex < serviceQuestions.length - 1) {
        // Normal soru devam et
        currentQuestionIndex++;
        const nextQuestion = serviceQuestions[currentQuestionIndex].question;
        setTimeout(() => {
            addMessageToChat(nextQuestion);
            goBackBtn.classList.remove('hidden');
        }, 500);
    } else {
        // SON SORU - Hizmete özel teklifi göster
        setTimeout(() => {
            showServiceSpecificOffer();
        }, 1000);
    }
}

// Sepeti görüntüle fonksiyonu
function viewCart() {
    // Sepet modal'ını aç veya sepete yönlendir
    const cartSection = document.getElementById('services');
    if (cartSection) {
        cartSection.scrollIntoView({ behavior: 'smooth' });
    }
}        

// Rapor teklifi göster
function showReportOffer() {
    const offerHTML = `
        <div class="chat-bubble">
            <p>Kapsamlı Pazar Analizi Raporunuzu hazırlamamızı ister misiniz?</p>
            <div class="flex space-x-4 mt-4">
                <button id="accept-offer" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300">
                    ✅ Evet
                </button>
                <button id="decline-offer" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-300">
                    ❌ Hayır
                </button>
            </div>
        </div>
    `;
    
    const chatContainer = document.getElementById('chat-container');
    chatContainer.insertAdjacentHTML('beforeend', offerHTML);
    
    // Input alanını gizle
    document.getElementById('chat-input-area').classList.add('hidden');
    
    // Event listener'ları ekle
    document.getElementById('accept-offer').addEventListener('click', handleOfferAccept);
    document.getElementById('decline-offer').addEventListener('click', handleOfferDecline);
}

// Hizmete özel teklifi göster - YENİ FONKSİYON
async function showServiceSpecificOffer() {
    try {
        // Hizmet detaylarını veritabanından al
        const { data: serviceDetails, error } = await supabase
            .from('ai_service_type')
            .select('service_name, service_price, currency, sort_code')
            .eq('id', currentService)
            .single();
        
        if (error) throw error;

        // Hizmet türüne göre son soruyu belirle
        const serviceType = serviceDetails.sort_code || currentService;
        const endConfig = serviceEndQuestions[serviceType] || {
            question: "Hizmetinizi başlatmak ister misiniz?",
            actionText: "Hizmeti Başlat"
        };

        const offerHTML = `
            <div class="chat-bubble">
                <p>${endConfig.question}</p>
                <div class="mt-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold">${serviceDetails.service_name}</span>
                        <span class="text-green-600 font-bold">
                            ${serviceDetails.service_price} ${serviceDetails.currency}
                        </span>
                    </div>
                    <div class="text-sm text-gray-600 mt-1">
                        Hizmet Bedeli
                    </div>
                </div>
                <div class="flex space-x-4 mt-4">
                    <button id="accept-offer" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300 flex items-center">
                        <i class="fas fa-check mr-2"></i>
                        ${endConfig.actionText}
                    </button>
                    <button id="decline-offer" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-300 flex items-center">
                        <i class="fas fa-times mr-2"></i>
                        Hayır
                    </button>
                </div>
            </div>
        `;
        
        const chatContainer = document.getElementById('chat-container');
        chatContainer.insertAdjacentHTML('beforeend', offerHTML);
        
        // Input alanını gizle
        document.getElementById('chat-input-area').classList.add('hidden');
        
        // Event listener'ları ekle
        document.getElementById('accept-offer').addEventListener('click', () => handleOfferAccept(serviceDetails));
        document.getElementById('decline-offer').addEventListener('click', handleOfferDecline);
        
    } catch (error) {
        console.error('Hizmet detayları yüklenirken hata:', error);
        // Fallback mesaj
        addMessageToChat("Hizmet bilgileri alınırken bir hata oluştu. Lütfen daha sonra tekrar deneyin.");
    }
}
// GÜNCELLENMİŞ - BU KULLANILACAK
function addToAICart(item) {
    // Eğer item bir template ise (rapor)
    if (item.template_id) {
        const existingItem = serviceCart.find(cartItem => 
            cartItem.id === item.template_id && cartItem.type !== 'service'
        );
        
        if (!existingItem) {
            serviceCart.push({
                id: item.template_id,
                name: item.report_title || item.report_name,
                price: item.report_price,
                currency: item.report_currency,
                reportId: item.id,
                type: 'report',
                quantity: 1
            });
        }
    } 
    // Eğer item bir hizmet ise
    else if (item.type === 'service') {
        const existingItem = serviceCart.find(cartItem => 
            cartItem.id === item.id && cartItem.type === 'service'
        );
        
        if (!existingItem) {
            serviceCart.push({
                id: item.id,
                name: item.name,
                price: item.price,
                currency: item.currency,
                type: 'service',
                profile: item.profile,
                service_type: item.service_type,
                quantity: 1
            });
        }
    }
    // Eğer sadece template bilgisi var (eski sistem)
    else {
        const existingItem = serviceCart.find(cartItem => cartItem.id === item.id);
        
        if (!existingItem) {
            serviceCart.push({
                id: item.id,
                name: item.name,
                price: item.price,
                currency: item.currency,
                reportId: item.reportId,
                quantity: 1
            });
        }
    }
    
    updateAICart();
}
        
// handleOfferAccept fonksiyonunu düzelt
async function handleOfferAccept(serviceDetails) {
    try {
        console.log('🛒 Servis sepete ekleniyor:', serviceDetails);
        
        // Fiyat kontrolü - serviceDetails doğru mu?
        const servicePrice = serviceDetails.service_price || serviceDetails.price || 0;
        const serviceCurrency = serviceDetails.currency || 'USD';
        const serviceName = serviceDetails.service_name || serviceDetails.name || 'Bilinmeyen Servis';
        
        // Sepete ekle
        const cartItem = {
            id: currentService,
            name: serviceName,
            price: servicePrice,
            currency: serviceCurrency,
            type: 'service',
            profile: companyProfile[currentService],
            service_type: serviceDetails.sort_code || currentService
        };
        
        console.log('✅ Sepet öğesi:', cartItem);
        addToAICart(cartItem);
        
        // Kullanıcıya bilgi ver
        addMessageToChat(`
            ✅ "${serviceName}" hizmeti sepete eklendi! 
            <br>Fiyat: ${servicePrice} ${serviceCurrency}
            <br><br>
            <button onclick="viewCart()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300 mt-2">
                Sepeti Görüntüle
            </button>
        `);
        
        // Butonları kaldır
        document.getElementById('accept-offer').style.display = 'none';
        document.getElementById('decline-offer').style.display = 'none';
        
    } catch (error) {
        console.error('❌ Teklif kabul hatası:', error);
        addMessageToChat('❌ Hizmet sepete eklenirken bir hata oluştu. Lütfen tekrar deneyin.');
    }
}
        
// Rapor teklifi göster
function showReportOffer() {
    const offerHTML = `
        <div class="chat-bubble">
            <p>Kapsamlı Pazar Analizi Raporunuzu hazırlamamızı ister misiniz?</p>
            <div class="flex space-x-4 mt-4">
                <button id="accept-offer" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300">
                    ✅ Evet
                </button>
                <button id="decline-offer" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-300">
                    ❌ Hayır
                </button>
            </div>
        </div>
    `;
    
    const chatContainer = document.getElementById('chat-container');
    chatContainer.insertAdjacentHTML('beforeend', offerHTML);
    
    // Input alanını gizle
    document.getElementById('chat-input-area').classList.add('hidden');
    
    // Event listener'ları ekle
    document.getElementById('accept-offer').addEventListener('click', handleOfferAccept);
    document.getElementById('decline-offer').addEventListener('click', handleOfferDecline);
}
// Teklifi reddet
function handleOfferDecline() {
    addMessageToChat('Anlıyorum. İstediğiniz zaman hizmetlerimizden faydalanabilirsiniz. Size nasıl yardımcı olabilirim?');
    
    // Butonları kaldır
    document.getElementById('accept-offer').style.display = 'none';
    document.getElementById('decline-offer').style.display = 'none';
    
    // Oturum verisini sakla (kullanıcı çıkış yapana kadar)
    saveChatSession();
}

// Oturum verisini sakla
function saveChatSession() {
    const sessionData = {
        serviceId: currentService,
        profile: companyProfile[currentService],
        timestamp: new Date().getTime()
    };
    sessionStorage.setItem('chat_session', JSON.stringify(sessionData));
}

// Oturum verisini temizle
function clearChatSession() {
    sessionStorage.removeItem('chat_session');
    companyProfile = {};
    currentService = null;
    currentQuestionIndex = 0;
    serviceQuestions = [];
}

// Sayfa yüklendiğinde oturum kontrolü
function checkChatSession() {
    const savedSession = sessionStorage.getItem('chat_session');
    if (savedSession) {
        const sessionData = JSON.parse(savedSession);
        const now = new Date().getTime();
        const sessionAge = now - sessionData.timestamp;
        
        // 1 saatten eski oturumları temizle
        if (sessionAge > 60 * 60 * 1000) {
            clearChatSession();
        } else {
            // Oturumu geri yükle
            console.log('📝 Kayıtlı sohbet oturumu bulundu');
        }
    }
}        
          // Şirket Analizi Oluştur - DOMAIN DÜZELTİLDİ
        async function generateCompanyAnalysis() {
            try {
                addMessageToChat("🔍 Bilgileriniz analiz ediliyor...");
                
                // DOMAIN DÜZELTME: parena-platform.app -> parenatrade.vercel.app
                const response = await fetch('https://parenatrade.vercel.app/api/analyze-company', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        service: currentService,
                        profile: companyProfile[currentService],
                        service_name: document.getElementById('service-select').selectedOptions[0]?.text
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API hatası: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    addMessageToChat(result.result);
                    addMessageToChat("💼 Size özel hazırladığım hizmet paketlerini sepete ekleyebilirsiniz.");
                } else {
                    throw new Error(result.error || 'Analiz oluşturulamadı');
                }

            } catch (error) {
                console.error('❌ Analiz oluşturma hatası:', error);
                addMessageToChat("❌ Üzgünüm, analiz oluşturulamadı: " + error.message);
                
                // Fallback: Mock analiz göster
                const mockAnalysis = generateMockAnalysis(currentService, companyProfile[currentService]);
                addMessageToChat("📋 Demo analiz:");
                addMessageToChat(mockAnalysis);
                addMessageToChat("💼 Size özel hazırladığım hizmet paketlerini sepete ekleyebilirsiniz.");
            }
        }

        
// Template seçiminde global değişkeni güncelle - TAM KOD
function setupQuickReportForm() {
    const templateSelect = document.getElementById('report-template-select');
    const generateBtn = document.getElementById('generate-report-btn');
    
    if (!templateSelect) {
        console.error('❌ Template select bulunamadı');
        return;
    }
    
    // Template değişim event'i
    templateSelect.addEventListener('change', function() {
        const templateId = this.value;
        console.log('🎯 Seçilen template:', templateId);
        
        if (!templateId) {
            // Temizleme
            window.selectedTemplate = null;
            document.getElementById('dynamic-form-fields').classList.add('hidden');
            document.getElementById('criteria-list').classList.add('hidden');
            if (generateBtn) generateBtn.classList.add('hidden');
            return;
        }
        
        // Global selectedTemplate'i güncelle
        window.selectedTemplate = window.reportTemplates?.find(t => t.id === templateId);
        console.log('🎯 Global selectedTemplate güncellendi:', window.selectedTemplate);
        
        if (window.selectedTemplate) {
            console.log('📊 Seçilen rapor:', window.selectedTemplate.report_name);
            
            // Template açıklamasını göster
            const descriptionElement = document.getElementById('template-description');
            if (descriptionElement && window.selectedTemplate.report_description) {
                descriptionElement.textContent = window.selectedTemplate.report_description;
                descriptionElement.classList.remove('hidden');
            }
            
            // Değişkenleri çıkar ve form oluştur
            const variables = extractVariables(window.selectedTemplate.report_prompt);
            createDynamicFormFields(variables);
            
            // Butonu göster
            if (generateBtn) {
                generateBtn.classList.remove('hidden');
                // Event listener'ı temizle ve yeniden ekle
                generateBtn.onclick = null;
                generateBtn.addEventListener('click', generateAIReport);
            }
            
        } else {
            console.error('❌ Template bulunamadı:', templateId);
            // Hata durumunda UI'ı temizle
            document.getElementById('dynamic-form-fields').classList.add('hidden');
            document.getElementById('criteria-list').classList.add('hidden');
            if (generateBtn) generateBtn.classList.add('hidden');
        }
    });
    
    // Generate butonuna event listener ekle
    if (generateBtn) {
        generateBtn.addEventListener('click', function(e) {
            e.preventDefault();
            generateAIReport();
        });
    }
    
    // Sayfa yüklendiğinde mevcut seçimi kontrol et
    setTimeout(() => {
        if (templateSelect.value && window.reportTemplates) {
            const currentTemplate = window.reportTemplates.find(t => t.id === templateSelect.value);
            if (currentTemplate) {
                window.selectedTemplate = currentTemplate;
                console.log('🔄 Mevcut template yüklendi:', window.selectedTemplate);
            }
        }
    }, 1000);
    
    console.log('✅ Quick report form kuruldu');
}
        
// Template detaylarını Supabase'den çek
async function getTemplateDetails(templateId) {
    try {
        const { data, error } = await supabase
            .from('ai_report_templates')
            .select('*')
            .eq('id', templateId)
            .single();
        
        if (error) throw error;
        return data;
        
    } catch (error) {
        console.error('❌ Template detayları yüklenemedi:', error);
        return null;
    }
}

function fillPromptTemplate(template, formData) {
    if (!template || !template.report_prompt) {
        console.error('❌ Geçersiz template veya prompt');
        return '';
    }
    
    let filledPrompt = template.report_prompt;
    
    console.log('🔍 FormData durumu:', formData);
    
    // current_year'i otomatik ekle
    const currentYear = new Date().getFullYear();
    filledPrompt = filledPrompt.replace(/\{\{current_year\}\}/g, currentYear);
    filledPrompt = filledPrompt.replace(/%current_year%/g, currentYear);
    
    // Tüm değişkenleri işle
    Object.entries(formData).forEach(([key, value]) => {
        if (value && value.trim() !== '') {
            // Tüm olası formatlarda değiştir
            const patterns = [
                `{{${key}}}`,
                `%${key}%`
            ];
            
            patterns.forEach(pattern => {
                const regex = new RegExp(pattern, 'g');
                filledPrompt = filledPrompt.replace(regex, value.trim());
            });
        }
    });
    
    // Eksik değişkenleri temizle
    filledPrompt = filledPrompt.replace(/\{\{\w+\}\}/g, 'Bilgi verilmemiş');
    filledPrompt = filledPrompt.replace(/%\w+%/g, 'Bilgi verilmemiş');
    
    console.log('✅ Prompt dolduruldu, ilk 200 karakter:', filledPrompt.substring(0, 200));
    return filledPrompt;
}
        
// Dropdown verilerini düzeltelim - tablo isimleri yanlış
async function loadDropdownData() {
    try {
        console.log('📊 Dropdown verileri yükleniyor...');
        
        // 1. Dilleri yükle - EĞER languages tablosu yoksa, sabit veri kullan
        try {
            const { data: languages, error: langError } = await supabase
                .from('languages')
                .select('id, name, iso_code')
                .order('name');
            
            if (!langError && languages) {
                window.languages = languages;
                console.log(`✅ ${languages.length} dil yüklendi`);
            } else {
                // Fallback: Sabit dil listesi
                window.languages = [
                { id: 1, name: 'Türkçe', iso_code: 'tr' },
                { id: 2, name: 'İngilizce', iso_code: 'en' },
                { id: 3, name: 'Almanca', iso_code: 'de' },
                { id: 4, name: 'Fransızca', iso_code: 'fr' },
                { id: 5, name: 'Rusça', iso_code: 'ru' }
                ];
                console.log('✅ Varsayılan diller yüklendi');
            }
        } catch (error) {
           window.languages = [
            { id: 1, name: 'Türkçe', iso_code: 'tr' },
            { id: 2, name: 'İngilizce', iso_code: 'en' },
            { id: 3, name: 'Almanca', iso_code: 'de' },
            { id: 4, name: 'Fransızca', iso_code: 'fr' },
            { id: 5, name: 'Rusça', iso_code: 'ru' }
        ];
        }
        
        // 2. Ülkeleri yükle - EĞER country tablosu yoksa, sabit veri kullan
        try {
            const { data: countries, error: countryError } = await supabase
                .from('country')
                .select('id, name, iso_code')
                .order('name');
            
            if (!countryError && countries) {
                window.countries = countries;
                console.log(`✅ ${countries.length} ülke yüklendi`);
            } else {
                // Fallback: Sabit ülke listesi
                window.countries = [
                    { id: 1, name: 'Türkiye', iso_code: 'TR' },
                    { id: 2, name: 'Almanya', iso_code: 'DE' },
                    { id: 3, name: 'Fransa', iso_code: 'FR' },
                    { id: 4, name: 'Romanya', iso_code: 'RO' },
                    { id: 5, name: 'Bulgaristan', iso_code: 'BG' }
                ];
                console.log('✅ Varsayılan ülkeler yüklendi');
            }
        } catch (error) {
            window.countries = [
                { id: 1, name: 'Türkiye', iso_code: 'TR' },
                { id: 2, name: 'Almanya', iso_code: 'DE' }
            ];
        }
        
        // 3. Sektörleri yükle - EĞER sector tablosu yoksa, sabit veri kullan
        try {
            const { data: sectors, error: sectorError } = await supabase
                .from('sector')
                .select('id, name, code')
                .order('name');
            
            if (!sectorError && sectors) {
                window.sectors = sectors;
                console.log(`✅ ${sectors.length} sektör yüklendi`);
            } else {
                // Fallback: Sabit sektör listesi
                window.sectors = [
                    { id: 1, name: 'Gıda', code: 'FOOD' },
                    { id: 2, name: 'Tekstil', code: 'TEXTILE' },
                    { id: 3, name: 'Kimya', code: 'CHEMICAL' },
                    { id: 4, name: 'Otomotiv', code: 'AUTO' },
                    { id: 5, name: 'Teknoloji', code: 'TECH' }
                ];
                console.log('✅ Varsayılan sektörler yüklendi');
            }
        } catch (error) {
            window.sectors = [
                { id: 1, name: 'Gıda', code: 'FOOD' },
                { id: 2, name: 'Tekstil', code: 'TEXTILE' }
            ];
        }
        
        // 4. GTIP kodlarını yükle - EĞER gtip tablosu yoksa, sabit veri kullan
        try {
            const { data: gtipCodes, error: gtipError } = await supabase
                .from('gtip')
                .select('id, name, code')
                .order('code');
            
            if (!gtipError && gtipCodes) {
                window.gtipCodes = gtipCodes;
                console.log(`✅ ${gtipCodes.length} GTIP kodu yüklendi`);
            } else {
                // Fallback: Sabit GTIP listesi
                window.gtipCodes = [
                    { id: 1, code: '2002.10', name: 'Domates Salçası'},
                    { id: 2, code: '2002.90', name: 'Diğer Sebze Salçaları'},
                    { id: 3, code: '5208', name: 'Pamuklu Dokumalar'},
                    { id: 4, code: '6109', name: 'Tişört ve Atlet'}
                ];
                console.log('✅ Varsayılan GTIP kodları yüklendi');
            }
        } catch (error) {
            window.gtipCodes = [
                { id: 1, code: '2002.10', name: 'Domates Salçası'},
                { id: 2, code: '5208', name: 'Pamuklu Dokumalar'}
            ];
        }
        
        // 5. Rapor şablonlarını yükle - ai_report_templates yerine mevcut sistemi kullan
        try {
            const { data: reportTemplates, error: templateError } = await supabase
                .from('ai_report_templates')
                .select('id, report_name, report_type, report_description, report_price, report_currency')
                .order('report_name');
            
            if (!templateError && reportTemplates) {
                window.reportTemplates = reportTemplates;
                console.log(`✅ ${reportTemplates.length} rapor şablonu yüklendi`);
            } else {
                // Fallback: Mevcut rapor şablonlarını kullan
                window.reportTemplates = aiReportTemplates;
                console.log('✅ Mevcut rapor şablonları kullanılıyor');
            }
        } catch (error) {
            window.reportTemplates = aiReportTemplates;
        }
        
    } catch (error) {
        console.error('❌ Dropdown verileri yüklenirken hata:', error);
        // Hata durumunda varsayılan verileri yükle
        loadDefaultDropdownData();
    }
}

// Varsayılan dropdown verileri
function loadDefaultDropdownData() {
    window.languages = [
        { id: 1, name: 'Türkçe', iso_code: 'tr' },
        { id: 2, name: 'İngilizce', iso_code: 'en' },
        { id: 3, name: 'Gürcüce', iso_code: 'ka' }
    ];
    
    window.countries = [
        { id: 1, name: 'Türkiye', code: 'TR' },
        { id: 2, name: 'Gürcistan', code: 'KA' },
        { id: 3, name: 'İngiltere', code: 'EN' },
        { id: 4, name: 'Almanya', code: 'DE' },
        { id: 5, name: 'Fransa', code: 'FR' }
        
    ];
    
    window.sectors = [
        { id: 1, name: 'Gıda', code: 'FOOD' },
        { id: 2, name: 'Tekstil', code: 'TEXTILE' },
        { id: 3, name: 'Kimya', code: 'CHEMICAL' }
    ];
    
    window.gtipCodes = [
        { id: 1, code: '2002.10', name: 'Domates Salçası'},
        { id: 2, code: '5208', name: 'Pamuklu Dokumalar'}
    ];
    
    window.reportTemplates = aiReportTemplates;
}
// Akordiyon event listener'larını ekle - EKSİK KISIM
// Akordiyon listener'larını kur - DÜZELTİLMİŞ
function setupAccordionListeners() {
    const accordionHeaders = document.querySelectorAll('.accordion-header');
    
    console.log('🔧 Akordiyon listenerları kuruluyor, eleman sayısı:', accordionHeaders.length);
    
    if (accordionHeaders.length === 0) {
        console.warn('⚠️ Akordiyon header bulunamadı - form alanları henüz oluşmamış olabilir');
        return;
    }
    
    accordionHeaders.forEach(header => {
        // Önceki event listener'ları temizle
        header.replaceWith(header.cloneNode(true));
    });
    
    // Yeni listener'ları ekle
    document.querySelectorAll('.accordion-header').forEach(header => {
        header.addEventListener('click', function() {
            const content = this.nextElementSibling;
            
            if (this.classList.contains('active')) {
                // Kapat
                this.classList.remove('active');
                content.classList.remove('open');
                activeAccordion = null;
            } else {
                // Öncekini kapat
                if (activeAccordion) {
                    activeAccordion.classList.remove('active');
                    activeAccordion.nextElementSibling.classList.remove('open');
                }
                // Yeni aç
                this.classList.add('active');
                content.classList.add('open');
                activeAccordion = this;
            }
        });
    });
    
    console.log('✅ Akordiyon listenerları kuruldu');
}

        
// Dinamik form alanlarını oluştur - TAM BİRLEŞTİRİLMİŞ
function createDynamicFormFields(variables) {
    const container = document.getElementById('dynamic-form-fields');
    if (!container) {
        console.error('❌ Form container bulunamadı');
        return;
    }
    
     container.innerHTML = '';
    
    // FORM DATA INITIALIZATION - BURAYA DA EKLE
    if (!window.formData) {
        window.formData = {};
        console.log('✅ window.formData createDynamicFormFields içinde initialize edildi');
    }
    
    // Field konfigürasyonları - GERÇEK (ÜSTTEKİ KODDAN)
    const fieldConfigs = {
        dil: {
            title: 'Rapor Dili',
            type: 'dropdown',
            data: window.languages || [
                { id: 1, name: 'Türkçe', iso_code: 'tr' },
                { id: 2, name: 'İngilizce', iso_code: 'en' }
            ],
            displayField: 'name',
            valueField: 'iso_code'
        },
        ulke: {
            title: 'Hedef Ülke',
            type: 'dropdown',
            data: window.countries || [
                { id: 1, name: 'Türkiye', iso_code: 'TR' },
                { id: 2, name: 'Almanya', iso_code: 'DE' }
            ],
            displayField: 'name',
            valueField: 'name'
        },
        sektor: {
            title: 'Sektör',
            type: 'dropdown',
            data: window.sectors || [
                { id: 1, name: 'Gıda', code: 'FOOD' },
                { id: 2, name: 'Tekstil', code: 'TEXTILE' }
            ],
            displayField: 'name',
            valueField: 'name'
        },
        firma_adi: {
        title: 'Firma Adı',
        type: 'text',
        placeholder: 'Analiz edilecek firma veya marka adı...'
    },
        urun: {
            title: 'Ürün/Hizmet',
            type: 'text',
            placeholder: 'Örn: Domates Salçası, Tekstil Ürünleri...'
        },
        bolge: {
            title: 'Bölge',
            type: 'dropdown',
            data: [
                { id: 'all', name: 'Tüm Bölgeler' },
                { id: 'east', name: 'Doğu' },
                { id: 'west', name: 'Batı' },
                { id: 'north', name: 'Kuzey' },
                { id: 'south', name: 'Güney' }
            ],
            displayField: 'name',
            valueField: 'name'
        },
        gtip: {
            title: 'GTIP Kodu',
            type: 'text',
            placeholder: 'Örn: 2002.10, 5208.11...'
        },
        zaman: {
            title: 'Zaman Aralığı',
            type: 'text',
            placeholder: 'Örn: 2020-2024, Son 5 yıl...'
        },
        amac: {
            title: 'Analiz Amacı',
            type: 'textarea',
            placeholder: 'Raporu hangi amaçla kullanacaksınız?'
        },
        derinlik: {
            title: 'Analiz Derinliği',
            type: 'dropdown',
            data: [
                { id: 1, name: 'Özet Rapor' },
                { id: 2, name: 'Detaylı Analiz' },
                { id: 3, name: 'Kapsamlı Araştırma' }
            ],
            displayField: 'name',
            valueField: 'name'
        },
        rapor_turu: {
            title: 'Rapor Türü',
            type: 'hidden'
        }
    };
    
    // ALTTAKİ KODDAN GELEN MANTIK:
    if (!variables || variables.length === 0) {
        container.innerHTML = '<p class="text-gray-500 p-4">Bu rapor için ek bilgi gerekmemektedir.</p>';
        container.classList.remove('hidden');
        return;
    }
    
     variables.forEach(variable => {
        const config = fieldConfigs[variable];
        if (!config) {
            console.warn(`⚠️ ${variable} için config bulunamadı`);
            return;
        }
        
        if (config.type === 'hidden') {
            window.formData[variable] = window.selectedTemplate?.report_name || ''; // formData -> window.formData
            return;
        }
        
        const fieldHTML = `
            <div class="accordion-item">
                <div class="accordion-header" data-field="${variable}">
                    <span>${config.title}</span>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </div>
                <div class="accordion-content">
                    ${createFieldHTML(variable, config)}
                </div>
            </div>
        `;
        
        container.innerHTML += fieldHTML;
        window.formData[variable] = ''; // formData -> window.formData // Başlangıç değeri
    });
    
    // ALTTAKİ KODDAN GELEN İYİLEŞTİRME:
    if (selectedTemplate) {
        formData.rapor_turu = selectedTemplate.report_name;
    }
    
    container.classList.remove('hidden');
    
    // İKİ KODDAN GELEN LISTENER'LAR:
    setTimeout(() => {
        setupAccordionListeners();
        setupFieldEventListeners(); // YENİ TAM FONKSİYON
        updateCriteriaList();       // ALTTAKİ KODDAN GELEN
    }, 100);
    
    console.log('✅ Form alanları oluşturuldu');
}
// Form alanı oluştur
function createFieldHTML(field, config) {
    const baseClasses = "w-full px-4 py-2 border border-gray-300 rounded-lg form-field";
    
    switch (config.type) {
        case 'dropdown':
            return `
                <select class="${baseClasses}" data-field="${field}">
                    <option value="">Seçiniz</option>
                    ${config.data.map(item => 
                        `<option value="${item[config.valueField]}">${item[config.displayField]}</option>`
                    ).join('')}
                </select>
            `;
        
        case 'searchable-dropdown':
            return `
                <div class="searchable-dropdown relative">
                    <input type="text" 
                           class="${baseClasses} search-input"
                           placeholder="${config.placeholder || 'Arama yapın...'}"
                           data-field="${field}"
                           id="${field}-search-input">
                    <div class="dropdown-results hidden absolute z-50 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-60 overflow-y-auto shadow-xl"></div>
                </div>
                <div class="selected-value mt-2 hidden">
                    <span class="text-sm text-gray-600">Seçilen: </span>
                    <span class="selected-text font-medium"></span>
                    <button class="text-red-500 hover:text-red-700 clear-selection ml-2" data-field="${field}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        
        case 'textarea':
            return `
                <textarea class="${baseClasses}" 
                          data-field="${field}" 
                          placeholder="${config.placeholder || ''}"
                          rows="3"></textarea>
            `;
        
        default:
            return `
                <input type="text" 
                       class="${baseClasses}"
                       data-field="${field}"
                       placeholder="${config.placeholder || ''}">
            `;
    }
}
// Field HTML oluştur - YENİ FONKSİYON
function createFieldHTML(field, config) {
    switch (config.type) {
        case 'dropdown':
            return `
                <select class="w-full px-4 py-2 border border-gray-300 rounded-lg form-field" data-field="${field}">
                    <option value="">Seçiniz</option>
                    ${config.data.map(item => 
                        `<option value="${item[config.valueField]}">${item[config.displayField]}</option>`
                    ).join('')}
                </select>
            `;
        
        case 'textarea':
            return `
                <textarea class="w-full px-4 py-2 border border-gray-300 rounded-lg form-field" 
                          data-field="${field}" 
                          placeholder="${config.placeholder || ''}"
                          rows="3"></textarea>
            `;
        
        default: // text
            return `
                <input type="text" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg form-field"
                       data-field="${field}"
                       placeholder="${config.placeholder || ''}">
            `;
    }
}
        

// Dropdown alanı oluştur
function createDropdownField(field, config) {
    return `
        <div class="accordion-item">
            <div class="accordion-header" data-field="${field}">
                <span>${config.title}</span>
                <i class="fas fa-chevron-down accordion-icon"></i>
            </div>
            <div class="accordion-content">
                <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 form-field dropdown-field"
                        data-field="${field}">
                    <option value="">Seçiniz</option>
                    ${config.data ? config.data.map(item => 
                        `<option value="${item[config.valueField]}">${item[config.displayField]}</option>`
                    ).join('') : ''}
                </select>
            </div>
        </div>
    `;
}

// Arama yapılabilir dropdown (GTIP için) - MEVCUT FONKSİYONU DÜZELTELİM
// Arama yapılabilir dropdown (GTIP için) - MEVCUT FONKSİYONU DÜZELTELİM
function createSearchableDropdownField(field, config) {
    return `
        <div class="accordion-item">
            <div class="accordion-header" data-field="${field}">
                <span>${config.title}</span>
                <i class="fas fa-chevron-down accordion-icon"></i>
            </div>
            <div class="accordion-content">
                <div class="searchable-dropdown relative">
                    <input type="text" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 search-input"
                           placeholder="${field === 'gtip' ? 'GTIP kodu yazın (örn: 2002.90) veya ürün adı arayın...' : 'Arama yapın...'}"
                           data-field="${field}"
                           id="${field}-search-input">
                    <div class="dropdown-results hidden absolute z-50 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-60 overflow-y-auto shadow-xl"></div>
                </div>
                ${field === 'gtip' ? `
                <div class="selected-value mt-3 p-3 bg-green-50 rounded-lg border border-green-200 hidden">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-sm text-green-700 font-medium">Seçilen GTIP:</span>
                            <div class="selected-text font-semibold text-green-800"></div>
                        </div>
                        <button class="text-red-500 hover:text-red-700 clear-selection" data-field="${field}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                ` : `
                <div class="selected-value mt-2 hidden">
                    <span class="text-sm text-gray-600">Seçilen: </span>
                    <span class="selected-text font-medium"></span>
                </div>
                `}
            </div>
        </div>
    `;
}
        
// Rapor şablonu dropdown
function createTemplateDropdownField(field, config) {
    return `
        <div class="accordion-item">
            <div class="accordion-header" data-field="${field}">
                <span>${config.title}</span>
                <i class="fas fa-chevron-down accordion-icon"></i>
            </div>
            <div class="accordion-content">
                <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 form-field template-field"
                        data-field="${field}">
                    <option value="">Rapor türü seçin</option>
                    ${config.data ? config.data.map(item => 
                        `<option value="${item[config.valueField]}" 
                                data-description="${item.report_description}"
                                data-price="${item.report_price}"
                                data-currency="${item.report_currency}">
                            ${item[config.displayField]} - $${item.report_price} ${item.report_currency}
                        </option>`
                    ).join('') : ''}
                </select>
                <div class="template-description mt-2 text-sm text-gray-600 hidden"></div>
            </div>
        </div>
    `;
}

// Text alanı oluştur
function createTextField(field, config) {
    return `
        <div class="accordion-item">
            <div class="accordion-header" data-field="${field}">
                <span>${config.title}</span>
                <i class="fas fa-chevron-down accordion-icon"></i>
            </div>
            <div class="accordion-content">
                <input type="text" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 form-field"
                       data-field="${field}"
                       placeholder="${config.placeholder || ''}">
            </div>
        </div>
    `;
}

// Field event listener'larını KESİN ÇÖZÜM - SADECE GEREKLİ DÜZELTMELER
function setupFieldEventListeners() {
    console.log('🔧 Field event listenerları kuruluyor...');
    
    // FORM DATA INITIALIZATION - SADECE BURAYA EKLE
    if (!window.formData) {
        window.formData = {};
        console.log('✅ window.formData setupFieldEventListeners içinde initialize edildi');
    }
    
    // 1. TÜM select elementlerini dinle - KESİN ÇÖZÜM
    document.addEventListener('change', function(e) {
        const target = e.target;
        
        if (target.tagName === 'SELECT') {
            const fieldName = target.getAttribute('data-field');
            if (fieldName) {
                window.formData[fieldName] = target.value; // SADECE formData -> window.formData
                console.log(`✅ SELECT ${fieldName} seçildi:`, target.value);
                updateCriteriaList();
            }
        }
    });
    
    // 2. TÜM input ve textarea'ları dinle
    document.addEventListener('input', function(e) {
        const target = e.target;
        
        if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') {
            const fieldName = target.getAttribute('data-field');
            if (fieldName && !target.classList.contains('search-input')) {
                window.formData[fieldName] = target.value; // SADECE formData -> window.formData
                console.log(`✅ INPUT ${fieldName} değişti:`, target.value);
                updateCriteriaList();
            }
        }
    });
    
    // 3. Arama yapılabilir dropdown'lar (mevcut kodunuz - DEĞİŞİKLİK YOK)
    document.querySelectorAll('.search-input').forEach(input => {
        input.addEventListener('input', debounce(function() {
            const field = this.getAttribute('data-field');
            const searchTerm = this.value.trim();
            const resultsContainer = this.parentElement.querySelector('.dropdown-results');
            const selectedContainer = this.closest('.accordion-content').querySelector('.selected-value');
            
            console.log(`🔍 ${field} arama:`, searchTerm);
            
            if (searchTerm.length < 2) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            let filteredResults = [];
            
            if (field === 'gtip') {
                if (!window.gtipCodes || window.gtipCodes.length === 0) {
                    resultsContainer.innerHTML = '<div class="p-3 text-red-500">GTIP verileri yüklenemedi</div>';
                    resultsContainer.classList.remove('hidden');
                    return;
                }
                
                filteredResults = window.gtipCodes.filter(item => 
                    item.code.toString().includes(searchTerm) || 
                    item.name.toLowerCase().includes(searchTerm.toLowerCase())
                ).slice(0, 8);
                
            } else if (field === 'amac' || field === 'derinlik') {
                const config = getFieldConfig(field);
                if (config && config.data) {
                    filteredResults = config.data.filter(item => 
                        item.name.toLowerCase().includes(searchTerm.toLowerCase())
                    ).slice(0, 6);
                }
            }
            
            if (filteredResults.length > 0) {
                resultsContainer.innerHTML = filteredResults.map(item => {
                    if (field === 'gtip') {
                        return `
                            <div class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 search-result-item" 
                                 data-value="${item.code}" 
                                 data-display="${item.code} - ${item.name}">
                                <div class="font-bold text-blue-700">${item.code}</div>
                                <div class="text-sm text-gray-700">${item.name}</div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 search-result-item" 
                                 data-value="${item.name}" 
                                 data-display="${item.name}">
                                <div class="font-medium">${item.name}</div>
                            </div>
                        `;
                    }
                }).join('');
                resultsContainer.classList.remove('hidden');
            } else {
                resultsContainer.innerHTML = '<div class="p-3 text-gray-500">Sonuç bulunamadı</div>';
                resultsContainer.classList.remove('hidden');
            }
        }, 300));
        
        input.addEventListener('focus', function() {
            const resultsContainer = this.parentElement.querySelector('.dropdown-results');
            if (this.value.trim().length > 0) {
                resultsContainer.classList.remove('hidden');
            }
        });
    });
    
    // 4. Dropdown sonuç tıklama (mevcut kodunuz - SADECE formData -> window.formData)
    document.addEventListener('click', function(e) {
        if (e.target.closest('.search-result-item')) {
            const resultItem = e.target.closest('.search-result-item');
            const value = resultItem.getAttribute('data-value');
            const display = resultItem.getAttribute('data-display');
            const resultsContainer = resultItem.closest('.dropdown-results');
            const input = resultsContainer.previousElementSibling;
            const field = input.getAttribute('data-field');
            const selectedContainer = input.closest('.accordion-content').querySelector('.selected-value');
            
            console.log(`✅ ${field} seçildi:`, value);
            
            window.formData[field] = value; // SADECE formData -> window.formData
            input.value = display;
            
            if (selectedContainer) {
                selectedContainer.querySelector('.selected-text').textContent = display;
                selectedContainer.classList.remove('hidden');
            }
            
            resultsContainer.classList.add('hidden');
            updateCriteriaList();
        }
        
        if (e.target.closest('.clear-selection')) {
            const button = e.target.closest('.clear-selection');
            const field = button.getAttribute('data-field');
            const input = document.getElementById(`${field}-search-input`);
            const selectedContainer = button.closest('.selected-value');
            
            window.formData[field] = ''; // SADECE formData -> window.formData
            if (input) input.value = '';
            if (selectedContainer) selectedContainer.classList.add('hidden');
            updateCriteriaList();
        }
        
        if (!e.target.closest('.search-input') && !e.target.closest('.dropdown-results')) {
            document.querySelectorAll('.dropdown-results').forEach(container => {
                container.classList.add('hidden');
            });
        }
    });
    
    console.log('✅ Tüm field listenerları kuruldu');
}
        
// Debounce fonksiyonu
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
        // Field config getter
function getFieldConfig(field) {
    const fieldConfigs = {
        amac: {
            data: [
                { id: 1, name: 'Yeni bir girişim pazara giriş stratejisi için kullanacağım' },
                { id: 2, name: 'Mevcut ürün/hizmeti geliştirmek için pazar analizi' },
                { id: 3, name: 'Yatırım kararı ve risk değerlendirmesi' },
                { id: 4, name: 'Rekabet analizi ve stratejik pozisyon belirleme' },
                { id: 5, name: 'Ürün fiyatlandırma ve pazarlama stratejisi geliştirme' }
            ]
        },
        derinlik: {
            data: [
                { id: 1, name: 'Çıktıyı yönetim sunumuna uygun şekilde 5-6 başlık altında rapor formatında hazırla' },
                { id: 2, name: 'Stratejik yönetim için detaylı analiz ve öneriler' },
                { id: 3, name: 'Yatırımcı sunumu için özet rapor ve finansal projeksiyonlar' },
                { id: 4, name: 'Operasyonel ekip için detaylı pazar ve rekabet analizi' }
            ]
        }
    };
    return fieldConfigs[field];
}

        // Field konfigürasyonları
const fieldConfigs = {
    dil: {
        title: 'Rapor Dili',
        type: 'dropdown',
        data: window.languages || [
            { id: 1, name: 'Türkçe', iso_code: 'tr' },
            { id: 2, name: 'İngilizce', iso_code: 'en' }
        ],
        displayField: 'name',
        valueField: 'iso_code'
    },
    ulke: {
        title: 'Hedef Ülke',
        type: 'dropdown',
        data: window.countries || [
            { id: 1, name: 'Türkiye', iso_code: 'TR' },
            { id: 2, name: 'Almanya', iso_code: 'DE' }
        ],
        displayField: 'name',
        valueField: 'name'
    },
    sektor: {
        title: 'Sektör',
        type: 'dropdown',
        data: window.sectors || [
            { id: 1, name: 'Gıda', code: 'FOOD' },
            { id: 2, name: 'Tekstil', code: 'TEXTILE' }
        ],
        displayField: 'name',
        valueField: 'name'
    },
    urun: {
        title: 'Ürün/Hizmet',
        type: 'text',
        placeholder: 'Örn: Domates Salçası, Tekstil Ürünleri...'
    },
    bolge: {
        title: 'Bölge',
        type: 'dropdown',
        data: [
            { name: 'Tüm Bölgeler' },
            { name: 'Doğu' },
            { name: 'Batı' },
            { name: 'Kuzey' },
            { name: 'Güney' }
        ],
        displayField: 'name',
        valueField: 'name'
    },
    gtip: {
        title: 'GTIP Kodu',
        type: 'searchable-dropdown',
        data: window.gtipCodes || [],
        displayField: 'name',
        valueField: 'code'
    },
    zaman: {
        title: 'Zaman Aralığı',
        type: 'text',
        placeholder: 'Örn: 2020-2024, Son 5 yıl...'
    },
    amac: {
        title: 'Analiz Amacı',
        type: 'searchable-dropdown',
        data: [
            { id: 1, name: 'Yeni bir girişim pazara giriş stratejisi için kullanacağım' },
            { id: 2, name: 'Mevcut ürün/hizmeti geliştirmek için pazar analizi' },
            { id: 3, name: 'Yatırım kararı ve risk değerlendirmesi' }
        ],
        displayField: 'name',
        valueField: 'name'
    },
    derinlik: {
        title: 'Analiz Derinliği',
        type: 'searchable-dropdown',
        data: [
            { id: 1, name: 'Çıktıyı yönetim sunumuna uygun şekilde 5-6 başlık altında rapor formatında hazırla' },
            { id: 2, name: 'Stratejik yönetim için detaylı analiz ve öneriler' },
            { id: 3, name: 'Yatırımcı sunumu için özet rapor ve finansal projeksiyonlar' }
        ],
        displayField: 'name',
        valueField: 'name'
    },
    rapor_turu: {
        title: 'Rapor Türü',
        type: 'hidden'
    }
};

 // Kriter listesini güncelle - DEBUG için
// Kriter listesini güncelle - DEBUG için
function updateCriteriaList() {
    const criteriaContainer = document.getElementById('criteria-items');
    const criteriaList = document.getElementById('criteria-list');
    
    if (!criteriaContainer || !criteriaList) {
        console.error('❌ Kriter containerları bulunamadı');
        return;
    }
    
    criteriaContainer.innerHTML = '';
    
    console.log('🔍 DEBUG - FormData durumu:', window.formData);
    console.log('🔍 DEBUG - dil değeri:', window.formData?.dil);
    
    let hasData = false;
    
    // GÜVENLİ ERİŞİM - window.formData kullan
    if (window.formData && typeof window.formData === 'object') {
        Object.entries(window.formData).forEach(([key, value]) => {
            if (value !== undefined && value !== null && value.toString().trim() !== '') {
                hasData = true;
                const title = getFieldTitle(key);
                criteriaContainer.innerHTML += `
                    <div class="criteria-item">
                        <strong>${title}:</strong> ${value}
                    </div>
                `;
                console.log(`✅ Kriter eklendi: ${title} = ${value}`);
            }
        });
    }
    
    if (hasData) {
        criteriaList.classList.remove('hidden');
        console.log('✅ Kriter listesi güncellendi');
    } else {
        criteriaList.classList.add('hidden');
        console.log('ℹ️ Kriter listesi boş');
    }
}
        // Field title'ları güncelle
function getFieldTitle(field) {
    const titles = {
        dil: 'Rapor Dili',
        ulke: 'Hedef Pazar Ülkesi', // Güncellendi
        sektor: 'Sektör',
        urun: 'Ürün/Hizmet',
        firma_adi: 'Firma Adı', // Eklendi
        bolge: 'Bölge',
        gtip: 'GTIP Kodu',
        zaman: 'Zaman Aralığı',
        amac: 'Analiz Amacı',
        derinlik: 'Analiz Derinliği',
        rapor_turu: 'Rapor Türü'
    };
    return titles[field] || field;
}
// Kullanıcı yönetimi değişkenleri
let currentUser = null;
let authToken = null;

// Kullanıcı yönetim sistemini başlat
function initializeAuthSystem() {
    checkExistingSession();
    setupAuthModals();
    setupProfileTabs();
}

// Mevcut oturumu kontrol et
function checkExistingSession() {
    const savedToken = localStorage.getItem('parenatrade_token');
    const savedUser = localStorage.getItem('parenatrade_user');
    
    if (savedToken && savedUser) {
        authToken = savedToken;
        currentUser = JSON.parse(savedUser);
        updateUIForLoggedInUser();
    }
}

// Auth modal'larını kur
function setupAuthModals() {
    // Login modal
    const closeLoginBtn = document.getElementById('close-login-modal');
    if (closeLoginBtn) {
        closeLoginBtn.addEventListener('click', () => {
            document.getElementById('login-modal').classList.add('hidden');
        });
    }
    
    // Register/Login toggle
    const showRegister = document.getElementById('show-register');
    const showLogin = document.getElementById('show-login');
    
    if (showRegister) {
        showRegister.addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
        });
    }
    
    if (showLogin) {
        showLogin.addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
        });
    }
    
    // Login form
    const loginForm = document.getElementById('login-form');
    if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
    }
    
    // Register form
    const registerForm = document.getElementById('register-form');
    if (registerForm) {
        registerForm.addEventListener('submit', handleRegister);
    }
    
    // Profile modal
    const closeProfileBtn = document.getElementById('close-profile-modal');
    if (closeProfileBtn) {
        closeProfileBtn.addEventListener('click', () => {
            document.getElementById('profile-modal').classList.add('hidden');
        });
    }
    
    // Logout
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
    }
}

        
// Kayıt işlemi
async function handleRegister(e) {
    e.preventDefault();
    
    const name = document.getElementById('register-name').value;
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const passwordConfirm = document.getElementById('register-password-confirm').value;
    
    if (password !== passwordConfirm) {
        alert('Şifreler eşleşmiyor!');
        return;
    }
    
    try {
        const { data, error } = await supabase.auth.signUp({
            email: email,
            password: password,
            options: {
                data: {
                    full_name: name
                }
            }
        });
        
        if (error) throw error;
        
        if (data.user) {
            // E-posta doğrulama göster
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('email-verification').classList.remove('hidden');
        }
        
    } catch (error) {
        alert('Kayıt hatası: ' + error.message);
    }
}
        
// Çıkış işlemi
function handleLogout() {
    supabase.auth.signOut();
    localStorage.removeItem('parenatrade_token');
    localStorage.removeItem('parenatrade_user');
    currentUser = null;
    authToken = null;
    updateUIForLoggedOutUser();
    document.getElementById('profile-modal').classList.add('hidden');
}

// UI güncelleme - Giriş yapılmış
function updateUIForLoggedInUser() {
    // Navbar'ı güncelle
    const navButtons = document.querySelector('.flex.space-x-3');
    if (navButtons) {
        navButtons.innerHTML = `
            <button id="profile-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm">
                <i class="fas fa-user mr-1"></i> Profilim
            </button>
            <button id="logout-nav-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 text-sm">
                Çıkış
            </button>
        `;
        
        document.getElementById('profile-btn').addEventListener('click', () => {
            document.getElementById('profile-modal').classList.remove('hidden');
        });
        
        document.getElementById('logout-nav-btn').addEventListener('click', handleLogout);
    }
}

// UI güncelleme - Çıkış yapılmış
function updateUIForLoggedOutUser() {
    const navButtons = document.querySelector('.flex.space-x-3');
    if (navButtons) {
        navButtons.innerHTML = `
            <a href="#" id="login-nav-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm">Giriş Yap</a>
            <a href="#" id="register-nav-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 text-sm">Kayıt Ol</a>
        `;
        
        document.getElementById('login-nav-btn').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('login-modal').classList.remove('hidden');
        });
        
        document.getElementById('register-nav-btn').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
        });
    }
}
        

// Profil tab'larını kur
function setupProfileTabs() {
    const tabs = document.querySelectorAll('.profile-tab');
    if (tabs.length === 0) {
        console.log('Profil tabları bulunamadı');
        return;
    }
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // Aktif tab'ı güncelle
            document.querySelectorAll('.profile-tab').forEach(t => {
                t.classList.remove('bg-indigo-100', 'text-indigo-700');
                t.classList.add('hover:bg-gray-100', 'text-gray-700');
            });
            
            this.classList.add('bg-indigo-100', 'text-indigo-700');
            this.classList.remove('hover:bg-gray-100', 'text-gray-700');
            
            // İçeriği göster
            const tabName = this.getAttribute('data-tab');
            document.querySelectorAll('.profile-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            const targetTab = document.getElementById(`tab-${tabName}`);
            if (targetTab) {
                targetTab.classList.remove('hidden');
                
                // Raporlar sekmesine tıklandığında raporları yükle
                if (tabName === 'reports') {
                    loadUserReports();
                }
            }
        });
    });
}
        
// Kullanıcı raporlarını yükle - SADE VE TEMİZ
async function loadUserReports() {
    if (!currentUser) {
        console.log('Kullanıcı girişi yok');
        return;
    }
    
    const reportsList = document.getElementById('user-reports-list');
    if (!reportsList) {
        console.log('reportsList elementi bulunamadı');
        return;
    }
    
    try {
        console.log('Kullanıcı raporları yükleniyor:', currentUser.id);
        
        const { data: reports, error } = await supabase
            .from('ai_reports')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });
        
        if (error) {
            console.error('Rapor yükleme hatası:', error);
            reportsList.innerHTML = '<p class="text-red-500 text-center py-4">Raporlar yüklenirken hata oluştu.</p>';
            return;
        }
        
        console.log('Yüklenen rapor sayısı:', reports?.length);
        
        if (!reports || reports.length === 0) {
            reportsList.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-file-pdf text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Henüz raporunuz bulunmamaktadır.</p>
                    <p class="text-gray-400 text-sm mt-2">Ödeme yaptıktan sonra raporlarınız burada görünecektir.</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        reports.forEach(report => {
            const createdDate = new Date(report.created_at).toLocaleDateString('tr-TR');
            const isPaid = report.status === 'completed' || report.status === 'paid';
            const canDownload = isPaid && report.pdf_url;
            
            html += `
                <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h5 class="font-semibold text-gray-800">${report.report_title || 'İsimsiz Rapor'}</h5>
                            <p class="text-sm text-gray-600 mt-1">
                                <i class="far fa-calendar mr-1"></i>${createdDate}
                            </p>
                            <div class="flex space-x-2 mt-2">
                                <span class="inline-block ${isPaid ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'} text-xs px-2 py-1 rounded">
                                    ${isPaid ? '✅ Ödeme Tamam' : '⏳ Beklemede'}
                                </span>
                                ${report.is_mock ? `
                                    <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">
                                        Demo Rapor
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                        <div class="flex space-x-2 ml-4">
                            ${canDownload ? `
                                <a href="${report.pdf_url}" target="_blank" 
                                   class="bg-green-500 text-white px-3 py-2 rounded text-sm hover:bg-green-600 transition flex items-center">
                                    <i class="fas fa-download mr-1"></i> PDF İndir
                                </a>
                            ` : `
                                <button class="bg-gray-300 text-gray-500 px-3 py-2 rounded text-sm cursor-not-allowed flex items-center" disabled>
                                    <i class="fas fa-download mr-1"></i> Ödeme Gerekli
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        });
        
        reportsList.innerHTML = html;
        
    } catch (error) {
        console.error('Raporlar yüklenirken hata:', error);
        reportsList.innerHTML = '<p class="text-red-500 text-center py-4">Raporlar yüklenirken hata oluştu.</p>';
    }
}
    

// Giriş sonrası siparişe devam et
function proceedWithOrder() {
    const pendingOrder = sessionStorage.getItem('pending_order');
    if (pendingOrder) {
        serviceCart = JSON.parse(pendingOrder);
        sessionStorage.removeItem('pending_order');
        updateAICart();
        proceedToPayment();
    }
}

// Ödeme sayfasına git
function proceedToPayment() {
    // Sepetteki raporları veritabanına kaydet
    saveReportsToDatabase().then(() => {
        // Ödeme sayfasına yönlendir
        window.location.href = '/ai/payment.html?cart=' + encodeURIComponent(JSON.stringify(serviceCart));
    });
}
        




// PDF indirme
function downloadPDF() {
    const pdfUrl = document.getElementById('pdf-iframe').src;
    if (pdfUrl) {
        const a = document.createElement('a');
        a.href = pdfUrl;
        a.download = `rapor_${Date.now()}.pdf`;
        a.click();
    }
}



// Örnek rapor kartlarına görüntüleme butonu ekle
function setupExampleReports() {
    document.querySelectorAll('#reports .bg-gray-50 button').forEach((button, index) => {
        button.addEventListener('click', function() {
            // Örnek rapor verisi
            const exampleReports = [
                {
                    id: 'example-1',
                    report_title: 'Romanya Domates Salçası Pazar Analizi',
                    report_content: `# Romanya Domates Salçası Pazar Analizi\n\n## Özet\nRomanya domates salçası pazarı büyüme potansiyeli yüksek bir pazardır...`,
                    created_at: new Date().toISOString(),
                    pdf_url: null
                },
                {
                    id: 'example-2', 
                    report_title: 'Bulgaristan Tekstil Ürünleri Pazar Analizi',
                    report_content: `# Bulgaristan Tekstil Ürünleri Pazar Analizi\n\n## Özet\nBulgaristan tekstil pazarı rekabetçi bir yapıya sahiptir...`,
                    created_at: new Date().toISOString(),
                    pdf_url: null
                }
            ];
            
            showExampleReport(exampleReports[index]);
        });
    });
}

// Örnek rapor göster
function showExampleReport(report) {
    document.getElementById('report-view-title').textContent = report.report_title;
    document.getElementById('report-content-display').innerHTML = formatReportContent(report.report_content);
    document.getElementById('report-created-date').textContent = new Date(report.created_at).toLocaleDateString('tr-TR');
    document.getElementById('report-status').textContent = 'Örnek Rapor';
    
    document.getElementById('download-pdf-btn').classList.add('hidden');
    document.getElementById('view-pdf-btn').classList.add('hidden');
    
    showContentView();
}

        
// Raporları veritabanına kaydet - GÜNCELLENDİ
async function saveReportsToDatabase() {
    if (!currentUser) return;
    
    for (const item of serviceCart) {
        if (!item.reportId) continue; // reportId yoksa atla
        
        try {
            const { error } = await supabase
                .from('ai_reports')
                .update({
                    user_id: currentUser.id,
                    status: 'pending_payment'
                })
                .eq('id', item.reportId);
            
            if (error) throw error;
            
        } catch (error) {
            console.error('Rapor güncelleme hatası:', error);
        }
    }
}


// ✅ YENİ - Gelişmiş prompt hazırlama (Sizin tasarımınıza uygun)
function prepareAdvancedPrompt(template, formData) {
    console.log('🎯 Gelişmiş prompt hazırlanıyor:', { template: template.report_name, formData });
    
    // Değişken mapping
    const variables = {
        dil: formData.dil?.trim() || 'Türkçe',
        ulke: formData.ulke?.trim() || 'Belirtilmemiş',
        sektor: formData.sektor?.trim() || 'Belirtilmemiş',
        urun: formData.urun?.trim() || 'Belirtilmemiş',
        bolge: formData.bolge?.trim() || 'Tüm Bölgeler',
        gtip: formData.gtip?.trim() || 'Belirtilmemiş',
        zaman: formData.zaman?.trim() || '2020-2025 ve güncel yıl',
        amac: formData.amac?.trim() || 'pazar analizi ve yatırım değerlendirmesi',
        derinlik: formData.derinlik?.trim() || 'yönetim sunumuna uygun şekilde hazırla',
        rapor_turu: formData.rapor_turu?.trim() || template.report_name
    };

    // ✅ SİZİN TASARIMINIZA UYGUN PROFESYONEL PROMPT
    const advancedPrompt = `
Sen bir uluslararası ticaret ve pazar araştırma uzmanısın. Benimle birlikte ${variables.urun} için detaylı pazar araştırması yapmak istiyorum.

Aşağıdaki başlıklar kapsamında derinlemesine analiz yapmanı istiyorum:

## Pazar Tanımı ve Genel Görünüm: 
Pazarın boyutu, büyüme oranları, tarihsel gelişimi ve geleceğe yönelik projeksiyonlar.

## Pazar Segmentasyonu: 
Coğrafi, demografik, psikografik ve davranışsal segmentler.

## Hedef Müşteri Profilleri (Buyer Persona): 
Temel ihtiyaçlar, karar alma davranışları, satın alma kriterleri.

## Rakip Analizi: 
Ana rakipler, pazardaki konumları, güçlü/zayıf yönleri, fiyatlama, dağıtım kanalları, farklılaştırıcı stratejiler.

## Trendler ve Fırsatlar: 
Teknolojik gelişmeler, regülasyon değişiklikleri, kültür/sosyal eğilimler, yeni iş modelleri.

## Tehditler ve Giriş Engelleri: 
Regülasyonlar, rekabet yoğunluğu, ikame ürünler, müşteri sadakati.

## Fiyatlandırma Dinamikleri: 
Ortalama fiyat aralıkları, fiyatlandırma modelleri, müşteri ödeme istekliliği.

## SWOT Analizi: 
Genel pazar için güçlü yönler, zayıf yönler, fırsatlar ve tehditler.

## Sonuç ve Öneriler: 
Stratejik pozisyonlama, potansiyel giriş stratejileri, farklılaşma noktaları.

**Araştırma Parametreleri:**
- Ülke/Bölge: ${variables.ulke} / ${variables.bolge}
- Sektör: ${variables.sektor}
- Ürün: ${variables.urun}
- GTIP: ${variables.gtip}
- Zaman Aralığı: ${variables.zaman}
- Analiz Amacı: ${variables.amac}
- Derinlik Düzeyi: ${variables.derinlik}

**Önemli Talimatlar:**
- Bilgileri mümkün olduğunca güncel kaynaklara dayanarak hazırla
- Gerektiğinde tablo ve madde işaretleri kullan
- Profesyonel, veri odaklı ve rapor formatında yaz
- Kullanılan kaynakları ve veri yıllarını belirt
- ${variables.derinlik}
    `.trim();

    console.log('✅ Gelişmiş Prompt Hazırlandı');
    return advancedPrompt;
}

async function generateAIReport() {
    console.log('🚀 Rapor oluşturma başlatılıyor...');
    
    // Validasyon - GÜVENLİ FORM DATA KONTROLÜ
    if (!window.selectedTemplate) {
        alert('❌ Lütfen rapor türü seçin.');
        return;
    }
    
    // Form data kontrolü - KESİN ÇÖZÜM
    if (!window.formData || typeof window.formData !== 'object') {
        console.error('❌ FormData tanımlı değil:', window.formData);
        alert('❌ Form verileri yüklenemedi. Lütfen sayfayı yenileyin.');
        return;
    }
    
    // Form validasyonu - GÜVENLİ
    const requiredFields = ['ulke', 'sektor', 'urun'];
    const missingFields = [];
    
    requiredFields.forEach(field => {
        // Güvenli erişim
        if (!window.formData[field] || String(window.formData[field]).trim() === '') {
            missingFields.push(getFieldTitle(field));
        }
    });
    
    if (missingFields.length > 0) {
        alert(`Lütfen aşağıdaki alanları doldurun:\n${missingFields.join('\n')}`);
        return;
    }
    
    const generateBtn = document.getElementById('generate-report-btn');
    const progressSection = document.getElementById('report-progress');
    
    // UI durumunu güncelle
    if (generateBtn) {
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Oluşturuluyor...';
    }
    if (progressSection) progressSection.classList.remove('hidden');
    updateProgress(20);

    try {
        // 1. Prompt'u doldur - GÜVENLİ
        const finalPrompt = fillPromptTemplate(window.selectedTemplate, window.formData);
        console.log('📝 Doldurulmuş prompt:', finalPrompt);
        
        if (!finalPrompt) {
            throw new Error('Prompt oluşturulamadı.');
        }
        
        updateProgress(40);

        // 2. API'ye gönder
        console.log('🌐 API çağrısı yapılıyor...');
        const response = await fetch('https://parenatrade.vercel.app/api/generate-report', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                prompt: finalPrompt,
                template: window.selectedTemplate.report_name,
                parameters: window.formData
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`API hatası: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        console.log('📨 API cevabı:', result);
        
        if (!result.success) {
            throw new Error(result.error || 'Rapor oluşturulamadı');
        }

        updateProgress(60);

        // 3. SUPABASE'E KAYDET - GÜVENLİ
        console.log('💾 Supabase\'e kaydediliyor...');
        const reportData = {
            template_id: window.selectedTemplate.id,
            report_title: window.selectedTemplate.report_name,
            report_prompt: finalPrompt,
            report_content: result.result,
            country: window.formData.ulke || null,
            sector: window.formData.sektor || null,
            product: window.formData.urun || null,
            region: window.formData.bolge || null,
            gtip: window.formData.gtip || null,
            period: window.formData.zaman || null,
            purpose: window.formData.amac || null,
            language: window.formData.dil || 'tr',
            depth: window.formData.derinlik || null,
            report_type: window.selectedTemplate.report_type,
            status: 'completed',
            user_id: window.currentUser?.id || null,
            report_price: window.selectedTemplate.report_price,
            currency: window.selectedTemplate.report_currency,
            created_at: new Date().toISOString()
        };

        console.log('📊 Kaydedilecek rapor verisi:', reportData);

        const { data: report, error } = await supabase
            .from('ai_reports')
            .insert(reportData)
            .select()
            .single();

        if (error) {
            console.error('❌ Supabase kayıt hatası:', error);
            // Hata durumunda bile devam et
        } else {
            console.log('✅ Rapor Supabase\'e kaydedildi:', report);
        }

        updateProgress(80);

        // 4. SEPETE EKLE - GÜVENLİ
        console.log('🎯 Selected Template Detayları:', {
            id: window.selectedTemplate.id,
            name: window.selectedTemplate.report_name,
            price: window.selectedTemplate.report_price,
            currency: window.selectedTemplate.report_currency
        });

        // Fiyat kontrolü - kesin çözüm
        const itemPrice = window.selectedTemplate.report_price !== undefined && 
                         window.selectedTemplate.report_price !== null && 
                         !isNaN(parseFloat(window.selectedTemplate.report_price)) 
            ? parseFloat(window.selectedTemplate.report_price) 
            : 199;

        const itemCurrency = window.selectedTemplate.report_currency || 'USD';
        const itemName = window.selectedTemplate.report_name || 'Pazar Raporu';

        const cartItem = {
            id: window.selectedTemplate.id,
            name: itemName,
            price: itemPrice,
            currency: itemCurrency,
            reportId: report?.id,
            type: 'report',
            template_data: window.selectedTemplate
        };

        console.log('🛒 Sepete eklenecek öğe:', cartItem);
        addToAICart(cartItem);

        updateProgress(100);

        // 5. Sonuçları göster
        const quickResult = document.getElementById('quick-analysis-result');
        if (quickResult) quickResult.classList.remove('hidden');
        
        // Başarı mesajı
        setTimeout(() => {
            if (progressSection) progressSection.classList.add('hidden');
            if (generateBtn) {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-search mr-2"></i> Rapor Oluştur';
            }
            
            console.log('✅ Rapor oluşturma işlemi tamamlandı');
            
        }, 2000);

    } catch (error) {
        console.error('❌ Rapor oluşturma hatası:', error);
        
        // UI'ı eski haline getir
        if (generateBtn) {
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="fas fa-search mr-2"></i> Rapor Oluştur';
        }
        if (progressSection) progressSection.classList.add('hidden');
        
        // Hata mesajını göster
        let errorMessage = 'Rapor oluşturulurken hata: ' + error.message;
        
        if (error.message.includes('API hatası: 405')) {
            errorMessage = 'API endpoint\'i geçici olarak kullanılamıyor. Lütfen daha sonra tekrar deneyin.';
        } else if (error.message.includes('Failed to fetch')) {
            errorMessage = 'İnternet bağlantınızı kontrol edin ve tekrar deneyin.';
        }
        
        alert('❌ ' + errorMessage);
    }
}
        
// Hata göster - BASİT
function showError(message) {
    alert('❌ ' + message);
}

// Başarı göster - BASİT  
function showSuccess(message) {
    alert('✅ ' + message);
}
        
// Hata loglama fonksiyonu
async function logError(error, context = {}) {
    try {
        await supabase
            .from('error_logs')
            .insert({
                error_message: error.message,
                error_stack: error.stack,
                context: context,
                user_id: window.currentUser?.id,
                url: window.location.href,
                created_at: new Date().toISOString()
            });
    } catch (logError) {
        console.error('Hata loglama başarısız:', logError);
    }
}
        
// Giriş işlemi - GÜNCELLENMİŞ
async function handleLogin(e) {
    e.preventDefault();
    
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    try {
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (error) throw error;
        
        if (data.user) {
            currentUser = data.user;
            authToken = data.session.access_token;
            
            // LocalStorage'a kaydet
            localStorage.setItem('parenatrade_token', authToken);
            localStorage.setItem('parenatrade_user', JSON.stringify(currentUser));
            
            // UI güncelle
            updateUIForLoggedInUser();
            
            // Modal'ı kapat
            document.getElementById('login-modal').classList.add('hidden');
            
            // BEKLEYEN RAPOR VARSA TAMAMLA
            const pendingReport = sessionStorage.getItem('pending_report_data');
            if (pendingReport) {
                const reportData = JSON.parse(pendingReport);
                sessionStorage.removeItem('pending_report_data');
                
                // Kullanıcıya bilgi ver
                alert('Giriş başarılı! Rapor oluşturma işlemini tamamlıyorum...');
                
                // Rapor oluşturma işlemini başlat
                await completePendingReport(reportData);
            } else {
                alert('Başarıyla giriş yapıldı!');
            }
        }
        
    } catch (error) {
        alert('Giriş hatası: ' + error.message);
    }
}

// Bekleyen raporu tamamla - TESTLİ
async function completePendingReport(reportData) {
    const { template, formData, finalPrompt } = reportData;
    
    // ÖNCE: API durumunu kontrol et
    const apiStatus = await testAPIEndpoint();
    
    if (!apiStatus) {
        showErrorModal(
            'Rapor Tamamlanamadı',
            'Önceden başlattığınız rapor oluşturma işlemi tamamlanamıyor.<br><br>' +
            'AI servisi geçici olarak kullanılamıyor. Lütfen daha sonra "Raporlarım" bölümünden tekrar deneyin.'
        );
        return;
    }

    try {
        // API çağrısı
        const response = await fetch('https://parenatrade.vercel.app/api/generate-report', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                prompt: finalPrompt,
                template: template.report_name,
                parameters: formData
            })
        });

        if (!response.ok) throw new Error(`API hatası: ${response.status}`);

        const result = await response.json();
        
        if (!result.success) throw new Error(result.error);

        // Supabase'e kaydet
        const reportDbData = {
            template_id: template.id,
            report_title: template.report_name,
            report_prompt: finalPrompt,
            report_content: result.result,
            country: formData.ulke || null,
            sector: formData.sektor || null,
            product: formData.urun || null,
            region: formData.bolge || null,
            gtip: formData.gtip || null,
            period: formData.zaman || null,
            purpose: formData.amac || null,
            language: formData.dil || null,
            depth: formData.derinlik || null,
            report_type: template.report_type,
            status: 'completed',
            user_id: currentUser.id,
            created_at: new Date().toISOString()
        };

        const { data: report, error } = await supabase
            .from('ai_reports')
            .insert(reportDbData)
            .select()
            .single();

        if (error) throw error;

        // Sepete ekle
        addToAICart(template, report.id);
        
        alert('✅ Rapor başarıyla oluşturuldu ve sepete eklendi!');

    } catch (error) {
        console.error('Bekleyen rapor tamamlama hatası:', error);
        showErrorModal(
            'Rapor Tamamlanamadı',
            'Giriş yaptınız ancak rapor oluşturma işlemi tamamlanamadı:<br><br>' +
            '• Hata: ' + error.message + '<br>' +
            '• Lütfen daha sonra "Raporlarım" bölümünden tekrar deneyin<br>' +
            '• Sorun devam ederse müşteri hizmetleri ile iletişime geçin'
        );
    }
}
        

                        
// Yardımcı fonksiyonlar
function updateProgress(percent) {
    const progressFill = document.getElementById('progress-fill');
    const progressPercent = document.getElementById('progress-percent');
    
    if (progressFill && progressPercent) {
        progressFill.style.width = `${percent}%`;
        progressPercent.textContent = `${percent}%`;
    }
}

        

        // AI Raporunu Sepete Ekle
        function addToAICart(template, reportId) {
            const existingItem = serviceCart.find(item => item.id === template.id);
            
            if (!existingItem) {
                serviceCart.push({
                    id: template.id,
                    name: template.report_name,
                    price: template.report_price,
                    currency: template.report_currency,
                    reportId: reportId,
                    quantity: 1
                });
            }
            
            updateAICart();
        }

        function setupCartFunctionality() {
    // AI Rapor sepete ekleme
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-ai-report')) {
            const button = e.target;
            const template = aiReportTemplates.find(t => t.id === button.getAttribute('data-id'));
            
            if (template) {
                addToAICart(template);
            }
        }
    });

    // Sepeti tamamlama - GÜNCELLENMİŞ
document.getElementById('complete-ai-report-order').addEventListener('click', function() {
    if (serviceCart.length === 0) return;
    
    if (!currentUser) {
        // Kullanıcı giriş yapmamışsa login modal aç
        alert('Lütfen önce giriş yapın!');
        document.getElementById('login-modal').classList.remove('hidden');
        return;
    }
    
    // Kullanıcı giriş yapmışsa direkt ödeme
    proceedToPayment();
});

            // Hata ayıklama için Supabase bağlantısını kontrol et
        async function checkSupabaseConnection() {
            try {
                const { data, error } = await supabase
                    .from('ai_service_type')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    console.error('Supabase bağlantı hatası:', error);
                    return false;
                }
                
                console.log('Supabase bağlantısı başarılı');
                return true;
            } catch (error) {
                console.error('Supabase bağlantı testi hatası:', error);
                return false;
            }
        }

        // Sayfa yüklendiğinde bağlantıyı test et - GÜNCELLENDİ
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM yüklendi, uygulama başlatılıyor...');
            const isConnected = await checkSupabaseConnection();
            if (!isConnected) {
                console.warn('Supabase bağlantısı sorunlu, fallback modunda çalışılıyor');
            }
            
            // Sadece bir kere initialize et
            await initializeApp();
        });

        // Çift yüklenmeyi önlemek için ayrıca bir kontrol
        let initializationStarted = false;

        // Alternatif başlatma yöntemi
        if (!initializationStarted) {
            initializationStarted = true;
            document.addEventListener('DOMContentLoaded', initializeApp);
        }
        
        // İletişim formu
        document.getElementById('contact-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Burada Supabase'e iletişim formu kaydedilecek
            // Şimdilik sadece alert gösteriyoruz
            
            alert('Mesajınız başarıyla gönderildi. En kısa sürede size dönüş yapacağız.');
            this.reset();
        });
}
            
    </script>
</body>
</html>
