<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hızlı Sipariş Sistemi</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<style>
  .reyon { perspective: 800px; cursor: pointer; }
  .reyon-inner { transition: transform 0.5s; transform-style: preserve-3d; }
  .reyon:hover .reyon-inner { transform: rotateY(15deg) scale(1.05); }
  .urun-card { transition: transform 0.3s; }
  .urun-card:hover { transform: rotateY(10deg) scale(1.05); }
  .fade-in { animation: fadeIn 0.5s forwards; }
  @keyframes fadeIn { from {opacity:0;} to{opacity:1;} }
  /* Modal */
  .modal-bg { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; }
  .modal-content { background:white; padding:20px; border-radius:10px; max-width:400px; width:90%; max-height:80%; overflow:auto; }
</style>
</head>
<body class="bg-gray-100 font-sans">

<header class="text-center py-8 bg-green-600 text-white">
  <h1 class="text-3xl font-bold">Hızlı Sipariş Sistemi</h1>
  <p class="mt-2">Sadece konuş, siparişin hazırlansın!</p>
</header>

<!-- Lokasyon ve Satıcı -->
<section class="max-w-xl mx-auto my-6 p-4 bg-white rounded shadow">
  <h2 class="text-xl font-semibold mb-2">Lokasyon ve Satıcı</h2>
  <button id="locBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Konumumu Kullan</button>
  <select id="saticiSelect" class="w-full p-2 border rounded mt-2 hidden">
    <option value="">Satıcı seçin</option>
  </select>
  <p id="noSatici" class="mt-2 text-red-600 hidden">Bölgede satıcı bulunamadı.</p>
</section>

<!-- Reyonlar -->
<section id="reyonSection" class="max-w-5xl mx-auto grid grid-cols-1 sm:grid-cols-3 gap-6 my-6 px-4 hidden"></section>

<!-- Ürün Listesi ve Sepet -->
<section class="max-w-xl mx-auto my-6 p-4 bg-white rounded shadow">
  <h2 class="text-xl font-semibold mb-2">Sepet ve Ürün Seçimi</h2>
  <ul id="sepet" class="mb-4"></ul>
  <div id="urunPanel" class="hidden">
    <h3 class="font-semibold mb-2" id="urunReyon"></h3>
    <div id="urunlerContainer" class="grid grid-cols-2 gap-2"></div>
  </div>

  <!-- Sepet Finansal Özet -->
  <div id="sepetOzet" class="mt-4 p-2 border-t border-gray-300">
    <p>Toplam Tutar: ₺<span id="toplamTutar">0</span></p>
    <p>İndirim: ₺<span id="indirim">0</span></p>
    <p>KDV (18%): ₺<span id="kdv">0</span></p>
    <p class="font-bold">Genel Toplam: ₺<span id="genelToplam">0</span></p>
    <button id="detayBtn" class="mt-2 bg-gray-700 text-white px-4 py-2 rounded">Sipariş Detaylarını Gör</button>
  </div>
</section>

<!-- Profil & Bonus -->
<section class="max-w-xl mx-auto my-6 p-4 bg-white rounded shadow">
  <h2 class="text-xl font-semibold mb-2">Profil & Bonus</h2>
  <div class="flex items-center gap-4 mb-2">
    <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="Profil" class="w-12 h-12 rounded-full">
    <div>
      <p id="userName" class="font-semibold">Ayşe Teyze</p>
      <p id="userEmail" class="text-gray-600 text-sm">ayse@example.com</p>
    </div>
  </div>
  <div class="mb-2">
    <p>Kazanılan Bonus: <span id="kazananBonus">0</span> puan</p>
    <p>Harcanan Bonus: <span id="harcananBonus">0</span> puan</p>
    <p>Kalan Bonus: <span id="kalanBonus">0</span> puan</p>
  </div>
</section>

<!-- Ödeme Butonları -->
<section class="max-w-xl mx-auto my-6 p-4 bg-white rounded shadow text-center">
  <h2 class="text-xl font-semibold mb-2">Ödeme Seçenekleri</h2>
  <div class="flex flex-col sm:flex-row gap-2 mt-4">
    <button id="payNakit" class="bg-gray-600 text-white px-4 py-2 rounded flex-1">Kapıda Nakit</button>
    <button id="payKart" class="bg-blue-600 text-white px-4 py-2 rounded flex-1">Kapıda Kredi Kartı</button>
    <button id="payBonus" class="bg-green-600 text-white px-4 py-2 rounded flex-1">Bonusla Ödeme</button>
  </div>
</section>

<!-- Sesli Sipariş -->
<section class="max-w-xl mx-auto my-6 text-center">
  <button id="startVoice" class="bg-blue-600 text-white px-6 py-3 rounded text-lg">Sesli Sipariş Başlat</button>
</section>

<!-- WhatsApp Referans -->
<section class="max-w-xl mx-auto my-6 p-4 bg-white rounded shadow text-center">
  <h2 class="text-xl font-semibold mb-2">Arkadaşına Gönder</h2>
  <button id="shareBtn" class="bg-green-600 text-white px-6 py-3 rounded text-lg">
    Referans Linki WhatsApp’a Gönder
  </button>
</section>

<!-- Modal -->
<div id="modal" class="modal-bg flex">
  <div class="modal-content">
    <h3 class="text-lg font-semibold mb-2">Sipariş Detayları</h3>
    <ul id="modalSepet" class="mb-2"></ul>
    <p>Toplam: ₺<span id="modalToplam">0</span></p>
    <p>İndirim: ₺<span id="modalIndirim">0</span></p>
    <p>KDV: ₺<span id="modalKdv">0</span></p>
    <p class="font-bold">Genel Toplam: ₺<span id="modalGenelToplam">0</span></p>
    <button id="closeModal" class="mt-2 bg-red-600 text-white px-4 py-2 rounded">Kapat</button>
  </div>
</div>

<script>
// Supabase client
const SUPABASE_URL = "https://xliutvspwodhoaxvysks.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsaXV0dnNwd29kaG9heHZ5c2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTgyOTksImV4cCI6MjA3MjkzNDI5OX0.Zodisa_ifP8t2Q4X0ecnB56RiR_Bg4QS5gvPn5ZLK_w";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// DOM Elements
const sepet = document.getElementById('sepet');
const urunPanel = document.getElementById('urunPanel');
const urunReyon = document.getElementById('urunReyon');
const urunlerContainer = document.getElementById('urunlerContainer');
const saticiSelect = document.getElementById('saticiSelect');
const noSatici = document.getElementById('noSatici');
const reyonSection = document.getElementById('reyonSection');
const toplamTutarEl = document.getElementById('toplamTutar');
const indirimEl = document.getElementById('indirim');
const kdvEl = document.getElementById('kdv');
const genelToplamEl = document.getElementById('genelToplam');
const kazanilanBonusEl = document.getElementById('kazananBonus');
const harcananBonusEl = document.getElementById('harcananBonus');
const kalanBonusEl = document.getElementById('kalanBonus');

let mevcutBonus = 120;
let harcananBonus = 0;
let urunlerData = [];
let saticilarData = [];

// Lokasyon ve satıcı çekme
document.getElementById('locBtn').addEventListener('click', async () => {
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const { data: saticilar, error } = await supabase.from('saticilar').select('*');
      if(error){ console.error(error); return; }
      saticilarData = saticilar.filter(s => Math.abs(lat - s.lat)+Math.abs(lon - s.lon)<2);
      if(saticilarData.length>0){
        saticiSelect.innerHTML = '<option value="">Satıcı seçin</option>';
        saticilarData.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = s.name;
          saticiSelect.appendChild(opt);
        });
        saticiSelect.classList.remove('hidden');
        noSatici.classList.add('hidden');
      } else {
        saticiSelect.classList.add('hidden');
        noSatici.classList.remove('hidden');
        reyonSection.classList.add('hidden');
      }
    });
  } else { alert('Konum alınamadı!'); }
});

// Satıcı seçildiğinde ürün ve reyonları çek
saticiSelect.addEventListener('change', async () => {
  const saticiId = saticiSelect.value;
  if(!saticiId) return;
  const { data: urunler, error } = await supabase.from('urunler').select('*').eq('satici_id', saticiId);
  if(error){ console.error(error); return; }
  urunlerData = urunler;
  const reyonlar = [...new Set(urunler.map(u=>u.reyon))];
  reyonSection.innerHTML = '';
  reyonlar.forEach(r => {
    const div = document.createElement('div');
    div.className = 'reyon bg-white rounded shadow p-4';
    div.dataset.reyon = r;
    div.innerHTML = `<div class="reyon-inner text-center"><h3 class="mt-2 font-semibold">${r}</h3></div>`;
    div.addEventListener('click', ()=>{
      urunPanel.classList.remove('hidden');
      urunReyon.textContent = r.toUpperCase();
      urunlerContainer.innerHTML = '';
      urunlerData.filter(u=>u.reyon===r).forEach(u=>{
        const card = document.createElement('div');
        card.className = 'urun-card bg-white p-2 rounded shadow flex flex-col items-center';
        card.innerHTML = `<img src="${u.image_url}" class="w-20 h-20 mb-1" alt="${u.name}">
                          <p class="text-sm font-semibold">${u.name}</p>
                          <p>₺${u.fiyat}</p>
                          <button class="mt-1 bg-green-600 text-white px-2 py-1 rounded addToCart">Sepete Ekle</button>`;
        card.querySelector('.addToCart').addEventListener('click', ()=>{
          const li = document.createElement('li');
          li.textContent = `${u.name} - 1 adet - ₺${u.fiyat.toFixed(2)}`;
          li.classList.add('fade-in');
          sepet.appendChild(li);
          guncelleOzet();
        });
        urunlerContainer.appendChild(card);
      });
    });
    reyonSection.appendChild(div);
  });
  reyonSection.classList.remove('hidden');
});

// Sepet ve özet fonksiyonları
function guncelleOzet(){
  let toplam=0;
  document.querySelectorAll('#sepet li').forEach(li=>{
    const match = li.textContent.match(/₺(\d+(\.\d+)?)/);
    if(match) toplam += parseFloat(match[1]);
  });
  const indirim = toplam*0.05;
  const kdv = (toplam-indirim)*0.18;
  const genel = toplam-indirim+kdv;
  toplamTutarEl.textContent = toplam.toFixed(2);
  indirimEl.textContent = indirim.toFixed(2);
  kdvEl.textContent = kdv.toFixed(2);
  genelToplamEl.textContent = genel.toFixed(2);
  const kazanilan = Math.floor(genel*0.05);
  kazanilanBonusEl.textContent = kazanilan;
  harcananBonusEl.textContent = harcananBonus;
  kalanBonusEl.textContent = (mevcutBonus - harcananBonus + kazanilan).toFixed(0);
}

// Modal işlemleri
const modal = document.getElementById('modal');
const modalSepet = document.getElementById('modalSepet');
document.getElementById('detayBtn').addEventListener('click', ()=>{
  modalSepet.innerHTML = '';
  document.querySelectorAll('#sepet li').forEach(li=>{
    const liClone = li.cloneNode(true);
    modalSepet.appendChild(liClone);
  });
  document.getElementById('modalToplam').textContent = toplamTutarEl.textContent;
  document.getElementById('modalIndirim').textContent = indirimEl.textContent;
  document.getElementById('modalKdv').textContent = kdvEl.textContent;
  document.getElementById('modalGenelToplam').textContent = genelToplamEl.textContent;
  modal.style.display='flex';
});
document.getElementById('closeModal').addEventListener('click', ()=>{ modal.style.display='none'; });

// Sesli sipariş (dinamik)
const startVoice = document.getElementById('startVoice');
const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = 'tr-TR';
recognition.interimResults = false;
startVoice.addEventListener('click', ()=>recognition.start());
recognition.addEventListener('result',(e)=>{
  const text = e.results[0][0].transcript.toLowerCase();
  const reyonlar = [...new Set(urunlerData.map(u=>u.reyon.toLowerCase()))];
  const match = reyonlar.find(r => text.includes(r));
  if(match){
    urunPanel.classList.remove('hidden');
    urunReyon.textContent = match.toUpperCase();
    urunlerContainer.innerHTML = '';
    urunlerData.filter(u=>u.reyon.toLowerCase()===match).forEach(u=>{
      const card = document.createElement('div');
      card.className = 'urun-card bg-white p-2 rounded shadow flex flex-col items-center';
      card.innerHTML = `<img src="${u.image_url}" class="w-20 h-20 mb-1" alt="${u.name}">
                        <p class="text-sm font-semibold">${u.name}</p>
                        <p>₺${u.fiyat}</p>
                        <button class="mt-1 bg-green-600 text-white px-2 py-1 rounded addToCart">Sepete Ekle</button>`;
      card.querySelector('.addToCart').addEventListener('click', ()=>{
        const li = document.createElement('li');
        li.textContent = `${u.name} - 1 adet - ₺${u.fiyat.toFixed(2)}`;
        li.classList.add('fade-in');
        sepet.appendChild(li);
        guncelleOzet();
      });
      urunlerContainer.appendChild(card);
    });
  }
});

// Ödeme ve sipariş gönderme
async function siparisVer(siparis){
  const { data, error } = await supabase.from('orders').insert([siparis]).select();
  if(error){ console.error(error); return null; }
  return data[0];
}
async function siparisGonder(odemeYontemi){
  const urunlerSepet = [];
  document.querySelectorAll('#sepet li').forEach(li=>{
    const match = li.textContent.match(/(.*) - (\d+) adet - ₺(\d+(\.\d+)?)/);
    if(match) urunlerSepet.push({ad: match[1], adet: parseInt(match[2]), fiyat: parseFloat(match[3])});
  });
  if(urunlerSepet.length===0){ alert("Sepet boş!"); return; }
  const toplamTutar = parseFloat(genelToplamEl.textContent);
  const siparis = {
    user: document.getElementById('userName').textContent,
    urunler: urunlerSepet,
    toplam: toplamTutar,
    odeme: odemeYontemi,
    bonusKullan: harcananBonus
  };
  const result = await siparisVer(siparis);
  if(result?.id){
    alert(`Siparişiniz alındı! ID: ${result.id}`);
    mevcutBonus = mevcutBonus - harcananBonus + Math.floor(toplamTutar*0.05);
    harcananBonus = 0;
    guncelleOzet();
    sepet.innerHTML = '';
  } else { alert("Sipariş gönderilemedi!"); }
}
document.getElementById('payNakit').addEventListener('click', ()=>siparisGonder('Kapıda Nakit'));
document.getElementById('payKart').addEventListener('click', ()=>siparisGonder('Kapıda Kredi Kartı'));
document.getElementById('payBonus').addEventListener('click', ()=>siparisGonder('Bonus ile Ödeme'));

// WhatsApp paylaşımı
document.getElementById('shareBtn').addEventListener('click', ()=>{
  const referansLink = encodeURIComponent(window.location.href);
  const mesaj = encodeURIComponent('Merhaba! Bu linkten sipariş verebilirsin: ');
  window.open(`https://api.whatsapp.com/send?text=${mesaj}${referansLink}`,'_blank');
});
</script>
</body>
</html>
