<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Sipariş Sayfası</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #444; }
    .profile, .selectors, .products, .cart { margin-bottom: 20px; }
    select, button { margin: 5px; padding: 5px; }
    .product-card {
      display: inline-block;
      width: 150px;
      margin: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      text-align: center;
    }
    .cart-list { border-top: 1px solid #ccc; margin-top: 10px; padding-top: 10px; }
  </style>
</head>
<body>

<h1>Sipariş Sayfası</h1>

<div class="profile">
  <h3>Profilim</h3>
  <div id="profile-info">Yükleniyor...</div>
</div>

<div class="selectors">
  <label>Reyon:</label>
  <select id="reyonSelect"></select>
  <label>Kategori:</label>
  <select id="categorySelect"></select>
  <label>Ürün:</label>
  <select id="productSelect"></select>
</div>

<div class="products" id="products">
  <h3>Ürünler</h3>
  <div id="product-list"></div>
</div>

<div class="cart">
  <h3>Sepet</h3>
  <div id="cart-list"></div>
  <div id="cart-total">Toplam: 0₺</div>
</div>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
<script>
/* =================== CONFIG =================== */
const SUPABASE_URL = "https://xliutvspwodhoaxvysks.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsaXV0dnNwd29kaG9heHZ5c2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTgyOTksImV4cCI6MjA3MjkzNDI5OX0.Zodisa_ifP8t2Q4X0ecnB56RiR_Bg4QS5gvPn5ZLK_w";
const { createClient } = supabase;
const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
/* =============================================== */

let cart = [];

// Profil yükle
async function loadProfile() {
  const { data: { session } } = await client.auth.getSession();
  if (!session) {
    document.getElementById("profile-info").innerText = "Oturum yok!";
    return;
  }
  const userId = session.user.id;
  const { data, error } = await client.from("profiles").select("full_name, role, phone, address, city").eq("id", userId).single();
  if (error) {
    document.getElementById("profile-info").innerText = "Hata: " + error.message;
  } else {
    document.getElementById("profile-info").innerText =
      `Ad: ${data.full_name} | Rol: ${data.role} | Tel: ${data.phone} | Adres: ${data.address} / ${data.city}`;
  }
}

// Reyonları doldur
async function loadReyons() {
  const { data, error } = await client.from("reyon").select("id, name");
  if (error) return;
  const select = document.getElementById("reyonSelect");
  select.innerHTML = "";
  data.forEach(r => {
    const opt = document.createElement("option");
    opt.value = r.id;
    opt.textContent = r.name;
    select.appendChild(opt);
  });
}

// Kategorileri doldur (seçilen reyon bazlı)
async function loadCategories(reyonId) {
  const { data, error } = await client.from("categories").select("id, name").eq("reyon_id", reyonId);
  if (error) return;
  const select = document.getElementById("categorySelect");
  select.innerHTML = "";
  data.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.name;
    select.appendChild(opt);
  });
}

// Ürünleri doldur (seçilen kategori bazlı)
async function loadProducts(categoryId) {
  const { data, error } = await client.from("products").select("id, name, price, imgurl").eq("category_id", categoryId);
  if (error) return;
  const container = document.getElementById("product-list");
  container.innerHTML = "";
  data.forEach(p => {
    const card = document.createElement("div");
    card.className = "product-card";
    card.innerHTML = `
      <img src="${p.imgurl}" alt="${p.name}" width="80"><br>
      ${p.name}<br>
      ${p.price}₺<br>
      <button onclick="addToCart('${p.id}', '${p.name}', ${p.price})">Sepete Ekle</button>
    `;
    container.appendChild(card);
  });
}

// Sepete ekle
function addToCart(id, name, price) {
  cart.push({ id, name, price, qty: 1 });
  renderCart();
}

// Sepeti göster
function renderCart() {
  const list = document.getElementById("cart-list");
  list.innerHTML = "";
  let total = 0;
  cart.forEach(item => {
    total += item.price * item.qty;
    list.innerHTML += `<div>${item.name} x${item.qty} - ${item.price * item.qty}₺</div>`;
  });
  document.getElementById("cart-total").innerText = "Toplam: " + total + "₺";
}

// Eventler
document.getElementById("reyonSelect").addEventListener("change", e => loadCategories(e.target.value));
document.getElementById("categorySelect").addEventListener("change", e => loadProducts(e.target.value));

// Başlangıç
(async function init() {
  await loadProfile();
  await loadReyons();
})();
</script>

</body>
</html>
