<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Onur Market - Sipariş Sistemi</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:0;}
#productsGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;padding:10px;}
.card{padding:10px;background:#f9f9f9;border-radius:8px;text-align:center;cursor:pointer;transition:transform 0.2s;}
#cartModal,#cartList,#modalCartList{padding:10px;}
</style>
</head>
<body>

<h2>Onur Market</h2>

<!-- Kullanıcı Bilgileri / Bonus -->
<div>
    Hoşgeldiniz: <span id="currentUser">Giriş Yapılmadı</span> | 
    Bonus: <span id="p_bonus">0 ₺</span>
</div>

<!-- Sesli Üyelik -->
<button id="voiceRegisterBtn">Sesli Üyelik Kaydı</button>

<!-- Satıcı Seçim -->
<select id="sellerSelect">
    <option value="">-- Satıcı Seçin --</option>
</select>

<!-- Ürün Listesi -->
<div id="productsGrid"></div>

<!-- Sepet -->
<h3>Sepet</h3>
<div id="cartList"></div>
<div id="modalCartList"></div>
<div>Toplam: <span id="cartTotal">0 ₺</span></div>

<!-- Ödeme Butonları -->
<button id="payCash">Nakit Öde</button>
<button id="payCard">Kart Öde</button>
<button id="payBonus">Bonus ile Öde</button>

<script>
/* ====== SUPABASE INIT ====== */
const SUPABASE_URL = 'https://YOUR_PROJECT.supabase.co';
const SUPABASE_KEY = 'YOUR_ANON_KEY';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ====== GLOBALS ====== */
let cart = [];
let currentProfile = null;
const cartList = document.getElementById('cartList');
const modalCartList = document.getElementById('modalCartList');
const p_bonus = document.getElementById('p_bonus');
const productsGrid = document.getElementById('productsGrid');
const sellerSelect = document.getElementById('sellerSelect');

/* ====== MONEY FORMAT ====== */
function money(amount){ return Number(amount).toLocaleString('tr-TR', { style:'currency', currency:'TRY' }); }

/* ====== CART RENDER ====== */
function renderCart(){
    cartList.innerHTML='';
    modalCartList.innerHTML='';
    if(!cart.length){ 
        cartList.innerHTML='<div class="text-sm text-gray-500">Sepet boş</div>'; 
        updateTotals(); 
        return; 
    }
    cart.forEach((it,idx)=>{
        const row=document.createElement('div');
        row.className='flex items-center gap-2';
        row.innerHTML=`<img src="${it.img||'https://via.placeholder.com/48'}" class="w-12 h-12 object-cover rounded" />
        <div class="flex-1 text-sm">
            <div class="font-semibold">${it.name}</div>
            <div class="text-xs text-gray-500">Birim: ${money(it.price)} • x${it.qty}</div>
        </div>
        <div class="text-sm font-semibold">${money(it.price*it.qty)}</div>`;
        cartList.appendChild(row);
        const modalRow=row.cloneNode(true); modalCartList.appendChild(modalRow);
    });
    updateTotals();
}

/* ====== UPDATE TOTALS ====== */
function updateTotals(){
    const total = cart.reduce((s,it)=> s + it.price*it.qty,0);
    document.getElementById('cartTotal').textContent = money(total);
}

/* ====== MODAL CART ====== */
function renderCartModal(){
    if(!modalCartList) return;
    modalCartList.innerHTML = '';
    if(!cart.length){ 
        modalCartList.innerHTML = '<div class="text-sm text-gray-500">Sepet boş</div>'; 
        return; 
    }
    cart.forEach(it => {
        const row = document.createElement('div');
        row.className = 'flex justify-between items-center mb-1';
        row.innerHTML = `
            <div class="flex-1">${it.name}</div>
            <div>${it.qty} x ${money(it.price)}</div>
            <div>${money(it.price*it.qty)}</div>
        `;
        modalCartList.appendChild(row);
    });
}

/* ====== CLEAR CART ====== */
function clearCart(){
    cart = [];
    renderCart();
    renderCartModal();
    updateTotals();
}

/* ====== REFERRAL / BONUS ====== */
async function refreshUserBonus(){
    if(!currentProfile?.id) return;
    const { data, error } = await supabase
        .from('referral_bonus_summary')
        .select('kalan_bonus')
        .eq('user_id', currentProfile.id)
        .maybeSingle();
    if(error){ console.error(error); return; }
    const kalan = data?.kalan_bonus ?? 0;
    p_bonus.textContent = money(kalan);
}

/* ====== FINALIZE ORDER ====== */
async function finalizeOrder(method){
    if (!currentProfile?.id) return alert('Lütfen giriş yapın ve profilinizi tamamlayın.');
    if (!cart.length) return alert('Sepet boş.');

    const items = cart.map(it => ({
        product_id: it.product_id,
        quantity: it.qty,
        unit_price: it.price
    }));

    let bonusToUse = 0;
    if(method === 'bonus'){
        const { data } = await supabase.from('referral_bonus_summary')
            .select('kalan_bonus')
            .eq('user_id', currentProfile.id)
            .maybeSingle();
        const kalan = data?.kalan_bonus ?? 0;
        if(kalan <= 0) return alert('Yeterli bonus yok.');
        const subtotal = cart.reduce((s,it)=> s + it.price*it.qty, 0);
        bonusToUse = Math.min(kalan, subtotal);
    }

    try{
        const { data, error } = await supabase.rpc('create_order_with_bonus', {
            p_user_id: currentProfile.id,
            p_items: items,
            p_bonus_used: bonusToUse,
            p_payment_type: (bonusToUse>0 ? 'bonus+' + method : method)
        });
        if(error){ console.error(error); return alert('Sipariş oluşturulamadı: ' + error.message); }

        const orderId = data;
        alert('Sipariş kaydedildi. Sipariş ID: ' + orderId);

        clearCart();
        await refreshUserBonus();
        openReceiptPrint(orderId);
        postOrderUIUpdates();

    } catch(err){
        console.error(err); 
        alert('Sipariş sırasında hata oluştu: ' + (err.message || err));
    }
}

/* ====== PRINT RECEIPT ====== */
async function openReceiptPrint(orderId){
    let orderData;
    try{
        const q = await supabase.rpc('get_order_receipt', { p_order_id: orderId });
        orderData = q?.data;
    } catch(e){ console.warn('RPC çalışmadı, fallback kullanılıyor'); }

    if(!orderData){
        const { data: order } = await supabase.from('orders').select('*').eq('id', orderId).maybeSingle();
        const { data: details } = await supabase.from('order_details').select('*').eq('order_id', orderId);
        const { data: profile } = await supabase.from('profiles')
            .select('full_name, phone, address, city').eq('id', order.user_id).maybeSingle();
        orderData = { order, details, profile };
    }

    let html = `<div style="font-family: Arial; padding:10px; width:320px;">
        <h3>Onur Market</h3>
        <div>Sipariş No: ${orderId}</div>
        <div>Tarih: ${new Date().toLocaleString()}</div>
        <div>Müşteri: ${orderData.profile?.full_name || ''}</div>
        <div>Tel: ${orderData.profile?.phone || ''}</div>
        <hr/>`;

    (orderData.details || []).forEach(d => {
        html += `<div style="display:flex; justify-content:space-between;">
                    <div>${d.product_id}</div>
                    <div>${d.quantity} x ${money(d.unit_price)}</div>
                 </div>`;
    });

    html += `<hr/><div>Toplam: ${money(orderData.order.total_amount)}</div></div>`;

    const w = window.open('', '_blank', 'width=400,height=600');
    w.document.write(html);
    w.document.close();
    w.print();
}

/* ====== SESLİ ÜYELİK ====== */
const voiceRegisterBtn = document.getElementById('voiceRegisterBtn');
let voiceRegRecognition = null;
function setupVoiceRegistration(){
    if(!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) return;
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    voiceRegRecognition = new SpeechRecognition();
    voiceRegRecognition.lang = 'tr-TR';
    voiceRegRecognition.interimResults = false;

    voiceRegRecognition.onresult = async (ev) => {
        const transcript = ev.results[ev.results.length-1][0].transcript.toLowerCase().trim();
        const nameMatch = transcript.match(/adım\s+(\w+)/);
        const phoneMatch = transcript.match(/telefon\s+(\d{10,11})/);
        const cityMatch = transcript.match(/konum\s+(\w+)/);
        if(!nameMatch || !phoneMatch || !cityMatch) return alert('Ad, telefon ve konum söyleyin.');
        const full_name = nameMatch[1], phone = phoneMatch[1], city = cityMatch[1];

        const { data, error } = await supabase.auth.signUp({ email: phone+'@dummy.com', password: Math.random().toString(36).slice(-8) });
        if(error) return alert('Kayıt başarısız: '+error.message);
        const userId = data.user.id;
        await supabase.from('profiles').insert({ id:userId, full_name, phone, city, role:'customer', location: city });
        alert('Sesli kayıt tamamlandı. Hoşgeldiniz, '+full_name);
        await loadSessionAndProfile();
    };
}
voiceRegisterBtn?.addEventListener('click', ()=> {
    if(!voiceRegRecognition) setupVoiceRegistration();
    voiceRegRecognition.start();
});

/* ====== LOKASYON BAZLI SATICI ====== */
async function checkSellersForLocation(city){
    const { data: sellersData } = await supabase.from('profiles')
        .select('id, full_name').eq('role','market').eq('location', city);
    if(!sellersData.length) return alert('Bu lokasyon için aktif satıcı bulunamadı.');
    sellerSelect.innerHTML = '<option value="">-- Satıcı seçin --</option>';
    sellersData.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.full_name;
        sellerSelect.appendChild(opt);
    });
}

/* ====== 2.5D ÜRÜN GÖRSELLERİ ====== */
function add3DEffectToProducts(){
    productsGrid.querySelectorAll('.card').forEach(card => {
        card.style.transformStyle = 'preserve-3d';
        card.addEventListener('mouseenter', ()=>{ card.style.transform='rotateX(10deg) rotateY(10deg)'; });
        card.addEventListener('mouseleave', ()=>{ card.style.transform='rotateX(0deg) rotateY(0deg)'; });
    });
}

/* ====== REFERRAL & BONUS LOG ====== */
async function updateReferralAndBonus(orderId){
    await refreshUserBonus();
    const { data: ref } = await supabase.from('referral_links')
        .select('*').eq('owner_user_id', currentProfile.id).maybeSingle();
    if(ref) await supabase.from('referral_usage').insert({
        referral_id: ref.id,
        user_id: currentProfile.id,
        order_id: orderId,
        used_at: new Date()
    });
}

/* ====== POST ORDER UI ====== */
function postOrderUIUpdates(){
    renderCartModal();
    add3DEffectToProducts();
}

/* ====== EVENT LISTENERS ====== */
document.getElementById('payCash')?.addEventListener('click', ()=>finalizeOrder('nakit'));
document.getElementById('payCard')?.addEventListener('click', ()=>finalizeOrder('kart'));
document.getElementById('payBonus')?.addEventListener('click', ()=>finalizeOrder('bonus'));

/* ====== INIT ====== */
renderCartModal();
updateTotals();
add3DEffectToProducts();
refreshUserBonus();
</script>

</body>
</html>
