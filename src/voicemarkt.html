       // Global state
        let currentCustomer = null;
        let sellers = [];
        let reyonlar = [];
        let categories = [];
        let products = [];
        let cart = [];
        let recognition = null;
        let isListening = false;
        let isMicrophoneEnabled = false;
        let conversationStep = 0;
        let currentPaymentMethod = null;
        let orderStatusInterval = null;
        let referralCode = null;
        let referralGroupCode = null;
        let selectedSellerId = null;
        let locationCheckTimer = null;
        let locationCheckAttempts = 0;
        let conversationHistory = [];
        const MAX_LOCATION_CHECK_ATTEMPTS = 10;

        // DOM Elements
        const userNameEl = document.getElementById("userName");
        const userMetaEl = document.getElementById("userMeta");
        const p_name = document.getElementById("p_name");
        const p_phone = document.getElementById("p_phone");
        const p_role = document.getElementById("p_role");
        const p_address = document.getElementById("p_address");
        const p_city = document.getElementById("p_city");
        const p_bonus = document.getElementById("p_bonus");
        const sellerGrid = document.getElementById("sellerGrid");
        const reyonSelect = document.getElementById("reyonSelect");
        const categorySelect = document.getElementById("categorySelect");
        const productSearch = document.getElementById("productSearch");
        const productsGrid = document.getElementById("productsGrid");
        const cartList = document.getElementById("cartList");
        const subtotalEl = document.getElementById("subtotal");
        const discountEl = document.getElementById("discount");
        const vatAmountEl = document.getElementById("vatAmount");
        const totalAmountEl = document.getElementById("totalAmount");
        const btnLoadProducts = document.getElementById("btnLoadProducts");
        const btnShareWhatsApp = document.getElementById("btnShareWhatsApp");
        const voiceBtn = document.getElementById("voiceBtn");
        const voiceStatus = document.getElementById("voiceStatus");
        const microphoneToggle = document.getElementById('microphoneToggle');
        const assistantMessage = document.getElementById('assistantMessage');
        const userMessage = document.getElementById('userMessage');
        const voiceIndicator = document.getElementById('voiceIndicator');
        const closeVoiceStatus = document.getElementById('closeVoiceStatus');
        const voiceStatusPanel = document.getElementById('voiceStatusPanel');
        const payCashBtn = document.getElementById('payCash');
        const payCardBtn = document.getElementById('payCard');
        const payBonusBtn = document.getElementById('payBonus');
        const mainContent = document.getElementById('mainContent');
        const sessionSaver = document.getElementById('sessionSaver');
        const locationChecker = document.getElementById('locationChecker');
        const locationTimer = document.getElementById('locationTimer');
        const productAnimationContainer = document.getElementById('productAnimationContainer');
        const orderStatusProgress = document.getElementById('orderStatusProgress');
        const orderStatusText = document.getElementById('orderStatusText');

        // Utility functions
        function money(n){ return Number(n||0).toLocaleString('tr-TR',{minimumFractionDigits:2, maximumFractionDigits:2}) + ' ₺'; }

        // Chat.js API Entegrasyonu
        async function getAIResponse(userMessage, context = {}) {
            try {
                const requestData = {
                    message: userMessage,
                    context: {
                        customerName: currentCustomer?.name,
                        city: currentCustomer?.city,
                        cartCount: cart.length,
                        totalAmount: totalAmountEl.textContent,
                        conversationStep: conversationStep,
                        ...context
                    },
                    history: conversationHistory.slice(-4)
                };

                const response = await fetch(CHAT_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                const aiResponse = data.reply;

                // Konuşma geçmişine ekle
                conversationHistory.push(
                    { role: "user", content: userMessage },
                    { role: "assistant", content: aiResponse }
                );

                return aiResponse;

            } catch (error) {
                console.error('Chat API hatası:', error);
                return getRuleBasedResponse(userMessage, context);
            }
        }


// Kural veritabanı (rules tablosu yapısı)
const businessRules = {
    "Üyelik": {
        keywords: ["üye", "kayıt", "giriş", "login", "kayıt ol", "giriş yap"],
        actions: ["check_membership", "create_member"],
        responses: {
            "welcome": "Merhaba efendim! Onur Market'e hoş geldiniz. Giriş yapmak ister misiniz?",
            "ask_phone": "Telefon numaranızı söyler misiniz?",
            "ask_name": "Teşekkürler. Adınızı ve soyadınızı söyler misiniz?",
            "ask_city": "Hangi şehirden alışveriş yapmak istiyorsunuz?",
            "ask_address": "Tamam. Son olarak, adresinizi öğrenebilir miyim?",
            "success": "Teşekkürler. Üyeliğiniz oluşturuldu. Size en yakın satıcılar yükleniyor."
        }
    },
    "Satıcılar": {
        keywords: ["satıcı", "market", "mağaza", "dükkan", "şube"],
        actions: ["load_sellers", "select_seller"],
        responses: {
            "loading": "Size en yakın satıcılar yükleniyor...",
            "found": "{{count}} satıcı bulundu. Hangisini seçmek istersiniz?",
            "selected": "{{seller}} satıcısı seçildi. Ürünler yükleniyor."
        }
    },
    "Reyonlar": {
        keywords: ["reyon", "bölüm", "departman", "manav", "kasap", "şarküteri"],
        actions: ["load_departments"],
        responses: {
            "list": "Mevcut reyonlar: {{departments}}",
            "selected": "{{department}} reyonu seçildi."
        }
    },
    "Kategoriler": {
        keywords: ["kategori", "çeşit", "tür", "sebze", "meyve", "içecek"],
        actions: ["load_categories"],
        responses: {
            "list": "{{department}} reyonundaki kategoriler: {{categories}}",
            "selected": "{{category}} kategorisi seçildi."
        }
    },
    "Ürünler": {
        keywords: ["ürün", "mal", "yiyecek", "içecek", "domates", "ekmek", "süt"],
        actions: ["search_products", "add_to_cart"],
        responses: {
            "found": "{{count}} ürün bulundu.",
            "added": "{{product}} sepete eklendi.",
            "not_found": "Üzgünüm, '{{product}}' bulamadım."
        }
    },
    "Sepet": {
        keywords: ["sepet", "sepete ekle", "sepete koy", "alışveriş"],
        actions: ["view_cart", "update_cart", "clear_cart"],
        responses: {
            "empty": "Sepetiniz boş.",
            "items": "Sepetinizde {{count}} ürün var. Toplam: {{total}}",
            "updated": "Sepet güncellendi."
        }
    },
    "Ödeme": {
        keywords: ["ödeme", "öde", "fatura", "hesap", "nakit", "kart", "bonus"],
        actions: ["select_payment", "process_payment"],
        responses: {
            "options": "Ödeme seçenekleri: Nakit, Kredi Kartı, Bonus Puan",
            "selected": "{{method}} ödeme seçildi.",
            "processing": "Ödeme işleminiz gerçekleştiriliyor..."
        }
    },
    "Teslimat": {
        keywords: ["teslimat", "kargo", "adres", "ev", "iş", "getir"],
        actions: ["set_delivery"],
        responses: {
            "confirm": "Teslimat adresiniz: {{address}}. Onaylıyor musunuz?",
            "scheduled": "Teslimatınız {{time}} için planlandı."
        }
    }
};

// Konuşma durumu yönetimi
const conversationFlow = {
    currentStep: "welcome",
    expectedResponses: ["evet", "hayır", "telefon", "isim", "şehir", "adres"],
    context: {}
};

// Kural tabanlı komut işleme
function processRuleBasedCommand(transcript) {
    const message = transcript.toLowerCase();
    
    // Mevcut adıma göre işlem yap
    switch (conversationFlow.currentStep) {
        case "welcome":
            return processWelcomeStep(message);
        case "ask_phone":
            return processPhoneStep(message);
        case "ask_name":
            return processNameStep(message);
        case "ask_city":
            return processCityStep(message);
        case "ask_address":
            return processAddressStep(message);
        case "main_menu":
            return processMainMenu(message);
        default:
            return processGeneralCommand(message);
    }
}

// Karşılama adımı
function processWelcomeStep(message) {
    if (message.includes('evet') || message.includes('tabi') || message.includes('olur')) {
        conversationFlow.currentStep = "ask_phone";
        return businessRules.Üyelik.responses.ask_phone;
    } else if (message.includes('hayır') || message.includes('istemiyorum')) {
        return "Peki, ihtiyacınız olduğunda buradayım. İyi günler!";
    } else {
        return businessRules.Üyelik.responses.welcome;
    }
}

// Telefon adımı
function processPhoneStep(message) {
    const phoneMatch = message.match(/\d+/g);
    if (phoneMatch && phoneMatch.join('').length >= 10) {
        const phone = phoneMatch.join('');
        conversationFlow.context.phone = phone;
        conversationFlow.currentStep = "ask_name";
        return businessRules.Üyelik.responses.ask_name;
    } else {
        return "Telefon numaranızı anlayamadım. Lütfen 10 haneli numaranızı söyler misiniz?";
    }
}

// İsim adımı
function processNameStep(message) {
    if (message.trim().length > 2) {
        conversationFlow.context.name = message.trim();
        conversationFlow.currentStep = "ask_city";
        return businessRules.Üyelik.responses.ask_city;
    } else {
        return "İsminizi anlayamadım. Lütfen adınızı ve soyadınızı söyler misiniz?";
    }
}

// Şehir adımı
function processCityStep(message) {
    if (message.trim().length > 2) {
        conversationFlow.context.city = message.trim();
        conversationFlow.currentStep = "ask_address";
        return businessRules.Üyelik.responses.ask_address;
    } else {
        return "Şehir bilgisini anlayamadım. Lütfen şehir adını söyler misiniz?";
    }
}

// Adres adımı
function processAddressStep(message) {
    if (message.trim().length > 5) {
        conversationFlow.context.address = message.trim();
        conversationFlow.currentStep = "main_menu";
        
        // Müşteri kaydını oluştur
        createCustomerProfile();
        
        return businessRules.Üyelik.responses.success;
    } else {
        return "Adres bilgisini anlayamadım. Lütfen tam adresinizi söyler misiniz?";
    }
}

// Ana menü işlemleri
function processMainMenu(message) {
    // Ürün arama ve sepete ekleme
    const productMatch = message.match(/(\d+)?\s*(kilo|gram|litre|adet|tane|paket)?\s*([a-zçğıöşü\s]+)/i);
    if (productMatch) {
        return processProductOrder(message, productMatch);
    }
    
    // Sepet işlemleri
    if (message.includes('sepet') || message.includes('sepete') || message.includes('sepetim')) {
        return processCartOperations(message);
    }
    
    // Ödeme işlemleri
    if (message.includes('ödeme') || message.includes('öde') || message.includes('fatura')) {
        return processPaymentOperations(message);
    }
    
    // Satıcı işlemleri
    if (message.includes('satıcı') || message.includes('market') || message.includes('mağaza')) {
        return processSellerOperations(message);
    }
    
    // Anlamadığımız komutlar için AI'ya yönlendir
    return processWithAI(message);
}

// Ürün sipariş işlemi
function processProductOrder(message, productMatch) {
    const quantity = productMatch[1] ? parseInt(productMatch[1]) : 1;
    const unit = productMatch[2] || 'adet';
    const productName = productMatch[3].trim();
    
    const product = findProductByRule(productName);
    
    if (product) {
        addToCartByProduct(product, quantity, true);
        return `{{product}} ${quantity} ${unit} sepete eklendi.`.replace('{{product}}', product.name);
    } else {
        return `Üzgünüm, '${productName}' bulamadım. Lütfen başka bir ürün söyleyin.`;
    }
}

// Kural tabanlı ürün bulma
function findProductByRule(productName) {
    // Öncelikle tam eşleşme
    let product = products.find(p => 
        p.name.toLowerCase().includes(productName.toLowerCase())
    );
    
    if (product) return product;
    
    // Kategori bazlı eşleştirme
    const categoryMapping = {
        'domates': ['domates', 'salça', 'biber'],
        'salatalık': ['salatalık', 'turşu', 'hıyar'],
        'elma': ['elma', 'meyve', 'armut'],
        'ekmek': ['ekmek', 'simit', 'poğaça'],
        'süt': ['süt', 'yoğurt', 'ayran']
    };
    
    for (const [category, keywords] of Object.entries(categoryMapping)) {
        if (keywords.some(keyword => productName.includes(keyword))) {
            return products.find(p => p.category === category) || products[0];
        }
    }
    
    return null;
}

// Sepet işlemleri
function processCartOperations(message) {
    if (message.includes('göster') || message.includes('liste') || message.includes('ne var')) {
        if (cart.length === 0) {
            return businessRules.Sepet.responses.empty;
        } else {
            const total = calculateSubtotal();
            return businessRules.Sepet.responses.items
                .replace('{{count}}', cart.length)
                .replace('{{total}}', money(total));
        }
    }
    
    if (message.includes('temizle') || message.includes('boşalt')) {
        cart = [];
        updateCartUI();
        return "Sepetiniz temizlendi.";
    }
    
    return "Sepetinizde " + cart.length + " ürün var. Toplam: " + totalAmountEl.textContent;
}

// Ödeme işlemleri
function processPaymentOperations(message) {
    if (message.includes('nakit')) {
        selectPaymentMethod('nakit');
        return businessRules.Ödeme.responses.selected.replace('{{method}}', 'Nakit');
    }
    
    if (message.includes('kart') || message.includes('kredi')) {
        selectPaymentMethod('kart');
        return businessRules.Ödeme.responses.selected.replace('{{method}}', 'Kredi Kartı');
    }
    
    if (message.includes('bonus')) {
        selectPaymentMethod('bonus');
        return businessRules.Ödeme.responses.selected.replace('{{method}}', 'Bonus Puan');
    }
    
    return businessRules.Ödeme.responses.options;
}

// Satıcı işlemleri
function processSellerOperations(message) {
    if (!currentCustomer?.location) {
        return "Önce konum bilginizi belirlememiz gerekiyor. Lütfen adresinizi güncelleyin.";
    }
    
    loadSellersByLocation();
    return businessRules.Satıcılar.responses.loading;
}

// AI ile işlem (sadece kural dışı durumlarda)
async function processWithAI(message) {
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                message: message,
                context: {
                    currentStep: conversationFlow.currentStep,
                    customer: currentCustomer,
                    cartCount: cart.length
                }
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            return data.reply;
        }
    } catch (error) {
        console.error('AI hatası:', error);
    }
    
    return "Anlayamadım efendim. Lütfen ürün adı söyleyin, sepete bakın veya ödeme yapın.";
}

// Müşteri profili oluşturma
async function createCustomerProfile() {
    const customerData = {
        name: conversationFlow.context.name,
        phone: conversationFlow.context.phone,
        city: conversationFlow.context.city,
        address: conversationFlow.context.address,
        role: 'Üye',
        bonus_amount: 0,
        created_at: new Date().toISOString()
    };
    
    try {
        const { data, error } = await supabase
            .from('customers')
            .insert([customerData])
            .select()
            .single();
            
        if (!error) {
            currentCustomer = data;
            updateCustomerUI();
            enableUI();
            loadSellersByLocation();
        }
    } catch (error) {
        console.error('Müşteri kaydı hatası:', error);
    }
}

// Sesli komut işleme (ana fonksiyon)
async function processVoiceCommand(transcript) {
    // Önce kural tabanlı sistemi dene
    const ruleBasedResponse = processRuleBasedCommand(transcript);
    
    if (ruleBasedResponse) {
        speakToUser(ruleBasedResponse);
        return;
    }
    
    // Kural tabanlı sistem cevap vermezse AI'ya yönlendir
    const aiResponse = await processWithAI(transcript);
    speakToUser(aiResponse);
}

// Mevcut kullanıcı arayüzü fonksiyonları (değişmeden kalacak)
function speakToUser(message) {
    assistantMessage.textContent = message;
    
    if ('speechSynthesis' in window) {
        const speech = new SpeechSynthesisUtterance(message);
        speech.lang = 'tr-TR';
        speech.volume = 1;
        speech.rate = 1;
        speech.pitch = 1;
        window.speechSynthesis.speak(speech);
    }
}

// Satıcıları yükleme fonksiyonu
async function loadSellersByLocation() {
    if (!currentCustomer?.city) return;
    
    try {
        const { data, error } = await supabase
            .from('profiles')
            .select('id, full_name, city, address')
            .eq('role', 'seller')
            .ilike('city', `%${currentCustomer.city}%`)
            .limit(10);
            
        if (!error && data.length > 0) {
            sellers = data;
            updateSellersGrid();
            speakToUser(`${data.length} satıcı bulundu. Size en yakın şubeler yüklendi.`);
        } else {
            speakToUser("Size yakın satıcı bulunamadı. Lütfen daha sonra tekrar deneyin.");
        }
    } catch (error) {
        console.error('Satıcı yükleme hatası:', error);
    }
}

// Kalan fonksiyonlar (önceki kodunuzdaki gibi kalacak)
// updateCustomerUI, enableUI, addToCartByProduct, calculateSubtotal, vb.

        // Satıcı grid'ini güncelle
        function updateSellersGrid() {
            sellerGrid.innerHTML = '';
            
            if (sellers.length === 0) {
                sellerGrid.innerHTML = '<div class="text-sm text-gray-500 text-center">Satıcı bulunamadı</div>';
                return;
            }
            
            sellers.forEach(seller => {
                const sellerCard = document.createElement('div');
                sellerCard.className = 'seller-card';
                if (selectedSellerId === seller.id) {
                    sellerCard.classList.add('selected');
                }
                
                sellerCard.innerHTML = `
                    <img src="${seller.imgurl || 'https://via.placeholder.com/50'}" alt="${seller.full_name}">
                    <div class="seller-name">${seller.full_name}</div>
                `;
                
                sellerCard.addEventListener('click', () => {
                    document.querySelectorAll('.seller-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    
                    sellerCard.classList.add('selected');
                    selectedSellerId = seller.id;
                    
                    loadSellerData(seller.id);
                });
                
                sellerGrid.appendChild(sellerCard);
            });
        }

        // Satıcı verilerini yükle
        async function loadSellerData(sellerId) {
            try {
                const selectedSeller = sellers.find(s => s.id === sellerId);
                if (selectedSeller) {
                    speakToUser(`${selectedSeller.full_name} satıcısının ürünleri yükleniyor.`);
                }
                
                // Ürünleri yükle
                const { data: productData, error: productError } = await supabase
                    .from('products')
                    .select(`
                        id, name, description, price, stock, currency, 
                        gtip_code, imgurl, unit_type, barcode, brand, category_id, reyon_id,
                        discount_price
                    `)
                    .limit(50);
                
                if (productError) {
                    console.error('Ürün yükleme hatası:', productError);
                    products = [];
                } else {
                    products = productData || [];
                }
                
                displayProducts(products);
                
                speakToUser(`${products.length} ürün yüklendi. Sesli olarak veya listeden ürün seçebilirsiniz.`);
                
            } catch (error) {
                console.error('Satıcı verileri yüklenme hatası:', error);
                speakToUser("Satıcı verileri yüklenirken bir hata oluştu. Lütfen daha sonra tekrar deneyin.");
            }
        }

        // Siparişi tamamla
        async function finalizeOrder(paymentMethod) {
            try {
                if (cart.length === 0) {
                    speakToUser("Sepetiniz boş. Lütfen önce ürün ekleyin.");
                    return;
                }
                
                speakToUser("Siparişiniz işleniyor. Lütfen bekleyin...");
                
                // Sipariş toplamlarını hesapla
                const subtotal = calculateSubtotal();
                const discount = calculateDiscount();
                const vatAmount = calculateVAT(subtotal - discount);
                const grandTotal = subtotal - discount + vatAmount;
                
                // Siparişi veritabanına kaydet
                const { data: order, error: orderError } = await supabase
                    .from('orders')
                    .insert([
                        {
                            user_id: currentCustomer.id,
                            currency: 'TRY',
                            discount: discount,
                            tax_total: vatAmount,
                            grand_total: grandTotal,
                            bonus_used: paymentMethod === 'bonus' ? Math.min(parseFloat(p_bonus.textContent.replace('₺', '').replace(',', '.')), grandTotal) : 0,
                            payment_type: paymentMethod,
                            shipping_company: 'Onur Market Kurye',
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }
                    ])
                    .select()
                    .single();
                
                if (orderError) throw orderError;
                
                // Sipariş başarılı mesajı
                speakToUser(`Siparişiniz başarıyla oluşturuldu! Sipariş numaranız: ${order.id}. Toplam tutar: ${money(grandTotal)}. Siparişiniz en geç 45 dakika içinde adresinize teslim edilecektir. İyi günler dileriz.`);
                
                // Sepeti temizle
                cart = [];
                updateCartUI();
                
                // Sipariş durumunu simüle et
                simulateOrderStatus(order.id);
                
            } catch (error) {
                console.error('Sipariş oluşturma hatası:', error);
                speakToUser("Sipariş oluşturulurken bir hata oluştu. Lütfen daha sonra tekrar deneyin.");
            }
        }

        // Sipariş durumunu simüle et
        function simulateOrderStatus(orderId) {
            const statuses = [
                "Atama Bekliyor",
                "Kurye Atandı",
                "Kurye Markette",
                "Kurye Yolda",
                "Kurye Adreste",
                "Kurye Ürünü Teslim Etti"
            ];
            
            let currentStatus = 0;
            
            orderStatusInterval = setInterval(() => {
                if (currentStatus < statuses.length) {
                    orderStatusText.textContent = statuses[currentStatus];
                    orderStatusProgress.style.width = `${(currentStatus + 1) * (100 / statuses.length)}%`;
                    currentStatus++;
                } else {
                    clearInterval(orderStatusInterval);
                }
            }, 10000);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        async function initApp() {
            // Sayfa yüklendiğinde oturumu geri yükle
            restoreSession();
            
            // Check for referral code in URL
            const urlParams = new URLSearchParams(window.location.search);
            referralCode = urlParams.get('referral_code');
            referralGroupCode = urlParams.get('referral_groups');
            
            if (referralCode && referralGroupCode) {
                await processReferralCode(referralCode, referralGroupCode);
            }
            
            setupEventHandlers();
            
            // Sesli asistanı başlat
            initVoiceAssistant();
            
            // Sayfa kapanmadan önce oturumu kaydet
            window.addEventListener('beforeunload', saveSession);
        }

        // Referans kodu işleme
        async function processReferralCode(code, groupCode) {
            try {
                const { data, error } = await supabase
                    .from('referral_links')
                    .select('owner_user_id, referral_code, group_code, is_used')
                    .eq('referral_code', code)
                    .eq('group_code', groupCode)
                    .single();
                
                if (error) throw error;
                
                if (data) {
                    if (data.is_used) {
                        assistantMessage.textContent = "Bu referans linki daha önce kullanılmış.";
                        return;
                    }
                    
                    referralGroupCode = data.group_code;
                    const { data: ownerData } = await supabase
                        .from('profiles')
                        .select('full_name')
                        .eq('id', data.owner_user_id)
                        .single();
                    
                    if (ownerData) {
                        assistantMessage.textContent += ` Referans ile geldiniz: ${ownerData.full_name}`;
                    }
                }
            } catch (error) {
                console.error('Referans kodu işleme hatası:', error);
            }
        }

        // Ses durumu kutusunu gizle
        function hideVoiceStatus() {
            voiceStatusPanel.style.display = 'none';
        }
    </script>
</body>
</html>
