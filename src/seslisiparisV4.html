<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sesli Sipari≈ü - Onur Market</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #5d3ebc;
            --primary-light: #7849f7;
            --secondary: #ffd300;
            --accent: #ff6b00;
            --dark: #1a1a1a;
            --light: #f8f9fa;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --success: #28a745;
            --danger: #dc3545;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            line-height: 1.6;
        }
        
        /* Header Styles */
        header {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 22px;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .logo-icon::after {
            content: "";
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--secondary);
            border-radius: 50%;
            bottom: 5px;
            right: 5px;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .action-btn {
            background: none;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: var(--transition);
            color: var(--dark);
            font-weight: 500;
            font-size: 14px;
        }
        
        .action-btn:hover {
            background: var(--gray-light);
        }
        
        .order-summary {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--primary);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .order-summary:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }
        
        .order-count {
            background: var(--secondary);
            color: var(--dark);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .language-selector {
            position: relative;
        }
        
        .language-btn {
            background: none;
            border: none;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 10px 0;
            width: 200px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 10;
        }
        
        .language-dropdown.show {
            display: block;
        }
        
        .language-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .language-option:hover {
            background: var(--gray-light);
        }
        
        .language-option.active {
            background: var(--primary);
            color: white;
        }
        
        /* Banner Styles */
        .banner {
            position: relative;
            height: 300px;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 0 20px;
        }
        
        .banner-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.2;
        }
        
        .banner-content {
            position: relative;
            z-index: 2;
            max-width: 600px;
        }
        
        .banner h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            font-weight: 700;
        }
        
        .banner p {
            font-size: 1.1rem;
            margin-bottom: 20px;
            opacity: 0.9;
        }
        
        /* Main Content */
        .main-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            flex: 1;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: var(--primary);
        }
        
        /* Horizontal Scroll Containers */
        .scroll-container {
            position: relative;
            margin-bottom: 30px;
        }
        
        .scroll-content {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
            scroll-behavior: smooth;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scroll-content::-webkit-scrollbar {
            display: none;
        }
        
        .scroll-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            z-index: 10;
            transition: var(--transition);
        }
        
        .scroll-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .scroll-btn.left {
            left: -20px;
        }
        
        .scroll-btn.right {
            right: -20px;
        }
        
        /* Store Type Cards (Horizontal) */
        .store-type-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            min-width: 150px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .store-type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .store-type-card.selected {
            border-color: var(--primary);
            background: rgba(93, 62, 188, 0.05);
        }
        
        .store-type-icon {
            font-size: 32px;
            color: var(--primary);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(93, 62, 188, 0.1);
        }
        
        .store-type-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        /* Seller Cards (Horizontal) */
        .seller-card {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            min-width: 280px;
            flex-shrink: 0;
        }
        
        .seller-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .seller-card.selected {
            border-color: var(--success);
        }
        
        .seller-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
        }
        
        .seller-info {
            padding: 15px;
        }
        
        .seller-name {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 18px;
        }
        
        .seller-details {
            font-size: 14px;
            color: var(--gray);
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .seller-rating {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--secondary);
        }
        
        .delivery-info {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--gray-light);
        }
        
        .delivery-fee {
            font-size: 14px;
            color: var(--primary);
            font-weight: 600;
        }
        
        .delivery-fee.free {
            color: var(--success);
        }
        
        .min-order {
            font-size: 12px;
            color: var(--gray);
            margin-top: 2px;
        }
        
        /* Category Cards (Horizontal) */
        .category-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            min-width: 150px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .category-card.selected {
            border-color: var(--success);
            background: rgba(40, 167, 69, 0.05);
        }
        
        .category-icon {
            font-size: 32px;
            color: var(--success);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(40, 167, 69, 0.1);
        }
        
        .category-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        /* Product Cards (Horizontal) */
        .products-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }
        
        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .product-card {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-light);
            min-width: 200px;
            flex-shrink: 0;
        }
        
        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .product-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .product-image {
            width: 100%;
            height: 140px;
            object-fit: cover;
        }
        
        .product-info {
            padding: 15px;
        }
        
        .product-name {
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
            height: 40px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .product-price {
            font-weight: 600;
            color: var(--primary);
            font-size: 16px;
        }
        
        .product-discount {
            color: var(--danger);
            font-size: 12px;
            text-decoration: line-through;
            margin-left: 5px;
        }
        
        .add-to-cart-btn {
            margin-top: 10px;
            width: 100%;
            padding: 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .add-to-cart-btn:hover {
            background: var(--primary-light);
        }
        
        /* Cart Section */
        .cart-container {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background: white;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .cart-container.open {
            right: 0;
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .cart-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray);
        }
        
        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .cart-item-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .cart-item-image {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .cart-item-details {
            font-size: 14px;
        }
        
        .cart-item-name {
            font-weight: 500;
        }
        
        .cart-item-price {
            color: var(--gray);
            font-size: 12px;
        }
        
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid var(--gray-light);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .quantity-btn:hover {
            background: var(--gray-light);
        }
        
        .cart-totals {
            border-top: 1px solid var(--gray-light);
            padding: 20px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .total-final {
            font-weight: 600;
            font-size: 18px;
            border-top: 1px solid var(--gray-light);
            padding-top: 10px;
        }
        
        .payment-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
            padding: 0 20px 20px;
        }
        
        .payment-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .payment-btn.cash {
            background: var(--success);
            color: white;
        }
        
        .payment-btn.card {
            background: var(--primary);
            color: white;
        }
        
        .payment-btn.bonus {
            background: var(--accent);
            color: white;
            grid-column: 1 / -1;
        }
        
        .payment-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        /* Footer */
        footer {
            background: var(--dark);
            color: white;
            padding: 40px 0 20px;
            margin-top: auto;
        }
        
        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
        }
        
        .footer-section h3 {
            margin-bottom: 20px;
            font-size: 18px;
            color: var(--secondary);
        }
        
        .footer-links {
            list-style: none;
        }
        
        .footer-links li {
            margin-bottom: 10px;
        }
        
        .footer-links a {
            color: #ccc;
            text-decoration: none;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .footer-links a:hover {
            color: white;
        }
        
        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .social-link {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            transition: var(--transition);
        }
        
        .social-link:hover {
            background: var(--primary);
            transform: translateY(-3px);
        }
        
        .partner-login {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .partner-login:hover {
            background: var(--primary-light);
        }
        
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            margin-top: 20px;
            border-top: 1px solid #444;
            font-size: 14px;
            color: #aaa;
        }
        
        /* Voice Assistant */
        .voice-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 300px;
            z-index: 100;
            display: block;
        }
        
        .status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .status-title {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: var(--dark);
        }
        
        .status-title i {
            margin-right: 8px;
            color: var(--accent);
        }
        
        .status-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--gray);
        }
        
        .status-content {
            margin-bottom: 15px;
        }
        
        .assistant-message {
            padding: 12px;
            background: rgba(93, 62, 188, 0.1);
            border-radius: 8px;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .user-message {
            padding: 12px;
            background: rgba(255, 107, 0, 0.1);
            border-radius: 8px;
            text-align: right;
            color: var(--accent);
        }
        
        .voice-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 30px;
            margin-top: 10px;
        }
        
        .voice-bar {
            width: 6px;
            height: 10px;
            background: #ddd;
            margin: 0 3px;
            border-radius: 3px;
        }
        
        .listening .voice-bar {
            animation: voiceIndicator 0.8s infinite;
        }
        
        @keyframes voiceIndicator {
            0%, 100% { height: 10px; background: #ddd; }
            50% { height: 30px; background: var(--accent); }
        }
        
        /* Location Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 100%;
            box-shadow: var(--shadow);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .close-modal {
            cursor: pointer;
            font-size: 24px;
            color: var(--gray);
        }
        
        .location-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .location-option {
            padding: 20px;
            border: 2px solid var(--gray-light);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .location-option:hover {
            border-color: var(--primary);
            background: rgba(93, 62, 188, 0.05);
        }
        
        .location-option.selected {
            border-color: var(--primary);
            background: rgba(93, 62, 188, 0.1);
        }
        
        .location-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .location-details h4 {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .location-details p {
            color: var(--gray);
            font-size: 14px;
        }
        
        .location-detect-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 20px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: var(--transition);
        }
        
        .location-detect-btn:hover {
            background: var(--primary-light);
        }
        
        .location-detect-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }
        
        .location-result {
            border-left: 4px solid var(--primary);
            padding: 15px;
            background: rgba(93, 62, 188, 0.05);
            border-radius: 8px;
            margin-top: 15px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .logo {
                font-size: 20px;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .banner {
                height: 250px;
            }
            
            .banner h1 {
                font-size: 2rem;
            }
            
            .banner p {
                font-size: 1rem;
            }
            
            .scroll-btn {
                display: none;
            }
            
            .cart-container {
                width: 100%;
                right: -100%;
            }
            
            .voice-status {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
            }
            
            .footer-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        
        /* Animation for logo */
        @keyframes logoPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .logo-icon {
            animation: logoPulse 2s infinite;
        }
    </style>

</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-container">
            <a href="#" class="logo">
                <div class="logo-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <span data-translate="app_name">Sesli Sipari≈ü</span>
            </a>
            
            <div class="header-actions">
                <div class="language-selector">
                    <button class="language-btn" id="languageBtn">
                        <i class="fas fa-globe"></i>
                        <span id="currentLanguage">TR</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="language-dropdown" id="languageDropdown">
                        <!-- Languages will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="location-marker action-btn" id="locationMarker">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="locationText" data-translate="select_location">Konum Se√ßin</span>
                </div>
                
                <div class="order-summary" id="orderSummary" style="display: none;">
                    <div class="order-count" id="orderCount">0</div>
                    <div data-translate="order">Sipari≈ü: <span id="orderTotal">0 ‚Ç∫</span></div>
                </div>
               
                <div class="profile-info">
                    <button class="action-btn" id="profileBtn">
                        <i class="fas fa-user"></i>
                        <span id="userName" data-translate="profile">Profilim</span>
                    </button>
                    <div class="profile-dropdown" id="profileDropdown">
                        <!-- Profile dropdown content -->
                    </div>
                </div>

                <button id="microphoneToggle" class="action-btn">
                    <i class="fas fa-microphone-slash"></i>
                    <span data-translate="microphone_off">Mikrofon (Kapalƒ±)</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Banner -->
    <div class="banner" id="banner">
        <video class="banner-video" id="bannerVideo" loop muted autoplay>
            <!-- Video will be set dynamically based on store type -->
        </video>
        <div class="banner-content">
            <h1 id="bannerTitle" data-translate="banner_title">Sesli Sipari≈ü ile Kolay Alƒ±≈üveri≈ü</h1>
            <p id="bannerDescription" data-translate="banner_description">Sadece konu≈üun, sipari≈üiniz kapƒ±nƒ±zda!</p>
            <button class="location-detect-btn" id="bannerLocationBtn">
                <i class="fas fa-location-arrow"></i>
                <span data-translate="detect_location">Konumumu Belirle</span>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-container">
         <!-- Seller Type Selection -->
        <section>
            <h2 class="section-title">Ne yemek istersiniz?</h2>
            <div class="seller-type-container">
                <button class="scroll-btn left" id="scrollSellerTypesLeft">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="seller-type-grid" id="sellerTypeGrid">
                    <!-- Satƒ±cƒ± tipleri buraya y√ºklenecek -->
                </div>
                <button class="scroll-btn right" id="scrollSellerTypesRight">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>

        <!-- Sellers Grid -->
        <section id="sellersSection" style="display: none;">
            <h2 class="section-title" data-translate="nearest_places">
                <i class="fas fa-store"></i>
                Size En Yakƒ±n Yerler
            </h2>
            <div class="scroll-container">
                <button class="scroll-btn left" id="scrollSellersLeft">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="scroll-content" id="sellerGrid">
                    <!-- Sellers will be loaded here -->
                </div>
                <button class="scroll-btn right" id="scrollSellersRight">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>

        <!-- Categories Grid -->
        <section id="categoriesSection" style="display: none;">
            <h2 class="section-title" id="categoriesTitle" data-translate="categories">
                <i class="fas fa-layer-group"></i>
                Kategoriler
            </h2>
            <div class="scroll-container">
                <button class="scroll-btn left" id="scrollCategoriesLeft">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="scroll-content" id="categoriesGrid">
                    <!-- Categories will be loaded here -->
                </div>
                <button class="scroll-btn right" id="scrollCategoriesRight">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>

        <!-- Products Grid -->
        <section class="products-section" id="productsSection" style="display: none;">
            <div class="products-header">
                <h2 class="section-title" style="margin-bottom: 0;" data-translate="products">
                    <i class="fas fa-box-open"></i>
                    √úr√ºnler
                </h2>
                <div id="selectedSellerInfo" class="text-gray">Satƒ±cƒ± se√ßilmedi</div>
            </div>
            <div class="scroll-container">
                <button class="scroll-btn left" id="scrollProductsLeft">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="scroll-content" id="productsGrid">
                    <!-- Products will be loaded here -->
                </div>
                <button class="scroll-btn right" id="scrollProductsRight">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>
    </div>

    <!-- Location Modal -->
    <div id="locationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" data-translate="select_location">Konum Se√ßiniz</h3>
                <span class="close-modal" id="closeLocationModal">&times;</span>
            </div>
            <div class="modal-body">
                <p data-translate="location_description">L√ºtfen sipari≈ü vermek istediƒüiniz konumu se√ßin:</p>
                <div class="location-options">
                    <div class="location-option" data-location="inside">
                        <div class="location-icon">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <div class="location-details">
                            <h4 data-translate="inside_restaurant">Restoran i√ßinde</h4>
                            <p data-translate="inside_description">Yemeƒüinizi restoranda yiyin</p>
                        </div>
                    </div>
                    <div class="location-option" data-location="takeaway">
                        <div class="location-icon">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <div class="location-details">
                            <h4 data-translate="takeaway">Paket servis</h4>
                            <p data-translate="takeaway_description">Yemeƒüinizi kendiniz alƒ±n</p>
                        </div>
                    </div>
                    <div class="location-option" data-location="delivery">
                        <div class="location-icon">
                            <i class="fas fa-motorcycle"></i>
                        </div>
                        <div class="location-details">
                            <h4 data-translate="delivery">Adrese teslim</h4>
                            <p data-translate="delivery_description">Yemeƒüiniz adresinize gelsin</p>
                        </div>
                    </div>
                </div>
                
                <button id="detectLocationBtn" class="location-detect-btn">
                    <i class="fas fa-location-arrow"></i>
                    <span data-translate="auto_detect">Konumumu Otomatik Belirle</span>
                </button>
                
                <div id="locationResult" class="location-result" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Cart Section -->
    <div class="cart-container" id="cartContainer">
        <div class="cart-header">
            <h2 data-translate="your_cart">Sepetiniz</h2>
            <button class="cart-close" id="cartClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="cart-items" id="cartItems">
            <div class="text-center" style="padding: 30px; color: var(--gray);">
                <i class="fas fa-shopping-cart fa-2x mb-3"></i>
                <p data-translate="empty_cart">Sepetiniz bo≈ü</p>
            </div>
        </div>
        <div class="cart-totals">
            <div class="total-row">
                <span data-translate="subtotal">Ara Toplam:</span>
                <span id="subtotal">0 ‚Ç∫</span>
            </div>
            <div class="total-row">
                <span data-translate="discount">ƒ∞ndirim:</span>
                <span id="discount">0 ‚Ç∫</span>
            </div>
            <div class="total-row">
                <span data-translate="vat">KDV (%18):</span>
                <span id="vatAmount">0 ‚Ç∫</span>
            </div>
            <div class="total-row total-final">
                <span data-translate="total">Toplam:</span>
                <span id="totalAmount">0 ‚Ç∫</span>
            </div>
        </div>
        <div class="payment-buttons">
            <button class="payment-btn cash" id="payCash" data-translate="pay_cash">Nakit √ñde</button>
            <button class="payment-btn card" id="payCard" data-translate="pay_card">Kartla √ñde</button>
            <button class="payment-btn bonus" id="payBonus" data-translate="pay_bonus">Bonus ile √ñde</button>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <div class="footer-section">
                <h3 data-translate="app_name">Sesli Sipari≈ü</h3>
                <p data-translate="footer_description">Sesli komutlarla kolayca sipari≈ü verin. Hƒ±zlƒ±, g√ºvenli ve pratik alƒ±≈üveri≈ü deneyimi.</p>
                <div class="social-links">
                    <a href="#" class="social-link"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
                    <a href="https://wa.me/?text=Merhaba!%20Sesli%20Sipari≈ü%20sisteminden%20alƒ±≈üveri≈ü%20yapmak%20istiyorum." class="social-link" target="_blank"><i class="fab fa-whatsapp"></i></a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3 data-translate="quick_links">Hƒ±zlƒ± Baƒülantƒ±lar</h3>
                <ul class="footer-links">
                    <li><a href="#" id="referralLink"><i class="fas fa-link"></i> <span data-translate="referral_link">Referans Linki</span></a></li>
                    <li><a href="#" id="whatsappOrder"><i class="fab fa-whatsapp"></i> <span data-translate="whatsapp_order">WhatsApp ile Sipari≈ü</span></a></li>
                    <li><a href="#"><i class="fas fa-shopping-bag"></i> <span data-translate="my_orders">Sipari≈ülerim</span></a></li>
                    <li><a href="#"><i class="fas fa-question-circle"></i> <span data-translate="help">Yardƒ±m</span></a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3 data-translate="contact">ƒ∞leti≈üim</h3>
                <ul class="footer-links">
                    <li><a href="tel:08501234567"><i class="fas fa-phone"></i> 0850 123 45 67</a></li>
                    <li><a href="mailto:info@seslisiparis.com"><i class="fas fa-envelope"></i> info@seslisiparis.com</a></li>
                    <li><a href="#"><i class="fas fa-map-marker-alt"></i> <span data-translate="location">ƒ∞stanbul, T√ºrkiye</span></a></li>
                </ul>
                <a href="#" class="partner-login" data-translate="partner_login">Partner Giri≈üi</a>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy; 2023 Sesli Sipari≈ü Sistemi. <span data-translate="all_rights_reserved">T√ºm haklarƒ± saklƒ±dƒ±r.</span></p>
        </div>
    </footer>

    <!-- Voice Assistant -->
    <div class="voice-status" id="voiceStatusPanel">
        <div class="status-header">
            <div class="status-title">
                <i class="fas fa-microphone"></i>
                <span data-translate="voice_assistant">Sesli Asistan</span>
            </div>
            <button class="status-close" id="closeVoiceStatus">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="status-content">
            <div class="assistant-message" id="assistantMessage" data-translate="welcome_message">Merhaba! Sipari≈ü vermek i√ßin mikrofonu a√ßƒ±n ve konu≈üun.</div>
            <div class="user-message" id="userMessage"></div>
        </div>
        <div class="voice-indicator" id="voiceIndicator">
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
        </div>
    </div>
<script>
        // =============================================
        // √áOKLU Dƒ∞L DESTEƒûƒ∞
        // =============================================
        
        const translations = {
            tr: {
                app_name: "Sesli Sipari≈ü",
                select_location: "Konum Se√ßin",
                order: "Sipari≈ü:",
                profile: "Profilim",
                microphone_off: "Mikrofon (Kapalƒ±)",
                banner_title: "Sesli Sipari≈ü ile Kolay Alƒ±≈üveri≈ü",
                banner_description: "Sadece konu≈üun, sipari≈üiniz kapƒ±nƒ±zda!",
                detect_location: "Konumumu Belirle",
                what_to_eat: "Ne yemek istersiniz?",
                nearest_places: "Size En Yakƒ±n Yerler",
                categories: "Kategoriler",
                products: "√úr√ºnler",
                inside_restaurant: "Restoran i√ßinde",
                inside_description: "Yemeƒüinizi restoranda yiyin",
                takeaway: "Paket servis",
                takeaway_description: "Yemeƒüinizi kendiniz alƒ±n",
                delivery: "Adrese teslim",
                delivery_description: "Yemeƒüiniz adresinize gelsin",
                auto_detect: "Konumumu Otomatik Belirle",
                your_cart: "Sepetiniz",
                empty_cart: "Sepetiniz bo≈ü",
                subtotal: "Ara Toplam:",
                discount: "ƒ∞ndirim:",
                vat: "KDV (%18):",
                total: "Toplam:",
                pay_cash: "Nakit √ñde",
                pay_card: "Kartla √ñde",
                pay_bonus: "Bonus ile √ñde",
                footer_description: "Sesli komutlarla kolayca sipari≈ü verin. Hƒ±zlƒ±, g√ºvenli ve pratik alƒ±≈üveri≈ü deneyimi.",
                quick_links: "Hƒ±zlƒ± Baƒülantƒ±lar",
                referral_link: "Referans Linki",
                whatsapp_order: "WhatsApp ile Sipari≈ü",
                my_orders: "Sipari≈ülerim",
                help: "Yardƒ±m",
                contact: "ƒ∞leti≈üim",
                location: "ƒ∞stanbul, T√ºrkiye",
                partner_login: "Partner Giri≈üi",
                all_rights_reserved: "T√ºm haklarƒ± saklƒ±dƒ±r.",
                voice_assistant: "Sesli Asistan",
                welcome_message: "Merhaba! Sipari≈ü vermek i√ßin mikrofonu a√ßƒ±n ve konu≈üun.",
                location_description: "L√ºtfen sipari≈ü vermek istediƒüiniz konumu se√ßin:"
            },
            en: {
                app_name: "Voice Order",
                select_location: "Select Location",
                order: "Order:",
                profile: "My Profile",
                microphone_off: "Microphone (Off)",
                banner_title: "Easy Shopping with Voice Order",
                banner_description: "Just speak, your order is at your door!",
                detect_location: "Detect My Location",
                what_to_eat: "What would you like to eat?",
                nearest_places: "Nearest Places to You",
                categories: "Categories",
                products: "Products",
                inside_restaurant: "Inside Restaurant",
                inside_description: "Eat your meal at the restaurant",
                takeaway: "Takeaway",
                takeaway_description: "Pick up your meal yourself",
                delivery: "Home Delivery",
                delivery_description: "Your meal delivered to your address",
                auto_detect: "Auto Detect My Location",
                your_cart: "Your Cart",
                empty_cart: "Your cart is empty",
                subtotal: "Subtotal:",
                discount: "Discount:",
                vat: "VAT (%18):",
                total: "Total:",
                pay_cash: "Pay Cash",
                pay_card: "Pay by Card",
                pay_bonus: "Pay with Bonus",
                footer_description: "Order easily with voice commands. Fast, secure and practical shopping experience.",
                quick_links: "Quick Links",
                referral_link: "Referral Link",
                whatsapp_order: "Order via WhatsApp",
                my_orders: "My Orders",
                help: "Help",
                contact: "Contact",
                location: "Istanbul, Turkey",
                partner_login: "Partner Login",
                all_rights_reserved: "All rights reserved.",
                voice_assistant: "Voice Assistant",
                welcome_message: "Hello! Turn on the microphone to place an order and start speaking.",
                location_description: "Please select the location where you want to place your order:"
            },
            ge: {
                app_name: "·ÉÆ·Éõ·Éù·Éï·Éê·Éú·Éò ·É®·Éî·Éô·Éï·Éî·Éó·Éê",
                select_location: "·Éê·Éò·É†·É©·Éò·Éî·Éó ·Éõ·Éì·Éî·Éë·Éê·É†·Éî·Éù·Éë·Éê",
                order: "·É®·Éî·Éô·Éï·Éî·Éó·Éê:",
                profile: "·É©·Éî·Éõ·Éò ·Éû·É†·Éù·É§·Éò·Éö·Éò",
                microphone_off: "·Éõ·Éò·Éô·É†·Éù·É§·Éù·Éú·Éò (·Éí·Éê·Éõ·Éù·É†·Éó·É£·Éö·Éò·Éê)",
                banner_title: "·Éõ·Éê·É†·É¢·Éò·Éï·Éò ·É®·Éù·Éû·Éò·Éú·Éí·Éò ·ÉÆ·Éõ·Éù·Éï·Éê·Éú·Éò ·É®·Éî·Éô·Éï·Éî·Éó·Éò·Éó",
                banner_description: "·É£·Éë·É†·Éê·Éö·Éù·Éì ·Éö·Éê·Éû·Éê·É†·Éê·Éô·Éò, ·Éó·É•·Éï·Éî·Éú·Éò ·É®·Éî·Éô·Éï·Éî·Éó·Éê ·Éó·É•·Éï·Éî·Éú·É° ·Éô·Éê·É†·Éñ·Éî·Éê!",
                detect_location: "·Éí·Éê·Éú·É°·Éê·Éñ·É¶·Éï·É†·Éî·Éó ·É©·Éî·Éõ·Éò ·Éõ·Éì·Éî·Éë·Éê·É†·Éî·Éù·Éë·Éê",
                what_to_eat: "·É†·Éê ·Éí·Éò·Éú·Éì·Éê·Éó ·É≠·Éê·Éõ·Éù·Éó?",
                nearest_places: "·É£·Éê·ÉÆ·Éö·Éù·Éî·É°·Éò ·Éê·Éì·Éí·Éò·Éö·Éî·Éë·Éò ·Éó·É•·Éï·Éî·Éú·Éó·Éê·Éú",
                categories: "·Éô·Éê·É¢·Éî·Éí·Éù·É†·Éò·Éî·Éë·Éò",
                products: "·Éû·É†·Éù·Éì·É£·É•·É¢·Éî·Éë·Éò",
                inside_restaurant: "·É†·Éî·É°·É¢·Éù·É†·Éú·Éò·É° ·É®·Éò·Éí·Éú·Éò·Éó",
                inside_description: "·Éõ·Éò·Éò·É†·Éó·Éï·Éò·Éó ·Éó·É•·Éï·Éî·Éú·Éò ·Éô·Éï·Éî·Éë·Éê ·É†·Éî·É°·É¢·Éù·É†·Éú·É®·Éò",
                takeaway: "Takeaway",
                takeaway_description: "·Éó·Éê·Éï·Éê·Éì ·É¨·Éê·Éò·É¶·Éî·Éó ·Éó·É•·Éï·Éî·Éú·Éò ·Éô·Éï·Éî·Éë·Éê",
                delivery: "·É°·Éê·ÉÆ·Éö·Éò·É° ·Éõ·Éò·É¢·Éê·Éú·Éê",
                delivery_description: "·Éó·É•·Éï·Éî·Éú·Éò ·Éô·Éï·Éî·Éë·Éê ·Éõ·Éò·Éò·É¢·Éê·Éú·Éî·Éë·Éê ·Éó·É•·Éï·Éî·Éú·É° ·Éõ·Éò·É°·Éê·Éõ·Éê·É†·Éó·Éñ·Éî",
                auto_detect: "·Éê·Éï·É¢·Éù·Éõ·Éê·É¢·É£·É†·Éê·Éì ·Éí·Éê·Éú·É°·Éê·Éñ·É¶·Éï·É†·Éî·Éó ·É©·Éî·Éõ·Éò ·Éõ·Éì·Éî·Éë·Éê·É†·Éî·Éù·Éë·Éê",
                your_cart: "·Éó·É•·Éï·Éî·Éú·Éò ·Éô·Éê·Éö·Éê·Éó·Éê",
                empty_cart: "·Éó·É•·Éï·Éî·Éú·Éò ·Éô·Éê·Éö·Éê·Éó·Éê ·É™·Éê·É†·Éò·Éî·Éö·Éò·Éê",
                subtotal: "·É®·É£·Éê·Éö·Éî·Éì·É£·É†·Éò ·ÉØ·Éê·Éõ·Éò:",
                discount: "·É§·Éê·É°·Éì·Éê·Éô·Éö·Éî·Éë·Éê:",
                vat: "·Éì·É¶·Éí (%18):",
                total: "·É°·É£·Éö:",
                pay_cash: "·Éí·Éê·Éì·Éê·Éò·ÉÆ·Éê·Éì·Éî·Éó ·Éú·Éê·É¶·Éì·Éò ·Éê·Éú·Éí·Éê·É†·Éò·É®·É°·É¨·Éù·É†·Éî·Éë·Éò·Éó",
                pay_card: "·Éí·Éê·Éì·Éê·Éò·ÉÆ·Éê·Éì·Éî·Éó ·Éë·Éê·É†·Éê·Éó·Éò·Éó",
                pay_bonus: "·Éí·Éê·Éì·Éê·Éò·ÉÆ·Éê·Éì·Éî·Éó ·Éë·Éù·Éú·É£·É°·Éò·Éó",
                footer_description: "·Éõ·Éê·É†·É¢·Éò·Éï·Éê·Éì ·É®·Éî·É£·Éô·Éï·Éî·Éó·Éî·Éó ·ÉÆ·Éõ·Éù·Éï·Éê·Éú·Éò ·Éë·É†·É´·Éê·Éú·Éî·Éë·Éî·Éë·Éò·Éó. ·É°·É¨·É†·Éê·É§·Éò, ·É£·É°·Éê·É§·É†·Éó·ÉÆ·Éù ·Éì·Éê ·Éû·É†·Éê·É•·É¢·Éò·Éô·É£·Éö·Éò ·É®·Éù·Éû·Éò·Éú·Éí·Éò·É° ·Éí·Éê·Éõ·Éù·É™·Éì·Éò·Éö·Éî·Éë·Éê.",
                quick_links: "·É°·É¨·É†·Éê·É§·Éò ·Éë·Éõ·É£·Éö·Éî·Éë·Éò",
                referral_link: "·É†·Éî·É§·Éî·É†·Éê·Éö·É£·É†·Éò ·Éë·Éõ·É£·Éö·Éò",
                whatsapp_order: "·É®·Éî·É£·Éô·Éï·Éî·Éó·Éî·Éó WhatsApp-·Éò·Éó",
                my_orders: "·É©·Éî·Éõ·Éò ·É®·Éî·Éô·Éï·Éî·Éó·Éî·Éë·Éò",
                help: "·Éì·Éê·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éê",
                contact: "·Éô·Éù·Éú·É¢·Éê·É•·É¢·Éò",
                location: "·Éó·Éë·Éò·Éö·Éò·É°·Éò, ·É°·Éê·É•·Éê·É†·Éó·Éï·Éî·Éö·Éù",
                partner_login: "·Éû·Éê·É†·É¢·Éú·Éò·Éù·É†·Éò·É° ·É®·Éî·É°·Éï·Éö·Éê",
                all_rights_reserved: "·Éß·Éï·Éî·Éö·Éê ·É£·É§·Éö·Éî·Éë·Éê ·Éì·Éê·É™·É£·Éö·Éò·Éê.",
                voice_assistant: "·ÉÆ·Éõ·Éù·Éï·Éê·Éú·Éò ·Éê·É°·Éò·É°·É¢·Éî·Éú·É¢·Éò",
                welcome_message: "·Éí·Éê·Éõ·Éê·É†·ÉØ·Éù·Éë·Éê! ·É©·Éê·É†·Éó·Éî·Éó ·Éõ·Éò·Éô·É†·Éù·É§·Éù·Éú·Éò ·É®·Éî·Éô·Éï·Éî·Éó·Éò·É° ·Éí·Éê·Éú·É°·Éê·ÉÆ·Éù·É†·É™·Éò·Éî·Éö·Éî·Éë·Éö·Éê·Éì ·Éì·Éê ·Éì·Éê·Éò·É¨·Éß·Éî·Éó ·É°·Éê·É£·Éë·Éê·É†·Éò.",
                location_description: "·Éí·Éó·ÉÆ·Éù·Éï·Éó, ·Éê·Éò·É†·É©·Éò·Éù·Éó ·Éõ·Éì·Éî·Éë·Éê·É†·Éî·Éù·Éë·Éê, ·É°·Éê·Éì·Éê·É™ ·Éí·É°·É£·É†·Éó ·É®·Éî·Éô·Éï·Éî·Éó·Éò·É° ·Éí·Éê·Éú·Éó·Éê·Éï·É°·Éî·Éë·Éê:"
            },
            ru: {
                app_name: "–ì–æ–ª–æ—Å–æ–≤–æ–π –ó–∞–∫–∞–∑",
                select_location: "–í—ã–±–µ—Ä–∏—Ç–µ –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ",
                order: "–ó–∞–∫–∞–∑:",
                profile: "–ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å",
                microphone_off: "–ú–∏–∫—Ä–æ—Ñ–æ–Ω (–í—ã–∫–ª—é—á–µ–Ω)",
                banner_title: "–õ–µ–≥–∫–∏–π –®–æ–ø–ø–∏–Ω–≥ —Å –ì–æ–ª–æ—Å–æ–≤—ã–º –ó–∞–∫–∞–∑–æ–º",
                banner_description: "–ü—Ä–æ—Å—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç–µ, –≤–∞—à –∑–∞–∫–∞–∑ —É –≤–∞—à–µ–π –¥–≤–µ—Ä–∏!",
                detect_location: "–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ú–æ–µ –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ",
                what_to_eat: "–ß—Ç–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ –ø–æ–µ—Å—Ç—å?",
                nearest_places: "–ë–ª–∏–∂–∞–π—à–∏–µ –ú–µ—Å—Ç–∞ –∫ –í–∞–º",
                categories: "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏",
                products: "–ü—Ä–æ–¥—É–∫—Ç—ã",
                inside_restaurant: "–í–Ω—É—Ç—Ä–∏ –†–µ—Å—Ç–æ—Ä–∞–Ω–∞",
                inside_description: "–ü–æ–µ—à—å—Ç–µ –≤–∞—à—É –µ–¥—É –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ",
                takeaway: "–ù–∞ –í—ã–Ω–æ—Å",
                takeaway_description: "–ó–∞–±–µ—Ä–∏—Ç–µ –≤–∞—à—É –µ–¥—É —Å–∞–º–∏",
                delivery: "–î–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ –î–æ–º",
                delivery_description: "–í–∞—à–∞ –µ–¥–∞ –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ø–æ –≤–∞—à–µ–º—É –∞–¥—Ä–µ—Å—É",
                auto_detect: "–ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ú–æ–µ–≥–æ –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è",
                your_cart: "–í–∞—à–∞ –ö–æ—Ä–∑–∏–Ω–∞",
                empty_cart: "–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞",
                subtotal: "–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –∏—Ç–æ–≥:",
                discount: "–°–∫–∏–¥–∫–∞:",
                vat: "–ù–î–° (%18):",
                total: "–í—Å–µ–≥–æ:",
                pay_cash: "–û–ø–ª–∞—Ç–∏—Ç—å –ù–∞–ª–∏—á–Ω—ã–º–∏",
                pay_card: "–û–ø–ª–∞—Ç–∏—Ç—å –ö–∞—Ä—Ç–æ–π",
                pay_bonus: "–û–ø–ª–∞—Ç–∏—Ç—å –ë–æ–Ω—É—Å–∞–º–∏",
                footer_description: "–õ–µ–≥–∫–æ –∑–∞–∫–∞–∑—ã–≤–∞–π—Ç–µ —Å –ø–æ–º–æ—â—å—é –≥–æ–ª–æ—Å–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥. –ë—ã—Å—Ç—Ä—ã–π, –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π –æ–ø—ã—Ç –ø–æ–∫—É–ø–æ–∫.",
                quick_links: "–ë—ã—Å—Ç—Ä—ã–µ –°—Å—ã–ª–∫–∏",
                referral_link: "–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –°—Å—ã–ª–∫–∞",
                whatsapp_order: "–ó–∞–∫–∞–∑ —á–µ—Ä–µ–∑ WhatsApp",
                my_orders: "–ú–æ–∏ –ó–∞–∫–∞–∑—ã",
                help: "–ü–æ–º–æ—â—å",
                contact: "–ö–æ–Ω—Ç–∞–∫—Ç",
                location: "–°—Ç–∞–º–±—É–ª, –¢—É—Ä—Ü–∏—è",
                partner_login: "–í—Ö–æ–¥ –¥–ª—è –ü–∞—Ä—Ç–Ω–µ—Ä–æ–≤",
                all_rights_reserved: "–í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.",
                voice_assistant: "–ì–æ–ª–æ—Å–æ–≤–æ–π –ü–æ–º–æ—â–Ω–∏–∫",
                welcome_message: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –í–∫–ª—é—á–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑, –∏ –Ω–∞—á–∏–Ω–∞–π—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç—å.",
                location_description: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ, –≥–¥–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –∑–∞–∫–∞–∑:"
            },
            az: {
                app_name: "S…ôsli Sifari≈ü",
                select_location: "Yeri Se√ßin",
                order: "Sifari≈ü:",
                profile: "Profilim",
                microphone_off: "Mikrofon (S√∂nd√ºr√ºlm√º≈ü)",
                banner_title: "S…ôsli Sifari≈ü il…ô Asan Alƒ±≈ü-veri≈ü",
                banner_description: "Sad…ôc…ô danƒ±≈üƒ±n, sifari≈üiniz qapƒ±nƒ±zda!",
                detect_location: "M…ônim Yerimi M√º…ôyy…ônl…ô≈üdir",
                what_to_eat: "N…ô yem…ôk ist…ôyirsiniz?",
                nearest_places: "Siz…ô ∆èn Yaxƒ±n Yerl…ôr",
                categories: "Kateqoriyalar",
                products: "M…ôhsullar",
                inside_restaurant: "Restoran Daxilind…ô",
                inside_description: "Yem…ôyinizi restoranda yeyin",
                takeaway: "Paket Xidm…ôti",
                takeaway_description: "Yem…ôyinizi √∂z√ºn√ºz g√∂t√ºr√ºn",
                delivery: "√únvana √áatdƒ±rƒ±lma",
                delivery_description: "Yem…ôyiniz √ºnvanƒ±nƒ±za √ßatdƒ±rƒ±lsƒ±n",
                auto_detect: "Yerimi Avtomatik M√º…ôyy…ônl…ô≈üdir",
                your_cart: "S…ôb…ôtiniz",
                empty_cart: "S…ôb…ôtiniz bo≈üdur",
                subtotal: "Ara C…ômi:",
                discount: "Endirim:",
                vat: "∆èDV (%18):",
                total: "√úmumi:",
                pay_cash: "Naƒüd √ñd…ô",
                pay_card: "Kartla √ñd…ô",
                pay_bonus: "Bonusla √ñd…ô",
                footer_description: "S…ôsli …ômrl…ôrl…ô asanlƒ±qla sifari≈ü verin. S√ºr…ôtli, t…ôhl√ºk…ôsiz v…ô praktik alƒ±≈ü-veri≈ü t…ôcr√ºb…ôsi.",
                quick_links: "S√ºr…ôtli Ke√ßidl…ôr",
                referral_link: "Referans Linki",
                whatsapp_order: "WhatsApp il…ô Sifari≈ü",
                my_orders: "Sifari≈ül…ôrim",
                help: "Yardƒ±m",
                contact: "∆èlaq…ô",
                location: "ƒ∞stanbul, T√ºrkiy…ô",
                partner_login: "Partner Giri≈üi",
                all_rights_reserved: "B√ºt√ºn h√ºquqlar qorunur.",
                voice_assistant: "S…ôsli K√∂m…ôk√ßi",
                welcome_message: "Salam! Sifari≈ü verm…ôk √º√ß√ºn mikrofonu a√ßƒ±n v…ô danƒ±≈ümaƒüa ba≈ülayƒ±n.",
                location_description: "Z…ôhm…ôt olmasa sifari≈ü verm…ôk ist…ôdiyiniz yeri se√ßin:"
            },
            de: {
                app_name: "Sprachbestellung",
                select_location: "Standort ausw√§hlen",
                order: "Bestellung:",
                profile: "Mein Profil",
                microphone_off: "Mikrofon (Aus)",
                banner_title: "Einfaches Einkaufen mit Sprachbestellung",
                banner_description: "Einfach sprechen, Ihre Bestellung ist vor Ihrer T√ºr!",
                detect_location: "Meinen Standort ermitteln",
                what_to_eat: "Was m√∂chten Sie essen?",
                nearest_places: "N√§chste Orte zu Ihnen",
                categories: "Kategorien",
                products: "Produkte",
                inside_restaurant: "Im Restaurant",
                inside_description: "Essen Sie Ihre Mahlzeit im Restaurant",
                takeaway: "Takeaway",
                takeaway_description: "Holen Sie Ihre Mahlzeit selbst ab",
                delivery: "Lieferung nach Hause",
                delivery_description: "Ihre Mahlzeit wird zu Ihrer Adresse geliefert",
                auto_detect: "Automatische Standortermittlung",
                your_cart: "Ihr Warenkorb",
                empty_cart: "Ihr Warenkorb ist leer",
                subtotal: "Zwischensumme:",
                discount: "Rabatt:",
                vat: "MwSt (%18):",
                total: "Gesamt:",
                pay_cash: "Bar bezahlen",
                pay_card: "Mit Karte bezahlen",
                pay_bonus: "Mit Bonus bezahlen",
                footer_description: "Bestellen Sie einfach mit Sprachbefehlen. Schnelles, sicheres und praktisches Einkaufserlebnis.",
                quick_links: "Schnelllinks",
                referral_link: "Empfehlungslink",
                whatsapp_order: "Bestellung per WhatsApp",
                my_orders: "Meine Bestellungen",
                help: "Hilfe",
                contact: "Kontakt",
                location: "Istanbul, T√ºrkei",
                partner_login: "Partner-Login",
                all_rights_reserved: "Alle Rechte vorbehalten.",
                voice_assistant: "Sprachassistent",
                welcome_message: "Hallo! Schalten Sie das Mikrofon ein, um eine Bestellung aufzugeben, und beginnen Sie zu sprechen.",
                location_description: "Bitte w√§hlen Sie den Standort aus, an dem Sie Ihre Bestellung aufgeben m√∂chten:"
            },
            it: {
                app_name: "Ordine Vocale",
                select_location: "Seleziona Posizione",
                order: "Ordine:",
                profile: "Mio Profilo",
                microphone_off: "Microfono (Spento)",
                banner_title: "Shopping Facile con Ordine Vocale",
                banner_description: "Parla e basta, il tuo ordine √® alla tua porta!",
                detect_location: "Rileva la Mia Posizione",
                what_to_eat: "Cosa vorresti mangiare?",
                nearest_places: "Luoghi Pi√π Vicini a Te",
                categories: "Categorie",
                products: "Prodotti",
                inside_restaurant: "All'interno del Ristorante",
                inside_description: "Mangia il tuo pasto al ristorante",
                takeaway: "Takeaway",
                takeaway_description: "Ritira tu stesso il tuo pasto",
                delivery: "Consegna a Domicilio",
                delivery_description: "Il tuo pasto consegnato al tuo indirizzo",
                auto_detect: "Rilevamento Automatico della Mia Posizione",
                your_cart: "Il Tuo Carrello",
                empty_cart: "Il tuo carrello √® vuoto",
                subtotal: "Subtotale:",
                discount: "Sconto:",
                vat: "IVA (%18):",
                total: "Totale:",
                pay_cash: "Paga in Contanti",
                pay_card: "Paga con Carta",
                pay_bonus: "Paga con Bonus",
                footer_description: "Ordina facilmente con comandi vocali. Esperienza di shopping veloce, sicura e pratica.",
                quick_links: "Link Rapidi",
                referral_link: "Link di Referral",
                whatsapp_order: "Ordina tramite WhatsApp",
                my_orders: "I Miei Ordini",
                help: "Aiuto",
                contact: "Contatto",
                location: "Istanbul, Turchia",
                partner_login: "Accesso Partner",
                all_rights_reserved: "Tutti i diritti riservati.",
                voice_assistant: "Assistente Vocale",
                welcome_message: "Ciao! Accendi il microfono per effettuare un ordine e inizia a parlare.",
                location_description: "Seleziona la posizione in cui desideri effettuare l'ordine:"
            }
        };
        
        const languages = [
            { code: 'tr', name: 'T√ºrk√ße', flag: 'üáπüá∑' },
            { code: 'en', name: 'English', flag: 'üá∫üá∏' },
            { code: 'ge', name: '·É•·Éê·É†·Éó·É£·Éö·Éò', flag: 'üá¨üá™' },
            { code: 'ru', name: '–†—É—Å—Å–∫–∏–π', flag: 'üá∑üá∫' },
            { code: 'az', name: 'Az…ôrbaycanca', flag: 'üá¶üáø' },
            { code: 'de', name: 'Deutsch', flag: 'üá©üá™' },
            { code: 'it', name: 'Italiano', flag: 'üáÆüáπ' }
        ];
        
        let currentLanguage = 'tr';
        
        // Tarayƒ±cƒ± dilini algƒ±la
        function detectBrowserLanguage() {
            const browserLang = navigator.language || navigator.userLanguage;
            const langCode = browserLang.split('-')[0];
            
            // Desteklenen dillerden birini bul
            const supportedLang = languages.find(lang => lang.code === langCode);
            if (supportedLang) {
                return supportedLang.code;
            }
            
            return 'tr'; // Varsayƒ±lan dil
        }
        
        // Dil se√ßeneklerini olu≈ütur
        function populateLanguageOptions() {
            const dropdown = document.getElementById('languageDropdown');
            dropdown.innerHTML = '';
            
            languages.forEach(lang => {
                const option = document.createElement('div');
                option.className = `language-option ${lang.code === currentLanguage ? 'active' : ''}`;
                option.setAttribute('data-lang', lang.code);
                
                option.innerHTML = `
                    <span class="flag">${lang.flag}</span>
                    <span>${lang.name}</span>
                    ${lang.code === currentLanguage ? '<i class="fas fa-check"></i>' : ''}
                `;
                
                dropdown.appendChild(option);
            });
        }
        
        // Sayfayƒ± √ßevir
        function translatePage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        element.placeholder = translations[lang][key];
                    } else {
                        element.textContent = translations[lang][key];
                    }
                }
            });
            
            // Dil d√ºƒümesini g√ºncelle
            const currentLang = languages.find(l => l.code === lang);
            document.getElementById('currentLanguage').textContent = currentLang.flag;
            
            // Sesli asistan dilini g√ºncelle
            if (recognition) {
                recognition.lang = getSpeechRecognitionLang(lang);
            }
            
            // Dil se√ßeneklerini g√ºncelle
            populateLanguageOptions();
            
            // Banner'ƒ± g√ºncelle
            updateBanner(currentStoreType);
        }
        
        // Konu≈üma tanƒ±ma dili
        function getSpeechRecognitionLang(lang) {
            const langMap = {
                'tr': 'tr-TR',
                'en': 'en-US',
                'ge': 'ka-GE',
                'ru': 'ru-RU',
                'az': 'az-AZ',
                'de': 'de-DE',
                'it': 'it-IT'
            };
            
            return langMap[lang] || 'tr-TR';
        }
        
        // =============================================
        // Dƒ∞NAMƒ∞K BANNER Sƒ∞STEMƒ∞
        // =============================================
        
        const bannerVideos = {
            market: "",
            restaurant: "",
            bakery: "",
            pharmacy: ""
        };
        
        const bannerTitles = {
            tr: {
                market: "Market Alƒ±≈üveri≈üini Sesinle Yap",
                restaurant: "Lezzetli Yemekler Sesinle Kapƒ±nda",
                bakery: "Taze Fƒ±rƒ±n √úr√ºnleri Sesinle Gelsin",
                pharmacy: "ƒ∞la√ßlarƒ±n Sesinle Kapƒ±nda"
            },
            en: {
                market: "Do Your Grocery Shopping with Your Voice",
                restaurant: "Delicious Food at Your Door with Your Voice",
                bakery: "Fresh Bakery Products with Your Voice",
                pharmacy: "Your Medications at Your Door with Your Voice"
            },
            ge: {
                market: "·Éí·Éê·Éõ·Éù·Éò·Éß·Éî·Éú·Éî·Éó ·Éó·É•·Éï·Éî·Éú·Éò ·ÉÆ·Éõ·Éê ·É°·Éê·É°·É£·É†·É°·Éê·Éó·Éù ·É®·Éù·Éû·Éò·Éú·Éí·Éò·É°·Éó·Éï·Éò·É°",
                restaurant: "·Éí·Éî·Éõ·É†·Éò·Éî·Éö·Éò ·É°·Éê·É≠·Éõ·Éî·Éö·Éò ·Éó·É•·Éï·Éî·Éú·É° ·Éô·Éê·É†·Éñ·Éî ·Éó·É•·Éï·Éî·Éú·Éò ·ÉÆ·Éõ·Éò·Éó",
                bakery: "·Éê·ÉÆ·Éê·Éö·Éò ·É°·Éê·É™·ÉÆ·Éù·Éë·Éò ·Éû·É†·Éù·Éì·É£·É•·É¢·Éî·Éë·Éò ·Éó·É•·Éï·Éî·Éú·Éò ·ÉÆ·Éõ·Éò·Éó",
                pharmacy: "·Éó·É•·Éï·Éî·Éú·Éò ·Éõ·Éî·Éì·Éò·Éô·Éê·Éõ·Éî·Éú·É¢·Éî·Éë·Éò ·Éó·É•·Éï·Éî·Éú·É° ·Éô·Éê·É†·Éñ·Éî ·Éó·É•·Éï·Éî·Éú·Éò ·ÉÆ·Éõ·Éò·Éó"
            },
            ru: {
                market: "–î–µ–ª–∞–π—Ç–µ –ø–æ–∫—É–ø–∫–∏ –≤ —Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç–µ —Å –ø–æ–º–æ—â—å—é —Å–≤–æ–µ–≥–æ –≥–æ–ª–æ—Å–∞",
                restaurant: "–í–∫—É—Å–Ω–∞—è –µ–¥–∞ —É –≤–∞—à–µ–π –¥–≤–µ—Ä–∏ —Å –≤–∞—à–∏–º –≥–æ–ª–æ—Å–æ–º",
                bakery: "–°–≤–µ–∂–∞—è –≤—ã–ø–µ—á–∫–∞ —Å –≤–∞—à–∏–º –≥–æ–ª–æ—Å–æ–º",
                pharmacy: "–í–∞—à–∏ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞ —É –≤–∞—à–µ–π –¥–≤–µ—Ä–∏ —Å –≤–∞—à–∏–º –≥–æ–ª–æ—Å–æ–º"
            },
            az: {
                market: "Market Alƒ±≈ü-veri≈üini S…ôsinl…ô Et",
                restaurant: "L…ôzz…ôtli Yem…ôkl…ôr S…ôsinl…ô Qapƒ±nda",
                bakery: "T…ôz…ô Fƒ±rƒ±n M…ôhsullarƒ± S…ôsinl…ô G…ôlsin",
                pharmacy: "D…ôrmanlarƒ±n S…ôsinl…ô Qapƒ±nda"
            },
            de: {
                market: "Machen Sie Ihren Lebensmitteleinkauf mit Ihrer Stimme",
                restaurant: "Leckeres Essen an Ihrer T√ºr mit Ihrer Stimme",
                bakery: "Frische Backwaren mit Ihrer Stimme",
                pharmacy: "Ihre Medikamente an Ihrer T√ºr mit Ihrer Stimme"
            },
            it: {
                market: "Fai la tua spesa alimentare con la tua voce",
                restaurant: "Cibo delizioso alla tua porta con la tua voce",
                bakery: "Prodotti da forno freschi con la tua voce",
                pharmacy: "I tuoi farmaci alla tua porta con la tua voce"
            }
        };
        
        const bannerDescriptions = {
            tr: {
                market: "Market √ºr√ºnlerini sesinle sipari≈ü et, kapƒ±na gelsin!",
                restaurant: "Restoran lezzetlerini sesinle ke≈üfet!",
                bakery: "Taze ekmek ve pastane √ºr√ºnleri sesinle kapƒ±nda!",
                pharmacy: "ƒ∞la√ßlarƒ±nƒ± sesinle sipari≈ü et, zaman kazan!"
            },
            en: {
                market: "Order grocery products with your voice, delivered to your door!",
                restaurant: "Discover restaurant flavors with your voice!",
                bakery: "Fresh bread and bakery products with your voice at your door!",
                pharmacy: "Order your medications with your voice, save time!"
            },
            ge: {
                market: "·É®·Éî·É£·Éô·Éï·Éî·Éó·Éî·Éó ·É°·Éê·É°·É£·É†·É°·Éê·Éó·Éù ·Éû·É†·Éù·Éì·É£·É•·É¢·Éî·Éë·Éò ·Éó·É•·Éï·Éî·Éú·Éò ·ÉÆ·Éõ·Éò·Éó, ·Éõ·Éò·Éò·É¢·Éê·Éú·Éî·Éó ·Éó·É•·Éï·Éî·Éú·É° ·Éô·Éê·É†·Éñ·Éî!",
                restaurant: "·Éê·É¶·Éõ·Éù·Éê·É©·Éò·Éú·Éî·Éó ·É†·Éî·É°·É¢·Éù·É†·Éú·Éò·É° ·Éí·Éî·Éõ·Éù·Éî·Éë·Éò ·Éó·É•·Éï·Éî·Éú·Éò ·ÉÆ·Éõ·Éò·Éó!",
                bakery: "·Éê·ÉÆ·Éê·Éö·Éò ·Éû·É£·É†·Éò ·Éì·Éê ·É°·Éê·É™·ÉÆ·Éù·Éë·Éò ·Éû·É†·Éù·Éì·É£·É•·É¢·Éî·Éë·Éò ·Éó·É•·Éï·Éî·Éú·Éò ·ÉÆ·Éõ·Éò·Éó ·Éó·É•·Éï·Éî·Éú·É° ·Éô·Éê·É†·Éñ·Éî!",
                pharmacy: "·É®·Éî·É£·Éô·Éï·Éî·Éó·Éî·Éó ·Éó·É•·Éï·Éî·Éú·Éò ·Éõ·Éî·Éì·Éò·Éô·Éê·Éõ·Éî·Éú·É¢·Éî·Éë·Éò ·Éó·É•·Éï·Éî·Éú·Éò ·ÉÆ·Éõ·Éò·Éó, ·Éì·Éê·Éñ·Éù·Éí·Éî·Éó ·Éì·É†·Éù!"
            },
            ru: {
                market: "–ó–∞–∫–∞–∑—ã–≤–∞–π—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã —Å –ø–æ–º–æ—â—å—é —Å–≤–æ–µ–≥–æ –≥–æ–ª–æ—Å–∞, –¥–æ—Å—Ç–∞–≤–∫–∞ –∫ –≤–∞—à–µ–π –¥–≤–µ—Ä–∏!",
                restaurant: "–û—Ç–∫—Ä–æ–π—Ç–µ –¥–ª—è —Å–µ–±—è –≤–∫—É—Å—ã —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ —Å –≤–∞—à–∏–º –≥–æ–ª–æ—Å–æ–º!",
                bakery: "–°–≤–µ–∂–∏–π —Ö–ª–µ–± –∏ –≤—ã–ø–µ—á–∫–∞ —Å –≤–∞—à–∏–º –≥–æ–ª–æ—Å–æ–º —É –≤–∞—à–µ–π –¥–≤–µ—Ä–∏!",
                pharmacy: "–ó–∞–∫–∞–∑—ã–≤–∞–π—Ç–µ —Å–≤–æ–∏ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞ —Å –≤–∞—à–∏–º –≥–æ–ª–æ—Å–æ–º, —ç–∫–æ–Ω–æ–º—å—Ç–µ –≤—Ä–µ–º—è!"
            },
            az: {
                market: "Market m…ôhsullarƒ±nƒ± s…ôsinl…ô sifari≈ü et, qapƒ±na g…ôlsin!",
                restaurant: "Restoran l…ôzz…ôtl…ôrini s…ôsinl…ô k…ô≈üf et!",
                bakery: "T…ôz…ô √ß√∂r…ôk v…ô pastaxana m…ôhsullarƒ± s…ôsinl…ô qapƒ±nda!",
                pharmacy: "D…ôrmanlarƒ±nƒ± s…ôsinl…ô sifari≈ü et, vaxt qazan!"
            },
            de: {
                market: "Bestellen Sie Lebensmittel mit Ihrer Stimme, liefern Sie an Ihre T√ºr!",
                restaurant: "Entdecken Sie Restaurantaromen mit Ihrer Stimme!",
                bakery: "Frisches Brot und Backwaren mit Ihrer Stimme an Ihrer T√ºr!",
                pharmacy: "Bestellen Sie Ihre Medikamente mit Ihrer Stimme, sparen Sie Zeit!"
            },
            it: {
                market: "Ordina prodotti alimentari con la tua voce, consegnati alla tua porta!",
                restaurant: "Scopri i sapori del ristorante con la tua voce!",
                bakery: "Pane fresco e prodotti da forno con la tua voce alla tua porta!",
                pharmacy: "Ordina i tuoi farmaci con la tua voce, risparmia tempo!"
            }
        };
        
        let currentStoreType = 'market';
        
        function updateBanner(storeType) {
            const banner = document.getElementById('banner');
            const bannerVideo = document.getElementById('bannerVideo');
            const bannerTitle = document.getElementById('bannerTitle');
            const bannerDescription = document.getElementById('bannerDescription');
            
            // Varsayƒ±lan deƒüerler
            let videoSrc = bannerVideos.market;
            let title = bannerTitles[currentLanguage].market;
            let description = bannerDescriptions[currentLanguage].market;
            
            // Store type'a g√∂re i√ßerikleri belirle
            if (storeType && bannerVideos[storeType]) {
                videoSrc = bannerVideos[storeType];
                title = bannerTitles[currentLanguage][storeType];
                description = bannerDescriptions[currentLanguage][storeType];
                currentStoreType = storeType;
            }
            
            // Banner'ƒ± g√ºncelle
            bannerVideo.src = videoSrc;
            bannerVideo.load();
            bannerVideo.play().catch(e => console.log("Video autoplay prevented:", e));
            
            bannerTitle.textContent = title;
            bannerDescription.textContent = description;
        }

// Banner video fallback sistemi
function setupBannerFallback() {
    const banner = document.getElementById('banner');
    const bannerVideo = document.getElementById('bannerVideo');
    
    if (!banner || !bannerVideo) return;
    
    // Video y√ºklenemezse fallback
    bannerVideo.addEventListener('error', function() {
        console.log('üé• Video y√ºklenemedi, fallback aktif');
        banner.style.background = 'linear-gradient(135deg, var(--primary), var(--primary-light))';
        bannerVideo.style.display = 'none';
    });
    
    // Video y√ºklenirse
    bannerVideo.addEventListener('loadeddata', function() {
        console.log('üé• Video ba≈üarƒ±yla y√ºklendi');
        this.play().catch(e => {
            console.log('‚ö†Ô∏è Video oynatƒ±lamadƒ±:', e.name);
            // Oynatƒ±lamazsa fallback
            banner.style.background = 'linear-gradient(135deg, var(--primary), var(--primary-light))';
            bannerVideo.style.display = 'none';
        });
    });
}

// Banner fallback'i ba≈ülat
document.addEventListener('DOMContentLoaded', setupBannerFallback);

	
        // =============================================
        // YATAY KAYDIRMA FONKSƒ∞YONLARI
        // =============================================
        
        
        // =============================================
        // √ñRNEK VERƒ∞ Y√úKLEME
        // =============================================
        
        function loadSampleData() {
            // Store types
            const storeTypes = [
                { id: 1, name: 'Market', type: 'market', icon: 'fas fa-store' },
                { id: 2, name: 'Restoran', type: 'restaurant', icon: 'fas fa-utensils' },
                { id: 3, name: 'Fƒ±rƒ±n', type: 'bakery', icon: 'fas fa-bread-slice' },
                { id: 4, name: 'Eczane', type: 'pharmacy', icon: 'fas fa-prescription-bottle' },
                { id: 5, name: 'Kafe', type: 'cafe', icon: 'fas fa-coffee' },
                { id: 6, name: 'Fast Food', type: 'fastfood', icon: 'fas fa-hamburger' }
            ];
            
            const storeTypeGrid = document.getElementById('storeTypeGrid');
            storeTypes.forEach(store => {
                const card = document.createElement('div');
                card.className = 'store-type-card';
                card.setAttribute('data-store-type', store.type);
                
                card.innerHTML = `
                    <div class="store-type-icon">
                        <i class="${store.icon}"></i>
                    </div>
                    <div class="store-type-name">${store.name}</div>
                `;
                
                card.addEventListener('click', function() {
                    // T√ºm kartlardan se√ßimi kaldƒ±r
                    document.querySelectorAll('.store-type-card').forEach(c => {
                        c.classList.remove('selected');
                    });
                    
                    // Bu kartƒ± se√ßili yap
                    this.classList.add('selected');
                    
                    // Banner'ƒ± g√ºncelle
                    updateBanner(store.type);
                    
                    // Satƒ±cƒ±larƒ± g√∂ster
                    document.getElementById('sellersSection').style.display = 'block';
                    loadSampleSellers();
                });
                
                storeTypeGrid.appendChild(card);
            });
        }
        
        function loadSampleSellers() {
            const sellers = [
                { 
                    id: 1, 
                    name: '√ñrnek Market', 
                    image: 'https://images.unsplash.com/photo-1604719312566-8912e221a99f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80',
                    rating: 4.5,
                    deliveryFee: 5.99,
                    minOrder: 50,
                    freeDelivery: false
                },
                { 
                    id: 2, 
                    name: 'Lezzet Restoran', 
                    image: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80',
                    rating: 4.8,
                    deliveryFee: 0,
                    minOrder: 75,
                    freeDelivery: true
                },
                { 
                    id: 3, 
                    name: 'Taze Fƒ±rƒ±n', 
                    image: 'https://images.unsplash.com/photo-1509440159596-0249088772ff?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80',
                    rating: 4.7,
                    deliveryFee: 3.99,
                    minOrder: 25,
                    freeDelivery: false
                }
            ];
            
            const sellerGrid = document.getElementById('sellerGrid');
            sellerGrid.innerHTML = '';
            
            sellers.forEach(seller => {
                const card = document.createElement('div');
                card.className = 'seller-card';
                
                card.innerHTML = `
                    <img src="${seller.image}" alt="${seller.name}" class="seller-image">
                    <div class="seller-info">
                        <div class="seller-name">${seller.name}</div>
                        <div class="seller-details">
                            <span><i class="fas fa-map-marker-alt"></i> 1.2 km</span>
                            <span class="seller-rating">
                                <i class="fas fa-star"></i>
                                ${seller.rating}
                            </span>
                        </div>
                        <div class="delivery-info">
                            <div class="delivery-fee ${seller.freeDelivery ? 'free' : ''}">
                                <i class="fas fa-motorcycle"></i>
                                ${seller.freeDelivery ? '√úcretsiz Teslimat' : `Teslimat: ${seller.deliveryFee} ‚Ç∫`}
                            </div>
                            ${seller.minOrder ? `<div class="min-order">Min. Sipari≈ü: ${seller.minOrder} ‚Ç∫</div>` : ''}
                        </div>
                    </div>
                `;
                
                card.addEventListener('click', function() {
                    // Kategorileri g√∂ster
                    document.getElementById('categoriesSection').style.display = 'block';
                    loadSampleCategories();
                    
                    // Satƒ±cƒ± bilgisini g√ºncelle
                    document.getElementById('selectedSellerInfo').textContent = seller.name;
                });
                
                sellerGrid.appendChild(card);
            });
        }
        
        function loadSampleCategories() {
            const categories = [
                { id: 1, name: 'Meyve & Sebze', icon: 'fas fa-apple-alt' },
                { id: 2, name: 'S√ºt √úr√ºnleri', icon: 'fas fa-cheese' },
                { id: 3, name: 'Et & Tavuk', icon: 'fas fa-drumstick-bite' },
                { id: 4, name: 'Temel Gƒ±da', icon: 'fas fa-wheat-alt' },
                { id: 5, name: 'ƒ∞√ßecekler', icon: 'fas fa-wine-bottle' },
                { id: 6, name: 'Atƒ±≈ütƒ±rmalƒ±k', icon: 'fas fa-cookie' }
            ];
            
            const categoriesGrid = document.getElementById('categoriesGrid');
            categoriesGrid.innerHTML = '';
            
            categories.forEach(category => {
                const card = document.createElement('div');
                card.className = 'category-card';
                
                card.innerHTML = `
                    <div class="category-icon">
                        <i class="${category.icon}"></i>
                    </div>
                    <div class="category-name">${category.name}</div>
                `;
                
                card.addEventListener('click', function() {
                    // √úr√ºnleri g√∂ster
                    document.getElementById('productsSection').style.display = 'block';
                    loadSampleProducts();
                });
                
                categoriesGrid.appendChild(card);
            });
        }
        
        function loadSampleProducts() {
            const products = [
                { 
                    id: 1, 
                    name: 'S√ºt 1L', 
                    image: 'https://images.unsplash.com/photo-1563636619-e9143da7973b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=500&q=80',
                    price: 15.90,
                    discountPrice: 12.90,
                    hasDiscount: true
                },
                { 
                    id: 2, 
                    name: 'Ekmek', 
                    image: 'https://images.unsplash.com/photo-1549931319-a545dcf3bc73?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=500&q=80',
                    price: 5.50,
                    discountPrice: null,
                    hasDiscount: false
                },
                { 
                    id: 3, 
                    name: 'Yumurta 10\'lu', 
                    image: 'https://images.unsplash.com/photo-1582722872445-44dc5f7e3c8f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=500&q=80',
                    price: 32.00,
                    discountPrice: 28.00,
                    hasDiscount: true
                },
                { 
                    id: 4, 
                    name: 'Peynir 500g', 
                    image: 'https://images.unsplash.com/photo-1552767059-ce182ead6c1b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=500&q=80',
                    price: 45.00,
                    discountPrice: null,
                    hasDiscount: false
                },
                { 
                    id: 5, 
                    name: 'Domates 1kg', 
                    image: 'https://images.unsplash.com/photo-1592924357228-91a4daadcfea?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=500&q=80',
                    price: 18.00,
                    discountPrice: 15.00,
                    hasDiscount: true
                }
            ];
            
            const productsGrid = document.getElementById('productsGrid');
            productsGrid.innerHTML = '';
            
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                
                card.innerHTML = `
                    ${product.hasDiscount ? '<div class="product-badge">ƒ∞ndirim</div>' : ''}
                    <img src="${product.image}" alt="${product.name}" class="product-image">
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">
                            ${product.hasDiscount ? `
                                <span>${product.discountPrice} ‚Ç∫</span>
                                <span class="product-discount">${product.price} ‚Ç∫</span>
                            ` : `
                                <span>${product.price} ‚Ç∫</span>
                            `}
                        </div>
                        <button class="add-to-cart-btn" data-translate="add_to_cart">Sepete Ekle</button>
                    </div>
                `;
                
                productsGrid.appendChild(card);
            });
        }
        
        // =============================================
        // UYGULAMA BA≈ûLATMA
        // =============================================
       // setupHorizontalScrolling fonksiyonunu ekliyoruz
function setupHorizontalScrolling() {
    try {
        debugLog('üîß Yatay kaydƒ±rma sistemleri ayarlanƒ±yor...');
        
        // Store types kaydƒ±rma
        const scrollStoreTypesLeft = document.getElementById('scrollStoreTypesLeft');
        const scrollStoreTypesRight = document.getElementById('scrollStoreTypesRight');
        const sellerTypeGrid = document.getElementById('sellerTypeGrid');
        
        if (scrollStoreTypesLeft && sellerTypeGrid) {
            scrollStoreTypesLeft.addEventListener('click', () => {
                sellerTypeGrid.scrollBy({ left: -200, behavior: 'smooth' });
            });
        }
        
        if (scrollStoreTypesRight && sellerTypeGrid) {
            scrollStoreTypesRight.addEventListener('click', () => {
                sellerTypeGrid.scrollBy({ left: 200, behavior: 'smooth' });
            });
        }
        
        // Sellers kaydƒ±rma
        const scrollSellersLeft = document.getElementById('scrollSellersLeft');
        const scrollSellersRight = document.getElementById('scrollSellersRight');
        const sellerGrid = document.getElementById('sellerGrid');
        
        if (scrollSellersLeft && sellerGrid) {
            scrollSellersLeft.addEventListener('click', () => {
                sellerGrid.scrollBy({ left: -200, behavior: 'smooth' });
            });
        }
        
        if (scrollSellersRight && sellerGrid) {
            scrollSellersRight.addEventListener('click', () => {
                sellerGrid.scrollBy({ left: 200, behavior: 'smooth' });
            });
        }
        
        // Categories kaydƒ±rma
        const scrollCategoriesLeft = document.getElementById('scrollCategoriesLeft');
        const scrollCategoriesRight = document.getElementById('scrollCategoriesRight');
        const categoriesGrid = document.getElementById('categoriesGrid');
        
        if (scrollCategoriesLeft && categoriesGrid) {
            scrollCategoriesLeft.addEventListener('click', () => {
                categoriesGrid.scrollBy({ left: -200, behavior: 'smooth' });
            });
        }
        
        if (scrollCategoriesRight && categoriesGrid) {
            scrollCategoriesRight.addEventListener('click', () => {
                categoriesGrid.scrollBy({ left: 200, behavior: 'smooth' });
            });
        }
        
        // Products kaydƒ±rma
        const scrollProductsLeft = document.getElementById('scrollProductsLeft');
        const scrollProductsRight = document.getElementById('scrollProductsRight');
        const productsGrid = document.getElementById('productsGrid');
        
        if (scrollProductsLeft && productsGrid) {
            scrollProductsLeft.addEventListener('click', () => {
                productsGrid.scrollBy({ left: -200, behavior: 'smooth' });
            });
        }
        
        if (scrollProductsRight && productsGrid) {
            scrollProductsRight.addEventListener('click', () => {
                productsGrid.scrollBy({ left: 200, behavior: 'smooth' });
            });
        }
        
        debugLog('‚úÖ Yatay kaydƒ±rma sistemleri ayarlandƒ±');
    } catch (error) {
        console.error('‚ùå Yatay kaydƒ±rma ayarlama hatasƒ±:', error);
    }
}

// =============================================
// VIDEO AUTOPLAY SORUNU √á√ñZ√úM√ú
// =============================================

// Banner video autoplay sorununu √ß√∂z
	function setupBannerVideo() {
    const bannerVideo = document.getElementById('bannerVideo');
    if (!bannerVideo) return;
    
    // Video y√ºkleme event'leri
    bannerVideo.addEventListener('loadeddata', function() {
        console.log('üé• Video y√ºklendi, oynatƒ±lmaya √ßalƒ±≈üƒ±lƒ±yor...');
        this.play().catch(e => {
            console.log('‚ö†Ô∏è Video otomatik oynatƒ±lamƒ±yor:', e.name);
        });
    });
    
    bannerVideo.addEventListener('error', function(e) {
        console.error('‚ùå Video y√ºkleme hatasƒ±:', e);
        // Fallback: Arkaplan rengi g√∂ster
        const banner = document.getElementById('banner');
        if (banner) {
            banner.style.background = 'linear-gradient(135deg, var(--primary), var(--primary-light))';
        }
    });
    
    // Muted ve playsinline √∂zelliklerini garanti et
    bannerVideo.muted = true;
    bannerVideo.playsInline = true;
    bannerVideo.setAttribute('playsinline', '');
    bannerVideo.setAttribute('webkit-playsinline', '');
}
   
            
            // Banner konum butonu
            document.getElementById('bannerLocationBtn').addEventListener('click', function() {
                showLocationModal();
            });
            
            // Konum modalƒ± event'leri
            document.getElementById('closeLocationModal').addEventListener('click', hideLocationModal);
            
            document.querySelectorAll('.location-option').forEach(option => {
                option.addEventListener('click', function() {
                    // T√ºm se√ßeneklerden se√ßimi kaldƒ±r
                    document.querySelectorAll('.location-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Bu se√ßeneƒüi se√ßili yap
                    this.classList.add('selected');
                    
                    // Konum t√ºr√ºn√º se√ß
                    const locationType = this.getAttribute('data-location');
                    
                    // Modal'ƒ± kapat
                    setTimeout(hideLocationModal, 500);
                });
            });
            
            // Konum tespit butonu
            document.getElementById('detectLocationBtn').addEventListener('click', function() {
                // Konum tespit sim√ºlasyonu
                const resultDiv = document.getElementById('locationResult');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <div style="color: var(--success);">
                        <i class="fas fa-check-circle"></i> 
                        <strong>Konumunuz Belirlendi!</strong>
                        <div style="font-size: 12px; margin-top: 5px;">
                            Kadƒ±k√∂y, ƒ∞stanbul
                        </div>
                    </div>
                `;
            });
            
            // Dƒ±≈üarƒ± tƒ±klayƒ±nca modal'ƒ± kapat
            window.addEventListener('click', function(e) {
                if (e.target === document.getElementById('locationModal')) {
                    hideLocationModal();
                }
            });
        });
        
        // =============================================
        // BA≈ûLANGI√á KODLARI - 1. B√ñL√úM √ñNCESƒ∞
        // =============================================

        // Supabase configuration
        const SUPABASE_URL = "https://xliutvspwodhoaxvysks.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsaXV0dnNwd29kaG9heHZ5c2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTgyOTksImV4cCI6MjA3MjkzNDI5OX0.Zodisa_ifP8t2Q4X0ecnB56RiR_Bg4QS5gvPn5ZLK_w";

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Global state
        let currentCustomer = null;
        let sellers = [];
        let products = [];
        let categories = [];
        let storeTypes = [];
        let cart = [];
        let recognition = null;
        let isListening = false;
        let isMicrophoneEnabled = false;
        let conversationStep = 0;
        let currentPaymentMethod = null;
        let selectedSellerId = null;
        let selectedSellerType = null;
        let selectedCategoryId = null;
        let isSellerLocked = false;
        let selectedLocation = null;
        let referralCode = null;
        let referralGroupCode = null;
		let selectedStoreTypeId = null;
		let selectedStoreTypeName = null;
		let allSellersInLocation = []; // Konumdaki t√ºm satƒ±cƒ±lar (store type filtresi olmadan)
		let filteredSellers = []; // Store type'a g√∂re filtrelenmi≈ü satƒ±cƒ±lar
		let pendingCart = []; // Oturum a√ßƒ±lana kadar bekleyen sepet
		let isGuestMode = false; // Misafir modu
		let pendingOrder = null; // Bekleyen sipari≈ü
		let currentRoot = "0:0"; // Mevcut k√∂k durumu
		let pendingResponse = null; // Askƒ±da cevap
		let commandRules = new Map(); // Komut kurallarƒ±
		let appInitialized = false;
		let domLoaded = false;
		let isLocationDetected = false;
	
		// Global state'e ekle
		let userLocation = {
	   	latitude: null,
   	 	longitude: null,
  	  	address: null,
 	  	city: null,
   	 	district: null
	};
	
        // DOM Elements
        const profileBtn = document.getElementById('profileBtn');
        const profileDropdown = document.getElementById('profileDropdown');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profilePhone = document.getElementById('profilePhone');
        const profileCity = document.getElementById('profileCity');
        const profileAddress = document.getElementById('profileAddress');
        const profileBonus = document.getElementById('profileBonus');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const microphoneToggle = document.getElementById('microphoneToggle');
        const sellerTypeGrid = document.getElementById('sellerTypeGrid');
        const scrollSellerTypesLeft = document.getElementById('scrollSellerTypesLeft');
        const scrollSellerTypesRight = document.getElementById('scrollSellerTypesRight');
        const categoriesSection = document.getElementById('categoriesSection');
        const categoriesTitle = document.getElementById('categoriesTitle');
        const categoriesGrid = document.getElementById('categoriesGrid');
        const scrollCategoriesLeft = document.getElementById('scrollCategoriesLeft');
        const scrollCategoriesRight = document.getElementById('scrollCategoriesRight');
        const sellersSection = document.getElementById('sellersSection');
        const sellerGrid = document.getElementById('sellerGrid');
        const scrollSellersLeft = document.getElementById('scrollSellersLeft');
        const scrollSellersRight = document.getElementById('scrollSellersRight');
        const productsSection = document.getElementById('productsSection');
        const selectedSellerInfo = document.getElementById('selectedSellerInfo');
        const productsGrid = document.getElementById('productsGrid');
        const cartContainer = document.getElementById('cartContainer');
        const cartClose = document.getElementById('cartClose');
        const cartItems = document.getElementById('cartItems');
        const orderSummary = document.getElementById('orderSummary');
        const orderCount = document.getElementById('orderCount');
        const orderTotal = document.getElementById('orderTotal');
        const subtotalEl = document.getElementById('subtotal');
        const discountEl = document.getElementById('discount');
        const vatAmountEl = document.getElementById('vatAmount');
        const totalAmountEl = document.getElementById('totalAmount');
        const payCashBtn = document.getElementById('payCash');
        const payCardBtn = document.getElementById('payCard');
        const payBonusBtn = document.getElementById('payBonus');
        const assistantMessage = document.getElementById('assistantMessage');
        const userMessage = document.getElementById('userMessage');
        const voiceIndicator = document.getElementById('voiceIndicator');
        const closeVoiceStatus = document.getElementById('closeVoiceStatus');
        const voiceStatusPanel = document.getElementById('voiceStatusPanel');
        const howItWorks = document.getElementById('howItWorks');
        const locationMarker = document.getElementById('locationMarker');
        const locationText = document.getElementById('locationText');
        const locationModal = document.getElementById('locationModal');
        const referralLink = document.getElementById('referralLink');
        const whatsappOrder = document.getElementById('whatsappOrder');
	

        // Utility functions
        function money(n) { 
            return Number(n||0).toLocaleString('tr-TR',{minimumFractionDigits:2, maximumFractionDigits:2}) + ' ‚Ç∫'; 
        }

        // Debug modu
        const DEBUG_MODE = true;

        // Debug fonksiyonu
        function debugLog(message, data = null) {
            if (DEBUG_MODE) {
                console.log(`[DEBUG] ${new Date().toLocaleTimeString()}: ${message}`, data || '');
            }
        }

        // =============================================
        // LOKASYON SE√áƒ∞M Sƒ∞STEMƒ∞
        // =============================================

	function showLocationModal() {
    const modal = document.getElementById('locationModal');
    if (!modal) {
        console.error('‚ùå Location modal bulunamadƒ±');
        return;
    }

    document.body.classList.add('modal-open');
    modal.style.display = 'flex';
    modal.style.zIndex = '10000';
    
    // Modal i√ßeriƒüini g√ºncelle
    updateLocationModal();
    
    // Modal kapatma event'lerini ayarla
    setupModalCloseEvents();
    
    debugLog('üìç Konum modalƒ± g√∂sterildi (zorunlu)');
}

// Konum se√ßimini g√ºncelle - T√úM SATICILARI Y√úKLE
function selectLocation(locationType) {
    console.log('üìç Se√ßilen konum:', locationType);
    
    if (!locationType) {
        console.error('‚ùå Konum tipi belirtilmedi');
        return;
    }
    
    // Adrese teslim se√ßildiyse konum bilgisi kontrol√º
    if (locationType === 'delivery' && !isLocationDetected) {
        speakToUser("Adrese teslim i√ßin l√ºtfen √∂nce konumunuzu tespit edin.");
        return;
    }
    
    selectedLocation = locationType;
    localStorage.setItem('selectedLocation', locationType);
    
    // Konum bilgisini de kaydet
    if (userLocation) {
        localStorage.setItem('userLocation', JSON.stringify(userLocation));
    }
    
    updateLocationText();
    hideLocationModal();
    
    // K√ñK DEƒûƒ∞≈ûƒ∞KLƒ∞ƒûƒ∞: Konum se√ßildi, maƒüaza tipi se√ßimine ge√ß
    currentRoot = "1:0";
    
    // KONUM SE√áƒ∞LDƒ∞ƒûƒ∞NDE T√úM SATICILARI Y√úKLE
    loadAllSellersByLocation();
    
    debugLog('üìç Konum se√ßildi:', locationType);
    
    if (locationType === 'delivery') {
        speakToUser(`Konumunuz kaydedildi: ${userLocation.district}, ${userLocation.city}. Hangi maƒüaza tipinden alƒ±≈üveri≈ü yapmak istersiniz? Market, restoran, eczane?`);
    } else {
        speakToUser(`Konumunuz kaydedildi: ${locationType === 'inside' ? 'Restoran i√ßinde' : 'Paket servis'}. Hangi maƒüaza tipinden alƒ±≈üveri≈ü yapmak istersiniz?`);
    }
}

// Konum alma fonksiyonu
function getCurrentLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject(new Error('Tarayƒ±cƒ±nƒ±z konum almaya izin vermiyor.'));
        } else {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    // Reverse geocoding i√ßin Nominatim API'sini kullan
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                        const data = await response.json();
                        resolve({
                            coordinates: { latitude, longitude },
                            address: data.address,
                            display_name: data.display_name
                        });
                    } catch (error) {
                        reject(error);
                    }
                },
                (error) => {
                    reject(error);
                }
            );
        }
    });
}

// Konum metnini g√ºncelle - Konum bilgisini g√∂ster
function updateLocationText() {
    if (locationText && selectedLocation) {
        const locationNames = {
            'inside': 'Restoran i√ßinde',
            'takeaway': 'Paket servis', 
            'delivery': 'Adrese teslim'
        };
        
        let locationTextContent = locationNames[selectedLocation] || selectedLocation;
        
        // Adrese teslimde konum bilgisini g√∂ster
        if (selectedLocation === 'delivery' && userLocation.city) {
            locationTextContent += ` - ${userLocation.district}, ${userLocation.city}`;
        }
        
        locationText.textContent = locationTextContent;
    }
}

        function setupLocationEvents() {
            const locationMarker = document.getElementById('locationMarker');
            if (locationMarker) {
                locationMarker.onclick = null;
                locationMarker.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üìç Konum marker tƒ±klandƒ±');
                    showLocationModal();
                });
                locationMarker.style.cursor = 'pointer';
                debugLog('‚úÖ Konum marker eventleri ayarlandƒ±');
            }
        }

     
// Uygulama ba≈ülangƒ±cƒ±nda konumu zorunlu yap
function initializeLocation() {
    debugLog('üìç Konum y√∂netimi ba≈ülatƒ±lƒ±yor...');
    
    // Her zaman konum modalƒ±nƒ± g√∂ster (zorunlu)
    setTimeout(() => {
        showLocationModal();
    }, 1000);
    
    // Konum modal i√ßeriƒüini g√ºncelle
    updateLocationModal();
}

// Konum modalƒ±nƒ± g√ºncelle - SADECE KONUM TESPƒ∞Tƒ∞
function updateLocationModal() {
    const locationModal = document.getElementById('locationModal');
    if (!locationModal) return;
    
    locationModal.querySelector('.modal-body').innerHTML = `
        <div class="modal-header">
           
            <span class="close-modal" id="closeLocationModal">&times;</span>
        </div>
        <p><strong>Sipari≈üiniz i√ßin l√ºtfen konumunuzu belirleyin:</strong></p>
        
        <div class="location-options">
            <div class="location-option" data-location="inside">
                <i class="fas fa-utensils"></i>
                <div>
                    <strong>Restoran i√ßinde</strong>
                    <small>Yemeƒüinizi restoranda yiyin</small>
                </div>
            </div>
            
            <div class="location-option" data-location="takeaway">
                <i class="fas fa-utensils"></i>
                <div>
                    <strong>Paket servis</strong>
                    <small>Yemeƒüinizi kendiniz alƒ±n</small>
                </div>
            </div>
            
            <div class="location-option" data-location="delivery">
                <i class="fas fa-motorcycle"></i>
                <div>
                    <strong>Adrese teslim</strong>
                    <small>Yemeƒüiniz adresinize gelsin</small>
                </div>
            </div>
        </div>

        <!-- Konum tespit butonu -->
        <div style="margin-top: 20px; text-align: center;">
            <button id="detectLocationBtn" style="width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 16px;">
                <i class="fas fa-location-arrow"></i> Konumumu Otomatik Belirle
            </button>
            <div id="locationResult" class="location-result" style="display: none; margin-top: 15px;"></div>
        </div>

        <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; border: 1px solid #ffeaa7; font-size: 14px;">
            <i class="fas fa-info-circle"></i>
            <strong>Not:</strong> Konumunuz sadece size en yakƒ±n satƒ±cƒ±larƒ± g√∂stermek i√ßin kullanƒ±lacaktƒ±r.
        </div>
    `;
    
    // LOKASYON SE√áƒ∞M EVENT'LERƒ∞Nƒ∞ EKLE
    setTimeout(() => {
        // Lokasyon se√ßeneklerine tƒ±klama event'leri
        document.querySelectorAll('.location-option').forEach(option => {
            option.addEventListener('click', function() {
                const locationType = this.getAttribute('data-location');
                
                // T√ºm se√ßeneklerden se√ßimi kaldƒ±r
                document.querySelectorAll('.location-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Bu se√ßeneƒüi se√ßili yap
                this.classList.add('selected');
                
                // Restoran i√ßi veya paket servis i√ßin direkt se√ß
                if (locationType === 'inside' || locationType === 'takeaway') {
                    selectLocation(locationType);
                } else {
                    // Adrese teslim i√ßin konum tespiti gerekli
                    speakToUser("Adrese teslim i√ßin l√ºtfen konumunuzu belirleyin.");
                }
            });
        });
        
        // Konum tespit butonu
        const detectBtn = document.getElementById('detectLocationBtn');
        if (detectBtn) {
            detectBtn.addEventListener('click', function() {
                detectUserLocation().then(success => {
                    if (success) {
                        // Konum tespit edildiƒüinde, adrese teslim se√ßeneƒüini otomatik se√ß
                        const deliveryOption = document.querySelector('.location-option[data-location="delivery"]');
                        if (deliveryOption) {
                            // √ñnce diƒüer se√ßeneklerden se√ßimi kaldƒ±r
                            document.querySelectorAll('.location-option').forEach(opt => {
                                opt.classList.remove('selected');
                            });
                            // Adrese teslimi se√ßili yap
                            deliveryOption.classList.add('selected');
                            // Lokasyonu se√ß
                            selectLocation('delivery');
                        }
                    }
                });
            });
        }
        
        // Modal kapatma event'ini ayarla
        setupModalCloseEvents();
        
    }, 100);
}

// Modal gizleme fonksiyonlarƒ±
function hideLocationModal() {
    const modal = document.getElementById('locationModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    }
    debugLog('üìç Konum modalƒ± gizlendi');
}

// Modal kapatma event'ini ayarla
function setupModalCloseEvents() {
    // Konum modal kapatma
    const closeLocationModal = document.getElementById('closeLocationModal');
    if (closeLocationModal) {
        closeLocationModal.addEventListener('click', function(e) {
            e.stopPropagation();
            hideLocationModal();
        });
    }
    
    // Modal dƒ±≈üƒ±na tƒ±klayƒ±nca kapanmasƒ±nƒ± engelle (konum zorunlu)
    const locationModal = document.getElementById('locationModal');
    if (locationModal) {
        locationModal.addEventListener('click', function(e) {
            if (e.target === locationModal) {
                // Modal dƒ±≈üƒ±na tƒ±klanƒ±rsa sadece uyarƒ± ver, kapatma
                speakToUser("L√ºtfen bir konum se√ßiniz. Konum se√ßmeden devam edemezsiniz.");
            }
        });
    }
}


//=====================================
// KONUM ALMA FONKSƒ∞YONU
//=====================================

// Konum tespit et - HTML5 Geolocation API (G√úNCELLENMƒ∞≈û)
async function detectUserLocation() {
    const resultDiv = document.getElementById('locationResult');
    const detectBtn = document.getElementById('detectLocationBtn');
    
    if (!navigator.geolocation) {
        showLocationError("Tarayƒ±cƒ±nƒ±z konum servisini desteklemiyor.");
        return false;
    }
    
    // Butonu loading durumuna getir
    if (detectBtn) {
        detectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Konumunuz Belirleniyor...';
        detectBtn.disabled = true;
    }
    
    if (resultDiv) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div style="color: #007bff;"><i class="fas fa-spinner fa-spin"></i> Konumunuz belirleniyor...</div>';
    }
    
    try {
        const position = await getCurrentPosition();
        const { latitude, longitude } = position.coords;
        
        // Konumu adrese √ßevir
        const address = await reverseGeocode(latitude, longitude);
        
        // Konum bilgisini kaydet - ≈üehir ve il√ße bilgisi
        userLocation = {
            latitude,
            longitude,
            address: address.display_name,
            city: address.address?.city || address.address?.town || address.address?.village || 'Bilinmeyen',
            district: address.address?.suburb || address.address?.county || address.address?.state_district || 'Bilinmeyen',
            fullAddress: address.display_name
        };
        
        isLocationDetected = true;
        
        // Sonucu g√∂ster
        if (resultDiv) {
            resultDiv.innerHTML = `
                <div style="color: var(--success);">
                    <i class="fas fa-check-circle"></i> 
                    <strong>Konumunuz Belirlendi!</strong>
                    <div style="font-size: 12px; margin-top: 5px;">
                        ${userLocation.district}, ${userLocation.city}
                    </div>
                </div>
            `;
        }
        
        debugLog('üìç Konum tespit edildi:', userLocation);
        return true;
        
    } catch (error) {
        console.error('Konum tespit hatasƒ±:', error);
        showLocationError("Konumunuz belirlenemedi. L√ºtfen tarayƒ±cƒ± ayarlarƒ±nƒ±zdan konum eri≈üimine izin verin.");
        return false;
    } finally {
        // Butonu eski haline getir
        if (detectBtn) {
            detectBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Konumumu Otomatik Belirle';
            detectBtn.disabled = false;
        }
    }
}

// Yeni √ºyelik sƒ±rasƒ±nda adres teyidi
async function confirmAddressWithAssistant() {
    return new Promise((resolve) => {
        if (!userLocation || !userLocation.fullAddress) {
            resolve(false);
            return;
        }
        
        const detectedAddress = userLocation.fullAddress;
        
        speakToUser(`Konumunuz ≈üu ≈üekilde belirlendi: ${detectedAddress}. Bu adresiniz doƒüru mu? L√ºtfen 'Evet' veya 'Hayƒ±r' diyerek teyit edin.`);
        
        // Sesli cevap bekliyoruz
        const originalProcessCommand = window.processVoiceCommand;
        let responseReceived = false;
        
        window.processVoiceCommand = function(transcript) {
            const message = transcript.toLowerCase().trim();
            
            if (message.includes('evet') || message.includes('doƒüru') || message.includes('onay')) {
                responseReceived = true;
                window.processVoiceCommand = originalProcessCommand;
                speakToUser("Te≈üekk√ºr ederim! Adresiniz kaydedildi.");
                resolve(true);
            } 
            else if (message.includes('hayƒ±r') || message.includes('yanlƒ±≈ü') || message.includes('deƒüil')) {
                responseReceived = true;
                window.processVoiceCommand = originalProcessCommand;
                speakToUser("√ñz√ºr dilerim. L√ºtfen doƒüru adresinizi s√∂yleyin.");
                resolve(false);
            }
            else {
                // Anla≈üƒ±lamadƒ±, tekrar sor
                speakToUser(`Adresiniz: ${detectedAddress}. Doƒüru mu? L√ºtfen 'Evet' veya 'Hayƒ±r' diyerek teyit edin.`);
            }
        };
        
        // 30 saniye timeout
        setTimeout(() => {
            if (!responseReceived) {
                window.processVoiceCommand = originalProcessCommand;
                speakToUser("Adres teyidi zaman a≈üƒ±mƒ±na uƒüradƒ±. Varsayƒ±lan adres kullanƒ±lacak.");
                resolve(true); // Zaman a≈üƒ±mƒ±nda varsayƒ±lan olarak kabul et
            }
        }, 30000);
    });
}
// HTML5 Geolocation Promise wrapper
function getCurrentPosition() {
    return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
        });
    });
}

// Koordinatlarƒ± adrese √ßevir - OpenStreetMap Nominatim API (√úCRETSƒ∞Z)
async function reverseGeocode(lat, lon) {
    try {
        const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1&zoom=18`
        );
        
        if (!response.ok) {
            throw new Error('Adres √ß√∂z√ºmleme hatasƒ±');
        }
        
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Reverse geocoding hatasƒ±:', error);
        // Fallback: Basit koordinat bilgisi
        return {
            display_name: `Konum: ${lat.toFixed(6)}, ${lon.toFixed(6)}`,
            address: {
                city: 'Bilinmeyen',
                town: 'Bilinmeyen',
                village: 'Bilinmeyen',
                suburb: 'Bilinmeyen'
            }
        };
    }
}

// Konum hatasƒ± g√∂ster
function showLocationError(message) {
    const resultDiv = document.getElementById('locationResult');
    if (resultDiv) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div style="color: #dc3545;">
                <i class="fas fa-exclamation-triangle"></i> 
                ${message}
                <button onclick="showManualAddressInput()" style="margin-top: 8px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">
                    Manuel Adres Gir
                </button>
            </div>
        `;
    }
    speakToUser("Konumunuz tespit edilemedi. L√ºtfen manuel olarak adres giriniz.");
}


// Manuel adres giri≈üi formu
function showManualAddressInput() {
    const resultDiv = document.getElementById('locationResult');
    if (!resultDiv) return;
    
    resultDiv.innerHTML = `
        <div style="color: #333;">
            <strong>L√ºtfen Adresinizi Girin:</strong>
            <div style="margin-top: 10px;">
                <input type="text" id="manualCity" placeholder="ƒ∞l" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="text" id="manualDistrict" placeholder="ƒ∞l√ße" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <textarea id="manualAddress" placeholder="Detaylƒ± adres" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px; height: 60px;"></textarea>
                <button onclick="saveManualAddress()" style="padding: 8px 15px; background: var(--success); color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Adresi Kaydet
                </button>
            </div>
        </div>
    `;
}

// Manuel adres kaydƒ±
function saveManualAddress() {
    const city = document.getElementById('citySelect')?.value;
    const district = document.getElementById('districtSelect')?.value;
    const detailedAddress = document.getElementById('detailedAddress')?.value;
    
    if (!city || !district) {
        alert('L√ºtfen il ve il√ße bilgilerinizi se√ßin.');
        return;
    }
    
    if (!detailedAddress || detailedAddress.trim().length < 10) {
        alert('L√ºtfen detaylƒ± adresinizi girin (en az 10 karakter).');
        return;
    }
    
    userLocation = {
        city: city,
        district: district,
        address: detailedAddress.trim(),
        fullAddress: `${detailedAddress.trim()}, ${district}, ${city}`
    };
    
    isLocationDetected = true;
    
    const resultDiv = document.getElementById('locationResult');
    if (resultDiv) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div style="color: var(--success);">
                <i class="fas fa-check-circle"></i> 
                <strong>Adresiniz Kaydedildi</strong>
                <div style="font-size: 12px; margin-top: 5px;">
                    ${district}, ${city}
                </div>
            </div>
        `;
    }
    
    speakToUser(`Adresiniz kaydedildi: ${district}, ${city}.`);
}

        // =============================================
        // Mƒ∞KROFON VE SESLƒ∞ ASƒ∞STAN Sƒ∞STEMƒ∞
        // =============================================

        function handleMicrophoneToggle() {
            console.log('üé§ Mikrofon toggle √ßaƒürƒ±ldƒ±', { 
                selectedLocation: selectedLocation, 
                currentCustomer: currentCustomer 
            });
            
            if (!selectedLocation) {
                console.log('üìç Konum se√ßilmemi≈ü');
                showLocationModal();
                speakToUser("L√ºtfen √∂nce bir konum se√ßiniz.");
                return;
            }
            
            if (isListening) {
                disableMicrophone();
            } else {
                enableMicrophone();
            }
        }



        async function enableMicrophone() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error("Mikrofon eri≈üimi desteklenmiyor");
                }

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                isMicrophoneEnabled = true;
                microphoneToggle.innerHTML = '<i class="fas fa-microphone"></i> <span>Mikrofon (A√ßƒ±k)</span>';
                microphoneToggle.classList.add('listening');
                
                initializeSpeechRecognition();
                
                if (assistantMessage) {
                    assistantMessage.textContent = "Mikrofon a√ßƒ±ldƒ±. Konu≈ümaya ba≈ülayabilirsiniz.";
                }
                
                // Sesli kar≈üƒ±lama mesajƒ±
                setTimeout(() => {
                    initializeVoiceAssistant();
                }, 1000);
                
                stream.getTracks().forEach(track => track.stop());
                
            } catch (error) {
                console.error("Mikrofon eri≈üim hatasƒ±:", error);
                let errorMessage = "Mikrofon eri≈üimi saƒülanamadƒ±. ";
                
                if (error.name === "NotAllowedError") {
                    errorMessage += "L√ºtfen tarayƒ±cƒ± ayarlarƒ±nƒ±zdan mikrofon eri≈üimine izin verin.";
                } else if (error.name === "NotFoundError") {
                    errorMessage += "Mikrofon cihazƒ± bulunamadƒ±.";
                } else {
                    errorMessage += "Beklenmeyen bir hata olu≈ütu: " + error.message;
                }
                
                if (assistantMessage) {
                    assistantMessage.textContent = errorMessage;
                }
                disableMicrophone();
            }
        }

        function disableMicrophone() {
            isMicrophoneEnabled = false;
            microphoneToggle.innerHTML = '<i class="fas fa-microphone-slash"></i> <span>Mikrofon (Kapalƒ±)</span>';
            microphoneToggle.classList.remove('listening');
            
            if (recognition) {
                recognition.stop();
            }
            
            if (voiceIndicator) {
                voiceIndicator.classList.remove('listening');
            }
            
            if (assistantMessage) {
                assistantMessage.textContent = "Mikrofon kapalƒ±. Sesli sipari≈ü i√ßin l√ºtfen mikrofonu a√ßƒ±n.";
            }
        }

        function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                if (assistantMessage) {
                    assistantMessage.textContent = "Tarayƒ±cƒ±nƒ±z ses tanƒ±ma √∂zelliƒüini desteklemiyor";
                }
                disableMicrophone();
                return;
            }
            
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.lang = 'tr-TR';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            
            recognition.onstart = function() {
                isListening = true;
                if (voiceIndicator) {
                    voiceIndicator.classList.add('listening');
                }
                if (assistantMessage) {
                    assistantMessage.textContent = "Dinliyorum... Konu≈ümaya ba≈ülayƒ±n.";
                }
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[event.results.length - 1][0].transcript;
                if (userMessage) {
                    userMessage.textContent = transcript;
                }
                processVoiceCommand(transcript);
            };
            
            recognition.onerror = function(event) {
                console.error('Ses tanƒ±ma hatasƒ±:', event.error);
                
                if (event.error === 'no-speech') {
                    return;
                } 
                
                if (event.error === 'not-allowed') {
                    if (assistantMessage) {
                        assistantMessage.textContent = "Mikrofon eri≈üimine izin verilmedi. L√ºtfen tarayƒ±cƒ± ayarlarƒ±nƒ±zdan izin verin.";
                    }
                    disableMicrophone();
                } else {
                    if (assistantMessage) {
                        assistantMessage.textContent = "Ses tanƒ±ma hatasƒ±: " + event.error;
                    }
                }
                
                isListening = false;
                if (voiceIndicator) {
                    voiceIndicator.classList.remove('listening');
                }
            };
            
            recognition.onend = function() {
                isListening = false;
                if (voiceIndicator) {
                    voiceIndicator.classList.remove('listening');
                }
                
                if (isMicrophoneEnabled && !isListening) {
                    setTimeout(() => {
                        try {
                            recognition.start();
                        } catch (error) {
                            console.log('Ses tanƒ±ma yeniden ba≈ülatƒ±lamadƒ±:', error);
                        }
                    }, 500);
                }
            };
            
            try {
                recognition.start();
            } catch (error) {
                console.error('Ses tanƒ±ma ba≈ülatƒ±lamadƒ±:', error);
                if (assistantMessage) {
                    assistantMessage.textContent = "Ses tanƒ±ma ba≈ülatƒ±lamadƒ±. L√ºtfen sayfayƒ± yenileyin.";
                }
                disableMicrophone();
            }
        }

        function initializeVoiceAssistant() {
            setTimeout(() => {
                if (!currentCustomer) {
                    speakToUser("Merhaba! Sesli sipari≈ü sistemine ho≈ü geldiniz. Telefon numaranƒ±zƒ± s√∂yleyerek giri≈ü yapabilir veya misafir olarak devam edebilirsiniz.");
                    conversationStep = 0;
                } else {
                    speakToUser(`Ho≈ü geldiniz ${currentCustomer.name}! Ne satƒ±n almak istersiniz?`);
                }
            }, 1000);
        }

        function speakToUser(message) {
            if (assistantMessage) {
                assistantMessage.textContent = message;
            }
            
            if ('speechSynthesis' in window) {
                const speech = new SpeechSynthesisUtterance(message);
                speech.lang = 'tr-TR';
                speech.volume = 1;
                speech.rate = 1;
                speech.pitch = 1;
                window.speechSynthesis.speak(speech);
            }
        }






// K√∂k komut i≈üleme - √úR√úN EKLEME DESTEƒûƒ∞ EKLENDƒ∞
function processRootCommand(message) {
    const rules = commandRules.get(currentRoot) || [];
    
    for (const rule of rules) {
        const patterns = rule.input_patterns.split('|');
        for (const pattern of patterns) {
            if (matchesPattern(message, pattern)) {
                const extractedData = extractData(message, pattern);
                executeMatchedRule(rule, extractedData, message);
                return true;
            }
        }
    }
    return false;
}


// √ñdeme komutlarƒ±nƒ± i≈üle - OTURUM KONTROLL√ú
function handlePaymentCommands(message) {
    const paymentMethods = {
        'nakit': 'nakit',
        'kart': 'kart', 
        'kredi kartƒ±': 'kart',
        'bonus': 'bonus',
        'puan': 'bonus'
    };
    
    for (const [key, method] of Object.entries(paymentMethods)) {
        if (message.includes(key)) {
            // Oturum kontrol√º
            if (!currentCustomer) {
                speakToUser(`√ñdeme y√∂nteminiz: ${key}. Sipari≈üi tamamlamak i√ßin telefon numaranƒ±zƒ± s√∂yleyin.`);
                pendingOrder = pendingOrder || {};
                pendingOrder.paymentMethod = method;
                currentRoot = "8:0";
                return true;
            } else {
                speakToUser(`√ñdeme y√∂nteminiz: ${key}. Sipari≈üiniz tamamlanƒ±yor...`);
                finalizeOrder(method);
                return true;
            }
        }
    }
    return false;
}

	// Resim y√ºkleme hatalarƒ±nƒ± yakala
function setupImageErrorHandling() {
    // Mevcut resimlere error handler ekle
    document.querySelectorAll('img').forEach(img => {
        img.addEventListener('error', function() {
            console.log('üñºÔ∏è Resim y√ºkleme hatasƒ±:', this.src);
            // Fallback resim
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGVlMmYzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY3Njc2NyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPlJlc2ltIFl1a8SxZW5lbWVkaTwvdGV4dD48L3N2Zz4=';
            this.onerror = null; // Sonsuz d√∂ng√ºy√º √∂nle
        });
    });
}

// √úr√ºn resimleri i√ßin √∂zel fallback
function setupProductImageFallbacks() {
    const productImages = document.querySelectorAll('.product-image, .seller-image, .cart-item-image');
    productImages.forEach(img => {
        img.addEventListener('error', function() {
            if (this.classList.contains('product-image')) {
                this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGVlMmYzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzY3Njc2NyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPsOccsO8bjwvdGV4dD48L3N2Zz4=';
            } else if (this.classList.contains('seller-image')) {
                this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGVlMmYzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY3Njc2NyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPlNhdMSxY8SxPC90ZXh0Pjwvc3ZnPg==';
            }
            this.onerror = null;
        });
    });
}
// =============================================
// OTURUM Y√ñNETƒ∞Mƒ∞ ƒ∞Yƒ∞LE≈ûTƒ∞RMELERƒ∞
// =============================================

// Oturum a√ßƒ±ldƒ±ƒüƒ±nda √ßaƒürƒ±lacak fonksiyon
function onUserLoggedIn() {
    // Misafir sepetini aktar
    transferGuestCartToUser();
    
    // Bekleyen sipari≈üi tamamla
    if (pendingOrder) {
        speakToUser("Ho≈ü geldiniz! Bekleyen sipari≈üiniz tamamlanƒ±yor...");
        setTimeout(() => {
            completePendingOrder();
        }, 2000);
    }
    
    // UI g√ºncelle
    updateUIAfterLogin();
}

        // =============================================
        // SAYFA Y√úKLEME S√úRECƒ∞
        // =============================================

        function waitForDOMElements() {
            return new Promise((resolve) => {
                const elements = {
                    'microphoneToggle': document.getElementById('microphoneToggle'),
                    'locationModal': document.getElementById('locationModal'),
                    'locationMarker': document.getElementById('locationMarker'),
                    'profileBtn': document.getElementById('profileBtn'),
                    'logoutBtn': document.getElementById('logoutBtn')
                };

                let attempts = 0;
                const maxAttempts = 50;

                const checkElements = () => {
                    attempts++;
                    const loaded = Object.values(elements).filter(el => el !== null).length;
                    const total = Object.keys(elements).length;

                    debugLog(`DOM y√ºkleme: ${loaded}/${total} (deneme ${attempts})`);

                    if (loaded >= 3 || attempts >= maxAttempts) {
                        debugLog('‚úÖ Minimum DOM elementleri y√ºklendi');
                        resolve();
                        return;
                    }

                    setTimeout(checkElements, 100);
                };

                checkElements();
            });
        }

        function setupEventHandlers() {
            try {
                debugLog('üîß Event handlerlar ayarlanƒ±yor...');

                // Konum event'leri
                setupLocationEvents();

                // Mikrofon toggle
                if (microphoneToggle) {
                    microphoneToggle.addEventListener('click', handleMicrophoneToggle);
                }

                // Profil dropdown
                if (profileBtn && profileDropdown) {
                    profileBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        profileDropdown.classList.toggle('show');
                    });
                    
                    document.addEventListener('click', function() {
                        profileDropdown.classList.remove('show');
                    });
                }

                // √áƒ±kƒ±≈ü butonu
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        logout();
                    });
                }

                // Kaydƒ±rma butonlarƒ±
                if (scrollSellerTypesLeft && sellerTypeGrid) {
                    scrollSellerTypesLeft.addEventListener('click', () => scrollElement(sellerTypeGrid, -200));
                    scrollSellerTypesRight.addEventListener('click', () => scrollElement(sellerTypeGrid, 200));
                }
                
                if (scrollCategoriesLeft && categoriesGrid) {
                    scrollCategoriesLeft.addEventListener('click', () => scrollElement(categoriesGrid, -200));
                    scrollCategoriesRight.addEventListener('click', () => scrollElement(categoriesGrid, 200));
                }
                
                if (scrollSellersLeft && sellerGrid) {
                    scrollSellersLeft.addEventListener('click', () => scrollElement(sellerGrid, -200));
                    scrollSellersRight.addEventListener('click', () => scrollElement(sellerGrid, 200));
                }

                // Sepet i≈ülemleri
                if (cartClose) {
                    cartClose.addEventListener('click', closeCart);
                }
                
                if (orderSummary) {
                    orderSummary.addEventListener('click', toggleCart);
                }

                // √ñdeme butonlarƒ±
                if (payCashBtn) {
                    payCashBtn.addEventListener('click', () => finalizeOrder('nakit'));
                }
                if (payCardBtn) {
                    payCardBtn.addEventListener('click', () => finalizeOrder('kart'));
                }
                if (payBonusBtn) {
                    payBonusBtn.addEventListener('click', () => finalizeOrder('bonus'));
                }

                debugLog('‚úÖ T√ºm event handlerlar ba≈üarƒ±yla ayarlandƒ±');

            } catch (error) {
                console.error('‚ùå Event handler ayarlama hatasƒ±:', error);
            }
        }

        function updateUIAfterLogin() {
            updateLogoutButtonVisibility();
            
            if (currentCustomer) {
                hideHowItWorksBanner();
            } else {
                showHowItWorksBanner();
            }
            
            updateCustomerUI();
            updateLocationText();
        }

        function updateLogoutButtonVisibility() {
            if (logoutBtn) {
                logoutBtn.style.display = currentCustomer ? 'block' : 'none';
            }
        }
        
        function updateCustomerUI() {
            if (currentCustomer) {
                if (userName) userName.textContent = currentCustomer.name || 'Profilim';
                if (profileName) profileName.textContent = currentCustomer.name || '-';
                if (profilePhone) profilePhone.textContent = currentCustomer.phone || '-';
                if (profileCity) profileCity.textContent = currentCustomer.city || '-';
                if (profileAddress) profileAddress.textContent = currentCustomer.address || '-';
                if (profileBonus) profileBonus.textContent = money(currentCustomer.bonus_amount || 0);
                if (profileAvatar) profileAvatar.textContent = (currentCustomer.name || 'P').charAt(0).toUpperCase();
            }
        }


 	// Referans linki olu≈ütur
        async function generateReferralLink() {
            if (!currentCustomer) {
                alert('√ñnce giri≈ü yapmalƒ±sƒ±nƒ±z');
                return;
            }
            
            try {
                // √ñnce mevcut bir referans linki var mƒ± kontrol et
                const { data: existingLink, error: checkError } = await supabase
                    .from('referral_links')
                    .select('referral_code, group_code')
                    .eq('owner_user_id', currentCustomer.id)
                    .maybeSingle();
                
                let referralCode, groupCode;
                
                if (existingLink) {
                    referralCode = existingLink.referral_code;
                    groupCode = existingLink.group_code;
                } else {
                    // Yeni referans kodu olu≈ütur
                    referralCode = generateReferralCode();
                    
                    // Grup kodu olu≈ütur veya mevcut kodu al
                    const { data: groupData, error: groupError } = await supabase
                        .from('referral_groups')
                        .select('group_code')
                        .eq('leader_user_id', currentCustomer.id)
                        .maybeSingle();
                    
                    if (groupData) {
                        groupCode = groupData.group_code;
                    } else {
                        groupCode = generateGroupCode();
                        
                        // Yeni grup olu≈ütur
                        const { error: groupCreateError } = await supabase
                            .from('referral_groups')
                            .insert([
                                {
                                    name: `${currentCustomer.name} Grubu`,
                                    leader_user_id: currentCustomer.id,
                                    group_code: groupCode,
                                    created_at: new Date().toISOString()
                                }
                            ]);
                        
                        if (groupCreateError) throw groupCreateError;
                    }
                    
                    // Yeni referans linki olu≈ütur
                    const { error: linkError } = await supabase
                        .from('referral_links')
                        .insert([
                            {
                                owner_user_id: currentCustomer.id,
                                owner_phone: currentCustomer.phone,
                                referral_code: referralCode,
                                group_code: groupCode,
                                created_at: new Date().toISOString()
                            }
                        ]);
                    
                    if (linkError) throw linkError;
                }
                
                // Referans linkini payla≈ü
                const referralLink = `${window.location.origin}${window.location.pathname}?referral_groups=${groupCode}&referral_code=${referralCode}`;
                
                if (navigator.share) {
                    // Web Share API desteƒüi varsa
                    navigator.share({
                        title: 'Onur Market Referans Linkim',
                        text: 'Onur Market\'ten alƒ±≈üveri≈ü yapmak i√ßin linkimi kullanabilirsiniz.',
                        url: referralLink
                    });
                } else {
                    // Web Share API desteklemiyorsa
                    navigator.clipboard.writeText(referralLink).then(() => {
                        alert('Referans linki panoya kopyalandƒ±: ' + referralLink);
                    });
                }
                
            } catch (error) {
                console.error('Referans linki olu≈üturma hatasƒ±:', error);
                alert('Referans linki olu≈üturulurken bir hata olu≈ütu.');
            }
        }

        // Benzersiz referans kodu olu≈ütur
        function generateReferralCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // Benzersiz grup kodu olu≈ütur
        function generateGroupCode() {
            return Math.random().toString(36).substring(2, 6).toUpperCase() + 
                   Math.random().toString(36).substring(2, 6).toUpperCase();
        }


 	
       function emergencyFallback() {
    debugLog('üÜò Acil durum modu aktif');
    
    try {
        // Temel i≈ülevleri ba≈ülat
        setupLocationEvents();
        setupModalCloseEvents();
        setupHorizontalScrolling();
        setupImageErrorHandling();
        setupProductImageFallbacks();
        
        if (!selectedLocation) {
            setTimeout(() => {
                showLocationModal();
            }, 2000);
        }
        
        // Kullanƒ±cƒ±ya bilgi ver
        speakToUser("Sistemde ge√ßici bir sorun olu≈ütu. Temel i≈ülevlerle devam ediyoruz.");
    } catch (error) {
        console.error('‚ùå Acil durum modunda bile hata:', error);
    }
}

// =============================================
// UYGULAMA BA≈ûLATMA - D√úZELTƒ∞LMƒ∞≈û
// =============================================

async function initApp() {
    if (appInitialized) {
        console.log('‚ö†Ô∏è Uygulama zaten ba≈ülatƒ±lmƒ±≈ü, tekrar ba≈ülatƒ±lmƒ±yor.');
        return;
    }
    
    appInitialized = true;
    
    try {
        debugLog('üöÄ === UYGULAMA BA≈ûLATILIYOR ===');
        
        // 1. Temel sistemleri kur
        setupImageErrorHandling();
        setupProductImageFallbacks();
        setupBannerVideo();
        
        // 2. Komut kurallarƒ±nƒ± kontrol et
        await checkAndPopulateCommandRules();
        
        // 3. AI komut sistemini y√ºkle
        await loadCommandRules();
        debugLog('‚úÖ AI komut sistemi y√ºklendi');

        // 4. DOM hazƒ±r olana kadar bekle
        await waitForDOMElements();
        debugLog('‚úÖ DOM hazƒ±r');

        // 5. Yatay kaydƒ±rma sistemlerini ayarla
        setupHorizontalScrolling();
        
        // 6. Konum event'lerini ayarla
        setupLocationEvents();
        
        // 7. Modal kapatma event'lerini ayarla
        setupModalCloseEvents();
        
        // 8. StoreTypes y√ºkle
        await loadStoreTypes();
        debugLog('‚úÖ StoreTypes y√ºklendi');

        // 9. Oturumu geri y√ºkle
        await restoreSession();
        debugLog('‚úÖ Oturum y√ºklendi');

        // 10. Konum y√∂netimi
        initializeLocation();
        debugLog('‚úÖ Konum y√∂netimi tamamlandƒ±');

        // 11. UI elementlerini ayarla
        updateUIAfterLogin();
        debugLog('‚úÖ UI g√ºncellendi');

        // 12. Event handler'larƒ± ayarla
        setupEventHandlers();
        debugLog('‚úÖ Event handlerlar ayarlandƒ±');

        // 13. Sesli √ºr√ºn ekleme sistemini ba≈ülat
        setTimeout(() => {
            debugLog('üé§ Sesli √ºr√ºn ekleme sistemi aktif');
        }, 3000);

        debugLog('üéâ === UYGULAMA BA≈ûLATMA TAMAMLANDI ===');

    } catch (error) {
        console.error('üí• Uygulama ba≈ülatma hatasƒ±:', error);
        emergencyFallback();
    }
}	

// Sepet toggle fonksiyonu - G√úVENLƒ∞
function toggleCart() {
    try {
        if (cartContainer.classList.contains('open')) {
            closeCart();
        } else {
            openCart();
        }
    } catch (error) {
        console.error('‚ùå Sepet toggle hatasƒ±:', error);
    }
}
       
// =============================================
// G√úNCELLENMƒ∞≈û EVENT HANDLER
// =============================================
document.addEventListener('DOMContentLoaded', function() {
    if (domLoaded) return;
    domLoaded = true;

    console.log('üöÄ DOM y√ºklendi, uygulama ba≈ülatƒ±lƒ±yor...');

    // Dil se√ßeneklerini olu≈ütur
    populateLanguageOptions();
    
    // Tarayƒ±cƒ± dilini algƒ±la ve √ßevir
    const browserLang = detectBrowserLanguage();
    translatePage(browserLang);
    
    // Varsayƒ±lan banner'ƒ± y√ºkle
    updateBanner('market');
    
    // Yatay kaydƒ±rma ayarlarƒ±nƒ± yap
    setupHorizontalScrolling();
    
    // √ñrnek verileri y√ºkle
    loadSampleData();
    
    // √ñdeme butonlarƒ±nƒ± g√ºncelle
    updatePaymentButtons();
    
    // Sepet konteynƒ±rƒ±nƒ± g√ºncelle
    updateCartContainer();

    // Dil deƒüi≈ütirme event'leri
    document.getElementById('languageBtn').addEventListener('click', function() {
        document.getElementById('languageDropdown').classList.toggle('show');
    });
    
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.language-selector')) {
            document.getElementById('languageDropdown').classList.remove('show');
        }
        
        if (e.target.closest('.language-option')) {
            const lang = e.target.closest('.language-option').getAttribute('data-lang');
            translatePage(lang);
            document.getElementById('languageDropdown').classList.remove('show');
        }
    });

    // Sepet kontrol√º
    if (cartContainer) {
        setTimeout(() => {
            const hasItems = cart.length > 0 || pendingCart.length > 0;
            if (hasItems) {
                openCart();
                debugLog('üõí Sayfa y√ºklendi - Sepet otomatik a√ßƒ±ldƒ± (√ºr√ºn var)');
            }
        }, 2000);
    }

    // Ana uygulamayƒ± ba≈ülat
    initApp().catch(error => {
        console.error('‚ùå Uygulama ba≈ülatma hatasƒ±:', error);
        emergencyFallback();
    });
});

// =============================================
// 1. B√ñL√úM: LOGIN Gƒ∞Rƒ∞≈û VE KAYIT S√úRECƒ∞
// =============================================

// Kullanƒ±cƒ± oturumunu geri y√ºkle
async function restoreSession() {
    try {
        const savedSession = localStorage.getItem('onurmarket_session');
        if (savedSession) {
            const sessionData = JSON.parse(savedSession);
            const now = new Date().getTime();
            
            // 24 saat i√ßindeki oturumu geri y√ºkle
            if (now - sessionData.timestamp < 24 * 60 * 60 * 1000) {
                currentCustomer = sessionData.customer;
                cart = sessionData.cart || [];
                selectedSellerId = sessionData.selectedSellerId;
                selectedLocation = sessionData.selectedLocation;
                
                updateCustomerUI();
                updateCartUI();
                
                if (currentCustomer) {
                    hideHowItWorksBanner();
                    orderSummary.style.display = 'flex';
                    
                    if (selectedLocation) {
                        updateLocationText();
                    } else {
                        showLocationModal();
                    }
                }
            } else {
                localStorage.removeItem('onurmarket_session');
            }
        }
    } catch (error) {
        console.error('Oturum geri y√ºkleme hatasƒ±:', error);
        localStorage.removeItem('onurmarket_session');
    }
}

// Oturumu kaydet
function saveSession() {
    if (currentCustomer) {
        const sessionData = { 
            customer: currentCustomer, 
            cart: cart, 
            selectedSellerId: selectedSellerId, 
            selectedLocation: selectedLocation, 
            timestamp: new Date().getTime()
        };
        localStorage.setItem('onurmarket_session', JSON.stringify(sessionData));
    }
}


	// Referans kodu i≈üleme
        async function processReferralCode(code, groupCode) {
            try {
                const { data, error } = await supabase
                    .from('referral_links')
                    .select('owner_user_id, referral_code, group_code, is_used')
                    .eq('referral_code', code)
                    .eq('group_code', groupCode)
                    .single();
                
                if (error) throw error;
                
                if (data) {
                    if (data.is_used) {
                        assistantMessage.textContent = "Bu referans linki daha √∂nce kullanƒ±lmƒ±≈ü.";
                        return;
                    }
                    
                    referralGroupCode = data.group_code;
                    // Referans sahibinin bilgilerini al
                    const { data: ownerData } = await supabase
                        .from('profiles')
                        .select('full_name')
                        .eq('id', data.owner_user_id)
                        .single();
                    
                    if (ownerData) {
                        assistantMessage.textContent += ` Referans ile geldiniz: ${ownerData.full_name}`;
                    }
                }
            } catch (error) {
                console.error('Referans kodu i≈üleme hatasƒ±:', error);
            }
        }







// =============================================
// 1. B√ñL√úM EKSƒ∞KLERƒ∞Nƒ∞ TAMAMLAMA - VERƒ∞TABANI BAƒûLANTILARI
// =============================================


// M√º≈üteri kontrol√º - ADRES TEYƒ∞Dƒ∞ EKLENDƒ∞
async function checkCustomerByPhone(phone) {
    try {
        const cleanPhone = phone.replace(/\D/g, '');
        
        const { data, error } = await supabase
            .from('customers')
            .select('*')
            .eq('phone', cleanPhone)
            .maybeSingle();
        
        if (error) {
            console.error('M√º≈üteri sorgulama hatasƒ±:', error);
            throw error;
        }
        
        if (data) {
            // MEVCUT KULLANICI - Konum kar≈üƒ±la≈ütƒ±rmasƒ± yap
            currentCustomer = data;
            
            // Konum tespit edilmi≈üse ve mevcut adresten farklƒ±ysa not d√º≈ü
            if (isLocationDetected && currentCustomer.address) {
                const currentAddress = `${userLocation.district}, ${userLocation.city}`;
                const savedAddress = currentCustomer.address;
                
                if (currentAddress !== savedAddress) {
                    debugLog('üìç Konum farkƒ± tespit edildi:', { current: currentAddress, saved: savedAddress });
                    // Bu bilgiyi sipari≈ü notlarƒ±na ekleyeceƒüiz
                }
            }
            
            updateCustomerUI();
            hideHowItWorksBanner();
            orderSummary.style.display = 'flex';
            
            speakToUser(`Ho≈ü geldiniz ${data.name}! Sisteminiz a√ßƒ±lmƒ±≈ütƒ±r.`);
            conversationStep = 10;
            
            saveSession();
            
            if (!selectedLocation) {
                showLocationModal();
            }
        } else {
            // YENƒ∞ KULLANICI - Adres teyidi yap
            speakToUser("Telefon numaranƒ±z kayƒ±tlƒ± deƒüil. Yeni √ºyelik olu≈üturalƒ±m. L√ºtfen adƒ±nƒ±zƒ± ve soyadƒ±nƒ±zƒ± s√∂yler misiniz?");
            conversationStep = 2;
            
            currentCustomer = { 
                phone: cleanPhone, 
                role: 'customer',
                bonus_amount: 0 
            };
            
            // Konum tespiti yapƒ±lmamƒ±≈üsa yap
            if (!isLocationDetected) {
                speakToUser("Konumunuz belirleniyor...");
                const locationSuccess = await detectUserLocation();
                if (locationSuccess) {
                    // Adres teyidi iste
                    const addressConfirmed = await confirmAddressWithAssistant();
                    if (addressConfirmed) {
                        // Teyit edilen adresi kaydet
                        currentCustomer.address = userLocation.fullAddress;
                        currentCustomer.city = userLocation.city;
                        speakToUser("Harika! ≈ûimdi adƒ±nƒ±zƒ± ve soyadƒ±nƒ±zƒ± s√∂yleyin.");
                    }
                }
            }
        }
        
    } catch (error) {
        console.error('M√º≈üteri kontrol hatasƒ±:', error);
        speakToUser("Sistemde ge√ßici bir sorun olu≈ütu. L√ºtfen daha sonra tekrar deneyiniz.");
    }
}

// Yeni m√º≈üteri kaydƒ± - G√úNCELLENMƒ∞≈û
async function createCustomerProfile(customerData) {
    try {
        const address = userLocation ? userLocation.fullAddress : (customerData.address || 'Adres belirtilmemi≈ü');
        const city = userLocation ? userLocation.city : (customerData.city || '≈ûehir belirtilmemi≈ü');
        
        const { data, error } = await supabase
            .from('customers')
            .insert([{
                name: customerData.name,
                phone: customerData.phone,
                city: city,
                address: address,
                role: 'customer',
                bonus_amount: 0,
                created_at: new Date().toISOString()
            }])
            .select()
            .single();
        
        if (error) throw error;
        
        currentCustomer = data;
        updateCustomerUI();

	// Referans bilgilerini ekle
        if (referralGroupCode) {
            customerData.group_code = referralGroupCode;
        }
        if (referralCode) {
            customerData.referrer_id = await getReferrerId(referralCode);
        }


        // Oturum a√ßƒ±ldƒ±ƒüƒ±nda yapƒ±lacak i≈ülemler
        onUserLoggedIn();

        hideHowItWorksBanner();
        orderSummary.style.display = 'flex';
        
        speakToUser(`Profiliniz olu≈üturuldu! Ho≈ü geldiniz ${customerData.name}.`);
        
        saveSession();
        
        if (!selectedLocation) {
            showLocationModal();
        }
 	// Referans kodu varsa i≈üle
        if (referralCode) {
            await processReferralAfterSignup();
        }
        
    } catch (error) {
        console.error('Profil olu≈üturma hatasƒ±:', error);
        speakToUser("Profil olu≈üturulurken bir hata olu≈ütu. L√ºtfen daha sonra tekrar deneyin.");
    }
}




 // Referans kodundan referrer_id'yi al
        async function getReferrerId(referralCode) {
            try {
                const { data, error } = await supabase
                    .from('referral_links')
                    .select('owner_user_id')
                    .eq('referral_code', referralCode)
                    .single();
                
                if (error) throw error;
                
                return data.owner_user_id;
            } catch (error) {
                console.error('Referrer ID alma hatasƒ±:', error);
                return null;
            }
        }

        // √úyelik sonrasƒ± referans i≈üleme
        async function processReferralAfterSignup() {
            try {
                // Referans linkini kullanƒ±lmƒ±≈ü olarak i≈üaretle
                const { error: updateError } = await supabase
                    .from('referral_links')
                    .update({ is_used: true })
                    .eq('referral_code', referralCode);
                
                if (updateError) throw updateError;
                
                // Referans takip kaydƒ± olu≈ütur
                const { error: trackingError } = await supabase
                    .from('referral_tracking')
                    .insert([
                        {
                            referral_code: referralCode,
                            group_code: referralGroupCode,
                            referrer_user_id: await getReferrerId(referralCode),
                            new_user_id: currentCustomer.id,
                            created_at: new Date().toISOString()
                        }
                    ]);
                
                if (trackingError) throw trackingError;
                
                console.log('Referans kaydƒ± ba≈üarƒ±lƒ±');
                
            } catch (error) {
                console.error('Referans i≈üleme hatasƒ±:', error);
            }
        }

 // √áƒ±kƒ±≈ü i≈ülemi
async function logout() {
    try {
        speakToUser("Oturumunuz kapatƒ±lƒ±yor...");
        
        // G√∂rsel geri bildirim
        showNotification("√áƒ±kƒ±≈ü yapƒ±lƒ±yor...", "info");
        
        setTimeout(() => {
            performLogout();
        }, 1500);
        
    } catch (error) {
        console.error('√áƒ±kƒ±≈ü i≈ülemi sƒ±rasƒ±nda hata:', error);
        performEmergencyLogout();
    }
}

// Asƒ±l √ßƒ±kƒ±≈ü i≈ülemleri
function performLogout() {
    currentCustomer = null;
    cart = [];
    clearUserDataFromStorage();
    updateUIAfterLogout();
    
    speakToUser("Oturumunuz ba≈üarƒ±yla kapatƒ±ldƒ±. Yeni bir alƒ±≈üveri≈üe ba≈ülayabilirsiniz.");
    
    setTimeout(() => {
        window.location.reload();
    }, 2000);
}

// Acil durum √ßƒ±kƒ±≈üƒ±
function performEmergencyLogout() {
    localStorage.clear();
    currentCustomer = null;
    cart = [];
    updateUIAfterLogout();
    speakToUser("Oturumunuz kapatƒ±ldƒ±.");
    
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

// Kullanƒ±cƒ± verilerini temizle
function clearUserDataFromStorage() {
    localStorage.removeItem('onurmarket_session');
    localStorage.removeItem('currentCustomer');
}

// √áƒ±kƒ±≈ü sonrasƒ± UI g√ºncelleme
function updateUIAfterLogout() {
    if (userName) userName.textContent = 'Profilim';
    if (profileName) profileName.textContent = '-';
    if (profilePhone) profilePhone.textContent = '-';
    if (profileCity) profileCity.textContent = '-';
    if (profileAddress) profileAddress.textContent = '-';
    if (profileBonus) profileBonus.textContent = '0 ‚Ç∫';
    if (profileAvatar) profileAvatar.textContent = 'P';
    
    if (orderSummary) orderSummary.style.display = 'none';
    showHowItWorksBanner();
}

// Banner y√∂netimi
function showHowItWorksBanner() {
    const banner = document.getElementById('howItWorks');
    if (banner) banner.style.display = 'block';
    
    // Diƒüer b√∂l√ºmleri gizle
    const sections = ['categoriesSection', 'sellersSection', 'productsSection'];
    sections.forEach(section => {
        const el = document.getElementById(section);
        if (el) el.style.display = 'none';
    });
}

function hideHowItWorksBanner() {
    const banner = document.getElementById('howItWorks');
    if (banner) banner.style.display = 'none';
    
    // Diƒüer b√∂l√ºmleri g√∂ster
    const sections = ['categoriesSection', 'sellersSection'];
    sections.forEach(section => {
        const el = document.getElementById(section);
        if (el) el.style.display = 'block';
    });
}

// Bildirim g√∂ster
function showNotification(message, type = 'info') {
    // Basit bir bildirim sistemi
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background: ${type === 'error' ? '#f44336' : type === 'success' ? '#4CAF50' : '#2196F3'};
        color: white;
        border-radius: 5px;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}


// =============================================
// 2. B√ñL√úM STORE TYPE - MAƒûAZA T√úRLERƒ∞Nƒ∞ Lƒ∞STELE
// =============================================
// Load store types - G√úNCELLENMƒ∞≈û
async function loadStoreTypes() {
    try {
        debugLog('üîß StoreTypes y√ºkleniyor...');
        
        const { data, error, count } = await supabase
            .from('store_type')
            .select('*', { count: 'exact' })
            .eq('status', 'Active')
            .order('sort_code');

        if (error) throw error;

        if (data && data.length > 0) {
            storeTypes = data;
            localStorage.setItem('storeTypes', JSON.stringify(storeTypes));
            debugLog(`‚úÖ StoreTypes sunucudan y√ºklendi: ${data.length} adet`);
            displayStoreTypes(storeTypes);
            return;
        }

        throw new Error('StoreTypes verisi bo≈ü');
        
    } catch (error) {
        console.error('‚ùå StoreTypes y√ºkleme hatasƒ±:', error);
        
        // Cache kontrol√º
        const cached = localStorage.getItem('storeTypes');
        if (cached) {
            try {
                storeTypes = JSON.parse(cached);
                debugLog('‚úÖ StoreTypes cache\'den y√ºklendi');
                displayStoreTypes(storeTypes);
                return;
            } catch (parseError) {
                console.error('‚ùå Cache parse hatasƒ±:', parseError);
            }
        }
        
        // Fallback
        await useFallbackStoreTypes();
    }
}
	
// Store type'larƒ± ekranda g√∂ster - AKI≈û D√úZELTMESƒ∞
function displayStoreTypes(types) {
    const sellerTypeGrid = document.getElementById('sellerTypeGrid');
    if (!sellerTypeGrid) {
        console.error('‚ùå SellerTypeGrid bulunamadƒ±');
        return;
    }
    
    sellerTypeGrid.innerHTML = '';
    
    if (!types || types.length === 0) {
        sellerTypeGrid.innerHTML = `
            <div class="text-center" style="min-width: 100%; padding: 40px; color: #6c757d;">
                <i class="fas fa-store fa-3x mb-3"></i>
                <p>Maƒüaza tipi bulunamadƒ±</p>
            </div>
        `;
        return;
    }
    
    const iconMap = {
        'Market': 'fas fa-store',
        'Restoran': 'fas fa-utensils',
        'Eczane': 'fas fa-prescription-bottle',
        'Fƒ±rƒ±n': 'fas fa-bread-slice',
        'Kafe': 'fas fa-coffee'
    };
    
    types.forEach(type => {
        const typeCard = document.createElement('div');
        typeCard.className = 'seller-type-card';
        typeCard.dataset.typeId = type.id;
        typeCard.dataset.typeName = type.name;
        
        typeCard.innerHTML = `
            <div class="seller-type-icon">
                <i class="${iconMap[type.name] || 'fas fa-store'}"></i>
            </div>
            <div class="seller-type-name">${type.name}</div>
        `;
        
        typeCard.addEventListener('click', () => {
            // T√ºm kartlardan se√ßimi kaldƒ±r
            document.querySelectorAll('.seller-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Bu kartƒ± se√ßili yap
            typeCard.classList.add('selected');
            
            onStoreTypeSelected(type.id, type.name);
        });
        
        sellerTypeGrid.appendChild(typeCard);
    });
    
    // Store type se√ßildiƒüinde diƒüer b√∂l√ºmleri gizle
    if (sellersSection) sellersSection.style.display = 'none';
    if (categoriesSection) categoriesSection.style.display = 'none';
    if (productsSection) productsSection.style.display = 'none';
    
    debugLog("‚úÖ Store type'lar ba≈üarƒ±yla y√ºklendi");
}

// Store type se√ßildiƒüinde - KATEGORƒ∞ ve √úR√úNLERƒ∞ SIFIRLA
async function onStoreTypeSelected(storeTypeId, storeTypeName) {
    debugLog("üõçÔ∏è Store type se√ßildi:", storeTypeName, "ID:", storeTypeId);
   
    currentRoot = "2:0"; // Maƒüaza tipi se√ßildi, satƒ±cƒ± se√ßimine ge√ß
    // Store type bilgisini kaydet
    selectedStoreTypeId = storeTypeId;
    selectedStoreTypeName = storeTypeName;
    
    // Satƒ±cƒ±larƒ± store type'a g√∂re filtrele
    filterSellersByStoreType(storeTypeId);
    
    // Kategorileri ve √ºr√ºnleri sƒ±fƒ±rla
    selectedCategoryId = null;
    products = [];
    
    // Kategori grid'ini temizle
    if (categoriesGrid) {
        categoriesGrid.innerHTML = '<div class="text-center">Y√ºkleniyor...</div>';
    }
    
    // √úr√ºnler grid'ini temizle
    if (productsGrid) {
        productsGrid.innerHTML = '<div class="text-center">Bir reyon se√ßin</div>';
    }
    
    // √úr√ºnler b√∂l√ºm√ºn√º gizle
    if (productsSection) productsSection.style.display = 'none';
    
    debugLog(`‚úÖ Satƒ±cƒ±lar filtrelendi: ${storeTypeName}`);
    speakToUser(`${storeTypeName} se√ßildi. ${filteredSellers.length} satƒ±cƒ± bulundu.`);
}

// Satƒ±cƒ±larƒ± store type'a g√∂re filtrele
function filterSellersByStoreType(storeTypeId) {
    if (!allSellersInLocation || allSellersInLocation.length === 0) {
        debugLog('‚ö†Ô∏è Filtrelenecek satƒ±cƒ± yok');
        filteredSellers = [];
        updateSellersGrid();
        return;
    }
    
    // Store type'a g√∂re filtrele
    filteredSellers = allSellersInLocation.filter(seller => seller.store_type_id === storeTypeId);
    
    // Global sellers deƒüi≈ükenini g√ºncelle
    sellers = filteredSellers;
    
    debugLog(`üìä Store type filtresi: ${filteredSellers.length} satƒ±cƒ±`);
    
    // Filtrelenmi≈ü satƒ±cƒ±larƒ± g√∂ster
    updateSellersGrid();
    
    // Eƒüer filtrelenmi≈ü satƒ±cƒ± yoksa uyarƒ± ver
    if (filteredSellers.length === 0) {
        speakToUser(`Bu kategoride satƒ±cƒ± bulunamadƒ±. L√ºtfen ba≈üka bir kategori se√ßin.`);
    }
}



// Store type se√ßimini sƒ±fƒ±rla - T√úM SATICILARI G√ñSTER
function resetStoreTypeSelection() {
    // T√ºm store type kartlarƒ±ndaki se√ßimi kaldƒ±r
    document.querySelectorAll('.seller-type-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Global state'i sƒ±fƒ±rla
    selectedStoreTypeId = null;
    selectedStoreTypeName = null;
    
    // T√ºm satƒ±cƒ±larƒ± g√∂ster
    sellers = allSellersInLocation;
    filteredSellers = [...allSellersInLocation];
    
    debugLog('üîÑ Store type se√ßimi sƒ±fƒ±rlandƒ±, t√ºm satƒ±cƒ±lar g√∂steriliyor');
}

// Konum se√ßildikten sonra store type i≈ülemini devam ettir - AKI≈û D√úZELTMESƒ∞
async function proceedWithStoreTypeSelection(storeTypeId, storeTypeName) {
    // √ñnceki se√ßimleri temizle
    selectedSellerId = null;
    selectedCategoryId = null;
    products = [];
    
    // UI durumunu sƒ±fƒ±rla
    resetSections();
    
    try {
        // SADECE SATICILARI Y√úKLE - Reyonlarƒ± hen√ºz y√ºkleme
        await loadSellersByStoreType(storeTypeId);
        
        // Sadece satƒ±cƒ±lar b√∂l√ºm√ºn√º g√∂ster
        if (sellersSection) sellersSection.style.display = 'block';
        if (categoriesSection) categoriesSection.style.display = 'none'; // Reyonlarƒ± gizle
        if (productsSection) productsSection.style.display = 'none'; // √úr√ºnleri gizle
        
        debugLog(`‚úÖ ${storeTypeName} i√ßin satƒ±cƒ±lar y√ºklendi`);
        speakToUser(`${storeTypeName} se√ßildi. Size en yakƒ±n ${storeTypeName.toLowerCase()}lar listeleniyor. L√ºtfen bir satƒ±cƒ± se√ßin.`);
        
    } catch (error) {
        console.error('‚ùå Store type se√ßiminde hata:', error);
        speakToUser("Maƒüaza y√ºklenirken bir hata olu≈ütu. L√ºtfen tekrar deneyin.");
    }
}

// B√∂l√ºmleri sƒ±fƒ±rla - AKI≈û D√úZELTMESƒ∞
function resetSections() {
    // T√ºm se√ßimleri temizle
    document.querySelectorAll('.seller-type-card, .seller-card, .category-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Grid i√ßeriklerini sƒ±fƒ±rla
    if (sellerGrid) {
        sellerGrid.innerHTML = '<div class="text-center">Y√ºkleniyor...</div>';
    }
    if (categoriesGrid) {
        categoriesGrid.innerHTML = '<div class="text-center">Y√ºkleniyor...</div>';
    }
    if (productsGrid) {
        productsGrid.innerHTML = '<div class="text-center">Bir reyon se√ßin</div>';
    }
    
    // B√∂l√ºm g√∂r√ºn√ºrl√ºƒü√ºn√º ayarla
    if (sellersSection) sellersSection.style.display = 'none';
    if (categoriesSection) categoriesSection.style.display = 'none';
    if (productsSection) productsSection.style.display = 'none';
    
    if (selectedSellerInfo) {
        selectedSellerInfo.textContent = 'Satƒ±cƒ± se√ßilmedi';
    }
}
// =============================================
// 2. B√ñL√úM: REYONLARIN, SATICILARIN Y√úKLENMESƒ∞
// =============================================
// Satƒ±cƒ±ya g√∂re reyonlarƒ± y√ºkle - D√úZELTƒ∞LMƒ∞≈û
async function loadReyonsBySeller(sellerId) {
    try {
        debugLog(`üì¶ Satƒ±cƒ±ya g√∂re reyonlar y√ºkleniyor: ${sellerId}`);
        
        // Doƒüru SQL sorgusu - birle≈ütirilmi≈ü tablolar
        const { data, error } = await supabase
            .from('reyon')
            .select(`
                *,
                products!inner(
                    id,
                    product_prices!inner(
                        seller_id
                    )
                )
            `)
            .eq('products.product_prices.seller_id', sellerId)
            .order('name');

        if (error) {
            console.error('‚ùå Reyon y√ºkleme hatasƒ±:', error);
            debugLog(`‚ùå SQL HATASI: ${error.message}`);
            throw error;
        }

        debugLog(`üìä REYON SONU√á: ${data?.length || 0} reyon bulundu`);
        
        // Benzersiz reyonlarƒ± al (eƒüer aynƒ± reyon birden fazla √ºr√ºnde varsa)
        const uniqueReyons = [];
        const seenReyons = new Set();
        
        data.forEach(reyon => {
            if (!seenReyons.has(reyon.id)) {
                seenReyons.add(reyon.id);
                uniqueReyons.push(reyon);
            }
        });

        categories = uniqueReyons;
        displayCategories(categories, 'reyon');
        
        debugLog(`‚úÖ Satƒ±cƒ± reyonlarƒ± y√ºklendi: ${categories.length} adet`);
        
        if (categories.length === 0) {
            speakToUser("Bu satƒ±cƒ±da reyon bulunamadƒ±.");
        } else {
            speakToUser(`${categories.length} reyon bulundu. Bir reyon se√ßin.`);
        }

    } catch (error) {
        console.error('‚ùå Reyon y√ºkleme hatasƒ±:', error);
        debugLog('üîÑ Hata olu≈ütu, demo reyonlar kullanƒ±lƒ±yor');
        categories = getDemoReyons();
        displayCategories(categories, 'reyon');
        speakToUser("Reyonlar y√ºklenirken hata olu≈ütu. Demo reyonlar g√∂steriliyor.");
    }
}

// Demo reyonlar (yedek)
function getDemoReyons() {
    return [
        { id: 1, name: 'Meyve & Sebze', store_type_id: 1 },
        { id: 2, name: 'S√ºt √úr√ºnleri', store_type_id: 1 },
        { id: 3, name: 'Et & Tavuk', store_type_id: 1 },
        { id: 4, name: 'Temel Gƒ±da', store_type_id: 1 }
    ];
}



// Kategorileri g√∂ster - √úR√úN Y√úKLEME D√úZELTMESƒ∞
function displayCategories(categoriesToShow, type) {
    const categoriesGrid = document.getElementById('categoriesGrid');
    if (!categoriesGrid) return;
    
    categoriesGrid.innerHTML = '';
    
    if (categoriesToShow.length === 0) {
        categoriesGrid.innerHTML = `
            <div class="text-center" style="min-width: 100%; padding: 40px; color: #6c757d;">
                <i class="fas fa-box-open fa-3x mb-3"></i>
                <p>Kategori bulunamadƒ±</p>
            </div>
        `;
        return;
    }
    
    const iconMap = {
        'Meyve & Sebze': 'fas fa-apple-alt',
        'S√ºt √úr√ºnleri': 'fas fa-cheese',
        'Et & Tavuk': 'fas fa-drumstick-bite',
        'Temel Gƒ±da': 'fas fa-wheat-alt',
        'ƒ∞√ßecekler': 'fas fa-wine-bottle',
        'Ana Yemekler': 'fas fa-utensils',
        '√áorbalar': 'fas fa-bowl-food',
        'Salatalar': 'fas fa-leaf',
        'Tatlƒ±lar': 'fas fa-ice-cream',
        'Aƒürƒ± Kesiciler': 'fas fa-pills',
        'Vitaminler': 'fas fa-capsules',
        'Ekmekler': 'fas fa-bread-slice',
        'Pastalar': 'fas fa-birthday-cake'
    };
    
    categoriesToShow.forEach(category => {
        const categoryCard = document.createElement('div');
        categoryCard.className = 'category-card';
        categoryCard.dataset.categoryId = category.id;
        categoryCard.dataset.categoryName = category.name;
        
        categoryCard.innerHTML = `
            <div class="category-icon">
                <i class="${iconMap[category.name] || 'fas fa-box'}"></i>
            </div>
            <div class="category-name">${category.name}</div>
        `;
        
        categoryCard.addEventListener('click', async function() {
            if (!selectedSellerId) {
                speakToUser("√ñnce bir satƒ±cƒ± se√ßmelisiniz.");
                return;
            }
            
            // T√ºm kartlardan se√ßimi kaldƒ±r
            document.querySelectorAll('.category-card').forEach(c => {
                c.classList.remove('selected');
            });
            
            // Bu kartƒ± se√ßili yap
            this.classList.add('selected');
            
            selectedCategoryId = category.id;
            
            // REYON SE√áƒ∞LDƒ∞ƒûƒ∞NDE √úR√úNLERƒ∞ Y√úKLE
            await loadProductsByReyon(category.id);
            
            debugLog(`üõí Reyon se√ßildi: ${category.name}`);
            speakToUser(`${category.name} reyonundaki √ºr√ºnler listeleniyor.`);
        });
        
        categoriesGrid.appendChild(categoryCard);
    });
}

// Reyon se√ßildiƒüinde √ºr√ºnleri y√ºkle - SORGU D√úZELTƒ∞LMƒ∞≈û
async function loadProductsByReyon(reyonId) {
    try {
        debugLog(`üõí Reyona g√∂re √ºr√ºnler y√ºkleniyor: ${reyonId}, Satƒ±cƒ±: ${selectedSellerId}`);
        
        if (!selectedSellerId) {
            speakToUser("√ñnce bir satƒ±cƒ± se√ßmelisiniz.");
            return;
        }
        
        debugLog(`üîç SQL SORGUSU: seller_id='${selectedSellerId}' AND reyon_id='${reyonId}'`);
        
        const { data, error } = await supabase
            .from('product_prices')
            .select(`
                *,
                products!inner(
                    id, name, imgurl, reyon_id, category_id, is_active, description, unit_type
                )
            `)
            .eq('seller_id', selectedSellerId)
            .eq('products.reyon_id', reyonId)
            .eq('products.is_active', true);
            

        if (error) {
            console.error('‚ùå √úr√ºn y√ºkleme hatasƒ±:', error);
            debugLog(`‚ùå SQL HATASI: ${error.message}`);
            throw error;
        }

        debugLog(`üìä √úR√úN SONU√á: ${data?.length || 0} √ºr√ºn bulundu`);

        // Veriyi i≈üle
        products = data
            .filter(item => item.products)
            .map(item => ({
                id: item.products.id,
                product_price_id: item.id,
                name: item.products.name,
                price: item.price,
                discount_price: item.discount_price,
                imgurl: item.products.imgurl,
                reyon_id: item.products.reyon_id,
                category_id: item.products.category_id,
                seller_id: selectedSellerId,
                description: item.products.description,
                unit_type: item.products.unit_type
            }));

        debugLog(`‚úÖ √úr√ºnler y√ºklendi: ${products.length} adet`);
        
        // √úr√ºnleri g√∂ster
        displayProducts(products);
        
        // √úr√ºnler b√∂l√ºm√ºn√º g√∂ster, reyonlarƒ± gizle
        if (productsSection) productsSection.style.display = 'block';
        if (categoriesSection) categoriesSection.style.display = 'none';
        
        if (products.length === 0) {
            speakToUser("Bu reyonda √ºr√ºn bulunamadƒ±.");
        } else {
            speakToUser(`${products.length} √ºr√ºn bulundu.`);
        }

    } catch (error) {
        console.error('‚ùå √úr√ºn y√ºkleme hatasƒ±:', error);
        debugLog('üîÑ Hata olu≈ütu, demo √ºr√ºnler kullanƒ±lƒ±yor');
        products = getDemoProducts();
        displayProducts(products);
        speakToUser("√úr√ºnler y√ºklenirken hata olu≈ütu. Demo √ºr√ºnler g√∂steriliyor.");
    }
}

// Satƒ±cƒ± y√ºkleme fonksiyonunu g√ºncelle - ILIKE SORGUSU
async function loadSellersByStoreType(storeTypeId) {
    try {
        debugLog(`üîç Satƒ±cƒ±lar y√ºkleniyor: ${storeTypeId}`);
        
        let query = supabase
            .from('seller_profiles')
            .select('*')
            .eq('status', 'True')
            .eq('store_type_id', storeTypeId);

        // Konum bilgisi varsa, ILIKE sorgusu ile filtrele
        if (userLocation.city) {
            const customerCity = userLocation.city;
            const customerDistrict = userLocation.district;
            
            debugLog(`üìç ILIKE sorgusu: city=%${customerCity}%, district=%${customerDistrict}%`);
            
            // ILIKE ile esnek arama
            query = query.or(`city.ilike.%${customerCity}%,district.ilike.%${customerDistrict}%,address.ilike.%${customerCity}%`);
        }

        const { data, error } = await query.order('business_name');

        if (error) {
            console.error('‚ùå Satƒ±cƒ± y√ºkleme hatasƒ±:', error);
            throw error;
        }

        debugLog(`üìä Konuma uygun satƒ±cƒ±lar: ${data?.length || 0} adet`);

        if (data && data.length > 0) {
            sellers = data;
            
            // Teslimat bilgilerini ekle
            await addDeliveryInfoToSellers(sellers);
            
            debugLog(`‚úÖ Satƒ±cƒ±lar y√ºklendi: ${sellers.length} adet`);
            
            if (userLocation.city) {
                speakToUser(`${sellers.length} satƒ±cƒ± bulundu. Konumunuz: ${userLocation.district}, ${userLocation.city}`);
            } else {
                speakToUser(`${sellers.length} satƒ±cƒ± bulundu.`);
            }
            
            updateSellersGrid();
            
        } else {
            debugLog('‚ö†Ô∏è Bu kategoride ve konumda satƒ±cƒ± bulunamadƒ±');
            sellers = [];
            updateSellersGrid();
            
            if (userLocation.city) {
                speakToUser(`Bu kategoride ${userLocation.district}, ${userLocation.city} konumunda satƒ±cƒ± bulunamadƒ±. L√ºtfen ba≈üka bir kategori se√ßin.`);
            } else {
                speakToUser("Bu kategoride satƒ±cƒ± bulunamadƒ±. L√ºtfen ba≈üka bir kategori se√ßin.");
            }
        }

    } catch (error) {
        console.error('‚ùå Satƒ±cƒ± y√ºkleme hatasƒ±:', error);
        debugLog('üîÑ Hata olu≈ütu, demo satƒ±cƒ±lar kullanƒ±lƒ±yor');
        sellers = getDemoSellers();
        updateSellersGrid();
        speakToUser("Satƒ±cƒ±lar y√ºklenirken hata olu≈ütu. Demo satƒ±cƒ±lar g√∂steriliyor.");
    }
}

// Konuma g√∂re t√ºm satƒ±cƒ±larƒ± y√ºkle (store type filtresi OLMADAN)
async function loadAllSellersByLocation() {
    try {
        debugLog(`üîç Konumdaki t√ºm satƒ±cƒ±lar y√ºkleniyor: ${userLocation.district}, ${userLocation.city}`);
        
        let query = supabase
            .from('seller_profiles')
            .select('*')
            .eq('status', 'True');

        // Konum bilgisi varsa, ILIKE sorgusu ile filtrele
        if (userLocation.city && userLocation.district) {
            const customerCity = userLocation.city;
            const customerDistrict = userLocation.district;
            
            debugLog(`üìç T√úM SATICILAR - ILIKE sorgusu: city=%${customerCity}%, district=%${customerDistrict}%`);
            
            // ILIKE ile esnek arama - city, district ve address alanlarƒ±nda
            query = query.or(`city.ilike.%${customerCity}%,district.ilike.%${customerDistrict}%,address.ilike.%${customerCity}%,address.ilike.%${customerDistrict}%`);
        }

        const { data, error } = await query.order('business_name');

        if (error) {
            console.error('‚ùå T√ºm satƒ±cƒ±lar y√ºkleme hatasƒ±:', error);
            throw error;
        }

        debugLog(`üìä Konumdaki t√ºm satƒ±cƒ±lar: ${data?.length || 0} adet`);

        if (data && data.length > 0) {
            allSellersInLocation = data;
            
            // Teslimat bilgilerini ekle
            await addDeliveryInfoToSellers(allSellersInLocation);
            
            debugLog(`‚úÖ T√ºm satƒ±cƒ±lar y√ºklendi: ${allSellersInLocation.length} adet`);
            
            // T√ºm satƒ±cƒ±larƒ± g√∂ster (hen√ºz store type filtresi yok)
            showAllSellers();
            
            speakToUser(`Konumunuzda ${allSellersInLocation.length} satƒ±cƒ± bulundu. Hangi kategoriyi se√ßmek istersiniz?`);
            
        } else {
            debugLog('‚ö†Ô∏è Bu konumda satƒ±cƒ± bulunamadƒ±');
            allSellersInLocation = [];
            showAllSellers();
            speakToUser("Bu konumda satƒ±cƒ± bulunamadƒ±. L√ºtfen konumunuzu deƒüi≈ütirin.");
        }

    } catch (error) {
        console.error('‚ùå T√ºm satƒ±cƒ±lar y√ºkleme hatasƒ±:', error);
        debugLog('üîÑ Hata olu≈ütu, demo satƒ±cƒ±lar kullanƒ±lƒ±yor');
        allSellersInLocation = getDemoSellers();
        showAllSellers();
        speakToUser("Satƒ±cƒ±lar y√ºklenirken hata olu≈ütu. Demo satƒ±cƒ±lar g√∂steriliyor.");
    }
}

// T√ºm satƒ±cƒ±larƒ± g√∂ster (store type filtresi olmadan)
function showAllSellers() {
    // Global sellers deƒüi≈ükenini g√ºncelle
    sellers = allSellersInLocation;
    filteredSellers = [...allSellersInLocation];
    
    // UI'ƒ± g√ºncelle
    updateSellersGrid();
    
    // B√∂l√ºmleri g√∂ster
    if (sellersSection) sellersSection.style.display = 'block';
    if (categoriesSection) categoriesSection.style.display = 'none';
    if (productsSection) productsSection.style.display = 'none';
    
    // Store type se√ßimini sƒ±fƒ±rla
    resetStoreTypeSelection();
    
    debugLog(`‚úÖ T√ºm satƒ±cƒ±lar g√∂steriliyor: ${sellers.length} adet`);
}

// Satƒ±cƒ±larƒ± mesafeye g√∂re filtrele
async function filterSellersByDistance(allSellers) {
    if (!userLocation.city || !userLocation.district) {
        debugLog('‚ö†Ô∏è Konum bilgisi eksik, t√ºm satƒ±cƒ±lar g√∂steriliyor');
        return allSellers;
    }
    
    const filteredSellers = [];
    
    for (const seller of allSellers) {
        const isWithinRange = await checkSellerDeliveryRange(seller);
        if (isWithinRange) {
            filteredSellers.push(seller);
        }
    }
    
    return filteredSellers;
}

// Satƒ±cƒ±larƒ± konuma g√∂re filtrele - ILIKE SORGUSU
async function filterSellersByLocation(allSellers) {
    if (!userLocation.city || !userLocation.district) {
        debugLog('‚ö†Ô∏è Konum bilgisi eksik, t√ºm satƒ±cƒ±lar g√∂steriliyor');
        return allSellers;
    }
    
    const filteredSellers = [];
    const userCity = userLocation.city.toLowerCase();
    const userDistrict = userLocation.district.toLowerCase();
    
    debugLog(`üìç ILIKE filtreleme: ${userDistrict}, ${userCity}`);
    
    for (const seller of allSellers) {
        const sellerCity = (seller.city || '').toLowerCase();
        const sellerDistrict = (seller.district || '').toLowerCase();
        const sellerAddress = (seller.address || '').toLowerCase();
        
        // ILIKE benzeri esnek e≈üle≈üme
        const cityMatch = sellerCity.includes(userCity) || userCity.includes(sellerCity);
        const districtMatch = sellerDistrict.includes(userDistrict) || userDistrict.includes(sellerDistrict);
        const addressMatch = sellerAddress.includes(userCity) || sellerAddress.includes(userDistrict);
        
        if (cityMatch || districtMatch || addressMatch) {
            filteredSellers.push(seller);
            debugLog(`‚úÖ ILIKE e≈üle≈üme: ${seller.business_name} - ${sellerDistrict}, ${sellerCity}`);
        } else {
            debugLog(`‚ùå ILIKE e≈üle≈ümedi: ${seller.business_name} - ${sellerDistrict}, ${sellerCity}`);
        }
    }
    
    return filteredSellers;
}


// Satƒ±cƒ±lara teslimat bilgisi ekle - ILIKE UYUMLU
async function addDeliveryInfoToSellers(sellers) {
    if (!sellers || sellers.length === 0) return;
    
    debugLog(`üìç Teslimat bilgileri ekleniyor: ${sellers.length} satƒ±cƒ±`);
    
    for (const seller of sellers) {
        try {
            // Satƒ±cƒ±nƒ±n teslimat b√∂lgelerini getir
            const { data: deliveryAreas, error } = await supabase
                .from('seller_delivery_areas')
                .select('city, district, delivery_fee, min_order_amount')
                .eq('seller_id', seller.id)
                .eq('is_active', true);

            if (error) {
                console.error(`Teslimat bilgisi alma hatasƒ± (${seller.business_name}):`, error);
                continue;
            }

            // Teslimat b√∂lgesi yoksa varsayƒ±lan deƒüerler
            if (!deliveryAreas || deliveryAreas.length === 0) {
                seller.delivery_fee = 0;
                seller.min_order_amount = 0;
                seller.delivery_available = true;
                continue;
            }

            // ILIKE benzeri esnek e≈üle≈üme
            const matchedArea = deliveryAreas.find(area => {
                const areaCity = (area.city || '').toLowerCase();
                const areaDistrict = (area.district || '').toLowerCase();
                const userCity = (userLocation.city || '').toLowerCase();
                const userDistrict = (userLocation.district || '').toLowerCase();
                
                const cityMatch = areaCity.includes(userCity) || userCity.includes(areaCity);
                const districtMatch = areaDistrict.includes(userDistrict) || userDistrict.includes(areaDistrict);
                
                return cityMatch && districtMatch;
            });

            if (matchedArea) {
                seller.delivery_fee = matchedArea.delivery_fee || 0;
                seller.min_order_amount = matchedArea.min_order_amount || 0;
                seller.delivery_available = true;
            } else {
                seller.delivery_fee = null;
                seller.min_order_amount = null;
                seller.delivery_available = false;
            }

        } catch (error) {
            console.error(`Teslimat bilgisi ekleme hatasƒ± (${seller.business_name}):`, error);
            seller.delivery_fee = 0;
            seller.min_order_amount = 0;
            seller.delivery_available = true;
        }
    }
}

// Satƒ±cƒ±nƒ±n teslimat b√∂lgesini kontrol et - ESNEK E≈ûLE≈ûTƒ∞RME
async function checkSellerDeliveryRange(seller) {
    try {
        // Satƒ±cƒ±nƒ±n teslimat b√∂lgelerini getir
        const { data: deliveryAreas, error } = await supabase
            .from('seller_delivery_areas')
            .select('city, district, delivery_fee, min_order_amount')
            .eq('seller_id', seller.id)
            .eq('is_active', true);

        if (error) throw error;

        // Eƒüer satƒ±cƒ±nƒ±n teslimat b√∂lgesi tanƒ±mlƒ± deƒüilse, t√ºm b√∂lgelere teslimat yapƒ±yor kabul et
        if (!deliveryAreas || deliveryAreas.length === 0) {
            debugLog(`‚úÖ ${seller.business_name} - Teslimat b√∂lgesi tanƒ±mlƒ± deƒüil, t√ºm b√∂lgelere teslimat`);
            return true;
        }

        // Kullanƒ±cƒ±nƒ±n konumunu satƒ±cƒ±nƒ±n teslimat b√∂lgeleriyle kar≈üƒ±la≈ütƒ±r - ESNEK
        const matchedArea = deliveryAreas.find(area => {
            const areaCity = (area.city || '').toLowerCase().trim();
            const areaDistrict = (area.district || '').toLowerCase().trim();
            const userCity = (userLocation.city || '').toLowerCase().trim();
            const userDistrict = (userLocation.district || '').toLowerCase().trim();
            
            const cityMatch = areaCity && userCity && (
                areaCity.includes(userCity) || 
                userCity.includes(areaCity) ||
                areaCity === userCity
            );
            
            const districtMatch = areaDistrict && userDistrict && (
                areaDistrict.includes(userDistrict) ||
                userDistrict.includes(areaDistrict) ||
                areaDistrict === userDistrict
            );
            
            return cityMatch && districtMatch;
        });

        if (matchedArea) {
            debugLog(`‚úÖ ${seller.business_name} - Teslimat b√∂lgesi uygun: ${userLocation.district}, ${userLocation.city}`);
            
            // Teslimat √ºcreti ve min. sipari≈ü tutarƒ±nƒ± satƒ±cƒ± nesnesine ekle
            seller.delivery_fee = matchedArea.delivery_fee || 0;
            seller.min_order_amount = matchedArea.min_order_amount || 0;
            
            return true;
        } else {
            debugLog(`‚ùå ${seller.business_name} - Teslimat b√∂lgesi dƒ±≈üƒ±nda: ${userLocation.district}, ${userLocation.city}`);
            return false;
        }

    } catch (error) {
        console.error('Teslimat b√∂lgesi kontrol hatasƒ±:', error);
        // Hata durumunda teslimat yapƒ±yor kabul et
        return true;
    }
}

// Konum bilgilerini debug et - ILIKE SORGUSU
function debugLocationInfo() {
    debugLog('üìç KONUM Bƒ∞LGƒ∞LERƒ∞:');
    debugLog(`- ≈ûehir: "${userLocation.city}"`);
    debugLog(`- ƒ∞l√ße: "${userLocation.district}"`);
    debugLog(`- Adres: "${userLocation.address}"`);
    
    if (userLocation.city) {
        debugLog(`üìã ILIKE SORGUSU: city.ilike.%${userLocation.city}%, district.ilike.%${userLocation.district}%, address.ilike.%${userLocation.city}%`);
    }
}

// ƒ∞lk satƒ±cƒ±yƒ± otomatik se√ß
function selectFirstSeller(sellerId) {
    const sellerCard = document.querySelector(`[data-seller-id="${sellerId}"]`);
    if (sellerCard) {
        sellerCard.click();
        debugLog(`‚úÖ ƒ∞lk satƒ±cƒ± otomatik se√ßildi: ${sellerId}`);
    }
}
	
// T√ºm store type'larƒ± se√ßilebilir yap
function enableAllStoreTypes() {
    const storeTypeCards = document.querySelectorAll('.seller-type-card');
    storeTypeCards.forEach(card => {
        card.style.opacity = '1';
        card.style.cursor = 'pointer';
        card.style.pointerEvents = 'auto';
    });
}

// Konum se√ßildiƒüinde UI'ƒ± g√ºncelle
function updateUIAfterLocationSelection() {
    // Store type b√∂l√ºm√ºn√º g√∂ster
    const storeTypeSection = document.querySelector('section:has(.seller-type-container)');
    if (storeTypeSection) storeTypeSection.style.display = 'block';
    
    // Satƒ±cƒ±lar b√∂l√ºm√ºn√º g√∂ster
    if (sellersSection) sellersSection.style.display = 'block';
    
    // How it works banner'ƒ±nƒ± gizle
    if (howItWorks) howItWorks.style.display = 'none';
    
    // T√ºm store type'larƒ± aktif yap
    enableAllStoreTypes();
}

// Store type ID'sinden ismini al
function getStoreTypeName(storeTypeId) {
    if (!storeTypes || storeTypes.length === 0) return '';
    const storeType = storeTypes.find(type => type.id === storeTypeId);
    return storeType ? storeType.name : '';
}

// Satƒ±cƒ± grid'ini g√ºncelle - Fƒ∞LTRELENMƒ∞≈û SATICILARI G√ñSTER
function updateSellersGrid() {
    const sellerGrid = document.getElementById('sellerGrid');
    if (!sellerGrid) return;
    
    sellerGrid.innerHTML = '';
    
    const sellersToShow = sellers; // Global sellers deƒüi≈ükenini kullan
    
    if (sellersToShow.length === 0) {
        sellerGrid.innerHTML = `
            <div class="text-center" style="min-width: 100%; padding: 40px; color: #6c757d;">
                <i class="fas fa-store fa-3x mb-3"></i>
                <p>Bu konumda satƒ±cƒ± bulunamadƒ±</p>
                <small>L√ºtfen konumunuzu deƒüi≈ütirin veya ba≈üka bir kategori se√ßin</small>
            </div>
        `;
        return;
    }
    
    debugLog(`üîÑ Satƒ±cƒ± grid g√ºncelleniyor: ${sellersToShow.length} satƒ±cƒ±`);
    
    sellersToShow.forEach(seller => {
        const sellerCard = document.createElement('div');
        sellerCard.className = 'seller-card';
        sellerCard.dataset.sellerId = seller.id;
        
        if (selectedSellerId === seller.id) {
            sellerCard.classList.add('selected');
        }
        if (isSellerLocked && selectedSellerId !== seller.id) {
            sellerCard.classList.add('disabled');
        }
        
        // Store type bilgisini ekle (debug i√ßin)
        const storeTypeInfo = selectedStoreTypeId ? 
            '' : 
            `<small style="color: var(--gray); display: block; margin-top: 5px;">${getStoreTypeName(seller.store_type_id)}</small>`;
        
        // Teslimat bilgilerini hazƒ±rla
        let deliveryInfo = '';
        if (selectedLocation === 'delivery') {
            if (seller.delivery_available === false) {
                deliveryInfo = `<div class="delivery-fee" style="color: #dc3545;"><i class="fas fa-times-circle"></i> Bu Konuma Teslimat Yok</div>`;
            } else if (seller.delivery_fee > 0) {
                deliveryInfo = `<div class="delivery-fee"><i class="fas fa-motorcycle"></i> Teslimat: ${money(seller.delivery_fee)}</div>`;
            } else if (seller.delivery_fee === 0) {
                deliveryInfo = `<div class="delivery-fee free"><i class="fas fa-motorcycle"></i> √úcretsiz Teslimat</div>`;
            } else {
                deliveryInfo = `<div class="delivery-fee"><i class="fas fa-motorcycle"></i> Teslimat Bilgisi Yok</div>`;
            }
            
            if (seller.min_order_amount > 0) {
                deliveryInfo += `<div class="min-order">Min. Sipari≈ü: ${money(seller.min_order_amount)}</div>`;
            }
        } else {
            // Restoran i√ßi veya paket serviste teslimat bilgisi gerekmez
            deliveryInfo = `<div class="delivery-fee"><i class="fas fa-check-circle"></i> ${selectedLocation === 'inside' ? 'Restoran ƒ∞√ßi' : 'Paket Servis'}</div>`;
        }
        
        sellerCard.innerHTML = `
            <div class="seller-image-container">
                <img src="${seller.imgurl || getDefaultSellerImage(seller)}" 
                     alt="${seller.business_name || seller.full_name}" 
                     class="seller-image"
                     onerror="this.src='${getDefaultSellerImage(seller)}'; this.onerror=null;">
            </div>
            <div class="seller-info">
                <div class="seller-name">${seller.business_name || seller.full_name}</div>
                <div class="seller-details">
                    <span><i class="fas fa-map-marker-alt"></i> ${seller.district || ''}, ${seller.city || '≈ûehir belirtilmemi≈ü'}</span>
                    <span><i class="fas fa-star" style="color: gold;"></i> ${seller.rating || '4.5'}</span>
                </div>
                ${storeTypeInfo}
                ${deliveryInfo ? `<div class="delivery-info">${deliveryInfo}</div>` : ''}
            </div>
        `;
        
        sellerCard.addEventListener('click', () => {
            if (isSellerLocked && selectedSellerId !== seller.id) {
                speakToUser("√ñnce sepetinizi bo≈üaltmalƒ±sƒ±nƒ±z farklƒ± bir satƒ±cƒ± se√ßmek i√ßin.");
                return;
            }
            
            // Teslimat yoksa ve adrese teslim se√ßilmi≈üse uyarƒ± ver
            if (selectedLocation === 'delivery' && seller.delivery_available === false) {
                speakToUser("Bu satƒ±cƒ± konumunuza teslimat yapmƒ±yor. L√ºtfen ba≈üka bir satƒ±cƒ± se√ßin veya paket servis se√ßeneƒüini kullanƒ±n.");
                return;
            }
            
            selectSeller(seller);
        });
        
        sellerGrid.appendChild(sellerCard);
    });
}
// Varsayƒ±lan resim fonksiyonu ekleyin:
function getDefaultSellerImage(seller) {
    const sellerName = seller.business_name || seller.full_name || 'Satƒ±cƒ±';
    // Base64 encoded basit bir placeholder
    return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGVlMmYzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY3Njc2NyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPlNhdMSxY8SxPC90ZXh0Pjwvc3ZnPg==';
}

// Satƒ±cƒ± se√ß - G√úNCELLENMƒ∞≈û
async function selectSeller(seller) {
    debugLog(`üéØ Satƒ±cƒ± se√ßiliyor: ${seller.business_name || seller.full_name}`);
    
    // Teslimat kontrol√º
    if (selectedLocation === 'delivery' && seller.delivery_available === false) {
        const confirmSelection = confirm("Bu satƒ±cƒ± konumunuza teslimat yapmƒ±yor. Yine de se√ßmek istiyor musunuz?");
        if (!confirmSelection) {
            return;
        }
    }
    
    // √ñnceki se√ßimleri temizle
    document.querySelectorAll('.seller-card, .category-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Yeni satƒ±cƒ±yƒ± se√ß
    const sellerCard = document.querySelector(`[data-seller-id="${seller.id}"]`);
    if (sellerCard) {
        sellerCard.classList.add('selected');
    }
    
    selectedSellerId = seller.id;
    selectedCategoryId = null; // Kategori se√ßimini sƒ±fƒ±rla
    products = []; // √úr√ºnleri temizle
    
    // Kategori grid'ini temizle
    if (categoriesGrid) {
        categoriesGrid.innerHTML = '<div class="text-center">Y√ºkleniyor...</div>';
    }
    
    // √úr√ºnler grid'ini temizle
    if (productsGrid) {
        productsGrid.innerHTML = '<div class="text-center">Bir reyon se√ßin</div>';
    }
    
    // Satƒ±cƒ± bilgisini g√ºncelle
    if (selectedSellerInfo) {
        selectedSellerInfo.innerHTML = `
            <i class="fas fa-store"></i> ${seller.business_name || seller.full_name} 
            <small style="color: var(--gray);">- ${seller.city || ''}</small>
        `;
    }
    
    // SATICIYA G√ñRE REYONLARI Y√úKLE (D√úZELTƒ∞LDƒ∞)
    await loadReyonsBySeller(seller.id);
    
    // B√∂l√ºm g√∂r√ºn√ºrl√ºƒü√ºn√º ayarla
    if (categoriesSection) categoriesSection.style.display = 'block'; // Reyonlarƒ± g√∂ster
    if (productsSection) productsSection.style.display = 'none'; // √úr√ºnleri gizle
    
    debugLog(`‚úÖ Satƒ±cƒ± se√ßildi: ${seller.business_name || seller.full_name}`);
    
    // Teslimat durumuna g√∂re mesaj
    if (selectedLocation === 'delivery' && seller.delivery_available !== false) {
        const deliveryMsg = seller.delivery_fee > 0 ? 
            `Teslimat √ºcreti: ${money(seller.delivery_fee)}` : 
            "√úcretsiz teslimat";
        speakToUser(`${seller.business_name || seller.full_name} se√ßildi. ${deliveryMsg}. ≈ûimdi bir reyon se√ßin.`);
    } else {
        speakToUser(`${seller.business_name || seller.full_name} se√ßildi. ≈ûimdi bir reyon se√ßin.`);
    }
}


// Reyonalarƒ± g√ºncelle - YENƒ∞ FONKSƒ∞YON
function updateReyonsAvailability() {
    if (!categories || categories.length === 0) return;
    
    const categoryCards = document.querySelectorAll('.category-card');
    categoryCards.forEach(card => {
        if (selectedSellerId) {
            card.style.opacity = '1';
            card.style.cursor = 'pointer';
            card.style.pointerEvents = 'auto';
        } else {
            card.style.opacity = '0.5';
            card.style.cursor = 'not-allowed';
            card.style.pointerEvents = 'none';
        }
    });
}

// Reyona g√∂re √ºr√ºnleri grupla
function displayProductsByReyon(productsToShow) {
    if (!productsToShow || productsToShow.length === 0) {
        productsGrid.innerHTML = `
            <div class="text-center" style="grid-column: 1 / -1; padding: 40px; color: #6c757d;">
                <i class="fas fa-box-open fa-3x mb-3"></i>
                <p>Bu satƒ±cƒ±da √ºr√ºn bulunamadƒ±</p>
            </div>
        `;
        return;
    }
    
    // Reyona g√∂re grupla
    const productsByReyon = {};
    productsToShow.forEach(product => {
        const reyonId = product.reyon_id || 'other';
        if (!productsByReyon[reyonId]) {
            productsByReyon[reyonId] = [];
        }
        productsByReyon[reyonId].push(product);
    });
    
    // √úr√ºnleri g√∂ster
    displayProducts(productsToShow);
}	
// Reyonalarƒ± √ºr√ºnlerle g√ºncelle
function updateReyonsWithProducts(products) {
    if (!categories || categories.length === 0) return;
    
    // √úr√ºnlerin reyon ID'lerini topla
    const productReyonIds = [...new Set(products.map(p => p.reyon_id).filter(id => id))];
    
    // Reyon kartlarƒ±nƒ± g√ºncelle
    const categoryCards = document.querySelectorAll('.category-card');
    categoryCards.forEach(card => {
        const categoryId = card.dataset.categoryId;
        const hasProducts = productReyonIds.includes(categoryId);
        
        if (hasProducts) {
            card.style.opacity = '1';
            card.style.cursor = 'pointer';
        } else {
            card.style.opacity = '0.5';
            card.style.cursor = 'not-allowed';
        }
    });
}	
	// Fallback veriler
async function useFallbackStoreTypes() {
    // Manuel olarak t√ºm store type'larƒ± tanƒ±mlayƒ±n
    storeTypes = [
        { id: '1', name: 'Market', code: 'market', description: 'Market ve bakkallar' },
        { id: '2', name: 'Restoran', code: 'restaurant', description: 'Yemek restoranlarƒ±' },
        { id: '3', name: 'Kafe', code: 'cafe', description: 'Kafe ve pastaneler' },
        { id: '4', name: 'Fƒ±rƒ±n', code: 'bakery', description: 'Fƒ±rƒ±n ve unlu mam√ºller' },
        { id: '5', name: 'Eczane', code: 'pharmacy', description: 'Eczane ve ila√ßlar' },
        { id: '6', name: 'Teknoloji', code: 'technology', description: 'Elektronik √ºr√ºnler' },
        { id: '7', name: 'Giyim', code: 'clothing', description: 'Giyim maƒüazalarƒ±' },
        { id: '8', name: 'Kitap', code: 'bookstore', description: 'Kitap√ßƒ±lar' },
        { id: '9', name: 'Spor', code: 'sports', description: 'Spor malzemeleri' },
        { id: '10', name: 'Kozmetik', code: 'cosmetics', description: 'Kozmetik √ºr√ºnler' },
        { id: '11', name: 'Ev E≈üyasƒ±', code: 'home', description: 'Ev e≈üyalarƒ±' },
        { id: '12', name: 'Oyuncak', code: 'toys', description: 'Oyuncak maƒüazalarƒ±' }
    ];
    
    localStorage.setItem('storeTypes', JSON.stringify(storeTypes));
    displayStoreTypes(storeTypes);
    debugLog('üîÑ Manuel StoreTypes kullanƒ±lƒ±yor');
}
function getDemoReyons(storeTypeId) {
    const demoReyons = {
        '1': [ // Market reyonlarƒ±
            { id: '1', name: 'Meyve & Sebze', image_url: '' },
            { id: '2', name: 'S√ºt √úr√ºnleri', image_url: '' },
            { id: '3', name: 'Et & Tavuk', image_url: '' }
        ],
        '2': [ // Restoran kategorileri
            { id: '4', name: 'Ana Yemekler' },
            { id: '5', name: '√áorbalar' },
            { id: '6', name: 'Tatlƒ±lar' }
        ],
        '3': [ // Eczane kategorileri
            { id: '7', name: 'Aƒürƒ± Kesiciler' },
            { id: '8', name: 'Vitaminler' }
        ]
    };
    
    return demoReyons[storeTypeId] || [];
}

// Demo satƒ±cƒ±lar - konum bilgisi ekle
function getDemoSellers() {
    return [
        { 
            id: '1', 
            business_name: "Demo Market", 
            full_name: "Demo Market",
            city: userLocation.city || "ƒ∞stanbul", 
            district: userLocation.district || "Kadƒ±k√∂y",
            imgurl: "https://via.placeholder.com/200x120?text=Demo+Market", 
            address: "Demo Adres",
            rating: "4.5"
        },
        { 
            id: '2', 
            business_name: "√ñrnek Market", 
            full_name: "√ñrnek Market",
            city: userLocation.city || "ƒ∞stanbul", 
            district: userLocation.district || "Be≈üikta≈ü",
            imgurl: "https://via.placeholder.com/200x120?text=Ornek+Market", 
            address: "√ñrnek Adres",
            rating: "4.2"
        }
    ];
}




// =============================================
// 2. SESLƒ∞ Gƒ∞Rƒ∞≈û/KAYIT AKI≈ûI TAMAMLAMA
// =============================================

// =============================================
// K√ñK BAZLI AKILLI KOMUT Sƒ∞STEMƒ∞
// =============================================

// =============================================
// 0. K√ñK: BA≈ûLANGI√á & ANA MEN√ú
// =============================================

function handleRoot0(message) {
    if (message.includes('merhaba') || message.includes('selam') || message.includes('ba≈üla')) {
        speakToUser("Merhaba! Sesli sipari≈ü sistemine ho≈ü geldiniz. Giri≈ü yapmak i√ßin 'giri≈ü', misafir olarak devam etmek i√ßin 'misafir' diyebilirsiniz.");
        commandRoot = "0:1";
    }
    else if (message.includes('giri≈ü') || message.includes('giri≈ü yap')) {
        speakToUser("Giri≈ü yapƒ±lƒ±yor... L√ºtfen telefon numaranƒ±zƒ± s√∂yleyin.");
        commandRoot = "1:1";
    }
    else if (message.includes('misafir') || message.includes('misafir olarak')) {
        speakToUser("Misafir olarak devam ediyorsunuz. Hemen alƒ±≈üveri≈üe ba≈ülayalƒ±m!");
        currentCustomer = { name: "Misafir", role: "guest" };
        updateUIAfterLogin();
        commandRoot = "2:1"; // Doƒürudan satƒ±cƒ± se√ßimine git
    }
    else {
        speakToUser("Merhaba! Sesli sipari≈ü sistemine ho≈ü geldiniz. 'Giri≈ü' veya 'Misafir' diyerek ba≈ülayabilirsiniz.");
    }
}

// =============================================
// 1. K√ñK: Gƒ∞Rƒ∞≈û & KAYIT S√úRECƒ∞
// =============================================

function handleRoot1(message, subRoot) {
    // 1:1 - Telefon numarasƒ± alma
    if (subRoot === 1) {
        const phoneMatch = message.match(/\d+/g);
        if (phoneMatch && phoneMatch.join('').length >= 10) {
            const phone = phoneMatch.join('');
            currentCustomer = { ...currentCustomer, phone: phone };
            speakToUser(`Telefon numaranƒ±z: ${phone}. Doƒüru mu?`);
            commandRoot = "1:2"; // Onay bekliyoruz
        } else {
            speakToUser("Telefon numaranƒ±zƒ± anlayamadƒ±m. L√ºtfen 10 haneli numaranƒ±zƒ± s√∂yler misiniz?");
        }
    }
    // 1:2 - Telefon onayƒ±
    else if (subRoot === 2) {
        if (message.includes('evet') || message.includes('doƒüru') || message.includes('onay')) {
            checkCustomerByPhone(currentCustomer.phone);
        } else {
            speakToUser("√ñz√ºr dilerim. L√ºtfen telefon numaranƒ±zƒ± tekrar s√∂yler misiniz?");
            commandRoot = "1:1"; // Tekrar telefon soralƒ±m
        }
    }
}

// =============================================
// 2. K√ñK: SATICI ƒ∞≈ûLEMLERƒ∞
// =============================================

// 2. K√ñK: SATICI ƒ∞≈ûLEMLERƒ∞ - AKI≈û D√úZELTMESƒ∞
function handleRoot2(message, subRoot) {
    // 2:1 - Satƒ±cƒ± tipi se√ßimi
    if (subRoot === 1) {
        if (message.includes('market')) {
            selectStoreTypeByName('Market');
            speakToUser("Market se√ßildi. Size en yakƒ±n marketler y√ºkleniyor...");
            commandRoot = "2:2"; // Satƒ±cƒ± se√ßimine ge√ß
        }
        else if (message.includes('restoran') || message.includes('yemek')) {
            selectStoreTypeByName('Restoran');
            speakToUser("Restoran se√ßildi. Size en yakƒ±n restoranlar y√ºkleniyor...");
            commandRoot = "2:2";
        }
        else if (message.includes('eczane')) {
            selectStoreTypeByName('Eczane');
            speakToUser("Eczane se√ßildi. Size en yakƒ±n eczaneler y√ºkleniyor...");
            commandRoot = "2:2";
        }
        else if (message.includes('fƒ±rƒ±n')) {
            selectStoreTypeByName('Fƒ±rƒ±n');
            speakToUser("Fƒ±rƒ±n se√ßildi. Size en yakƒ±n fƒ±rƒ±nlar y√ºkleniyor...");
            commandRoot = "2:2";
        }
        else if (message.includes('geri') || message.includes('√∂nceki')) {
            speakToUser("Ana men√ºye d√∂n√ºl√ºyor...");
            commandRoot = "0:1";
        }
        else {
            speakToUser("Hangi t√ºr satƒ±cƒ±dan alƒ±≈üveri≈ü yapmak istersiniz? Market, restoran, eczane veya fƒ±rƒ±n?");
        }
    }
    // 2:2 - Satƒ±cƒ± se√ßimi
    else if (subRoot === 2) {
        if (sellers.length === 0) {
            speakToUser("Hen√ºz satƒ±cƒ± y√ºklenmedi. L√ºtfen bekleyin.");
            return;
        }
        
        // Satƒ±cƒ± ismi ile e≈üle≈ütirme
        const matchedSeller = sellers.find(seller => 
            message.includes(seller.business_name?.toLowerCase()) || 
            message.includes(seller.full_name?.toLowerCase())
        );
        
        if (matchedSeller) {
            selectSeller(matchedSeller);
            speakToUser(`${matchedSeller.business_name} se√ßildi. ≈ûimdi bir reyon se√ßin.`);
            commandRoot = "2:3"; // Reyon se√ßimine ge√ß
        } else {
            speakToUser(`Mevcut satƒ±cƒ±lar: ${sellers.map(s => s.business_name || s.full_name).join(', ')}. Hangisini se√ßmek istersiniz?`);
        }
    }
    // 2:3 - Reyon se√ßimi
    else if (subRoot === 3) {
        if (categories.length === 0) {
            speakToUser("Hen√ºz reyon y√ºklenmedi. L√ºtfen bekleyin.");
            return;
        }
        
        // Reyon ismi ile e≈üle≈ütirme
        const matchedCategory = categories.find(category => 
            message.includes(category.name.toLowerCase())
        );
        
        if (matchedCategory) {
            // Reyon se√ßimi sim√ºle et
            const categoryCard = document.querySelector(`[data-category-id="${matchedCategory.id}"]`);
            if (categoryCard) {
                categoryCard.click();
            }
            speakToUser(`${matchedCategory.name} reyonu se√ßildi. √úr√ºnler listeleniyor.`);
            commandRoot = "3:1"; // √úr√ºn se√ßimine ge√ß
        } else {
            speakToUser(`Mevcut reyonlar: ${categories.map(c => c.name).join(', ')}. Hangisini se√ßmek istersiniz?`);
        }
    }
}
// =============================================
// 3. K√ñK: √úR√úN ƒ∞≈ûLEMLERƒ∞
// =============================================

function handleRoot3(message, subRoot) {
    // 3:1 - √úr√ºn se√ßimi
    if (subRoot === 1) {
        if (message.includes('ekle') || message.includes('sepete') || message.includes('al')) {
            handleAddToCartCommand(message);
        }
        else if (message.includes('√ºr√ºn') || message.includes('liste') || message.includes('ne var')) {
            speakToUser(`Mevcut √ºr√ºnler: ${getAvailableProducts()}`);
        }
        else if (message.includes('geri') || message.includes('satƒ±cƒ±')) {
            speakToUser("Satƒ±cƒ± se√ßimine d√∂n√ºl√ºyor...");
            commandRoot = "2:1";
        }
        else if (message.includes('sepet') || message.includes('sepete git')) {
            openCart();
            speakToUser("Sepetiniz g√∂steriliyor...");
            commandRoot = "4:1";
        }
        else {
            speakToUser("√úr√ºn eklemek i√ßin 'ekle', sepete gitmek i√ßin 'sepet' diyebilirsiniz.");
        }
    }
}

// =============================================
// 4. K√ñK: SEPET ƒ∞≈ûLEMLERƒ∞
// =============================================

function handleRoot4(message, subRoot) {
    // 4:1 - Sepet y√∂netimi
    if (subRoot === 1) {
        if (message.includes('√∂deme') || message.includes('tamamla') || message.includes('sipari≈ü')) {
            if (cart.length === 0) {
                speakToUser("Sepetiniz bo≈ü. √ñnce √ºr√ºn eklemelisiniz.");
                commandRoot = "3:1";
            } else {
                const total = calculateCartTotal();
                speakToUser(`Sepetinizde ${cart.length} √ºr√ºn var. Toplam: ${money(total)}. √ñdeme yapmak i√ßin √∂deme y√∂ntemi se√ßin: nakit, kart veya bonus?`);
                commandRoot = "5:1";
            }
        }
        else if (message.includes('devam') || message.includes('alƒ±≈üveri≈ü')) {
            closeCart();
            speakToUser("Alƒ±≈üveri≈üe devam ediliyor...");
            commandRoot = "3:1";
        }
        else if (message.includes('sil') || message.includes('√ßƒ±kar') || message.includes('bo≈üalt')) {
            if (message.includes('hepsini') || message.includes('t√ºm√ºn√º')) {
                cart = [];
                updateCartUI();
                speakToUser("Sepetiniz bo≈üaltƒ±ldƒ±.");
            }
        }
        else if (message.includes('geri') || message.includes('√ºr√ºnler')) {
            closeCart();
            commandRoot = "3:1";
        }
        else {
            speakToUser("√ñdeme yapmak i√ßin '√∂deme', alƒ±≈üveri≈üe devam i√ßin 'devam' diyebilirsiniz.");
        }
    }
}

// =============================================
// 5. K√ñK: √ñDEME ƒ∞≈ûLEMLERƒ∞
// =============================================

// 5. K√ñK: √ñDEME ƒ∞≈ûLEMLERƒ∞ - ADRES ONAYI ve MESAFE KONTROL√ú
function handleRoot5(message, subRoot) {
    const total = calculateCartTotal();
    
    // 5:1 - √ñdeme y√∂ntemi se√ßimi
    if (subRoot === 1) {
        if (message.includes('nakit')) {
            currentPaymentMethod = 'nakit';
            startAddressConfirmation(total);
        }
        else if (message.includes('kart') || message.includes('kredi')) {
            currentPaymentMethod = 'kart';
            startAddressConfirmation(total);
        }
        else if (message.includes('bonus')) {
            if (currentCustomer && currentCustomer.bonus_amount >= total) {
                currentPaymentMethod = 'bonus';
                startAddressConfirmation(total);
            } else {
                speakToUser(`Bonus bakiyeniz yetersiz. Mevcut bonus: ${money(currentCustomer?.bonus_amount || 0)}. Ba≈üka √∂deme y√∂ntemi se√ßin.`);
            }
        }
        else if (message.includes('geri') || message.includes('sepet')) {
            speakToUser("Sepete d√∂n√ºl√ºyor...");
            commandRoot = "4:1";
        }
        else {
            speakToUser("L√ºtfen √∂deme y√∂ntemi se√ßin: nakit, kart veya bonus?");
        }
    }
    // 5:2 - Adres onayƒ±
    else if (subRoot === 2) {
        if (message.includes('evet') || message.includes('doƒüru') || message.includes('onay')) {
            // Mesafe kontrol√º yap
            checkDeliveryDistance().then(isWithinRange => {
                if (isWithinRange) {
                    speakToUser(`Teslimat adresiniz: ${currentCustomer.address}. Sipari≈üiniz tamamlanƒ±yor...`);
                    finalizeOrder(currentPaymentMethod);
                    commandRoot = "0:1";
                } else {
                    speakToUser("√úzg√ºn√ºz, se√ßtiƒüiniz satƒ±cƒ± bu adrese teslimat yapmƒ±yor. L√ºtfen ba≈üka bir satƒ±cƒ± se√ßin veya adresinizi deƒüi≈ütirin.");
                    commandRoot = "2:1"; // Satƒ±cƒ± se√ßimine d√∂n
                }
            });
        }
        else if (message.includes('hayƒ±r') || message.includes('deƒüi≈ü') || message.includes('farklƒ±')) {
            speakToUser("L√ºtfen yeni teslimat adresinizi s√∂yler misiniz?");
            commandRoot = "5:3";
        }
        else {
            speakToUser(`Teslimat adresiniz: ${currentCustomer.address}. Doƒüru mu? 'Evet' veya 'Hayƒ±r' diyin.`);
        }
    }
    // 5:3 - Yeni adres alma
    else if (subRoot === 3) {
        if (message.trim().length > 5) {
            currentCustomer.address = message.trim();
            
            // Yeni adresle mesafe kontrol√º
            checkDeliveryDistance().then(isWithinRange => {
                if (isWithinRange) {
                    speakToUser(`Yeni adresiniz kaydedildi: ${currentCustomer.address}. Sipari≈üiniz tamamlanƒ±yor...`);
                    finalizeOrder(currentPaymentMethod);
                    commandRoot = "0:1";
                } else {
                    speakToUser("√úzg√ºn√ºz, se√ßtiƒüiniz satƒ±cƒ± bu adrese teslimat yapmƒ±yor. L√ºtfen ba≈üka bir satƒ±cƒ± se√ßin veya adresinizi deƒüi≈ütirin.");
                    commandRoot = "2:1"; // Satƒ±cƒ± se√ßimine d√∂n
                }
            });
        } else {
            speakToUser("L√ºtfen tam adresinizi s√∂yler misiniz?");
        }
    }
}

// =============================================
// VERƒ∞TABANI ODAKLI ASƒ∞STAN Sƒ∞STEMƒ∞
// =============================================

// Veritabanƒ±ndan k√∂k kurallarƒ±nƒ± y√ºkle
// Komut kurallarƒ±nƒ± veritabanƒ±ndan y√ºkle
// Komut kurallarƒ±nƒ± y√ºkle - TABLOLAR MEVCUT
async function loadCommandRules() {
    try {
        const { data, error } = await supabase
            .from('voice_command_rules')
            .select('*')
            .eq('is_active', true)
            .order('priority', { ascending: false });

        if (error) {
            console.error('‚ùå Komut kurallarƒ± y√ºkleme hatasƒ±:', error);
            // Hata durumunda fallback kurallarƒ± y√ºkle
            loadFallbackCommandRules();
            return;
        }

        commandRules.clear();
        data.forEach(rule => {
            if (!commandRules.has(rule.root_code)) {
                commandRules.set(rule.root_code, []);
            }
            commandRules.get(rule.root_code).push(rule);
        });

        console.log(`‚úÖ ${data.length} komut kuralƒ± y√ºklendi`);
        
        // Eƒüer hi√ß kural y√ºklenmediyse fallback kullan
        if (data.length === 0) {
            console.log('‚ö†Ô∏è Hi√ß komut kuralƒ± y√ºklenemedi, fallback kurallar kullanƒ±lƒ±yor');
            loadFallbackCommandRules();
        }
    } catch (error) {
        console.error('‚ùå Komut kurallarƒ± y√ºkleme hatasƒ±:', error);
        loadFallbackCommandRules();
    }
}

// Fallback komut kurallarƒ±
// Fallback komut kurallarƒ±
function loadFallbackCommandRules() {
    commandRules.clear();
    
    const fallbackRules = [
        {
            root_code: '0:0',
            input_patterns: 'merhaba|selam|ba≈üla',
            output_text: 'Merhaba! Sesli sipari≈ü sistemine ho≈ü geldiniz.',
            next_root: '1:0',
            action_name: 'show_location_modal',
            priority: 100
        },
        {
            root_code: '1:0',
            input_patterns: 'market',
            output_text: 'Market se√ßildi. Size en yakƒ±n marketler listeleniyor.',
            next_root: '2:0',
            action_name: 'select_market',
            priority: 90
        },
        {
            root_code: '4:0',
            input_patterns: 'ekle|sepete|al',
            output_text: '√úr√ºn sepete eklendi.',
            next_root: '4:0',
            action_name: 'add_to_cart_voice',
            priority: 85
        }
    ];
    
    fallbackRules.forEach(rule => {
        if (!commandRules.has(rule.root_code)) {
            commandRules.set(rule.root_code, []);
        }
        commandRules.get(rule.root_code).push(rule);
    });
  
// Ana sesli komut i≈üleme - √úR√úN EKLEME ODAKLI
async function processVoiceCommand(transcript) {
    const message = transcript.toLowerCase().trim();
    
    if (userMessage) userMessage.textContent = transcript;

    debugLog(`üîä Komut i≈üleniyor: "${message}" | K√∂k: ${currentRoot} | √úr√ºn Sayƒ±sƒ±: ${products.length}`);

    // 1. √ñnce doƒürudan √ºr√ºn ekleme komutlarƒ±nƒ± kontrol et
    if (message.includes('ekle') || message.includes('sepete') || message.includes('al') || 
        message.includes('istiyorum') || message.includes('ver')) {
        
        // √úr√ºn ismi i√ßeriyor mu kontrol et
        const hasProductKeywords = message.includes('domates') || message.includes('soƒüan') || 
                                 message.includes('ekmek') || message.includes('s√ºt') || 
                                 message.includes('peynir') || message.includes('yumurta');
        
        if (hasProductKeywords || message.split(' ').length >= 2) {
            debugLog('üéØ Doƒürudan √ºr√ºn ekleme komutu tespit edildi');
            await handleAddToCartCommand(message);
            return;
        }
    }

    // 2. Askƒ±da cevap varsa, onu i≈üle
    if (pendingResponse) {
        return handlePendingResponse(message);
    }

    // 3. Mevcut k√∂k i√ßin kurallarƒ± ara
    const match = await findRuleMatch(message, currentRoot);
    
    if (match) {
        await executeMatchedRule(match, message);
    } else {
        // 4. E≈üle≈üme yoksa AI'ya y√∂nlendir
        await handleAIRequest(message, currentRoot);
    }
}
	
// K√∂k komut e≈üle≈ütirme
async function findRuleMatch(message, root) {
    const rules = commandRules.get(root) || [];
    
    for (const rule of rules) {
        const patterns = rule.input_patterns.split('|');
        for (const pattern of patterns) {
            if (matchesPattern(message, pattern)) {
                return { rule, pattern, extractedData: extractData(message, pattern) };
            }
        }
    }
    return null;
}

// Pattern e≈üle≈ütirme
function matchesPattern(message, pattern) {
    if (pattern.startsWith('regex:')) {
        const regex = new RegExp(pattern.replace('regex:', ''));
        return regex.test(message);
    }
    return message.includes(pattern);
}

// Veri √ßƒ±karma
function extractData(message, pattern) {
    const data = {};
    
    if (pattern.startsWith('regex:')) {
        const regex = new RegExp(pattern.replace('regex:', ''));
        const match = message.match(regex);
        if (match && match.groups) {
            return match.groups;
        }
    }
    
    // Telefon numarasƒ± √ßƒ±karma
    const phoneMatch = message.match(/\d+/g);
    if (phoneMatch && phoneMatch.join('').length >= 10) {
        data.phone = phoneMatch.join('');
    }
    
    return data;
}

// E≈üle≈üen kuralƒ± √ßalƒ±≈ütƒ±r
async function executeMatchedRule(match, message) {
    const { rule, extractedData } = match;
    
    // √áƒ±ktƒ±yƒ± hazƒ±rla
    let output = rule.output_text;
    if (extractedData.phone) output = output.replace('{phone}', extractedData.phone);
    
    // Sesli cevap ver
    speakToUser(output);
    
    // Aksiyonu √ßalƒ±≈ütƒ±r
    if (rule.action_name) {
        await executeAction(rule.action_name, { 
            extractedData, 
            message 
        });
    }
    
    // Askƒ±da cevap bekliyorsa
    if (rule.next_root && rule.next_root.includes('?')) {
        pendingResponse = { nextRoot: rule.next_root, context: extractedData };
    } else {
        currentRoot = rule.next_root || currentRoot;
    }
}


// AI isteƒüi i≈üleme - G√úNCELLENMƒ∞≈û
async function handleAIRequest(message, root) {
    speakToUser("Anlƒ±yorum...");
    
    const aiResult = await queryAI(message, root);
    
    if (aiResult.confidence > 0.7) {
        // Oturum durumunu da response'a ekle
        let response = aiResult.response;
        if (!currentCustomer && (response.includes('√∂deme') || response.includes('sipari≈ü'))) {
            response += " Misafir olarak alƒ±≈üveri≈ü yapƒ±yorsunuz. Sipari≈üi tamamlamak i√ßin giri≈ü yapmanƒ±z gerekecek.";
        }
        
        speakToUser(response);
        currentRoot = aiResult.suggested_root;
        
        // √ñƒürenmeyi kaydet - YENƒ∞ PARAMETRELERLE
        await saveToAILearningCache(
            message,                    // original_message
            response,                   // ai_generated_response  
            root,                       // original_root
            aiResult.suggested_root,    // ai_suggested_root
            aiResult.confidence,        // confidence_score
            aiResult.used_patterns      // used_patterns
        );
    } else {
        speakToUser("√úzg√ºn√ºm, tam anlayamadƒ±m. L√ºtfen tekrar s√∂yler misiniz?");
    }
}
	// AI √∂ƒürenme verisi kaydetme - GER√áEK TABLO YAPISINA UYGUN
async function saveToAILearningCache(originalMessage, aiGeneratedResponse, originalRoot, aiSuggestedRoot, confidenceScore, usedPatterns = null) {
    try {
        const { error } = await supabase
            .from('ai_learning_cache')
            .insert([{
                original_message: originalMessage,
                original_root: originalRoot,
                ai_generated_response: aiGeneratedResponse,
                ai_suggested_root: aiSuggestedRoot,
                confidence_score: confidenceScore,
                used_patterns: usedPatterns,
                is_approved: false, // Varsayƒ±lan olarak false
                created_at: new Date().toISOString()
            }]);

        if (error) {
            console.error('‚ùå AI √∂ƒürenme kaydetme hatasƒ±:', error);
            return;
        }
        
        debugLog('‚úÖ AI √∂ƒürenme verisi kaydedildi');
    } catch (error) {
        console.error('‚ùå AI √∂ƒürenme kaydetme hatasƒ±:', error);
    }
}
// Askƒ±da cevap i≈üleme
async function handlePendingResponse(message) {
    if (!pendingResponse) return;
    
    const { nextRoot, context } = pendingResponse;
    pendingResponse = null;
    
    if (message.includes('evet') || !message.includes('hayƒ±r')) {
        currentRoot = nextRoot.replace('?', '');
        speakToUser("Tamam, devam ediyorum...");
    } else {
        speakToUser("Anladƒ±m, ba≈üka nasƒ±l yardƒ±mcƒ± olabilirim?");
        currentRoot = "0:0";
    }
}

// AI sorgu fonksiyonunu g√ºncelle - DAHA GER√áEK√áƒ∞
async function queryAI(message, contextRoot) {
    return new Promise(resolve => {
        setTimeout(() => {
            // Basit bir AI sim√ºlasyonu - ger√ßekte burada bir AI API'si √ßaƒürƒ±lƒ±r
            let response, suggestedRoot, confidence, usedPatterns;
            
            // Basit pattern matching ile AI benzeri davranƒ±≈ü
            if (message.includes('merhaba') || message.includes('selam')) {
                response = "Merhaba! Size nasƒ±l yardƒ±mcƒ± olabilirim?";
                suggestedRoot = "1:0";
                confidence = 0.9;
                usedPatterns = "merhaba|selam";
            } 
            else if (message.includes('te≈üekk√ºr') || message.includes('saƒü ol')) {
                response = "Rica ederim! Ba≈üka bir ≈üey ister misiniz?";
                suggestedRoot = contextRoot;
                confidence = 0.95;
                usedPatterns = "te≈üekk√ºr|saƒü ol";
            }
            else if (message.includes('yardƒ±m') || message.includes('nasƒ±l')) {
                response = "Sesli komutlarla alƒ±≈üveri≈ü yapabilirsiniz. 'Market', 'Restoran' diyerek ba≈ülayabilir veya √ºr√ºn ismi s√∂yleyerek sepete ekleyebilirsiniz.";
                suggestedRoot = "0:0";
                confidence = 0.85;
                usedPatterns = "yardƒ±m|nasƒ±l";
            }
            else if (message.includes('fiyat') || message.includes('ne kadar')) {
                response = "√úr√ºn fiyatlarƒ±nƒ± g√∂rmek i√ßin √∂nce bir kategori se√ßmelisiniz.";
                suggestedRoot = contextRoot;
                confidence = 0.8;
                usedPatterns = "fiyat|ne kadar";
            }
            else {
                // Anla≈üƒ±lamayan komutlar i√ßin
                response = "√úzg√ºn√ºm, bu komutu tam anlayamadƒ±m. L√ºtfen ba≈üka ≈üekilde ifade edebilir misiniz?";
                suggestedRoot = contextRoot;
                confidence = 0.3;
                usedPatterns = "unknown";
            }
            
            resolve({
                response: response,
                suggested_root: suggestedRoot,
                confidence: confidence,
                used_patterns: usedPatterns
            });
        }, 1000);
    });
}

// Komut kurallarƒ±nƒ± kontrol et ve gerekirse √∂rnek veri ekle
async function checkAndPopulateCommandRules() {
    try {
        const { data, error } = await supabase
            .from('voice_command_rules')
            .select('*')
            .limit(1);

        if (error) {
            console.error('‚ùå Komut kurallarƒ± kontrol hatasƒ±:', error);
            return;
        }

        if (data.length === 0) {
            console.log('‚ö†Ô∏è Komut kurallarƒ± bo≈ü, √∂rnek veri ekleniyor...');
            await populateSampleCommandRules();
        } else {
            console.log(`‚úÖ ${data.length} komut kuralƒ± mevcut`);
        }
    } catch (error) {
        console.error('‚ùå Komut kurallarƒ± kontrol hatasƒ±:', error);
    }
}
	
// √ñƒürenmeyi kaydet (5 satƒ±r)
async function saveAILearning(originalRoot, userInput, aiResult) {
    await supabase.from('ai_learning_log').insert([{
        original_root: originalRoot,
        user_input: userInput,
        ai_response: aiResult.response,
        resolved_root: aiResult.suggested_root,
        confidence_score: aiResult.confidence
    }]);
}

// AI √∂ƒürenme verisi kaydetme - TABLOLAR MEVCUT
async function saveToAILearningCache(userInput, aiResponse, rootCode, confidence) {
    try {
        const { error } = await supabase
            .from('ai_learning_cache')
            .insert([{
                user_input: userInput,
                ai_response: aiResponse,
                root_code: rootCode,
                confidence_score: confidence,
                created_at: new Date().toISOString()
            }]);

        if (error) {
            console.error('‚ùå AI √∂ƒürenme kaydetme hatasƒ±:', error);
            // Hata durumunda sessizce devam et, uygulamayƒ± durdurma
            return;
        }
        
        debugLog('‚úÖ AI √∂ƒürenme verisi kaydedildi');
    } catch (error) {
        console.error('‚ùå AI √∂ƒürenme kaydetme hatasƒ±:', error);
        // Hata durumunda sessizce devam et
    }
}

	// √ñrnek komut kurallarƒ±nƒ± ekle
async function populateSampleCommandRules() {
    const sampleRules = [
        {
            root_code: '0:0',
            input_patterns: 'merhaba|selam|ba≈üla',
            output_text: 'Merhaba! Sesli sipari≈ü sistemine ho≈ü geldiniz. L√ºtfen konumunuzu se√ßin.',
            next_root: '1:0',
            action_name: 'show_location_modal',
            is_active: true,
            priority: 100
        },
        {
            root_code: '1:0',
            input_patterns: 'market',
            output_text: 'Market se√ßildi. Size en yakƒ±n marketler listeleniyor.',
            next_root: '2:0',
            action_name: 'select_market',
            is_active: true,
            priority: 90
        },
        {
            root_code: '1:0',
            input_patterns: 'restoran|yemek',
            output_text: 'Restoran se√ßildi. Size en yakƒ±n restoranlar listeleniyor.',
            next_root: '2:0',
            action_name: 'select_restaurant',
            is_active: true,
            priority: 90
        },
        {
            root_code: '1:0',
            input_patterns: 'eczane|ila√ß',
            output_text: 'Eczane se√ßildi. Size en yakƒ±n eczaneler listeleniyor.',
            next_root: '2:0',
            action_name: 'select_pharmacy',
            is_active: true,
            priority: 90
        },
        {
            root_code: '4:0',
            input_patterns: 'ekle|sepete|al',
            output_text: '√úr√ºn sepete eklendi.',
            next_root: '4:0',
            action_name: 'add_to_cart_voice',
            is_active: true,
            priority: 85
        },
        {
            root_code: '4:0',
            input_patterns: 'sepet|sepete git',
            output_text: 'Sepetiniz g√∂steriliyor.',
            next_root: '5:0',
            action_name: 'show_cart',
            is_active: true,
            priority: 80
        },
        {
            root_code: '5:0',
            input_patterns: '√∂deme|tamamla|sipari≈ü',
            output_text: '√ñdeme ekranƒ±na ge√ßiliyor.',
            next_root: '6:0',
            action_name: 'start_payment',
            is_active: true,
            priority: 95
        }
    ];

    try {
        const { error } = await supabase
            .from('voice_command_rules')
            .insert(sampleRules);

        if (error) {
            console.error('‚ùå √ñrnek komut kurallarƒ± ekleme hatasƒ±:', error);
            return;
        }

        console.log(`‚úÖ ${sampleRules.length} √∂rnek komut kuralƒ± eklendi`);
    } catch (error) {
        console.error('‚ùå √ñrnek komut kurallarƒ± ekleme hatasƒ±:', error);
    }
}
//AKSƒ∞YON Y√ñNETƒ∞Cƒ∞Sƒ∞

// =============================================
// YENƒ∞ K√ñK SIRALAMASI ƒ∞√áƒ∞N AKSƒ∞YON FONKSƒ∞YONLARI
// =============================================
	
async function executeAction(actionName, data) {
    console.log(`‚ö° Aksiyon: ${actionName}`, data);
    
    switch(actionName) {
        // Maƒüaza tipi se√ßim aksiyonlarƒ±
        case 'select_market':
            await selectStoreTypeByName('Market');
            break;
        case 'select_restaurant':
            await selectStoreTypeByName('Restoran');
            break;
        case 'select_pharmacy':
            await selectStoreTypeByName('Eczane');
            break;
        case 'select_bakery':
            await selectStoreTypeByName('Fƒ±rƒ±n');
            break;
        case 'select_cafe':
            await selectStoreTypeByName('Kafe');
            break;
            
        // Satƒ±cƒ± se√ßim aksiyonlarƒ±
        case 'select_seller_by_index':
            await selectSellerByIndex(extractNumber(data.message));
            break;
        case 'go_back_store_type':
            currentRoot = "1:0";
            speakToUser("Maƒüaza tipi se√ßimine d√∂n√ºl√ºyor.");
            break;
            
        // Reyon se√ßim aksiyonlarƒ±
        case 'select_category_fruits':
            await selectCategoryByName('Meyve & Sebze');
            break;
        case 'select_category_dairy':
            await selectCategoryByName('S√ºt √úr√ºnleri');
            break;
        case 'select_category_meat':
            await selectCategoryByName('Et & Tavuk');
            break;
        case 'select_category_drinks':
            await selectCategoryByName('ƒ∞√ßecekler');
            break;
        case 'select_category_by_index':
            await selectCategoryByIndex(extractNumber(data.message));
            break;
        case 'go_back_seller':
            currentRoot = "2:0";
            speakToUser("Satƒ±cƒ± se√ßimine d√∂n√ºl√ºyor.");
            break;
            
        // √úr√ºn se√ßim aksiyonlarƒ±
           case 'add_to_cart_voice':
            await handleAddToCartCommand(data.message || '');
            break;

	case 'add_specific_product':
            await handleSpecificProduct(data.extractedData?.product || '');
            break;

        case 'add_product_by_index':
            await addProductByIndex(extractNumberFromMessage(data.message));
            break;

        case 'show_cart':
            openCart();
            currentRoot = "5:0";
            break;
        case 'go_back_category':
            currentRoot = "3:0";
            speakToUser("Reyon se√ßimine d√∂n√ºl√ºyor.");
            break;
            
        // Sepet aksiyonlarƒ±
        case 'start_payment':
            currentRoot = "6:0";
            speakToUser("√ñdeme y√∂ntemi se√ßin: nakit, kart veya bonus.");
            break;

	case 'start_payment_session_check':
            await startPaymentWithSessionCheck();
            break;

	case 'set_payment_cash_session':
            await setPaymentWithSessionCheck('nakit');
            break;

	case 'set_payment_card_session':
            await setPaymentWithSessionCheck('kart');
            break;

	case 'set_payment_bonus_session':
            await setPaymentWithSessionCheck('bonus');
            break;

	case 'show_cart_session':
            await showCartWithSessionStatus();
            break;

        case 'continue_shopping':
            closeCart();
            currentRoot = "4:0";
            speakToUser("Alƒ±≈üveri≈üe devam ediliyor.");
            break;
        case 'clear_cart':
            cart = [];
            updateCartUI();
            speakToUser("Sepetiniz temizlendi.");
            break;
        case 'go_back_products':
            closeCart();
            currentRoot = "4:0";
            break;
			
       if (itemCount === 0) {
                speakToUser("Sepetiniz bo≈ü.");
            } else {
                speakToUser(`Sepetinizde ${itemCount} √ºr√ºn var.`);
            }
            break;
			
        // √ñdeme aksiyonlarƒ±
        case 'set_payment_cash':
            currentPaymentMethod = 'nakit';
            currentRoot = "7:0";
            speakToUser("Nakit √∂deme se√ßildi. Teslimat adresiniz: " + (currentCustomer?.address || userLocation?.fullAddress || "Belirtilmemi≈ü") + ". Doƒüru mu?");
            break;
        case 'set_payment_card':
            currentPaymentMethod = 'kart';
            currentRoot = "7:0";
            speakToUser("Kart ile √∂deme se√ßildi. Teslimat adresiniz: " + (currentCustomer?.address || userLocation?.fullAddress || "Belirtilmemi≈ü") + ". Doƒüru mu?");
            break;
        case 'set_payment_bonus':
            currentPaymentMethod = 'bonus';
            currentRoot = "7:0";
            speakToUser("Bonus ile √∂deme se√ßildi. Teslimat adresiniz: " + (currentCustomer?.address || userLocation?.fullAddress || "Belirtilmemi≈ü") + ". Doƒüru mu?");
            break;
			
        case 'go_back_payment':
            currentRoot = "6:0";
            speakToUser("√ñdeme y√∂ntemi se√ßimine d√∂n√ºl√ºyor.");
            break;

		case 'show_cart_auto':
            openCart();
            const currentCart = currentCustomer ? cart : pendingCart;
            const itemCount = currentCart.reduce((total, item) => total + item.quantity, 0);	
			
        // Adres aksiyonlarƒ±
        case 'confirm_address':
            currentRoot = "8:0";
            speakToUser("Teslimat adresiniz onaylandƒ±. L√ºtfen telefon numaranƒ±zƒ± s√∂yleyin.");
            break;
			
        case 'request_new_address':
            currentRoot = "7:1";
            speakToUser("L√ºtfen yeni teslimat adresinizi s√∂yleyin.");
            break;
			
        case 'save_new_address':
            if (currentCustomer) {
                currentCustomer.address = data.extractedData.address;
            }
            userLocation.fullAddress = data.extractedData.address;
            currentRoot = "8:0";
            speakToUser("Yeni adresiniz kaydedildi. L√ºtfen telefon numaranƒ±zƒ± s√∂yleyin.");
            break;
			
        case 'go_back_address':
            currentRoot = "7:0";
            break;
            
        // Telefon aksiyonlarƒ±
        case 'set_phone':
            currentCustomer = { ...currentCustomer, phone: data.extractedData.phone };
            break;
			
        case 'check_phone':
            await checkCustomerByPhone(data.extractedData.phone);
            break;
			
        case 'retry_phone':
            currentRoot = "8:0";
            speakToUser("L√ºtfen telefon numaranƒ±zƒ± tekrar s√∂yleyin.");
            break;
			
        case 'go_back_phone':
            currentRoot = "8:0";
            break;
            
        // Sipari≈ü onay aksiyonlarƒ±
        case 'confirm_order':
            await finalizeOrder(currentPaymentMethod);
            currentRoot = "0:0";
            break;
			
        case 'cancel_order':
            cart = [];
            updateCartUI();
            currentRoot = "0:0";
            speakToUser("Sipari≈üiniz iptal edildi. Yeni bir sipari≈üe ba≈ülayabilirsiniz.");
            break;
            
        default:
            console.warn(`Bilinmeyen aksiyon: ${actionName}`);
    }
}

async function saveToAILearningCache(originalMessage, aiGeneratedResponse, originalRoot, aiSuggestedRoot, confidence, usedPatterns = null) {
    try {
        const { error } = await supabase
            .from('ai_learning_cache')
            .insert([{
                original_message: originalMessage,
                original_root: originalRoot,
                ai_generated_response: aiGeneratedResponse,
                ai_suggested_root: aiSuggestedRoot,
                confidence_score: confidence,
                used_patterns: usedPatterns,
                is_approved: false // Varsayƒ±lan olarak false
            }]);

        if (error) {
            console.error('‚ùå AI √∂ƒürenme kaydetme hatasƒ±:', error);
            return;
        }
        
        debugLog('‚úÖ AI √∂ƒürenme verisi kaydedildi');
    } catch (error) {
        console.error('‚ùå AI √∂ƒürenme kaydetme hatasƒ±:', error);
    }
}

	
// Sepet g√∂ster (oturum durumu bilgili)
async function showCartWithSessionStatus() {
    openCart();
    
    const currentCart = currentCustomer ? cart : pendingCart;
    const itemCount = currentCart.reduce((total, item) => total + item.quantity, 0);
    
    if (!currentCustomer) {
        speakToUser(`Sepetinizde ${itemCount} √ºr√ºn var. Misafir olarak alƒ±≈üveri≈ü yapƒ±yorsunuz. Sipari≈üi tamamlamak i√ßin giri≈ü yapmanƒ±z gerekecek.`);
    } else {
        speakToUser(`Sepetinizde ${itemCount} √ºr√ºn var. √ñdeme yapmak i√ßin '√∂deme' diyebilirsiniz.`);
    }
    
    currentRoot = "5:0";
}

// √ñdeme y√∂ntemi se√ß (oturum kontroll√º)
async function setPaymentWithSessionCheck(paymentMethod) {
    if (!currentCustomer) {
        speakToUser(`${paymentMethod} √∂deme se√ßildi. Sipari≈üi tamamlamak i√ßin telefon numaranƒ±zƒ± s√∂yleyin.`);
        pendingOrder = {
            cart: [...pendingCart],
            paymentMethod: paymentMethod
        };
        currentRoot = "8:0";
    } else {
        speakToUser(`${paymentMethod} √∂deme se√ßildi. Sipari≈üiniz tamamlanƒ±yor...`);
        await finalizeOrder(paymentMethod);
    }
}

// √ñdeme ba≈ülatma (oturum kontroll√º)
async function startPaymentWithSessionCheck() {
    const currentCart = currentCustomer ? cart : pendingCart;
    
    if (currentCart.length === 0) {
        speakToUser("Sepetiniz bo≈ü. √ñnce √ºr√ºn eklemelisiniz.");
        return;
    }
    
    openCart();
    
    if (!currentCustomer) {
        speakToUser(`Sepetinizde ${currentCart.length} √ºr√ºn var. Misafir olarak alƒ±≈üveri≈ü yapƒ±yorsunuz. Sipari≈üi tamamlamak i√ßin √∂deme y√∂ntemi se√ßin: nakit, kart veya bonus.`);
    } else {
        speakToUser(`Sepetinizde ${currentCart.length} √ºr√ºn var. √ñdeme y√∂ntemi se√ßin: nakit, kart veya bonus.`);
    }
    
    currentRoot = "6:0";
}

// Belirli √ºr√ºn ekleme
async function handleSpecificProduct(productName) {
    if (!productName) return;
    
    const foundProduct = findProductByName(productName);
    if (foundProduct) {
        addToCart(foundProduct, 1);
        speakToUser(`${foundProduct.name} sepete eklendi.`);
    }
}

// Yardƒ±mcƒ± fonksiyonlar
function extractNumber(message) {
    const numbers = message.match(/\d+/g);
    return numbers ? parseInt(numbers[0]) : 1;
}

async function selectSellerByIndex(index) {
    if (sellers.length >= index) {
        await selectSeller(sellers[index - 1]);
    }
}

async function selectCategoryByName(categoryName) {
    const category = categories.find(cat => cat.name.includes(categoryName));
    if (category) {
        const categoryCard = document.querySelector(`[data-category-id="${category.id}"]`);
        if (categoryCard) categoryCard.click();
    }
}

async function selectCategoryByIndex(index) {
    if (categories.length >= index) {
        const categoryCard = document.querySelectorAll('.category-card')[index - 1];
        if (categoryCard) categoryCard.click();
    }
}

// Numara ile √ºr√ºn ekleme
async function addProductByIndex(index) {
    if (products.length >= index) {
        const product = products[index - 1];
        addToCart(product, 1);
        speakToUser(`${product.name} sepete eklendi.`);
    } else {
        speakToUser(`${index}. √ºr√ºn bulunamadƒ±.`);
    }
}


// Mesajdan sayƒ± √ßƒ±kar
function extractNumberFromMessage(message) {
    const numbers = message.match(/\d+/g);
    return numbers ? parseInt(numbers[0]) : 1;
}

// Sesli √ºr√ºn eklemeyi test et - GELƒ∞≈ûMƒ∞≈û
function testVoiceProductAdd() {
    const testCommands = [
        "domates ekle",
        "iki soƒüan al",
        "bir ekmek ver",
        "s√ºt istiyorum",
        "peynir sepete ekle",
        "3 yumurta al"
    ];
    
    debugLog('üß™ √úr√ºn ekleme testi ba≈ülatƒ±lƒ±yor...');
    
    testCommands.forEach((command, index) => {
        setTimeout(() => {
            console.log(`üß™ Test ${index + 1}: "${command}"`);
            handleAddToCartCommand(command);
        }, index * 3000);
    });
}

	// Manuel test fonksiyonu
function manualProductTest() {
    debugLog('üîß Manuel √ºr√ºn testi ba≈ülatƒ±lƒ±yor...');
    
    // Mevcut √ºr√ºnleri kontrol et
    if (products.length === 0) {
        speakToUser("Hen√ºz √ºr√ºn y√ºklenmedi. L√ºtfen √∂nce bir reyon se√ßin.");
        return;
    }
    
    // ƒ∞lk √ºr√ºn√º ekle
    const firstProduct = products[0];
    if (firstProduct) {
        addToCart(firstProduct, 1);
        speakToUser(`Test: ${firstProduct.name} sepete eklendi.`);
    }
}
	
	// √úr√ºn bulmayƒ± test et
function testProductFinding() {
    const testProducts = ["ekmek", "s√ºt", "domates", "peynir", "yumurta"];
    
    testProducts.forEach(product => {
        const found = findProductByName(product);
        console.log(`üîç "${product}" -> ${found ? found.name : 'Bulunamadƒ±'}`);
    });
}

// =============================================
// DEBUG MODU ƒ∞Yƒ∞LE≈ûTƒ∞RMELERƒ∞
// =============================================

// Debug modunda otomatik test
if (DEBUG_MODE) {
    // Sayfa y√ºklendikten sonra testleri ba≈ülat
    setTimeout(() => {
        debugLog('üîß Debug modu aktif - Test fonksiyonlarƒ± hazƒ±r');
        
        // Test butonlarƒ± ekle (sadece debug modunda)
        addDebugButtons();
    }, 5000);
}

// Debug butonlarƒ± ekle
function addDebugButtons() {
    const debugPanel = document.createElement('div');
    debugPanel.style.cssText = `
        position: fixed;
        bottom: 80px;
        right: 20px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 8px;
        z-index: 10000;
        font-size: 12px;
    `;
    
    debugPanel.innerHTML = `
        <div style="margin-bottom: 5px;"><strong>üîß Debug Panel</strong></div>
        <button onclick="testVoiceProductAdd()" style="margin: 2px; padding: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">Test √úr√ºn Ekleme</button>
        <button onclick="manualProductTest()" style="margin: 2px; padding: 5px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">Manuel Test</button>
        <button onclick="openCart()" style="margin: 2px; padding: 5px; background: #ffc107; color: black; border: none; border-radius: 3px; cursor: pointer;">Sepeti A√ß</button>
        <button onclick="closeCart()" style="margin: 2px; padding: 5px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">Sepeti Kapat</button>
    `;
    
    document.body.appendChild(debugPanel);
}
// =============================================

// Sepet konteynƒ±rƒ±nƒ± g√ºncelle - OTURUM DURUMU G√ñSTER
function updateCartContainer() {
    const cartHeader = document.querySelector('.cart-header h2');
    if (cartHeader && !currentCustomer) {
        cartHeader.innerHTML = `Sepetiniz <small style="color: var(--accent);">(Misafir)</small>`;
    }
}


// Oturum deƒüi≈üikliklerini dinle
function setupSessionListeners() {
    // Oturum a√ßƒ±ldƒ±ƒüƒ±nda/kapandƒ±ƒüƒ±nda UI'ƒ± g√ºncelle
    const originalUpdateUIAfterLogin = updateUIAfterLogin;
    updateUIAfterLogin = function() {
        originalUpdateUIAfterLogin();
        updatePaymentButtons();
        updateCartContainer();
    };
}

// Uygulama ba≈ülatƒ±ldƒ±ƒüƒ±nda oturum dinleyicilerini kur
setupSessionListeners();

// =============================================
// SAYFA Y√úKLENDƒ∞ƒûƒ∞NDE OTURUM Sƒ∞STEMƒ∞Nƒ∞ BA≈ûLAT
// =============================================

// √ñdeme butonlarƒ±nƒ± g√ºncelle - OTURUM KONTROLL√ú
function updatePaymentButtons() {
    if (!payCashBtn || !payCardBtn || !payBonusBtn) return;
    
    if (!currentCustomer) {
        // Misafir modunda butonlarƒ± g√ºncelle
        payCashBtn.innerHTML = '<i class="fas fa-user-clock"></i> Giri≈ü Yap ve Nakit √ñde';
        payCardBtn.innerHTML = '<i class="fas fa-user-clock"></i> Giri≈ü Yap ve Kartla √ñde';
        payBonusBtn.innerHTML = '<i class="fas fa-user-clock"></i> Giri≈ü Yap ve Bonus ile √ñde';
        
        // Buton stillerini g√ºncelle
        [payCashBtn, payCardBtn, payBonusBtn].forEach(btn => {
            btn.style.background = 'var(--gray)';
            btn.style.opacity = '0.8';
        });
    } else {
        // Oturum a√ßƒ±kken normal butonlar
        payCashBtn.innerHTML = '<i class="fas fa-money-bill-wave"></i> Nakit √ñde';
        payCardBtn.innerHTML = '<i class="fas fa-credit-card"></i> Kartla √ñde';
        payBonusBtn.innerHTML = '<i class="fas fa-gift"></i> Bonus ile √ñde';
        
        // Buton stillerini sƒ±fƒ±rla
        payCashBtn.style.background = '';
        payCardBtn.style.background = '';
        payBonusBtn.style.background = '';
        payCashBtn.style.opacity = '';
        payCardBtn.style.opacity = '';
        payBonusBtn.style.opacity = '';
    }
}

// =============================================
// √úR√úN EKLEME KOMUTLARI ƒ∞√áƒ∞N KURAL G√úNCELLEMESƒ∞
// =============================================

// Komut kurallarƒ±nƒ± g√ºncelle - √úR√úN EKLEME ODAKLI
async function updateCommandRulesForProducts() {
    try {
        const productRules = [
            {
                root_code: '4:0',
                input_patterns: 'ekle|sepete ekle|al|ver|istiyorum',
                output_text: '√úr√ºn sepete eklendi.',
                next_root: '4:0',
                action_name: 'add_to_cart_voice',
                is_active: true,
                priority: 95
            },
            {
                root_code: '4:0',
                input_patterns: 'sepet|sepete git|sepetim',
                output_text: 'Sepetiniz g√∂steriliyor.',
                next_root: '5:0',
                action_name: 'show_cart_auto',
                is_active: true,
                priority: 90
            }
        ];

        // Bu kurallarƒ± veritabanƒ±na ekle
        for (const rule of productRules) {
            const { error } = await supabase
                .from('voice_command_rules')
                .upsert(rule, { onConflict: 'root_code,input_patterns' });

            if (error) {
                console.error('‚ùå Kural ekleme hatasƒ±:', error);
            }
        }

        console.log('‚úÖ √úr√ºn ekleme kurallarƒ± g√ºncellendi');
    } catch (error) {
        console.error('‚ùå Kural g√ºncelleme hatasƒ±:', error);
    }
}

	
// √úr√ºn kartlarƒ±na sesli ekleme butonu ekle
function enhanceProductCardsForVoice() {
    const productCards = document.querySelectorAll('.product-card');
    
    productCards.forEach((card, index) => {
        const productName = card.querySelector('.product-name')?.textContent;
        if (productName) {
            // Sesli komut ipucu ekle
            const voiceHint = document.createElement('div');
            voiceHint.className = 'voice-hint';
            voiceHint.style.cssText = `
                font-size: 12px;
                color: var(--primary);
                margin-top: 5px;
                cursor: pointer;
            `;
            voiceHint.textContent = `Sesle ekle: "${productName}" veya "${index + 1} numara"`;
            voiceHint.onclick = () => {
                speakToUser(`"${productName}" sesli komutla eklenebilir.`);
            };
            
            card.querySelector('.product-info')?.appendChild(voiceHint);
        }
    });
}

// √úr√ºnler g√∂sterildiƒüinde sesli ipu√ßlarƒ±nƒ± ekle
const originalDisplayProducts = displayProducts;
displayProducts = function(productsToShow) {
    originalDisplayProducts(productsToShow);
    setTimeout(enhanceProductCardsForVoice, 100);
};
	
// =============================================
// YARDIMCI FONKSƒ∞YONLAR
// =============================================

function calculateCartTotal() {
    return cart.reduce((total, item) => total + (item.price * item.quantity), 0) * 1.18;
}

function getAvailableProducts() {
    if (products.length === 0) return "Hen√ºz √ºr√ºn y√ºklenmedi.";
    return products.slice(0, 5).map(p => p.name).join(', ');
}

// √úr√ºn ekleme komutunu i≈üle - YENƒ∞ FONKSƒ∞YON
function handleAddToCartCommand(message) {
    debugLog(`üõí √úr√ºn ekleme komutu i≈üleniyor: "${message}"`);
    
    if (!selectedSellerId) {
        speakToUser("√ñnce bir satƒ±cƒ± se√ßmelisiniz.");
        return;
    }
    
    if (products.length === 0) {
        speakToUser("Hen√ºz √ºr√ºn y√ºklenmedi. L√ºtfen bir reyon se√ßin.");
        return;
    }
    
    // √úr√ºn bilgisini √ßƒ±kar
    const productInfo = extractProductInfoFromCommand(message);
    
    if (productInfo) {
        const { productName, quantity } = productInfo;
        const foundProduct = findProductByName(productName);
        
        if (foundProduct) {
            addToCart(foundProduct, quantity);
            speakToUser(`${quantity} adet ${productName} sepete eklendi.`);
            
            // Ba≈üarƒ±lƒ± √ºr√ºn ekleme sonrasƒ± AI √∂ƒürenmesi
            saveSuccessfulProductMatch(message, productName);
        } else {
            handleProductNotFound(message, productName);
        }
    } else {
        speakToUser("√úr√ºn ismini anlayamadƒ±m. L√ºtfen 'iki ekmek' veya 's√ºt ekle' gibi s√∂yleyin.");
    }
}

// Sesli komuttan √ºr√ºn bilgisini √ßƒ±kar - GELƒ∞≈ûMƒ∞≈û FONKSƒ∞YON
function extractProductInfoFromCommand(message) {
    // "ekle", "sepete", "al" gibi kelimeleri √ßƒ±kar
    let cleanMessage = message.replace(/(ekle|sepete|al|istiyorum|l√ºtfen)/g, '').trim();

    // Sayƒ±larƒ± bul (varsa)
    let quantity = 1;
    const numbers = cleanMessage.match(/\d+/g);
    if (numbers && numbers.length > 0) {
        quantity = parseInt(numbers[0]);
        cleanMessage = cleanMessage.replace(numbers[0], '').trim();
    }

    // "bir" gibi ifadeleri de sayƒ±ya √ßevirebiliriz
    const numberWords = {
        'bir': 1, 'iki': 2, '√º√ß': 3, 'd√∂rt': 4, 'be≈ü': 5,
        'altƒ±': 6, 'yedi': 7, 'sekiz': 8, 'dokuz': 9, 'on': 10
    };
    for (const [word, num] of Object.entries(numberWords)) {
        if (cleanMessage.includes(word)) {
            quantity = num;
            cleanMessage = cleanMessage.replace(word, '').trim();
            break;
        }
    }

    // √úr√ºn ismi kalan kƒ±sƒ±m
    const productName = cleanMessage.replace(/\s+/g, ' ').trim();

    return { productName, quantity };
}

// Sesli √ºr√ºn ekleme komutunu i≈üle - TAMƒ∞R EDƒ∞LMƒ∞≈û
async function handleAddToCartCommand(message) {
    debugLog(`üõí √úr√ºn ekleme komutu i≈üleniyor: "${message}"`);
    
    if (!selectedSellerId) {
        speakToUser("√ñnce bir satƒ±cƒ± se√ßmelisiniz.");
        return;
    }
    
    if (products.length === 0) {
        speakToUser("Hen√ºz √ºr√ºn y√ºklenmedi. L√ºtfen bir reyon se√ßin.");
        return;
    }
    
    // √úr√ºn bilgisini √ßƒ±kar
    const productInfo = extractProductInfoFromCommand(message);
    
    if (productInfo && productInfo.productName) {
        const { productName, quantity } = productInfo;
        debugLog(`üîç Aranan √ºr√ºn: "${productName}", Miktar: ${quantity}`);
        
        const foundProduct = findProductByName(productName);
        
        if (foundProduct) {
            addToCart(foundProduct, quantity);
            speakToUser(`${quantity} adet ${foundProduct.name} sepete eklendi.`);
            
            // Sepeti otomatik a√ß
            setTimeout(() => {
                openCart();
            }, 500);
            
            // Ba≈üarƒ±lƒ± √ºr√ºn ekleme sonrasƒ± AI √∂ƒürenmesi
            saveSuccessfulProductMatch(message, foundProduct.name);
        } else {
            handleProductNotFound(message, productName);
        }
    } else {
        speakToUser("√úr√ºn ismini anlayamadƒ±m. L√ºtfen 'iki ekmek' veya 's√ºt ekle' gibi s√∂yleyin.");
    }
}
	
// √úr√ºn ismine g√∂re bul - GELƒ∞≈ûMƒ∞≈û E≈ûLE≈ûTƒ∞RME
function findProductByName(productName) {
    if (!products || products.length === 0) {
        debugLog('‚ùå √úr√ºn listesi bo≈ü');
        return null;
    }
    
    const cleanProductName = productName.toLowerCase()
        .replace(/[^\w\sƒü√º≈üƒ±√∂√ßƒû√ú≈ûƒ∞√ñ√á]/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    
    debugLog(`üîç √úr√ºn aranƒ±yor: "${cleanProductName}" - Toplam ${products.length} √ºr√ºn`);
    
    // Mevcut √ºr√ºnleri debug et
    products.forEach((p, i) => {
        debugLog(`üì¶ √úr√ºn ${i+1}: "${p.name}" -> "${p.name.toLowerCase()}"`);
    });
    
    // 1. Tam e≈üle≈üme (T√ºrk√ße karakter desteƒüi)
    let found = products.find(p => 
        p.name.toLowerCase().replace(/[^\w\sƒü√º≈üƒ±√∂√ßƒû√ú≈ûƒ∞√ñ√á]/g, '') === cleanProductName
    );
    if (found) {
        debugLog(`‚úÖ Tam e≈üle≈üme: ${found.name}`);
        return found;
    }
    
    // 2. T√ºrk√ße karakter esnek e≈üle≈üme
    found = products.find(p => {
        const cleanProductName2 = cleanProductName
            .replace(/ƒü/g, 'g').replace(/√º/g, 'u').replace(/≈ü/g, 's').replace(/ƒ±/g, 'i').replace(/√∂/g, 'o').replace(/√ß/g, 'c');
        
        const cleanPName = p.name.toLowerCase()
            .replace(/[^\w\sƒü√º≈üƒ±√∂√ßƒû√ú≈ûƒ∞√ñ√á]/g, '')
            .replace(/ƒü/g, 'g').replace(/√º/g, 'u').replace(/≈ü/g, 's').replace(/ƒ±/g, 'i').replace(/√∂/g, 'o').replace(/√ß/g, 'c');
        
        return cleanPName === cleanProductName2;
    });
    if (found) {
        debugLog(`‚úÖ T√ºrk√ße karakter e≈üle≈üme: ${found.name}`);
        return found;
    }
    
    // 3. Kelime e≈üle≈ümesi (t√ºm kelimeler)
    const searchWords = cleanProductName.split(' ');
    found = products.find(product => {
        const productNameClean = product.name.toLowerCase().replace(/[^\w\sƒü√º≈üƒ±√∂√ßƒû√ú≈ûƒ∞√ñ√á]/g, '');
        const productWords = productNameClean.split(' ');
        
        return searchWords.every(word => 
            productWords.some(pWord => pWord.includes(word) || word.includes(pWord))
        );
    });
    if (found) {
        debugLog(`‚úÖ Kelime e≈üle≈ümesi: ${found.name}`);
        return found;
    }
    
    // 4. Kƒ±smi e≈üle≈üme
    found = products.find(product => {
        const productNameClean = product.name.toLowerCase().replace(/[^\w\sƒü√º≈üƒ±√∂√ßƒû√ú≈ûƒ∞√ñ√á]/g, '');
        return productNameClean.includes(cleanProductName) || cleanProductName.includes(productNameClean);
    });
    if (found) {
        debugLog(`‚úÖ Kƒ±smi e≈üle≈üme: ${found.name}`);
        return found;
    }
    
    // 5. Benzerlik e≈üle≈ümesi
    found = findProductBySimilarity(cleanProductName);
    if (found) {
        debugLog(`‚úÖ Benzerlik e≈üle≈ümesi: ${found.name}`);
        return found;
    }
    
    debugLog(`‚ùå √úr√ºn bulunamadƒ±: ${cleanProductName}`);
    return null;
}
	
// Benzerlik e≈üle≈ümesi - LEVENSHTEIN DISTANCE
function findProductBySimilarity(searchName) {
    let bestMatch = null;
    let bestScore = 0;
    
    products.forEach(product => {
        const productName = product.name.toLowerCase();
        const score = calculateSimilarity(searchName, productName);
        
        if (score > bestScore && score > 0.6) { // %60 benzerlik e≈üiƒüi
            bestScore = score;
            bestMatch = product;
        }
    });
    
    return bestMatch;
}

// Benzerlik hesaplama
function calculateSimilarity(str1, str2) {
    const longer = str1.length > str2.length ? str1 : str2;
    const shorter = str1.length > str2.length ? str2 : str1;
    
    if (longer.length === 0) return 1.0;
    
    // Levenshtein distance basitle≈ütirilmi≈ü
    const distance = levenshteinDistance(str1, str2);
    return (longer.length - distance) / longer.length;
}

// Levenshtein distance hesaplama
function levenshteinDistance(str1, str2) {
    const matrix = [];
    
    for (let i = 0; i <= str2.length; i++) {
        matrix[i] = [i];
    }
    
    for (let j = 0; j <= str1.length; j++) {
        matrix[0][j] = j;
    }
    
    for (let i = 1; i <= str2.length; i++) {
        for (let j = 1; j <= str1.length; j++) {
            if (str2.charAt(i-1) === str1.charAt(j-1)) {
                matrix[i][j] = matrix[i-1][j-1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i-1][j-1] + 1,
                    matrix[i][j-1] + 1,
                    matrix[i-1][j] + 1
                );
            }
        }
    }
    
    return matrix[str2.length][str1.length];
}

// √úr√ºn bulunamadƒ± durumu
function handleProductNotFound(message, attemptedName) {
    debugLog(`‚ùå √úr√ºn bulunamadƒ±: "${attemptedName}"`);
    
    // Mevcut √ºr√ºn √∂nerileri
    const availableProducts = products.slice(0, 5).map(p => p.name);
    
    if (availableProducts.length > 0) {
        speakToUser(`"${attemptedName}" bulunamadƒ±. Mevcut √ºr√ºnler: ${availableProducts.join(', ')}`);
    } else {
        speakToUser("Hen√ºz √ºr√ºn y√ºklenmedi. L√ºtfen bir reyon se√ßin.");
    }
    
    // AI √∂ƒürenmesi i√ßin kaydet
    saveFailedProductMatch(message, attemptedName);
}

// Ba≈üarƒ±lƒ± e≈üle≈ümeleri kaydet
async function saveSuccessfulProductMatch(userInput, matchedProduct) {
    try {
        await supabase
            .from('product_voice_matches')
            .insert([{
                user_input: userInput,
                matched_product: matchedProduct,
                success: true,
                created_at: new Date().toISOString()
            }]);
    } catch (error) {
        console.error('√úr√ºn e≈üle≈üme kaydetme hatasƒ±:', error);
    }
}

// Ba≈üarƒ±sƒ±z e≈üle≈ümeleri kaydet
async function saveFailedProductMatch(userInput, attemptedMatch) {
    try {
        await supabase
            .from('product_voice_matches')
            .insert([{
                user_input: userInput,
                attempted_match: attemptedMatch,
                success: false,
                created_at: new Date().toISOString()
            }]);
    } catch (error) {
        console.error('√úr√ºn e≈üle≈üme kaydetme hatasƒ±:', error);
    }
}

// Satƒ±cƒ±larƒ± mesafeye g√∂re filtrele
async function filterSellersByDistance(sellers) {
    const sellersWithinRange = [];
    
    for (const seller of sellers) {
        // Satƒ±cƒ±nƒ±n konumu yoksa listeye ekle (esnek davran)
        if (!seller.latitude || !seller.longitude) {
            sellersWithinRange.push(seller);
            continue;
        }
        
        const distance = calculateDistance(
            userLocation.latitude,
            userLocation.longitude,
            seller.latitude,
            seller.longitude
        );
        
        const deliveryRadius = seller.delivery_radius || 10; // Varsayƒ±lan 10 km
        
        if (distance <= deliveryRadius) {
            sellersWithinRange.push(seller);
        }
    }
    
    return sellersWithinRange;
}

// =============================================
// 3. B√ñL√úM: SEPET VE Sƒ∞PARƒ∞≈û ƒ∞≈ûLEMLERƒ∞
// =============================================

// Satƒ±cƒ± √ºr√ºnlerini y√ºkle - TAMƒ∞R EDƒ∞LMƒ∞≈û
async function loadSellerProducts(sellerId) {
    try {
        debugLog(`üì¶ Satƒ±cƒ± √ºr√ºnleri y√ºkleniyor: ${sellerId}`);
        
        const { data, error } = await supabase
            .from('product_prices')
            .select(`
                *,
                products (
                    id, name, imgurl, reyon_id, category_id, is_active
                )
            `)
            .eq('seller_id', sellerId)
            .eq('products.is_active', true);

        if (error) {
            console.error('‚ùå √úr√ºn y√ºkleme hatasƒ±:', error);
            throw error;
        }

        // Veriyi i≈üle
        products = data
            .filter(item => item.products) // products null olmayanlarƒ± filtrele
            .map(item => ({
                id: item.products.id,
                product_price_id: item.id,
                name: item.products.name,
                price: item.price,
                discount_price: item.discount_price,
                imgurl: item.products.imgurl,
                reyon_id: item.products.reyon_id,
                category_id: item.products.category_id,
                seller_id: sellerId
            }));

        debugLog(`‚úÖ √úr√ºnler y√ºklendi: ${products.length} adet`);
        
        // Reyona g√∂re √ºr√ºnleri grupla ve g√∂ster
        displayProductsByReyon(products);
        
        // Reyonlarƒ± g√ºncelle (mevcut reyonlarla e≈üle≈üen)
        updateReyonsWithProducts(products);

    } catch (error) {
        console.error('‚ùå √úr√ºn y√ºkleme hatasƒ±:', error);
        products = getDemoProducts();
        displayProducts(products);
        debugLog('üîÑ Demo √ºr√ºnler kullanƒ±lƒ±yor');
    }
}

// √úr√ºnleri g√∂ster
function displayProducts(productsToShow) {
    const productsGrid = document.getElementById('productsGrid');
    if (!productsGrid) return;
    
    productsGrid.innerHTML = '';
    
    if (productsToShow.length === 0) {
        productsGrid.innerHTML = `
            <div class="text-center" style="grid-column: 1 / -1; padding: 40px; color: #6c757d;">
                <i class="fas fa-box-open fa-3x mb-3"></i>
                <p>Bu kategoride √ºr√ºn bulunamadƒ±</p>
            </div>
        `;
        return;
    }
    
    productsToShow.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card';
        
        let badgeHTML = '';
        if (product.discount_price && product.discount_price < product.price) {
            badgeHTML = `<div class="product-badge">ƒ∞ndirim</div>`;
        }
        
        let priceHTML = `<div class="product-price">${money(product.price)}</div>`;
        if (product.discount_price && product.discount_price < product.price) {
            priceHTML = `
                <div>
                    <span class="product-price">${money(product.discount_price)}</span>
                    <span class="product-discount">${money(product.price)}</span>
                </div>
            `;
        }
        
        productCard.innerHTML = `
            ${badgeHTML}
            <img src="${product.imgurl || 'https://via.placeholder.com/150x100?text=√úr√ºn'}" alt="${product.name}" class="product-image">
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                ${priceHTML}
                <button class="add-to-cart-btn" data-id="${product.id}" style="margin-top: 10px; width: 100%; padding: 8px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">Sepete Ekle</button>
            </div>
        `;
        
        const addToCartBtn = productCard.querySelector('.add-to-cart-btn');
        addToCartBtn.addEventListener('click', function() {
            addToCart(product, 1, productCard);
        });
        
        productsGrid.appendChild(productCard);
    });
}


// Sepete √ºr√ºn ekle - OTURUM KONTROLL√ú
// Sepete √ºr√ºn ekle - OTOMATƒ∞K SEPET A√áMA
function addToCart(product, quantity, productElement = null) {
    // Oturum kontrol√º
    if (!currentCustomer) {
        addToGuestCart(product, quantity, productElement);
        return;
    }
    
    const existingItem = cart.find(item => item.id === product.id);
    
    if (existingItem) {
        existingItem.quantity += quantity;
    } else {
        cart.push({ 
            id: product.id, 
            product_price_id: product.product_price_id, 
            name: product.name, 
            price: product.discount_price || product.price, 
            quantity: quantity, 
            imgurl: product.imgurl,
            seller_id: product.seller_id
        });
    }
    
    // Satƒ±cƒ± kilidini aktif et
    if (!isSellerLocked) {
        isSellerLocked = true;
        updateSellersGrid();
    }
    
    updateCartUI();
    
    // Sepeti otomatik a√ß (ilk √ºr√ºn eklenince)
    if (cart.length === 1) {
        setTimeout(() => {
            openCart();
            debugLog('üõí Sepet otomatik a√ßƒ±ldƒ± (ilk √ºr√ºn eklendi)');
        }, 300);
    }
    
    // Animasyon efekti
    if (productElement) {
        productElement.style.transform = 'scale(0.95)';
        setTimeout(() => {
            productElement.style.transform = 'scale(1)';
        }, 200);
    }
    
    speakToUser(`${product.name} sepete eklendi.`);
}




// Misafir sepet UI'ƒ±nƒ± g√ºncelle
function updateGuestCartUI() {
    if (!cartItems) return;
    
    cartItems.innerHTML = '';
    
    if (pendingCart.length === 0) {
        cartItems.innerHTML = `
            <div class="text-center" style="padding: 30px; color: #6c757d;">
                <i class="fas fa-shopping-cart fa-2x mb-3"></i>
                <p>Sepetiniz bo≈ü</p>
            </div>
        `;
        if (orderCount) orderCount.textContent = "0";
        if (orderTotal) orderTotal.textContent = "0 ‚Ç∫";
        
        // Sepet bo≈üsa satƒ±cƒ± kilidini kaldƒ±r
        if (isSellerLocked) {
            isSellerLocked = false;
            updateSellersGrid();
        }
    } else {
        pendingCart.forEach(item => {
            const cartItem = document.createElement('div');
            cartItem.className = 'cart-item';
            cartItem.innerHTML = `
                <div class="cart-item-info">
                    <img src="${item.imgurl || 'https://via.placeholder.com/40x40?text=√úr√ºn'}" alt="${item.name}" class="cart-item-image">
                    <div class="cart-item-details">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${money(item.price)}</div>
                    </div>
                </div>
                <div class="cart-item-controls">
                    <button class="quantity-btn decrease" data-id="${item.id}">-</button>
                    <span>${item.quantity}</span>
                    <button class="quantity-btn increase" data-id="${item.id}">+</button>
                </div>
            `;
            
            cartItems.appendChild(cartItem);
        });
        
        // Misafir uyarƒ±sƒ± ekle
        const guestWarning = document.createElement('div');
        guestWarning.className = 'guest-warning';
        guestWarning.style.cssText = `
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
        `;
        guestWarning.innerHTML = `
            <i class="fas fa-info-circle" style="color: #856404;"></i>
            <strong style="color: #856404;">Misafir Modu</strong>
            <div style="font-size: 12px; margin-top: 5px; color: #856404;">
                Sipari≈üi tamamlamak i√ßin giri≈ü yapmalƒ±sƒ±nƒ±z.
            </div>
        `;
        cartItems.appendChild(guestWarning);
        
        if (orderCount) orderCount.textContent = pendingCart.reduce((total, item) => total + item.quantity, 0);
        
        // Miktar butonlarƒ±na event listener ekle
        document.querySelectorAll('.decrease').forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.dataset.id;
                updateGuestCartItemQuantity(productId, -1);
            });
        });
        
        document.querySelectorAll('.increase').forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.dataset.id;
                updateGuestCartItemQuantity(productId, 1);
            });
        });
    }
    
    // Toplamlarƒ± g√ºncelle
    updateGuestCartTotals();
}

// Misafir sepet toplamlarƒ±nƒ± g√ºncelle
function updateGuestCartTotals() {
    const subtotal = pendingCart.reduce((total, item) => total + (item.price * item.quantity), 0);
    const vat = subtotal * 0.18;
    const total = subtotal + vat;
    
    if (subtotalEl) subtotalEl.textContent = money(subtotal);
    if (vatAmountEl) vatAmountEl.textContent = money(vat);
    if (totalAmountEl) totalAmountEl.textContent = money(total);
    if (orderTotal) orderTotal.textContent = money(total);
}

// Misafir sepet √ºr√ºn miktarƒ±nƒ± g√ºncelle
function updateGuestCartItemQuantity(productId, change) {
    const item = pendingCart.find(item => item.id === productId);
    if (item) {
        item.quantity += change;
        
        if (item.quantity <= 0) {
            pendingCart = pendingCart.filter(item => item.id !== productId);
        }
        
        updateGuestCartUI();
    }
}

// Oturum a√ßƒ±ldƒ±ƒüƒ±nda misafir sepetini aktar
function transferGuestCartToUser() {
    if (pendingCart.length > 0 && currentCustomer) {
        cart = [...pendingCart];
        pendingCart = [];
        isGuestMode = false;
        updateCartUI();
        speakToUser("Sepetiniz oturumunuza aktarƒ±ldƒ±. Sipari≈üinizi tamamlayabilirsiniz.");
    }
}

// Misafir sepetine √ºr√ºn ekle - OTOMATƒ∞K SEPET A√áMA
function addToGuestCart(product, quantity, productElement = null) {
    isGuestMode = true;
    
    const existingItem = pendingCart.find(item => item.id === product.id);
    
    if (existingItem) {
        existingItem.quantity += quantity;
    } else {
        pendingCart.push({ 
            id: product.id, 
            product_price_id: product.product_price_id, 
            name: product.name, 
            price: product.discount_price || product.price, 
            quantity: quantity, 
            imgurl: product.imgurl,
            seller_id: product.seller_id
        });
    }
    
    // Satƒ±cƒ± kilidini aktif et
    if (!isSellerLocked) {
        isSellerLocked = true;
        updateSellersGrid();
    }
    
    updateGuestCartUI();
    
    // Sepeti otomatik a√ß (ilk √ºr√ºn eklenince)
    if (pendingCart.length === 1) {
        setTimeout(() => {
            openCart();
            debugLog('üõí Misafir sepeti otomatik a√ßƒ±ldƒ± (ilk √ºr√ºn eklendi)');
        }, 300);
    }
    
    // Animasyon efekti
    if (productElement) {
        productElement.style.transform = 'scale(0.95)';
        setTimeout(() => {
            productElement.style.transform = 'scale(1)';
        }, 200);
    }
    
    speakToUser(`${product.name} sepete eklendi. Misafir olarak alƒ±≈üveri≈ü yapƒ±yorsunuz. Sipari≈üi tamamlamak i√ßin giri≈ü yapmanƒ±z gerekecek.`);
}

// Sepet UI'ƒ±nƒ± g√ºncelle
function updateCartUI() {
    if (!cartItems) return;
    
    cartItems.innerHTML = '';
    
    if (cart.length === 0) {
        cartItems.innerHTML = `
            <div class="text-center" style="padding: 30px; color: #6c757d;">
                <i class="fas fa-shopping-cart fa-2x mb-3"></i>
                <p>Sepetiniz bo≈ü</p>
            </div>
        `;
        if (orderCount) orderCount.textContent = "0";
        if (orderTotal) orderTotal.textContent = "0 ‚Ç∫";
        
        // Sepet bo≈üsa satƒ±cƒ± kilidini kaldƒ±r
        if (isSellerLocked) {
            isSellerLocked = false;
            updateSellersGrid();
        }
    } else {
        cart.forEach(item => {
            const cartItem = document.createElement('div');
            cartItem.className = 'cart-item';
            cartItem.innerHTML = `
                <div class="cart-item-info">
                    <img src="${item.imgurl || 'https://via.placeholder.com/40x40?text=√úr√ºn'}" alt="${item.name}" class="cart-item-image">
                    <div class="cart-item-details">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${money(item.price)}</div>
                    </div>
                </div>
                <div class="cart-item-controls">
                    <button class="quantity-btn decrease" data-id="${item.id}">-</button>
                    <span>${item.quantity}</span>
                    <button class="quantity-btn increase" data-id="${item.id}">+</button>
                </div>
            `;
            
            cartItems.appendChild(cartItem);
        });
        
        if (orderCount) orderCount.textContent = cart.reduce((total, item) => total + item.quantity, 0);
        
        // Miktar butonlarƒ±na event listener ekle
        document.querySelectorAll('.decrease').forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.dataset.id;
                updateCartItemQuantity(productId, -1);
            });
        });
        
        document.querySelectorAll('.increase').forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.dataset.id;
                updateCartItemQuantity(productId, 1);
            });
        });
    }
    
    // Toplamlarƒ± g√ºncelle
    updateCartTotals();
}

// Sepet toplamlarƒ±nƒ± g√ºncelle
function updateCartTotals() {
    const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
    const vat = subtotal * 0.18;
    const total = subtotal + vat;
    
    if (subtotalEl) subtotalEl.textContent = money(subtotal);
    if (vatAmountEl) vatAmountEl.textContent = money(vat);
    if (totalAmountEl) totalAmountEl.textContent = money(total);
    if (orderTotal) orderTotal.textContent = money(total);
}

// Sepet √ºr√ºn miktarƒ±nƒ± g√ºncelle
function updateCartItemQuantity(productId, change) {
    const item = cart.find(item => item.id === productId);
    if (item) {
        item.quantity += change;
        
        if (item.quantity <= 0) {
            cart = cart.filter(item => item.id !== productId);
        }
        
        updateCartUI();
    }
}

// =============================================
// 3. Sƒ∞PARƒ∞≈û TAMAMLAMA Sƒ∞STEMƒ∞
// =============================================

// Sipari≈ü tamamlama - KONUM FARKI NOTU EKLE
// Sipari≈ü tamamlama - OTURUM KONTROLL√ú
async function finalizeOrder(paymentMethod) {
    // Kullanƒ±lacak sepeti belirle
    const currentCart = currentCustomer ? cart : pendingCart;
    
    if (currentCart.length === 0) {
        speakToUser("Sepetiniz bo≈ü. L√ºtfen √∂nce √ºr√ºn ekleyin.");
        return;
    }
    
    if (!selectedSellerId) {
        speakToUser("L√ºtfen √∂nce bir satƒ±cƒ± se√ßin.");
        return;
    }
    
    if (!selectedLocation) {
        speakToUser("L√ºtfen teslimat konumunuzu se√ßin.");
        showLocationModal();
        return;
    }
    
    const subtotal = currentCart.reduce((total, item) => total + (item.price * item.quantity), 0);
    const vat = subtotal * 0.18;
    const total = subtotal + vat;
    
    // Oturum kontrol√º
    if (!currentCustomer) {
        // Misafir modunda - giri≈ü yapmasƒ±nƒ± iste
        pendingOrder = {
            cart: [...currentCart],
            paymentMethod: paymentMethod,
            subtotal: subtotal,
            total: total
        };
        
        speakToUser(`Sipari≈üiniz hazƒ±r! Toplam: ${money(total)}. Sipari≈üi tamamlamak i√ßin l√ºtfen telefon numaranƒ±zƒ± s√∂yleyin.`);
        currentRoot = "8:0"; // Telefon numarasƒ± alma k√∂k√ºne git
        return;
    }
    
    // Oturum varsa normal sipari≈ü i≈ülemi
    try {
        // KONUM FARKI NOTU HAZIRLA
        let orderNotes = "";
        if (currentCustomer && currentCustomer.address && isLocationDetected) {
            const currentAddress = `${userLocation.district}, ${userLocation.city}`;
            const savedAddress = currentCustomer.address;
            
            // Adresler farklƒ±ysa not ekle
            if (!savedAddress.includes(currentAddress)) {
                orderNotes = `Kullanƒ±cƒ±nƒ±n kayƒ±tlƒ± adresi: ${savedAddress}. Mevcut konum: ${currentAddress}.`;
                debugLog('üìç Konum farkƒ± sipari≈ü notuna eklendi:', orderNotes);
            }
        }
        
        // 1. Sipari≈üi kaydet
        const { data: order, error: orderError } = await supabase
            .from('orders')
            .insert([{
                customer_id: currentCustomer.id,
                seller_id: selectedSellerId,
                total_amount: total,
                payment_method: paymentMethod,
                status: 'pending',
                location: selectedLocation,
                order_notes: orderNotes,
                order_date: new Date().toISOString()
            }])
            .select()
            .single();
        
        if (orderError) throw orderError;
        
        // 2. Sipari≈ü detaylarƒ±nƒ± kaydet
        const orderDetails = currentCart.map(item => ({
            order_id: order.id,
            product_id: item.id,
            product_price_id: item.product_price_id,
            quantity: item.quantity,
            unit_price: item.price,
            tax_rate: 18
        }));
        
        const { error: detailsError } = await supabase
            .from('order_details')
            .insert(orderDetails);
        
        if (detailsError) throw detailsError;
        
        // 3. Bonus kullanƒ±mƒ±
        if (paymentMethod === 'bonus' && currentCustomer.bonus_amount >= total) {
            const newBonus = currentCustomer.bonus_amount - total;
            await supabase
                .from('customers')
                .update({ bonus_amount: newBonus })
                .eq('id', currentCustomer.id);
                
            currentCustomer.bonus_amount = newBonus;
            updateCustomerUI();
        }
        
        speakToUser(`Sipari≈üiniz alƒ±ndƒ±! Sipari≈ü numaranƒ±z: ${order.id}. Toplam: ${money(total)}`);
        
        // 4. Sepeti temizle
        setTimeout(() => {
            cart = [];
            pendingCart = [];
            updateCartUI();
            updateGuestCartUI();
            isSellerLocked = false;
            updateSellersGrid();
            pendingOrder = null;
        }, 3000);
        
    } catch (error) {
        console.error('Sipari≈ü hatasƒ±:', error);
        speakToUser("Sipari≈üiniz alƒ±nƒ±rken bir hata olu≈ütu. L√ºtfen tekrar deneyin.");
    }
}

// Bekleyen sipari≈üi tamamla (oturum a√ßƒ±ldƒ±ktan sonra)
async function completePendingOrder() {
    if (pendingOrder && currentCustomer) {
        const { paymentMethod } = pendingOrder;
        
        // Sepeti aktar
        cart = [...pendingOrder.cart];
        pendingCart = [];
        
        // Sipari≈üi tamamla
        await finalizeOrder(paymentMethod);
        pendingOrder = null;
    }
}

// Adres onayƒ± ba≈ülatma
function startAddressConfirmation(total) {
    if (currentCustomer && currentCustomer.address) {
        speakToUser(`√ñdeme y√∂ntemi: ${currentPaymentMethod}. Toplam: ${money(total)}. Teslimat adresiniz: ${currentCustomer.address}. Doƒüru mu?`);
        commandRoot = "5:2";
    } else {
        speakToUser(`√ñdeme y√∂ntemi: ${currentPaymentMethod}. Toplam: ${money(total)}. L√ºtfen teslimat adresinizi s√∂yler misiniz?`);
        commandRoot = "5:3";
    }
}


// Teslimat mesafesi kontrol√º
async function checkDeliveryDistance() {
    if (!selectedSellerId || !userLocation.latitude || !userLocation.longitude) {
        console.error('Mesafe kontrol√º i√ßin gerekli bilgiler eksik');
        return false;
    }
    
    try {
        // Satƒ±cƒ±nƒ±n konum bilgisini al
        const { data: seller, error } = await supabase
            .from('seller_profiles')
            .select('latitude, longitude, delivery_radius')
            .eq('id', selectedSellerId)
            .single();
            
        if (error || !seller) {
            console.error('Satƒ±cƒ± bilgisi alƒ±namadƒ±:', error);
            return true; // Hata durumunda teslimata izin ver (esnek davran)
        }
        
        // Satƒ±cƒ±nƒ±n teslimat yarƒ±√ßapƒ± (km cinsinden) - varsayƒ±lan 10 km
        const deliveryRadius = seller.delivery_radius || 10;
        
        // Mesafe hesapla
        const distance = calculateDistance(
            userLocation.latitude,
            userLocation.longitude,
            seller.latitude,
            seller.longitude
        );
        
        debugLog(`üìç Mesafe kontrol√º: ${distance.toFixed(2)} km (Sƒ±nƒ±r: ${deliveryRadius} km)`);
        
        return distance <= deliveryRadius;
        
    } catch (error) {
        console.error('Mesafe kontrol√º hatasƒ±:', error);
        return true; // Hata durumunda teslimata izin ver
    }
}


// ƒ∞ki koordinat arasƒ±ndaki mesafeyi hesapla (Haversine form√ºl√º)
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // D√ºnya yarƒ±√ßapƒ± (km)
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R * c;
    return distance;
}

// Sepet a√ßma fonksiyonu - G√úVENLƒ∞
function openCart() {
    try {
        if (cartContainer) {
            cartContainer.classList.add('open');
            debugLog('üõí Sepet a√ßƒ±ldƒ±');
            
            // Sepet i√ßeriƒüini g√ºncelle
            if (currentCustomer) {
                updateCartUI();
            } else {
                updateGuestCartUI();
            }
        } else {
            console.error('‚ùå Sepet konteynƒ±rƒ± bulunamadƒ±');
        }
    } catch (error) {
        console.error('‚ùå Sepet a√ßma hatasƒ±:', error);
    }
}

	// Sepet kapatma fonksiyonu - G√úVENLƒ∞
function closeCart() {
    try {
        if (cartContainer) {
            cartContainer.classList.remove('open');
            debugLog('üõí Sepet kapandƒ±');
        }
    } catch (error) {
        console.error('‚ùå Sepet kapatma hatasƒ±:', error);
    }
}

// Reyon'a g√∂re √ºr√ºnleri filtrele - TAMƒ∞R EDƒ∞LMƒ∞≈û
function filterProductsByReyon(reyonId) {
    if (!products || products.length === 0) {
        debugLog('‚ö†Ô∏è Filtrelenecek √ºr√ºn bulunamadƒ±');
        return;
    }
    
    const filteredProducts = products.filter(product => product.reyon_id === reyonId);
    
    if (filteredProducts.length > 0) {
        displayProducts(filteredProducts);
        debugLog(`‚úÖ Reyon filtreleme: ${filteredProducts.length} √ºr√ºn bulundu`);
    } else {
        // Bu reyonda √ºr√ºn yoksa t√ºm √ºr√ºnleri g√∂ster
        displayProducts(products);
        speakToUser("Bu reyonda √ºr√ºn bulunamadƒ±. T√ºm √ºr√ºnler g√∂steriliyor.");
    }
}
	// Kategoriye g√∂re √ºr√ºnleri filtrele
function filterProductsByCategory(categoryId) {
    const filteredProducts = products.filter(p => p.category_id === categoryId);
    displayProducts(filteredProducts.length > 0 ? filteredProducts : products);
}

// Demo √ºr√ºnler - GER√áEK√áƒ∞
function getDemoProducts() {
    return [
        { 
            id: 'demo-1', 
            name: "S√ºt 1L", 
            price: 15.90, 
            discount_price: 12.90,
            imgurl: "https://via.placeholder.com/150x100?text=S√ºt", 
            description: "Tam yaƒülƒ± s√ºt",
            seller_id: selectedSellerId || 'demo-seller',
            product_price_id: 'demo-price-1'
        },
        { 
            id: 'demo-2', 
            name: "Ekmek", 
            price: 5.50, 
            discount_price: null,
            imgurl: "https://via.placeholder.com/150x100?text=Ekmek", 
            description: "Taze ekmek",
            seller_id: selectedSellerId || 'demo-seller',
            product_price_id: 'demo-price-2'
        },
        { 
            id: 'demo-3', 
            name: "Yumurta 10'lu", 
            price: 32.00, 
            discount_price: 28.00,
            imgurl: "https://via.placeholder.com/150x100?text=Yumurta", 
            description: "Organik yumurta",
            seller_id: selectedSellerId || 'demo-seller',
            product_price_id: 'demo-price-3'
        }
    ];
}

// Kaydƒ±rma fonksiyonu
function scrollElement(element, amount) {
    element.scrollBy({ left: amount, behavior: 'smooth' });
}



</script>	
</body>
</html>


