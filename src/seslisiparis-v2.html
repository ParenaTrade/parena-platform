<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sesli Sipariş Sistemi - Onur Market</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
           :root {
            --primary: #003dff;
            --secondary: #00c2ff;
            --accent: #ff5c00;
            --dark: #1a1a1a;
            --light: #f8f9fa;
            --gray: #6c757d;
            --success: #28a745;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header Styles */
        header {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }
        
        .logo i {
            margin-right: 10px;
            color: var(--accent);
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .order-summary {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f0f7ff;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .order-count {
            background: var(--accent);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    max-width: 400px;
    width: 90%;
    z-index: 1001;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

		
.close-modal {
    cursor: pointer;
    font-size: 24px;
}

.location-option {
    padding: 15px;
    border: 2px solid #ddd;
    border-radius: 5px;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s;
    pointer-events: auto !important; /* Bu satırı ekleyin */
}

.location-option:hover {
    border-color: #007bff;
    background: #f8f9fa;
}

        .profile-info {
            position: relative;
        }
        
        .profile-btn {
            background: none;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 20px;
            transition: background 0.3s;
        }
        
        .profile-btn:hover {
            background: #f0f0f0;
        }
        
        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 15px;
            width: 250px;
            display: none;
            z-index: 10;
        }
        
        .profile-dropdown.show {
            display: block;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .profile-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .profile-details {
            font-size: 14px;
        }
        
        .profile-name {
            font-weight: 600;
        }
        
        .profile-phone {
            color: var(--gray);
        }
        
        .microphone-toggle {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }
        
        .microphone-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        
        .microphone-toggle.listening {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 92, 0, 0.6); }
            70% { box-shadow: 0 0 0 15px rgba(255, 92, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 92, 0, 0); }
        }
        
        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: #dc2626;
        }
        
        /* Location Marker */
        .location-marker {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f0f7ff;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .location-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        
        .location-modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
        }
        
        .location-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .location-option {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .location-option:hover {
            border-color: var(--primary);
            background: #f0f7ff;
        }
        
        .location-option.selected {
            border-color: var(--primary);
            background: #f0f7ff;
        }
        
        /* Main Content */
        .main-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            flex: 1;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark);
        }
        
        /* How it works banner */
        .how-it-works {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .how-it-works h2 {
            font-size: 28px;
            margin-bottom: 20px;
        }
        
        .steps {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .step {
            flex: 1;
            min-width: 200px;
            max-width: 250px;
        }
        
        .step-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .step h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        /* Seller Type Grid */
        .seller-type-container {
            position: relative;
            margin-bottom: 30px;
        }
        
        .seller-type-grid {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
            scroll-behavior: smooth;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .seller-type-grid::-webkit-scrollbar {
            display: none;
        }
        
        .seller-type-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            min-width: 150px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 2px solid transparent;
            flex-shrink: 0;
        }
        
        .seller-type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .seller-type-card.selected {
            border-color: var(--primary);
            background: #f0f7ff;
        }
        
        .seller-type-icon {
            font-size: 32px;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .seller-type-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        .scroll-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            z-index: 10;
        }
        
        .scroll-btn.left {
            left: -20px;
        }
        
        .scroll-btn.right {
            right: -20px;
        }
        
        /* Categories/Reyons Grid */
        .categories-container {
            position: relative;
            margin-bottom: 30px;
        }
        
        .categories-grid {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
            scroll-behavior: smooth;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .categories-grid::-webkit-scrollbar {
            display: none;
        }
        
        .category-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            min-width: 150px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 2px solid transparent;
            flex-shrink: 0;
        }
        
        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .category-card.selected {
            border-color: var(--success);
            background: #f0fff4;
        }
        
        .category-icon {
            font-size: 32px;
            margin-bottom: 10px;
            color: var(--success);
        }
        
        .category-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        /* Seller Grid */
        .sellers-container {
            position: relative;
            margin-bottom: 30px;
        }
        
        .seller-grid {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding: 10px 0;
            scroll-behavior: smooth;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .seller-grid::-webkit-scrollbar {
            display: none;
        }
        
        .seller-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 2px solid transparent;
            min-width: 200px;
            flex-shrink: 0;
        }
        
        .seller-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .seller-card.selected {
            border-color: var(--success);
            background: #f0fff4;
        }
        
        .seller-card.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .seller-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        
        .seller-info {
            padding: 15px;
        }
        
        .seller-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .seller-details {
            font-size: 14px;
            color: var(--gray);
            display: flex;
            justify-content: space-between;
        }
        
        /* Products Grid */
        .products-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }
        
        .product-card {
            background: #f9f9f9;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .product-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .product-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        
        .product-info {
            padding: 10px;
        }
        
        .product-name {
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .product-price {
            font-weight: 600;
            color: var(--primary);
        }
        
        .product-discount {
            color: #ef4444;
            font-size: 12px;
            text-decoration: line-through;
            margin-left: 5px;
        }
        
        /* Cart Section */
        .cart-container {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background: white;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .cart-container.open {
            right: 0;
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .cart-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        
        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .cart-item-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cart-item-image {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            object-fit: cover;
        }
        
        .cart-item-details {
            font-size: 14px;
        }
        
        .cart-item-name {
            font-weight: 500;
        }
        
        .cart-item-price {
            color: var(--gray);
            font-size: 12px;
        }
        
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .cart-totals {
            border-top: 1px solid #eee;
            padding: 20px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .total-final {
            font-weight: 600;
            font-size: 18px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        
        .payment-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
            padding: 0 20px 20px;
        }
        
        .payment-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .payment-btn.cash {
            background: var(--success);
            color: white;
        }
        
        .payment-btn.card {
            background: var(--primary);
            color: white;
        }
        
        .payment-btn.bonus {
            background: var(--accent);
            color: white;
            grid-column: 1 / -1;
        }
        
        .payment-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        /* Footer */
        footer {
            background: var(--dark);
            color: white;
            padding: 30px 0;
            margin-top: auto;
        }
        
        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
        }
        
        .footer-section h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .footer-links {
            list-style: none;
        }
        
        .footer-links li {
            margin-bottom: 8px;
        }
        
        .footer-links a {
            color: #ccc;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: white;
        }
        
        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .social-link {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            transition: background 0.3s;
        }
        
        .social-link:hover {
            background: var(--primary);
        }
        
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            margin-top: 20px;
            border-top: 1px solid #444;
            font-size: 14px;
            color: #aaa;
        }
        
        /* Voice Assistant */
        .voice-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 300px;
            z-index: 100;
            display: block;
        }
        
        .status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .status-title {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #1f2937;
        }
        
        .status-title i {
            margin-right: 8px;
            color: var(--accent);
        }
        
        .status-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #6b7280;
        }
        
        .status-content {
            margin-bottom: 15px;
        }
        
        .assistant-message {
            padding: 12px;
            background: #f0f9ff;
            border-radius: 8px;
            margin-bottom: 10px;
            color: #374151;
        }
        
        .user-message {
            padding: 12px;
            background: #dbeafe;
            border-radius: 8px;
            text-align: right;
            color: var(--primary);
        }
        
        .voice-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 30px;
            margin-top: 10px;
        }
        
        .voice-bar {
            width: 6px;
            height: 10px;
            background: #ddd;
            margin: 0 3px;
            border-radius: 3px;
        }
        
        .listening .voice-bar {
            animation: voiceIndicator 0.8s infinite;
        }
        
        @keyframes voiceIndicator {
            0%, 100% { height: 10px; background: #ddd; }
            50% { height: 30px; background: var(--accent); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .order-summary {
                order: 3;
                width: 100%;
                justify-content: center;
            }
            
            .seller-type-grid, .categories-grid, .seller-grid {
                flex-wrap: nowrap;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .payment-buttons {
                grid-template-columns: 1fr;
            }
            
            .steps {
                flex-direction: column;
                align-items: center;
            }
            
            .step {
                max-width: 100%;
            }
            
            .cart-container {
                width: 100%;
                right: -100%;
            }
            
            .scroll-btn {
                display: none;
            }
        }
/* Modal görünürken body'nin scrollunu engelle */
body.modal-open {
    overflow: hidden;
}

/* Konum tespit butonu */
.location-detect-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
    margin-top: 8px;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

.location-detect-btn:hover {
    background: var(--secondary);
}

.location-detect-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

/* Konum sonuç kutusu */
.location-result {
    border-left: 4px solid var(--primary);
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
}

/* Manuel adres inputları */
#manualCity, #manualDistrict, #manualAddress {
    font-size: 14px;
}

#manualAddress {
    resize: vertical;
    min-height: 60px;
}

/* Teslimat bilgisi stilleri */
.delivery-info {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #eee;
}

.delivery-fee {
    font-size: 12px;
    color: var(--primary);
    font-weight: 600;
}

.delivery-fee.free {
    color: var(--success);
}

.min-order {
    font-size: 11px;
    color: var(--gray);
    margin-top: 2px;
}

/* Konum form stilleri */
#deliveryLocationForm input,
#deliveryLocationForm select,
#deliveryLocationForm textarea {
    font-size: 14px;
}

#deliveryLocationForm label {
    font-size: 13px;
}

.location-option {
    position: relative;
}

.location-option.selected {
    border-color: var(--primary);
    background: #f0f7ff;
}
	
	</style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-container">
            <div class="logo">
                <i class="fas fa-utensils"></i>
                <span>Sesli Sipariş</span>
            </div>
            
            <div class="header-actions">
                <div class="location-marker" id="locationMarker">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="locationText">Konumunuzu işaretleyin</span>
                </div>
                
                <div class="order-summary" id="orderSummary" style="display: none;">
                    <div class="order-count" id="orderCount">0</div>
                    <div>Sipariş: <span id="orderTotal">0 ₺</span></div>
                </div>
               
                <div class="profile-info">
                    <button class="profile-btn" id="profileBtn">
                        <i class="fas fa-user"></i>
                        <span id="userName">Profilim</span>
                    </button>
                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="profile-header">
                            <div class="profile-avatar" id="profileAvatar">OM</div>
                            <div class="profile-details">
                                <div class="profile-name" id="profileName">-</div>
                                <div class="profile-phone" id="profilePhone">-</div>
                            </div>
                        </div>
                        <div class="profile-info-item">
                            <strong>Şehir:</strong> <span id="profileCity">-</span>
                        </div>
                        <div class="profile-info-item">
                            <strong>Adres:</strong> <span id="profileAddress">-</span>
                        </div>
                        <div class="profile-info-item">
                            <strong>Bonus:</strong> <span id="profileBonus">0 ₺</span>
                        </div>
                        <button class="logout-btn" id="logoutBtn" style="margin-top: 15px; width: 100%;">
                            <i class="fas fa-sign-out-alt"></i>
                            Çıkış Yap
                        </button>
                    </div>
                </div>

                <button id="microphoneToggle" class="microphone-toggle">
                    <i class="fas fa-microphone-slash"></i>
                    <span>Mikrofon (Kapalı)</span>
                </button>
            </div>
        </div>
    </header>




    <!-- Konum Seçim Modal'ı -->
    <div id="locationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Konum Seçiniz</h3>
                <span class="close-modal" id="closeLocationModal">&times;</span>
            </div>
            <div class="modal-body">
                <p>Lütfen sipariş vermek istediğiniz konumu seçin:</p>
                <div class="location-options">
                    <div class="location-option" data-location="inside">
                        <i class="fas fa-utensils"></i>
                        <span>Restoran içinde</span>
                    </div>
                    <div class="location-option" data-location="takeaway">
                        <i class="fas fa-utensils"></i>
                        <span>Paket servis</span>
                    </div>
                    <div class="location-option" data-location="delivery">
                        <i class="fas fa-motorcycle"></i>
                        <span>Adrese teslim</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

	<!-- Main Content -->
    <div class="main-container">
        <!-- How it works banner -->
        <section class="how-it-works" id="howItWorks">
            <h2>Nasıl Çalışır?</h2>
            <div class="steps">
                <div class="step">
                    <div class="step-icon"><i class="fas fa-store"></i></div>
                    <h3>Satıcı Seç</h3>
                    <p>Market, restoran, eczane veya fırın seçin</p>
                </div>
                <div class="step">
                    <div class="step-icon"><i class="fas fa-box-open"></i></div>
                    <h3>Ürünleri Seç</h3>
                    <p>Reyonlardan veya menüden ürün seçin</p>
                </div>
                <div class="step">
                    <div class="step-icon"><i class="fas fa-shopping-cart"></i></div>
                    <h3>Sipariş Ver</h3>
                    <p>Sepetinizi onaylayın ve ödeme yapın</p>
                </div>
                <div class="step">
                    <div class="step-icon"><i class="fas fa-robot"></i></div>
                    <h3>Sesli Asistan</h3>
                    <p>Mikrofonu açın ve sesli komut verin</p>
                </div>
            </div>
        </section>

        <!-- Seller Type Selection -->
        <section>
            <h2 class="section-title">Ne yemek istersiniz?</h2>
            <div class="seller-type-container">
                <button class="scroll-btn left" id="scrollSellerTypesLeft">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="seller-type-grid" id="sellerTypeGrid">
                    <!-- Satıcı tipleri buraya yüklenecek -->
                </div>
                <button class="scroll-btn right" id="scrollSellerTypesRight">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>
	 <!-- Sellers Grid -->
        <section id="sellersSection" style="display: none;">
            <h2 class="section-title">Size En Yakın Yerler</h2>
            <div class="sellers-container">
                <button class="scroll-btn left" id="scrollSellersLeft">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="seller-grid" id="sellerGrid">
                    <!-- Satıcılar buraya yüklenecek -->
                </div>
                <button class="scroll-btn right" id="scrollSellersRight">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>

        <!-- Categories/Reyons Grid -->
        <section id="categoriesSection" style="display: none;">
            <h2 class="section-title" id="categoriesTitle">Kategoriler</h2>
            <div class="categories-container">
                <button class="scroll-btn left" id="scrollCategoriesLeft">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="categories-grid" id="categoriesGrid">
                    <!-- Kategoriler/Reyonlar buraya yüklenecek -->
                </div>
                <button class="scroll-btn right" id="scrollCategoriesRight">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>

        <!-- Products Grid -->
        <section class="products-section" id="productsSection" style="display: none;">
            <div class="products-header">
                <h2 class="section-title" style="margin-bottom: 0;">Ürünler</h2>
                <div id="selectedSellerInfo" class="text-gray">Satıcı seçilmedi</div>
            </div>
            <div class="products-grid" id="productsGrid">
                <!-- Ürünler buraya yüklenecek -->
            </div>
        </section>
    </div>

    <!-- Cart Section -->
    <div class="cart-container" id="cartContainer">
        <div class="cart-header">
            <h2>Sepetiniz</h2>
            <button class="cart-close" id="cartClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="cart-items" id="cartItems">
            <div class="text-center" style="padding: 30px; color: #6c757d;">
                <i class="fas fa-shopping-cart fa-2x mb-3"></i>
                <p>Sepetiniz boş</p>
            </div>
        </div>
        <div class="cart-totals">
            <div class="total-row">
                <span>Ara Toplam:</span>
                <span id="subtotal">0 ₺</span>
            </div>
            <div class="total-row">
                <span>İndirim:</span>
                <span id="discount">0 ₺</span>
            </div>
            <div class="total-row">
                <span>KDV (%18):</span>
                <span id="vatAmount">0 ₺</span>
            </div>
            <div class="total-row total-final">
                <span>Toplam:</span>
                <span id="totalAmount">0 ₺</span>
            </div>
        </div>
        <div class="payment-buttons">
            <button class="payment-btn cash" id="payCash">Nakit Öde</button>
            <button class="payment-btn card" id="payCard">Kartla Öde</button>
            <button class="payment-btn bonus" id="payBonus">Bonus ile Öde</button>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <div class="footer-section">
                <h3>Sesli Sipariş</h3>
                <p>Sesli komutlarla kolayca sipariş verin. Hızlı, güvenli ve pratik alışveriş deneyimi.</p>
                <div class="social-links">
                    <a href="#" class="social-link"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
                    <a href="https://wa.me/?text=Merhaba!%20Sesli%20Sipariş%20sisteminden%20alışveriş%20yapmak%20istiyorum." class="social-link" target="_blank"><i class="fab fa-whatsapp"></i></a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Hızlı Bağlantılar</h3>
                <ul class="footer-links">
                    <li><a href="#" id="referralLink">Referans Linki</a></li>
                    <li><a href="#" id="whatsappOrder">WhatsApp ile Sipariş</a></li>
                    <li><a href="#">Siparişlerim</a></li>
                    <li><a href="#">Yardım</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3>İletişim</h3>
                <ul class="footer-links">
                    <li><i class="fas fa-phone"></i> 0850 123 45 67</li>
                    <li><i class="fas fa-envelope"></i> info@seslisiparis.com</li>
                    <li><i class="fas fa-map-marker-alt"></i> İstanbul, Türkiye</li>
                </ul>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy; 2023 Sesli Sipariş Sistemi. Tüm hakları saklıdır.</p>
        </div>
	
    </footer>

    <!-- Voice Assistant -->
    <div class="voice-status" id="voiceStatusPanel">
        <div class="status-header">
            <div class="status-title">
                <i class="fas fa-microphone"></i>
                <span>Sesli Asistan</span>
            </div>
            <button class="status-close" id="closeVoiceStatus">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="status-content">
            <div class="assistant-message" id="assistantMessage">Merhaba! Sipariş vermek için mikrofonu açın ve konuşun.</div>
            <div class="user-message" id="userMessage"></div>
        </div>
        <div class="voice-indicator" id="voiceIndicator">
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
        </div>
    </div>
<script>
        // =============================================
        // BAŞLANGIÇ KODLARI - 1. BÖLÜM ÖNCESİ
        // =============================================

        // Supabase configuration
        const SUPABASE_URL = "https://xliutvspwodhoaxvysks.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsaXV0dnNwd29kaG9heHZ5c2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTgyOTksImV4cCI6MjA3MjkzNDI5OX0.Zodisa_ifP8t2Q4X0ecnB56RiR_Bg4QS5gvPn5ZLK_w";

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Global state
        let currentCustomer = null;
        let sellers = [];
        let products = [];
        let categories = [];
        let storeTypes = [];
        let cart = [];
        let recognition = null;
        let isListening = false;
        let isMicrophoneEnabled = false;
        let conversationStep = 0;
        let currentPaymentMethod = null;
        let selectedSellerId = null;
        let selectedSellerType = null;
        let selectedCategoryId = null;
        let isSellerLocked = false;
        let selectedLocation = null;
        let referralCode = null;
        let referralGroupCode = null;
	let selectedStoreTypeId = null;
	let selectedStoreTypeName = null;
	
	// Global state'e ekle
	let userLocation = {
   	 latitude: null,
   	 longitude: null,
  	  address: null,
 	   city: null,
   	 district: null
	};
	
	let isLocationDetected = false;



        // DOM Elements
        const profileBtn = document.getElementById('profileBtn');
        const profileDropdown = document.getElementById('profileDropdown');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profilePhone = document.getElementById('profilePhone');
        const profileCity = document.getElementById('profileCity');
        const profileAddress = document.getElementById('profileAddress');
        const profileBonus = document.getElementById('profileBonus');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const microphoneToggle = document.getElementById('microphoneToggle');
        const sellerTypeGrid = document.getElementById('sellerTypeGrid');
        const scrollSellerTypesLeft = document.getElementById('scrollSellerTypesLeft');
        const scrollSellerTypesRight = document.getElementById('scrollSellerTypesRight');
        const categoriesSection = document.getElementById('categoriesSection');
        const categoriesTitle = document.getElementById('categoriesTitle');
        const categoriesGrid = document.getElementById('categoriesGrid');
        const scrollCategoriesLeft = document.getElementById('scrollCategoriesLeft');
        const scrollCategoriesRight = document.getElementById('scrollCategoriesRight');
        const sellersSection = document.getElementById('sellersSection');
        const sellerGrid = document.getElementById('sellerGrid');
        const scrollSellersLeft = document.getElementById('scrollSellersLeft');
        const scrollSellersRight = document.getElementById('scrollSellersRight');
        const productsSection = document.getElementById('productsSection');
        const selectedSellerInfo = document.getElementById('selectedSellerInfo');
        const productsGrid = document.getElementById('productsGrid');
        const cartContainer = document.getElementById('cartContainer');
        const cartClose = document.getElementById('cartClose');
        const cartItems = document.getElementById('cartItems');
        const orderSummary = document.getElementById('orderSummary');
        const orderCount = document.getElementById('orderCount');
        const orderTotal = document.getElementById('orderTotal');
        const subtotalEl = document.getElementById('subtotal');
        const discountEl = document.getElementById('discount');
        const vatAmountEl = document.getElementById('vatAmount');
        const totalAmountEl = document.getElementById('totalAmount');
        const payCashBtn = document.getElementById('payCash');
        const payCardBtn = document.getElementById('payCard');
        const payBonusBtn = document.getElementById('payBonus');
        const assistantMessage = document.getElementById('assistantMessage');
        const userMessage = document.getElementById('userMessage');
        const voiceIndicator = document.getElementById('voiceIndicator');
        const closeVoiceStatus = document.getElementById('closeVoiceStatus');
        const voiceStatusPanel = document.getElementById('voiceStatusPanel');
        const howItWorks = document.getElementById('howItWorks');
        const locationMarker = document.getElementById('locationMarker');
        const locationText = document.getElementById('locationText');
        const locationModal = document.getElementById('locationModal');
        const referralLink = document.getElementById('referralLink');
        const whatsappOrder = document.getElementById('whatsappOrder');

        // Utility functions
        function money(n) { 
            return Number(n||0).toLocaleString('tr-TR',{minimumFractionDigits:2, maximumFractionDigits:2}) + ' ₺'; 
        }

        // Debug modu
        const DEBUG_MODE = true;

        // Debug fonksiyonu
        function debugLog(message, data = null) {
            if (DEBUG_MODE) {
                console.log(`[DEBUG] ${new Date().toLocaleTimeString()}: ${message}`, data || '');
            }
        }

        // =============================================
        // LOKASYON SEÇİM SİSTEMİ
        // =============================================

function showLocationModal() {
    const modal = document.getElementById('locationModal');
    if (!modal) {
        console.error('❌ Location modal bulunamadı');
        return;
    }

    document.body.classList.add('modal-open');
    modal.style.display = 'flex';
    modal.style.zIndex = '10000';
    
    // Modal içeriğini güncelle
    updateLocationModal();
    
    debugLog('📍 Konum modalı gösterildi (zorunlu)');
}

// Konum seçimini güncelle - İl/ilçe zorunluluğu (GÜNCELLENMİŞ)
function selectLocation(locationType) {
    console.log('📍 Seçilen konum:', locationType);
    
    if (!locationType) {
        console.error('❌ Konum tipi belirtilmedi');
        return;
    }
    
    // Adrese teslim seçildiyse konum bilgisi kontrolü
    if (locationType === 'delivery') {
        if (!isLocationDetected) {
            speakToUser("Adrese teslim için lütfen konumunuzu belirleyin.");
            return;
        }
    }
    
    selectedLocation = locationType;
    localStorage.setItem('selectedLocation', locationType);
    localStorage.setItem('userLocation', JSON.stringify(userLocation));
    
    updateLocationText();
    hideLocationModal();
    
    // Store type seçilmişse işleme devam et
    if (selectedStoreTypeId) {
        proceedWithStoreTypeSelection(selectedStoreTypeId, selectedStoreTypeName);
    }
    
    debugLog('📍 Konum seçildi:', locationType);
    speakToUser(`Konumunuz kaydedildi. ${locationType === 'delivery' ? 'Adrese teslim seçeneği aktif.' : ''}`);
}


// Konum alma fonksiyonu
function getCurrentLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject(new Error('Tarayıcınız konum almaya izin vermiyor.'));
        } else {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    // Reverse geocoding için Nominatim API'sini kullan
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                        const data = await response.json();
                        resolve({
                            coordinates: { latitude, longitude },
                            address: data.address,
                            display_name: data.display_name
                        });
                    } catch (error) {
                        reject(error);
                    }
                },
                (error) => {
                    reject(error);
                }
            );
        }
    });
}

// Konum metnini güncelle - Konum bilgisini göster
function updateLocationText() {
    if (locationText && selectedLocation) {
        const locationNames = {
            'inside': 'Restoran içinde',
            'takeaway': 'Paket servis', 
            'delivery': 'Adrese teslim'
        };
        
        let locationTextContent = locationNames[selectedLocation] || selectedLocation;
        
        // Adrese teslimde konum bilgisini göster
        if (selectedLocation === 'delivery' && userLocation.city) {
            locationTextContent += ` - ${userLocation.district}, ${userLocation.city}`;
        }
        
        locationText.textContent = locationTextContent;
    }
}

        function setupLocationEvents() {
            const locationMarker = document.getElementById('locationMarker');
            if (locationMarker) {
                locationMarker.onclick = null;
                locationMarker.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('📍 Konum marker tıklandı');
                    showLocationModal();
                });
                locationMarker.style.cursor = 'pointer';
                debugLog('✅ Konum marker eventleri ayarlandı');
            }
        }

     
// Uygulama başlangıcında konumu zorunlu yap
function initializeLocation() {
    debugLog('📍 Konum yönetimi başlatılıyor...');
    
    // Her zaman konum modalını göster (zorunlu)
    setTimeout(() => {
        showLocationModal();
    }, 1000);
    
    // Konum modal içeriğini güncelle
    updateLocationModal();
}

// Konum modalını güncelle - SADECE KONUM TESPİTİ
function updateLocationModal() {
    const locationModal = document.getElementById('locationModal');
    if (!locationModal) return;
    
    locationModal.querySelector('.modal-body').innerHTML = `
        <p><strong>Siparişiniz için lütfen konumunuzu belirleyin:</strong></p>
        
        <div class="location-options">
            <div class="location-option" data-location="inside">
                <i class="fas fa-utensils"></i>
                <div>
                    <strong>Restoran içinde</strong>
                    <small>Yemeğinizi restoranda yiyin</small>
                </div>
            </div>
            
            <div class="location-option" data-location="takeaway">
                <i class="fas fa-utensils"></i>
                <div>
                    <strong>Paket servis</strong>
                    <small>Yemeğinizi kendiniz alın</small>
                </div>
            </div>
            
            <div class="location-option" data-location="delivery">
                <i class="fas fa-motorcycle"></i>
                <div>
                    <strong>Adrese teslim</strong>
                    <small>Yemeğiniz adresinize gelsin</small>
                </div>
            </div>
        </div>

        <!-- Konum tespit butonu -->
        <div style="margin-top: 20px; text-align: center;">
            <button id="detectLocationBtn" style="width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 16px;">
                <i class="fas fa-location-arrow"></i> Konumumu Otomatik Belirle
            </button>
            <div id="locationResult" class="location-result" style="display: none; margin-top: 15px;"></div>
        </div>

        <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; border: 1px solid #ffeaa7; font-size: 14px;">
            <i class="fas fa-info-circle"></i>
            <strong>Not:</strong> Konumunuz sadece size en yakın satıcıları göstermek için kullanılacaktır.
        </div>
    `;
    
    // LOKASYON SEÇİM EVENT'LERİNİ EKLE
    setTimeout(() => {
        // Lokasyon seçeneklerine tıklama event'leri
        document.querySelectorAll('.location-option').forEach(option => {
            option.addEventListener('click', function() {
                const locationType = this.getAttribute('data-location');
                
                // Tüm seçeneklerden seçimi kaldır
                document.querySelectorAll('.location-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Bu seçeneği seçili yap
                this.classList.add('selected');
                
                // Restoran içi veya paket servis için direkt seç
                if (locationType === 'inside' || locationType === 'takeaway') {
                    selectLocation(locationType);
                } else {
                    // Adrese teslim için konum tespiti gerekli
                    speakToUser("Adrese teslim için lütfen konumunuzu belirleyin.");
                }
            });
        });
        
        // Konum tespit butonu
        const detectBtn = document.getElementById('detectLocationBtn');
        if (detectBtn) {
            detectBtn.addEventListener('click', function() {
                detectUserLocation().then(success => {
                    if (success) {
                        // Konum tespit edildiğinde, adrese teslim seçeneğini otomatik seç
                        const deliveryOption = document.querySelector('.location-option[data-location="delivery"]');
                        if (deliveryOption) {
                            deliveryOption.classList.add('selected');
                            selectLocation('delivery');
                        }
                    }
                });
            });
        }
        
    }, 100);
}

//=====================================
// KONUM ALMA FONKSİYONU
//=====================================

// Konum tespit et - HTML5 Geolocation API (GÜNCELLENMİŞ)
async function detectUserLocation() {
    const resultDiv = document.getElementById('locationResult');
    const detectBtn = document.getElementById('detectLocationBtn');
    
    if (!navigator.geolocation) {
        showLocationError("Tarayıcınız konum servisini desteklemiyor.");
        return false;
    }
    
    // Butonu loading durumuna getir
    if (detectBtn) {
        detectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Konumunuz Belirleniyor...';
        detectBtn.disabled = true;
    }
    
    if (resultDiv) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div style="color: #007bff;"><i class="fas fa-spinner fa-spin"></i> Konumunuz belirleniyor...</div>';
    }
    
    try {
        const position = await getCurrentPosition();
        const { latitude, longitude } = position.coords;
        
        // Konumu adrese çevir
        const address = await reverseGeocode(latitude, longitude);
        
        // Konum bilgisini kaydet - şehir ve ilçe bilgisi
        userLocation = {
            latitude,
            longitude,
            address: address.display_name,
            city: address.address?.city || address.address?.town || address.address?.village || 'Bilinmeyen',
            district: address.address?.suburb || address.address?.county || address.address?.state_district || 'Bilinmeyen',
            fullAddress: address.display_name
        };
        
        isLocationDetected = true;
        
        // Sonucu göster
        if (resultDiv) {
            resultDiv.innerHTML = `
                <div style="color: var(--success);">
                    <i class="fas fa-check-circle"></i> 
                    <strong>Konumunuz Belirlendi!</strong>
                    <div style="font-size: 12px; margin-top: 5px;">
                        ${userLocation.district}, ${userLocation.city}
                    </div>
                </div>
            `;
        }
        
        debugLog('📍 Konum tespit edildi:', userLocation);
        return true;
        
    } catch (error) {
        console.error('Konum tespit hatası:', error);
        showLocationError("Konumunuz belirlenemedi. Lütfen tarayıcı ayarlarınızdan konum erişimine izin verin.");
        return false;
    } finally {
        // Butonu eski haline getir
        if (detectBtn) {
            detectBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Konumumu Otomatik Belirle';
            detectBtn.disabled = false;
        }
    }
}

// Yeni üyelik sırasında adres teyidi
async function confirmAddressWithAssistant() {
    return new Promise((resolve) => {
        if (!userLocation || !userLocation.fullAddress) {
            resolve(false);
            return;
        }
        
        const detectedAddress = userLocation.fullAddress;
        
        speakToUser(`Konumunuz şu şekilde belirlendi: ${detectedAddress}. Bu adresiniz doğru mu? Lütfen 'Evet' veya 'Hayır' diyerek teyit edin.`);
        
        // Sesli cevap bekliyoruz
        const originalProcessCommand = window.processVoiceCommand;
        let responseReceived = false;
        
        window.processVoiceCommand = function(transcript) {
            const message = transcript.toLowerCase().trim();
            
            if (message.includes('evet') || message.includes('doğru') || message.includes('onay')) {
                responseReceived = true;
                window.processVoiceCommand = originalProcessCommand;
                speakToUser("Teşekkür ederim! Adresiniz kaydedildi.");
                resolve(true);
            } 
            else if (message.includes('hayır') || message.includes('yanlış') || message.includes('değil')) {
                responseReceived = true;
                window.processVoiceCommand = originalProcessCommand;
                speakToUser("Özür dilerim. Lütfen doğru adresinizi söyleyin.");
                resolve(false);
            }
            else {
                // Anlaşılamadı, tekrar sor
                speakToUser(`Adresiniz: ${detectedAddress}. Doğru mu? Lütfen 'Evet' veya 'Hayır' diyerek teyit edin.`);
            }
        };
        
        // 30 saniye timeout
        setTimeout(() => {
            if (!responseReceived) {
                window.processVoiceCommand = originalProcessCommand;
                speakToUser("Adres teyidi zaman aşımına uğradı. Varsayılan adres kullanılacak.");
                resolve(true); // Zaman aşımında varsayılan olarak kabul et
            }
        }, 30000);
    });
}
// HTML5 Geolocation Promise wrapper
function getCurrentPosition() {
    return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
        });
    });
}

// Koordinatları adrese çevir - OpenStreetMap Nominatim API (ÜCRETSİZ)
async function reverseGeocode(lat, lon) {
    try {
        const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1&zoom=18`
        );
        
        if (!response.ok) {
            throw new Error('Adres çözümleme hatası');
        }
        
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Reverse geocoding hatası:', error);
        // Fallback: Basit koordinat bilgisi
        return {
            display_name: `Konum: ${lat.toFixed(6)}, ${lon.toFixed(6)}`,
            address: {
                city: 'Bilinmeyen',
                town: 'Bilinmeyen',
                village: 'Bilinmeyen',
                suburb: 'Bilinmeyen'
            }
        };
    }
}

// Konum hatası göster
function showLocationError(message) {
    const resultDiv = document.getElementById('locationResult');
    if (resultDiv) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div style="color: #dc3545;">
                <i class="fas fa-exclamation-triangle"></i> 
                ${message}
                <button onclick="showManualAddressInput()" style="margin-top: 8px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">
                    Manuel Adres Gir
                </button>
            </div>
        `;
    }
    speakToUser("Konumunuz tespit edilemedi. Lütfen manuel olarak adres giriniz.");
}


// Manuel adres girişi formu
function showManualAddressInput() {
    const resultDiv = document.getElementById('locationResult');
    if (!resultDiv) return;
    
    resultDiv.innerHTML = `
        <div style="color: #333;">
            <strong>Lütfen Adresinizi Girin:</strong>
            <div style="margin-top: 10px;">
                <input type="text" id="manualCity" placeholder="İl" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="text" id="manualDistrict" placeholder="İlçe" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <textarea id="manualAddress" placeholder="Detaylı adres" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px; height: 60px;"></textarea>
                <button onclick="saveManualAddress()" style="padding: 8px 15px; background: var(--success); color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Adresi Kaydet
                </button>
            </div>
        </div>
    `;
}

// Manuel adres kaydı
function saveManualAddress() {
    const city = document.getElementById('citySelect')?.value;
    const district = document.getElementById('districtSelect')?.value;
    const detailedAddress = document.getElementById('detailedAddress')?.value;
    
    if (!city || !district) {
        alert('Lütfen il ve ilçe bilgilerinizi seçin.');
        return;
    }
    
    if (!detailedAddress || detailedAddress.trim().length < 10) {
        alert('Lütfen detaylı adresinizi girin (en az 10 karakter).');
        return;
    }
    
    userLocation = {
        city: city,
        district: district,
        address: detailedAddress.trim(),
        fullAddress: `${detailedAddress.trim()}, ${district}, ${city}`
    };
    
    isLocationDetected = true;
    
    const resultDiv = document.getElementById('locationResult');
    if (resultDiv) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div style="color: var(--success);">
                <i class="fas fa-check-circle"></i> 
                <strong>Adresiniz Kaydedildi</strong>
                <div style="font-size: 12px; margin-top: 5px;">
                    ${district}, ${city}
                </div>
            </div>
        `;
    }
    
    speakToUser(`Adresiniz kaydedildi: ${district}, ${city}.`);
}

        // =============================================
        // MİKROFON VE SESLİ ASİSTAN SİSTEMİ
        // =============================================

        function handleMicrophoneToggle() {
            console.log('🎤 Mikrofon toggle çağrıldı', { 
                selectedLocation: selectedLocation, 
                currentCustomer: currentCustomer 
            });
            
            if (!selectedLocation) {
                console.log('📍 Konum seçilmemiş');
                showLocationModal();
                speakToUser("Lütfen önce bir konum seçiniz.");
                return;
            }
            
            if (isListening) {
                disableMicrophone();
            } else {
                enableMicrophone();
            }
        }



        async function enableMicrophone() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error("Mikrofon erişimi desteklenmiyor");
                }

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                isMicrophoneEnabled = true;
                microphoneToggle.innerHTML = '<i class="fas fa-microphone"></i> <span>Mikrofon (Açık)</span>';
                microphoneToggle.classList.add('listening');
                
                initializeSpeechRecognition();
                
                if (assistantMessage) {
                    assistantMessage.textContent = "Mikrofon açıldı. Konuşmaya başlayabilirsiniz.";
                }
                
                // Sesli karşılama mesajı
                setTimeout(() => {
                    initializeVoiceAssistant();
                }, 1000);
                
                stream.getTracks().forEach(track => track.stop());
                
            } catch (error) {
                console.error("Mikrofon erişim hatası:", error);
                let errorMessage = "Mikrofon erişimi sağlanamadı. ";
                
                if (error.name === "NotAllowedError") {
                    errorMessage += "Lütfen tarayıcı ayarlarınızdan mikrofon erişimine izin verin.";
                } else if (error.name === "NotFoundError") {
                    errorMessage += "Mikrofon cihazı bulunamadı.";
                } else {
                    errorMessage += "Beklenmeyen bir hata oluştu: " + error.message;
                }
                
                if (assistantMessage) {
                    assistantMessage.textContent = errorMessage;
                }
                disableMicrophone();
            }
        }

        function disableMicrophone() {
            isMicrophoneEnabled = false;
            microphoneToggle.innerHTML = '<i class="fas fa-microphone-slash"></i> <span>Mikrofon (Kapalı)</span>';
            microphoneToggle.classList.remove('listening');
            
            if (recognition) {
                recognition.stop();
            }
            
            if (voiceIndicator) {
                voiceIndicator.classList.remove('listening');
            }
            
            if (assistantMessage) {
                assistantMessage.textContent = "Mikrofon kapalı. Sesli sipariş için lütfen mikrofonu açın.";
            }
        }

        function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                if (assistantMessage) {
                    assistantMessage.textContent = "Tarayıcınız ses tanıma özelliğini desteklemiyor";
                }
                disableMicrophone();
                return;
            }
            
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.lang = 'tr-TR';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            
            recognition.onstart = function() {
                isListening = true;
                if (voiceIndicator) {
                    voiceIndicator.classList.add('listening');
                }
                if (assistantMessage) {
                    assistantMessage.textContent = "Dinliyorum... Konuşmaya başlayın.";
                }
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[event.results.length - 1][0].transcript;
                if (userMessage) {
                    userMessage.textContent = transcript;
                }
                processVoiceCommand(transcript);
            };
            
            recognition.onerror = function(event) {
                console.error('Ses tanıma hatası:', event.error);
                
                if (event.error === 'no-speech') {
                    return;
                } 
                
                if (event.error === 'not-allowed') {
                    if (assistantMessage) {
                        assistantMessage.textContent = "Mikrofon erişimine izin verilmedi. Lütfen tarayıcı ayarlarınızdan izin verin.";
                    }
                    disableMicrophone();
                } else {
                    if (assistantMessage) {
                        assistantMessage.textContent = "Ses tanıma hatası: " + event.error;
                    }
                }
                
                isListening = false;
                if (voiceIndicator) {
                    voiceIndicator.classList.remove('listening');
                }
            };
            
            recognition.onend = function() {
                isListening = false;
                if (voiceIndicator) {
                    voiceIndicator.classList.remove('listening');
                }
                
                if (isMicrophoneEnabled && !isListening) {
                    setTimeout(() => {
                        try {
                            recognition.start();
                        } catch (error) {
                            console.log('Ses tanıma yeniden başlatılamadı:', error);
                        }
                    }, 500);
                }
            };
            
            try {
                recognition.start();
            } catch (error) {
                console.error('Ses tanıma başlatılamadı:', error);
                if (assistantMessage) {
                    assistantMessage.textContent = "Ses tanıma başlatılamadı. Lütfen sayfayı yenileyin.";
                }
                disableMicrophone();
            }
        }

        function initializeVoiceAssistant() {
            setTimeout(() => {
                if (!currentCustomer) {
                    speakToUser("Merhaba! Sesli sipariş sistemine hoş geldiniz. Telefon numaranızı söyleyerek giriş yapabilir veya misafir olarak devam edebilirsiniz.");
                    conversationStep = 0;
                } else {
                    speakToUser(`Hoş geldiniz ${currentCustomer.name}! Ne satın almak istersiniz?`);
                }
            }, 1000);
        }

        function speakToUser(message) {
            if (assistantMessage) {
                assistantMessage.textContent = message;
            }
            
            if ('speechSynthesis' in window) {
                const speech = new SpeechSynthesisUtterance(message);
                speech.lang = 'tr-TR';
                speech.volume = 1;
                speech.rate = 1;
                speech.pitch = 1;
                window.speechSynthesis.speak(speech);
            }
        }

        function processVoiceCommand(transcript) {
            const message = transcript.toLowerCase();
            if (userMessage) {
                userMessage.textContent = transcript;
            }

            // Store type seçimi
            if (message.includes('market')) {
                selectStoreTypeByName('Market');
                speakToUser("Market seçildi. Size en yakın marketler listeleniyor.");
            } else if (message.includes('restoran') || message.includes('lokanta')) {
                selectStoreTypeByName('Restoran');
                speakToUser("Restoran seçildi. Size en yakın restoranlar listeleniyor.");
            } else if (message.includes('eczane')) {
                selectStoreTypeByName('Eczane');
                speakToUser("Eczane seçildi. Size en yakın eczaneler listeleniyor.");
            } else if (message.includes('fırın')) {
                selectStoreTypeByName('Fırın');
                speakToUser("Fırın seçildi. Size en yakın fırınlar listeleniyor.");
            }
            
            // Giriş süreci
            if (conversationStep === 0) {
                if (message.includes('evet') || message.includes('isterim') || message.includes('tabi') || message.includes('olur')) {
                    speakToUser("Harika! Telefon numaranızı söyler misiniz?");
                    conversationStep = 1;
                } else if (message.includes('hayır') || message.includes('istemiyorum')) {
                    speakToUser("Peki, giriş yapmak istediğiniz zaman bana 'Evet' deyin.");
                } else {
                    speakToUser("Giriş yapmak istiyor musunuz? Lütfen 'Evet' veya 'Hayır' diyerek yanıt verin.");
                }
                return;
            }
            
            if (conversationStep === 1) {
                const phoneMatch = message.match(/\d+/g);
                if (phoneMatch) {
                    const phone = phoneMatch.join('');
                    checkCustomerByPhone(phone);
                } else {
                    speakToUser("Telefon numaranızı anlayamadım. Lütfen numaranızı söyler misiniz?");
                }
                return;
            }
            
            // Diğer komutlar için buraya eklemeler yapılacak
        }

        function selectStoreTypeByName(typeName) {
            const typeCard = Array.from(document.querySelectorAll('.seller-type-card')).find(card => 
                card.dataset.typeName === typeName
            );
            
            if (typeCard) {
                typeCard.click();
            }
        }

        // =============================================
        // SAYFA YÜKLEME SÜRECİ
        // =============================================

        function waitForDOMElements() {
            return new Promise((resolve) => {
                const elements = {
                    'microphoneToggle': document.getElementById('microphoneToggle'),
                    'locationModal': document.getElementById('locationModal'),
                    'locationMarker': document.getElementById('locationMarker'),
                    'profileBtn': document.getElementById('profileBtn'),
                    'logoutBtn': document.getElementById('logoutBtn')
                };

                let attempts = 0;
                const maxAttempts = 50;

                const checkElements = () => {
                    attempts++;
                    const loaded = Object.values(elements).filter(el => el !== null).length;
                    const total = Object.keys(elements).length;

                    debugLog(`DOM yükleme: ${loaded}/${total} (deneme ${attempts})`);

                    if (loaded >= 3 || attempts >= maxAttempts) {
                        debugLog('✅ Minimum DOM elementleri yüklendi');
                        resolve();
                        return;
                    }

                    setTimeout(checkElements, 100);
                };

                checkElements();
            });
        }

        function setupEventHandlers() {
            try {
                debugLog('🔧 Event handlerlar ayarlanıyor...');

                // Konum event'leri
                setupLocationEvents();

                // Mikrofon toggle
                if (microphoneToggle) {
                    microphoneToggle.addEventListener('click', handleMicrophoneToggle);
                }

                // Profil dropdown
                if (profileBtn && profileDropdown) {
                    profileBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        profileDropdown.classList.toggle('show');
                    });
                    
                    document.addEventListener('click', function() {
                        profileDropdown.classList.remove('show');
                    });
                }

                // Çıkış butonu
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        logout();
                    });
                }

                // Kaydırma butonları
                if (scrollSellerTypesLeft && sellerTypeGrid) {
                    scrollSellerTypesLeft.addEventListener('click', () => scrollElement(sellerTypeGrid, -200));
                    scrollSellerTypesRight.addEventListener('click', () => scrollElement(sellerTypeGrid, 200));
                }
                
                if (scrollCategoriesLeft && categoriesGrid) {
                    scrollCategoriesLeft.addEventListener('click', () => scrollElement(categoriesGrid, -200));
                    scrollCategoriesRight.addEventListener('click', () => scrollElement(categoriesGrid, 200));
                }
                
                if (scrollSellersLeft && sellerGrid) {
                    scrollSellersLeft.addEventListener('click', () => scrollElement(sellerGrid, -200));
                    scrollSellersRight.addEventListener('click', () => scrollElement(sellerGrid, 200));
                }

                // Sepet işlemleri
                if (cartClose) {
                    cartClose.addEventListener('click', closeCart);
                }
                
                if (orderSummary) {
                    orderSummary.addEventListener('click', toggleCart);
                }

                // Ödeme butonları
                if (payCashBtn) {
                    payCashBtn.addEventListener('click', () => finalizeOrder('nakit'));
                }
                if (payCardBtn) {
                    payCardBtn.addEventListener('click', () => finalizeOrder('kart'));
                }
                if (payBonusBtn) {
                    payBonusBtn.addEventListener('click', () => finalizeOrder('bonus'));
                }

                debugLog('✅ Tüm event handlerlar başarıyla ayarlandı');

            } catch (error) {
                console.error('❌ Event handler ayarlama hatası:', error);
            }
        }

        function updateUIAfterLogin() {
            updateLogoutButtonVisibility();
            
            if (currentCustomer) {
                hideHowItWorksBanner();
            } else {
                showHowItWorksBanner();
            }
            
            updateCustomerUI();
            updateLocationText();
        }

        function updateLogoutButtonVisibility() {
            if (logoutBtn) {
                logoutBtn.style.display = currentCustomer ? 'block' : 'none';
            }
        }

        function showHowItWorksBanner() {
            if (howItWorks) howItWorks.style.display = 'block';
            if (categoriesSection) categoriesSection.style.display = 'none';
            if (sellersSection) sellersSection.style.display = 'none';
            if (productsSection) productsSection.style.display = 'none';
            if (orderSummary) orderSummary.style.display = 'none';
        }

        function hideHowItWorksBanner() {
            if (howItWorks) howItWorks.style.display = 'none';
            if (categoriesSection) categoriesSection.style.display = 'block';
            if (sellersSection) sellersSection.style.display = 'block';
            if (orderSummary) orderSummary.style.display = 'flex';
        }

        function updateCustomerUI() {
            if (currentCustomer) {
                if (userName) userName.textContent = currentCustomer.name || 'Profilim';
                if (profileName) profileName.textContent = currentCustomer.name || '-';
                if (profilePhone) profilePhone.textContent = currentCustomer.phone || '-';
                if (profileCity) profileCity.textContent = currentCustomer.city || '-';
                if (profileAddress) profileAddress.textContent = currentCustomer.address || '-';
                if (profileBonus) profileBonus.textContent = money(currentCustomer.bonus_amount || 0);
                if (profileAvatar) profileAvatar.textContent = (currentCustomer.name || 'P').charAt(0).toUpperCase();
            }
        }


 	// Referans linki oluştur
        async function generateReferralLink() {
            if (!currentCustomer) {
                alert('Önce giriş yapmalısınız');
                return;
            }
            
            try {
                // Önce mevcut bir referans linki var mı kontrol et
                const { data: existingLink, error: checkError } = await supabase
                    .from('referral_links')
                    .select('referral_code, group_code')
                    .eq('owner_user_id', currentCustomer.id)
                    .maybeSingle();
                
                let referralCode, groupCode;
                
                if (existingLink) {
                    referralCode = existingLink.referral_code;
                    groupCode = existingLink.group_code;
                } else {
                    // Yeni referans kodu oluştur
                    referralCode = generateReferralCode();
                    
                    // Grup kodu oluştur veya mevcut kodu al
                    const { data: groupData, error: groupError } = await supabase
                        .from('referral_groups')
                        .select('group_code')
                        .eq('leader_user_id', currentCustomer.id)
                        .maybeSingle();
                    
                    if (groupData) {
                        groupCode = groupData.group_code;
                    } else {
                        groupCode = generateGroupCode();
                        
                        // Yeni grup oluştur
                        const { error: groupCreateError } = await supabase
                            .from('referral_groups')
                            .insert([
                                {
                                    name: `${currentCustomer.name} Grubu`,
                                    leader_user_id: currentCustomer.id,
                                    group_code: groupCode,
                                    created_at: new Date().toISOString()
                                }
                            ]);
                        
                        if (groupCreateError) throw groupCreateError;
                    }
                    
                    // Yeni referans linki oluştur
                    const { error: linkError } = await supabase
                        .from('referral_links')
                        .insert([
                            {
                                owner_user_id: currentCustomer.id,
                                owner_phone: currentCustomer.phone,
                                referral_code: referralCode,
                                group_code: groupCode,
                                created_at: new Date().toISOString()
                            }
                        ]);
                    
                    if (linkError) throw linkError;
                }
                
                // Referans linkini paylaş
                const referralLink = `${window.location.origin}${window.location.pathname}?referral_groups=${groupCode}&referral_code=${referralCode}`;
                
                if (navigator.share) {
                    // Web Share API desteği varsa
                    navigator.share({
                        title: 'Onur Market Referans Linkim',
                        text: 'Onur Market\'ten alışveriş yapmak için linkimi kullanabilirsiniz.',
                        url: referralLink
                    });
                } else {
                    // Web Share API desteklemiyorsa
                    navigator.clipboard.writeText(referralLink).then(() => {
                        alert('Referans linki panoya kopyalandı: ' + referralLink);
                    });
                }
                
            } catch (error) {
                console.error('Referans linki oluşturma hatası:', error);
                alert('Referans linki oluşturulurken bir hata oluştu.');
            }
        }

        // Benzersiz referans kodu oluştur
        function generateReferralCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // Benzersiz grup kodu oluştur
        function generateGroupCode() {
            return Math.random().toString(36).substring(2, 6).toUpperCase() + 
                   Math.random().toString(36).substring(2, 6).toUpperCase();
        }


 	
        function emergencyFallback() {
            debugLog('🆘 Acil durum modu aktif');
            setupLocationEvents();
            
            if (!selectedLocation) {
                setTimeout(() => {
                    showLocationModal();
                }, 2000);
            }
        }



        // =============================================
        // ANA UYGULAMA BAŞLATMA
        // =============================================

        async function initApp() {
            try {
                debugLog('🚀 === UYGULAMA BAŞLATILIYOR ===');
		// 1. VERİTABANI ODAKLI ASİSTAN SİSTEMİ		
		await loadCommandRules();

                // 2. DOM hazır olana kadar bekle
                await waitForDOMElements();
                debugLog('✅ DOM hazır');

                // 3. Konum event'lerini ayarla
                setupLocationEvents();
                
                // 4. StoreTypes yükle
                await loadStoreTypes();
                debugLog('✅ StoreTypes yüklendi');

                // 5. Oturumu geri yükle
                await restoreSession();
                debugLog('✅ Oturum yüklendi');

                // 6. Konum yönetimi
                initializeLocation();
                debugLog('✅ Konum yönetimi tamamlandı');

                // 7. UI elementlerini ayarla
                updateUIAfterLogin();
                debugLog('✅ UI güncellendi');

                // 8. Event handler'ları ayarla
                setupEventHandlers();
                debugLog('✅ Event handlerlar ayarlandı');

                debugLog('🎉 === UYGULAMA BAŞLATMA TAMAMLANDI ===');

            } catch (error) {
                console.error('💥 Uygulama başlatma hatası:', error);
                emergencyFallback();
            }
        }

        // Yardımcı fonksiyonlar
        function scrollElement(element, amount) {
            if (element) {
                element.scrollBy({ left: amount, behavior: 'smooth' });
            }
        }

        function toggleCart() {
            if (cartContainer.classList.contains('open')) {
                closeCart();
            } else {
                openCart();
            }
        }

        function openCart() {
            if (cartContainer) {
                cartContainer.classList.add('open');
            }
        }

        function closeCart() {
            if (cartContainer) {
                cartContainer.classList.remove('open');
            }
        }

        // Sayfa yüklendiğinde initApp'i çalıştır
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM yüklendi, uygulama başlatılıyor...');
            initApp();
        });

	document.addEventListener('DOMContentLoaded', initApp);

       
      

// =============================================
// 1. BÖLÜM: LOGIN GİRİŞ VE KAYIT SÜRECİ
// =============================================

// Kullanıcı oturumunu geri yükle
async function restoreSession() {
    try {
        const savedSession = localStorage.getItem('onurmarket_session');
        if (savedSession) {
            const sessionData = JSON.parse(savedSession);
            const now = new Date().getTime();
            
            // 24 saat içindeki oturumu geri yükle
            if (now - sessionData.timestamp < 24 * 60 * 60 * 1000) {
                currentCustomer = sessionData.customer;
                cart = sessionData.cart || [];
                selectedSellerId = sessionData.selectedSellerId;
                selectedLocation = sessionData.selectedLocation;
                
                updateCustomerUI();
                updateCartUI();
                
                if (currentCustomer) {
                    hideHowItWorksBanner();
                    orderSummary.style.display = 'flex';
                    
                    if (selectedLocation) {
                        updateLocationText();
                    } else {
                        showLocationModal();
                    }
                }
            } else {
                localStorage.removeItem('onurmarket_session');
            }
        }
    } catch (error) {
        console.error('Oturum geri yükleme hatası:', error);
        localStorage.removeItem('onurmarket_session');
    }
}

// Oturumu kaydet
function saveSession() {
    if (currentCustomer) {
        const sessionData = { 
            customer: currentCustomer, 
            cart: cart, 
            selectedSellerId: selectedSellerId, 
            selectedLocation: selectedLocation, 
            timestamp: new Date().getTime()
        };
        localStorage.setItem('onurmarket_session', JSON.stringify(sessionData));
    }
}


	// Referans kodu işleme
        async function processReferralCode(code, groupCode) {
            try {
                const { data, error } = await supabase
                    .from('referral_links')
                    .select('owner_user_id, referral_code, group_code, is_used')
                    .eq('referral_code', code)
                    .eq('group_code', groupCode)
                    .single();
                
                if (error) throw error;
                
                if (data) {
                    if (data.is_used) {
                        assistantMessage.textContent = "Bu referans linki daha önce kullanılmış.";
                        return;
                    }
                    
                    referralGroupCode = data.group_code;
                    // Referans sahibinin bilgilerini al
                    const { data: ownerData } = await supabase
                        .from('profiles')
                        .select('full_name')
                        .eq('id', data.owner_user_id)
                        .single();
                    
                    if (ownerData) {
                        assistantMessage.textContent += ` Referans ile geldiniz: ${ownerData.full_name}`;
                    }
                }
            } catch (error) {
                console.error('Referans kodu işleme hatası:', error);
            }
        }



// =============================================
// 1. BÖLÜM EKSİKLERİNİ TAMAMLAMA - VERİTABANI BAĞLANTILARI
// =============================================

// Müşteri kontrolü - ADRES TEYİDİ EKLENDİ
async function checkCustomerByPhone(phone) {
    try {
        const cleanPhone = phone.replace(/\D/g, '');
        
        const { data, error } = await supabase
            .from('customers')
            .select('*')
            .eq('phone', cleanPhone)
            .maybeSingle();
        
        if (error) {
            console.error('Müşteri sorgulama hatası:', error);
            throw error;
        }
        
        if (data) {
            // MEVCUT KULLANICI - Konum karşılaştırması yap
            currentCustomer = data;
            
            // Konum tespit edilmişse ve mevcut adresten farklıysa not düş
            if (isLocationDetected && currentCustomer.address) {
                const currentAddress = `${userLocation.district}, ${userLocation.city}`;
                const savedAddress = currentCustomer.address;
                
                if (currentAddress !== savedAddress) {
                    debugLog('📍 Konum farkı tespit edildi:', { current: currentAddress, saved: savedAddress });
                    // Bu bilgiyi sipariş notlarına ekleyeceğiz
                }
            }
            
            updateCustomerUI();
            hideHowItWorksBanner();
            orderSummary.style.display = 'flex';
            
            speakToUser(`Hoş geldiniz ${data.name}! Sisteminiz açılmıştır.`);
            conversationStep = 10;
            
            saveSession();
            
            if (!selectedLocation) {
                showLocationModal();
            }
        } else {
            // YENİ KULLANICI - Adres teyidi yap
            speakToUser("Telefon numaranız kayıtlı değil. Yeni üyelik oluşturalım. Lütfen adınızı ve soyadınızı söyler misiniz?");
            conversationStep = 2;
            
            currentCustomer = { 
                phone: cleanPhone, 
                role: 'customer',
                bonus_amount: 0 
            };
            
            // Konum tespiti yapılmamışsa yap
            if (!isLocationDetected) {
                speakToUser("Konumunuz belirleniyor...");
                const locationSuccess = await detectUserLocation();
                if (locationSuccess) {
                    // Adres teyidi iste
                    const addressConfirmed = await confirmAddressWithAssistant();
                    if (addressConfirmed) {
                        // Teyit edilen adresi kaydet
                        currentCustomer.address = userLocation.fullAddress;
                        currentCustomer.city = userLocation.city;
                        speakToUser("Harika! Şimdi adınızı ve soyadınızı söyleyin.");
                    }
                }
            }
        }
        
    } catch (error) {
        console.error('Müşteri kontrol hatası:', error);
        speakToUser("Sistemde geçici bir sorun oluştu. Lütfen daha sonra tekrar deneyiniz.");
    }
}

    // Yeni müşteri kaydı - KONUM BİLGİSİNİ EKLE
async function createCustomerProfile(customerData) {
    try {
        // Konum bilgisini customerData'ya ekle (teyit edilmişse)
        const address = userLocation ? userLocation.fullAddress : (customerData.address || 'Adres belirtilmemiş');
        const city = userLocation ? userLocation.city : (customerData.city || 'Şehir belirtilmemiş');
        
        const { data, error } = await supabase
            .from('customers')
            .insert([{
                name: customerData.name,
                phone: customerData.phone,
                city: city,
                address: address,
                role: 'customer',
                bonus_amount: 0,
                created_at: new Date().toISOString()
            }])
            .select()
            .single();
        
        if (error) throw error;
        
        currentCustomer = data;
        updateCustomerUI();

        // Referans bilgilerini ekle
        if (referralGroupCode) {
            customerData.group_code = referralGroupCode;
        }
        if (referralCode) {
            customerData.referrer_id = await getReferrerId(referralCode);
        }

        hideHowItWorksBanner();
        orderSummary.style.display = 'flex';
        
        speakToUser(`Profiliniz oluşturuldu! Hoş geldiniz ${customerData.name}.`);
        conversationStep = 10;
        
        saveSession();
       
        // Referans kodu varsa işle
        if (referralCode) {
            await processReferralAfterSignup();
        }
 
        if (!selectedLocation) {
            showLocationModal();
        }
        
    } catch (error) {
        console.error('Profil oluşturma hatası:', error);
        speakToUser("Profil oluşturulurken bir hata oluştu. Lütfen daha sonra tekrar deneyin.");
    }
}

 // Referans kodundan referrer_id'yi al
        async function getReferrerId(referralCode) {
            try {
                const { data, error } = await supabase
                    .from('referral_links')
                    .select('owner_user_id')
                    .eq('referral_code', referralCode)
                    .single();
                
                if (error) throw error;
                
                return data.owner_user_id;
            } catch (error) {
                console.error('Referrer ID alma hatası:', error);
                return null;
            }
        }

        // Üyelik sonrası referans işleme
        async function processReferralAfterSignup() {
            try {
                // Referans linkini kullanılmış olarak işaretle
                const { error: updateError } = await supabase
                    .from('referral_links')
                    .update({ is_used: true })
                    .eq('referral_code', referralCode);
                
                if (updateError) throw updateError;
                
                // Referans takip kaydı oluştur
                const { error: trackingError } = await supabase
                    .from('referral_tracking')
                    .insert([
                        {
                            referral_code: referralCode,
                            group_code: referralGroupCode,
                            referrer_user_id: await getReferrerId(referralCode),
                            new_user_id: currentCustomer.id,
                            created_at: new Date().toISOString()
                        }
                    ]);
                
                if (trackingError) throw trackingError;
                
                console.log('Referans kaydı başarılı');
                
            } catch (error) {
                console.error('Referans işleme hatası:', error);
            }
        }

 
// Kullanıcı arayüzünü güncelle
function updateCustomerUI() {
    if (currentCustomer) {
        if (userName) userName.textContent = currentCustomer.name || 'Profilim';
        if (profileName) profileName.textContent = currentCustomer.name || '-';
        if (profilePhone) profilePhone.textContent = currentCustomer.phone || '-';
        if (profileCity) profileCity.textContent = currentCustomer.city || '-';
        if (profileAddress) profileAddress.textContent = currentCustomer.address || '-';
        if (profileBonus) profileBonus.textContent = money(currentCustomer.bonus_amount || 0);
        if (profileAvatar) profileAvatar.textContent = (currentCustomer.name || 'P').charAt(0).toUpperCase();
    }
}

// Çıkış işlemi
async function logout() {
    try {
        speakToUser("Oturumunuz kapatılıyor...");
        
        // Görsel geri bildirim
        showNotification("Çıkış yapılıyor...", "info");
        
        setTimeout(() => {
            performLogout();
        }, 1500);
        
    } catch (error) {
        console.error('Çıkış işlemi sırasında hata:', error);
        performEmergencyLogout();
    }
}

// Asıl çıkış işlemleri
function performLogout() {
    currentCustomer = null;
    cart = [];
    clearUserDataFromStorage();
    updateUIAfterLogout();
    
    speakToUser("Oturumunuz başarıyla kapatıldı. Yeni bir alışverişe başlayabilirsiniz.");
    
    setTimeout(() => {
        window.location.reload();
    }, 2000);
}

// Acil durum çıkışı
function performEmergencyLogout() {
    localStorage.clear();
    currentCustomer = null;
    cart = [];
    updateUIAfterLogout();
    speakToUser("Oturumunuz kapatıldı.");
    
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

// Kullanıcı verilerini temizle
function clearUserDataFromStorage() {
    localStorage.removeItem('onurmarket_session');
    localStorage.removeItem('currentCustomer');
}

// Çıkış sonrası UI güncelleme
function updateUIAfterLogout() {
    if (userName) userName.textContent = 'Profilim';
    if (profileName) profileName.textContent = '-';
    if (profilePhone) profilePhone.textContent = '-';
    if (profileCity) profileCity.textContent = '-';
    if (profileAddress) profileAddress.textContent = '-';
    if (profileBonus) profileBonus.textContent = '0 ₺';
    if (profileAvatar) profileAvatar.textContent = 'P';
    
    if (orderSummary) orderSummary.style.display = 'none';
    showHowItWorksBanner();
}

// Banner yönetimi
function showHowItWorksBanner() {
    const banner = document.getElementById('howItWorks');
    if (banner) banner.style.display = 'block';
    
    // Diğer bölümleri gizle
    const sections = ['categoriesSection', 'sellersSection', 'productsSection'];
    sections.forEach(section => {
        const el = document.getElementById(section);
        if (el) el.style.display = 'none';
    });
}

function hideHowItWorksBanner() {
    const banner = document.getElementById('howItWorks');
    if (banner) banner.style.display = 'none';
    
    // Diğer bölümleri göster
    const sections = ['categoriesSection', 'sellersSection'];
    sections.forEach(section => {
        const el = document.getElementById(section);
        if (el) el.style.display = 'block';
    });
}

// Bildirim göster
function showNotification(message, type = 'info') {
    // Basit bir bildirim sistemi
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background: ${type === 'error' ? '#f44336' : type === 'success' ? '#4CAF50' : '#2196F3'};
        color: white;
        border-radius: 5px;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}


// =============================================
// 2. BÖLÜM STORE TYPE - MAĞAZA TÜRLERİNİ LİSTELE
// =============================================
// Load store types - GÜNCELLENMİŞ
async function loadStoreTypes() {
    try {
        debugLog('🔧 StoreTypes yükleniyor...');
        
        const { data, error, count } = await supabase
            .from('store_type')
            .select('*', { count: 'exact' })
            .eq('status', 'Active')
            .order('sort_code');

        if (error) throw error;

        if (data && data.length > 0) {
            storeTypes = data;
            localStorage.setItem('storeTypes', JSON.stringify(storeTypes));
            debugLog(`✅ StoreTypes sunucudan yüklendi: ${data.length} adet`);
            displayStoreTypes(storeTypes);
            return;
        }

        throw new Error('StoreTypes verisi boş');
        
    } catch (error) {
        console.error('❌ StoreTypes yükleme hatası:', error);
        
        // Cache kontrolü
        const cached = localStorage.getItem('storeTypes');
        if (cached) {
            try {
                storeTypes = JSON.parse(cached);
                debugLog('✅ StoreTypes cache\'den yüklendi');
                displayStoreTypes(storeTypes);
                return;
            } catch (parseError) {
                console.error('❌ Cache parse hatası:', parseError);
            }
        }
        
        // Fallback
        await useFallbackStoreTypes();
    }
}
	
// Store type'ları ekranda göster - AKIŞ DÜZELTMESİ
function displayStoreTypes(types) {
    const sellerTypeGrid = document.getElementById('sellerTypeGrid');
    if (!sellerTypeGrid) {
        console.error('❌ SellerTypeGrid bulunamadı');
        return;
    }
    
    sellerTypeGrid.innerHTML = '';
    
    if (!types || types.length === 0) {
        sellerTypeGrid.innerHTML = `
            <div class="text-center" style="min-width: 100%; padding: 40px; color: #6c757d;">
                <i class="fas fa-store fa-3x mb-3"></i>
                <p>Mağaza tipi bulunamadı</p>
            </div>
        `;
        return;
    }
    
    const iconMap = {
        'Market': 'fas fa-store',
        'Restoran': 'fas fa-utensils',
        'Eczane': 'fas fa-prescription-bottle',
        'Fırın': 'fas fa-bread-slice',
        'Kafe': 'fas fa-coffee'
    };
    
    types.forEach(type => {
        const typeCard = document.createElement('div');
        typeCard.className = 'seller-type-card';
        typeCard.dataset.typeId = type.id;
        typeCard.dataset.typeName = type.name;
        
        typeCard.innerHTML = `
            <div class="seller-type-icon">
                <i class="${iconMap[type.name] || 'fas fa-store'}"></i>
            </div>
            <div class="seller-type-name">${type.name}</div>
        `;
        
        typeCard.addEventListener('click', () => {
            // Tüm kartlardan seçimi kaldır
            document.querySelectorAll('.seller-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Bu kartı seçili yap
            typeCard.classList.add('selected');
            
            onStoreTypeSelected(type.id, type.name);
        });
        
        sellerTypeGrid.appendChild(typeCard);
    });
    
    // Store type seçildiğinde diğer bölümleri gizle
    if (sellersSection) sellersSection.style.display = 'none';
    if (categoriesSection) categoriesSection.style.display = 'none';
    if (productsSection) productsSection.style.display = 'none';
    
    debugLog("✅ Store type'lar başarıyla yüklendi");
}

// Store type seçildiğinde - Konum zorunluluğu
async function onStoreTypeSelected(storeTypeId, storeTypeName) {
    debugLog("🛍️ Store type seçildi:", storeTypeName, "ID:", storeTypeId);
    
    // Konum kontrolü - eğer konum seçilmemişse modal aç
    if (!selectedLocation) {
        debugLog('📍 Konum seçilmemiş, modal açılıyor');
        speakToUser("Lütfen önce bir konum seçiniz.");
        showLocationModal();
        return;
    }
    
    // Adrese teslim seçildiyse konum bilgisi kontrolü
    if (selectedLocation === 'delivery' && !isLocationDetected) {
        debugLog('📍 Adres bilgisi yok, modal açılıyor');
        speakToUser("Adrese teslim için lütfen konumunuzu belirleyin.");
        showLocationModal();
        return;
    }
    
    // Store type bilgisini kaydet
    selectedStoreTypeId = storeTypeId;
    selectedStoreTypeName = storeTypeName;
    
    await proceedWithStoreTypeSelection(storeTypeId, storeTypeName);
}

// Konum seçildikten sonra store type işlemini devam ettir - AKIŞ DÜZELTMESİ
async function proceedWithStoreTypeSelection(storeTypeId, storeTypeName) {
    // Önceki seçimleri temizle
    selectedSellerId = null;
    selectedCategoryId = null;
    products = [];
    
    // UI durumunu sıfırla
    resetSections();
    
    try {
        // SADECE SATICILARI YÜKLE - Reyonları henüz yükleme
        await loadSellersByStoreType(storeTypeId);
        
        // Sadece satıcılar bölümünü göster
        if (sellersSection) sellersSection.style.display = 'block';
        if (categoriesSection) categoriesSection.style.display = 'none'; // Reyonları gizle
        if (productsSection) productsSection.style.display = 'none'; // Ürünleri gizle
        
        debugLog(`✅ ${storeTypeName} için satıcılar yüklendi`);
        speakToUser(`${storeTypeName} seçildi. Size en yakın ${storeTypeName.toLowerCase()}lar listeleniyor. Lütfen bir satıcı seçin.`);
        
    } catch (error) {
        console.error('❌ Store type seçiminde hata:', error);
        speakToUser("Mağaza yüklenirken bir hata oluştu. Lütfen tekrar deneyin.");
    }
}

// Bölümleri sıfırla - AKIŞ DÜZELTMESİ
function resetSections() {
    // Tüm seçimleri temizle
    document.querySelectorAll('.seller-type-card, .seller-card, .category-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Grid içeriklerini sıfırla
    if (sellerGrid) {
        sellerGrid.innerHTML = '<div class="text-center">Yükleniyor...</div>';
    }
    if (categoriesGrid) {
        categoriesGrid.innerHTML = '<div class="text-center">Yükleniyor...</div>';
    }
    if (productsGrid) {
        productsGrid.innerHTML = '<div class="text-center">Bir reyon seçin</div>';
    }
    
    // Bölüm görünürlüğünü ayarla
    if (sellersSection) sellersSection.style.display = 'none';
    if (categoriesSection) categoriesSection.style.display = 'none';
    if (productsSection) productsSection.style.display = 'none';
    
    if (selectedSellerInfo) {
        selectedSellerInfo.textContent = 'Satıcı seçilmedi';
    }
}
// =============================================
// 2. BÖLÜM: REYONLARIN, SATICILARIN YÜKLENMESİ
// =============================================
// Reyon yükleme - TAMİR EDİLMİŞ
async function loadReyonsByStoreType(storeTypeId) {
    try {
        debugLog(`🛒 Reyonlar yükleniyor, StoreType: ${storeTypeId}`);
        
        const { data, error } = await supabase
            .from('reyon')
            .select('*')
            .eq('store_type_id', storeTypeId)
            .order('name');

        if (error) {
            console.error('❌ Reyon yükleme hatası:', error);
            throw error;
        }

        categories = data || [];
        displayCategories(categories, 'reyon');
        debugLog(`✅ Reyonlar yüklendi: ${categories.length} adet`);

    } catch (error) {
        console.error('❌ Reyon yükleme hatası:', error);
        // Fallback demo reyonlar
        categories = getDemoReyons(storeTypeId);
        displayCategories(categories, 'reyon');
        debugLog('🔄 Demo reyonlar kullanılıyor');
    }
}

// Kategorileri göster - AKIŞ DÜZELTMESİ
function displayCategories(categoriesToShow, type) {
    const categoriesGrid = document.getElementById('categoriesGrid');
    if (!categoriesGrid) return;
    
    categoriesGrid.innerHTML = '';
    
    if (categoriesToShow.length === 0) {
        categoriesGrid.innerHTML = `
            <div class="text-center" style="min-width: 100%; padding: 40px; color: #6c757d;">
                <i class="fas fa-box-open fa-3x mb-3"></i>
                <p>Kategori bulunamadı</p>
            </div>
        `;
        return;
    }
    
    const iconMap = {
        'Meyve & Sebze': 'fas fa-apple-alt',
        'Süt Ürünleri': 'fas fa-cheese',
        'Et & Tavuk': 'fas fa-drumstick-bite',
        'Temel Gıda': 'fas fa-wheat-alt',
        'İçecekler': 'fas fa-wine-bottle',
        'Ana Yemekler': 'fas fa-utensils',
        'Çorbalar': 'fas fa-bowl-food',
        'Salatalar': 'fas fa-leaf',
        'Tatlılar': 'fas fa-ice-cream',
        'Ağrı Kesiciler': 'fas fa-pills',
        'Vitaminler': 'fas fa-capsules',
        'Ekmekler': 'fas fa-bread-slice',
        'Pastalar': 'fas fa-birthday-cake'
    };
    
    categoriesToShow.forEach(category => {
        const categoryCard = document.createElement('div');
        categoryCard.className = 'category-card';
        categoryCard.dataset.categoryId = category.id;
        categoryCard.dataset.categoryName = category.name;
        
        categoryCard.innerHTML = `
            <div class="category-icon">
                <i class="${iconMap[category.name] || 'fas fa-box'}"></i>
            </div>
            <div class="category-name">${category.name}</div>
        `;
        
        categoryCard.addEventListener('click', async function() {
            if (!selectedSellerId) {
                speakToUser("Önce bir satıcı seçmelisiniz.");
                return;
            }
            
            // Tüm kartlardan seçimi kaldır
            document.querySelectorAll('.category-card').forEach(c => {
                c.classList.remove('selected');
            });
            
            // Bu kartı seçili yap
            this.classList.add('selected');
            
            selectedCategoryId = category.id;
            
            // REYON SEÇİLDİĞİNDE ÜRÜNLERİ YÜKLE
            await loadProductsByReyon(category.id);
            
            debugLog(`🛒 Reyon seçildi: ${category.name}`);
            speakToUser(`${category.name} reyonundaki ürünler listeleniyor.`);
        });
        
        categoriesGrid.appendChild(categoryCard);
    });
}

// Reyona göre ürünleri yükle - YENİ FONKSİYON
async function loadProductsByReyon(reyonId) {
    try {
        debugLog(`📦 Reyona göre ürünler yükleniyor: ${reyonId}, Satıcı: ${selectedSellerId}`);
        
        if (!selectedSellerId) {
            speakToUser("Önce bir satıcı seçmelisiniz.");
            return;
        }
        
        const { data, error } = await supabase
            .from('product_prices')
            .select(`
                *,
                products (
                    id, name, imgurl, reyon_id, category_id, is_active, description
                )
            `)
            .eq('sube_id', selectedSellerId)
            .eq('products.reyon_id', reyonId)
            .eq('products.is_active', true);

        if (error) {
            console.error('❌ Ürün yükleme hatası:', error);
            throw error;
        }

        // Veriyi işle
        products = data
            .filter(item => item.products)
            .map(item => ({
                id: item.products.id,
                product_price_id: item.id,
                name: item.products.name,
                price: item.price,
                discount_price: item.discount_price,
                imgurl: item.products.imgurl,
                reyon_id: item.products.reyon_id,
                category_id: item.products.category_id,
                seller_id: selectedSellerId,
                description: item.products.description
            }));

        debugLog(`✅ Ürünler yüklendi: ${products.length} adet`);
        
        // Ürünleri göster
        displayProducts(products);
        
        // Ürünler bölümünü göster
        if (productsSection) productsSection.style.display = 'block';
        
        if (products.length === 0) {
            speakToUser("Bu reyonda ürün bulunamadı.");
        } else {
            speakToUser(`${products.length} ürün bulundu.`);
        }

    } catch (error) {
        console.error('❌ Ürün yükleme hatası:', error);
        products = getDemoProducts();
        displayProducts(products);
        speakToUser("Ürünler yüklenirken hata oluştu. Demo ürünler gösteriliyor.");
        debugLog('🔄 Demo ürünler kullanılıyor');
    }
}
// Satıcı yükleme fonksiyonunu güncelle - Mesafe kontrolü ekle
async function loadSellersByStoreType(storeTypeId) {
    try {
        debugLog(`🔍 Satıcılar yükleniyor: ${storeTypeId}`);
        
        // Tüm aktif satıcıları getir
        const { data, error } = await supabase
            .from('seller_profiles')
            .select('*')
            .eq('status', 'True')
            .eq('store_type_id', storeTypeId)
            .order('business_name');

        if (error) {
            console.error('❌ Satıcı yükleme hatası:', error);
            throw error;
        }

        if (data && data.length > 0) {
            // Mesafe kontrolü yap
            const filteredSellers = await filterSellersByDistance(data);
            sellers = filteredSellers;
            
            debugLog(`✅ Satıcılar yüklendi: ${filteredSellers.length} adet (${data.length - filteredSellers.length} satıcı mesafe dışında)`);
            updateSellersGrid();
            
            if (filteredSellers.length === 0) {
                speakToUser("Bu kategoride size yakın satıcı bulunamadı. Lütfen başka bir kategori seçin veya konumunuzu değiştirin.");
            }
        } else {
            debugLog('⚠️ Bu kategoride satıcı bulunamadı');
            sellers = [];
            updateSellersGrid();
            speakToUser("Bu kategoride satıcı bulunamadı. Lütfen başka bir kategori seçin.");
        }

    } catch (error) {
        console.error('❌ Satıcı yükleme hatası:', error);
        sellers = getDemoSellers();
        updateSellersGrid();
        debugLog('🔄 Demo satıcılar kullanılıyor');
    }
}

// Satıcıları mesafeye göre filtrele
async function filterSellersByDistance(allSellers) {
    if (!userLocation.city || !userLocation.district) {
        debugLog('⚠️ Konum bilgisi eksik, tüm satıcılar gösteriliyor');
        return allSellers;
    }
    
    const filteredSellers = [];
    
    for (const seller of allSellers) {
        const isWithinRange = await checkSellerDeliveryRange(seller);
        if (isWithinRange) {
            filteredSellers.push(seller);
        }
    }
    
    return filteredSellers;
}

// Satıcının teslimat bölgesini kontrol et
async function checkSellerDeliveryRange(seller) {
    try {
        // Satıcının teslimat bölgelerini getir
        const { data: deliveryAreas, error } = await supabase
            .from('seller_delivery_areas')
            .select('city, district, delivery_fee, min_order_amount')
            .eq('seller_id', seller.id)
            .eq('is_active', true);

        if (error) throw error;

        // Eğer satıcının teslimat bölgesi tanımlı değilse, tüm bölgelere teslimat yapıyor kabul et
        if (!deliveryAreas || deliveryAreas.length === 0) {
            debugLog(`✅ ${seller.business_name} - Teslimat bölgesi tanımlı değil, tüm bölgelere teslimat`);
            return true;
        }

        // Kullanıcının konumunu satıcının teslimat bölgeleriyle karşılaştır
        const matchedArea = deliveryAreas.find(area => 
            area.city.toLowerCase().includes(userLocation.city.toLowerCase()) &&
            area.district.toLowerCase().includes(userLocation.district.toLowerCase())
        );

        if (matchedArea) {
            debugLog(`✅ ${seller.business_name} - Teslimat bölgesi uygun: ${userLocation.district}, ${userLocation.city}`);
            
            // Teslimat ücreti ve min. sipariş tutarını satıcı nesnesine ekle
            seller.delivery_fee = matchedArea.delivery_fee || 0;
            seller.min_order_amount = matchedArea.min_order_amount || 0;
            
            return true;
        } else {
            debugLog(`❌ ${seller.business_name} - Teslimat bölgesi dışında: ${userLocation.district}, ${userLocation.city}`);
            return false;
        }

    } catch (error) {
        console.error('Teslimat bölgesi kontrol hatası:', error);
        // Hata durumunda teslimat yapıyor kabul et
        return true;
    }
}

// İlk satıcıyı otomatik seç
function selectFirstSeller(sellerId) {
    const sellerCard = document.querySelector(`[data-seller-id="${sellerId}"]`);
    if (sellerCard) {
        sellerCard.click();
        debugLog(`✅ İlk satıcı otomatik seçildi: ${sellerId}`);
    }
}
	
// Satıcı grid'ini güncelle - Teslimat bilgisi ekle
function updateSellersGrid() {
    const sellerGrid = document.getElementById('sellerGrid');
    if (!sellerGrid) return;
    
    sellerGrid.innerHTML = '';
    
    if (sellers.length === 0) {
        sellerGrid.innerHTML = `
            <div class="text-center" style="min-width: 100%; padding: 40px; color: #6c757d;">
                <i class="fas fa-store fa-3x mb-3"></i>
                <p>Bu kategoride size yakın satıcı bulunamadı</p>
                <small>Lütfen konumunuzu veya kategoriyi değiştirin</small>
            </div>
        `;
        return;
    }
    
    sellers.forEach(seller => {
        const sellerCard = document.createElement('div');
        sellerCard.className = 'seller-card';
        sellerCard.dataset.sellerId = seller.id;
        
        if (selectedSellerId === seller.id) {
            sellerCard.classList.add('selected');
        }
        if (isSellerLocked && selectedSellerId !== seller.id) {
            sellerCard.classList.add('disabled');
        }
        
        // Teslimat bilgilerini hazırla
        let deliveryInfo = '';
        if (seller.delivery_fee > 0) {
            deliveryInfo = `<div class="delivery-fee">Teslimat: ${money(seller.delivery_fee)}</div>`;
        } else if (seller.delivery_fee === 0) {
            deliveryInfo = `<div class="delivery-fee free">Ücretsiz Teslimat</div>`;
        }
        
        if (seller.min_order_amount > 0) {
            deliveryInfo += `<div class="min-order">Min. Sipariş: ${money(seller.min_order_amount)}</div>`;
        }
        
        sellerCard.innerHTML = `
            <div class="seller-image-container">
                <img src="${seller.imgurl || getDefaultSellerImage(seller)}" 
                     alt="${seller.business_name || seller.full_name}" 
                     class="seller-image"
                     onerror="this.src='${getDefaultSellerImage(seller)}'; this.onerror=null;">
            </div>
            <div class="seller-info">
                <div class="seller-name">${seller.business_name || seller.full_name}</div>
                <div class="seller-details">
                    <span><i class="fas fa-map-marker-alt"></i> ${seller.city || 'Şehir belirtilmemiş'}</span>
                    <span><i class="fas fa-star" style="color: gold;"></i> ${seller.rating || '4.5'}</span>
                </div>
                ${deliveryInfo ? `<div class="delivery-info">${deliveryInfo}</div>` : ''}
            </div>
        `;
        
        sellerCard.addEventListener('click', () => {
            if (isSellerLocked && selectedSellerId !== seller.id) {
                speakToUser("Önce sepetinizi boşaltmalısınız farklı bir satıcı seçmek için.");
                return;
            }
            
            selectSeller(seller);
        });
        
        sellerGrid.appendChild(sellerCard);
    });
}


// Varsayılan resim fonksiyonu ekleyin:
function getDefaultSellerImage(seller) {
    const sellerName = seller.business_name || seller.full_name || 'Satıcı';
    // Base64 encoded basit bir placeholder
    return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGVlMmYzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY3Njc2NyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPlNhdMSxY8SxPC90ZXh0Pjwvc3ZnPg==';
}

// Satıcı seç - AKIŞ DÜZELTMESİ
async function selectSeller(seller) {
    debugLog(`🎯 Satıcı seçiliyor: ${seller.business_name || seller.full_name}`);
    
    // Önceki seçimleri temizle
    document.querySelectorAll('.seller-card, .category-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Yeni satıcıyı seç
    const sellerCard = document.querySelector(`[data-seller-id="${seller.id}"]`);
    if (sellerCard) {
        sellerCard.classList.add('selected');
    }
    
    selectedSellerId = seller.id;
    selectedCategoryId = null;
    products = []; // Ürünleri temizle
    
    // Satıcı bilgisini güncelle
    if (selectedSellerInfo) {
        selectedSellerInfo.innerHTML = `
            <i class="fas fa-store"></i> ${seller.business_name || seller.full_name} 
            <small style="color: var(--gray);">- ${seller.city || ''}</small>
        `;
    }
    
    // REYONLARI YÜKLE ve GÖSTER
    await loadReyonsByStoreType(selectedStoreTypeId);
    
    // Bölüm görünürlüğünü ayarla
    if (categoriesSection) categoriesSection.style.display = 'block'; // Reyonları göster
    if (productsSection) productsSection.style.display = 'none'; // Ürünleri gizle
    
    // Ürünler grid'ini temizle
    if (productsGrid) productsGrid.innerHTML = '<div class="text-center">Bir reyon seçin</div>';
    
    debugLog(`✅ Satıcı seçildi: ${seller.business_name || seller.full_name}`);
    speakToUser(`${seller.business_name || seller.full_name} seçildi. Şimdi bir reyon seçin.`);
}

// Reyonaları güncelle - YENİ FONKSİYON
function updateReyonsAvailability() {
    if (!categories || categories.length === 0) return;
    
    const categoryCards = document.querySelectorAll('.category-card');
    categoryCards.forEach(card => {
        if (selectedSellerId) {
            card.style.opacity = '1';
            card.style.cursor = 'pointer';
            card.style.pointerEvents = 'auto';
        } else {
            card.style.opacity = '0.5';
            card.style.cursor = 'not-allowed';
            card.style.pointerEvents = 'none';
        }
    });
}

// Reyona göre ürünleri grupla
function displayProductsByReyon(productsToShow) {
    if (!productsToShow || productsToShow.length === 0) {
        productsGrid.innerHTML = `
            <div class="text-center" style="grid-column: 1 / -1; padding: 40px; color: #6c757d;">
                <i class="fas fa-box-open fa-3x mb-3"></i>
                <p>Bu satıcıda ürün bulunamadı</p>
            </div>
        `;
        return;
    }
    
    // Reyona göre grupla
    const productsByReyon = {};
    productsToShow.forEach(product => {
        const reyonId = product.reyon_id || 'other';
        if (!productsByReyon[reyonId]) {
            productsByReyon[reyonId] = [];
        }
        productsByReyon[reyonId].push(product);
    });
    
    // Ürünleri göster
    displayProducts(productsToShow);
}	
// Reyonaları ürünlerle güncelle
function updateReyonsWithProducts(products) {
    if (!categories || categories.length === 0) return;
    
    // Ürünlerin reyon ID'lerini topla
    const productReyonIds = [...new Set(products.map(p => p.reyon_id).filter(id => id))];
    
    // Reyon kartlarını güncelle
    const categoryCards = document.querySelectorAll('.category-card');
    categoryCards.forEach(card => {
        const categoryId = card.dataset.categoryId;
        const hasProducts = productReyonIds.includes(categoryId);
        
        if (hasProducts) {
            card.style.opacity = '1';
            card.style.cursor = 'pointer';
        } else {
            card.style.opacity = '0.5';
            card.style.cursor = 'not-allowed';
        }
    });
}	
	// Fallback veriler
async function useFallbackStoreTypes() {
    // Manuel olarak tüm store type'ları tanımlayın
    storeTypes = [
        { id: '1', name: 'Market', code: 'market', description: 'Market ve bakkallar' },
        { id: '2', name: 'Restoran', code: 'restaurant', description: 'Yemek restoranları' },
        { id: '3', name: 'Kafe', code: 'cafe', description: 'Kafe ve pastaneler' },
        { id: '4', name: 'Fırın', code: 'bakery', description: 'Fırın ve unlu mamüller' },
        { id: '5', name: 'Eczane', code: 'pharmacy', description: 'Eczane ve ilaçlar' },
        { id: '6', name: 'Teknoloji', code: 'technology', description: 'Elektronik ürünler' },
        { id: '7', name: 'Giyim', code: 'clothing', description: 'Giyim mağazaları' },
        { id: '8', name: 'Kitap', code: 'bookstore', description: 'Kitapçılar' },
        { id: '9', name: 'Spor', code: 'sports', description: 'Spor malzemeleri' },
        { id: '10', name: 'Kozmetik', code: 'cosmetics', description: 'Kozmetik ürünler' },
        { id: '11', name: 'Ev Eşyası', code: 'home', description: 'Ev eşyaları' },
        { id: '12', name: 'Oyuncak', code: 'toys', description: 'Oyuncak mağazaları' }
    ];
    
    localStorage.setItem('storeTypes', JSON.stringify(storeTypes));
    displayStoreTypes(storeTypes);
    debugLog('🔄 Manuel StoreTypes kullanılıyor');
}
function getDemoReyons(storeTypeId) {
    const demoReyons = {
        '1': [ // Market reyonları
            { id: '1', name: 'Meyve & Sebze', image_url: '' },
            { id: '2', name: 'Süt Ürünleri', image_url: '' },
            { id: '3', name: 'Et & Tavuk', image_url: '' }
        ],
        '2': [ // Restoran kategorileri
            { id: '4', name: 'Ana Yemekler' },
            { id: '5', name: 'Çorbalar' },
            { id: '6', name: 'Tatlılar' }
        ],
        '3': [ // Eczane kategorileri
            { id: '7', name: 'Ağrı Kesiciler' },
            { id: '8', name: 'Vitaminler' }
        ]
    };
    
    return demoReyons[storeTypeId] || [];
}

function getDemoSellers() {
    return [
        { 
            id: '1', 
            full_name: "Migros", 
            city: "İstanbul", 
            imgurl: "https://via.placeholder.com/200x120?text=Migros", 
            address: "Kadıköy, İstanbul"
        },
        { 
            id: '2', 
            full_name: "CarrefourSA", 
            city: "İstanbul", 
            imgurl: "https://via.placeholder.com/200x120?text=Carrefour", 
            address: "Beşiktaş, İstanbul"
        }
    ];
}





// =============================================
// 2. SESLİ GİRİŞ/KAYIT AKIŞI TAMAMLAMA
// =============================================

// =============================================
// KÖK BAZLI AKILLI KOMUT SİSTEMİ
// =============================================

// Kök komut yapısı: [ana_kök]:[alt_kök]
// Örnek: "1:1", "1:2", "2:1", "2:2"
let commandRoot = "0:0"; // Başlangıç kökü

function processVoiceCommand(transcript) {
    const message = transcript.toLowerCase().trim();
    if (userMessage) userMessage.textContent = transcript;

    debugLog(`🔊 Komut işleniyor: "${message}" | Kök: ${commandRoot}`);

    // Kökleri parçala
    const [mainRoot, subRoot] = commandRoot.split(':').map(Number);

    // 1. KÖK: GİRİŞ/KAYIT SÜRECİ
    if (mainRoot === 1) {
        handleRoot1(message, subRoot);
    }
    // 2. KÖK: SATICI İŞLEMLERİ
    else if (mainRoot === 2) {
        handleRoot2(message, subRoot);
    }
    // 3. KÖK: ÜRÜN İŞLEMLERİ
    else if (mainRoot === 3) {
        handleRoot3(message, subRoot);
    }
    // 4. KÖK: SEPET İŞLEMLERİ
    else if (mainRoot === 4) {
        handleRoot4(message, subRoot);
    }
    // 5. KÖK: ÖDEME İŞLEMLERİ
    else if (mainRoot === 5) {
        handleRoot5(message, subRoot);
    }
    // 0. KÖK: BAŞLANGIÇ/MENÜ
    else {
        handleRoot0(message);
    }
}

// =============================================
// 0. KÖK: BAŞLANGIÇ & ANA MENÜ
// =============================================

function handleRoot0(message) {
    if (message.includes('merhaba') || message.includes('selam') || message.includes('başla')) {
        speakToUser("Merhaba! Sesli sipariş sistemine hoş geldiniz. Giriş yapmak için 'giriş', misafir olarak devam etmek için 'misafir' diyebilirsiniz.");
        commandRoot = "0:1";
    }
    else if (message.includes('giriş') || message.includes('giriş yap')) {
        speakToUser("Giriş yapılıyor... Lütfen telefon numaranızı söyleyin.");
        commandRoot = "1:1";
    }
    else if (message.includes('misafir') || message.includes('misafir olarak')) {
        speakToUser("Misafir olarak devam ediyorsunuz. Hemen alışverişe başlayalım!");
        currentCustomer = { name: "Misafir", role: "guest" };
        updateUIAfterLogin();
        commandRoot = "2:1"; // Doğrudan satıcı seçimine git
    }
    else {
        speakToUser("Merhaba! Sesli sipariş sistemine hoş geldiniz. 'Giriş' veya 'Misafir' diyerek başlayabilirsiniz.");
    }
}

// =============================================
// 1. KÖK: GİRİŞ & KAYIT SÜRECİ
// =============================================

function handleRoot1(message, subRoot) {
    // 1:1 - Telefon numarası alma
    if (subRoot === 1) {
        const phoneMatch = message.match(/\d+/g);
        if (phoneMatch && phoneMatch.join('').length >= 10) {
            const phone = phoneMatch.join('');
            currentCustomer = { ...currentCustomer, phone: phone };
            speakToUser(`Telefon numaranız: ${phone}. Doğru mu?`);
            commandRoot = "1:2"; // Onay bekliyoruz
        } else {
            speakToUser("Telefon numaranızı anlayamadım. Lütfen 10 haneli numaranızı söyler misiniz?");
        }
    }
    // 1:2 - Telefon onayı
    else if (subRoot === 2) {
        if (message.includes('evet') || message.includes('doğru') || message.includes('onay')) {
            checkCustomerByPhone(currentCustomer.phone);
        } else {
            speakToUser("Özür dilerim. Lütfen telefon numaranızı tekrar söyler misiniz?");
            commandRoot = "1:1"; // Tekrar telefon soralım
        }
    }
}

// =============================================
// 2. KÖK: SATICI İŞLEMLERİ
// =============================================

// 2. KÖK: SATICI İŞLEMLERİ - AKIŞ DÜZELTMESİ
function handleRoot2(message, subRoot) {
    // 2:1 - Satıcı tipi seçimi
    if (subRoot === 1) {
        if (message.includes('market')) {
            selectStoreTypeByName('Market');
            speakToUser("Market seçildi. Size en yakın marketler yükleniyor...");
            commandRoot = "2:2"; // Satıcı seçimine geç
        }
        else if (message.includes('restoran') || message.includes('yemek')) {
            selectStoreTypeByName('Restoran');
            speakToUser("Restoran seçildi. Size en yakın restoranlar yükleniyor...");
            commandRoot = "2:2";
        }
        else if (message.includes('eczane')) {
            selectStoreTypeByName('Eczane');
            speakToUser("Eczane seçildi. Size en yakın eczaneler yükleniyor...");
            commandRoot = "2:2";
        }
        else if (message.includes('fırın')) {
            selectStoreTypeByName('Fırın');
            speakToUser("Fırın seçildi. Size en yakın fırınlar yükleniyor...");
            commandRoot = "2:2";
        }
        else if (message.includes('geri') || message.includes('önceki')) {
            speakToUser("Ana menüye dönülüyor...");
            commandRoot = "0:1";
        }
        else {
            speakToUser("Hangi tür satıcıdan alışveriş yapmak istersiniz? Market, restoran, eczane veya fırın?");
        }
    }
    // 2:2 - Satıcı seçimi
    else if (subRoot === 2) {
        if (sellers.length === 0) {
            speakToUser("Henüz satıcı yüklenmedi. Lütfen bekleyin.");
            return;
        }
        
        // Satıcı ismi ile eşleştirme
        const matchedSeller = sellers.find(seller => 
            message.includes(seller.business_name?.toLowerCase()) || 
            message.includes(seller.full_name?.toLowerCase())
        );
        
        if (matchedSeller) {
            selectSeller(matchedSeller);
            speakToUser(`${matchedSeller.business_name} seçildi. Şimdi bir reyon seçin.`);
            commandRoot = "2:3"; // Reyon seçimine geç
        } else {
            speakToUser(`Mevcut satıcılar: ${sellers.map(s => s.business_name || s.full_name).join(', ')}. Hangisini seçmek istersiniz?`);
        }
    }
    // 2:3 - Reyon seçimi
    else if (subRoot === 3) {
        if (categories.length === 0) {
            speakToUser("Henüz reyon yüklenmedi. Lütfen bekleyin.");
            return;
        }
        
        // Reyon ismi ile eşleştirme
        const matchedCategory = categories.find(category => 
            message.includes(category.name.toLowerCase())
        );
        
        if (matchedCategory) {
            // Reyon seçimi simüle et
            const categoryCard = document.querySelector(`[data-category-id="${matchedCategory.id}"]`);
            if (categoryCard) {
                categoryCard.click();
            }
            speakToUser(`${matchedCategory.name} reyonu seçildi. Ürünler listeleniyor.`);
            commandRoot = "3:1"; // Ürün seçimine geç
        } else {
            speakToUser(`Mevcut reyonlar: ${categories.map(c => c.name).join(', ')}. Hangisini seçmek istersiniz?`);
        }
    }
}
// =============================================
// 3. KÖK: ÜRÜN İŞLEMLERİ
// =============================================

function handleRoot3(message, subRoot) {
    // 3:1 - Ürün seçimi
    if (subRoot === 1) {
        if (message.includes('ekle') || message.includes('sepete') || message.includes('al')) {
            handleAddToCartCommand(message);
        }
        else if (message.includes('ürün') || message.includes('liste') || message.includes('ne var')) {
            speakToUser(`Mevcut ürünler: ${getAvailableProducts()}`);
        }
        else if (message.includes('geri') || message.includes('satıcı')) {
            speakToUser("Satıcı seçimine dönülüyor...");
            commandRoot = "2:1";
        }
        else if (message.includes('sepet') || message.includes('sepete git')) {
            openCart();
            speakToUser("Sepetiniz gösteriliyor...");
            commandRoot = "4:1";
        }
        else {
            speakToUser("Ürün eklemek için 'ekle', sepete gitmek için 'sepet' diyebilirsiniz.");
        }
    }
}

// =============================================
// 4. KÖK: SEPET İŞLEMLERİ
// =============================================

function handleRoot4(message, subRoot) {
    // 4:1 - Sepet yönetimi
    if (subRoot === 1) {
        if (message.includes('ödeme') || message.includes('tamamla') || message.includes('sipariş')) {
            if (cart.length === 0) {
                speakToUser("Sepetiniz boş. Önce ürün eklemelisiniz.");
                commandRoot = "3:1";
            } else {
                const total = calculateCartTotal();
                speakToUser(`Sepetinizde ${cart.length} ürün var. Toplam: ${money(total)}. Ödeme yapmak için ödeme yöntemi seçin: nakit, kart veya bonus?`);
                commandRoot = "5:1";
            }
        }
        else if (message.includes('devam') || message.includes('alışveriş')) {
            closeCart();
            speakToUser("Alışverişe devam ediliyor...");
            commandRoot = "3:1";
        }
        else if (message.includes('sil') || message.includes('çıkar') || message.includes('boşalt')) {
            if (message.includes('hepsini') || message.includes('tümünü')) {
                cart = [];
                updateCartUI();
                speakToUser("Sepetiniz boşaltıldı.");
            }
        }
        else if (message.includes('geri') || message.includes('ürünler')) {
            closeCart();
            commandRoot = "3:1";
        }
        else {
            speakToUser("Ödeme yapmak için 'ödeme', alışverişe devam için 'devam' diyebilirsiniz.");
        }
    }
}

// =============================================
// 5. KÖK: ÖDEME İŞLEMLERİ
// =============================================

// 5. KÖK: ÖDEME İŞLEMLERİ - ADRES ONAYI ve MESAFE KONTROLÜ
function handleRoot5(message, subRoot) {
    const total = calculateCartTotal();
    
    // 5:1 - Ödeme yöntemi seçimi
    if (subRoot === 1) {
        if (message.includes('nakit')) {
            currentPaymentMethod = 'nakit';
            startAddressConfirmation(total);
        }
        else if (message.includes('kart') || message.includes('kredi')) {
            currentPaymentMethod = 'kart';
            startAddressConfirmation(total);
        }
        else if (message.includes('bonus')) {
            if (currentCustomer && currentCustomer.bonus_amount >= total) {
                currentPaymentMethod = 'bonus';
                startAddressConfirmation(total);
            } else {
                speakToUser(`Bonus bakiyeniz yetersiz. Mevcut bonus: ${money(currentCustomer?.bonus_amount || 0)}. Başka ödeme yöntemi seçin.`);
            }
        }
        else if (message.includes('geri') || message.includes('sepet')) {
            speakToUser("Sepete dönülüyor...");
            commandRoot = "4:1";
        }
        else {
            speakToUser("Lütfen ödeme yöntemi seçin: nakit, kart veya bonus?");
        }
    }
    // 5:2 - Adres onayı
    else if (subRoot === 2) {
        if (message.includes('evet') || message.includes('doğru') || message.includes('onay')) {
            // Mesafe kontrolü yap
            checkDeliveryDistance().then(isWithinRange => {
                if (isWithinRange) {
                    speakToUser(`Teslimat adresiniz: ${currentCustomer.address}. Siparişiniz tamamlanıyor...`);
                    finalizeOrder(currentPaymentMethod);
                    commandRoot = "0:1";
                } else {
                    speakToUser("Üzgünüz, seçtiğiniz satıcı bu adrese teslimat yapmıyor. Lütfen başka bir satıcı seçin veya adresinizi değiştirin.");
                    commandRoot = "2:1"; // Satıcı seçimine dön
                }
            });
        }
        else if (message.includes('hayır') || message.includes('değiş') || message.includes('farklı')) {
            speakToUser("Lütfen yeni teslimat adresinizi söyler misiniz?");
            commandRoot = "5:3";
        }
        else {
            speakToUser(`Teslimat adresiniz: ${currentCustomer.address}. Doğru mu? 'Evet' veya 'Hayır' diyin.`);
        }
    }
    // 5:3 - Yeni adres alma
    else if (subRoot === 3) {
        if (message.trim().length > 5) {
            currentCustomer.address = message.trim();
            
            // Yeni adresle mesafe kontrolü
            checkDeliveryDistance().then(isWithinRange => {
                if (isWithinRange) {
                    speakToUser(`Yeni adresiniz kaydedildi: ${currentCustomer.address}. Siparişiniz tamamlanıyor...`);
                    finalizeOrder(currentPaymentMethod);
                    commandRoot = "0:1";
                } else {
                    speakToUser("Üzgünüz, seçtiğiniz satıcı bu adrese teslimat yapmıyor. Lütfen başka bir satıcı seçin veya adresinizi değiştirin.");
                    commandRoot = "2:1"; // Satıcı seçimine dön
                }
            });
        } else {
            speakToUser("Lütfen tam adresinizi söyler misiniz?");
        }
    }
}

// =============================================
// VERİTABANI ODAKLI ASİSTAN SİSTEMİ
// =============================================

let commandRules = new Map();
let currentRoot = "0:0";
let pendingResponse = null;

// Veritabanından kök kurallarını yükle
async function loadCommandRules() {
    try {
        const { data, error } = await supabase
            .from('voice_command_rules')
            .select('*')
            .eq('is_active', true)
            .order('priority', { ascending: false });

        if (error) throw error;

        commandRules.clear();
        data.forEach(rule => {
            if (!commandRules.has(rule.root_code)) {
                commandRules.set(rule.root_code, []);
            }
            commandRules.get(rule.root_code).push(rule);
        });

        console.log(`✅ ${data.length} komut kuralı yüklendi`);
    } catch (error) {
        console.error('Komut kuralları yükleme hatası:', error);
    }
}

// Ana komut işleme fonksiyonu (SADECE 50 SATIR!)
async function processVoiceCommand(transcript) {
    const message = transcript.toLowerCase().trim();
    
    // 1. Askıda cevap varsa, onu işle
    if (pendingResponse) {
        return handlePendingResponse(message);
    }

    // 2. Mevcut kök için kuralları ara
    const match = await findRuleMatch(message, currentRoot);
    
    if (match) {
        await executeMatchedRule(match, message);
    } else {
        // 3. Eşleşme yoksa AI'ya yönlendir
        await handleAIRequest(message, currentRoot);
    }
}

// Kural eşleştirme (10 satır)
async function findRuleMatch(message, root) {
    const rules = commandRules.get(root) || [];
    
    for (const rule of rules) {
        const patterns = rule.input_patterns.split('|');
        for (const pattern of patterns) {
            if (matchesPattern(message, pattern)) {
                return { rule, pattern, extractedData: extractData(message, pattern) };
            }
        }
    }
    return null;
}

// Pattern eşleştirme (5 satır)
function matchesPattern(message, pattern) {
    if (pattern.startsWith('regex:')) {
        const regex = new RegExp(pattern.replace('regex:', ''));
        return regex.test(message);
    }
    return message.includes(pattern);
}

// Kural çalıştırma (15 satır)
async function executeMatchedRule(match, message) {
    const { rule, extractedData } = match;
    
    // Çıktıyı hazırla
    let output = rule.output_text;
    if (extractedData.phone) output = output.replace('{phone}', extractedData.phone);
    
    // Sesli cevap ver
    speakToUser(output);
    
    // Aksiyonu çalıştır
    if (rule.action_name) {
        await executeAction(rule.action_name, extractedData);
    }
    
    // Askıda cevap bekliyorsa
    if (rule.next_root && rule.next_root.includes('?')) {
        pendingResponse = { nextRoot: rule.next_root, context: extractedData };
    } else {
        currentRoot = rule.next_root || currentRoot;
    }
}

// AI isteği işleme (10 satır)
async function handleAIRequest(message, root) {
    speakToUser("Anlıyorum...");
    
    const aiResult = await queryAI(message, root);
    
    if (aiResult.confidence > 0.7) {
        speakToUser(aiResult.response);
        currentRoot = aiResult.suggested_root;
        
        // Öğrenmeyi kaydet
        await saveAILearning(root, message, aiResult);
    } else {
        speakToUser("Üzgünüm, tam anlayamadım. Lütfen tekrar söyler misiniz?");
    }
}

// Askıda cevap işleme (8 satır)
async function handlePendingResponse(message) {
    const { nextRoot, context } = pendingResponse;
    pendingResponse = null;
    
    if (message.includes('evet') || !message.includes('hayır')) {
        currentRoot = nextRoot.replace('?', '');
        speakToUser("Tamam, devam ediyorum...");
    } else {
        speakToUser("Anladım, başka nasıl yardımcı olabilirim?");
    }
}

// AI sorgusu (8 satır - mock)
async function queryAI(message, contextRoot) {
    // Gerçek implementasyon için API endpoint
    return new Promise(resolve => {
        setTimeout(() => {
            resolve({
                response: "Anladım, siparişinizi tamamlamak için ödeme yöntemi seçin.",
                suggested_root: "5:1",
                confidence: 0.8
            });
        }, 1000);
    });
}

// Öğrenmeyi kaydet (5 satır)
async function saveAILearning(originalRoot, userInput, aiResult) {
    await supabase.from('ai_learning_log').insert([{
        original_root: originalRoot,
        user_input: userInput,
        ai_response: aiResult.response,
        resolved_root: aiResult.suggested_root,
        confidence_score: aiResult.confidence
    }]);
}



//AKSİYON YÖNETİCİSİ

// Aksiyonları yönet (tüm işlevsellik burada)
async function executeAction(actionName, data) {
    console.log(`⚡ Aksiyon: ${actionName}`, data);
    
    switch(actionName) {
        case 'set_phone':
            currentCustomer.phone = data.phone;
            break;
            
        case 'check_phone':
            await checkCustomerByPhone(data.phone);
            break;
            
        case 'select_market':
            await selectStoreTypeByName('Market');
            break;
            
        case 'select_restaurant':
            await selectStoreTypeByName('Restoran');
            break;
            
        case 'save_address':
            await saveCustomerAddress(data);
            break;
            
        default:
            console.warn(`Bilinmeyen aksiyon: ${actionName}`);
    }
}

// Müşteri kontrolü (mevcut fonksiyon)
async function checkCustomerByPhone(phone) {
    // Mevcut kod aynen kalacak
    const { data } = await supabase.from('customers').select().eq('phone', phone);
    if (data && data.length > 0) {
        currentCustomer = data[0];
        currentRoot = '2:1'; // Satıcı seçimine git
    } else {
        currentRoot = '1:4'; // Kayıt ekranına git
    }
}

// =============================================
// YARDIMCI FONKSİYONLAR
// =============================================

function calculateCartTotal() {
    return cart.reduce((total, item) => total + (item.price * item.quantity), 0) * 1.18;
}

function getAvailableProducts() {
    if (products.length === 0) return "Henüz ürün yüklenmedi.";
    return products.slice(0, 5).map(p => p.name).join(', ');
}

// Ürün ekleme komutu (aynı kalan)
function handleAddToCartCommand(message) {
    if (!selectedSellerId) {
        speakToUser("Önce bir satıcı seçmelisiniz.");
        commandRoot = "2:1";
        return;
    }
    
    const productMatch = extractProductInfo(message);
    if (productMatch) {
        const { productName, quantity } = productMatch;
        const foundProduct = findProductByName(productName);
        
        if (foundProduct) {
            addToCart(foundProduct, quantity);
            speakToUser(`${quantity} adet ${productName} sepete eklendi.`);
        } else {
            speakToUser(`Üzgünüm, '${productName}' bulunamadı. Mevcut ürünler: ${getAvailableProducts()}`);
        }
    }
}

// Satıcıları mesafeye göre filtrele
async function filterSellersByDistance(sellers) {
    const sellersWithinRange = [];
    
    for (const seller of sellers) {
        // Satıcının konumu yoksa listeye ekle (esnek davran)
        if (!seller.latitude || !seller.longitude) {
            sellersWithinRange.push(seller);
            continue;
        }
        
        const distance = calculateDistance(
            userLocation.latitude,
            userLocation.longitude,
            seller.latitude,
            seller.longitude
        );
        
        const deliveryRadius = seller.delivery_radius || 10; // Varsayılan 10 km
        
        if (distance <= deliveryRadius) {
            sellersWithinRange.push(seller);
        }
    }
    
    return sellersWithinRange;
}

// =============================================
// 3. BÖLÜM: SEPET VE SİPARİŞ İŞLEMLERİ
// =============================================

// Satıcı ürünlerini yükle - TAMİR EDİLMİŞ
async function loadSellerProducts(sellerId) {
    try {
        debugLog(`📦 Satıcı ürünleri yükleniyor: ${sellerId}`);
        
        const { data, error } = await supabase
            .from('product_prices')
            .select(`
                *,
                products (
                    id, name, imgurl, reyon_id, category_id, is_active
                )
            `)
            .eq('sube_id', sellerId)
            .eq('products.is_active', true);

        if (error) {
            console.error('❌ Ürün yükleme hatası:', error);
            throw error;
        }

        // Veriyi işle
        products = data
            .filter(item => item.products) // products null olmayanları filtrele
            .map(item => ({
                id: item.products.id,
                product_price_id: item.id,
                name: item.products.name,
                price: item.price,
                discount_price: item.discount_price,
                imgurl: item.products.imgurl,
                reyon_id: item.products.reyon_id,
                category_id: item.products.category_id,
                seller_id: sellerId
            }));

        debugLog(`✅ Ürünler yüklendi: ${products.length} adet`);
        
        // Reyona göre ürünleri grupla ve göster
        displayProductsByReyon(products);
        
        // Reyonları güncelle (mevcut reyonlarla eşleşen)
        updateReyonsWithProducts(products);

    } catch (error) {
        console.error('❌ Ürün yükleme hatası:', error);
        products = getDemoProducts();
        displayProducts(products);
        debugLog('🔄 Demo ürünler kullanılıyor');
    }
}

// Ürünleri göster
function displayProducts(productsToShow) {
    const productsGrid = document.getElementById('productsGrid');
    if (!productsGrid) return;
    
    productsGrid.innerHTML = '';
    
    if (productsToShow.length === 0) {
        productsGrid.innerHTML = `
            <div class="text-center" style="grid-column: 1 / -1; padding: 40px; color: #6c757d;">
                <i class="fas fa-box-open fa-3x mb-3"></i>
                <p>Bu kategoride ürün bulunamadı</p>
            </div>
        `;
        return;
    }
    
    productsToShow.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card';
        
        let badgeHTML = '';
        if (product.discount_price && product.discount_price < product.price) {
            badgeHTML = `<div class="product-badge">İndirim</div>`;
        }
        
        let priceHTML = `<div class="product-price">${money(product.price)}</div>`;
        if (product.discount_price && product.discount_price < product.price) {
            priceHTML = `
                <div>
                    <span class="product-price">${money(product.discount_price)}</span>
                    <span class="product-discount">${money(product.price)}</span>
                </div>
            `;
        }
        
        productCard.innerHTML = `
            ${badgeHTML}
            <img src="${product.imgurl || 'https://via.placeholder.com/150x100?text=Ürün'}" alt="${product.name}" class="product-image">
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                ${priceHTML}
                <button class="add-to-cart-btn" data-id="${product.id}" style="margin-top: 10px; width: 100%; padding: 8px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">Sepete Ekle</button>
            </div>
        `;
        
        const addToCartBtn = productCard.querySelector('.add-to-cart-btn');
        addToCartBtn.addEventListener('click', function() {
            addToCart(product, 1, productCard);
        });
        
        productsGrid.appendChild(productCard);
    });
}

// Sepete ürün ekle
function addToCart(product, quantity, productElement = null) {
    // Sepete ürün ekle
    const existingItem = cart.find(item => item.id === product.id);
    
    if (existingItem) {
        existingItem.quantity += quantity;
    } else {
        cart.push({ 
            id: product.id, 
            product_price_id: product.product_price_id, 
            name: product.name, 
            price: product.discount_price || product.price, 
            quantity: quantity, 
            imgurl: product.imgurl,
            seller_id: product.seller_id
        });
    }
    
    // Satıcı kilidini aktif et
    if (!isSellerLocked) {
        isSellerLocked = true;
        updateSellersGrid();
    }
    
    updateCartUI();
    
    // Animasyon efekti
    if (productElement) {
        productElement.style.transform = 'scale(0.95)';
        setTimeout(() => {
            productElement.style.transform = 'scale(1)';
        }, 200);
    }
    
    speakToUser(`${product.name} sepete eklendi.`);
}

// Sepet UI'ını güncelle
function updateCartUI() {
    if (!cartItems) return;
    
    cartItems.innerHTML = '';
    
    if (cart.length === 0) {
        cartItems.innerHTML = `
            <div class="text-center" style="padding: 30px; color: #6c757d;">
                <i class="fas fa-shopping-cart fa-2x mb-3"></i>
                <p>Sepetiniz boş</p>
            </div>
        `;
        if (orderCount) orderCount.textContent = "0";
        if (orderTotal) orderTotal.textContent = "0 ₺";
        
        // Sepet boşsa satıcı kilidini kaldır
        if (isSellerLocked) {
            isSellerLocked = false;
            updateSellersGrid();
        }
    } else {
        cart.forEach(item => {
            const cartItem = document.createElement('div');
            cartItem.className = 'cart-item';
            cartItem.innerHTML = `
                <div class="cart-item-info">
                    <img src="${item.imgurl || 'https://via.placeholder.com/40x40?text=Ürün'}" alt="${item.name}" class="cart-item-image">
                    <div class="cart-item-details">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${money(item.price)}</div>
                    </div>
                </div>
                <div class="cart-item-controls">
                    <button class="quantity-btn decrease" data-id="${item.id}">-</button>
                    <span>${item.quantity}</span>
                    <button class="quantity-btn increase" data-id="${item.id}">+</button>
                </div>
            `;
            
            cartItems.appendChild(cartItem);
        });
        
        if (orderCount) orderCount.textContent = cart.reduce((total, item) => total + item.quantity, 0);
        
        // Miktar butonlarına event listener ekle
        document.querySelectorAll('.decrease').forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.dataset.id;
                updateCartItemQuantity(productId, -1);
            });
        });
        
        document.querySelectorAll('.increase').forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.dataset.id;
                updateCartItemQuantity(productId, 1);
            });
        });
    }
    
    // Toplamları güncelle
    updateCartTotals();
}

// Sepet toplamlarını güncelle
function updateCartTotals() {
    const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
    const vat = subtotal * 0.18;
    const total = subtotal + vat;
    
    if (subtotalEl) subtotalEl.textContent = money(subtotal);
    if (vatAmountEl) vatAmountEl.textContent = money(vat);
    if (totalAmountEl) totalAmountEl.textContent = money(total);
    if (orderTotal) orderTotal.textContent = money(total);
}

// Sepet ürün miktarını güncelle
function updateCartItemQuantity(productId, change) {
    const item = cart.find(item => item.id === productId);
    if (item) {
        item.quantity += change;
        
        if (item.quantity <= 0) {
            cart = cart.filter(item => item.id !== productId);
        }
        
        updateCartUI();
    }
}

// =============================================
// 3. SİPARİŞ TAMAMLAMA SİSTEMİ
// =============================================

// Sipariş tamamlama - KONUM FARKI NOTU EKLE
async function finalizeOrder(paymentMethod) {
    if (cart.length === 0) {
        speakToUser("Sepetiniz boş. Lütfen önce ürün ekleyin.");
        return;
    }
    
    if (!selectedSellerId) {
        speakToUser("Lütfen önce bir satıcı seçin.");
        return;
    }
    
    if (!currentCustomer || currentCustomer.role === 'guest') {
        speakToUser("Lütfen önce giriş yapın.");
        return;
    }
    
    if (!selectedLocation) {
        speakToUser("Lütfen teslimat konumunuzu seçin.");
        showLocationModal();
        return;
    }
    
    const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
    const vat = subtotal * 0.18;
    const total = subtotal + vat;
    
    try {
        // KONUM FARKI NOTU HAZIRLA
        let orderNotes = "";
        if (currentCustomer && currentCustomer.address && isLocationDetected) {
            const currentAddress = `${userLocation.district}, ${userLocation.city}`;
            const savedAddress = currentCustomer.address;
            
            // Adresler farklıysa not ekle
            if (!savedAddress.includes(currentAddress)) {
                orderNotes = `Kullanıcının kayıtlı adresi: ${savedAddress}. Mevcut konum: ${currentAddress}.`;
                debugLog('📍 Konum farkı sipariş notuna eklendi:', orderNotes);
            }
        }
        
        // 1. Siparişi kaydet
        const { data: order, error: orderError } = await supabase
            .from('orders')
            .insert([{
                customer_id: currentCustomer.id,
                seller_id: selectedSellerId,
                total_amount: total,
                payment_method: paymentMethod,
                status: 'pending',
                location: selectedLocation,
                order_notes: orderNotes, // Konum notunu ekle
                order_date: new Date().toISOString()
            }])
            .select()
            .single();
        
        if (orderError) throw orderError;
        
        // 2. Sipariş detaylarını kaydet
        const orderDetails = cart.map(item => ({
            order_id: order.id,
            product_id: item.id,
            product_price_id: item.product_price_id,
            quantity: item.quantity,
            unit_price: item.price,
            tax_rate: 18
        }));
        
        const { error: detailsError } = await supabase
            .from('order_details')
            .insert(orderDetails);
        
        if (detailsError) throw detailsError;
        
        // 3. Bonus kullanımı
        if (paymentMethod === 'bonus' && currentCustomer.bonus_amount >= total) {
            const newBonus = currentCustomer.bonus_amount - total;
            await supabase
                .from('customers')
                .update({ bonus_amount: newBonus })
                .eq('id', currentCustomer.id);
                
            currentCustomer.bonus_amount = newBonus;
            updateCustomerUI();
        }
        
        speakToUser(`Siparişiniz alındı! Sipariş numaranız: ${order.id}. Toplam: ${money(total)}`);
        
        // 4. Sepeti temizle
        setTimeout(() => {
            cart = [];
            updateCartUI();
            isSellerLocked = false;
            updateSellersGrid();
        }, 3000);
        
    } catch (error) {
        console.error('Sipariş hatası:', error);
        speakToUser("Siparişiniz alınırken bir hata oluştu. Lütfen tekrar deneyin.");
    }
}
// Adres onayı başlatma
function startAddressConfirmation(total) {
    if (currentCustomer && currentCustomer.address) {
        speakToUser(`Ödeme yöntemi: ${currentPaymentMethod}. Toplam: ${money(total)}. Teslimat adresiniz: ${currentCustomer.address}. Doğru mu?`);
        commandRoot = "5:2";
    } else {
        speakToUser(`Ödeme yöntemi: ${currentPaymentMethod}. Toplam: ${money(total)}. Lütfen teslimat adresinizi söyler misiniz?`);
        commandRoot = "5:3";
    }
}


// Teslimat mesafesi kontrolü
async function checkDeliveryDistance() {
    if (!selectedSellerId || !userLocation.latitude || !userLocation.longitude) {
        console.error('Mesafe kontrolü için gerekli bilgiler eksik');
        return false;
    }
    
    try {
        // Satıcının konum bilgisini al
        const { data: seller, error } = await supabase
            .from('seller_profiles')
            .select('latitude, longitude, delivery_radius')
            .eq('id', selectedSellerId)
            .single();
            
        if (error || !seller) {
            console.error('Satıcı bilgisi alınamadı:', error);
            return true; // Hata durumunda teslimata izin ver (esnek davran)
        }
        
        // Satıcının teslimat yarıçapı (km cinsinden) - varsayılan 10 km
        const deliveryRadius = seller.delivery_radius || 10;
        
        // Mesafe hesapla
        const distance = calculateDistance(
            userLocation.latitude,
            userLocation.longitude,
            seller.latitude,
            seller.longitude
        );
        
        debugLog(`📍 Mesafe kontrolü: ${distance.toFixed(2)} km (Sınır: ${deliveryRadius} km)`);
        
        return distance <= deliveryRadius;
        
    } catch (error) {
        console.error('Mesafe kontrolü hatası:', error);
        return true; // Hata durumunda teslimata izin ver
    }
}


// İki koordinat arasındaki mesafeyi hesapla (Haversine formülü)
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Dünya yarıçapı (km)
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R * c;
    return distance;
}

// Sepet işlemleri
function toggleCart() {
    if (cartContainer.classList.contains('open')) {
        closeCart();
    } else {
        openCart();
    }
}

function openCart() {
    cartContainer.classList.add('open');
}

function closeCart() {
    cartContainer.classList.remove('open');
}

// Reyon'a göre ürünleri filtrele - TAMİR EDİLMİŞ
function filterProductsByReyon(reyonId) {
    if (!products || products.length === 0) {
        debugLog('⚠️ Filtrelenecek ürün bulunamadı');
        return;
    }
    
    const filteredProducts = products.filter(product => product.reyon_id === reyonId);
    
    if (filteredProducts.length > 0) {
        displayProducts(filteredProducts);
        debugLog(`✅ Reyon filtreleme: ${filteredProducts.length} ürün bulundu`);
    } else {
        // Bu reyonda ürün yoksa tüm ürünleri göster
        displayProducts(products);
        speakToUser("Bu reyonda ürün bulunamadı. Tüm ürünler gösteriliyor.");
    }
}
	// Kategoriye göre ürünleri filtrele
function filterProductsByCategory(categoryId) {
    const filteredProducts = products.filter(p => p.category_id === categoryId);
    displayProducts(filteredProducts.length > 0 ? filteredProducts : products);
}

// Demo ürünler
function getDemoProducts() {
    return [
        { id: '1', name: "Süt 1L", price: 15.90, imgurl: "https://via.placeholder.com/150x100?text=Süt", discount_price: 12.90 },
        { id: '2', name: "Ekmek", price: 5.50, imgurl: "https://via.placeholder.com/150x100?text=Ekmek" },
        { id: '3', name: "Yumurta 10'lu", price: 32.00, imgurl: "https://via.placeholder.com/150x100?text=Yumurta" }
    ];
}

// Kaydırma fonksiyonu
function scrollElement(element, amount) {
    element.scrollBy({ left: amount, behavior: 'smooth' });
}

// Demo veri fallback'leri
function getDemoReyons(storeTypeId) {
    const demoReyons = {
        '1': [ { id: '1', name: 'Meyve & Sebze' }, { id: '2', name: 'Süt Ürünleri' } ],
        '2': [ { id: '3', name: 'Ana Yemekler' }, { id: '4', name: 'Çorbalar' } ]
    };
    return demoReyons[storeTypeId] || [];
}

function getDemoSellers() {
    return [
        { id: '1', full_name: "Demo Market", city: "İstanbul", business_name: "Demo Market" }
    ];
}

function getDemoProducts() {
    return [
        { id: '1', name: "Demo Ürün", price: 10.00, seller_id: '1', product_price_id: '1' }
    ];
}

</script>	
</body>
</html>

