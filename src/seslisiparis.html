<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sesli Sipari≈ü Sistemi - Onur Market</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #003dff;
            --secondary: #00c2ff;
            --accent: #ff5c00;
            --dark: #1a1a1a;
            --light: #f8f9fa;
            --gray: #6c757d;
            --success: #28a745;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header Styles */
        header {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }
        
        .logo i {
            margin-right: 10px;
            color: var(--accent);
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .order-summary {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f0f7ff;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .order-count {
            background: var(--accent);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    max-width: 400px;
    width: 90%;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.close-modal {
    cursor: pointer;
    font-size: 24px;
}

.location-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.location-option {
    padding: 15px;
    border: 2px solid #ddd;
    border-radius: 5px;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s;
}

.location-option:hover {
    border-color: #007bff;
    background: #f8f9fa;
}
        .profile-info {
            position: relative;
        }
        
        .profile-btn {
            background: none;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 20px;
            transition: background 0.3s;
        }
        
        .profile-btn:hover {
            background: #f0f0f0;
        }
        
        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 15px;
            width: 250px;
            display: none;
            z-index: 10;
        }
        
        .profile-dropdown.show {
            display: block;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .profile-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .profile-details {
            font-size: 14px;
        }
        
        .profile-name {
            font-weight: 600;
        }
        
        .profile-phone {
            color: var(--gray);
        }
        
        .microphone-toggle {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }
        
        .microphone-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        
        .microphone-toggle.listening {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 92, 0, 0.6); }
            70% { box-shadow: 0 0 0 15px rgba(255, 92, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 92, 0, 0); }
        }
        
        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: #dc2626;
        }
        
        /* Location Marker */
        .location-marker {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f0f7ff;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .location-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        
        .location-modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
        }
        
        .location-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .location-option {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .location-option:hover {
            border-color: var(--primary);
            background: #f0f7ff;
        }
        
        .location-option.selected {
            border-color: var(--primary);
            background: #f0f7ff;
        }
        
        /* Main Content */
        .main-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            flex: 1;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark);
        }
        
        /* How it works banner */
        .how-it-works {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .how-it-works h2 {
            font-size: 28px;
            margin-bottom: 20px;
        }
        
        .steps {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .step {
            flex: 1;
            min-width: 200px;
            max-width: 250px;
        }
        
        .step-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .step h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        /* Seller Type Grid */
        .seller-type-container {
            position: relative;
            margin-bottom: 30px;
        }
        
        .seller-type-grid {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
            scroll-behavior: smooth;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .seller-type-grid::-webkit-scrollbar {
            display: none;
        }
        
        .seller-type-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            min-width: 150px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 2px solid transparent;
            flex-shrink: 0;
        }
        
        .seller-type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .seller-type-card.selected {
            border-color: var(--primary);
            background: #f0f7ff;
        }
        
        .seller-type-icon {
            font-size: 32px;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .seller-type-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        .scroll-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            z-index: 10;
        }
        
        .scroll-btn.left {
            left: -20px;
        }
        
        .scroll-btn.right {
            right: -20px;
        }
        
        /* Categories/Reyons Grid */
        .categories-container {
            position: relative;
            margin-bottom: 30px;
        }
        
        .categories-grid {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
            scroll-behavior: smooth;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .categories-grid::-webkit-scrollbar {
            display: none;
        }
        
        .category-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            min-width: 150px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 2px solid transparent;
            flex-shrink: 0;
        }
        
        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .category-card.selected {
            border-color: var(--success);
            background: #f0fff4;
        }
        
        .category-icon {
            font-size: 32px;
            margin-bottom: 10px;
            color: var(--success);
        }
        
        .category-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        /* Seller Grid */
        .sellers-container {
            position: relative;
            margin-bottom: 30px;
        }
        
        .seller-grid {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding: 10px 0;
            scroll-behavior: smooth;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .seller-grid::-webkit-scrollbar {
            display: none;
        }
        
        .seller-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 2px solid transparent;
            min-width: 200px;
            flex-shrink: 0;
        }
        
        .seller-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .seller-card.selected {
            border-color: var(--success);
            background: #f0fff4;
        }
        
        .seller-card.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .seller-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        
        .seller-info {
            padding: 15px;
        }
        
        .seller-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .seller-details {
            font-size: 14px;
            color: var(--gray);
            display: flex;
            justify-content: space-between;
        }
        
        /* Products Grid */
        .products-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }
        
        .product-card {
            background: #f9f9f9;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .product-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .product-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        
        .product-info {
            padding: 10px;
        }
        
        .product-name {
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .product-price {
            font-weight: 600;
            color: var(--primary);
        }
        
        .product-discount {
            color: #ef4444;
            font-size: 12px;
            text-decoration: line-through;
            margin-left: 5px;
        }
        
        /* Cart Section */
        .cart-container {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background: white;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .cart-container.open {
            right: 0;
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .cart-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        
        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .cart-item-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cart-item-image {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            object-fit: cover;
        }
        
        .cart-item-details {
            font-size: 14px;
        }
        
        .cart-item-name {
            font-weight: 500;
        }
        
        .cart-item-price {
            color: var(--gray);
            font-size: 12px;
        }
        
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .cart-totals {
            border-top: 1px solid #eee;
            padding: 20px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .total-final {
            font-weight: 600;
            font-size: 18px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        
        .payment-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
            padding: 0 20px 20px;
        }
        
        .payment-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .payment-btn.cash {
            background: var(--success);
            color: white;
        }
        
        .payment-btn.card {
            background: var(--primary);
            color: white;
        }
        
        .payment-btn.bonus {
            background: var(--accent);
            color: white;
            grid-column: 1 / -1;
        }
        
        .payment-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        /* Footer */
        footer {
            background: var(--dark);
            color: white;
            padding: 30px 0;
            margin-top: auto;
        }
        
        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
        }
        
        .footer-section h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .footer-links {
            list-style: none;
        }
        
        .footer-links li {
            margin-bottom: 8px;
        }
        
        .footer-links a {
            color: #ccc;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: white;
        }
        
        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .social-link {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            transition: background 0.3s;
        }
        
        .social-link:hover {
            background: var(--primary);
        }
        
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            margin-top: 20px;
            border-top: 1px solid #444;
            font-size: 14px;
            color: #aaa;
        }
        
        /* Voice Assistant */
        .voice-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 300px;
            z-index: 100;
            display: block;
        }
        
        .status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .status-title {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #1f2937;
        }
        
        .status-title i {
            margin-right: 8px;
            color: var(--accent);
        }
        
        .status-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #6b7280;
        }
        
        .status-content {
            margin-bottom: 15px;
        }
        
        .assistant-message {
            padding: 12px;
            background: #f0f9ff;
            border-radius: 8px;
            margin-bottom: 10px;
            color: #374151;
        }
        
        .user-message {
            padding: 12px;
            background: #dbeafe;
            border-radius: 8px;
            text-align: right;
            color: var(--primary);
        }
        
        .voice-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 30px;
            margin-top: 10px;
        }
        
        .voice-bar {
            width: 6px;
            height: 10px;
            background: #ddd;
            margin: 0 3px;
            border-radius: 3px;
        }
        
        .listening .voice-bar {
            animation: voiceIndicator 0.8s infinite;
        }
        
        @keyframes voiceIndicator {
            0%, 100% { height: 10px; background: #ddd; }
            50% { height: 30px; background: var(--accent); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .order-summary {
                order: 3;
                width: 100%;
                justify-content: center;
            }
            
            .seller-type-grid, .categories-grid, .seller-grid {
                flex-wrap: nowrap;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .payment-buttons {
                grid-template-columns: 1fr;
            }
            
            .steps {
                flex-direction: column;
                align-items: center;
            }
            
            .step {
                max-width: 100%;
            }
            
            .cart-container {
                width: 100%;
                right: -100%;
            }
            
            .scroll-btn {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-container">
            <div class="logo">
                <i class="fas fa-utensils"></i>
                <span>Sesli Sipari≈ü</span>
            </div>
            
            <div class="header-actions">
                <div class="location-marker" id="locationMarker">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="locationText">Konumunuzu i≈üaretleyin</span>
                </div>
                
                <div class="order-summary" id="orderSummary" style="display: none;">
                    <div class="order-count" id="orderCount">0</div>
                    <div>Sipari≈ü: <span id="orderTotal">0 ‚Ç∫</span></div>
                </div>
               
                <div class="profile-info">
                    <button class="profile-btn" id="profileBtn">
                        <i class="fas fa-user"></i>
                        <span id="userName">Profilim</span>
                    </button>
                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="profile-header">
                            <div class="profile-avatar" id="profileAvatar">OM</div>
                            <div class="profile-details">
                                <div class="profile-name" id="profileName">-</div>
                                <div class="profile-phone" id="profilePhone">-</div>
                            </div>
                        </div>
                        <div class="profile-info-item">
                            <strong>≈ûehir:</strong> <span id="profileCity">-</span>
                        </div>
                        <div class="profile-info-item">
                            <strong>Adres:</strong> <span id="profileAddress">-</span>
                        </div>
                        <div class="profile-info-item">
                            <strong>Bonus:</strong> <span id="profileBonus">0 ‚Ç∫</span>
                        </div>
                        <button class="logout-btn" id="logoutBtn" style="margin-top: 15px; width: 100%;">
                            <i class="fas fa-sign-out-alt"></i>
                            √áƒ±kƒ±≈ü Yap
                        </button>
                    </div>
                </div>
             <button id="logoutButton" style="display: none; position: fixed; top: 10px; right: 10px; z-index: 1000; padding: 8px 16px; background: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer;">
    <i class="fas fa-sign-out-alt"></i> √áƒ±kƒ±≈ü Yap
</button>


                <button id="microphoneToggle" class="microphone-toggle">
                    <i class="fas fa-microphone-slash"></i>
                    <span>Mikrofon (Kapalƒ±)</span>
                </button>
            </div>
        </div>
    </header>
    <!-- Konum Se√ßim Modal'ƒ± -->
<div id="locationModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Konum Se√ßiniz</h3>
            <span class="close-modal" onclick="hideLocationModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p>L√ºtfen sipari≈ü vermek istediƒüiniz konumu se√ßin:</p>
            <div class="location-options">
                <div class="location-option" data-location="inside">
                    <i class="fas fa-utensils"></i>
                    <span>Restoran i√ßinde</span>
                </div>
                <div class="location-option" data-location="takeaway">
                    <i class="fas fa-utensils"></i>
                    <span>Paket servis</span>
                </div>
                <div class="location-option" data-location="delivery">
                    <i class="fas fa-motorcycle"></i>
                    <span>Adrese teslim</span>
                </div>
            </div>
        </div>
    </div>
</div>
    <!-- Main Content -->
    <div class="main-container">
        <!-- How it works banner -->
        <section class="how-it-works" id="howItWorks">
            <h2>Nasƒ±l √áalƒ±≈üƒ±r?</h2>
            <div class="steps">
                <div class="step">
                    <div class="step-icon"><i class="fas fa-store"></i></div>
                    <h3>Satƒ±cƒ± Se√ß</h3>
                    <p>Market, restoran, eczane veya fƒ±rƒ±n se√ßin</p>
                </div>
                <div class="step">
                    <div class="step-icon"><i class="fas fa-box-open"></i></div>
                    <h3>√úr√ºnleri Se√ß</h3>
                    <p>Reyonlardan veya men√ºden √ºr√ºn se√ßin</p>
                </div>
                <div class="step">
                    <div class="step-icon"><i class="fas fa-shopping-cart"></i></div>
                    <h3>Sipari≈ü Ver</h3>
                    <p>Sepetinizi onaylayƒ±n ve √∂deme yapƒ±n</p>
                </div>
                <div class="step">
                    <div class="step-icon"><i class="fas fa-robot"></i></div>
                    <h3>Sesli Asistan</h3>
                    <p>Mikrofonu a√ßƒ±n ve sesli komut verin</p>
                </div>
            </div>
        </section>

        <!-- Seller Type Selection -->
        <section>
            <h2 class="section-title">Ne yemek istersiniz?</h2>
            <div class="seller-type-container">
                <button class="scroll-btn left" id="scrollSellerTypesLeft">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="seller-type-grid" id="sellerTypeGrid">
                    <!-- Satƒ±cƒ± tipleri buraya y√ºklenecek -->
                </div>
                <button class="scroll-btn right" id="scrollSellerTypesRight">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>

        <!-- Categories/Reyons Grid -->
        <section id="categoriesSection" style="display: none;">
            <h2 class="section-title" id="categoriesTitle">Kategoriler</h2>
            <div class="categories-container">
                <button class="scroll-btn left" id="scrollCategoriesLeft">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="categories-grid" id="categoriesGrid">
                    <!-- Kategoriler/Reyonlar buraya y√ºklenecek -->
                </div>
                <button class="scroll-btn right" id="scrollCategoriesRight">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>

        <!-- Sellers Grid -->
        <section id="sellersSection" style="display: none;">
            <h2 class="section-title">Size En Yakƒ±n Yerler</h2>
            <div class="sellers-container">
                <button class="scroll-btn left" id="scrollSellersLeft">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="seller-grid" id="sellerGrid">
                    <!-- Satƒ±cƒ±lar buraya y√ºklenecek -->
                </div>
                <button class="scroll-btn right" id="scrollSellersRight">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>

        <!-- Products Grid -->
        <section class="products-section" id="productsSection" style="display: none;">
            <div class="products-header">
                <h2 class="section-title" style="margin-bottom: 0;">√úr√ºnler</h2>
                <div id="selectedSellerInfo" class="text-gray">Satƒ±cƒ± se√ßilmedi</div>
            </div>
            <div class="products-grid" id="productsGrid">
                <!-- √úr√ºnler buraya y√ºklenecek -->
            </div>
        </section>
    </div>

    <!-- Cart Section -->
    <div class="cart-container" id="cartContainer">
        <div class="cart-header">
            <h2>Sepetiniz</h2>
            <button class="cart-close" id="cartClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="cart-items" id="cartItems">
            <div class="text-center" style="padding: 30px; color: #6c757d;">
                <i class="fas fa-shopping-cart fa-2x mb-3"></i>
                <p>Sepetiniz bo≈ü</p>
            </div>
        </div>
        <div class="cart-totals">
            <div class="total-row">
                <span>Ara Toplam:</span>
                <span id="subtotal">0 ‚Ç∫</span>
            </div>
            <div class="total-row">
                <span>ƒ∞ndirim:</span>
                <span id="discount">0 ‚Ç∫</span>
            </div>
            <div class="total-row">
                <span>KDV (%18):</span>
                <span id="vatAmount">0 ‚Ç∫</span>
            </div>
            <div class="total-row total-final">
                <span>Toplam:</span>
                <span id="totalAmount">0 ‚Ç∫</span>
            </div>
        </div>
        <div class="payment-buttons">
            <button class="payment-btn cash" id="payCash">Nakit √ñde</button>
            <button class="payment-btn card" id="payCard">Kartla √ñde</button>
            <button class="payment-btn bonus" id="payBonus">Bonus ile √ñde</button>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <div class="footer-section">
                <h3>Sesli Sipari≈ü</h3>
                <p>Sesli komutlarla kolayca sipari≈ü verin. Hƒ±zlƒ±, g√ºvenli ve pratik alƒ±≈üveri≈ü deneyimi.</p>
                <div class="social-links">
                    <a href="#" class="social-link"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
                    <a href="https://wa.me/?text=Merhaba!%20Sesli%20Sipari≈ü%20sisteminden%20alƒ±≈üveri≈ü%20yapmak%20istiyorum." class="social-link" target="_blank"><i class="fab fa-whatsapp"></i></a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Hƒ±zlƒ± Baƒülantƒ±lar</h3>
                <ul class="footer-links">
                    <li><a href="#" id="referralLink">Referans Linki</a></li>
                    <li><a href="#" id="whatsappOrder">WhatsApp ile Sipari≈ü</a></li>
                    <li><a href="#">Sipari≈ülerim</a></li>
                    <li><a href="#">Yardƒ±m</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3>ƒ∞leti≈üim</h3>
                <ul class="footer-links">
                    <li><i class="fas fa-phone"></i> 0850 123 45 67</li>
                    <li><i class="fas fa-envelope"></i> info@seslisiparis.com</li>
                    <li><i class="fas fa-map-marker-alt"></i> ƒ∞stanbul, T√ºrkiye</li>
                </ul>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy; 2023 Sesli Sipari≈ü Sistemi. T√ºm haklarƒ± saklƒ±dƒ±r.</p>
        </div>
	<div style="position: fixed; bottom: 10px; left: 10px; z-index: 10000; background: #f0f0f0; padding: 10px; border-radius: 5px; font-size: 12px;">
    <strong>Test Ara√ßlarƒ±:</strong><br>
    <button onclick="debugApp.checkElements()">Elementleri Kontrol Et</button>
    <button onclick="debugApp.setLocation('inside')">Konum: ƒ∞√ßeri</button>
    <button onclick="debugApp.setLocation('takeaway')">Konum: Paket</button>
    <button onclick="debugApp.simulateLogin()">Test Giri≈üi</button>
    <button onclick="debugApp.reset()">Temizle & Yenile</button>
</div>
    </footer>

    <!-- Voice Assistant -->
    <div class="voice-status" id="voiceStatusPanel">
        <div class="status-header">
            <div class="status-title">
                <i class="fas fa-microphone"></i>
                <span>Sesli Asistan</span>
            </div>
            <button class="status-close" id="closeVoiceStatus">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="status-content">
            <div class="assistant-message" id="assistantMessage">Merhaba! Sipari≈ü vermek i√ßin mikrofonu a√ßƒ±n ve konu≈üun.</div>
            <div class="user-message" id="userMessage"></div>
        </div>
        <div class="voice-indicator" id="voiceIndicator">
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = "https://xliutvspwodhoaxvysks.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsaXV0dnNwd29kaG9heHZ5c2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTgyOTksImV4cCI6MjA3MjkzNDI5OX0.Zodisa_ifP8t2Q4X0ecnB56RiR_Bg4QS5gvPn5ZLK_w";

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Global state
        let currentCustomer = null;
        let sellers = [];
        let products = [];
        let categories = [];
        let storeTypes = [];
        let cart = [];
        let recognition = null;
        let isListening = false;
        let isMicrophoneEnabled = false;
        let conversationStep = 0;
        let currentPaymentMethod = null;
        let selectedSellerId = null;
        let selectedSellerType = null;
        let selectedCategoryId = null;
        let isSellerLocked = false;
        let selectedLocation = null;
        let referralCode = null;
        let referralGroupCode = null;

        // DOM Elements
        const profileBtn = document.getElementById('profileBtn');
        const profileDropdown = document.getElementById('profileDropdown');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profilePhone = document.getElementById('profilePhone');
        const profileCity = document.getElementById('profileCity');
        const profileAddress = document.getElementById('profileAddress');
        const profileBonus = document.getElementById('profileBonus');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const microphoneToggle = document.getElementById('microphoneToggle');
        const sellerTypeGrid = document.getElementById('sellerTypeGrid');
        const scrollSellerTypesLeft = document.getElementById('scrollSellerTypesLeft');
        const scrollSellerTypesRight = document.getElementById('scrollSellerTypesRight');
        const categoriesSection = document.getElementById('categoriesSection');
        const categoriesTitle = document.getElementById('categoriesTitle');
        const categoriesGrid = document.getElementById('categoriesGrid');
        const scrollCategoriesLeft = document.getElementById('scrollCategoriesLeft');
        const scrollCategoriesRight = document.getElementById('scrollCategoriesRight');
        const sellersSection = document.getElementById('sellersSection');
        const sellerGrid = document.getElementById('sellerGrid');
        const scrollSellersLeft = document.getElementById('scrollSellersLeft');
        const scrollSellersRight = document.getElementById('scrollSellersRight');
        const productsSection = document.getElementById('productsSection');
        const selectedSellerInfo = document.getElementById('selectedSellerInfo');
        const productsGrid = document.getElementById('productsGrid');
        const cartContainer = document.getElementById('cartContainer');
        const cartClose = document.getElementById('cartClose');
        const cartItems = document.getElementById('cartItems');
        const orderSummary = document.getElementById('orderSummary');
        const orderCount = document.getElementById('orderCount');
        const orderTotal = document.getElementById('orderTotal');
        const subtotalEl = document.getElementById('subtotal');
        const discountEl = document.getElementById('discount');
        const vatAmountEl = document.getElementById('vatAmount');
        const totalAmountEl = document.getElementById('totalAmount');
        const payCashBtn = document.getElementById('payCash');
        const payCardBtn = document.getElementById('payCard');
        const payBonusBtn = document.getElementById('payBonus');
        const assistantMessage = document.getElementById('assistantMessage');
        const userMessage = document.getElementById('userMessage');
        const voiceIndicator = document.getElementById('voiceIndicator');
        const closeVoiceStatus = document.getElementById('closeVoiceStatus');
        const voiceStatusPanel = document.getElementById('voiceStatusPanel');
        const howItWorks = document.getElementById('howItWorks');
        const locationMarker = document.getElementById('locationMarker');
        const locationText = document.getElementById('locationText');
        const locationModal = document.getElementById('locationModal');
        const locationOptions = document.getElementById('locationOptions');
        const currentAddressText = document.getElementById('currentAddressText');
        const newAddressForm = document.getElementById('newAddressForm');
        const newAddressInput = document.getElementById('newAddressInput');
        const saveNewAddress = document.getElementById('saveNewAddress');
        const confirmLocation = document.getElementById('confirmLocation');
        const referralLink = document.getElementById('referralLink');
        const whatsappOrder = document.getElementById('whatsappOrder');

         // Utility functions
        function money(n) { 
            return Number(n||0).toLocaleString('tr-TR',{minimumFractionDigits:2, maximumFractionDigits:2}) + ' ‚Ç∫'; 
        }

   // D√ºzeltilmi≈ü initApp sƒ±ralamasƒ±// Ana uygulama ba≈ülatma fonksiyonu (d√ºzeltilmi≈ü)
async function initApp() {
    try {
        debugLog('üöÄ === UYGULAMA BA≈ûLATILIYOR ===');
        debugStorage();

        // 1. DOM hazƒ±r olana kadar bekle
        await waitForDOMElements();
        debugLog('‚úÖ DOM hazƒ±r');

        // 2. Oturumu geri y√ºkle (√ñNEMLƒ∞: ƒ∞lk sƒ±rada)
        await restoreSession();
        debugLog('‚úÖ Oturum y√ºklendi', { 
            user: currentCustomer ? 'Giri≈ü yapƒ±lmƒ±≈ü' : 'Misafir',
            location: localStorage.getItem('selectedLocation')
        });

        // 3. Profil ve √ßƒ±kƒ±≈ü butonunu ayarla
        setupProfileDropdown();
        debugLog('‚úÖ Profil dropdown ayarlandƒ±');

        // 4. StoreTypes ve Vendors y√ºkle (OTURUMDAN BAƒûIMSIZ)
        await loadStoreTypes();
        debugLog('‚úÖ StoreTypes ve Vendors y√ºklendi');

        // 5. Konum y√∂netimi
        const hasLocation = initializeLocation();
        debugLog('‚úÖ Konum y√∂netimi tamamlandƒ±', { hasLocation });

        // 6. Mikrofon kontrolleri
        setupMicrophoneControls();
        debugLog('‚úÖ Mikrofon kontrolleri ayarlandƒ±');

        // 7. Banner y√∂netimi
        if (currentCustomer) {
            hideHowItWorksBanner();
            debugLog('‚úÖ Giri≈ü yapƒ±lmƒ±≈ü - banner gizlendi');
        } else {
            showHowItWorksBanner();
            debugLog('‚úÖ Misafir - banner g√∂sterildi');
        }

        // 8. Asistanƒ± ba≈ülat
        if (hasLocation) {
            initializeAssistant();
            debugLog('‚úÖ Asistan ba≈ülatƒ±ldƒ±');
        }

        debugLog('üéâ === UYGULAMA BA≈ûLATMA TAMAMLANDI ===');

    } catch (error) {
        console.error('üí• Uygulama ba≈ülatma hatasƒ±:', error);
        emergencyFallback();
    }
}

// Mikrofon kontrolleri
function setupMicrophoneControls() {
    if (microphoneToggle) {
        microphoneToggle.addEventListener('click', handleMicrophoneToggle);
        
        // Misafir kullanƒ±cƒ± i√ßin mikrofonu otomatik a√ß
        if (!currentCustomer) {
            setTimeout(() => {
                enableMicrophone();
                debugLog('üé§ Misafir i√ßin mikrofon a√ßƒ±ldƒ±');
            }, 1500);
        }
    }
}
// Acil durum fallback'i
function emergencyFallback() {
    debugLog('üÜò Acil durum modu aktif');
    
    // Kritik verileri kontrol et ve fallback uygula
    if (!storeTypes || storeTypes.length === 0) {
        useFallbackStoreTypes();
    }
    
    if (!vendors || vendors.length === 0) {
        useFallbackVendors();
    }
    
    if (!selectedLocation) {
        selectedLocation = 'inside';
        localStorage.setItem('selectedLocation', selectedLocation);
    }
    
    // Mikrofonu etkinle≈ütir
    setTimeout(() => {
        enableMicrophone();
    }, 1000);
    
    // √áƒ±kƒ±≈ü butonunu olu≈ütur
    setupProfileDropdown();
    
    debugLog('üÜò Acil durum modu tamamlandƒ±');
}     
// DOM elementlerinin y√ºklenmesini bekleyen fonksiyon
function waitForDOMElements() {
    return new Promise((resolve) => {
        const elements = {
            'microphoneToggle': document.getElementById('microphoneToggle'),
            'locationModal': document.getElementById('locationModal'),
            'userProfile': document.getElementById('userProfile'),
            'logoutButton': document.getElementById('logoutButton') || document.getElementById('fixedLogoutButton')
        };

        let attempts = 0;
        const maxAttempts = 30; // 3 saniye

        const checkElements = () => {
            attempts++;
            const loaded = Object.values(elements).filter(el => el !== null).length;
            const total = Object.keys(elements).length;

            debugLog(`DOM y√ºkleme: ${loaded}/${total} (deneme ${attempts})`);

            if (loaded >= 2 || attempts >= maxAttempts) { // En az 2 kritik element
                debugLog('‚úÖ Minimum DOM elementleri y√ºklendi');
                resolve();
                return;
            }

            setTimeout(checkElements, 100);
        };

        checkElements();
    });
}

		
// Konum se√ßimini zorunlu kƒ±lmak i√ßin mikrofon kontrol√º
function toggleMicrophone() {
    // Konum se√ßilmemi≈üse mikrofonu a√ßmaya izin verme
    if (!selectedLocation) {
        showLocationModal();
        showNotification('L√ºtfen √∂nce bir konum se√ßiniz.');
        return;
    }
    
    // Normal mikrofon a√ßma/kapama i≈ülemi
    if (isListening) {
        disableMicrophone();
    } else {
        enableMicrophone();
    }
}

// Bildirim g√∂ster
function showNotification(message) {
    // Basit bir bildirim sistemi
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #ff4444;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 10000;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        document.body.removeChild(notification);
    }, 3000);
}

// Konum y√∂netimi
function initializeLocation() {
    // √ñnce kayƒ±tlƒ± konumu kontrol et
    const savedLocation = localStorage.getItem('selectedLocation');
    
    if (savedLocation) {
        selectedLocation = savedLocation;
        debugLog('üìç Kayƒ±tlƒ± konum kullanƒ±lƒ±yor:', selectedLocation);
        return true;
    }
    
    // Konum yoksa modal g√∂ster
    debugLog('üìç Konum se√ßilmemi≈ü, modal g√∂sterilecek');
    showLocationModal();
    return false;
}

// Geli≈ütirilmi≈ü konum se√ßim modalƒ±
function showLocationModal() {
    const modal = document.getElementById('locationModal');
    if (!modal) {
        debugLog('‚ùå Location modal bulunamadƒ±');
        // Acil durum: Varsayƒ±lan konum ata
        selectedLocation = 'inside';
        localStorage.setItem('selectedLocation', selectedLocation);
        debugLog('üîÑ Varsayƒ±lan konum atandƒ±:', selectedLocation);
        return;
    }

    modal.style.display = 'block';
    
    // Konum se√ßeneklerine event listener ekle
    const options = modal.querySelectorAll('.location-option');
    options.forEach(option => {
        option.onclick = function() {
            const location = this.getAttribute('data-location');
            selectLocation(location);
        };
    });

    debugLog('üìç Konum modalƒ± g√∂sterildi');
}
		
		// Geli≈ütirilmi≈ü konum kontrol fonksiyonu
function checkLocationAndInitialize() {
    const savedLocation = localStorage.getItem('selectedLocation');
    
    // Eƒüer kullanƒ±cƒ± giri≈ü yapmƒ±≈üsa ve konum se√ßilmemi≈üse modal g√∂ster
    if (currentCustomer && !savedLocation) {
        console.log('Kullanƒ±cƒ± giri≈ü yapmƒ±≈ü ama konum se√ßmemi≈ü, modal g√∂steriliyor...');
        showLocationModal();
        return false; // Konum se√ßilene kadar devam etme
    }
    
    // Eƒüer konum se√ßilmi≈üse asistanƒ± ba≈ülat
    if (savedLocation) {
        selectedLocation = savedLocation;
        console.log('Kayƒ±tlƒ± konum kullanƒ±lƒ±yor:', selectedLocation);
        initializeAssistant();
        return true;
    }
    
    // Giri≈ü yapmamƒ±≈ü kullanƒ±cƒ±lar i√ßin doƒürudan asistanƒ± ba≈ülat
    if (!currentCustomer) {
        console.log('Misafir kullanƒ±cƒ±, konum se√ßimi olmadan asistan ba≈ülatƒ±lƒ±yor...');
        setTimeout(() => {
            enableMicrophone();
        }, 1000);
        return true;
    }
    
    return false;
}
		
// Sayfa y√ºklendiƒüinde initApp'i √ßalƒ±≈ütƒ±r
document.addEventListener('DOMContentLoaded', function() {
    initApp();
});

		
async function processReferralCode(code, groupCode) {
    try {
        console.log('Referans kodu i≈üleniyor:', code, groupCode);
        
        // √ñnce bu referral kodunun var olup olmadƒ±ƒüƒ±nƒ± kontrol et
        const { data: existingLink, error: checkError } = await supabase
            .from('referral_links')
            .select('*')
            .eq('referral_code', code)
            .maybeSingle(); // single() yerine maybeSingle() kullanƒ±yoruz

        if (checkError && checkError.code !== 'PGRST116') { // PGRST116: no rows returned hatasƒ±
            console.error('Kontrol hatasƒ±:', checkError);
            throw checkError;
        }

        // Eƒüer referral link yoksa, yeni bir tane olu≈ütur
        if (!existingLink) {
            const referrerUserId = "e70fbcb9-ea86-4479-9c0a-39957283c38f"; // Varsayƒ±lan admin user ID
            
            const { data: newLink, error: insertError } = await supabase
                .from('referral_links')
                .insert([
                    { 
                        owner_user_id: referrerUserId,
                        referral_code: code,
                        group_code: groupCode,
                        created_at: new Date().toISOString()
                    }
                ])
                .select();

            if (insertError) {
                console.error('Referral link ekleme hatasƒ±:', insertError);
                throw insertError;
            }
            
            console.log('Yeni referral link olu≈üturuldu:', newLink);
        } else {
            console.log('Referral link zaten mevcut:', existingLink);
        }

        // Local storage'a kaydet (sonradan kullanmak i√ßin)
        localStorage.setItem('referral_code', code);
        localStorage.setItem('referral_group_code', groupCode);
        
        console.log('Referans kodu ba≈üarƒ±yla i≈ülendi ve kaydedildi');
        
    } catch (error) {
        console.error('Referans kodu i≈üleme hatasƒ±:', error);
        // Hata olsa bile uygulamanƒ±n √ßalƒ±≈ümasƒ±na devam etmesi i√ßin hatayƒ± fƒ±rlatmƒ±yoruz
    }
}

		
        function setupEventHandlers() {
            // Profil dropdown
            profileBtn.addEventListener('click', function() {
                profileDropdown.classList.toggle('show');
                
                // 10 saniye sonra dropdown'u kapat
                setTimeout(() => {
                    profileDropdown.classList.remove('show');
                }, 10000);
            });
            
         // √áƒ±kƒ±≈ü butonu
            logoutBtn.addEventListener('click', logout);
            
            // Kaydƒ±rma butonlarƒ±
            scrollSellerTypesLeft.addEventListener('click', () => scrollElement(sellerTypeGrid, -200));
            scrollSellerTypesRight.addEventListener('click', () => scrollElement(sellerTypeGrid, 200));
            scrollCategoriesLeft.addEventListener('click', () => scrollElement(categoriesGrid, -200));
            scrollCategoriesRight.addEventListener('click', () => scrollElement(categoriesGrid, 200));
            scrollSellersLeft.addEventListener('click', () => scrollElement(sellerGrid, -200));
            scrollSellersRight.addEventListener('click', () => scrollElement(sellerGrid, 200));
            
            // Sepet i≈ülemleri
            cartClose.addEventListener('click', closeCart);
            orderSummary.addEventListener('click', toggleCart);
            
            // √ñdeme butonlarƒ±
            payCashBtn.addEventListener('click', () => finalizeOrder('nakit'));
            payCardBtn.addEventListener('click', () => finalizeOrder('kart'));
            payBonusBtn.addEventListener('click', () => finalizeOrder('bonus'));
            
            // Konum i≈ülemleri
            locationMarker.addEventListener('click', showLocationModal);
            locationOptions.querySelectorAll('.location-option').forEach(option => {
                option.addEventListener('click', function() {
                    locationOptions.querySelectorAll('.location-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    
                    if (this.dataset.type === 'new') {
                        newAddressForm.style.display = 'block';
                    } else {
                        newAddressForm.style.display = 'none';
                    }
                });
            });
            
            saveNewAddress.addEventListener('click', saveNewLocation);
            confirmLocation.addEventListener('click', confirmSelectedLocation);
            
            // Footer linkleri
            referralLink.addEventListener('click', generateReferralLink);
            whatsappOrder.addEventListener('click', shareOnWhatsApp);
            
            // Sesli asistan kapatma
            closeVoiceStatus.addEventListener('click', function() {
                voiceStatusPanel.style.display = 'none';
            });
        }

function handleMicrophoneToggle() {
    // Konum kontrol√º - eƒüer kullanƒ±cƒ± giri≈ü yapmƒ±≈üsa ve konum se√ßmemi≈üse
    if (currentCustomer && !localStorage.getItem('selectedLocation')) {
        showLocationModal();
        showNotification('L√ºtfen √∂nce bir konum se√ßiniz.');
        return;
    }
    
    // Normal mikrofon a√ßma/kapama i≈ülemi
    if (isListening) {
        disableMicrophone();
    } else {
        enableMicrophone();
    }
}




// √áƒ±kƒ±≈ü butonunu ayarla
// Geli≈ütirilmi≈ü logout buton y√∂netimi
function setupLogoutButton() {
    let logoutBtn = document.getElementById('logoutButton');
    
    // Eƒüer element yoksa, olu≈ütur
    if (!logoutBtn) {
        logoutBtn = createLogoutButton();
        debugLog('logoutButton olu≈üturuldu');
    } else {
        debugLog('logoutButton mevcut, ayarlanƒ±yor');
    }
    
    // Event listener'ƒ± temizle ve yeniden ekle
    logoutBtn.onclick = null;
    logoutBtn.removeEventListener('click', handleLogout);
    logoutBtn.addEventListener('click', handleLogout);
    
    // G√∂r√ºn√ºrl√ºƒü√º g√ºncelle
    updateLogoutButtonVisibility();
}

// Logout butonu olu≈ütur
function createLogoutButton() {
    const logoutBtn = document.createElement('button');
    logoutBtn.id = 'logoutButton';
    logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> √áƒ±kƒ±≈ü Yap';
    logoutBtn.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1000;
        padding: 8px 16px;
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: none;
    `;
    
    document.body.appendChild(logoutBtn);
    return logoutBtn;
}

// Logout buton g√∂r√ºn√ºrl√ºƒü√ºn√º g√ºncelle
function updateLogoutButtonVisibility() {
    const logoutBtn = document.getElementById('logoutButton');
    if (!logoutBtn) return;
    
    if (currentCustomer) {
        logoutBtn.style.display = 'block';
        debugLog('√áƒ±kƒ±≈ü butonu g√∂r√ºn√ºr yapƒ±ldƒ± - Kullanƒ±cƒ± giri≈ü yapmƒ±≈ü');
    } else {
        logoutBtn.style.display = 'none';
        debugLog('√áƒ±kƒ±≈ü butonu gizlendi - Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü');
    }
}		
// Debug i√ßin: LocalStorage durumunu g√∂ster
function showStorageStatus() {
    console.log('=== LOCALSTORAGE DURUMU ===');
    console.log('currentCustomer:', localStorage.getItem('currentCustomer'));
    console.log('selectedLocation:', localStorage.getItem('selectedLocation'));
    console.log('referral_code:', localStorage.getItem('referral_code'));
    console.log('referral_group_code:', localStorage.getItem('referral_group_code'));
    console.log('==========================');
}


		
// Sayfa y√ºklendiƒüinde storage durumunu g√∂ster
document.addEventListener('DOMContentLoaded', function() {
    showStorageStatus();
    
    // Her 5 saniyede bir storage durumunu logla (debug i√ßin)
    setInterval(showStorageStatus, 5000);
});
		
        function scrollElement(element, amount) {
            element.scrollBy({ left: amount, behavior: 'smooth' });
        }

        function toggleCart() {
            if (cartContainer.classList.contains('open')) {
                closeCart();
            } else {
                openCart();
            }
        }

        function openCart() {
            cartContainer.classList.add('open');
        }

        function closeCart() {
            cartContainer.classList.remove('open');
        }


		 // Store type'ƒ± isme g√∂re se√ß
        // Store type'ƒ± isme g√∂re se√ß
        function selectStoreTypeByName(typeName) {
            const typeCard = Array.from(document.querySelectorAll('.seller-type-card')).find(card => 
                card.dataset.typeName === typeName
            );
            
            if (typeCard) {
                typeCard.click();
            }
        }

       // "Nasƒ±l √áalƒ±≈üƒ±r" banner'ƒ±nƒ± g√∂ster
        function showHowItWorksBanner() {
            document.getElementById('howItWorks').style.display = 'block';
            document.getElementById('categoriesSection').style.display = 'none';
            document.getElementById('sellersSection').style.display = 'none';
            document.getElementById('productsSection').style.display = 'none';
            document.getElementById('orderSummary').style.display = 'none';
        }

        // "Nasƒ±l √áalƒ±≈üƒ±r" banner'ƒ±nƒ± gizle
        function hideHowItWorksBanner() {
            document.getElementById('howItWorks').style.display = 'none';
            document.getElementById('categoriesSection').style.display = 'block';
            document.getElementById('sellersSection').style.display = 'block';
            document.getElementById('productsSection').style.display = 'block';
            document.getElementById('orderSummary').style.display = 'flex';
        }

// Basitle≈ütirilmi≈ü showLocationModal
function showLocationModal() {
    const locationModal = document.getElementById('locationModal');
    const locationOptions = document.querySelector('.location-options');
    
    if (!locationModal || !locationOptions) {
        console.error('Modal elementleri bulunamadƒ±');
        return;
    }
    
    locationModal.style.display = 'block';
    
    // Modal dƒ±≈üƒ±na tƒ±klanƒ±nca kapanmasƒ±nƒ± saƒüla
    locationModal.onclick = function(e) {
        if (e.target === locationModal) {
            hideLocationModal();
        }
    };
    
    // Konum se√ßeneklerine tƒ±klama event'lerini ekle
    locationOptions.querySelectorAll('.location-option').forEach(option => {
        option.onclick = function() {
            selectLocation(this.getAttribute('data-location'));
        };
    });
    
    disableMicrophone();
}
// Konum modalƒ±nƒ± gizle
function hideLocationModal() {
    locationModal.style.display = 'none';
    // Modal kapandƒ±ƒüƒ±nda mikrofonu etkinle≈ütir
    enableMicrophone();
}

// Konum se√ßildiƒüinde √ßalƒ±≈üacak fonksiyon
function selectLocation(locationType) {
    console.log('Se√ßilen konum:', locationType);
    
    // Se√ßilen konumu sakla
    selectedLocation = locationType;
    localStorage.setItem('selectedLocation', locationType);
    
    // Modalƒ± kapat
    hideLocationModal();
    
    // Konum se√ßildikten sonra asistanƒ± aktif et
    initializeAssistant();
}
// Asistanƒ± ba≈ülat
function initializeAssistant() {
    // Mikrofonu etkinle≈ütir
    enableMicrophone();
    
    // Gerekli diƒüer ba≈ülatma i≈ülemleri
    console.log('Asistan aktif, konum:', selectedLocation);
}

		
        // Store type'larƒ± y√ºkle (d√ºzeltilmi≈ü versiyon)
// StoreTypes y√ºkleme (yeniden d√ºzenlenmi≈ü)
async function loadStoreTypes() {
    try {
        debugLog('üîß StoreTypes y√ºkleniyor...');
        
        // 1. √ñnce cache kontrol√º
        const cached = localStorage.getItem('storeTypes');
        if (cached) {
            storeTypes = JSON.parse(cached);
            debugLog('‚úÖ StoreTypes cache den y√ºklendi', storeTypes.length);
        }
        
        // 2. Sunucudan y√ºkle (cache olsa bile g√ºncelle)
        const { data, error } = await supabase
            .from('store_type')
            .select('*')
            .order('name');

        if (error) {
            console.error('‚ùå StoreTypes y√ºkleme hatasƒ±:', error);
            
            // Cache'de veri yoksa fallback kullan
            if (!storeTypes || storeTypes.length === 0) {
                await useFallbackStoreTypes();
            }
            return;
        }

        if (data && data.length > 0) {
            storeTypes = data;
            localStorage.setItem('storeTypes', JSON.stringify(storeTypes));
            debugLog('‚úÖ StoreTypes sunucudan y√ºklendi', storeTypes.length);
        } else {
            debugLog('‚ö†Ô∏è StoreTypes verisi bo≈ü');
            await useFallbackStoreTypes();
        }

        // 3. Vendors y√ºkle
        await loadVendors();

    } catch (error) {
        console.error('‚ùå StoreTypes y√ºkleme hatasƒ±:', error);
        await useFallbackStoreTypes();
    }
}

//  y√ºkleme
async function load() {
    try {
        debugLog('üîß  y√ºkleniyor...');
        
        let Data = [];

        // Cache kontrol√º
        const cached = localStorage.getItem('');
        if (cached) {
            vendorsData = JSON.parse(cached);
            debugLog('‚úÖ Vendors cache den y√ºklendi', vendorsData.length);
        }

        // Sunucudan y√ºkle
        const { data, error } = await supabase
            .from('vendors')
            .select('*')
            .eq('is_active', true)
            .order('name');

        if (error) {
            console.error('‚ùå Vendors y√ºkleme hatasƒ±:', error);
            
            if (vendorsData.length === 0) {
                await useFallbackVendors();
            }
            return;
        }

        if (data && data.length > 0) {
            vendorsData = data;
            localStorage.setItem('vendors', JSON.stringify(vendorsData));
            debugLog('‚úÖ Vendors sunucudan y√ºklendi', vendorsData.length);
        } else {
            debugLog('‚ö†Ô∏è Vendors verisi bo≈ü');
            await useFallbackVendors();
        }

        vendors = vendorsData;
        filterAndDisplayVendors();

    } catch (error) {
        console.error('‚ùå Vendors y√ºkleme hatasƒ±:', error);
        await useFallbackVendors();
    }
}

// Fallback veriler
async function useFallbackStoreTypes() {
    storeTypes = [
        { id: 1, name: 'Restoran', code: 'restaurant', description: 'Yemek restoranlarƒ±' },
        { id: 2, name: 'Kafe', code: 'cafe', description: 'Kafe ve pastaneler' },
        { id: 3, name: 'Market', code: 'market', description: 'Market ve bakkallar' }
    ];
    localStorage.setItem('storeTypes', JSON.stringify(storeTypes));
    debugLog('üîÑ Fallback StoreTypes kullanƒ±lƒ±yor');
}

async function useFallbackVendors() {
    vendors = [
        { 
            id: 1, 
            name: '√ñrnek Restoran', 
            description: 'Lezzetli yemekler',
            locations: 'inside,takeaway,delivery',
            is_active: true
        }
    ];
    localStorage.setItem('vendors', JSON.stringify(vendors));
    debugLog('üîÑ Fallback Vendors kullanƒ±lƒ±yor');
}

// Sunucudan StoreTypes y√ºkle
async function loadStoreTypesFromServer() {
    const { data, error } = await supabase
        .from('store_type')
        .select('*')
        .order('name');
    
    if (error) {
        console.error('StoreTypes sunucu hatasƒ±:', error);
        throw error;
    }
    
    storeTypes = data || [];
    localStorage.setItem('storeTypes', JSON.stringify(storeTypes));
    debugLog('StoreTypes sunucudan y√ºklendi:', storeTypes.length);
    
    // Satƒ±cƒ±larƒ± y√ºkle
    await loadVendors();
}

// Fallback StoreTypes kullan
async function useFallbackStoreTypes() {
    storeTypes = [
        { id: 1, name: 'Restoran', code: 'restaurant' },
        { id: 2, name: 'Kafe', code: 'cafe' },
        { id: 3, name: 'Market', code: 'market' }
    ];
    
    debugLog('Fallback StoreTypes kullanƒ±lƒ±yor:', storeTypes);
    
    // Satƒ±cƒ±larƒ± y√ºkle
    await loadVendors();
}
function getFallbackStoreTypes() {
    return [
        { id: 1, name: 'Restoran', code: 'restaurant' },
        { id: 2, name: 'Kafe', code: 'cafe' },
        { id: 3, name: 'Market', code: 'market' }
    ];
}
		
// Satƒ±cƒ±larƒ± y√ºkle
// Satƒ±cƒ±larƒ± y√ºkleme fonksiyonunu d√ºzelt
async function loadVendors() {
    try {
        debugLog('üîß Satƒ±cƒ±lar y√ºkleniyor...');
        
        let vendorsData = [];

        // Seller_profiles tablosunu kullan
        const { data, error } = await supabase
            .from('seller_profiles')  // ‚úÖ Doƒüru tablo
            .select('*')
            .eq('is_active', true)
            .order('seller_name');

        if (error) {
            console.error('‚ùå Satƒ±cƒ± y√ºkleme hatasƒ±:', error);
            await useFallbackVendors();
            return;
        }

        if (data && data.length > 0) {
            vendorsData = data.map(seller => ({
                id: seller.id,
                name: seller.business_name || seller.full_name,
                description: seller.business_description,
                locations: seller.service_locations || 'inside,takeaway,delivery',
                is_active: seller.is_active,
                image_url: seller.business_logo
            }));
            
            vendors = vendorsData;
            localStorage.setItem('vendors', JSON.stringify(vendors));
            debugLog('‚úÖ Satƒ±cƒ±lar y√ºklendi:', vendors.length);
        } else {
            await useFallbackVendors();
        }

        // Konuma g√∂re filtrele
        filterAndDisplayVendors();

    } catch (error) {
        console.error('‚ùå Satƒ±cƒ± y√ºkleme hatasƒ±:', error);
        await useFallbackVendors();
    }
}
// Satƒ±cƒ±larƒ± filtrele ve g√∂ster
// Satƒ±cƒ± y√ºkleme ve konum e≈üle≈ütirme
async function loadVendors() {
    try {
        debugLog('Satƒ±cƒ±lar y√ºkleniyor, konum:', selectedLocation);
        
        let vendorsData = [];
        
        // √ñnce cache'den dene
        const cachedVendors = localStorage.getItem('vendors');
        if (cachedVendors) {
            vendorsData = JSON.parse(cachedVendors);
            debugLog('Satƒ±cƒ±lar cache den y√ºklendi:', vendorsData.length);
        }
        
        // Sunucudan g√ºncel veriyi al
        const { data, error } = await supabase
            .from('vendors')
            .select('*')
            .eq('is_active', true)
            .order('name');
        
        if (!error && data) {
            vendorsData = data;
            localStorage.setItem('vendors', JSON.stringify(vendorsData));
            debugLog('Satƒ±cƒ±lar sunucudan y√ºklendi:', vendorsData.length);
        }
        
        vendors = vendorsData;
        
        // Konuma g√∂re filtrele
        filterAndDisplayVendors();
        
    } catch (error) {
        console.error('Satƒ±cƒ± y√ºkleme hatasƒ±:', error);
        vendors = [];
    }
}

// Satƒ±cƒ±larƒ± filtrele ve g√∂ster
function filterAndDisplayVendors() {
    if (!selectedLocation) {
        debugLog('Konum se√ßilmediƒüi i√ßin t√ºm satƒ±cƒ±lar g√∂steriliyor');
        displayVendors(vendors);
        return;
    }
    
    pconst filteredVendors = vendors.filter(vendor => {
        // Vendor'ƒ±n locations alanƒ±nƒ± kontrol et
        let vendorLocations = [];
        
        if (vendor.locations) {
            if (typeof vendor.locations === 'string') {
                vendorLocations = vendor.locations.split(',').map(loc => loc.trim());
            } else if (Array.isArray(vendor.locations)) {
                vendorLocations = vendor.locations;
            }
        }
        
        // Konum e≈üle≈ümesini kontrol et ve debug et
        const matches = vendorLocations.length === 0 || 
                       vendorLocations.includes('all') || 
                       vendorLocations.includes(selectedLocation);
        
        debugLog(`Satƒ±cƒ±: ${vendor.name}`, {
            'Satƒ±cƒ± Konumlarƒ±': vendorLocations,
            'Kullanƒ±cƒ± Konumu': selectedLocation,
            'E≈üle≈üme': matches
        });
        
        return matches;
    });
    
    debugLog(`Filtrelenmi≈ü satƒ±cƒ±lar: ${filteredVendors.length}/${vendors.length}`);
    displayVendors(filteredVendors);
}
// Store type'larƒ± ekranda g√∂ster
        function displayStoreTypes(types) {
            const sellerTypeGrid = document.getElementById('sellerTypeGrid');
            sellerTypeGrid.innerHTML = '';
            
            if (types.length === 0) {
                sellerTypeGrid.innerHTML = `
                    <div class="text-center" style="min-width: 100%; padding: 40px; color: #6c757d;">
                        <i class="fas fa-store fa-3x mb-3"></i>
                        <p>Store type bulunamadƒ±</p>
                    </div>
                `;
                return;
            }
            
            const iconMap = {
                'Market': 'fas fa-store',
                'Restoran': 'fas fa-utensils',
                'Eczane': 'fas fa-prescription-bottle',
                'Fƒ±rƒ±n': 'fas fa-bread-slice'
            };
            
            types.forEach(type => {
                const typeCard = document.createElement('div');
                typeCard.className = 'seller-type-card';
                typeCard.dataset.typeId = type.id;
                typeCard.dataset.typeName = type.name;
                
                typeCard.innerHTML = `
                    <div class="seller-type-icon">
                        <i class="${iconMap[type.name] || 'fas fa-store'}"></i>
                    </div>
                    <div class="seller-type-name">${type.name}</div>
                `;
                
                typeCard.addEventListener('click', () => {
                    onStoreTypeSelected(type.id, type.name);
                });
                
                sellerTypeGrid.appendChild(typeCard);
            });
            
            console.log("Store type'lar ba≈üarƒ±yla y√ºklendi");
        }

        // Store type se√ßildiƒüinde
        async function onStoreTypeSelected(storeTypeId, storeTypeName) {
            console.log("Store type se√ßildi:", storeTypeName, "ID:", storeTypeId);
            
            selectedSellerType = storeTypeName;
            
            // Reyonlarƒ± y√ºkle
            await loadReyonsByStoreType(storeTypeId);
            
            // Satƒ±cƒ±larƒ± y√ºkle
            await loadSellersByStoreType(storeTypeId);
            
            // Kategori/reyon ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
            const categoriesTitle = document.getElementById('categoriesTitle');
            categoriesTitle.textContent = storeTypeName === 'Market' ? 'Reyonlar' : 'Men√º Kategorileri';
            
            // ƒ∞lgili b√∂l√ºmleri g√∂ster
            document.getElementById('categoriesSection').style.display = 'block';
            document.getElementById('sellersSection').style.display = 'block';
            
            // "Nasƒ±l √áalƒ±≈üƒ±r" banner'ƒ±nƒ± gizle
            hideHowItWorksBanner();
        }

         // Store type'a g√∂re reyonlarƒ± y√ºkle
        async function loadReyonsByStoreType(storeTypeId) {
            try {
                console.log("Reyonlar y√ºkleniyor, storeTypeId:", storeTypeId);
                
                const { data, error } = await supabase
                    .from('reyon')
                    .select('*')
                    .eq('store_type_id', storeTypeId);

                if (error) throw error;

                categories = data || [];
                console.log("Reyonlar:", categories);
                
                displayCategories(categories, 'reyon');

            } catch (error) {
                console.error('Reyon y√ºkleme hatasƒ±:', error);
                
                // Demo veriler
                const demoReyons = {
                    '1': [ // Market reyonlarƒ±
                        { id: '1', name: 'Meyve & Sebze', image_url: '' },
                        { id: '2', name: 'S√ºt √úr√ºnleri', image_url: '' },
                        { id: '3', name: 'Et & Tavuk', image_url: '' }
                    ],
                    '2': [ // Restoran kategorileri
                        { id: '4', name: 'Ana Yemekler' },
                        { id: '5', name: '√áorbalar' },
                        { id: '6', name: 'Tatlƒ±lar' }
                    ],
                    '3': [ // Eczane kategorileri
                        { id: '7', name: 'Aƒürƒ± Kesiciler' },
                        { id: '8', name: 'Vitaminler' }
                    ],
                    '4': [ // Fƒ±rƒ±n kategorileri
                        { id: '9', name: 'Ekmekler' },
                        { id: '10', name: 'Pastalar' }
                    ]
                };
                
                categories = demoReyons[storeTypeId] || [];
                displayCategories(categories, 'reyon');
            }
        }

// Konuma g√∂re satƒ±cƒ±larƒ± filtrele
function filterVendorsByLocation() {
    if (!selectedLocation || vendors.length === 0) {
        debugLog('Filtreleme i√ßin konum veya satƒ±cƒ± bulunamadƒ±');
        return;
    }
    
    const filteredVendors = vendors.filter(vendor => {
        const vendorLocations = vendor.locations ? vendor.locations.split(',') : ['all'];
        const matches = vendorLocations.includes(selectedLocation) || vendorLocations.includes('all');
        
        // Debug √ßƒ±ktƒ±sƒ±
        debugLocationMatch(vendorLocations, selectedLocation);
        debugLog(`Satƒ±cƒ±: ${vendor.name}, Konumlar: ${vendorLocations}, E≈üle≈üme: ${matches}`);
        
        return matches;
    });
    
    debugLog(`Filtrelenmi≈ü satƒ±cƒ±lar: ${filteredVendors.length} / ${vendors.length}`);
    displayVendors(filteredVendors);
}

// Satƒ±cƒ±larƒ± g√∂r√ºnt√ºle
function displayVendors(vendorList) {
    const vendorsContainer = document.getElementById('vendorsContainer');
    if (!vendorsContainer) {
        debugLog('Vendors container bulunamadƒ±');
        return;
    }
    
    if (vendorList.length === 0) {
        vendorsContainer.innerHTML = '<p>Bu konum i√ßin satƒ±cƒ± bulunamadƒ±.</p>';
        return;
    }
    
    vendorsContainer.innerHTML = vendorList.map(vendor => `
        <div class="vendor-card" data-vendor-id="${vendor.id}">
            <h3>${vendor.name}</h3>
            <p>${vendor.description || ''}</p>
            <span class="vendor-location">Konum: ${vendor.locations || 'T√ºm konumlar'}</span>
        </div>
    `).join('');
    
    debugLog('Satƒ±cƒ±lar g√∂r√ºnt√ºlendi:', vendorList.length);
}

		// Debug modu
const DEBUG_MODE = true;

// Debug fonksiyonu
function debugLog(message, data = null) {
    if (DEBUG_MODE) {
        console.log(`[DEBUG] ${new Date().toLocaleTimeString()}: ${message}`, data || '');
    }
}

// Geli≈ütirilmi≈ü debug fonksiyonlarƒ±
function debugStorage() {
    console.group('üìä DEBUG: STORAGE DURUMU');
    console.log('currentCustomer:', localStorage.getItem('currentCustomer') ? '‚úì' : '‚úó');
    console.log('selectedLocation:', localStorage.getItem('selectedLocation') || 'null');
    console.log('storeTypes:', localStorage.getItem('storeTypes') ? '‚úì' : '‚úó');
    console.log('vendors:', localStorage.getItem('vendors') ? '‚úì' : '‚úó');
    console.log('referral_code:', localStorage.getItem('referral_code') || 'null');
    console.log('referral_group_code:', localStorage.getItem('referral_group_code') || 'null');
    console.groupEnd();
}

// Manuel test fonksiyonlarƒ±
window.debugApp = {
    // Storage'ƒ± temizle ve yeniden ba≈ülat
    reset: function() {
        localStorage.clear();
        sessionStorage.clear();
        location.reload();
    },
    
    // Konum ata
    setLocation: function(loc) {
        selectedLocation = loc;
        localStorage.setItem('selectedLocation', loc);
        debugLog('Konum manuel ayarlandƒ±:', loc);
        filterAndDisplayVendors();
    },
    
    // Kullanƒ±cƒ± sim√ºlasyonu
    simulateLogin: function() {
        currentCustomer = { id: 1, name: 'Test Kullanƒ±cƒ±' };
        localStorage.setItem('currentCustomer', JSON.stringify(currentCustomer));
        setupProfileDropdown();
        debugLog('Test kullanƒ±cƒ± giri≈ü yaptƒ±');
    },
    
    // Elementleri kontrol et
    checkElements: function() {
        const elements = [
            'userProfile', 'logoutButton', 'microphoneToggle', 
            'locationModal', 'fixedLogoutButton'
        ];
        
        console.group('üîç ELEMENT KONTROL√ú');
        elements.forEach(id => {
            const el = document.getElementById(id);
            console.log(`${id}:`, el ? '‚úì' : '‚úó');
        });
        console.groupEnd();
    }
};// Konum e≈üle≈üme kontrol√º
function debugLocationMatch(vendorLocation, userLocation) {
    if (!DEBUG_MODE) return;
    
    console.group('=== DEBUG: KONUM E≈ûLE≈ûMESƒ∞ ===');
    console.log('Satƒ±cƒ± Konumu:', vendorLocation);
    console.log('Kullanƒ±cƒ± Konumu:', userLocation);
    console.log('E≈üle≈üme Durumu:', vendorLocation === userLocation ? 'E≈ûLE≈ûƒ∞YOR' : 'E≈ûLE≈ûMƒ∞YOR');
    console.groupEnd();
}

		// Profil dropdown y√∂netimi
    function setupProfileDropdown() {
    const userProfile = document.getElementById('userProfile');
    const profileToggle = document.getElementById('profileToggle');
    const profileDropdown = document.getElementById('profileDropdown');
    const logoutButton = document.getElementById('logoutButton');
    const fixedLogoutButton = document.getElementById('fixedLogoutButton');

    // Kullanƒ±cƒ± giri≈ü yapmƒ±≈üsa profil alanƒ±nƒ± g√∂ster
    if (currentCustomer) {
        if (userProfile) userProfile.style.display = 'block';
        if (fixedLogoutButton) fixedLogoutButton.style.display = 'block';
        
        // Profil toggle event listener
        if (profileToggle && profileDropdown) {
            profileToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                const isVisible = profileDropdown.style.display === 'block';
                profileDropdown.style.display = isVisible ? 'none' : 'block';
            });

            // Dropdown dƒ±≈üƒ±na tƒ±klanƒ±nca kapat
            document.addEventListener('click', function() {
                profileDropdown.style.display = 'none';
            });
        }

        // √áƒ±kƒ±≈ü butonu event listener
        if (logoutButton) {
            logoutButton.addEventListener('click', handleLogout);
        }
        if (fixedLogoutButton) {
            fixedLogoutButton.addEventListener('click', handleLogout);
        }

        debugLog('Profil dropdown ayarlandƒ±');
    } else {
        // Kullanƒ±cƒ± giri≈ü yapmamƒ±≈üsa gizle
        if (userProfile) userProfile.style.display = 'none';
        if (fixedLogoutButton) fixedLogoutButton.style.display = 'none';
    }
}
		
		// Store type'a g√∂re satƒ±cƒ±larƒ± y√ºkle
        async function loadSellersByStoreType(storeTypeId) {
            try {
                console.log("Satƒ±cƒ±lar y√ºkleniyor, storeTypeId:", storeTypeId);
                
                // M√º≈üterinin konumunu al
                const customerCity = currentCustomer?.city || 'ƒ∞stanbul';
                
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('role', 'seller')
                    .eq('status', 'Active')
                    .eq('seller_type', storeTypeId) // seller_type = store_type_id
                    .ilike('city', `%${customerCity}%`);

                if (error) throw error;

                sellers = data || [];
                console.log("Satƒ±cƒ±lar:", sellers);
                
                updateSellersGrid();

            } catch (error) {
                console.error('Satƒ±cƒ± y√ºkleme hatasƒ±:', error);
                
                // Demo veriler
                sellers = [
                    { 
                        id: '1', 
                        full_name: "Migros", 
                        city: "ƒ∞stanbul", 
                        imgurl: "https://via.placeholder.com/200x120?text=Migros",
                        address: "Kadƒ±k√∂y, ƒ∞stanbul"
                    },
                    { 
                        id: '2', 
                        full_name: "CarrefourSA", 
                        city: "ƒ∞stanbul", 
                        imgurl: "https://via.placeholder.com/200x120?text=Carrefour",
                        address: "Be≈üikta≈ü, ƒ∞stanbul"
                    }
                ];
                updateSellersGrid();
            }
        }


     // Kategorileri/reyonlarƒ± g√∂ster
        function displayCategories(categoriesToShow, type) {
            const categoriesGrid = document.getElementById('categoriesGrid');
            categoriesGrid.innerHTML = '';
            
            if (categoriesToShow.length === 0) {
                categoriesGrid.innerHTML = `
                    <div class="text-center" style="min-width: 100%; padding: 40px; color: #6c757d;">
                        <i class="fas fa-box-open fa-3x mb-3"></i>
                        <p>Kategori bulunamadƒ±</p>
                    </div>
                `;
                return;
            }
            
            categoriesToShow.forEach(category => {
                const categoryCard = document.createElement('div');
                categoryCard.className = 'category-card';
                categoryCard.dataset.categoryId = category.id;
                
                const iconMap = {
                    'Meyve & Sebze': 'fas fa-apple-alt',
                    'S√ºt √úr√ºnleri': 'fas fa-cheese',
                    'Et & Tavuk': 'fas fa-drumstick-bite',
                    'Temel Gƒ±da': 'fas fa-wheat-alt',
                    'ƒ∞√ßecekler': 'fas fa-wine-bottle',
                    'Ana Yemekler': 'fas fa-utensils',
                    '√áorbalar': 'fas fa-bowl-food',
                    'Salatalar': 'fas fa-leaf',
                    'Tatlƒ±lar': 'fas fa-ice-cream',
                    'Aƒürƒ± Kesiciler': 'fas fa-pills',
                    'Vitaminler': 'fas fa-capsules',
                    'Ekmekler': 'fas fa-bread-slice',
                    'Pastalar': 'fas fa-birthday-cake'
                };
                
                categoryCard.innerHTML = `
                    <div class="category-icon">
                        <i class="${iconMap[category.name] || 'fas fa-box'}"></i>
                    </div>
                    <div class="category-name">${category.name}</div>
                `;
                
                categoryCard.addEventListener('click', function() {
                    document.querySelectorAll('.category-card').forEach(c => {
                        c.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    
                    selectedCategoryId = category.id;
                    if (type === 'reyon') {
                        filterProductsByReyon(selectedCategoryId);
                    } else {
                        filterProductsByCategory(selectedCategoryId);
                    }
                });
                
                categoriesGrid.appendChild(categoryCard);
            });
        }

        // Satƒ±cƒ± grid'ini g√ºncelle
        function updateSellersGrid() {
            const sellerGrid = document.getElementById('sellerGrid');
            sellerGrid.innerHTML = '';
            
            if (sellers.length === 0) {
                sellerGrid.innerHTML = `
                    <div class="text-center" style="min-width: 100%; padding: 40px; color: #6c757d;">
                        <i class="fas fa-store fa-3x mb-3"></i>
                        <p>Bu kategoride satƒ±cƒ± bulunamadƒ±</p>
                    </div>
                `;
                return;
            }
            
            sellers.forEach(seller => {
                const sellerCard = document.createElement('div');
                sellerCard.className = 'seller-card';
                if (selectedSellerId === seller.id) {
                    sellerCard.classList.add('selected');
                }
                if (isSellerLocked && selectedSellerId !== seller.id) {
                    sellerCard.classList.add('disabled');
                }
                
                sellerCard.innerHTML = `
                    <img src="${seller.imgurl || 'https://via.placeholder.com/200x120?text=Satƒ±cƒ±'}" alt="${seller.full_name}" class="seller-image">
                    <div class="seller-info">
                        <div class="seller-name">${seller.full_name}</div>
                        <div class="seller-details">
                            <span>${seller.city}</span>
                        </div>
                    </div>
                `;
                
                sellerCard.addEventListener('click', () => {
                    if (isSellerLocked && selectedSellerId !== seller.id) {
                        speakToUser("√ñnce sepetinizi bo≈üaltmalƒ±sƒ±nƒ±z farklƒ± bir satƒ±cƒ± se√ßmek i√ßin.");
                        return;
                    }
                    
                    document.querySelectorAll('.seller-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    
                    sellerCard.classList.add('selected');
                    selectedSellerId = seller.id;
                    document.getElementById('selectedSellerInfo').textContent = seller.full_name;
                    
                    // √úr√ºnler b√∂l√ºm√ºn√º g√∂ster
                    document.getElementById('productsSection').style.display = 'block';
                    
                    loadSellerProducts(seller.id);
                });
                
                sellerGrid.appendChild(sellerCard);
            });
        }

     // Satƒ±cƒ±nƒ±n √ºr√ºnlerini y√ºkle
        async function loadSellerProducts(sellerId) {
            try {
                console.log("√úr√ºnler y√ºkleniyor, sellerId:", sellerId);
                
                // product_prices ve products tablolarƒ±nƒ± join ederek √ºr√ºnleri getir
                const { data, error } = await supabase
                    .from('product_prices')
                    .select(`
                        *,
                        products (*)
                    `)
                    .eq('sube_id', sellerId);

                if (error) throw error;

                // Veriyi i≈üle
                products = data.map(item => ({
                    id: item.products.id,
                    product_price_id: item.id,
                    name: item.products.name,
                    description: item.products.description,
                    price: item.price,
                    discount_price: item.discount_price,
                    stock: item.stock,
                    imgurl: item.products.imgurl,
                    barcode: item.products.barcode,
                    category_id: item.products.category_id,
                    reyon_id: item.products.reyon_id,
                    seller_id: sellerId
                }));
                
                console.log("√úr√ºnler:", products);
                displayProducts(products);

            } catch (error) {
                console.error('√úr√ºn y√ºkleme hatasƒ±:', error);
                
                // Demo veriler
                products = [
                    { id: '1', name: "S√ºt 1L", price: 15.90, imgurl: "https://via.placeholder.com/150x100?text=S√ºt", discount_price: 12.90 },
                    { id: '2', name: "Ekmek", price: 5.50, imgurl: "https://via.placeholder.com/150x100?text=Ekmek" },
                    { id: '3', name: "Yumurta 10'lu", price: 32.00, imgurl: "https://via.placeholder.com/150x100?text=Yumurta" }
                ];
                displayProducts(products);
            }
        }

 // Reyon'a g√∂re √ºr√ºnleri filtrele
        function filterProductsByReyon(reyonId) {
            const filteredProducts = products.filter(p => p.reyon_id === reyonId);
            displayProducts(filteredProducts.length > 0 ? filteredProducts : products);
        }

        // Kategoriye g√∂re √ºr√ºnleri filtrele
        function filterProductsByCategory(categoryId) {
            const filteredProducts = products.filter(p => p.category_id === categoryId);
            displayProducts(filteredProducts.length > 0 ? filteredProducts : products);
        }

        // √úr√ºnleri g√∂ster
        function displayProducts(productsToShow) {
            const productsGrid = document.getElementById('productsGrid');
            productsGrid.innerHTML = '';
            
            if (productsToShow.length === 0) {
                productsGrid.innerHTML = `
                    <div class="text-center" style="grid-column: 1 / -1; padding: 40px; color: #6c757d;">
                        <i class="fas fa-box-open fa-3x mb-3"></i>
                        <p>Bu kategoride √ºr√ºn bulunamadƒ±</p>
                    </div>
                `;
                return;
            }
            
            productsToShow.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                
                let badgeHTML = '';
                if (product.discount_price && product.discount_price < product.price) {
                    badgeHTML = `<div class="product-badge">ƒ∞ndirim</div>`;
                }
                
                let priceHTML = `<div class="product-price">${money(product.price)}</div>`;
                if (product.discount_price && product.discount_price < product.price) {
                    priceHTML = `
                        <div>
                            <span class="product-price">${money(product.discount_price)}</span>
                            <span class="product-discount">${money(product.price)}</span>
                        </div>
                    `;
                }
                
                productCard.innerHTML = `
                    ${badgeHTML}
                    <img src="${product.imgurl || 'https://via.placeholder.com/150x100?text=√úr√ºn'}" alt="${product.name}" class="product-image">
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        ${priceHTML}
                        <button class="add-to-cart-btn" data-id="${product.id}" style="margin-top: 10px; width: 100%; padding: 8px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">Sepete Ekle</button>
                    </div>
                `;
                
                const addToCartBtn = productCard.querySelector('.add-to-cart-btn');
                addToCartBtn.addEventListener('click', function() {
                    addToCart(product, 1, productCard);
                });
                
                productsGrid.appendChild(productCard);
            });
        }

 // Sepete √ºr√ºn ekle
        function addToCart(product, quantity, productElement = null) {
            // Sepete √ºr√ºn ekle
            const existingItem = cart.find(item => item.id === product.id);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({
                    id: product.id,
                    product_price_id: product.product_price_id,
                    name: product.name,
                    price: product.discount_price || product.price,
                    quantity: quantity,
                    imgurl: product.imgurl,
                    seller_id: product.seller_id
                });
            }
            
            // Satƒ±cƒ± kilidini aktif et
            if (!isSellerLocked) {
                isSellerLocked = true;
                updateSellersGrid();
            }
            
            updateCartUI();
            
            // Animasyon efekti
            if (productElement) {
                productElement.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    productElement.style.transform = 'scale(1)';
                }, 200);
            }
            
            speakToUser(`${product.name} sepete eklendi.`);
        }

        function updateCartUI() {
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div class="text-center" style="padding: 30px; color: #6c757d;">
                        <i class="fas fa-shopping-cart fa-2x mb-3"></i>
                        <p>Sepetiniz bo≈ü</p>
                    </div>
                `;
                orderCount.textContent = "0";
                orderTotal.textContent = "0 ‚Ç∫";
                
                // Sepet bo≈üsa satƒ±cƒ± kilidini kaldƒ±r
                if (isSellerLocked) {
                    isSellerLocked = false;
                    updateSellersGrid();
                }
            } else {
                cart.forEach(item => {
                    const cartItem = document.createElement('div');
                    cartItem.className = 'cart-item';
                    cartItem.innerHTML = `
                        <div class="cart-item-info">
                            <img src="${item.imgurl || 'https://via.placeholder.com/40x40?text=√úr√ºn'}" alt="${item.name}" class="cart-item-image">
                            <div class="cart-item-details">
                                <div class="cart-item-name">${item.name}</div>
                                <div class="cart-item-price">${money(item.price)}</div>
                            </div>
                        </div>
                        <div class="cart-item-controls">
                            <button class="quantity-btn decrease" data-id="${item.id}">-</button>
                            <span>${item.quantity}</span>
                            <button class="quantity-btn increase" data-id="${item.id}">+</button>
                        </div>
                    `;
                    
                    cartItems.appendChild(cartItem);
                });
                
                orderCount.textContent = cart.reduce((total, item) => total + item.quantity, 0);
                
                // Miktar butonlarƒ±na event listener ekle
                document.querySelectorAll('.decrease').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const productId = this.dataset.id;
                        updateCartItemQuantity(productId, -1);
                    });
                });
                
                document.querySelectorAll('.increase').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const productId = this.dataset.id;
                        updateCartItemQuantity(productId, 1);
                    });
                });
            }
            
            // Toplamlarƒ± g√ºncelle
            const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
            const vat = subtotal * 0.18;
            const total = subtotal + vat;
            
            subtotalEl.textContent = money(subtotal);
            vatAmountEl.textContent = money(vat);
            totalAmountEl.textContent = money(total);
            orderTotal.textContent = money(total);
        }

        function updateCartItemQuantity(productId, change) {
            const item = cart.find(item => item.id === productId);
            if (item) {
                item.quantity += change;
                
                if (item.quantity <= 0) {
                    cart = cart.filter(item => item.id !== productId);
                }
                
                updateCartUI();
            }
        }

        async function finalizeOrder(paymentMethod) {
            if (cart.length === 0) {
                speakToUser("Sepetiniz bo≈ü. L√ºtfen √∂nce √ºr√ºn ekleyin.");
                return;
            }
            
            if (!selectedSellerId) {
                speakToUser("L√ºtfen √∂nce bir satƒ±cƒ± se√ßin.");
                return;
            }
            
            if (!currentCustomer) {
                speakToUser("L√ºtfen √∂nce giri≈ü yapƒ±n.");
                return;
            }
            
            if (!selectedLocation) {
                speakToUser("L√ºtfen teslimat adresinizi se√ßin.");
                showLocationModal();
                return;
            }
            
            const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
            const vat = subtotal * 0.18;
            const total = subtotal + vat;
            
            try {
                // Sipari≈üi veritabanƒ±na kaydet
                const { data: order, error: orderError } = await supabase
                    .from('orders')
                    .insert([{
                        customer_id: currentCustomer.id,
                        seller_id: selectedSellerId,
                        total_amount: total,
                        payment_method: paymentMethod,
                        status: 'pending',
                        location: selectedLocation
                    }])
                    .select()
                    .single();
                
                if (orderError) throw orderError;
                
                // Sipari≈ü detaylarƒ±nƒ± kaydet
                const orderDetails = cart.map(item => ({
                    order_id: order.id,
                    product_id: item.id,
                    quantity: item.quantity,
                    unit_price: item.price,
                    discount: 0, // ƒ∞ndirim hesaplamasƒ± yapƒ±labilir
                    tax_rate: 18
                }));
                
                const { error: detailsError } = await supabase
                    .from('order_details')
                    .insert(orderDetails);
                
                if (detailsError) throw detailsError;
                
                speakToUser(`Sipari≈üiniz alƒ±ndƒ±! Sipari≈ü numaranƒ±z: ${order.id}. Toplam tutar: ${money(total)}.`);
                
                // Sipari≈ü tamamlandƒ±ktan sonra sepeti temizle
                setTimeout(() => {
                    cart = [];
                    updateCartUI();
                    speakToUser("Yeni bir sipari≈ü vermek i√ßin satƒ±cƒ± se√ßebilirsiniz.");
                }, 3000);
                
            } catch (error) {
                console.error('Sipari≈ü kaydetme hatasƒ±:', error);
                speakToUser("Sipari≈üiniz alƒ±nƒ±rken bir hata olu≈ütu. L√ºtfen tekrar deneyin.");
            }
        }


function initVoiceAssistant() {
            microphoneToggle.addEventListener('click', toggleMicrophone);
            
            // Mikrofonu varsayƒ±lan olarak a√ß
            setTimeout(() => {
                enableMicrophone();
            }, 1000);
        }


        // Sayfa y√ºklendiƒüinde store type'larƒ± manuel tetikle
        setTimeout(() => {
            // ƒ∞lk store type'ƒ± se√ß (Market)
            const marketCard = document.querySelector('.seller-type-card[data-type-name="Market"]');
            if (marketCard) {
                marketCard.click();
            }
        }, 2000);

        function toggleMicrophone() {
            if (isMicrophoneEnabled) {
                disableMicrophone();
            } else {
                enableMicrophone();
            }
        }

        async function restoreSession() {
            const savedSession = localStorage.getItem('onurmarket_session');
            if (savedSession) {
                try {
                    const sessionData = JSON.parse(savedSession);
                    
                    // Oturumun s√ºresi dolmu≈ü mu kontrol et (24 saat)
                    const now = new Date().getTime();
                    if (now - sessionData.timestamp < 24 * 60 * 60 * 1000) {
                        currentCustomer = sessionData.customer;
                        cart = sessionData.cart || [];
                        selectedSellerId = sessionData.selectedSellerId;
                        selectedLocation = sessionData.selectedLocation;
                        
                        updateCustomerUI();
                        updateCartUI();
                        
                        if (currentCustomer) {
                            hideHowItWorksBanner();
                            orderSummary.style.display = 'flex';
                            
                            if (selectedLocation) {
                                locationText.textContent = selectedLocation;
                            } else {
                                showLocationModal();
                            }
                            
                            // Store type'larƒ± y√ºklendikten sonra se√ßili satƒ±cƒ±yƒ± y√ºkle
                            setTimeout(() => {
                                if (selectedSellerId) {
                                    loadSellerProducts(selectedSellerId);
                                }
                            }, 1000);
                        }
                    } else {
                        localStorage.removeItem('onurmarket_session');
                    }
                } catch (error) {
                    console.error('Oturum geri y√ºkleme hatasƒ±:', error);
                    localStorage.removeItem('onurmarket_session');
                }
            }
        }

        function saveSession() {
            if (currentCustomer) {
                const sessionData = {
                    customer: currentCustomer,
                    cart: cart,
                    selectedSellerId: selectedSellerId,
                    selectedLocation: selectedLocation,
                    timestamp: new Date().getTime()
                };
                localStorage.setItem('onurmarket_session', JSON.stringify(sessionData));
            }
        }

        async function checkCustomerByPhone(phone) {
            try {
                const cleanPhone = phone.replace(/\D/g, '');
                
                const { data, error } = await supabase
                    .from('customers')
                    .select('*')
                    .eq('phone', cleanPhone)
                    .maybeSingle();
                
                if (error) throw error;
                
                if (data) {
                    currentCustomer = data;
                    updateCustomerUI();
                    hideHowItWorksBanner();
                    orderSummary.style.display = 'flex';
                    showLocationModal();
                    
                    speakToUser(`Ho≈ü geldiniz ${data.name}! Sisteminiz a√ßƒ±lmƒ±≈ütƒ±r, sipari≈ü i≈üleminize ba≈ülayabilirsiniz.`);
                    conversationStep = 10;
                    
                    saveSession();
                } else {
                    speakToUser("Telefon numaranƒ±z kayƒ±tlƒ± deƒüil. Yeni √ºyelik olu≈üturalƒ±m. L√ºtfen adƒ±nƒ±zƒ± ve soyadƒ±nƒ±zƒ± s√∂yler misiniz?");
                    conversationStep = 2;
                    
                    // Ge√ßici m√º≈üteri olu≈ütur
                    currentCustomer = {
                        phone: cleanPhone,
                        role: 'customer',
                        bonus_amount: 0
                    };
                }
                
            } catch (error) {
                console.error('M√º≈üteri kontrol hatasƒ±:', error);
                speakToUser("Telefon numaranƒ±z kayƒ±tlƒ± deƒüil. Yeni √ºyelik olu≈üturalƒ±m. L√ºtfen adƒ±nƒ±zƒ± ve soyadƒ±nƒ±zƒ± s√∂yler misiniz?");
                conversationStep = 2;
            }
        }

        async function createCustomerProfile() {
            try {
                const name = document.getElementById('p_name').textContent;
                const phone = document.getElementById('p_phone').textContent;
                const city = document.getElementById('p_city').textContent;
                const address = document.getElementById('p_address').textContent;
                
                const { data, error } = await supabase
                    .from('customers')
                    .insert([{
                        name: name,
                        phone: phone,
                        city: city,
                        address: address,
                        role: 'customer',
                        bonus_amount: 0
                    }])
                    .select()
                    .single();
                
                if (error) throw error;
                
                currentCustomer = data;
                updateCustomerUI();
                hideHowItWorksBanner();
                orderSummary.style.display = 'flex';
                showLocationModal();
                
                speakToUser(`Profiliniz olu≈üturuldu! Ho≈ü geldiniz ${name}.`);
                conversationStep = 10;
                
                saveSession();
                
            } catch (error) {
                console.error('Profil olu≈üturma hatasƒ±:', error);
                speakToUser("Profil olu≈üturulurken bir hata olu≈ütu. L√ºtfen daha sonra tekrar deneyin.");
            }
        }

        function updateCustomerUI() {
            if (currentCustomer) {
                userName.textContent = currentCustomer.name || 'Profilim';
                profileName.textContent = currentCustomer.name || '-';
                profilePhone.textContent = currentCustomer.phone || '-';
                profileCity.textContent = currentCustomer.city || '-';
                profileAddress.textContent = currentCustomer.address || '-';
                profileBonus.textContent = money(currentCustomer.bonus_amount || 0);
                profileAvatar.textContent = (currentCustomer.name || 'P').charAt(0).toUpperCase();
                
                if (currentCustomer.address) {
                    locationText.textContent = currentCustomer.address;
                    selectedLocation = currentCustomer.address;
                }
            }
        }

// √áƒ±kƒ±≈ü butonunu kontrol et (geli≈ütirilmi≈ü)
function setupLogoutButton() {
    const logoutBtn = document.getElementById('logoutButton');
    const userProfile = document.getElementById('userProfile');
    
    debugLog('√áƒ±kƒ±≈ü butonu ayarlanƒ±yor...', {
        logoutBtnExists: !!logoutBtn,
        userProfileExists: !!userProfile,
        currentCustomer: !!currentCustomer
    });
    
    // Eƒüer logoutBtn yoksa ve currentCustomer varsa, fallback buton olu≈ütur
    if (!logoutBtn && currentCustomer) {
        createFallbackLogoutButton();
        return;
    }
    
    if (logoutBtn) {
        // Event listener'ƒ± temizle ve yeniden ekle
        logoutBtn.onclick = null;
        logoutBtn.addEventListener('click', handleLogout);
        
        // G√∂r√ºn√ºrl√ºƒü√º ayarla
        if (currentCustomer) {
            logoutBtn.style.display = 'block';
            if (userProfile) userProfile.style.display = 'block';
            debugLog('√áƒ±kƒ±≈ü butonu g√∂r√ºn√ºr yapƒ±ldƒ±');
        } else {
            logoutBtn.style.display = 'none';
            if (userProfile) userProfile.style.display = 'block';
            debugLog('√áƒ±kƒ±≈ü butonu gizlendi');
        }
    }
}
// Fallback √ßƒ±kƒ±≈ü butonu olu≈ütur
function createFallbackLogoutButton() {
    // Eƒüer fallback buton zaten varsa, i≈ülem yapma
    if (document.getElementById('fallbackLogoutButton')) {
        return;
    }
    
    const logoutBtn = document.createElement('button');
    logoutBtn.id = 'fallbackLogoutButton';
    logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> √áƒ±kƒ±≈ü Yap';
    logoutBtn.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1000;
        padding: 8px 16px;
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    `;
    
    document.body.appendChild(logoutBtn);
    logoutBtn.addEventListener('click', handleLogout);
    debugLog('Fallback √ßƒ±kƒ±≈ü butonu olu≈üturuldu');
}
// √áƒ±kƒ±≈ü i≈ülemini y√∂net
function handleLogout(e) {
    e.preventDefault();
    e.stopPropagation();
    debugLog('√áƒ±kƒ±≈ü butonuna tƒ±klandƒ±');
    logout();
}

// Fallback √ßƒ±kƒ±≈ü butonu olu≈ütur
function createFallbackLogoutButton() {
    let logoutBtn = document.getElementById('logoutButton');
    
    if (!logoutBtn) {
        logoutBtn = document.createElement('button');
        logoutBtn.id = 'logoutButton';
        logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> √áƒ±kƒ±≈ü Yap';
        logoutBtn.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            padding: 8px 16px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        `;
        
        document.body.appendChild(logoutBtn);
        debugLog('Fallback √ßƒ±kƒ±≈ü butonu olu≈üturuldu');
    }
    
    logoutBtn.addEventListener('click', handleLogout);
}

// √áƒ±kƒ±≈ü i≈ülemini y√∂net
function handleLogout(e) {
    e.preventDefault();
    e.stopPropagation();
    debugLog('√áƒ±kƒ±≈ü butonuna tƒ±klandƒ±');
    logout();
}

		
// √áƒ±kƒ±≈ü yap fonksiyonu
function logout() {
    try {
        // Mevcut m√º≈üteriyi temizle
        currentCustomer = null;
        
        // LocalStorage'dan t√ºm kullanƒ±cƒ± verilerini temizle
        localStorage.removeItem('currentCustomer');
        localStorage.removeItem('userToken');
        localStorage.removeItem('session');
        localStorage.removeItem('selectedLocation');
        localStorage.removeItem('referral_code');
        localStorage.removeItem('referral_group_code');
        
        // SessionStorage'ƒ± da temizle
        sessionStorage.clear();
        
        // Supabase oturumunu sonlandƒ±r
        if (supabase) {
            supabase.auth.signOut();
        }
        
        console.log('√áƒ±kƒ±≈ü yapƒ±ldƒ±, t√ºm veriler temizlendi.');
		
		
        // Sayfayƒ± yenile veya giri≈ü sayfasƒ±na y√∂nlendir
        setTimeout(() => {
            window.location.href = window.location.pathname; // Aynƒ± sayfaya y√∂nlendir
        }, 500);
			
    } catch (error) {
        console.error('√áƒ±kƒ±≈ü yapƒ±lƒ±rken hata olu≈ütu:', error);
    }
}
	
        function generateReferralLink() {
            if (!currentCustomer) {
                alert('√ñnce giri≈ü yapmalƒ±sƒ±nƒ±z');
                return;
            }
            
            // Referans linki olu≈ütur
            const baseUrl = window.location.origin + window.location.pathname;
            const referralUrl = `${baseUrl}?referral_code=${currentCustomer.id}&referral_groups=default`;
            
            // Kopyala butonu g√∂ster
            if (navigator.clipboard) {
                navigator.clipboard.writeText(referralUrl).then(() => {
                    alert('Referans linki panoya kopyalandƒ±: ' + referralUrl);
                });
            } else {
                alert('Referans linkiniz: ' + referralUrl);
            }
        }

        function shareOnWhatsApp() {
            if (!currentCustomer) {
                alert('√ñnce giri≈ü yapmalƒ±sƒ±nƒ±z');
                return;
            }
            
            if (cart.length === 0) {
                alert('Sepetiniz bo≈ü');
                return;
            }
            
            const orderSummary = cart.map(item => 
                `${item.name} - ${item.quantity} adet x ${money(item.price)}`
            ).join('%0A');
            
            const total = cart.reduce((total, item) => total + (item.price * item.quantity), 0) * 1.18;
            
            const message = `Merhaba! Sesli Sipari≈ü sisteminden sipari≈ü vermek istiyorum:%0A%0A${orderSummary}%0A%0AToplam: ${money(total)}%0ATeslimat adresi: ${selectedLocation || currentCustomer.address}`;
            
            const whatsappUrl = `https://wa.me/?text=${message}`;
            
            window.open(whatsappUrl, '_blank');
        }

        async function processReferralCode(code, groupCode) {
            try {
                if (!currentCustomer) return;
                
                // Referans kodunu i≈üle
                const { error } = await supabase
                    .from('referral_tracking')
                    .insert([{
                        referral_code: code,
                        group_code: groupCode,
                        referrer_user_id: code, // Bu kodu g√∂nderen kullanƒ±cƒ± ID'si
                        new_user_id: currentCustomer.id
                    }]);
                
                if (error) throw error;
                
                // Bonus ekle
                const { error: bonusError } = await supabase
                    .from('referral_bonus')
                    .insert([{
                        referral_tracking_id: code, // Bu √∂rnek i√ßin basit tutuyoruz
                        bonus_amount: 10.00 // Varsayƒ±lan bonus miktarƒ±
                    }]);
                
                if (bonusError) throw bonusError;
                
                speakToUser("Referans kodunuz i≈ülendi. Hesabƒ±nƒ±za 10 TL bonus eklendi.");
                
            } catch (error) {
                console.error('Referans kodu i≈üleme hatasƒ±:', error);
            }
        }

        // Sesli asistan fonksiyonlarƒ± aynƒ± kalacak, sadece gerekli yerlerde deƒüi≈üiklik yapƒ±ldƒ±
        // ... (Sesli asistan kodlarƒ± buraya gelecek)


         // Mikrofonu etkinle≈ütir
        async function enableMicrophone() {
            try {
                // Tarayƒ±cƒ± desteƒüini kontrol et
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error("Mikrofon eri≈üimi desteklenmiyor");
                }

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                isMicrophoneEnabled = true;
                microphoneToggle.innerHTML = '<i class="fas fa-microphone"></i> <span>Mikrofon (A√ßƒ±k)</span>';
                microphoneToggle.classList.add('listening');
                
                // Ses tanƒ±mayƒ± ba≈ülat
                initializeSpeechRecognition();
                
                assistantMessage.textContent = "Mikrofon a√ßƒ±ldƒ±. Konu≈ümaya ba≈ülayabilirsiniz.";
                
                // Stream'i kapat (sadece izin i√ßin kullanƒ±yoruz)
                stream.getTracks().forEach(track => track.stop());
                
            } catch (error) {
                console.error("Mikrofon eri≈üim hatasƒ±:", error);
                let errorMessage = "Mikrofon eri≈üimi saƒülanamadƒ±. ";
                
                if (error.name === "NotAllowedError") {
                    errorMessage += "L√ºtfen tarayƒ±cƒ± ayarlarƒ±nƒ±zdan mikrofon eri≈üimine izin verin.";
                } else if (error.name === "NotFoundError") {
                    errorMessage += "Mikrofon cihazƒ± bulunamadƒ±.";
                } else {
                    errorMessage += "Beklenmeyen bir hata olu≈ütu: " + error.message;
                }
                
                assistantMessage.textContent = errorMessage;
                disableMicrophone();
            }
        }
		
       // Mikrofonu devre dƒ±≈üƒ± bƒ±rak
        function disableMicrophone() {
            isMicrophoneEnabled = false;
            microphoneToggle.innerHTML = '<i class="fas fa-microphone-slash"></i> <span>Mikrofon (Kapalƒ±)</span>';
            microphoneToggle.classList.remove('listening');
            
            if (recognition) {
                recognition.stop();
            }
            
            voiceIndicator.classList.remove('listening');
            assistantMessage.textContent = "Mikrofon kapalƒ±. Sesli sipari≈ü i√ßin l√ºtfen mikrofonu a√ßƒ±n.";
        }

        // Mikrofonu a√ß/kapa
        function toggleMicrophone() {
            if (isMicrophoneEnabled) {
                disableMicrophone();
            } else {
                enableMicrophone();
            }
        }

        // Ses tanƒ±mayƒ± ba≈ülat
        function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                assistantMessage.textContent = "Tarayƒ±cƒ±nƒ±z ses tanƒ±ma √∂zelliƒüini desteklemiyor";
                disableMicrophone();
                return;
            }
            
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.lang = 'tr-TR';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            
            recognition.onstart = function() {
                isListening = true;
                voiceIndicator.classList.add('listening');
                assistantMessage.textContent = "Dinliyorum... Konu≈ümaya ba≈ülayƒ±n.";
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[event.results.length - 1][0].transcript;
                userMessage.textContent = transcript;
                processVoiceCommand(transcript);
            };
            
            recognition.onerror = function(event) {
                console.error('Ses tanƒ±ma hatasƒ±:', event.error);
                
                // "no-speech" hatasƒ±nƒ± normal kar≈üƒ±la
                if (event.error === 'no-speech') {
                    console.log('Ses algƒ±lanmadƒ±');
                    return;
                } 
                
                if (event.error === 'not-allowed') {
                    assistantMessage.textContent = "Mikrofon eri≈üimine izin verilmedi. L√ºtfen tarayƒ±cƒ± ayarlarƒ±nƒ±zdan izin verin.";
                    disableMicrophone();
                } else {
                    assistantMessage.textContent = "Ses tanƒ±ma hatasƒ±: " + event.error;
                }
                
                isListening = false;
                voiceIndicator.classList.remove('listening');
            };
            
            recognition.onend = function() {
                isListening = false;
                voiceIndicator.classList.remove('listening');
                
                // Mikrofon hala a√ßƒ±ksa yeniden ba≈ülat
                if (isMicrophoneEnabled && !isListening) {
                    setTimeout(() => {
                        try {
                            recognition.start();
                        } catch (error) {
                            console.log('Ses tanƒ±ma yeniden ba≈ülatƒ±lamadƒ±:', error);
                        }
                    }, 500);
                }
            };
            
            // Ses tanƒ±mayƒ± ba≈ülat
            try {
                recognition.start();
            } catch (error) {
                console.error('Ses tanƒ±ma ba≈ülatƒ±lamadƒ±:', error);
                assistantMessage.textContent = "Ses tanƒ±ma ba≈ülatƒ±lamadƒ±. L√ºtfen sayfayƒ± yenileyin.";
                disableMicrophone();
            }
        }

        // Sesli komutlarƒ± i≈üle
        function processVoiceCommand(transcript) {
            const message = transcript.toLowerCase();
            userMessage.textContent = transcript;

  	// Store type se√ßimi
            if (message.includes('market')) {
                selectStoreTypeByName('Market');
                speakToUser("Market se√ßildi. Size en yakƒ±n marketler listeleniyor.");
            } else if (message.includes('restoran') || message.includes('lokanta')) {
                selectStoreTypeByName('Restoran');
                speakToUser("Restoran se√ßildi. Size en yakƒ±n restoranlar listeleniyor.");
            } else if (message.includes('eczane')) {
                selectStoreTypeByName('Eczane');
                speakToUser("Eczane se√ßildi. Size en yakƒ±n eczaneler listeleniyor.");
            } else if (message.includes('fƒ±rƒ±n')) {
                selectStoreTypeByName('Fƒ±rƒ±n');
                speakToUser("Fƒ±rƒ±n se√ßildi. Size en yakƒ±n fƒ±rƒ±nlar listeleniyor.");
            }
            
            // Giri≈ü s√ºreci
            if (conversationStep === 0) {
                if (message.includes('evet') || message.includes('isterim') || message.includes('tabi') || message.includes('olur')) {
                    speakToUser("Harika! Telefon numaranƒ±zƒ± s√∂yler misiniz?");
                    conversationStep = 1;
                } else if (message.includes('hayƒ±r') || message.includes('istemiyorum')) {
                    speakToUser("Peki, giri≈ü yapmak istediƒüiniz zaman bana 'Evet' deyin.");
                } else {
                    speakToUser("Giri≈ü yapmak istiyor musunuz? L√ºtfen 'Evet' veya 'Hayƒ±r' diyerek yanƒ±t verin.");
                }
                return;
            }
            
            if (conversationStep === 1) {
                const phoneMatch = message.match(/\d+/g);
                if (phoneMatch) {
                    const phone = phoneMatch.join('');
                    checkCustomerByPhone(phone);
                } else {
                    speakToUser("Telefon numaranƒ±zƒ± anlayamadƒ±m. L√ºtfen numaranƒ±zƒ± s√∂yler misiniz?");
                }
                return;
            }
            
            // Satƒ±cƒ± tipi se√ßimi
            if (message.includes('market')) {
                selectSellerTypeByName('Market');
                speakToUser("Market se√ßildi. Size en yakƒ±n marketler listeleniyor.");
            } else if (message.includes('restoran') || message.includes('lokanta')) {
                selectSellerTypeByName('Restoran');
                speakToUser("Restoran se√ßildi. Size en yakƒ±n restoranlar listeleniyor.");
            } else if (message.includes('eczane')) {
                selectSellerTypeByName('Eczane');
                speakToUser("Eczane se√ßildi. Size en yakƒ±n eczaneler listeleniyor.");
            } else if (message.includes('fƒ±rƒ±n')) {
                selectSellerTypeByName('Fƒ±rƒ±n');
                speakToUser("Fƒ±rƒ±n se√ßildi. Size en yakƒ±n fƒ±rƒ±nlar listeleniyor.");
            }
            
            // √úr√ºn ekleme
            else if (message.includes('ekle') || message.includes('sepete')) {
                const productMatch = message.match(/(\d+)?\s*(kilo|gram|litre|adet|tane|paket)?\s*([a-z√ßƒüƒ±√∂≈ü√º\s]+)/i);
                
                if (productMatch) {
                    const quantity = productMatch[1] ? parseInt(productMatch[1]) : 1;
                    const productName = productMatch[3].trim();
                    
                    const product = products.find(p => 
                        p.name.toLowerCase().includes(productName.toLowerCase())
                    );
                    
                    if (product) {
                        addToCart(product, quantity);
                    } else {
                        speakToUser("√úzg√ºn√ºm, istediƒüiniz √ºr√ºn√º bulamadƒ±m. L√ºtfen ba≈üka bir √ºr√ºn s√∂yleyin.");
                    }
                }
            }
            
            // Sepeti onaylama
            else if (message.includes('sepeti onayla') || message.includes('sipari≈üi ver')) {
                if (cart.length === 0) {
                    speakToUser("Sepetiniz bo≈ü. L√ºtfen √∂nce √ºr√ºn ekleyin.");
                    return;
                }
                
                if (!selectedSellerId) {
                    speakToUser("L√ºtfen √∂nce bir satƒ±cƒ± se√ßin.");
                    return;
                }
                
                speakToUser(`Sepetinizde ${cart.length} √ºr√ºn bulunuyor. Toplam tutar ${totalAmountEl.textContent}. Nasƒ±l √∂demek istersiniz? Nakit, kart veya bonus?`);
            }
            
            // √ñdeme se√ßenekleri
            else if (message.includes('nakit')) {
                selectPaymentMethod('nakit');
                speakToUser("Nakit √∂deme se√ßildi. Sipari≈üinizi onaylƒ±yor musunuz?");
            } else if (message.includes('kart') || message.includes('kredi kartƒ±')) {
                selectPaymentMethod('kart');
                speakToUser("Kart ile √∂deme se√ßildi. Sipari≈üinizi onaylƒ±yor musunuz?");
            } else if (message.includes('bonus')) {
                selectPaymentMethod('bonus');
                speakToUser("Bonus ile √∂deme se√ßildi. Sipari≈üinizi onaylƒ±yor musunuz?");
            }
            
            // Sipari≈ü onayƒ±
            else if (message.includes('evet') || message.includes('onaylƒ±yorum') || message.includes('tamam')) {
                if (!currentPaymentMethod) {
                    speakToUser("√ñnce bir √∂deme y√∂ntemi se√ßmelisiniz.");
                    return;
                }
                
                finalizeOrder(currentPaymentMethod);
            }
            
            // Diƒüer komutlar
            else {
                speakToUser("√úzg√ºn√ºm, anlayamadƒ±m. L√ºtfen tekrar s√∂yler misiniz?");
            }
        }

	// Kullanƒ±cƒ±ya sesli yanƒ±t ver
        function speakToUser(message) {
            assistantMessage.textContent = message;
            
            if ('speechSynthesis' in window) {
                const speech = new SpeechSynthesisUtterance(message);
                speech.lang = 'tr-TR';
                speech.volume = 1;
                speech.rate = 1;
                speech.pitch = 1;
                
                window.speechSynthesis.speak(speech);
            }
        }

 // Satƒ±cƒ± tipini isme g√∂re se√ß
        function selectSellerTypeByName(typeName) {
            const typeCard = Array.from(document.querySelectorAll('.seller-type-card')).find(card => 
                card.dataset.typeName === typeName
            );
            
            if (typeCard) {
                typeCard.click();
            }
        }
		
        async function checkReferralAndProcess() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        let referralCode = urlParams.get('referral_code');
        let referralGroupCode = urlParams.get('referral_groups');
        
        console.log('URL parametreleri:', { referralCode, referralGroupCode });
        
        // Kullanƒ±cƒ± giri≈ü yapmamƒ±≈üsa ve URL'de referans kodu yoksa
        if (!isUserLoggedIn() && !referralCode) {
            console.log('Otomatik referans kodu olu≈üturuluyor...');
            referralGroupCode = "07KR5DSD"; // Varsayƒ±lan grup kodu
            referralCode = generateReferralCode(); // Yeni referans kodu olu≈ütur
        }

        if (referralCode && referralGroupCode) {
            console.log('Referans kodu i≈üleme ba≈ülƒ±yor:', referralCode, referralGroupCode);
            await processReferralCode(referralCode, referralGroupCode);
        } else {
            console.log('Referans kodu veya grup kodu bulunamadƒ±');
        }
    } catch (error) {
        console.error('Referans kontrol√º sƒ±rasƒ±nda hata:', error);
    }
}

// Rastgele referans kodu olu≈üturma (sync versiyonu)
function generateReferralCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < 8; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

// Kullanƒ±cƒ± giri≈ü kontrol√º
function isUserLoggedIn() {
    return currentCustomer !== null && currentCustomer !== undefined;
}

 // √ñdeme y√∂ntemini se√ß
        function selectPaymentMethod(method) {
            currentPaymentMethod = method;
            // √ñdeme butonlarƒ±nƒ± g√ºncelle
            document.querySelectorAll('.payment-btn').forEach(btn => {
                btn.style.opacity = '0.7';
            });
            
            const selectedBtn = document.getElementById(`pay${method.charAt(0).toUpperCase() + method.slice(1)}`);
            if (selectedBtn) {
                selectedBtn.style.opacity = '1';
            }
        }
        // Sayfa kapanmadan √∂nce oturumu kaydet
        window.addEventListener('beforeunload', saveSession);
// Fallback mekanizmasƒ± - kritik fonksiyonlar √ßalƒ±≈ümazsa
function initializeFallbacks() {
    // Store types y√ºklenmezse fallback data
    if (!storeTypes || storeTypes.length === 0) {
        storeTypes = [
            { id: 1, name: 'Restoran', code: 'restaurant' },
            { id: 2, name: 'Kafe', code: 'cafe' },
            { id: 3, name: 'Market', code: 'market' }
        ];
        debugLog('Fallback store type lar kullanƒ±lƒ±yor');
    }
    
    // Vendors y√ºklenmezse
    if (!vendors || vendors.length === 0) {
        debugLog('Satƒ±cƒ±lar y√ºklenemedi, fallback modu');
        // Burada statik vendor listesi kullanabilirsiniz
    }
}

// Hata raporlama
window.addEventListener('error', function(e) {
    debugLog('Global hata yakalandƒ±:', {
        message: e.message,
        file: e.filename,
        line: e.lineno,
        col: e.colno
    });
});
		
    </script>
</body>
</html>
