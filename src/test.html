<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sesli Sipari≈ü - Dinamik Sistem</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
       :root {
            --primary: #5d3ebc;
            --primary-light: #7849f7;
            --secondary: #ffd300;
            --accent: #ff6b00;
            --dark: #1a1a1a;
            --light: #f8f9fa;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --success: #28a745;
            --danger: #dc3545;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            line-height: 1.6;
        }
        
        /* Header Styles */
        header {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 22px;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .logo-icon::after {
            content: "";
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--secondary);
            border-radius: 50%;
            bottom: 5px;
            right: 5px;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .action-btn {
            background: none;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: var(--transition);
            color: var(--dark);
            font-weight: 500;
            font-size: 14px;
        }
        
        .action-btn:hover {
            background: var(--gray-light);
        }
        
        .order-summary {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--primary);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .order-summary:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }
        
        .order-count {
            background: var(--secondary);
            color: var(--dark);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }


.store-type-number {
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--primary);
    color: var(--secondary);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    border: 2px solid var(--secondary);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}


.product-number {
    position: absolute;
    top: 10px;
    left: 10px;
    background: var(--primary);
    color: var(--secondary);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    border: 2px solid var(--secondary);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 2;
}
        
        .language-selector {
            position: relative;
        }
        
        .language-btn {
            background: none;
            border: none;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 10px 0;
            width: 200px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 10;
        }
        
        .language-dropdown.show {
            display: block;
        }
        
        .language-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .language-option:hover {
            background: var(--gray-light);
        }
        
        .language-option.active {
            background: var(--primary);
            color: white;
        }
        
        /* Banner Styles */
        .banner {
            position: relative;
            height: 300px;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 0 20px;
        }
        
        .banner-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.2;
        }
        
        .banner-content {
            position: relative;
            z-index: 2;
            max-width: 600px;
        }
        
        .banner h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            font-weight: 700;
        }
        
        .banner p {
            font-size: 1.1rem;
            margin-bottom: 20px;
            opacity: 0.9;
        }
        
        /* Main Content */
        .main-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            flex: 1;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: var(--primary);
        }
        
        /* Horizontal Scroll Containers */
        .scroll-container {
            position: relative;
            margin-bottom: 30px;
        }
        
        .scroll-content {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
            scroll-behavior: smooth;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scroll-content::-webkit-scrollbar {
            display: none;
        }
        
        .scroll-btn {
            position: absolute;
            top: 70%;
            transform: translateY(-50%);
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            z-index: 10;
            transition: var(--transition);
        }
        
        .scroll-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .scroll-btn.left {
            left: -50px;
        }
        
        .scroll-btn.right {
            right: -50px;
        }
        
        /* Store Type Cards (Horizontal) */
        .seller-type-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            min-width: 150px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            position: relative; /* Numarayƒ± konumlandƒ±rmak i√ßin */
        }
        
        .seller-type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .seller-type-card.selected {
            border-color: var(--primary);
            background: rgba(93, 62, 188, 0.05);
        }
        
        .seller-type-icon {
            font-size: 32px;
            color: var(--primary);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(93, 62, 188, 0.1);
        }
        
        .seller-type-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        /* Seller Cards (Horizontal) */
        .seller-card {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            min-width: 280px;
            flex-shrink: 0
            position: relative; /* Numarayƒ± konumlandƒ±rmak i√ßin */
        }
        
    .seller-number {
    position: absolute;
    top: 10px;
    left: 10px; /* Saƒü yerine SOL tarafa al */
    background: var(--primary);
    color: var(--secondary);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    border: 2px solid var(--secondary);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 2;
}
        
        .seller-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .seller-card.selected {
            border-color: var(--success);
        }
        
        .seller-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
        }
        
        .seller-info {
            padding: 15px;
        }
        
        .seller-name {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 18px;
        }
        
        .seller-details {
            font-size: 14px;
            color: var(--gray);
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .seller-rating {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--secondary);
        }
        
        .delivery-info {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--gray-light);
        }
        
        .delivery-fee {
            font-size: 14px;
            color: var(--primary);
            font-weight: 600;
        }
        
        .delivery-fee.free {
            color: var(--success);
        }
        
        .min-order {
            font-size: 12px;
            color: var(--gray);
            margin-top: 2px;
        }
        
        /* Category Cards (Horizontal) */
        .category-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            min-width: 150px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            position: relative; /* Numarayƒ± konumlandƒ±rmak i√ßin */
        }
        .category-number {
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--primary);
    color: var(--secondary);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    border: 2px solid var(--secondary);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 2;
}
        
        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .category-card.selected {
            border-color: var(--success);
            background: rgba(40, 167, 69, 0.05);
        }
        
        .category-icon {
            font-size: 32px;
            color: var(--success);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(40, 167, 69, 0.1);
        }
        
        .category-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        /* Product Cards (Horizontal) */
        .products-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }
        
        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .product-card {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-light);
            min-width: 200px;
            flex-shrink: 0;
        }
        
        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .product-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .product-image {
            width: 100%;
            height: 140px;
            object-fit: cover;
        }
        
        .product-info {
            padding: 15px;
        }
        
        .product-name {
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
            height: 40px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .product-price {
            font-weight: 600;
            color: var(--primary);
            font-size: 16px;
        }
        
        .product-discount {
            color: var(--danger);
            font-size: 12px;
            text-decoration: line-through;
            margin-left: 5px;
        }
        
        .add-to-cart-btn {
            margin-top: 10px;
            width: 100%;
            padding: 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .add-to-cart-btn:hover {
            background: var(--primary-light);
        }
        
        /* Cart Section */
        .cart-container {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background: white;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .cart-container.open {
            right: 0;
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .cart-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray);
        }
        
        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .cart-item-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .cart-item-image {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .cart-item-details {
            font-size: 14px;
        }
        
        .cart-item-name {
            font-weight: 500;
        }
        
        .cart-item-price {
            color: var(--gray);
            font-size: 12px;
        }
        
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid var(--gray-light);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .quantity-btn:hover {
            background: var(--gray-light);
        }
        
        .cart-totals {
            border-top: 1px solid var(--gray-light);
            padding: 20px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .total-final {
            font-weight: 600;
            font-size: 18px;
            border-top: 1px solid var(--gray-light);
            padding-top: 10px;
        }
        
        .payment-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
            padding: 0 20px 20px;
        }
        
        .payment-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .payment-btn.cash {
            background: var(--success);
            color: white;
        }
        
        .payment-btn.card {
            background: var(--primary);
            color: white;
        }
        
        .payment-btn.bonus {
            background: var(--accent);
            color: white;
            grid-column: 1 / -1;
        }
        
        .payment-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        /* Footer */
        footer {
            background: var(--dark);
            color: white;
            padding: 40px 0 20px;
            margin-top: auto;
        }
        
        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
        }
        
        .footer-section h3 {
            margin-bottom: 20px;
            font-size: 18px;
            color: var(--secondary);
        }
        
        .footer-links {
            list-style: none;
        }
        
        .footer-links li {
            margin-bottom: 10px;
        }
        
        .footer-links a {
            color: #ccc;
            text-decoration: none;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .footer-links a:hover {
            color: white;
        }
        
        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .social-link {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            transition: var(--transition);
        }
        
        .social-link:hover {
            background: var(--primary);
            transform: translateY(-3px);
        }
        
        .partner-login {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .partner-login:hover {
            background: var(--primary-light);
        }
        
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            margin-top: 20px;
            border-top: 1px solid #444;
            font-size: 14px;
            color: #aaa;
        }
        
        /* Voice Assistant */
        .voice-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 300px;
            z-index: 100;
            display: block;
        }
        
        .status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .status-title {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: var(--dark);
        }
        
        .status-title i {
            margin-right: 8px;
            color: var(--accent);
        }
        
        .status-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--gray);
        }
        
        .status-content {
            margin-bottom: 15px;
        }
        
/* Display mesaj stilleri */
.assistant-message {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    font-size: 14px;
    line-height: 1.4;
    transition: all 0.3s ease;
    border-left: 4px solid var(--primary);
    background: rgba(93, 62, 188, 0.1);
    color: var(--dark);
}
        
 .assistant-message.success {
    background: rgba(40, 167, 69, 0.1);
    color: var(--success);
    border-left-color: var(--success);
}   

        .assistant-message.error {
    background: rgba(220, 53, 69, 0.1);
    color: var(--danger);
    border-left-color: var(--danger);
}
        .user-message {
            padding: 12px;
            background: rgba(255, 107, 0, 0.1);
            border-radius: 8px;
            text-align: right;
            color: var(--accent);
        }
        
        .voice-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 30px;
            margin-top: 10px;
        }
        
        .voice-bar {
            width: 6px;
            height: 10px;
            background: #ddd;
            margin: 0 3px;
            border-radius: 3px;
        }
        
        .listening .voice-bar {
            animation: voiceIndicator 0.8s infinite;
        }
        
        @keyframes voiceIndicator {
            0%, 100% { height: 10px; background: #ddd; }
            50% { height: 30px; background: var(--accent); }
        }
        
        /* Location Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 100%;
            box-shadow: var(--shadow);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .close-modal {
            cursor: pointer;
            font-size: 24px;
            color: var(--gray);
        }
        
        .location-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .location-option {
            padding: 20px;
            border: 2px solid var(--gray-light);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .location-option:hover {
            border-color: var(--primary);
            background: rgba(93, 62, 188, 0.05);
        }
        
        .location-option.selected {
            border-color: var(--primary);
            background: rgba(93, 62, 188, 0.1);
        }
        
        .location-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .location-details h4 {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .location-details p {
            color: var(--gray);
            font-size: 14px;
        }
        
        .location-detect-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 20px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: var(--transition);
        }
        
        .location-detect-btn:hover {
            background: var(--primary-light);
        }
        
        .location-detect-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }
        
        .location-result {
            border-left: 4px solid var(--primary);
            padding: 15px;
            background: rgba(93, 62, 188, 0.05);
            border-radius: 8px;
            margin-top: 15px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .logo {
                font-size: 20px;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .banner {
                height: 250px;
            }
            
            .banner h1 {
                font-size: 2rem;
            }
            
            .banner p {
                font-size: 1rem;
            }
            
            .scroll-btn {
                display: none;
            }
            
            .cart-container {
                width: 100%;
                right: -100%;
            }
            
            .voice-status {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
            }
            
            .footer-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        
        /* Animation for logo */
        @keyframes logoPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .logo-icon {
            animation: logoPulse 2s infinite;
        }

  #sellerTypeGrid {
   display: flex;
   gap: 15px;
   overflow-x: auto;
}
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-container">
            <a href="#" class="logo">
                <div class="logo-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <span>Sesli Sipari≈ü</span>
            </a>
            
            <div class="header-actions">
                <div class="language-selector">
                    <button class="language-btn" id="languageBtn">
                        <i class="fas fa-globe"></i>
                        <span id="currentLanguage">TR</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="language-dropdown" id="languageDropdown"></div>
                </div>
                
                <div class="location-marker action-btn" id="locationMarker">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="locationText">Konum Se√ßin</span>
                </div>
                
                <div class="order-summary" id="orderSummary">
                    <div class="order-count" id="orderCount">0</div>
                    <div>Sipari≈ü: <span id="orderTotal">0 ‚Ç∫</span></div>
                </div>
               
                <button id="microphoneToggle" class="action-btn">
                    <i class="fas fa-microphone-slash"></i>
                    <span>Mikrofon (Kapalƒ±)</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Banner -->
    <div class="banner" id="banner">
        <video class="banner-video" id="bannerVideo" loop muted autoplay></video>
        <div class="banner-content">
            <h1 id="bannerTitle">Sesli Sipari≈ü ile Kolay Alƒ±≈üveri≈ü</h1>
            <p id="bannerDescription">Sadece konu≈üun, sipari≈üiniz kapƒ±nƒ±zda!</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Store Type Selection -->
        <section>
            <h2 class="section-title">Ne yemek istersiniz?</h2>
            <div class="scroll-container">
                <button class="scroll-btn left" id="scrollStoreTypesLeft">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="scroll-content" id="sellerTypeGrid"></div>
                <button class="scroll-btn right" id="scrollStoreTypesRight">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>

        <!-- Sellers Grid -->
        <section id="sellersSection" style="display: none;">
            <h2 class="section-title">
                <i class="fas fa-store"></i>
                Size En Yakƒ±n Yerler
            </h2>
            <div class="scroll-container">
                <button class="scroll-btn left" id="scrollSellersLeft">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="scroll-content" id="sellerGrid"></div>
                <button class="scroll-btn right" id="scrollSellersRight">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>

        <!-- Categories Grid -->
        <section id="categoriesSection" style="display: none;">
            <h2 class="section-title">
                <i class="fas fa-layer-group"></i>
                Kategoriler
            </h2>
            <div class="scroll-container">
                <button class="scroll-btn left" id="scrollCategoriesLeft">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="scroll-content" id="categoriesGrid"></div>
                <button class="scroll-btn right" id="scrollCategoriesRight">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>

        <!-- Products Grid -->
        <section class="products-section" id="productsSection" style="display: none;">
            <div class="products-header">
                <h2 class="section-title" style="margin-bottom: 0;">
                    <i class="fas fa-box-open"></i>
                    √úr√ºnler
                </h2>
                <div id="selectedSellerInfo">Satƒ±cƒ± se√ßilmedi</div>
            </div>
            <div class="scroll-container">
                <button class="scroll-btn left" id="scrollProductsLeft">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="scroll-content" id="productsGrid"></div>
                <button class="scroll-btn right" id="scrollProductsRight">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>
    </div>

    <!-- Location Modal -->
    <div id="locationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Konum Se√ßiniz</h3>
                <span class="close-modal" id="closeLocationModal">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Dinamik i√ßerik JavaScript ile doldurulacak -->
            </div>
        </div>
    </div>

    <!-- Cart Section -->
    <div class="cart-container" id="cartContainer">
        <div class="cart-header">
            <h2>Sepetiniz</h2>
            <button class="cart-close" id="cartClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="cart-items" id="cartItems">
            <div class="text-center" style="padding: 30px; color: var(--gray);">
                <i class="fas fa-shopping-cart fa-2x mb-3"></i>
                <p>Sepetiniz bo≈ü</p>
            </div>
        </div>
        <div class="cart-totals">
            <div class="total-row">
                <span>Ara Toplam:</span>
                <span id="subtotal">0 ‚Ç∫</span>
            </div>
            <div class="total-row">
                <span>ƒ∞ndirim:</span>
                <span id="discount">0 ‚Ç∫</span>
            </div>
            <div class="total-row">
                <span>KDV (%18):</span>
                <span id="vatAmount">0 ‚Ç∫</span>
            </div>
            <div class="total-row total-final">
                <span>Toplam:</span>
                <span id="totalAmount">0 ‚Ç∫</span>
            </div>
        </div>
        <div class="payment-buttons">
            <button class="payment-btn cash" id="payCash">Nakit √ñde</button>
            <button class="payment-btn card" id="payCard">Kartla √ñde</button>
            <button class="payment-btn bonus" id="payBonus">Bonus ile √ñde</button>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <div class="footer-section">
                <h3 data-translate="app_name">Sesli Sipari≈ü</h3>
                <p data-translate="footer_description">Sesli komutlarla kolayca sipari≈ü verin. Hƒ±zlƒ±, g√ºvenli ve pratik alƒ±≈üveri≈ü deneyimi.</p>
                <div class="social-links">
                    <a href="#" class="social-link"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
                    <a href="https://wa.me/?text=Merhaba!%20Sesli%20Sipari≈ü%20sisteminden%20alƒ±≈üveri≈ü%20yapmak%20istiyorum." class="social-link" target="_blank"><i class="fab fa-whatsapp"></i></a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3 data-translate="quick_links">Hƒ±zlƒ± Baƒülantƒ±lar</h3>
                <ul class="footer-links">
                    <li><a href="#" id="referralLink"><i class="fas fa-link"></i> <span data-translate="referral_link">Referans Linki</span></a></li>
                    <li><a href="#" id="whatsappOrder"><i class="fab fa-whatsapp"></i> <span data-translate="whatsapp_order">WhatsApp ile Sipari≈ü</span></a></li>
                    <li><a href="#"><i class="fas fa-shopping-bag"></i> <span data-translate="my_orders">Sipari≈ülerim</span></a></li>
                    <li><a href="#"><i class="fas fa-question-circle"></i> <span data-translate="help">Yardƒ±m</span></a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3 data-translate="contact">ƒ∞leti≈üim</h3>
                <ul class="footer-links">
                    <li><a href="tel:08501234567"><i class="fas fa-phone"></i> 0850 123 45 67</a></li>
                    <li><a href="mailto:info@seslisiparis.com"><i class="fas fa-envelope"></i> info@seslisiparis.com</a></li>
                    <li><a href="#"><i class="fas fa-map-marker-alt"></i> <span data-translate="location">ƒ∞stanbul, T√ºrkiye</span></a></li>
                </ul>
                <a href="#" class="partner-login" data-translate="partner_login">Partner Giri≈üi</a>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy; 2023 Sesli Sipari≈ü Sistemi. <span data-translate="all_rights_reserved">T√ºm haklarƒ± saklƒ±dƒ±r.</span></p>
        </div>
    </footer>
    <!-- Voice Assistant -->
    <div class="voice-status" id="voiceStatusPanel">
        <div class="status-header">
            <div class="status-title">
                <i class="fas fa-microphone"></i>
                <span>Sesli Asistan</span>
            </div>
            <button class="status-close" id="closeVoiceStatus">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="status-content">
            <div class="assistant-message" id="assistantMessage">Merhaba! Sipari≈ü vermek i√ßin mikrofonu a√ßƒ±n ve konu≈üun.</div>
            <div class="user-message" id="userMessage"></div>
        </div>
        <div class="voice-indicator" id="voiceIndicator">
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
        </div>
    </div>

    <script>
        // =============================================
        // EKSƒ∞K FONKSƒ∞YONLAR - Sƒ∞STEMƒ∞ TAMAMLAYAN
        // =============================================

        // Supabase configuration
        const SUPABASE_URL = "https://xliutvspwodhoaxvysks.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsaXV0dnNwd29kaG9heHZ5c2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTgyOTksImV4cCI6MjA3MjkzNDI5OX0.Zodisa_ifP8t2Q4X0ecnB56RiR_Bg4QS5gvPn5ZLK_w";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // =============================================
        // UI Y√ñNETƒ∞M FONKSƒ∞YONLARI
        // =============================================

        // Store type'larƒ± g√∂ster
        function displayStoreTypes(types) {
    const sellerTypeGrid = document.getElementById('sellerTypeGrid');
    if (!sellerTypeGrid) return;
    
    sellerTypeGrid.innerHTML = '';
    
    if (!types || types.length === 0) {
        sellerTypeGrid.innerHTML = `
            <div class="text-center" style="min-width: 100%; padding: 40px; color: #6c757d;">
                <i class="fas fa-store fa-3x mb-3"></i>
                <p>Maƒüaza tipi bulunamadƒ±</p>
            </div>
        `;
        return;
    }
    
    const iconMap = {
        'Market': 'fas fa-store',
        'Restoran': 'fas fa-utensils',
        'Eczane': 'fas fa-prescription-bottle',
        'Fƒ±rƒ±n': 'fas fa-bread-slice',
        'Kafe': 'fas fa-coffee'
    };
    
    types.forEach((type, index) => {
        const typeCard = document.createElement('div');
        typeCard.className = 'seller-type-card';
        typeCard.dataset.typeId = type.id;
        typeCard.dataset.typeName = type.name;
        typeCard.dataset.typeIndex = index + 1; // Sƒ±ra numarasƒ± ekle
        
        typeCard.innerHTML = `
            <div class="seller-type-icon">
                <i class="${iconMap[type.name] || 'fas fa-store'}"></i>
            </div>
            <div class="seller-type-name">${type.name}</div>
            <div class="store-type-number">${index + 1}</div>
        `;
        
        typeCard.addEventListener('click', () => {
            document.querySelectorAll('.seller-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            typeCard.classList.add('selected');
            onStoreTypeSelected(type.id, type.name);
        });
        
        sellerTypeGrid.appendChild(typeCard);
    });
}
        // Satƒ±cƒ±larƒ± g√∂ster
        function updateSellersGrid() {
    const sellerGrid = document.getElementById('sellerGrid');
    if (!sellerGrid) return;
    
    sellerGrid.innerHTML = '';
    
    const sellersToShow = sellers;
    
    if (sellersToShow.length === 0) {
        sellerGrid.innerHTML = `
            <div class="text-center" style="min-width: 100%; padding: 40px; color: #6c757d;">
                <i class="fas fa-store fa-3x mb-3"></i>
                <p>Bu konumda satƒ±cƒ± bulunamadƒ±</p>
            </div>
        `;
        return;
    }
    
    sellersToShow.forEach((seller, index) => {
        const sellerCard = document.createElement('div');
        sellerCard.className = 'seller-card';
        sellerCard.dataset.sellerId = seller.id;
        sellerCard.dataset.sellerIndex = index + 1; // Sƒ±ra numarasƒ± ekle
        
        if (selectedSellerId === seller.id) {
            sellerCard.classList.add('selected');
        }
        
        let deliveryInfo = '';
        if (selectedLocation === 'delivery') {
            if (seller.delivery_available === false) {
                deliveryInfo = `<div class="delivery-fee" style="color: #dc3545;"><i class="fas fa-times-circle"></i> Bu Konuma Teslimat Yok</div>`;
            } else if (seller.delivery_fee > 0) {
                deliveryInfo = `<div class="delivery-fee"><i class="fas fa-motorcycle"></i> Teslimat: ${money(seller.delivery_fee)}</div>`;
            } else if (seller.delivery_fee === 0) {
                deliveryInfo = `<div class="delivery-fee free"><i class="fas fa-motorcycle"></i> √úcretsiz Teslimat</div>`;
            }
            
            if (seller.min_order_amount > 0) {
                deliveryInfo += `<div class="min-order">Min. Sipari≈ü: ${money(seller.min_order_amount)}</div>`;
            }
        }
        
        sellerCard.innerHTML = `
            <div class="seller-number">${index + 1}</div>
            <img src="${seller.store_image || getDefaultSellerImage(seller)}" 
                 alt="${seller.business_name}" 
                 class="seller-image"
                 onerror="this.src='${getDefaultSellerImage(seller)}'">
            <div class="seller-info">
                <div class="seller-name">${seller.business_name}</div>
                <div class="seller-details">
                    <span><i class="fas fa-map-marker-alt"></i> ${seller.district || ''}, ${seller.city || '≈ûehir belirtilmemi≈ü'}</span>
                    <span><i class="fas fa-star" style="color: gold;"></i> ${seller.rating || '4.5'}</span>
                </div>
                ${deliveryInfo ? `<div class="delivery-info">${deliveryInfo}</div>` : ''}
            </div>
        `;
        
        sellerCard.addEventListener('click', () => {
            if (selectedLocation === 'delivery' && seller.delivery_available === false) {
                speakToUser("Bu satƒ±cƒ± konumunuza teslimat yapmƒ±yor.");
                return;
            }
            selectDynamicSeller(seller);
        });
        
        sellerGrid.appendChild(sellerCard);
    });
}
        // Kategorileri g√∂ster
        function displayCategories(categoriesToShow) {
    const categoriesGrid = document.getElementById('categoriesGrid');
    if (!categoriesGrid) return;
    
    categoriesGrid.innerHTML = '';
    
    if (categoriesToShow.length === 0) {
        categoriesGrid.innerHTML = `
            <div class="text-center" style="min-width: 100%; padding: 40px; color: #6c757d;">
                <i class="fas fa-box-open fa-3x mb-3"></i>
                <p>Kategori bulunamadƒ±</p>
            </div>
        `;
        return;
    }
    
    const iconMap = {
        'Meyve & Sebze': 'fas fa-apple-alt',
        'S√ºt √úr√ºnleri': 'fas fa-cheese',
        'Et & Tavuk': 'fas fa-drumstick-bite',
        'Temel Gƒ±da': 'fas fa-wheat-alt',
        'ƒ∞√ßecekler': 'fas fa-wine-bottle'
    };
    
    categoriesToShow.forEach((category, index) => {
        const categoryCard = document.createElement('div');
        categoryCard.className = 'category-card';
        categoryCard.dataset.categoryId = category.id;
        categoryCard.dataset.categoryName = category.name;
        categoryCard.dataset.categoryIndex = index + 1; // Sƒ±ra numarasƒ± ekle
        
        categoryCard.innerHTML = `
            <div class="category-number">${index + 1}</div>
            <div class="category-icon">
                <i class="${iconMap[category.name] || 'fas fa-box'}"></i>
            </div>
            <div class="category-name">${category.name}</div>
        `;
        
        categoryCard.addEventListener('click', async function() {
            if (!selectedSellerId) {
                speakToUser("√ñnce bir satƒ±cƒ± se√ßmelisiniz.");
                return;
            }
            
            document.querySelectorAll('.category-card').forEach(c => {
                c.classList.remove('selected');
            });
            
            this.classList.add('selected');
            selectedCategoryId = category.id;
            await loadProductsByReyon(category.id);
            
            // Akƒ±llƒ± geri bildirim
            const categoryNumber = this.dataset.categoryIndex;
            speakToUser(`${categoryNumber}. ${category.name} reyonu se√ßildi.`);
        });
        
        categoriesGrid.appendChild(categoryCard);
    });
}
        // √úr√ºnleri g√∂ster
       function displayProducts(productsToShow) {
    const productsGrid = document.getElementById('productsGrid');
    if (!productsGrid) return;
    
    productsGrid.innerHTML = '';
    
    if (productsToShow.length === 0) {
        productsGrid.innerHTML = `
            <div class="text-center" style="grid-column: 1 / -1; padding: 40px; color: #6c757d;">
                <i class="fas fa-box-open fa-3x mb-3"></i>
                <p>Bu kategoride √ºr√ºn bulunamadƒ±</p>
            </div>
        `;
        return;
    }
    
    productsToShow.forEach((product, index) => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card';
        productCard.dataset.productId = product.id;
        productCard.dataset.productIndex = index + 1; // Sƒ±ra numarasƒ± ekle
        
        let badgeHTML = '';
        let priceHTML = '';
        
        if (product.discount_price && product.discount_price < product.price) {
            badgeHTML = `<div class="product-badge">ƒ∞ndirim</div>`;
            priceHTML = `
                <span class="product-price">${money(product.discount_price)}</span>
                <span class="product-discount">${money(product.price)}</span>
            `;
        } else {
            priceHTML = `<span class="product-price">${money(product.price)}</span>`;
        }
        
        productCard.innerHTML = `
            ${badgeHTML}
            <div class="product-number">${index + 1}</div>
            <img src="${product.imgurl || 'https://via.placeholder.com/150x100?text=√úr√ºn'}" 
                 alt="${product.name}" 
                 class="product-image">
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div class="product-price">${priceHTML}</div>
                <button class="add-to-cart-btn" data-id="${product.id}">Sepete Ekle</button>
            </div>
        `;
        
        const addToCartBtn = productCard.querySelector('.add-to-cart-btn');
        addToCartBtn.addEventListener('click', function() {
            addToCart(product, 1, productCard);
        });
        
        productsGrid.appendChild(productCard);
    });
}

        // =============================================
        // SEPET Y√ñNETƒ∞M FONKSƒ∞YONLARI
        // =============================================

    function addToCart(product, quantity, productCard = null) {
    console.log('üõí addToCart √ßaƒürƒ±ldƒ±:', product.name, quantity);
    console.log('üìä √ñnceki sepet durumu:', cart.length, '√ºr√ºn');
    console.log('üîí Kilit durumu:', isSellerLocked);
    console.log('üè™ Se√ßili satƒ±cƒ±:', selectedSellerId);
    
    // Kƒ∞Lƒ∞T KONTROL√ú - farklƒ± satƒ±cƒ±dan √ºr√ºn eklenmeye √ßalƒ±≈üƒ±lƒ±yorsa
    if (isSellerLocked && cart.length > 0) {
        const firstCartItem = cart[0];
        if (firstCartItem && firstCartItem.seller_id !== selectedSellerId) {
            const currentSeller = sellers.find(s => s.id === firstCartItem.seller_id);
            console.log('‚ùå Farklƒ± satƒ±cƒ±dan √ºr√ºn eklenmeye √ßalƒ±≈üƒ±lƒ±yor');
            speakToUser(`Sepet dolu. Sadece ${currentSeller?.business_name || 'mevcut satƒ±cƒ±'} ile alƒ±≈üveri≈üe devam edebilirsiniz.`);
            return; // ƒ∞≈ülemi durdur
        }
    }
    
    // Sepet durumunu kontrol et (kilit mekanizmasƒ± i√ßin)
    const wasCartEmpty = cart.length === 0;
    
    const existingItem = cart.find(item => item.id === product.id);
    
    if (existingItem) {
        existingItem.quantity += quantity;
        console.log('‚úÖ Mevcut √ºr√ºn g√ºncellendi:', existingItem.name, existingItem.quantity);
    } else {
        cart.push({
            id: product.id,
            name: product.name,
            price: product.discount_price || product.price,
            quantity: quantity,
            unit_type: product.unit_type || 'adet',
            image: product.imgurl,
            product_price_id: product.product_price_id,
            seller_id: selectedSellerId, // Mevcut satƒ±cƒ±yƒ± kaydet
            category_id: selectedCategoryId
        });
        console.log('‚úÖ Yeni √ºr√ºn eklendi:', product.name);
    }
    
    // HEMEN G√úNCELLE
    updateCartUI();
    
    // √ñNEMLƒ∞: ƒ∞lk √ºr√ºn eklendiƒüinde kilit mekanizmasƒ±nƒ± aktif et
    if (wasCartEmpty && cart.length > 0) {
        console.log('üéØ ƒ∞lk √ºr√ºn eklendi, kilit aktif ediliyor...');
        lockStoreAndSeller();
    }
    
    if (productCard) {
        // Animasyon efekti
        productCard.style.transform = 'scale(1.05)';
        setTimeout(() => {
            productCard.style.transform = 'scale(1)';
        }, 300);
    }
    
    console.log(`‚úÖ Sepet g√ºncellendi: ${cart.length} √ºr√ºn`);
}

// Maƒüaza ve satƒ±cƒ± kilitleme fonksiyonu
function lockStoreAndSeller() {
    console.log('üîí Maƒüaza ve satƒ±cƒ± kilitleniyor...');
    
    if (!selectedSellerId) {
        console.log('‚ö†Ô∏è Kilitlenecek satƒ±cƒ± yok');
        return;
    }
    
    // Kilit durumunu global deƒüi≈ükende sakla
    isSellerLocked = true;
    localStorage.setItem('isSellerLocked', 'true');
    
    // UI'da kilidi g√∂ster
    updateLockUI();
    
    // Daha a√ßƒ±k mesaj
    const currentSeller = sellers.find(s => s.id === selectedSellerId);
    speakToUser(`ƒ∞lk √ºr√ºn sepete eklendi. Artƒ±k sadece ${currentSeller?.business_name || 'bu maƒüaza'} ile alƒ±≈üveri≈ü yapabilirsiniz. Ba≈üka maƒüaza se√ßmek i√ßin "sepeti bo≈üalt" diyebilirsiniz.`);
    
    console.log('‚úÖ Maƒüaza ve satƒ±cƒ± kilitlendi:', selectedSellerId);
}
        
// Kilidi kaldƒ±rma fonksiyonu
function unlockStoreAndSeller() {
    console.log('üîì Maƒüaza ve satƒ±cƒ± kilidi kaldƒ±rƒ±lƒ±yor...');
    
    isSellerLocked = false;
    localStorage.setItem('isSellerLocked', 'false');
    
    // UI'dan kilidi kaldƒ±r
    updateLockUI();
    
    console.log('‚úÖ Maƒüaza ve satƒ±cƒ± kilidi kaldƒ±rƒ±ldƒ±');
}

// UI g√ºncelleme fonksiyonu
function updateLockUI() {
    const sellerTypeGrid = document.getElementById('sellerTypeGrid');
    const sellerGrid = document.getElementById('sellerGrid');
    
    if (isSellerLocked) {
        // Kilitli durum - diƒüer maƒüazalarƒ± gri g√∂ster
        document.querySelectorAll('.seller-type-card:not(.selected)').forEach(card => {
            card.style.opacity = '0.5';
            card.style.pointerEvents = 'none';
            card.title = 'Sepet dolu - sadece se√ßili maƒüaza kullanƒ±labilir';
        });
        
        document.querySelectorAll('.seller-card:not(.selected)').forEach(card => {
            card.style.opacity = '0.5';
            card.style.pointerEvents = 'none';
            card.title = 'Sepet dolu - sadece se√ßili satƒ±cƒ± kullanƒ±labilir';
        });
        
        // Se√ßili olanlarƒ± normal g√∂ster
        document.querySelectorAll('.seller-type-card.selected, .seller-card.selected').forEach(card => {
            card.style.opacity = '1';
            card.style.pointerEvents = 'auto';
            card.style.border = '2px solid var(--success)';
        });
        
        // Kilit ikonu ekle
        if (!document.getElementById('lockIndicator')) {
            const lockIndicator = document.createElement('div');
            lockIndicator.id = 'lockIndicator';
            lockIndicator.innerHTML = `
                <div style="position: fixed; top: 72px; right: 20px; background: var(--success); color: white; padding: 10px; border-radius: 8px; z-index: 1000; box-shadow: var(--shadow);">
                    <i class="fas fa-lock"></i> Sepet Aktif - Maƒüaza Kilitli
                </div>
            `;
            document.body.appendChild(lockIndicator);
        }
        
    } else {
        // Kilitli deƒüil - t√ºm√º aktif
        document.querySelectorAll('.seller-type-card, .seller-card').forEach(card => {
            card.style.opacity = '1';
            card.style.pointerEvents = 'auto';
            card.style.border = '';
            card.title = '';
        });
        
        // Kilit ikonunu kaldƒ±r
        const lockIndicator = document.getElementById('lockIndicator');
        if (lockIndicator) {
            lockIndicator.remove();
        }
    }
}
   function updateCartUI() {
    console.log('üîÑ updateCartUI √ßaƒürƒ±ldƒ±, sepet durumu:', cart.length, '√ºr√ºn');
    
    // Sepet sayacƒ± - CANLI HESAPLAMA
    const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 0), 0);
    console.log('üìä Sepet toplam √ºr√ºn sayƒ±sƒ±:', totalItems);
    
    if (orderCount) {
        orderCount.textContent = totalItems;
        console.log('‚úÖ Sepet sayacƒ± g√ºncellendi:', totalItems);
    }
    
    // Toplam tutar
    const total = calculateTotal();
    if (orderTotal) orderTotal.textContent = money(total);
    
    // Sepet i√ßeriƒüi
    updateCartItems();
    
    // √ñdeme √∂zeti
    updateCartTotals();
    
    // √ñNEMLƒ∞ D√úZELTME: Sepet durumuna g√∂re kilit y√∂netimi
    console.log('üîç Kilit kontrol√º - Sepet:', totalItems, '√ºr√ºn, Kilitli mi:', isSellerLocked);
    
    if (totalItems === 0) {
        // Sepet BO≈ûSA kesinlikle kilidi kaldƒ±r
        if (isSellerLocked) {
            console.log('üóëÔ∏è Sepet bo≈ü, kilidi kaldƒ±rƒ±lƒ±yor...');
            unlockStoreAndSeller();
        }
    } else {
        // Sepet DOLUYSA ve kilit yoksa kilitle
        if (!isSellerLocked && selectedSellerId) {
            console.log('üõí Sepet dolu, kilitleme aktif ediliyor...');
            lockStoreAndSeller();
        }
    }
    
    // Kilit UI'ƒ±nƒ± g√ºncelle
    updateLockUI();
}
        
        function updateCartItems() {
    const cartItems = document.getElementById('cartItems');
    if (!cartItems) return;
    
    console.log('üì¶ updateCartItems √ßaƒürƒ±ldƒ±, sepet:', cart.length, '√ºr√ºn');
    
    if (cart.length === 0) {
        cartItems.innerHTML = `
            <div class="text-center" style="padding: 30px; color: var(--gray);">
                <i class="fas fa-shopping-cart fa-2x mb-3"></i>
                <p>Sepetiniz bo≈ü</p>
            </div>
        `;
        console.log('üõí Sepet g√∂rseli: BO≈û');
    } else {
        cartItems.innerHTML = '';
        
        cart.forEach((item, index) => {
            const cartItem = document.createElement('div');
            cartItem.className = 'cart-item';
            
            cartItem.innerHTML = `
                <div class="cart-item-info">
                    <img src="${item.image || 'https://via.placeholder.com/50x50?text=√úr√ºn'}" 
                         alt="${item.name}" 
                         class="cart-item-image">
                    <div class="cart-item-details">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${money(item.price)} / ${item.unit_type}</div>
                    </div>
                </div>
                <div class="cart-item-controls">
                    <button class="quantity-btn decrease" data-index="${index}">-</button>
                    <span class="quantity">${item.quantity}</span>
                    <button class="quantity-btn increase" data-index="${index}">+</button>
                    <button class="quantity-btn remove" data-index="${index}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            cartItems.appendChild(cartItem);
        });
        
        console.log('üõí Sepet g√∂rseli:', cart.length, '√ºr√ºn listelendi');
        
        // Event listener'larƒ± ekle
        setTimeout(() => {
            setupCartItemEvents();
        }, 100);
    }
    
    // Temizleme butonunu kontrol et
    addClearCartButton();
}

// Sepet item event'lerini ayarla
function setupCartItemEvents() {
    console.log('üéØ Sepet event listenerlarƒ± kuruluyor...');
    
    document.querySelectorAll('.quantity-btn.decrease').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = parseInt(this.dataset.index);
            console.log('‚ûñ Azalt butonu:', index);
            
            if (cart[index].quantity > 1) {
                cart[index].quantity--;
            } else {
                cart.splice(index, 1);
            }
            updateCartUI(); // HEMEN G√úNCELLE
        });
    });
    
    document.querySelectorAll('.quantity-btn.increase').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = parseInt(this.dataset.index);
            console.log('‚ûï Artƒ±r butonu:', index);
            
            cart[index].quantity++;
            updateCartUI(); // HEMEN G√úNCELLE
        });
    });
    
    document.querySelectorAll('.quantity-btn.remove').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = parseInt(this.dataset.index);
            console.log('üóëÔ∏è Sil butonu:', index, cart[index].name);
            
            cart.splice(index, 1);
            updateCartUI(); // HEMEN G√úNCELLE
        });
    });
}
        function updateCartTotals() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const vat = subtotal * 0.18;
            const total = subtotal + vat;
            
            if (subtotalEl) subtotalEl.textContent = money(subtotal);
            if (vatAmountEl) vatAmountEl.textContent = money(vat);
            if (totalAmountEl) totalAmountEl.textContent = money(total);
        }

       function calculateTotal() {
    const total = cart.reduce((sum, item) => {
        const quantity = item.quantity || 0;
        const price = item.price || 0;
        return sum + (price * quantity);
    }, 0);
    
    console.log('üí∞ Sepet toplamƒ± hesaplandƒ±:', total, '| √úr√ºn sayƒ±sƒ±:', cart.length);
    return total;
}


        // =============================================
        // YARDIMCI FONKSƒ∞YONLAR
        // =============================================

        function money(n) { 
            return Number(n||0).toLocaleString('tr-TR',{minimumFractionDigits:2, maximumFractionDigits:2}) + ' ‚Ç∫'; 
        }

        function getDefaultSellerImage(seller) {
            return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGVlMmYzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY3Njc2NyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPlNhdMSxY8SxPC90ZXh0Pjwvc3ZnPg==';
        }

        function debugLog(message, data = null) {
            if (true) { // DEBUG_MODE
                console.log(`[DEBUG] ${new Date().toLocaleTimeString()}: ${message}`, data || '');
            }
        }

// =============================================
// SESSƒ∞Z ASƒ∞STAN MESAJLARI
// =============================================


function speakToUser(message) {
    console.log(`üó£Ô∏è Asistan (SESLƒ∞): ${message}`);
    
    const cleanMessage = message.trim();
    if (!cleanMessage) return;
    
    const now = Date.now();
    
    // 1. AYNI MESAJ KONTROL√ú
    if (cleanMessage === lastSpokenMessage) {
        console.log("üõë Aynƒ± sesli mesaj tekrarƒ± engellendi:", cleanMessage);
        return;
    }
    
    // 2. SIKLIK KONTROL√ú
    if (now - lastSpeakTime < SPEAK_COOLDOWN) {
        console.log("üõë Sƒ±k sesli mesaj engellendi (cooldown):", cleanMessage);
        return;
    }
    
    // 3. SADECE SE√áƒ∞M √ñNCESƒ∞ VE √ñNEMLƒ∞ MESAJLAR SESLƒ∞ OLSUN
    const allowedVoiceMessages = [
        // SE√áƒ∞M √ñNCESƒ∞ MESAJLAR
        "maƒüaza se√ßin", "satƒ±cƒ± se√ßin", "reyon se√ßin", "√ºr√ºn se√ßin",
        "hangi maƒüaza", "hangi satƒ±cƒ±", "hangi reyon", "hangi √ºr√ºn",
        "numara s√∂yleyin", "isim s√∂yleyin",
        
        // TEMEL ONAYLAR
        "se√ßildi", "eklendi", "bulundu",
        
        // TEMEL UYARILAR
        "hata", "bulunamadƒ±", "sepet dolu", "se√ßilmedi",
        
        // Sƒ∞STEM MESAJLARI
        "mikrofon a√ßƒ±ldƒ±", "mikrofon kapandƒ±", "ho≈ü geldiniz"
    ];
    
    // Mesajƒ±n izin verilenlerden birini i√ßerip i√ßermediƒüini kontrol et
    const isAllowed = allowedVoiceMessages.some(allowedMsg => 
        cleanMessage.toLowerCase().includes(allowedMsg.toLowerCase())
    );
    
    if (!isAllowed) {
        console.log("üîá Sadece se√ßim √∂ncesi mesajlar sesli s√∂ylenecek:", cleanMessage);
        return;
    }
    
    // SESLƒ∞ OKUMA (sadece izin verilen mesajlar i√ßin)
    if ('speechSynthesis' in window && isMicrophoneEnabled) {
        const speech = new SpeechSynthesisUtterance(cleanMessage);
        speech.lang = currentLanguage === 'tr' ? 'tr-TR' : 'en-US';
        speech.volume = 0.7;
        speech.rate = 1.0;
        
        // Konu≈üma bitince mikrofonu yeniden ba≈ülat
        speech.onend = function() {
            console.log("‚úÖ Sesli mesaj bitti");
            setTimeout(() => {
                if (isMicrophoneEnabled && !isListening) {
                    restartRecognition();
                }
            }, 1000);
        };
        
        // √ñnceki konu≈ümayƒ± durdur
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(speech);
    }
    
    // KAYDET
    lastSpokenMessage = cleanMessage;
    lastSpeakTime = now;
    
    console.log("‚úÖ Yeni sesli mesaj s√∂ylendi:", cleanMessage);
}
function isSimilarMessage(newMessage, oldMessage) {
    if (!oldMessage) return false;
    
    const newWords = newMessage.toLowerCase().split(' ');
    const oldWords = oldMessage.toLowerCase().split(' ');
    
    // Ortak kelime sayƒ±sƒ±nƒ± bul
    const commonWords = newWords.filter(word => 
        oldWords.includes(word) && word.length > 3
    );
    
    const similarity = commonWords.length / Math.max(newWords.length, oldWords.length);
    
    console.log(`üîç Benzerlik kontrol: ${similarity.toFixed(2)} (${commonWords.join(', ')})`);
    
    return similarity > SIMILARITY_THRESHOLD;
}

    function speakToUserForce(message) {
    // Zorla konu≈üma (√∂nemli mesajlar i√ßin)
    lastSpokenMessage = "";
    lastSpeakTime = 0;
    speakToUser(message);
}
// =============================================
// Mƒ∞KROFON ve SES TANIMA
// =============================================

// Mikrofon a√ßma fonksiyonunu g√ºncelle
async function enableDynamicMicrophone() {
    console.log('üé§ Mikrofon a√ßƒ±lmak isteniyor...');
    
    // Konum kontrol√º
    if (!selectedLocation) {
        showDynamicLocationModal();
        displayMessage("L√ºtfen √∂nce bir konum se√ßiniz.");
        speakToUser("konum se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
        return;
    }
    
    // Zaten a√ßƒ±ksa kapat
    if (isMicrophoneEnabled) {
        disableDynamicMicrophone();
        return;
    }
    
    try {
        // Mikrofon iznini test et
        console.log('üîê Mikrofon izni isteniyor...');
        const stream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            }
        });
        
        // Stream'i temizle
        stream.getTracks().forEach(track => track.stop());
        
        console.log('‚úÖ Mikrofon izni alƒ±ndƒ±');
        
        // Durumu g√ºncelle
        isMicrophoneEnabled = true;
        
        if (microphoneToggle) {
            microphoneToggle.innerHTML = '<i class="fas fa-microphone"></i> <span>Mikrofon (A√áIK)</span>';
            microphoneToggle.style.color = 'var(--success)';
        }
        
    // Ba≈üarƒ± mesajƒ±
    setTimeout(() => {
        displayMessage("Mikrofon a√ßƒ±ldƒ±. Hangi maƒüaza tipinden alƒ±≈üveri≈ü yapmak istersiniz?");
        speakToUser("mikrofon a√ßƒ±ldƒ±"); // SESLƒ∞: Sistem mesajƒ±
    }, 1500);
                
        function disableDynamicMicrophone() {
    console.log('üîá Mikrofon kapatƒ±lƒ±yor...');
    
    isMicrophoneEnabled = false;
    isListening = false;
    
    // Recognition'ƒ± durdur
    if (recognition) {
        try {
            recognition.stop();
        } catch (error) {
            console.log('Recognition stop hatasƒ±:', error);
        }
        recognition = null;
    }
    
    // UI'ƒ± g√ºncelle
    if (microphoneToggle) {
        microphoneToggle.innerHTML = '<i class="fas fa-microphone-slash"></i> <span>Mikrofon (KAPALI)</span>';
        microphoneToggle.style.color = 'var(--danger)';
    }
    
    if (voiceIndicator) {
        voiceIndicator.classList.remove('listening');
    }
    
   if (assistantMessage) {
        assistantMessage.textContent = "Mikrofon kapalƒ±. A√ßmak i√ßin mikrofon butonuna tƒ±klayƒ±n.";
    }
    
    speakToUser("mikrofon kapandƒ±"); // SESLƒ∞: Sistem mesajƒ±
}

// "no-speech" hatalarƒ±nƒ± filtreleme
function setupSpeechRecognitionFilter() {
    let errorCount = 0;
    const MAX_CONSECUTIVE_ERRORS = 5;
    let lastErrorTime = 0;
    
    // Orijinal error handler'ƒ± sakla
    const originalOnError = recognition.onerror;
    
    recognition.onerror = function(event) {
        const now = Date.now();
        
        // Aynƒ± hatayƒ± √ßok sƒ±k alƒ±yorsak filtrele
        if (event.error === 'no-speech') {
            errorCount++;
            
            // 5 saniye i√ßinde 5'ten fazla hata alƒ±ndƒ±ysa, bir s√ºre beklet
            if (errorCount > MAX_CONSECUTIVE_ERRORS && (now - lastErrorTime) < 5000) {
                console.log('üö´ √áok fazla no-speech hatasƒ±, 10 saniye bekletiliyor...');
                setTimeout(() => {
                    errorCount = 0;
                    if (isMicrophoneEnabled) {
                        restartRecognition();
                    }
                }, 10000);
                return;
            }
            
            lastErrorTime = now;
        } else {
            errorCount = 0; // Diƒüer hatalar i√ßin sayacƒ± sƒ±fƒ±rla
        }
        
        // Orijinal handler'ƒ± √ßaƒüƒ±r
        originalOnError.call(this, event);
    };
}

// Ses tanƒ±ma durumunu kullanƒ±cƒ±ya bildirme
function updateRecognitionStatus(status) {
    const statusMessages = {
        'listening': 'üé§ Dinliyorum... Konu≈üun!',
        'processing': '‚è≥ ƒ∞≈üleniyor...',
        'waiting': 'üîç Ses bekleniyor...',
        'error': '‚ùå Ses tanƒ±namadƒ±'
    };
    
    if (assistantMessage) {
        assistantMessage.textContent = statusMessages[status] || 'Mikrofon hazƒ±r';
    }
}

        // Ses giri≈üi g√∂rsel geri bildirimi
function setupVisualFeedback() {
    const voiceBars = document.querySelectorAll('.voice-bar');
    let animationInterval;
    
    function startAnimation() {
        clearInterval(animationInterval);
        animationInterval = setInterval(() => {
            voiceBars.forEach((bar, index) => {
                const height = 10 + Math.random() * 20;
                const delay = index * 100;
                
                setTimeout(() => {
                    bar.style.height = `${height}px`;
                    bar.style.background = 'var(--accent)';
                }, delay);
            });
        }, 200);
    }

     function stopAnimation() {
        clearInterval(animationInterval);
        voiceBars.forEach(bar => {
            bar.style.height = '10px';
            bar.style.background = '#ddd';
        });
    }
    
    // Dinleme durumuna g√∂re animasyonu kontrol et
    recognition.onstart = function() {
        startAnimation();
        updateRecognitionStatus('listening');
    };
    
    recognition.onspeechstart = function() {
        updateRecognitionStatus('processing');
    };
    
    recognition.onend = function() {
        stopAnimation();
        updateRecognitionStatus('waiting');
    };
}
// Basitle≈ütirilmi≈ü ses tanƒ±ma (no-speech hatalarƒ±nƒ± yoksay)
function initializeSimpleSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (!SpeechRecognition) return;
    
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.lang = 'tr-TR';
    recognition.interimResults = false;
    
    recognition.onstart = function() {
        console.log('‚úÖ Dinliyorum...');
        isListening = true;
        if (voiceIndicator) voiceIndicator.classList.add('listening');
    };
    
    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        console.log('üéØ Tanƒ±nan:', transcript);
        
        if (userMessage) userMessage.textContent = transcript;
        processVoiceCommand(transcript);
    };
    
    recognition.onerror = function(event) {
        console.log('‚ö†Ô∏è Hata (yoksayƒ±lƒ±yor):', event.error);
        isListening = false;
        if (voiceIndicator) voiceIndicator.classList.remove('listening');
        
        // T√ºm hatalarƒ± yoksay ve yeniden ba≈üla
        setTimeout(() => {
            if (isMicrophoneEnabled && !isListening) {
                try {
                    recognition.start();
                } catch (e) {
                    console.log('Yeniden ba≈ülatma hatasƒ±:', e);
                }
            }
        }, 1000);
    };
    
    recognition.onend = function() {
        isListening = false;
        if (voiceIndicator) voiceIndicator.classList.remove('listening');
        
        if (isMicrophoneEnabled) {
            setTimeout(() => {
                try {
                    recognition.start();
                } catch (error) {
                    console.log('Yeniden ba≈ülatma hatasƒ±:', error);
                }
            }, 800);
        }
    };
    
    try {
        recognition.start();
    } catch (error) {
        console.error('Ba≈ülatma hatasƒ±:', error);
    }
}
        
        // Acil durum fallback'leri
function setupEmergencyFallbacks() {
    // Languages tablosu yoksa
    if (typeof supabase === 'undefined') {
        console.error('‚ùå Supabase baƒülantƒ±sƒ± yok');
        speakToUser("Sistem baƒülantƒ±sƒ±nda sorun olu≈ütu. Demo modunda √ßalƒ±≈üƒ±yorum.");
        initializeDemoMode();
        return;
    }
    
    // Ses tanƒ±ma yoksa
    if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
        console.error('‚ùå Ses tanƒ±ma desteklenmiyor');
        speakToUser("Tarayƒ±cƒ±nƒ±z ses tanƒ±mayƒ± desteklemiyor. Manuel olarak tƒ±klayarak kullanabilirsiniz.");
        setupManualMode();
    }
}

function initializeDemoMode() {
    // Demo verilerle √ßalƒ±≈ü
    storeTypes = getDemoStoreTypes();
    displayStoreTypes(storeTypes);
    
    // Manuel modu etkinle≈ütir
    document.querySelectorAll('.seller-type-card, .seller-card, .category-card, .product-card').forEach(element => {
        element.style.cursor = 'pointer';
        element.addEventListener('click', function() {
            speakToUser("Demo mod: " + (this.querySelector('.seller-type-name, .seller-name, .category-name, .product-name')?.textContent || '√ñƒüe se√ßildi'));
        });
    });
}

function setupManualMode() {
    // T√ºm tƒ±klanabilir √∂ƒüelere sesli geri bildirim ekle
    document.addEventListener('click', function(e) {
        const target = e.target;
        const card = target.closest('.seller-type-card, .seller-card, .category-card, .product-card');
        
        if (card) {
            const nameElement = card.querySelector('.seller-type-name, .seller-name, .category-name, .product-name');
            if (nameElement) {
                speakToUser(nameElement.textContent + " se√ßildi");
            }
        }
    });
}

        
      function initializeDynamicSpeechRecognition() {
    // Basitle≈ütirilmi≈ü ses tanƒ±ma (no-speech hatalarƒ±nƒ± yoksay)
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (!SpeechRecognition) return;
    
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.lang = 'tr-TR';
    recognition.interimResults = false;
    
    recognition.onstart = function() {
        console.log('‚úÖ Dinliyorum...');
        isListening = true;
        if (voiceIndicator) voiceIndicator.classList.add('listening');
    };
    
    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        console.log('üéØ Tanƒ±nan:', transcript);
        
        if (userMessage) userMessage.textContent = transcript;
        processVoiceCommand(transcript);
    };
    
    recognition.onerror = function(event) {
        console.log('‚ö†Ô∏è Hata (yoksayƒ±lƒ±yor):', event.error);
        isListening = false;
        if (voiceIndicator) voiceIndicator.classList.remove('listening');
        
        // T√ºm hatalarƒ± yoksay ve yeniden ba≈üla
        setTimeout(() => {
            if (isMicrophoneEnabled && !isListening) {
                try {
                    recognition.start();
                } catch (e) {
                    console.log('Yeniden ba≈ülatma hatasƒ±:', e);
                }
            }
        }, 1000);
    };
    
    recognition.onend = function() {
        isListening = false;
        if (voiceIndicator) voiceIndicator.classList.remove('listening');
        
        if (isMicrophoneEnabled) {
            setTimeout(() => {
                try {
                    recognition.start();
                } catch (error) {
                    console.log('Yeniden ba≈ülatma hatasƒ±:', error);
                }
            }, 800);
        }
    };
    
    try {
        recognition.start();
    } catch (error) {
        console.error('Ba≈ülatma hatasƒ±:', error);
    }
}

// Ses tanƒ±ma ba≈ülatma fonksiyonunu g√ºncelle
function startRecognition() {
    if (!recognition) {
        console.error('‚ùå Recognition objesi yok');
        return;
    }
    
    // Asistan konu≈üuyorsa ba≈ülatma
    if (isAssistantSpeaking) {
        console.log('‚è∏Ô∏è Asistan konu≈üuyor, ses tanƒ±ma ertelendi');
        return;
    }
    
    // Zaten √ßalƒ±≈üƒ±yorsa ba≈ülatma
    if (isListening) {
        console.log('‚ÑπÔ∏è Zaten dinleniyor');
        return;
    }
    
    try {
        console.log('üöÄ Ses tanƒ±ma ba≈ülatƒ±lƒ±yor...');
        recognition.start();
        console.log('‚úÖ Ses tanƒ±ma ba≈ülatma komutu g√∂nderildi');
    } catch (error) {
        console.error('‚ùå Ses tanƒ±ma ba≈ülatma hatasƒ±:', error);
        
        // "already started" hatasƒ±nƒ± yoksay
        if (error.toString().includes('already started')) {
            console.log('‚ÑπÔ∏è Ses tanƒ±ma zaten ba≈ülamƒ±≈ü');
            return;
        }
        
        // Diƒüer hatalar i√ßin 3 saniye sonra yeniden dene
        setTimeout(() => {
            if (isMicrophoneEnabled && !isListening && !isAssistantSpeaking) {
                console.log('üîÑ Hata sonrasƒ± yeniden deneme...');
                startRecognition();
            }
        }, 3000);
    }
}
        
 function restartRecognition() {
    console.log('üîÑ Ses tanƒ±ma yeniden ba≈ülatƒ±lƒ±yor...');
    
    if (recognition && isListening) {
        try {
            recognition.stop();
        } catch (e) {
            console.log('Stop hatasƒ± (normal):', e);
        }
    }
    
    // Kƒ±sa bir bekleme s√ºresi
    setTimeout(() => {
        if (isMicrophoneEnabled && !isListening) {
            startRecognition();
        }
    }, 600);
}       
        
        
            
        function initializeDynamicVoiceAssistant() {
    setTimeout(() => {
        if (!currentCustomer) {
            displayMessage("Merhaba! Sesli sipari≈ü sistemine ho≈ü geldiniz. L√ºtfen konumunuzu se√ßin.");
            speakToUser("ho≈ü geldiniz"); // SESLƒ∞: Sistem mesajƒ±
        } else {
            displayMessage(`Ho≈ü geldiniz ${currentCustomer.name}! Ne satƒ±n almak istersiniz?`);
            speakToUser("ho≈ü geldiniz"); // SESLƒ∞: Sistem mesajƒ±
        }
    }, 1000);
}

        // =============================================
        // EKSƒ∞K FONKSƒ∞YONLARIN TAMAMLANMASI
        // =============================================

        // √ñnceki cevaptaki t√ºm dinamik fonksiyonlar buraya eklenecek
        // (processVoiceCommand, executeDynamicAction, handleDynamicStoreTypeSelection, vb.)

// =============================================
// TAMAMEN Dƒ∞NAMƒ∞K SESLƒ∞ Sƒ∞PARƒ∞≈û Sƒ∞STEMƒ∞
// =============================================

// Global state - Dinamik
let currentCustomer = null;
let sellers = [];
let products = [];
let categories = [];
let storeTypes = [];
let cart = [];
let recognition = null;
let isListening = false;
let isMicrophoneEnabled = false;
let conversationStep = 0;
let currentPaymentMethod = null;
let selectedSellerId = null;
let selectedSellerType = null;
let selectedStoreTypeId = null;
let selectedStoreTypeName = null;
let selectedCategoryId = null;
let isSellerLocked = false;
let selectedLocation = null;
let referralCode = null;
let referralGroupCode = null;
let allSellersInLocation = [];
let filteredSellers = [];
let pendingCart = [];
let isGuestMode = false;
let pendingOrder = null;
let currentRoot = "0:0";
let pendingResponse = null;
let commandRules = new Map();
let lastRecognizedProduct = null;
let lastSpokenMessage = "";
let lastSpeakTime = 0;
let isLocationDetected = false;        

// Konum state
let userLocation = {
    latitude: null,
    longitude: null,
    address: null,
    city: null,
    district: null
};




// DOM Elements
        const profileBtn = document.getElementById('profileBtn');
        const profileDropdown = document.getElementById('profileDropdown');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profilePhone = document.getElementById('profilePhone');
        const profileCity = document.getElementById('profileCity');
        const profileAddress = document.getElementById('profileAddress');
        const profileBonus = document.getElementById('profileBonus');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const microphoneToggle = document.getElementById('microphoneToggle');
        const sellerTypeGrid = document.getElementById('sellerTypeGrid');
        const scrollSellerTypesLeft = document.getElementById('scrollSellerTypesLeft');
        const scrollSellerTypesRight = document.getElementById('scrollSellerTypesRight');
        const categoriesSection = document.getElementById('categoriesSection');
        const categoriesTitle = document.getElementById('categoriesTitle');
        const categoriesGrid = document.getElementById('categoriesGrid');
        const scrollCategoriesLeft = document.getElementById('scrollCategoriesLeft');
        const scrollCategoriesRight = document.getElementById('scrollCategoriesRight');
        const sellersSection = document.getElementById('sellersSection');
        const sellerGrid = document.getElementById('sellerGrid');
        const scrollSellersLeft = document.getElementById('scrollSellersLeft');
        const scrollSellersRight = document.getElementById('scrollSellersRight');
        const productsSection = document.getElementById('productsSection');
        const selectedSellerInfo = document.getElementById('selectedSellerInfo');
        const productsGrid = document.getElementById('productsGrid');
        const cartContainer = document.getElementById('cartContainer');
        const cartClose = document.getElementById('cartClose');
        const cartItems = document.getElementById('cartItems');
        const orderSummary = document.getElementById('orderSummary');
        const orderCount = document.getElementById('orderCount');
        const orderTotal = document.getElementById('orderTotal');
        const subtotalEl = document.getElementById('subtotal');
        const discountEl = document.getElementById('discount');
        const vatAmountEl = document.getElementById('vatAmount');
        const totalAmountEl = document.getElementById('totalAmount');
        const payCashBtn = document.getElementById('payCash');
        const payCardBtn = document.getElementById('payCard');
        const payBonusBtn = document.getElementById('payBonus');
        const assistantMessage = document.getElementById('assistantMessage');
        const userMessage = document.getElementById('userMessage');
        const voiceIndicator = document.getElementById('voiceIndicator');
        const closeVoiceStatus = document.getElementById('closeVoiceStatus');
        const voiceStatusPanel = document.getElementById('voiceStatusPanel');
        const howItWorks = document.getElementById('howItWorks');
        const locationMarker = document.getElementById('locationMarker');
        const locationText = document.getElementById('locationText');
        const locationModal = document.getElementById('locationModal');
        const referralLink = document.getElementById('referralLink');
        const whatsappOrder = document.getElementById('whatsappOrder');
        const SPEAK_COOLDOWN = 3000; // 3 saniye
        const SIMILARITY_THRESHOLD = 0.8; // %80 benzerlik


        // Utility functions
        function money(n) { 
            return Number(n||0).toLocaleString('tr-TR',{minimumFractionDigits:2, maximumFractionDigits:2}) + ' ‚Ç∫'; 
        }

        // Debug modu
        const DEBUG_MODE = true;

        // Debug fonksiyonu
        function debugLog(message, data = null) {
            if (DEBUG_MODE) {
                console.log(`[DEBUG] ${new Date().toLocaleTimeString()}: ${message}`, data || '');
            }
        }

// =============================================
// ANA UYGULAMA BA≈ûLATMA - Dƒ∞NAMƒ∞K
// =============================================

async function initApp() {
      try {
        console.log('üöÄ Uygulama ba≈ülatƒ±lƒ±yor...');
        
        // √ñnce √∂ƒürenen sistemi ba≈ülat
        await voiceLearner.initialize();
        
        // 1. T√ºm dinamik verileri y√ºkle
        await loadAllDynamicData();
        
        // 2. DOM hazƒ±r olana kadar bekle
        await waitForDOMElements();
        
        // 3. Dinamik event handler'larƒ± ayarla
        setupDynamicEventHandlers();
        
        // 4. Oturumu geri y√ºkle
        await restoreSession();
        
        // 5. Konum y√∂netimini ba≈ülat
        initializeDynamicLocation();
        
        // 6. UI'ƒ± g√ºncelle
        updateUIAfterDynamicLogin();

           // Kilit durumunu kontrol et
        if (cart.length > 0 && selectedSellerId) {
            lockStoreAndSeller();
        }
        debugLog('üéâ === Dƒ∞NAMƒ∞K UYGULAMA BA≈ûLATMA TAMAMLANDI ===');
          

    } catch (error) {
        console.error('üí• Dinamik uygulama ba≈ülatma hatasƒ±:', error);
        dynamicEmergencyFallback();
    }
}

async function loadAllDynamicData() {
    await loadCommandRules();
    await loadStoreTypes();
    
    // Dil se√ßeneklerini y√ºkle (hata olsa bile devam et)
    try {
        await loadLanguageOptions();
    } catch (error) {
        console.log('Dil y√ºkleme hatasƒ±, fallback kullanƒ±lƒ±yor:', error);
    }
    
    debugLog('‚úÖ T√ºm dinamik veriler y√ºklendi');
}

// Uygulama ba≈ülatƒ±ldƒ±ƒüƒ±nda dil selector'√º kur
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        setupLanguageSelector();
        translatePage('tr'); // Varsayƒ±lan dil
    }, 1000);
});

        // Sayfa y√ºklendiƒüinde
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM y√ºklendi, uygulama ba≈ülatƒ±lƒ±yor...');
    
    // Acil durum fallback'lerini kur
    setupEmergencyFallbacks();
    
    // Uygulamayƒ± ba≈ülat
    setTimeout(() => {
        initApp().catch(error => {
            console.error('üí• Uygulama ba≈ülatma hatasƒ±:', error);
            speakToUser("Sistem y√ºklenirken hata olu≈ütu. Demo modunda devam ediyorum.");
            initializeDemoMode();
        });
    }, 1000);
});

// =============================================
// Dƒ∞NAMƒ∞K KOMUT Sƒ∞STEMƒ∞ - VERƒ∞TABANI ODAKLI
// =============================================

async function loadCommandRules() {
    try {
        const { data, error } = await supabase
            .from('voice_command_rules')
            .select('*')
            .eq('is_active', true)
            .order('priority', { ascending: false });

        if (error) throw error;

        commandRules.clear();
        data.forEach(rule => {
            if (!commandRules.has(rule.root_code)) {
                commandRules.set(rule.root_code, []);
            }
            commandRules.get(rule.root_code).push(rule);
        });

        debugLog(`‚úÖ ${data.length} komut kuralƒ± y√ºklendi`);
    } catch (error) {
        console.error('Komut kurallarƒ± y√ºkleme hatasƒ±:', error);
        await createDefaultCommandRules();
    }
}

// Varsayƒ±lan komut kurallarƒ±nƒ± olu≈ütur
async function createDefaultCommandRules() {
    const defaultRules = [
        // Ba≈ülangƒ±√ß komutlarƒ±
        {
            root_code: '0:0',
            input_patterns: 'merhaba|selam|ba≈üla|hello|start',
            output_text: 'Merhaba! Sesli sipari≈ü sistemine ho≈ü geldiniz. L√ºtfen konumunuzu se√ßin.',
            next_root: '1:0',
            action_name: 'show_location_modal',
            priority: 10
        },
        
        // Konum komutlarƒ±
        {
            root_code: '1:0',
            input_patterns: 'restoran i√ßi|i√ßerde|yerinde',
            output_text: 'Restoran i√ßi se√ßildi.',
            next_root: '2:0',
            action_name: 'select_location',
            priority: 10
        },
        {
            root_code: '1:0',
            input_patterns: 'paket servis|paket|g√∂t√ºr',
            output_text: 'Paket servis se√ßildi.',
            next_root: '2:0',
            action_name: 'select_location',
            priority: 10
        },
        {
            root_code: '1:0',
            input_patterns: 'adrese teslim|teslimat|evime',
            output_text: 'Adrese teslim se√ßildi.',
            next_root: '2:0',
            action_name: 'select_location',
            priority: 10
        },
        
        // Maƒüaza tipi komutlarƒ±
        {
            root_code: '2:0',
            input_patterns: 'regex:(?<storeType>market|restoran|eczane|fƒ±rƒ±n|kafe)',
            output_text: '{storeType} se√ßiliyor...',
            next_root: '3:0',
            action_name: 'select_store_type',
            priority: 10
        },
        
        // Satƒ±cƒ± komutlarƒ±
        {
            root_code: '3:0',
            input_patterns: 'regex:birinci|ilk|1',
            output_text: 'Birinci satƒ±cƒ± se√ßiliyor...',
            next_root: '4:0',
            action_name: 'select_seller',
            priority: 10
        },
        {
            root_code: '3:0',
            input_patterns: 'regex:ikinci|2',
            output_text: 'ƒ∞kinci satƒ±cƒ± se√ßiliyor...',
            next_root: '4:0',
            action_name: 'select_seller',
            priority: 9
        },
        
        // Reyon komutlarƒ±
        {
            root_code: '4:0',
            input_patterns: 'meyve|sebze|meyve sebze',
            output_text: 'Meyve ve sebze reyonu se√ßildi.',
            next_root: '5:0',
            action_name: 'select_category',
            priority: 10
        },
        {
            root_code: '4:0',
            input_patterns: 's√ºt|peynir|yoƒüurt|s√ºt √ºr√ºn',
            output_text: 'S√ºt √ºr√ºnleri reyonu se√ßildi.',
            next_root: '5:0',
            action_name: 'select_category',
            priority: 10
        },
        
        // √úr√ºn komutlarƒ±
        {
            root_code: '5:0',
            input_patterns: 'regex:(?<quantity>\d+)\s*(?<product>.*)',
            output_text: '{quantity} adet {product} sepete ekleniyor...',
            next_root: '5:0',
            action_name: 'add_to_cart',
            priority: 10
        },
        {
            root_code: '5:0',
            input_patterns: 'sepete git|sepetim|sepet',
            output_text: 'Sepetiniz a√ßƒ±lƒ±yor...',
            next_root: '6:0',
            action_name: 'manage_cart',
            priority: 9
        },
        
        // Sepet komutlarƒ±
        {
            root_code: '6:0',
            input_patterns: '√∂deme yap|√∂de|satƒ±n al',
            output_text: '√ñdeme y√∂ntemi se√ßiliyor...',
            next_root: '7:0',
            action_name: 'select_payment',
            priority: 10
        },
        
        // √ñdeme komutlarƒ±
        {
            root_code: '7:0',
            input_patterns: 'nakit|para',
            output_text: 'Nakit √∂deme se√ßildi.',
            next_root: '8:0',
            action_name: 'select_payment',
            priority: 10
        },
        {
            root_code: '7:0',
            input_patterns: 'kart|kredi|bank',
            output_text: 'Kart ile √∂deme se√ßildi.',
            next_root: '8:0',
            action_name: 'select_payment',
            priority: 10
        }
    ];

    // Varsayƒ±lan kurallarƒ± veritabanƒ±na kaydet
    for (const rule of defaultRules) {
        const { error } = await supabase
            .from('voice_command_rules')
            .insert([rule]);
        
        if (error) {
            console.error('Varsayƒ±lan kural ekleme hatasƒ±:', error);
        }
    }

    // Belleƒüe y√ºkle
    defaultRules.forEach(rule => {
        if (!commandRules.has(rule.root_code)) {
            commandRules.set(rule.root_code, []);
        }
        commandRules.get(rule.root_code).push(rule);
    });
}


// =============================================
// Dƒ∞NAMƒ∞K SES KOMUT ƒ∞≈ûLEME
// =============================================

// product_voice_matches tablosu i√ßin g√ºvenli sorgu fonksiyonu
// G√ºvenli ses e≈üle≈ütirme sorgusu
async function safeVoiceMatchQuery(userInput) {
    try {
        const cleanInput = userInput.toLowerCase()
            .replace(/√∂rneƒüin|mesela/g, '')
            .trim();
            
        const { data, error } = await supabase
            .from('product_voice_matches')
            .select('matched_product')
            .eq('user_input', cleanInput)
            .eq('success', true)
            .single();

        if (error) {
            if (error.code === '406' || error.message.includes('406')) {
                console.log('‚ö†Ô∏è Supabase 406 hatasƒ±, devam ediliyor:', cleanInput);
                return null;
            }
            throw error;
        }
        
        return data;
    } catch (error) {
        console.log('üîá Voice match sorgu hatasƒ± (g√ºvenli):', error.message);
        return null;
    }
}
        

async function processVoiceCommand(transcript) {
 const message = transcript.toLowerCase().trim();
    console.log(`üîä Sesli komut: "${message}" | K√∂k: ${currentRoot}`);
    
    // KENDƒ∞ MESAJIMIZI TEKRAR ALGILAMA KONTROL√ú
    if (transcript.trim() === lastSpokenMessage.trim()) {
        console.log("‚ö†Ô∏è Kendi cevabƒ±mƒ±z tekrar algƒ±landƒ±, atlandƒ±");
        return;
    }

    // GEREKSƒ∞Z KELƒ∞MELERƒ∞ Fƒ∞LTRELE
    const filteredMessage = filterUnnecessaryWords(message);
    if (!filteredMessage) {
        console.log("üîá Gereksiz mesaj filtrelendi");
        return;
    }
    
    console.log(`üéØ Filtrelenmi≈ü komut: "${filteredMessage}"`);

    try {
        // 1. √úR√úN EKLEME KOMUTU - √ñNCELƒ∞KLƒ∞
        if (selectedCategoryId && products.length > 0) {
            console.log('üõí √úr√ºn ekleme komutu kontrol ediliyor...');
            const success = await handleVoiceProductAdd(filteredMessage);
            if (success) {
                console.log('‚úÖ √úr√ºn ba≈üarƒ±yla eklendi');
                return;
            }
        }

        // 2. MAƒûAZA Tƒ∞Pƒ∞ SE√áƒ∞Mƒ∞
        if ((currentRoot === "2:0" || !selectedStoreTypeId) && hasStoreTypeKeywords(filteredMessage)) {
            console.log('üè™ Maƒüaza tipi se√ßim komutu algƒ±landƒ±');
            const success = await handleVoiceStoreSelection(filteredMessage);
            if (success) return;
        }

        // 3. SATICI SE√áƒ∞Mƒ∞
        if ((currentRoot === "3:0" || (selectedStoreTypeId && !selectedSellerId)) && hasSellerKeywords(filteredMessage)) {
            console.log('üè¨ Satƒ±cƒ± se√ßim komutu algƒ±landƒ±');
            const success = await handleVoiceSellerSelection(filteredMessage);
            if (success) return;
        }

        // 4. REYON SE√áƒ∞Mƒ∞
        if ((currentRoot === "4:0" || (selectedSellerId && !selectedCategoryId)) && hasCategoryKeywords(filteredMessage)) {
            console.log('üì¶ Reyon se√ßim komutu algƒ±landƒ±');
            const success = await handleVoiceCategorySelection(filteredMessage);
            if (success) return;
        }

       // FALLBACK MESAJI (cooldown kontrol√º ile)
        console.log('‚ùå Hi√ßbir komut i≈ülenemedi, fallback kontrol√º...');
        const fallbackMessage = getSmartFallback();
        if (fallbackMessage) {
            speakToUser(fallbackMessage);
        }

    } catch (error) {
        console.error('‚ùå Komut i≈üleme hatasƒ±:', error);
        // Hata mesajlarƒ±nda da cooldown
        if (Date.now() - lastSpeakTime > SPEAK_COOLDOWN) {
            speakToUser("Bir hata olu≈ütu, tekrar deneyin.");
        }
    }
}
// YARDIMCI FONKSƒ∞YONLAR
function filterUnnecessaryWords(message) {
    const unnecessary = [
        'l√ºtfen', 'rica', 'ediyorum', 'istiyorum', '√∂rneƒüin', 'mesela',
        '≈üey', 'falan', 'filan', 'gibi', 'yani', 'acaba'
    ];
    
    let filtered = message;
    unnecessary.forEach(word => {
        filtered = filtered.replace(new RegExp(word, 'g'), '');
    });
    
    return filtered.replace(/\s+/g, ' ').trim();
}

function shouldShowFallback(message) {
    // Sadece belirli aralƒ±klarla fallback g√∂ster
    const now = Date.now();
    const lastFallbackTime = window.lastFallbackTime || 0;
    
    if (now - lastFallbackTime < 5000) { // 5 saniyede bir
        return false;
    }
    
    window.lastFallbackTime = now;
    return true;
}

    function getSmartFallback() {
    const now = Date.now();
    
    // Fallback'ler arasƒ±nda da cooldown
    if (now - lastSpeakTime < SPEAK_COOLDOWN * 2) {
        return null; // Mesaj g√∂sterme
    }
    
    if (!selectedStoreTypeId) {
        const storeCards = document.querySelectorAll('.seller-type-card');
        if (storeCards.length > 0) {
            const storeList = Array.from(storeCards)
                .slice(0, 3)
                .map(card => `${card.dataset.typeIndex}. ${card.querySelector('.seller-type-name')?.textContent}`)
                .join(', ');
            return `Hangi maƒüaza tipi? ${storeList}`;
        }
        return "Maƒüaza tipi se√ßin: Market, Restoran...";
    }
    
    if (!selectedSellerId) {
        return "Bir satƒ±cƒ± se√ßin. ƒ∞sim veya numara s√∂yleyin.";
    }
    
    if (!selectedCategoryId) {
        return "Bir reyon se√ßin: Manav, S√ºt √úr√ºnleri...";
    }
    
    if (selectedCategoryId && products.length > 0) {
        const productCards = document.querySelectorAll('.product-card');
        if (productCards.length > 0) {
            const productList = Array.from(productCards)
                .slice(0, 2) // Sadece 2 √ºr√ºn g√∂ster
                .map(card => `${card.dataset.productIndex}. ${card.querySelector('.product-name')?.textContent}`)
                .join(', ');
            return `√úr√ºn se√ßin: ${productList}`;
        }
    }
    
    return "Nasƒ±l yardƒ±mcƒ± olabilirim?";
}
        
// YARDIMCI FONKSƒ∞YONLAR
function hasStoreTypeKeywords(message) {
    const keywords = ['market', 'restoran', 'eczane', 'fƒ±rƒ±n', 'kafe', 'maƒüaza', 'tip'];
    return keywords.some(keyword => message.includes(keyword));
}

function hasSellerKeywords(message) {
    const keywords = ['satƒ±cƒ±', 'yer', 'd√ºkkan', 'market', 'birinci', 'ikinci', '√º√ß√ºnc√º'];
    return keywords.some(keyword => message.includes(keyword)) || 
           /\d/.test(message); // Sayƒ± i√ßeriyorsa
}

function hasCategoryKeywords(message) {
    const keywords = ['reyon', 'manav', 'kasap', 'fƒ±rƒ±n', '≈üark√ºteri', 'i√ßecek', 's√ºt', 'meyve', 'sebze'];
    return keywords.some(keyword => message.includes(keyword));
}

function hasProductKeywords(message) {
    const keywords = ['kilo', 'gram', 'paket', 'adet', 'tane', 'litre', 'lt', 'yarƒ±m', '√ßeyrek'];
    return keywords.some(keyword => message.includes(keyword)) || 
           /\d+\s*\w+/.test(message);
}

function getCurrentStatus() {
    let status = "Mevcut durum: ";
    
    if (!selectedStoreTypeId) {
        status += "Maƒüaza tipi se√ßilmedi. ";
    } else {
        status += `Maƒüaza tipi: ${selectedStoreTypeName}. `;
    }
    
    if (!selectedSellerId) {
        status += "Satƒ±cƒ± se√ßilmedi. ";
    } else {
        const seller = sellers.find(s => s.id === selectedSellerId);
        status += `Satƒ±cƒ±: ${seller?.business_name}. `;
    }
    
    if (!selectedCategoryId) {
        status += "Kategori se√ßilmedi.";
    } else {
        const category = categories.find(c => c.id === selectedCategoryId);
        status += `Kategori: ${category?.name}.`;
    }
    
    return status;
}

// G√úNCELLENMƒ∞≈û getContextualFallback - Daha az tekrarlayan mesaj
function getContextualFallback() {
    // Mevcut durumu kontrol et
    const status = getCurrentStatus();
    
    if (!selectedStoreTypeId) {
        const availableTypes = storeTypes.map(st => st.name).join(', ');
        return `Hangi maƒüaza tipinden alƒ±≈üveri≈ü yapmak istersiniz? ${availableTypes}`;
    }
    
    if (!selectedSellerId) {
        return "L√ºtfen bir satƒ±cƒ± se√ßin. Satƒ±cƒ± ismi veya numarasƒ± s√∂yleyebilirsiniz.";
    }
    
    if (!selectedCategoryId) {
        const categoryList = categories.slice(0, 3).map(c => c.name).join(', ');
        return `Hangi reyondan alƒ±≈üveri≈ü yapmak istersiniz? ${categoryList}`;
    }
    
    // √úr√ºn ekleme a≈üamasƒ±nda √∂rnek verme
    if (products.length > 0) {
        const sampleProducts = products.slice(0, 2).map(p => p.name).join(', ');
        return `√úr√ºn sipari≈üi verebilirsiniz. √ñrneƒüin: "1 kilo ${sampleProducts.split(',')[0]}"`;
    }
    
    return "Nasƒ±l yardƒ±mcƒ± olabilirim?";
}

// Basit durum mesajƒ±
function getCurrentStatus() {
    let status = [];
    if (selectedStoreTypeId) status.push(`Maƒüaza: ${selectedStoreTypeName}`);
    if (selectedSellerId) {
        const seller = sellers.find(s => s.id === selectedSellerId);
        if (seller) status.push(`Satƒ±cƒ±: ${seller.business_name}`);
    }
    if (selectedCategoryId) {
        const category = categories.find(c => c.id === selectedCategoryId);
        if (category) status.push(`Reyon: ${category.name}`);
    }
    return status.join(' | ');
}


        
// Yardƒ±mcƒ± fonksiyonlar
function hasProductKeywords(message) {
    const keywords = ['kilo', 'gram', 'paket', 'adet', 'tane', 'litre', 'lt', 'yarƒ±m', '√ßeyrek'];
    return keywords.some(keyword => message.includes(keyword)) || 
           /\d+\s*\w+/.test(message); // Sayƒ± + kelime pattern'i
}


        
        
// Ekranda detaylƒ± mesaj g√∂sterme fonksiyonu
function displayMessage(msg) {
    // Mevcut assistantMessage elementini kullan
    if (assistantMessage) {
        assistantMessage.textContent = msg;
        
        // Mesaj stilini ayarla (ba≈üarƒ±/ba≈üarƒ±sƒ±zlƒ±k)
        if (msg.includes('‚úÖ') || msg.includes('Eklendi')) {
            assistantMessage.style.background = 'rgba(40, 167, 69, 0.1)';
            assistantMessage.style.color = 'var(--success)';
            assistantMessage.style.borderLeft = '4px solid var(--success)';
        } else if (msg.includes('‚ùå') || msg.includes('Hata')) {
            assistantMessage.style.background = 'rgba(220, 53, 69, 0.1)';
            assistantMessage.style.color = 'var(--danger)';
            assistantMessage.style.borderLeft = '4px solid var(--danger)';
        } else {
            assistantMessage.style.background = 'rgba(93, 62, 188, 0.1)';
            assistantMessage.style.color = 'var(--dark)';
            assistantMessage.style.borderLeft = '4px solid var(--primary)';
        }
    }
    
    // Ayrƒ±ca console'da da g√∂ster
    console.log('üì± Display Message:', msg);
}

// üõí Sepet kontrol
function cartHasItems() {
    return cart && cart.length > 0;
}



// Sepet temizleme komutlarƒ±nƒ± tespit et
function isClearCartCommand(message) {
    const clearCommands = [
        'sepeti bo≈üalt', 'sepeti temizle', 'her ≈üeyi sil', 'sƒ±fƒ±rla',
        'clear cart', 'empty cart', 'reset cart', 'temizle'
    ];
    
    return clearCommands.some(cmd => message.includes(cmd));
}

// Maƒüaza deƒüi≈ütirme komutlarƒ±nƒ± tespit et
function isStoreChangeCommand(message) {
    const changeCommands = [
        'market', 'restoran', 'eczane', 'fƒ±rƒ±n', 'kafe',
        'maƒüaza', 'd√ºkkan', 'satƒ±cƒ±', 'yer',
        'deƒüi≈ütir', 'ba≈üka', 'diƒüer', 'farklƒ±', 'yeni',
        'birinci', 'ikinci', '√º√ß√ºnc√º', 'd√∂rd√ºnc√º',
        '1.', '2.', '3.', '4.', '1 ', '2 ', '3 ', '4 '
    ];
    
    return changeCommands.some(cmd => message.includes(cmd));
}

// G√úNCELLENMƒ∞≈û handleContextualCommand - Store Type kontrol√º ekle
// GELƒ∞≈ûTƒ∞Rƒ∞LMƒ∞≈û handleContextualCommand - Detaylƒ± Debug
async function handleContextualCommand(message) {
    console.log(`üîç Baƒülamsal komut kontrol√º: "${message}"`);
    
    // Kontroller
    if (!selectedStoreTypeId) {
        speakToUser("√ñnce bir maƒüaza tipi se√ßmelisiniz.");
        return false;
    }
    
    if (!selectedSellerId) {
        speakToUser("L√ºtfen bir satƒ±cƒ± se√ßin.");
        return false;
    }
    
    if (!selectedCategoryId || products.length === 0) {
        speakToUser("√ñnce bir kategori se√ßmelisiniz.");
        return false;
    }
    
    try {
        console.log('üì¶ √úr√ºn bilgisi √ßƒ±karƒ±lƒ±yor...');
        const productInfo = await extractProductInfoFromCommand(message);
        
        if (!productInfo || !productInfo.productName) {
            console.log('‚ùå √úr√ºn bilgisi √ßƒ±karƒ±lamadƒ±');
            // HATA AYIKLAMA: Neden √ßƒ±karƒ±lamadƒ±?
            console.log('üí° HATA NEDENLERƒ∞:');
            console.log('   - "√∂rneƒüin" kelimesi var mƒ±?', message.includes('√∂rneƒüin'));
            console.log('   - Temiz mesaj:', message.toLowerCase().replace(/√∂rneƒüin/g, '').trim());
            console.log('   - Mevcut √ºr√ºnler:', products.map(p => p.name));
            return false;
        }

        console.log('‚úÖ √áƒ±karƒ±lan √ºr√ºn bilgisi:', productInfo);
        console.log('üîç √úr√ºn aranƒ±yor:', productInfo.productName);

        const product = findProductByName(productInfo.productName);
        
        if (product) {
            console.log('üéØ √úr√ºn bulundu:', product.name);
            
            // Kilit kontrol√º
            if (isSellerLocked) {
                const firstCartItem = cart[0];
                if (firstCartItem && firstCartItem.seller_id !== selectedSellerId) {
                    const currentSeller = sellers.find(s => s.id === firstCartItem.seller_id);
                    speakToUser(`Sepet dolu. Sadece ${currentSeller?.business_name} ile alƒ±≈üveri≈üe devam edebilirsiniz.`);
                    return true;
                }
            }
            
            // SEPETE EKLE
            console.log('üõí Sepete ekleniyor:', `${productInfo.quantity} ${productInfo.unit} ${product.name}`);
            addToCart(product, productInfo.quantity);
            speakToUser(`${productInfo.quantity} ${productInfo.unit} ${product.name} sepete eklendi.`);
            
            return true;
        } else {
            console.log('‚ùå √úr√ºn bulunamadƒ±:', productInfo.productName);
            console.log('üí° Mevcut √ºr√ºnler:', products.map(p => p.name));
            handleDynamicProductNotFound(message, productInfo.productName);
            return true;
        }
    } catch (error) {
        console.error('‚ùå Baƒülamsal komut hatasƒ±:', error);
        return false;
    }
}
        
// ACƒ∞L TEST FONKSƒ∞YONU - Hemen √ßalƒ±≈ütƒ±rƒ±n!
function emergencyTest() {
    console.log('üö® ACƒ∞L TEST BA≈ûLIYOR...');
    
    const testCases = [
        "1 kilo domates",
        "√∂rneƒüin 1 kilo domates", 
        "2 paket s√ºt",
        "bir kilo soƒüan",
        "domates",
        "√∂rneƒüin domates",
        "3 kilo √ßarliston biber",
        "yarƒ±m kilo peynir"
    ];
    
    testCases.forEach((testCase, index) => {
        console.log(`\n--- TEST ${index + 1}: "${testCase}" ---`);
        
        const result = extractProductInfoFromCommand(testCase);
        console.log('üì¶ SONU√á:', result);
        
        if (result && products.length > 0) {
            const found = findProductByName(result.productName);
            console.log('üîç BULUNDU MU?:', found ? `EVET - ${found.name}` : 'HAYIR');
            
            if (found) {
                console.log('üõí SEPETE EKLENEBƒ∞Lƒ∞R:', `${result.quantity} ${result.unit} ${found.name}`);
            }
        }
    });
    
    console.log('\nüéØ TEST TAMAMLANDI');
}

// HEMEN √áALI≈ûTIR: Console'da ≈üunu yazƒ±n:
// emergencyTest()

// ACƒ∞L MANUEL √á√ñZ√úM - Hemen test edin
function manualProductAddTest() {
    console.log('üõ†Ô∏è MANUEL √úR√úN EKLEME TESTƒ∞');
    
    if (products.length === 0) {
        console.log('‚ùå √úr√ºn listesi bo≈ü');
        return;
    }
    
    console.log('üì¶ Mevcut √ºr√ºnler:', products.map(p => p.name));
    
    // Manuel olarak "domates" √ºr√ºn√ºn√º bul ve sepete ekle
    const product = findProductByName("domates");
    
    if (product) {
        console.log('‚úÖ Domates bulundu, sepete ekleniyor...');
        addToCart(product, 1);
        console.log('üéâ Domates sepete eklendi!');
        speakToUser("1 adet domates sepete eklendi.");
    } else {
        console.log('‚ùå Domates bulunamadƒ±');
    }
}

// HEMEN √áALI≈ûTIR: Console'da ≈üunu yazƒ±n:
// manualProductAddTest()

// FALLBACK: Eƒüer hala √ßalƒ±≈ümazsa bu fonksiyonu kullanƒ±n
function superSimpleExtract(message) {
    console.log('üîÑ S√úPER BASƒ∞T √á√ñZ√úM:', message);
    
    // Sadece sayƒ±larƒ± ve √ºr√ºn adƒ±nƒ± ayƒ±r
    const numberMatch = message.match(/\d+/);
    const quantity = numberMatch ? parseInt(numberMatch[0]) : 1;
    
    // √úr√ºn adƒ±nƒ± bul (sayƒ±larƒ± ve birimleri temizle)
    let productName = message
        .replace(/\d+/g, '')
        .replace(/kilo|kg|paket|adet|tane|litre|lt|yarƒ±m|√ßeyrek|√∂rneƒüin|mesela/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    
    // Temel d√ºzeltmeler
    const fixes = {
        'domat': 'domates', 'sogan': 'soƒüan', 'salatalik': 'salatalƒ±k',
        'patat': 'patates', 'carliston': '√ßarliston biber', 'viber': '√ßarliston biber'
    };
    
    for (const [wrong, correct] of Object.entries(fixes)) {
        if (productName.includes(wrong)) {
            productName = productName.replace(wrong, correct);
        }
    }
    
    console.log('üéØ S√úPER BASƒ∞T SONU√á:', { productName, quantity, unit: 'adet' });
    return { productName, quantity, unit: 'adet' };
}

// Acil durumda bu satƒ±rƒ± a√ßƒ±n:
// extractProductInfoFromCommand = superSimpleExtract;
// Acil durumda bu satƒ±rƒ± a√ßƒ±n:
// extractProductInfoFromCommand = superSimpleExtract;
        
// Sepeti tamamen bo≈üaltma fonksiyonu
function clearCart() {
    console.log('üóëÔ∏è Sepet tamamen bo≈üaltƒ±lƒ±yor...');
    console.log('üìä √ñnceki sepet:', cart.length, '√ºr√ºn');
    
    cart = [];
    
    // HEMEN G√úNCELLE
    updateCartUI();
    
    // Kilidi kesinlikle kaldƒ±r
    unlockStoreAndSeller();
    
    speakToUser("Sepet bo≈üaltƒ±ldƒ±. Artƒ±k ba≈üka maƒüazalardan alƒ±≈üveri≈ü yapabilirsiniz.");
    
    // Sepet kapatƒ±lsƒ±n
    closeDynamicCart();
    
    console.log('‚úÖ Sepet tamamen bo≈üaltƒ±ldƒ±');
}
// Sepet UI'sƒ±na temizleme butonu ekle
// Sepet UI'sƒ±na temizleme butonu ekle
function addClearCartButton() {
    const cartItems = document.getElementById('cartItems');
    if (!cartItems) return;
    
    // Temizleme butonu yoksa ekle
    if (!document.getElementById('clearCartBtn') && cart.length > 0) {
        const clearBtn = document.createElement('button');
        clearBtn.id = 'clearCartBtn';
        clearBtn.innerHTML = '<i class="fas fa-trash"></i> Sepeti Bo≈üalt';
        clearBtn.style.cssText = `
            width: 100%;
            padding: 12px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            margin-top: 10px;
            cursor: pointer;
            font-weight: 600;
        `;
        
        clearBtn.addEventListener('click', function() {
            if (confirm('Sepeti tamamen bo≈üaltmak istediƒüinizden emin misiniz?')) {
                clearCart();
            }
        });
        
        cartItems.parentNode.insertBefore(clearBtn, cartItems.nextSibling);
    }
    
    // Sepet bo≈üsa butonu kaldƒ±r
    if (document.getElementById('clearCartBtn') && cart.length === 0) {
        document.getElementById('clearCartBtn').remove();
    }
}


        // Kategori ismine g√∂re bulma
function findCategoryByName(categoryName) {
    const cleanName = categoryName.toLowerCase().trim();
    
    // Tam e≈üle≈üme
    let category = categories.find(cat => 
        cat.name.toLowerCase() === cleanName
    );
    
    if (category) return category;
    
    // Kƒ±smi e≈üle≈üme
    category = categories.find(cat => 
        cat.name.toLowerCase().includes(cleanName) ||
        cleanName.includes(cat.name.toLowerCase())
    );
    
    if (category) return category;
    
    // Anahtar kelime e≈üle≈ümesi
    const keywordMap = {
        'meyve': 'Manav',
        'sebze': 'Manav', 
        'manav': 'Manav',
        's√ºt': 'S√ºt √úr√ºnleri',
        'peynir': 'S√ºt √úr√ºnleri',
        'yoƒüurt': 'S√ºt √úr√ºnleri',
        'et': 'Kasap',
        'tavuk': 'Kasap',
        'balƒ±k': 'Balƒ±k',
        'i√ßecek': 'ƒ∞√ßecekler',
        'su': 'ƒ∞√ßecekler',
        'me≈ürubat': 'ƒ∞√ßecekler'
    };
    
    for (const [keyword, categoryName] of Object.entries(keywordMap)) {
        if (cleanName.includes(keyword)) {
            return categories.find(cat => cat.name === categoryName);
        }
    }
    
    return null;
}

// Satƒ±cƒ±yƒ± komuta g√∂re bulma
function findSellerByCommand(message) {
    const cleanMessage = message.toLowerCase().trim();
    
    // Sayƒ±sal se√ßim (birinci, ikinci, 1., 2. vb.)
    const numberMatch = cleanMessage.match(/(birinci|ikinci|√º√ß√ºnc√º|d√∂rd√ºnc√º|1\.|2\.|3\.|4\.|1|2|3|4)/);
    if (numberMatch) {
        const numbers = {
            'birinci': 0, '1.': 0, '1': 0,
            'ikinci': 1, '2.': 1, '2': 1, 
            '√º√ß√ºnc√º': 2, '3.': 2, '3': 2,
            'd√∂rd√ºnc√º': 3, '4.': 3, '4': 3
        };
        const index = numbers[numberMatch[0]];
        if (index < sellers.length) {
            return sellers[index];
        }
    }
    
    // ƒ∞simle arama
    for (const seller of sellers) {
        if (cleanMessage.includes(seller.business_name.toLowerCase())) {
            return seller;
        }
    }
    
    return null;
}
        
// Dinamik kural e≈üle≈ütirme
async function findDynamicRuleMatch(message, root) {
    const rules = commandRules.get(root) || [];
    
    for (const rule of rules) {
        const patterns = rule.input_patterns.split('|');
        for (const pattern of patterns) {
            const matchResult = matchesDynamicPattern(message, pattern);
            if (matchResult.matches) {
                return { 
                    rule, 
                    pattern, 
                    extractedData: matchResult.extractedData 
                };
            }
        }
    }
    return null;
}

// Dinamik pattern e≈üle≈ütirme
function matchesDynamicPattern(message, pattern) {
    const result = { matches: false, extractedData: {} };
    
    if (pattern.startsWith('regex:')) {
        const regexPattern = pattern.replace('regex:', '');
        const regex = new RegExp(regexPattern, 'i');
        const match = message.match(regex);
        
        if (match) {
            result.matches = true;
            if (match.groups) {
                result.extractedData = match.groups;
            }
        }
    } else if (message.includes(pattern)) {
        result.matches = true;
        result.extractedData = { text: pattern };
    }
    
    return result;
}

// E≈üle≈üen kuralƒ± √ßalƒ±≈ütƒ±r
async function executeDynamicMatchedRule(match, message) {
    const { rule, extractedData } = match;
    
    // Dinamik √ßƒ±ktƒ± hazƒ±rla
    let output = rule.output_text;
    for (const [key, value] of Object.entries(extractedData)) {
        output = output.replace(`{${key}}`, value);
    }
    
    // Sesli cevap ver
    speakToUser(output);
    
    // Dinamik aksiyonu √ßalƒ±≈ütƒ±r
    if (rule.action_name) {
        await executeDynamicAction(rule.action_name, { 
            extractedData, 
            message 
        });
    }
    
    // K√∂k ge√ßi≈üini y√∂net
    if (rule.next_root) {
        if (rule.next_root.includes('?')) {
            pendingResponse = { nextRoot: rule.next_root, context: extractedData };
        } else {
            currentRoot = rule.next_root;
        }
    }
}

// =============================================
// Dƒ∞NAMƒ∞K AKSƒ∞YON FONKSƒ∞YONLARI
// =============================================

async function executeDynamicAction(actionName, data) {
    console.log(`‚ö° Dinamik Aksiyon: ${actionName}`, data);
    
    try {
        switch(actionName) {
            // KONUM AKSƒ∞YONLARI
            case 'show_location_modal':
                showDynamicLocationModal();
                break;
                
            case 'select_location':
                await handleDynamicLocationSelection(data);
                break;
                
            // MAƒûAZA Tƒ∞Pƒ∞ AKSƒ∞YONLARI
            case 'select_store_type':
                await handleDynamicStoreTypeSelection(data);
                break;
                
            // SATICI AKSƒ∞YONLARI
            case 'select_seller':
                await handleDynamicSellerSelection(data);
                break;
                
            // REYON AKSƒ∞YONLARI
            case 'select_category':
                await handleDynamicCategorySelection(data);
                break;
                
            // √úR√úN AKSƒ∞YONLARI
            case 'add_to_cart':
                await handleDynamicAddToCart(data);
                break;
                
            // SEPET AKSƒ∞YONLARI
            case 'manage_cart':
                await handleDynamicCartManagement(data);
                break;
                
            // √ñDEME AKSƒ∞YONLARI
            case 'select_payment':
                await handleDynamicPaymentSelection(data);
                break;
                
            // Sƒ∞STEM AKSƒ∞YONLARI
            case 'navigate_back':
                await handleDynamicNavigation(data);
                break;
                
            case 'show_help':
                await handleDynamicHelp(data);
                break;
                
            default:
                await handleUnknownDynamicAction(actionName, data);
        }
    } catch (error) {
        console.error(`Dinamik aksiyon hatasƒ± (${actionName}):`, error);
        speakToUser("√úzg√ºn√ºm, bir hata olu≈ütu. L√ºtfen tekrar deneyin.");
    }
}

// =============================================
// Dƒ∞NAMƒ∞K KONUM Sƒ∞STEMƒ∞
// =============================================

function showDynamicLocationModal() {
    const modal = document.getElementById('locationModal');
    if (!modal) return;

    document.body.classList.add('modal-open');
    modal.style.display = 'flex';
    modal.style.zIndex = '10000';
    
    updateDynamicLocationModal();
    setupDynamicModalCloseEvents();
    
    debugLog('üìç Dinamik konum modalƒ± g√∂sterildi');
    speakToUser("L√ºtfen konumunuzu se√ßin: restoran i√ßi, paket servis veya adrese teslim.");
}

function updateDynamicLocationModal() {
    const locationModal = document.getElementById('locationModal');
    if (!locationModal) return;
    
    locationModal.querySelector('.modal-body').innerHTML = `
        <div class="modal-header">
            <h3>Konum Se√ßiniz</h3>
            <span class="close-modal" id="closeLocationModal">&times;</span>
        </div>
        <p>Sipari≈üiniz i√ßin l√ºtfen konumunuzu belirleyin:</p>
        
        <div class="location-options">
            <div class="location-option" data-location="inside">
                <div class="location-icon">
                    <i class="fas fa-utensils"></i>
                </div>
                <div class="location-details">
                    <h4>Restoran i√ßinde</h4>
                    <p>Yemeƒüinizi restoranda yiyin</p>
                </div>
            </div>
            
            <div class="location-option" data-location="takeaway">
                <div class="location-icon">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <div class="location-details">
                    <h4>Paket servis</h4>
                    <p>Yemeƒüinizi kendiniz alƒ±n</p>
                </div>
            </div>
            
            <div class="location-option" data-location="delivery">
                <div class="location-icon">
                    <i class="fas fa-motorcycle"></i>
                </div>
                <div class="location-details">
                    <h4>Adrese teslim</h4>
                    <p>Yemeƒüiniz adresinize gelsin</p>
                </div>
            </div>
        </div>

        <button id="detectLocationBtn" class="location-detect-btn">
            <i class="fas fa-location-arrow"></i>
            Konumumu Otomatik Belirle
        </button>
        
        <div id="locationResult" class="location-result" style="display: none;"></div>
    `;
    
    setupDynamicLocationOptionEvents();
}

async function handleDynamicLocationSelection(data) {
    const locationType = data.extractedData?.location;
    
    if (!locationType) {
        speakToUser("Konum tipi belirtilmedi. L√ºtfen restoran i√ßi, paket servis veya adrese teslim se√ßin.");
        return;
    }
    
    // Adrese teslim i√ßin konum tespiti gerekli
    if (locationType === 'delivery' && !isLocationDetected) {
        const success = await detectUserLocation();
        if (!success) {
            speakToUser("Adrese teslim i√ßin konumunuzu tespit edemiyorum. L√ºtfen manuel olarak konumunuzu belirleyin.");
            return;
        }
    }
    
    selectDynamicLocation(locationType);
}

// Konum se√ßildiƒüinde doƒüru akƒ±≈üƒ± ba≈ülat
function selectDynamicLocation(locationType) {
    selectedLocation = locationType;
    localStorage.setItem('selectedLocation', locationType);
    
    if (userLocation) {
        localStorage.setItem('userLocation', JSON.stringify(userLocation));
    }
    
    updateDynamicLocationText();
    hideDynamicLocationModal();
    
    // DOƒûRU K√ñK BA≈ûLANGICI - Store Type se√ßimine y√∂nlendir
    currentRoot = "2:0";
    
    // Konum se√ßildiƒüinde t√ºm satƒ±cƒ±larƒ± y√ºkle ama store type se√ßimini bekle
    loadAllSellersByLocation();
    
    const locationNames = {
        'inside': 'Restoran i√ßinde',
        'takeaway': 'Paket servis', 
        'delivery': 'Adrese teslim'
    };
    
    let locationMessage = `${locationNames[locationType]} se√ßildi.`;
    if (locationType === 'delivery' && userLocation.city) {
        locationMessage += ` Konumunuz: ${userLocation.district}, ${userLocation.city}.`;
    }
    
    locationMessage += " Hangi maƒüaza tipinden alƒ±≈üveri≈ü yapmak istersiniz? Market, restoran veya eczane diyebilirsiniz.";
    
    speakToUser(locationMessage);
}
// =============================================
// Dƒ∞NAMƒ∞K MAƒûAZA Tƒ∞Pƒ∞ Sƒ∞STEMƒ∞
// =============================================

async function handleDynamicStoreTypeSelection(data) {
    const storeTypeName = data.extractedData?.storeType || await extractStoreTypeFromMessage(data.message);
    
    if (!storeTypeName) {
        const availableStoreTypes = await getAvailableStoreTypes();
        speakToUser(`Hangi maƒüaza tipini se√ßmek istiyorsunuz? ${availableStoreTypes}`);
        return;
    }
    
    const storeType = await findStoreTypeByName(storeTypeName);
    if (storeType) {
        await onStoreTypeSelected(storeType.id, storeType.name);
    } else {
        const availableStoreTypes = await getAvailableStoreTypes();
        speakToUser(`"${storeTypeName}" bulunamadƒ±. Mevcut maƒüaza tipleri: ${availableStoreTypes}`);
    }
}

// Store Type se√ßildiƒüinde otomatik satƒ±cƒ± se√ßimini engelle
async function onStoreTypeSelected(storeTypeId, storeTypeName) {
    // Kilit kontrol√º
    if (isSellerLocked) {
        const currentSeller = sellers.find(s => s.id === selectedSellerId);
        speakToUser(`Sepet dolu. Sadece ${currentSeller?.business_name || 'mevcut maƒüaza'} ile alƒ±≈üveri≈üe devam edebilirsiniz.`);
        return;
    }
    
    debugLog("üõçÔ∏è Store type se√ßildi:", storeTypeName, "ID:", storeTypeId);
   
    selectedStoreTypeId = storeTypeId;
    selectedStoreTypeName = storeTypeName;
    
    // SATICIYI OTOMATƒ∞K SE√áME - SADECE Fƒ∞LTRELE
    filterSellersByStoreType(storeTypeId);
    
    // KATEGORƒ∞ ve √úR√úNLERƒ∞ TEMƒ∞ZLE - yeni se√ßim i√ßin
    selectedSellerId = null;
    selectedCategoryId = null;
    products = [];
    resetProductAndCategoryUI();
    
    // K√ñK√ú G√úNCELLE - STORE TYPE SE√áƒ∞LDƒ∞, SATICI BEKLENƒ∞YOR
    currentRoot = "3:0";
    debugLog(`üîÑ K√∂k g√ºncellendi: 2:0 -> 3:0 (Store type se√ßildi: ${storeTypeName})`);
    
    speakToUser(`${storeTypeName} se√ßildi. ${filteredSellers.length} satƒ±cƒ± bulundu. L√ºtfen bir satƒ±cƒ± se√ßin.`);
}
        
// Maƒüaza tipi se√ßimi
async function handleVoiceStoreSelection(message) {
    console.log('üè™ Sesli maƒüaza tipi se√ßimi:', message);
    
    const storeCards = document.querySelectorAll('.seller-type-card');
    if (!storeCards.length) {
        displayMessage("‚ùå Maƒüaza listesi y√ºkleniyor, l√ºtfen bekleyin.");
        speakToUser("maƒüaza se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
        return false;
    }

    const cleanMessage = message.toLowerCase().trim();
    let selectedCard = null;


    console.log('üîç Maƒüaza arama:', cleanMessage);
    console.log('üìã Mevcut maƒüazalar:', Array.from(storeCards).map(card => 
        `${card.querySelector('.seller-type-name')?.textContent} (${card.dataset.typeIndex})`
    ));

    // 1. SAYISAL SE√áƒ∞M (birinci, ikinci, 1, 2 vb.)
    const numberMap = {
        'birinci': 1, 'bir': 1, '1': 1, '1.': 1,
        'ikinci': 2, 'iki': 2, '2': 2, '2.': 2,
        '√º√ß√ºnc√º': 3, '√º√ß': 3, '3': 3, '3.': 3,
        'd√∂rd√ºnc√º': 4, 'd√∂rt': 4, '4': 4, '4.': 4,
        'be≈üinci': 5, 'be≈ü': 5, '5': 5, '5.': 5,
        'altƒ±ncƒ±': 6, 'altƒ±': 6, '6': 6, '6.': 6,
        'yedinci': 7, 'yedi': 7, '7': 7, '7.': 7,
        'sekizinci': 8, 'sekiz': 8, '8': 8, '8.': 8,
        'dokuzuncu': 9, 'dokuz': 9, '9': 9, '9.': 9,
        'onuncu': 10, 'on': 10, '10': 10, '10.': 10
    };

    if (numberMap[cleanMessage] !== undefined) {
        const targetNumber = numberMap[cleanMessage];
        selectedCard = Array.from(storeCards).find(card => 
            parseInt(card.dataset.typeIndex) === targetNumber
        );
        
        if (selectedCard) {
            console.log(`‚úÖ Sayƒ±sal se√ßim: ${targetNumber}. maƒüaza`);
        }
    }

    // 2. DOƒûRUDAN ƒ∞Sƒ∞M E≈ûLE≈ûMESƒ∞
    if (!selectedCard) {
        for (const card of storeCards) {
            const typeName = card.querySelector('.seller-type-name')?.textContent.toLowerCase();
            const dataName = card.dataset.typeName?.toLowerCase();
            
            const cardName = typeName || dataName;
            if (!cardName) continue;

            console.log(`üîç Kontrol: "${cardName}" vs "${cleanMessage}"`);

            if (cleanMessage.includes(cardName) || cardName.includes(cleanMessage)) {
                selectedCard = card;
                console.log(`‚úÖ ƒ∞sim e≈üle≈ümesi: "${cardName}"`);
                break;
            }
        }
    }

    // 3. ANAHTAR KELƒ∞ME E≈ûLE≈ûMESƒ∞
    if (!selectedCard) {
        const keywordMap = {
            'market': 'Market', 's√ºpermarket': 'Market', 'bakkal': 'Market',
            'restoran': 'Restoran', 'lokanta': 'Restoran', 'yemek': 'Restoran',
            'fast food': 'Fast Food', 'fastfood': 'Fast Food',
            'pastane': 'Pastane', 'fƒ±rƒ±n': 'Pastane',
            'eczane': 'Eczane', 'ila√ß': 'Eczane',
            'kafe': 'Kafe', 'kahve': 'Kafe',
            'alkol': 'Alkol', 'i√ßki': 'Alkol',
            'pet shop': 'Pet Shop', 'pet': 'Pet Shop', 'hayvan': 'Pet Shop',
            '√ßi√ßek': '√ái√ßek√ßi', '√ßi√ßek√ßi': '√ái√ßek√ßi',
            '√ßar≈üƒ±': '√áar≈üƒ±', 'avm': '√áar≈üƒ±'
        };

        for (const [keyword, storeType] of Object.entries(keywordMap)) {
            if (cleanMessage.includes(keyword)) {
                selectedCard = Array.from(storeCards).find(card => 
                    card.querySelector('.seller-type-name')?.textContent === storeType
                );
                if (selectedCard) {
                    console.log(`‚úÖ Anahtar kelime e≈üle≈ümesi: "${keyword}" -> "${storeType}"`);
                    break;
                }
            }
        }
    }

    if (selectedCard) {
        try {
            selectedCard.click();
            
            const storeTypeName = selectedCard.querySelector('.seller-type-name')?.textContent || 'Maƒüaza';
            const storeNumber = selectedCard.dataset.typeIndex;
            
            // ‚úÖ EKRANDA DETAYLI G√ñSTER
            displayMessage(`‚úÖ ${storeNumber}. ${storeTypeName} se√ßildi. ≈ûimdi bir satƒ±cƒ± se√ßin.`);
            
            // ‚úÖ SESLƒ∞: Sadece temel onay
            speakToUser("se√ßildi");
            
            currentRoot = "3:0";
            return true;
            
        } catch (error) {
            console.error('‚ùå Maƒüaza tipi se√ßim hatasƒ±:', error);
            displayMessage("‚ùå Maƒüaza se√ßiminde hata olu≈ütu.");
            speakToUser("hata");
            return false;
        }
    }

    // Bulunamadƒ±ysa
    const availableStores = Array.from(storeCards)
        .slice(0, 5)
        .map(card => `${card.dataset.typeIndex}. ${card.querySelector('.seller-type-name')?.textContent}`)
        .filter(name => name)
        .join(', ');
    
    displayMessage(`‚ùå Maƒüaza bulunamadƒ±. Mevcut maƒüazalar: ${availableStores}`);
    speakToUser("maƒüaza se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
    return false;
}       

async function handleVoiceProductAdd(message) {
    console.log('üéØ Sesli √ºr√ºn ekleme:', message);
    
    // Kontroller - SESLƒ∞: Se√ßim √∂ncesi mesajlar
    if (!selectedStoreTypeId) {
        displayMessage("‚ùå √ñnce bir maƒüaza tipi se√ßmelisiniz.");
        speakToUser("maƒüaza se√ßin");
        return false;
    }
    
    if (!selectedSellerId) {
        displayMessage("‚ùå L√ºtfen bir satƒ±cƒ± se√ßin.");
        speakToUser("satƒ±cƒ± se√ßin");
        return false;
    }
    
    if (!selectedCategoryId || products.length === 0) {
        displayMessage("‚ùå √ñnce bir kategori se√ßmelisiniz.");
        speakToUser("reyon se√ßin");
        return false;
    }
    
    try {
        const cleanMessage = message.toLowerCase().trim();
        let selectedProduct = null;
        let quantity = 1;

        console.log('üîç Komut analizi:', cleanMessage);

        // 1. √ñNCE SAYISAL SE√áƒ∞M KONTROL√ú (numara ile)
        const numberMap = {
            'birinci': 1, 'bir': 1, '1': 1, '1.': 1,
            'ikinci': 2, 'iki': 2, '2': 2, '2.': 2,
            '√º√ß√ºnc√º': 3, '√º√ß': 3, '3': 3, '3.': 3,
            'd√∂rd√ºnc√º': 4, 'd√∂rt': 4, '4': 4, '4.': 4,
            'be≈üinci': 5, 'be≈ü': 5, '5': 5, '5.': 5
        };

        // SAYISAL SE√áƒ∞M PATTERNLERƒ∞
        let targetNumber = null;
        let explicitQuantity = null;

        // Pattern 1: "2 numara" veya "3 numaralƒ± √ºr√ºn"
        const numaraMatch = cleanMessage.match(/(\d+)\s*numara/);
        if (numaraMatch) {
            targetNumber = parseInt(numaraMatch[1]);
            console.log(`‚úÖ Numara pattern: ${targetNumber} numara`);
        }
        // Pattern 2: "birinci √ºr√ºn" veya "ikinci"
        else if (numberMap[cleanMessage] !== undefined) {
            targetNumber = numberMap[cleanMessage];
            console.log(`‚úÖ Sayƒ±sal pattern: ${targetNumber}. √ºr√ºn`);
        }
        // Pattern 3: "2. √ºr√ºn" 
        else if (cleanMessage.match(/(\d+)\.?\s*√ºr√ºn/)) {
            const match = cleanMessage.match(/(\d+)\.?\s*√ºr√ºn/);
            targetNumber = parseInt(match[1]);
            console.log(`‚úÖ Noktalƒ± pattern: ${targetNumber}. √ºr√ºn`);
        }

        // Mƒ∞KTAR TESPƒ∞Tƒ∞ (ayrƒ± olarak)
        const quantityMatch = cleanMessage.match(/(\d+)\s*(adet|tane|numara)/g);
        if (quantityMatch && quantityMatch.length >= 2) {
            const lastNumberMatch = cleanMessage.match(/(\d+)\s*(adet|tane)$/);
            if (lastNumberMatch) {
                explicitQuantity = parseInt(lastNumberMatch[1]);
                console.log(`üî¢ A√ßƒ±k miktar: ${explicitQuantity}`);
            }
        }

        // "1 kilo domates" gibi geleneksel pattern i√ßin
        const traditionalProductInfo = extractProductInfoFromCommand(message);

        // √úR√úN BULMA
        if (targetNumber !== null) {
            // Sayƒ±sal se√ßim
            const productCard = document.querySelector(`.product-card[data-product-index="${targetNumber}"]`);
            if (productCard) {
                const productId = productCard.dataset.productId;
                selectedProduct = products.find(p => p.id === productId);
                
                // Miktarƒ± belirle: a√ßƒ±k miktar varsa onu kullan, yoksa 1
                quantity = explicitQuantity !== null ? explicitQuantity : 1;
                
                console.log(`‚úÖ Sayƒ±sal se√ßim: ${targetNumber}. √ºr√ºn, ${quantity} adet`);
            }
        } else if (traditionalProductInfo && traditionalProductInfo.productName) {
            // Geleneksel se√ßim
            selectedProduct = findProductByName(traditionalProductInfo.productName);
            quantity = traditionalProductInfo.quantity;
            console.log(`‚úÖ Geleneksel se√ßim: ${quantity} ${traditionalProductInfo.unit} ${traditionalProductInfo.productName}`);
        }

        // SONU√á
        if (selectedProduct) {
            console.log('üéØ √úr√ºn bulundu:', selectedProduct.name);
            
            // Kilit kontrol√º
            if (isSellerLocked) {
                const firstCartItem = cart[0];
                if (firstCartItem && firstCartItem.seller_id !== selectedSellerId) {
                    const currentSeller = sellers.find(s => s.id === firstCartItem.seller_id);
                    displayMessage(`‚ùå Sepet dolu. Sadece ${currentSeller?.business_name} ile alƒ±≈üveri≈üe devam edebilirsiniz.`);
                    speakToUser("sepet dolu");
                    return true;
                }
            }
            
            // SEPETE EKLE
            console.log('üõí Sepete ekleniyor:', `${quantity} adet ${selectedProduct.name}`);
            addToCart(selectedProduct, quantity);
            
            // ‚úÖ EKRANDA DETAYLI G√ñSTER
            if (targetNumber !== null && explicitQuantity !== null) {
                displayMessage(`‚úÖ ${targetNumber}. √ºr√ºnden ${quantity} adet sepete eklendi: ${selectedProduct.name}`);
            } else if (targetNumber !== null) {
                displayMessage(`‚úÖ ${targetNumber}. √ºr√ºn sepete eklendi: ${selectedProduct.name}`);
            } else {
                displayMessage(`‚úÖ ${quantity} adet ${selectedProduct.name} sepete eklendi`);
            }
            
            // ‚úÖ SESLƒ∞: Sadece temel onay
            speakToUser("eklendi");
            
            return true;
        } else {
            console.log('‚ùå √úr√ºn bulunamadƒ±');
            
            // ‚úÖ EKRANDA DETAYLI G√ñSTER
            const productCards = document.querySelectorAll('.product-card');
            if (productCards.length > 0) {
                const productList = Array.from(productCards)
                    .slice(0, 3)
                    .map(card => `${card.dataset.productIndex}. ${card.querySelector('.product-name')?.textContent}`)
                    .join(', ');
                
                if (targetNumber !== null) {
                    displayMessage(`‚ùå ${targetNumber}. √ºr√ºn bulunamadƒ±. Mevcut √ºr√ºnler: ${productList}`);
                } else {
                    displayMessage(`‚ùå √úr√ºn bulunamadƒ±. Mevcut √ºr√ºnler: ${productList}`);
                }
            } else {
                displayMessage("‚ùå √úr√ºn bulunamadƒ±. L√ºtfen √ºr√ºn ismini veya numarasƒ±nƒ± s√∂yleyin.");
            }
            
            // ‚úÖ SESLƒ∞: Sadece temel uyarƒ±
            speakToUser("√ºr√ºn se√ßin");
            
            return true;
        }
    } catch (error) {
        console.error('‚ùå √úr√ºn ekleme hatasƒ±:', error);
        displayMessage("‚ùå √úr√ºn eklenirken bir hata olu≈ütu.");
        speakToUser("hata");
        return false;
    }
}
        function emergencyDebug() {
    console.log('üö® ACƒ∞L DEBUG BA≈ûLIYOR...');
    
    // Mevcut durumu kontrol et
    console.log('üìä MEVCUT DURUM:');
    console.log('- Store Type:', selectedStoreTypeId, selectedStoreTypeName);
    console.log('- Seller:', selectedSellerId);
    console.log('- Category:', selectedCategoryId);
    console.log('- Products:', products.length);
    console.log('- Products List:', products.map(p => p.name));
    
    // extractProductInfoFromCommand test
    const testCommands = [
        "1 kilo domates",
        "bir kilo soƒüan", 
        "2 paket s√ºt",
        "domates",
        "1 kilo √ßarliston biber"
    ];
    
    testCommands.forEach((testCommand, index) => {
        console.log(`\n--- TEST ${index + 1}: "${testCommand}" ---`);
        const result = extractProductInfoFromCommand(testCommand);
        console.log('üì¶ √áƒ±karƒ±m sonucu:', result);
        
        if (result && products.length > 0) {
            const found = findProductByName(result.productName);
            console.log('üîç √úr√ºn bulundu mu?:', found ? `EVET - ${found.name}` : 'HAYIR');
            
            if (found) {
                console.log('üõí Sepete eklenebilir:', `${result.quantity} ${result.unit} ${found.name}`);
            }
        }
    });
    
    console.log('\nüéØ DEBUG TAMAMLANDI');
}

// HEMEN √áALI≈ûTIRIN:
// emergencyDebug()
        
// =============================================
// Dƒ∞NAMƒ∞K SATICI Sƒ∞STEMƒ∞
// =============================================

async function handleDynamicSellerSelection(data) {
    if (!selectedStoreTypeId) {
        speakToUser("√ñnce bir maƒüaza tipi se√ßmelisiniz.");
        return;
    }
    
    const seller = await findDynamicSeller(data.extractedData, data.message);
    if (seller) {
        await selectDynamicSeller(seller);
        currentRoot = "4:0";
    } else {
        speakToUser("Satƒ±cƒ± bulunamadƒ±. L√ºtfen numarasƒ±nƒ± veya ismini s√∂yleyin.");
    }
}

// Satƒ±cƒ± se√ßildiƒüinde k√∂k√º g√ºncelle
async function selectDynamicSeller(seller) {
    // Kilit kontrol√º
    if (isSellerLocked && seller.id !== selectedSellerId) {
        const currentSeller = sellers.find(s => s.id === selectedSellerId);
        speakToUser(`Sepet dolu. Sadece ${currentSeller?.business_name || 'mevcut satƒ±cƒ±'} ile alƒ±≈üveri≈üe devam edebilirsiniz. Sepeti bo≈üaltarak ba≈üka bir satƒ±cƒ± se√ßebilirsiniz.`);
        return;
    }
    
    debugLog(`üéØ Satƒ±cƒ± se√ßiliyor: ${seller.business_name}`);
    
    // Teslimat kontrol√º
    if (selectedLocation === 'delivery' && seller.delivery_available === false) {
        speakToUser("Bu satƒ±cƒ± konumunuza teslimat yapmƒ±yor. L√ºtfen ba≈üka bir satƒ±cƒ± se√ßin.");
        return;
    }
    
    // √ñnceki se√ßimleri temizle
    document.querySelectorAll('.seller-card, .category-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    const sellerCard = document.querySelector(`[data-seller-id="${seller.id}"]`);
    if (sellerCard) {
        sellerCard.classList.add('selected');
    }
    
    selectedSellerId = seller.id;
    selectedCategoryId = null;
    products = [];
    
    // K√ñK√ú G√úNCELLE - SATICI SE√áƒ∞LDƒ∞
    currentRoot = "4:0";
    debugLog(`üîÑ K√∂k g√ºncellendi: 3:0 -> 4:0 (Satƒ±cƒ± se√ßildi)`);
    
    // UI temizleme
    if (categoriesGrid) {
        categoriesGrid.innerHTML = '<div class="text-center">Y√ºkleniyor...</div>';
    }
    if (productsGrid) {
        productsGrid.innerHTML = '<div class="text-center">Bir reyon se√ßin</div>';
    }
    
    // Satƒ±cƒ± bilgisini g√ºncelle
    if (selectedSellerInfo) {
        selectedSellerInfo.innerHTML = `
            <i class="fas fa-store"></i> ${seller.business_name} 
            <small style="color: var(--gray);">- ${seller.city || ''}</small>
        `;
    }
    
    // KATEGORƒ∞LERƒ∞ Y√úKLE
    await loadCategoriesBySeller(seller.id);
    
    // B√∂l√ºm g√∂r√ºn√ºrl√ºƒü√ºn√º ayarla
    if (categoriesSection) categoriesSection.style.display = 'block';
    if (productsSection) productsSection.style.display = 'none';
    
    debugLog(`‚úÖ Satƒ±cƒ± se√ßildi: ${seller.business_name}`);
    
    // Teslimat durumuna g√∂re mesaj
    let deliveryMsg = "";
    if (selectedLocation === 'delivery' && seller.delivery_available !== false) {
        deliveryMsg = seller.delivery_fee > 0 ? 
            ` Teslimat √ºcreti: ${money(seller.delivery_fee)}.` : 
            " √úcretsiz teslimat.";
    }
    
    speakToUser(`${seller.business_name} se√ßildi.${deliveryMsg} ≈ûimdi bir reyon se√ßin.`);
}
        
  async function loadCategoriesBySeller(sellerId) {
    try {
        debugLog(`üì¶ Satƒ±cƒ±ya g√∂re kategoriler y√ºkleniyor: ${sellerId}`);
        
        // √ñnce satƒ±cƒ±nƒ±n √ºr√ºnlerinden kategorileri bul
        const { data: productsData, error: productsError } = await supabase
            .from('products')
            .select('reyon_id, reyon(name)')
            .eq('is_active', true)
            .not('reyon_id', 'is', null);

        if (productsError) throw productsError;

        // Benzersiz kategorileri topla
        const uniqueCategories = [];
        const seenCategoryIds = new Set();
        
        if (productsData && productsData.length > 0) {
            productsData.forEach(item => {
                if (item.reyon && item.reyon_id && !seenCategoryIds.has(item.reyon_id)) {
                    seenCategoryIds.add(item.reyon_id);
                    uniqueCategories.push({
                        id: item.reyon_id,
                        name: item.reyon.name
                    });
                }
            });
        }

        // Eƒüer kategori bulunamazsa t√ºm kategorileri getir
        if (uniqueCategories.length === 0) {
            const { data: allCategories, error: categoriesError } = await supabase
                .from('reyon')
                .select('*')
                .eq('is_active', true)
                .order('name');
                
            if (categoriesError) throw categoriesError;
            
            categories = allCategories || [];
        } else {
            categories = uniqueCategories;
        }

        debugLog(`üìä KATEGORƒ∞ SONU√á: ${categories.length} kategori bulundu`);
        
        // Kategorileri g√∂ster
        displayCategories(categories);
        
        debugLog(`‚úÖ Satƒ±cƒ± kategorileri y√ºklendi: ${categories.length} adet`);
        
        if (categories.length === 0) {
            speakToUser("Bu satƒ±cƒ±da kategori bulunamadƒ±.");
        }

    } catch (error) {
        console.error('‚ùå Kategori y√ºkleme hatasƒ±:', error);
        categories = getDemoCategories();
        displayCategories(categories);
        speakToUser("Kategoriler y√ºklenirken hata olu≈ütu. Demo kategoriler g√∂steriliyor.");
    }
}

// SESLƒ∞ SATICI SE√áƒ∞M - REYON Y√úKLEME 
async function handleVoiceSellerSelection(message) {
    console.log('üéØ Sesli satƒ±cƒ± se√ßimi:', message);
    
    // Store Type kontrol√º
    if (!selectedStoreTypeId) {
        displayMessage("‚ùå √ñnce bir maƒüaza tipi se√ßmelisiniz.");
        speakToUser("maƒüaza se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
        return false;
    }

    const sellerCards = document.querySelectorAll("#sellerGrid .seller-card");
    if (!sellerCards.length) {
        displayMessage("‚ùå Satƒ±cƒ± listesi y√ºklenmedi. L√ºtfen bekleyin.");
        speakToUser("satƒ±cƒ± se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
        return false;
    }

    const cleanMessage = message.toLowerCase().trim();
    let selectedCard = null;

    // SAYISAL SE√áƒ∞M KONTROL√ú
    const numberMap = {
        'birinci': 1, 'bir': 1, '1': 1, '1.': 1,
        'ikinci': 2, 'iki': 2, '2': 2, '2.': 2,
        '√º√ß√ºnc√º': 3, '√º√ß': 3, '3': 3, '3.': 3,
        'd√∂rd√ºnc√º': 4, 'd√∂rt': 4, '4': 4, '4.': 4,
        'be≈üinci': 5, 'be≈ü': 5, '5': 5, '5.': 5
    };

    // 1. Sayƒ±sal se√ßim
    if (numberMap[cleanMessage] !== undefined) {
        const targetNumber = numberMap[cleanMessage];
        selectedCard = Array.from(sellerCards).find(card => 
            parseInt(card.dataset.sellerIndex) === targetNumber
        );
        
        if (selectedCard) {
            console.log(`‚úÖ Sayƒ±sal satƒ±cƒ± se√ßimi: ${targetNumber}. satƒ±cƒ±`);
        }
    }

    // 2. ƒ∞simle arama
    if (!selectedCard) {
        for (const card of sellerCards) {
            const sellerName = card.querySelector('.seller-name')?.textContent.toLowerCase() || '';
            const sellerId = card.dataset.sellerId;
            const seller = sellers.find(s => s.id === sellerId);
            
            if (seller && (
                seller.business_name.toLowerCase().includes(cleanMessage) ||
                cleanMessage.includes(seller.business_name.toLowerCase()) ||
                sellerName.includes(cleanMessage) ||
                cleanMessage.includes(sellerName)
            )) {
                selectedCard = card;
                break;
            }
        }
    }

    if (!selectedCard) {
        const sellerList = Array.from(sellerCards)
            .slice(0, 3)
            .map(card => `${card.dataset.sellerIndex}. ${card.querySelector('.seller-name')?.textContent}`)
            .filter(name => name)
            .join(', ');
        
        displayMessage(`‚ùå Satƒ±cƒ± bulunamadƒ±. Mevcut satƒ±cƒ±lar: ${sellerList}`);
        speakToUser("satƒ±cƒ± se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
        return false;
    }

    // Satƒ±cƒ±yƒ± se√ß
    const sellerId = selectedCard.dataset.sellerId;
    const seller = sellers.find(s => s.id === sellerId);
    
    if (seller) {
        await selectDynamicSeller(seller);
        
        const sellerNumber = selectedCard.dataset.sellerIndex;
        
        // ‚úÖ EKRANDA DETAYLI G√ñSTER
        displayMessage(`‚úÖ ${sellerNumber}. ${seller.business_name} se√ßildi. ≈ûimdi bir reyon se√ßin.`);
        
        // ‚úÖ SESLƒ∞: Sadece temel onay
        speakToUser("se√ßildi");
        
        return true;
    }

    displayMessage("‚ùå Satƒ±cƒ± bulunamadƒ±.");
    speakToUser("satƒ±cƒ± se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
    return false;
}

      
// =============================================
// KATEGORƒ∞ SE√áƒ∞Mƒ∞NDE √úR√úNLERƒ∞ Y√úKLE
// =============================================

// Kategori se√ßildiƒüinde k√∂k√º g√ºncelle
async function selectDynamicCategory(category) {
    const categoryCard = document.querySelector(`[data-category-id="${category.id}"]`);
    if (categoryCard) {
        document.querySelectorAll('.category-card').forEach(c => {
            c.classList.remove('selected');
        });
        
        categoryCard.classList.add('selected');
        selectedCategoryId = category.id;
        
        // K√ñK√ú G√úNCELLE - KATEGORƒ∞ SE√áƒ∞LDƒ∞
        currentRoot = "5:0";
        debugLog(`üîÑ K√∂k g√ºncellendi: 4:0 -> 5:0 (Kategori se√ßildi: ${category.name})`);
        
        await loadProductsByCategory(category.id);
        
        debugLog(`üõí Kategori se√ßildi: ${category.name}`);
        speakToUser(`${category.name} kategorisi se√ßildi. √úr√ºnler listeleniyor. Sesli olarak √ºr√ºn sipari≈üi verebilirsiniz.`);
    }
}      

// =============================================
// KATEGORƒ∞ SE√á √úR√úNLERƒ∞ Y√úKLE
// =============================================

// üéØ Sesli Reyon Se√ßimi (Tƒ±klama Sim√ºlasyonlu)
async function handleVoiceCategorySelection(message) {
    console.log(`üéØ Sesli Reyon Se√ßimi: ${message}`);

    const categoryCards = document.querySelectorAll('.category-card');
    if (!categoryCards.length) {
        displayMessage("‚ö†Ô∏è Reyonlar y√ºklenmemi≈ü g√∂r√ºn√ºyor.");
        speakToUser("reyon se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
        return false;
    }

    const cleanMessage = message.toLowerCase();
    let bestMatch = null;

    // SAYISAL SE√áƒ∞M KONTROL√ú
    const numberMap = {
        'birinci': 1, 'bir': 1, '1': 1, '1.': 1,
        'ikinci': 2, 'iki': 2, '2': 2, '2.': 2,
        '√º√ß√ºnc√º': 3, '√º√ß': 3, '3': 3, '3.': 3,
        'd√∂rd√ºnc√º': 4, 'd√∂rt': 4, '4': 4, '4.': 4,
        'be≈üinci': 5, 'be≈ü': 5, '5': 5, '5.': 5
    };

    // 1. Sayƒ±sal se√ßim
    if (numberMap[cleanMessage] !== undefined) {
        const targetNumber = numberMap[cleanMessage];
        bestMatch = Array.from(categoryCards).find(card => 
            parseInt(card.dataset.categoryIndex) === targetNumber
        );
        
        if (bestMatch) {
            console.log(`‚úÖ Sayƒ±sal reyon se√ßimi: ${targetNumber}. reyon`);
        }
    }

    // 2. ƒ∞simle arama
    if (!bestMatch) {
        categoryCards.forEach(card => {
            const categoryName = card.dataset.categoryName?.toLowerCase() || '';
            if (cleanMessage.includes(categoryName)) {
                bestMatch = card;
            }
        });
    }

    if (bestMatch) {
        // Sim√ºle tƒ±klama
        bestMatch.click();
        
        // Akƒ±llƒ± geri bildirim
        const categoryNumber = bestMatch.dataset.categoryIndex;
        const categoryName = bestMatch.dataset.categoryName;
        console.log(`‚úÖ Sesli olarak "${categoryNumber}. ${categoryName}" reyonu se√ßildi.`);
        
 // ‚úÖ EKRANDA DETAYLI G√ñSTER
        displayMessage(`‚úÖ ${categoryNumber}. ${categoryName} reyonu se√ßildi. ≈ûimdi √ºr√ºn se√ßin.`);
        
        // ‚úÖ SESLƒ∞: Sadece temel onay
        speakToUser("se√ßildi");
        currentRoot = "5:0";
        return true;
    } else {
        const categoryList = Array.from(categoryCards)
            .slice(0, 3)
            .map(card => `${card.dataset.categoryIndex}. ${card.dataset.categoryName}`)
            .join(', ');
        
         displayMessage(`‚ùå Reyon bulunamadƒ±. Mevcut reyonlar: ${categoryList}`);
        speakToUser("reyon se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
        return false;
    }
}
// =============================================
// SATICININ T√úM √úR√úNLERƒ∞Nƒ∞ Y√úKLE (YEDEK)
// =============================================

async function loadAllProductsBySeller() {
    try {
        debugLog(`üõí Satƒ±cƒ±nƒ±n t√ºm √ºr√ºnleri y√ºkleniyor: ${selectedSellerId}`);
        
        const { data: allProducts, error } = await supabase
            .from('products')
            .select('*')
            .eq('is_active', true)
            .order('name');

        if (error) throw error;

        products = (allProducts || []).map(product => ({
            id: product.id,
            name: product.name,
            price: product.price,
            discount_price: product.discount_price,
            imgurl: product.imgurl,
            reyon_id: product.reyon_id,
            unit_type: product.unit_type || 'adet',
            description: product.description
        }));

        debugLog(`‚úÖ T√ºm √ºr√ºnler y√ºklendi: ${products.length} adet`);
        
        displayProducts(products);
        
        if (productsSection) productsSection.style.display = 'block';
        if (categoriesSection) categoriesSection.style.display = 'none';

    } catch (error) {
        console.error('‚ùå T√ºm √ºr√ºn y√ºkleme hatasƒ±:', error);
        products = getDemoProducts();
        displayProducts(products);
    }
}
// =============================================
// YARDIMCI FONKSƒ∞YONLAR
// =============================================
// Basit ve etkili ana sesli se√ßim fonksiyonu
async function handleVoiceSelection(message, currentRoot) {
    console.log(`üéØ Sesli se√ßim i≈üleniyor: "${message}" | K√∂k: ${currentRoot}`);
    
    switch(currentRoot) {
        case '2:0': // Maƒüaza tipi se√ßimi
            return await handleVoiceStoreSelection(message);
            
        case '3:0': // Satƒ±cƒ± se√ßimi
            return await handleVoiceSellerSelection(message);
            
        case '4:0': // Reyon se√ßimi
            return await handleVoiceCategorySelection(message);
            
        case '5:0': // √úr√ºn ekleme
            return await handleVoiceProductAdd(message);
            
        default:
            return false;
    }
}

        // G√∂rsel feedback sistemi
function addVisualFeedback(element, type = 'primary') {
    const colors = {
        'primary': 'var(--primary)',
        'success': 'var(--success)',
        'accent': 'var(--accent)',
        'warning': 'var(--warning)'
    };
    
    const color = colors[type] || colors.primary;
    
    element.style.transition = 'all 0.3s ease';
    element.style.transform = 'scale(1.05)';
    element.style.boxShadow = `0 0 20px ${color}`;
    
    setTimeout(() => {
        element.style.transform = 'scale(1)';
        element.style.boxShadow = '';
    }, 1000);
}

// Kartlarƒ± vurgula
function highlightCards(selector, text) {
    const kartlar = document.querySelectorAll(selector);
    kartlar.forEach(kart => {
        const isimElementi = kart.querySelector('.seller-type-name, .seller-name, .category-name, .product-name');
        if (isimElementi) {
            const isim = isimElementi.textContent.toLowerCase();
            if (isim.includes(text) || text.includes(isim)) {
                addVisualFeedback(kart, 'success');
            }
        }
    });
}

// Mevcut kartlarƒ± listeleyen debug fonksiyonu
function listCurrentCards() {
    console.log('üìã MEVCUT KART Lƒ∞STESƒ∞:');
    
    const maƒüazaKartlarƒ± = document.querySelectorAll('.seller-type-card');
    if (maƒüazaKartlarƒ±.length > 0) {
        console.log('üè™ Maƒüaza Kartlarƒ±:');
        maƒüazaKartlarƒ±.forEach((kart, index) => {
            const isim = kart.querySelector('.seller-type-name').textContent;
            console.log(`  ${index + 1}. ${isim}`);
        });
    }
    
    const satƒ±cƒ±Kartlarƒ± = document.querySelectorAll('.seller-card');
    if (satƒ±cƒ±Kartlarƒ±.length > 0) {
        console.log('üè¨ Satƒ±cƒ± Kartlarƒ±:');
        satƒ±cƒ±Kartlarƒ±.forEach((kart, index) => {
            const isim = kart.querySelector('.seller-name').textContent;
            console.log(`  ${index + 1}. ${isim}`);
        });
    }
    
    const reyonKartlarƒ± = document.querySelectorAll('.category-card');
    if (reyonKartlarƒ±.length > 0) {
        console.log('üì¶ Reyon Kartlarƒ±:');
        reyonKartlarƒ±.forEach((kart, index) => {
            const isim = kart.querySelector('.category-name').textContent;
            console.log(`  ${index + 1}. ${isim}`);
        });
    }
    
    const √ºr√ºnKartlarƒ± = document.querySelectorAll('.product-card');
    if (√ºr√ºnKartlarƒ±.length > 0) {
        console.log('üõí √úr√ºn Kartlarƒ±:');
        √ºr√ºnKartlarƒ±.forEach((kart, index) => {
            const isim = kart.querySelector('.product-name').textContent;
            console.log(`  ${index + 1}. ${isim}`);
        });
    }
}

// Console'da test etmek i√ßin:
// listCurrentCards()
        
// Demo kategoriler
function getDemoCategories() {
    return [
        { id: 1, name: 'Meyve & Sebze' },
        { id: 2, name: 'S√ºt √úr√ºnleri' },
        { id: 3, name: 'Et & Tavuk' },
        { id: 4, name: 'Temel Gƒ±da' },
        { id: 5, name: 'ƒ∞√ßecekler' }
    ];
}

// Kategori ismine g√∂re se√ßim
async function selectCategoryByName(categoryName) {
    const category = categories.find(cat => cat.name === categoryName);
    if (category) {
        await selectDynamicCategory(category);
    }
}

// BASƒ∞T ve ETKƒ∞Lƒ∞ findProductByName
function findProductByName(productName) {
    console.log('üîç findProductByName √ßaƒürƒ±ldƒ±:', productName);
    
    if (!productName || !products || products.length === 0) {
        console.log('‚ùå √úr√ºn listesi bo≈ü');
        return null;
    }

    const cleanProductName = productName.toLowerCase().trim();
    console.log('üîé Aranan √ºr√ºn:', cleanProductName);
    console.log('üì¶ Mevcut √ºr√ºnler:', products.map(p => p.name));

    // √áOK BASƒ∞T E≈ûLE≈ûME
    for (const product of products) {
        const productNameLower = product.name.toLowerCase();
        
        // Tam e≈üle≈üme
        if (productNameLower === cleanProductName) {
            console.log(`‚úÖ Tam e≈üle≈üme: "${product.name}"`);
            return product;
        }
        
        // ƒ∞√ßerme
        if (productNameLower.includes(cleanProductName) || cleanProductName.includes(productNameLower)) {
            console.log(`‚úÖ ƒ∞√ßerme e≈üle≈ümesi: "${product.name}"`);
            return product;
        }
        
        // Kelime e≈üle≈ümesi
        const searchWords = cleanProductName.split(' ');
        const productWords = productNameLower.split(' ');
        
        let matchCount = 0;
        for (const searchWord of searchWords) {
            if (searchWord.length > 2) {
                for (const productWord of productWords) {
                    if (productWord.includes(searchWord)) {
                        matchCount++;
                        break;
                    }
                }
            }
        }
        
        if (matchCount >= Math.min(searchWords.length, 1)) {
            console.log(`‚úÖ Kelime e≈üle≈ümesi: "${product.name}"`);
            return product;
        }
    }

    console.log(`‚ùå √úr√ºn bulunamadƒ±: "${cleanProductName}"`);
    return null;
}
        // ACƒ∞L DEBUG - Hemen √ßalƒ±≈ütƒ±rƒ±n!
function debugExtractProduct() {
    console.log('üêõ ACƒ∞L DEBUG: extractProductInfoFromCommand Testi');
    
    const testCases = [
        "1 kilo domates",
        "bir kilo soƒüan",
        "2 paket s√ºt", 
        "domates",
        "1 kilo √ßarliston biber",
        "yarƒ±m kilo peynir"
    ];
    
    testCases.forEach((testCase, index) => {
        console.log(`\n--- TEST ${index + 1}: "${testCase}" ---`);
        const result = extractProductInfoFromCommand(testCase);
        console.log('üì¶ SONU√á:', result);
        
        if (result && products.length > 0) {
            const found = findProductByName(result.productName);
            console.log('üîç BULUNDU MU?:', found ? `EVET - ${found.name}` : 'HAYIR');
            
            if (found) {
                console.log('üõí Sepete eklenebilir:', `${result.quantity} ${result.unit} ${found.name}`);
            }
        }
    });
}

        function manualProductAdd() {
    console.log('üõ†Ô∏è MANUEL √úR√úN EKLEME TESTƒ∞');
    
    if (products.length === 0) {
        console.log('‚ùå √úr√ºn listesi bo≈ü');
        return;
    }
    
    console.log('üì¶ Mevcut √ºr√ºnler:', products.map(p => p.name));
    
    // Manuel olarak ilk √ºr√ºn√º sepete ekle
    const product = products[0];
    
    if (product) {
        console.log('‚úÖ √úr√ºn bulundu, sepete ekleniyor...');
        addToCart(product, 1);
        console.log('üéâ √úr√ºn sepete eklendi!');
        speakToUser(`1 adet ${product.name} sepete eklendi.`);
    } else {
        console.log('‚ùå √úr√ºn bulunamadƒ±');
    }
}

// HEMEN √áALI≈ûTIRIN:
// manualProductAdd()

        
// HEMEN √áALI≈ûTIRIN:
debugExtractProduct();
        
// DEBUG: Sepete ekleme s√ºrecini manuel test et
function debugProductAdd() {
    console.log('üêõ DEBUG: Sepete Ekleme S√ºreci');
    
    // 1. Mevcut durum
    console.log('üìä Mevcut Durum:');
    console.log('- Products:', products.length);
    console.log('- Selected Category:', selectedCategoryId);
    console.log('- Selected Seller:', selectedSellerId);
    
    // 2. Manuel extract test
    const testCommand = "1 kilo domates";
    console.log(`üß™ Test komutu: "${testCommand}"`);
    
    const extracted = extractProductInfoFromCommand(testCommand);
    console.log('üì¶ √áƒ±karƒ±lan:', extracted);
    
    if (extracted) {
        // 3. √úr√ºn bulma testi
        const found = findProductByName(extracted.productName);
        console.log('üîç Bulunan √ºr√ºn:', found);
        
        if (found) {
            // 4. Sepete ekleme testi
            console.log('üõí Sepete ekleniyor...');
            addToCart(found, extracted.quantity);
            console.log('‚úÖ Sepete eklendi!');
        }
    }
}

// HEMEN √áALI≈ûTIR:
// debugProductAdd() 
        
// TEST FONKSƒ∞YONU - Hemen √ßalƒ±≈ütƒ±rƒ±n
function testProductExtraction() {
    console.log('üß™ √úR√úN √áIKARIM TESTƒ∞ BA≈ûLIYOR...');
    
    const testCases = [
        "√∂rneƒüin 1 kilo domates",
        "mesela 2 paket s√ºt", 
        "1 kilo domates",
        "√∂rneƒüin domates",
        "√∂rneƒüin bir kilo soƒüan"
    ];
    
    testCases.forEach((testCase, index) => {
        console.log(`\n--- TEST ${index + 1}: "${testCase}" ---`);
        const result = extractProductInfoFromCommand(testCase);
        console.log('üì¶ SONU√á:', result);
    });
    
    console.log('\nüéØ TEST TAMAMLANDI');
}

// Console'da √ßalƒ±≈ütƒ±rƒ±n:
// testProductExtraction();
        
// Sayfa y√ºklendiƒüinde test et
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        // Test etmek i√ßin a≈üaƒüƒ±daki satƒ±rƒ±n yorumunu kaldƒ±rƒ±n:
        // testProductExtraction();
    }, 3000);
});

        function manualTest() {
    console.log('üõ†Ô∏è MANUEL TEST BA≈ûLIYOR...');
    
    if (products.length === 0) {
        console.log('‚ùå √úr√ºn listesi bo≈ü');
        return;
    }
    
    console.log('üì¶ Mevcut √ºr√ºnler:', products.map(p => p.name));
    
    // Manuel extract test
    const testCommand = "1 kilo domates";
    console.log('üß™ Test komutu:', testCommand);
    const result = extractProductInfoFromCommand(testCommand);
    console.log('üì¶ √áƒ±karƒ±m sonucu:', result);
    
    if (result) {
        // Manuel √ºr√ºn bulma
        const found = findProductByName(result.productName);
        console.log('üîç √úr√ºn bulundu:', found ? found.name : 'HAYIR');
        
        if (found) {
            // Manuel sepete ekleme
            console.log('üõí Sepete ekleniyor...');
            addToCart(found, result.quantity);
            console.log('üéâ √úr√ºn sepete eklendi!');
            speakToUser(`${result.quantity} ${result.unit} ${found.name} sepete eklendi.`);
        }
    }
}

// HEMEN √áALI≈ûTIRIN:
// manualTest()
        
function simpleProductMatch(productName) {
    if (!products || products.length === 0) return null;
    
    const cleanName = productName.toLowerCase().trim();
    
    // Basit e≈üle≈ütirme
    for (const product of products) {
        const productNameClean = product.name.toLowerCase();
        
        // Tam e≈üle≈üme
        if (productNameClean === cleanName) {
            return product;
        }
        
        // ƒ∞√ßerme
        if (productNameClean.includes(cleanName) || cleanName.includes(productNameClean)) {
            return product;
        }
        
        // Kelime e≈üle≈ümesi
        const searchWords = cleanName.split(' ');
        const productWords = productNameClean.split(' ');
        
        if (searchWords.some(word => productWords.some(pWord => pWord.includes(word)))) {
            return product;
        }
    }
    
    return null;
}     

// Basit √ßƒ±karƒ±m fonksiyonu
function simpleExtractProduct(message) {
    const cleanMessage = message.toLowerCase()
        .replace(/ekle|sepete|al|istiyorum|l√ºtfen/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    
    // Sayƒ±yƒ± bul
    const numbers = message.match(/\d+/g);
    const quantity = numbers ? parseInt(numbers[0]) : 1;
    
    // √úr√ºn adƒ±nƒ± bul
    let productName = cleanMessage;
    if (numbers) {
        productName = cleanMessage.replace(numbers[0], '').trim();
    }
    
    return productName ? { productName, quantity, unit: 'adet' } : null;
}
        
function findProductBySimilarity(searchName) {
    let bestMatch = null;
    let bestScore = 0;
    
    const searchWords = searchName.split(' ').filter(word => word.length > 2);
    
    products.forEach(product => {
        const productName = product.name.toLowerCase().replace(/[^\w\sƒü√º≈üƒ±√∂√ßƒû√ú≈ûƒ∞√ñ√á]/g, '');
        
        // Kelime bazlƒ± benzerlik
        let wordScore = 0;
        searchWords.forEach(searchWord => {
            let maxWordSimilarity = 0;
            productName.split(' ').forEach(productWord => {
                const similarity = calculateSimilarity(searchWord, productWord);
                if (similarity > maxWordSimilarity) {
                    maxWordSimilarity = similarity;
                }
            });
            wordScore += maxWordSimilarity;
        });
        
        const averageWordScore = wordScore / searchWords.length;
        
        // Tam isim benzerliƒüi
        const fullNameScore = calculateSimilarity(searchName, productName);
        
        // Kombine skor
        const combinedScore = (averageWordScore + fullNameScore) / 2;
        
        if (combinedScore > bestScore && combinedScore > 0.6) {
            bestScore = combinedScore;
            bestMatch = product;
        }
    });
    
    return bestMatch;
}

function calculateSimilarity(str1, str2) {
    if (!str1 || !str2) return 0;
    
    const longer = str1.length > str2.length ? str1 : str2;
    const shorter = str1.length > str2.length ? str2 : str1;
    
    if (longer.length === 0) return 1.0;
    
    // Levenshtein distance
    const distance = levenshteinDistance(str1, str2);
    return (longer.length - distance) / longer.length;
}       

function levenshteinDistance(str1, str2) {
    const matrix = [];
    
    for (let i = 0; i <= str2.length; i++) {
        matrix[i] = [i];
    }
    
    for (let j = 0; j <= str1.length; j++) {
        matrix[0][j] = j;
    }
    
    for (let i = 1; i <= str2.length; i++) {
        for (let j = 1; j <= str1.length; j++) {
            if (str2.charAt(i-1) === str1.charAt(j-1)) {
                matrix[i][j] = matrix[i-1][j-1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i-1][j-1] + 1,
                    matrix[i][j-1] + 1,
                    matrix[i-1][j] + 1
                );
            }
        }
    }
    
    return matrix[str2.length][str1.length];
}

async function handleDynamicAIRequest(message, root) {
    console.log(`ü§ñ AI ƒ∞steƒüi: "${message}" | K√∂k: ${root}`);
    try {
        const response = await processAILogic(message, root);

        // AI kararlƒ±lƒ±ƒüƒ± y√ºksekse
        if (response?.confidence > 0.7) {
            speakToUser(response.message);
            if (response.action) await executeDynamicAction(response.action, { message });
            if (response.nextRoot) {
                console.log(`üîÑ AI nextRoot: ${response.nextRoot}`);
                currentRoot = response.nextRoot;
            }
        } else {
            // Eƒüer currentRoot baƒülamƒ± belirleyebiliyorsa AI fallback yapma
            if (!root || root === "root") {
                speakToUser("Nasƒ±l yardƒ±mcƒ± olabilirim? √úr√ºn, satƒ±cƒ± veya reyon se√ßebilirsiniz.");
            } else {
                console.log("‚ö†Ô∏è AI fallback atlandƒ±, currentRoot:", root);
            }
        }
    } catch (error) {
        console.error('AI i≈üleme hatasƒ±:', error);
        speakToUser("√úzg√ºn√ºm, bir hata olu≈ütu. L√ºtfen tekrar deneyin.");
    }
}

        
   // G√ºncellenmi≈ü AI yardƒ±m mesajƒ±
async function processAILogic(message, root) {
    const lowerMessage = message.toLowerCase();
    
    // Kilit durumunda √∂zel yardƒ±m mesajƒ±
    if (isSellerLocked && lowerMessage.includes('yardƒ±m')) {
        const firstCartItem = cart[0];
        const currentSeller = firstCartItem ? sellers.find(s => s.id === firstCartItem.seller_id) : null;
        
        return {
            message: `Sepet dolu ve ${currentSeller?.business_name || 'mevcut maƒüaza'} kilitli. Sadece bu maƒüazadan √ºr√ºn ekleyebilirsiniz. "Sepeti bo≈üalt" diyerek kilidi kaldƒ±rabilir veya √∂deme yaparak sipari≈üi tamamlayabilirsiniz.`,
            confidence: 0.9
        };
    }
    
    debugLog(`ü§ñ AI ƒ∞≈üleme: "${message}" | K√∂k: ${root} | Satƒ±cƒ±: ${selectedSellerId} | Kategori: ${selectedCategoryId}`);
    
    // Baƒülamsal AI yanƒ±tlarƒ±
    if (selectedCategoryId && products.length > 0) {
        // √úr√ºn ekleme durumu
        if (lowerMessage.includes('ekle') || lowerMessage.includes('al') || lowerMessage.includes('istiyorum')) {
            const productInfo = extractProductInfoFromCommand(message);
            if (productInfo) {
                return {
                    message: `√úr√ºn ekleme komutu algƒ±landƒ±: ${productInfo.quantity} ${productInfo.unit} ${productInfo.productName}`,
                    confidence: 0.8,
                    action: 'add_to_cart'
                };
            }
        }
        
        // √úr√ºn listesi
        if (lowerMessage.includes('ne var') || lowerMessage.includes('√ºr√ºnler') || lowerMessage.includes('liste')) {
            const productList = products.slice(0, 5).map(p => p.name).join(', ');
            return {
                message: `Mevcut √ºr√ºnler: ${productList}. "iki ekmek" veya "bir kilo domates" gibi sipari≈ü verebilirsiniz.`,
                confidence: 0.9
            };
        }
    }
    
    if (selectedSellerId && categories.length > 0 && !selectedCategoryId) {
        // Kategori se√ßimi durumu
        const category = findCategoryByName(message);
        if (category) {
            return {
                message: `${category.name} kategorisi se√ßiliyor...`,
                confidence: 0.8,
                action: 'select_category'
            };
        }
        
        if (lowerMessage.includes('kategori') || lowerMessage.includes('reyon')) {
            const categoryList = categories.slice(0, 5).map(c => c.name).join(', ');
            return {
                message: `Mevcut kategoriler: ${categoryList}. Bir kategori se√ßin.`,
                confidence: 0.9
            };
        }
    }

 // Kilit durumunu g√∂steren debug paneli
function addLockStatusPanel() {
    if (document.getElementById('lockStatusPanel')) return;
    
    const panel = document.createElement('div');
    panel.id = 'lockStatusPanel';
    panel.style.cssText = `
        position: fixed;
        top: 60px;
        right: 20px;
        background: ${isSellerLocked ? '#ff6b6b' : '#51cf66'};
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        z-index: 10000;
        font-weight: bold;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    `;
    
    panel.innerHTML = `
        ${isSellerLocked ? 'üîí Kƒ∞Lƒ∞TLƒ∞' : 'üîì A√áIK'} 
        | Sepet: ${cart.length} √ºr√ºn
        <br>Satƒ±cƒ±: ${selectedSellerId ? 'Se√ßili' : 'Yok'}
    `;
    
    document.body.appendChild(panel);
    
    // Her UI g√ºncellemesinde paneli yenile
    setInterval(() => {
        if (document.getElementById('lockStatusPanel')) {
            document.getElementById('lockStatusPanel').innerHTML = `
                ${isSellerLocked ? 'üîí Kƒ∞Lƒ∞TLƒ∞' : 'üîì A√áIK'} 
                | Sepet: ${cart.length} √ºr√ºn
                <br>Satƒ±cƒ±: ${selectedSellerId ? 'Se√ßili' : 'Yok'}
            `;
            document.getElementById('lockStatusPanel').style.background = 
                isSellerLocked ? '#ff6b6b' : '#51cf66';
        }
    }, 2000);
}

// Sayfa y√ºklendiƒüinde debug panelini ekle
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        addLockStatusPanel();
    }, 3000);
});

    
    // K√∂k bazlƒ± AI yanƒ±tlarƒ±
    switch(root) {
        case '0:0': // Ba≈ülangƒ±√ß
            if (lowerMessage.includes('yardƒ±m') || lowerMessage.includes('help')) {
                return {
                    message: "Sesli sipari≈ü sistemine ho≈ü geldiniz. Konum se√ßerek ba≈ülayabilir, maƒüaza tipi se√ßebilir veya direkt 'market' veya 'restoran' diyerek alƒ±≈üveri≈üe ba≈ülayabilirsiniz.",
                    confidence: 0.9,
                    nextRoot: '1:0'
                };
            }
            break;
            
        case '1:0': // Konum se√ßimi
            if (lowerMessage.includes('nerede') || lowerMessage.includes('konum')) {
                return {
                    message: "Konumunuzu se√ßmeniz gerekiyor: restoran i√ßi, paket servis veya adrese teslim. Hangisini tercih edersiniz?",
                    confidence: 0.8,
                    action: 'show_location_modal'
                };
            }
            break;
            
        case '2:0': // Maƒüaza tipi
            if (lowerMessage.includes('ne var') || lowerMessage.includes('se√ßenek')) {
                const availableTypes = storeTypes.map(st => st.name).join(', ');
                return {
                    message: `Mevcut maƒüaza tipleri: ${availableTypes}. Hangisini se√ßmek istersiniz?`,
                    confidence: 0.9
                };
            }
            break;
            
        case '3:0': // Satƒ±cƒ± se√ßimi
            if (lowerMessage.includes('liste') || lowerMessage.includes('satƒ±cƒ±')) {
                const sellerList = sellers.slice(0, 3).map((s, i) => `${i+1}. ${s.business_name}`).join(', ');
                return {
                    message: `Mevcut satƒ±cƒ±lar: ${sellerList}. Numara s√∂yleyerek se√ßim yapabilirsiniz.`,
                    confidence: 0.8
                };
            }
            break;
            
        case '4:0': // Kategori se√ßimi
            if (lowerMessage.includes('kategori') || lowerMessage.includes('reyon')) {
                const categoryList = categories.slice(0, 5).map(c => c.name).join(', ');
                return {
                    message: `Mevcut kategoriler: ${categoryList}. Bir kategori se√ßin.`,
                    confidence: 0.8
                };
            }
            break;
            
        case '5:0': // √úr√ºn se√ßimi
            if (lowerMessage.includes('√ºr√ºn') || lowerMessage.includes('ne var')) {
                const productList = products.slice(0, 5).map(p => p.name).join(', ');
                return {
                    message: `Mevcut √ºr√ºnler: ${productList}. √úr√ºn adƒ± ve miktar s√∂yleyerek sepete ekleyebilirsiniz.`,
                    confidence: 0.8
                };
            }
            break;
            
        case '6:0': // Sepet y√∂netimi
            if (lowerMessage.includes('sepet') || lowerMessage.includes('√∂deme')) {
                const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
                const total = calculateTotal();
                return {
                    message: `Sepetinizde ${itemCount} √ºr√ºn bulunuyor. Toplam tutar: ${money(total)}. √ñdeme yapmak i√ßin '√∂deme yap' diyebilirsiniz.`,
                    confidence: 0.9,
                    action: 'manage_cart'
                };
            }
            break;
    }
    
    // Genel komutlar
    if (lowerMessage.includes('geri') || lowerMessage.includes('back')) {
        return {
            message: "Bir √∂nceki adƒ±ma d√∂n√ºl√ºyor.",
            confidence: 0.8,
            action: 'navigate_back'
        };
    }
    
    if (lowerMessage.includes('yardƒ±m') || lowerMessage.includes('help')) {
        return {
            message: "Sesli komutlarla alƒ±≈üveri≈ü yapabilirsiniz. 'market se√ß', 'ilk satƒ±cƒ±', 'meyve sebze reyonu', 'iki ekmek' gibi komutlar kullanabilirsiniz.",
            confidence: 0.9
        };
    }
    
    if (lowerMessage.includes('te≈üekk√ºr') || lowerMessage.includes('thanks')) {
        return {
            message: "Rica ederim! Size nasƒ±l yardƒ±mcƒ± olabilirim?",
            confidence: 0.9
        };
    }
    
         // Anla≈üƒ±lamayan mesaj i√ßin baƒülamsal yardƒ±m
    const contextualHelp = getContextualHelp();
    return {
        message: contextualHelp,
        confidence: 0.5
    };
}


// Akƒ±llƒ± yardƒ±m mesajlarƒ±
function getContextualHelp() {
    if (!selectedStoreTypeId) {
        const availableTypes = storeTypes.map(st => st.name).join(', ');
        displayMessage(`Hangi maƒüaza tipinden alƒ±≈üveri≈ü yapmak istersiniz? ${availableTypes}`);
        speakToUser("maƒüaza se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
        return "maƒüaza se√ßin";
    }
    
    if (!selectedSellerId) {
        displayMessage("L√ºtfen bir satƒ±cƒ± se√ßin. Satƒ±cƒ± ismi veya numarasƒ± s√∂yleyebilirsiniz.");
        speakToUser("satƒ±cƒ± se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
        return "satƒ±cƒ± se√ßin";
    }
    
    if (!selectedCategoryId) {
        const categoryList = categories.slice(0, 3).map(c => c.name).join(', ');
        displayMessage(`Hangi reyondan alƒ±≈üveri≈ü yapmak istersiniz? ${categoryList}`);
        speakToUser("reyon se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
        return "reyon se√ßin";
    }
    
    if (products.length > 0) {
        const sampleProducts = products.slice(0, 2).map(p => p.name).join(', ');
        displayMessage(`√úr√ºn sipari≈üi verebilirsiniz. √ñrneƒüin: "1 kilo ${sampleProducts.split(',')[0]}"`);
        speakToUser("√ºr√ºn se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
        return "√ºr√ºn se√ßin";
    }
    
    displayMessage("Nasƒ±l yardƒ±mcƒ± olabilirim?");
    return "yardƒ±m";
}
        


        // Askƒ±daki yanƒ±tƒ± i≈üleme
async function handlePendingDynamicResponse(message) {
    if (!pendingResponse) return;
    
    const { nextRoot, context } = pendingResponse;
    pendingResponse = null;
    
    // Basit onay/red mantƒ±ƒüƒ±
    const lowerMessage = message.toLowerCase();
    
    if (lowerMessage.includes('evet') || lowerMessage.includes('tamam') || lowerMessage.includes('onay')) {
        currentRoot = nextRoot.split('?')[0]; // Soru i≈üaretinden sonrasƒ±nƒ± kaldƒ±r
        speakToUser("Tamam, devam ediyorum.");
    } else if (lowerMessage.includes('hayƒ±r') || lowerMessage.includes('iptal') || lowerMessage.includes('geri')) {
        speakToUser("Anladƒ±m, iptal edildi.");
    } else {
        speakToUser("L√ºtfen evet veya hayƒ±r ≈üeklinde yanƒ±t verin.");
        pendingResponse = { nextRoot, context }; // Yanƒ±t beklemeye devam et
    }
}
        function testVoiceProductAdd() {
    const testCases = [
        "5 kilo domates",
        "3 ekmek",
        "iki s√ºt",
        "bir peynir",
        "yarƒ±m kilo kƒ±yma",
        "10 yumurta",
        "iki litre s√ºt",
        "500 gram zeytin",
        "bir paket makarna",
        "5 domates"
    ];
    
    testCases.forEach(testCase => {
        console.log(`üß™ Test: "${testCase}"`);
        const result = extractProductInfoFromCommand(testCase);
        if (result) {
            console.log(`‚úÖ √áƒ±karƒ±m: ${result.quantity} ${result.unit} ${result.productName}`);
            
            // √úr√ºn bulma testi
            if (products.length > 0) {
                const foundProduct = findProductByName(result.productName);
                console.log(`üîç Bulunan: ${foundProduct ? foundProduct.name : 'Bulunamadƒ±'}`);
            }
        } else {
            console.log(`‚ùå √áƒ±karƒ±m ba≈üarƒ±sƒ±z`);
        }
        console.log('---');
    });
}
 // Sayfa y√ºklendiƒüinde test et
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        // Test modu aktifse testleri √ßalƒ±≈ütƒ±r
        if (DEBUG_MODE) {
            // testVoiceProductAdd(); // Testleri a√ßmak i√ßin yorumu kaldƒ±rƒ±n
        }
    }, 3000);
});       
function extractProductInfoFromCommand(message) {
    console.log('üéß extractProductInfoFromCommand √ßaƒürƒ±ldƒ±:', message);

    if (!message || message.trim() === '') {
        console.log('‚ùå Bo≈ü mesaj');
        return null;
    }

    // √áOK BASƒ∞T TEMƒ∞ZLEME
    let cleanMessage = message.toLowerCase().trim();
    
    // "√∂rneƒüin" kelimesini kesinlikle kaldƒ±r
    cleanMessage = cleanMessage.replace(/√∂rneƒüin|mesela/g, '');
    cleanMessage = cleanMessage.replace(/\s+/g, ' ').trim();

    console.log('üßπ Temizlenmi≈ü mesaj:', cleanMessage);

    let quantity = 1;
    let unit = 'adet';
    let productName = '';

    console.log('üîç Pattern kontrol√º ba≈ülƒ±yor...');

    // 1. "1 kilo domates" pattern'i - KESƒ∞N √áALI≈ûAN
    if (cleanMessage.includes('kilo')) {
        const parts = cleanMessage.split('kilo');
        if (parts.length >= 2) {
            // Sayƒ±yƒ± bul
            const numberMatch = parts[0].match(/\d+/);
            quantity = numberMatch ? parseInt(numberMatch[0]) : 1;
            
            // √úr√ºn adƒ±nƒ± al (kilo'dan sonrasƒ±)
            productName = parts[1].trim();
            unit = 'kg';
            console.log(`‚úÖ Kilo pattern e≈üle≈üti: ${quantity} kg ${productName}`);
        }
    }
    // 2. "bir kilo domates" pattern'i - KESƒ∞N √áALI≈ûAN
    else if (cleanMessage.includes('bir kilo')) {
        quantity = 1;
        productName = cleanMessage.replace('bir kilo', '').trim();
        unit = 'kg';
        console.log(`‚úÖ Bir kilo pattern e≈üle≈üti: ${quantity} kg ${productName}`);
    }
    // 3. "iki kilo domates" pattern'i - KESƒ∞N √áALI≈ûAN
    else if (cleanMessage.includes('iki kilo')) {
        quantity = 2;
        productName = cleanMessage.replace('iki kilo', '').trim();
        unit = 'kg';
        console.log(`‚úÖ ƒ∞ki kilo pattern e≈üle≈üti: ${quantity} kg ${productName}`);
    }
    // 4. "yarƒ±m kilo" pattern'i
    else if (cleanMessage.includes('yarƒ±m kilo')) {
        quantity = 0.5;
        productName = cleanMessage.replace('yarƒ±m kilo', '').trim();
        unit = 'kg';
        console.log(`‚úÖ Yarƒ±m kilo pattern e≈üle≈üti: ${quantity} kg ${productName}`);
    }
    // 5. "√ßeyrek kilo" pattern'i
    else if (cleanMessage.includes('√ßeyrek kilo')) {
        quantity = 0.25;
        productName = cleanMessage.replace('√ßeyrek kilo', '').trim();
        unit = 'kg';
        console.log(`‚úÖ √áeyrek kilo pattern e≈üle≈üti: ${quantity} kg ${productName}`);
    }
    // 6. Sadece sayƒ± + √ºr√ºn - KESƒ∞N √áALI≈ûAN
    else if (cleanMessage.match(/^\d+/)) {
        const numberMatch = cleanMessage.match(/^(\d+)/);
        if (numberMatch) {
            quantity = parseInt(numberMatch[1]);
            productName = cleanMessage.replace(numberMatch[1], '').trim();
            unit = 'adet';
            console.log(`‚úÖ Sayƒ± pattern e≈üle≈üti: ${quantity} adet ${productName}`);
        }
    }
    // 7. Sadece √ºr√ºn adƒ± - KESƒ∞N √áALI≈ûAN
    else {
        productName = cleanMessage;
        quantity = 1;
        unit = 'adet';
        console.log(`‚úÖ Sadece √ºr√ºn adƒ±: ${quantity} adet ${productName}`);
    }

    // TEMEL D√úZELTMELER - D√úZG√úN √áALI≈ûAN VERSƒ∞YON
    const fixes = {
        'domates': 'domates',
        'soƒüan': 'soƒüan', 
        'salatalƒ±k': 'salatalƒ±k',
        'patates': 'patates',
        '√ßarliston biber': '√ßarliston biber',
        'biber': 'biber',
        'kabak': 'kabak',
        'marul': 'marul',
        'peynir': 'peynir',
        's√ºt': 's√ºt',
        'ekmek': 'ekmek'
    };

    // Sadece doƒüru yazƒ±mlarƒ± kabul et, yanlƒ±≈ülarƒ± d√ºzeltme
    let foundFix = false;
    for (const [correct] of Object.entries(fixes)) {
        if (productName && productName.includes(correct)) {
            productName = correct; // Doƒüru yazƒ±mƒ± kullan
            foundFix = true;
            console.log(`‚úÖ Doƒüru √ºr√ºn adƒ±: "${correct}"`);
            break;
        }
    }

    // Eƒüer hi√ß e≈üle≈üme yoksa, mevcut √ºr√ºnlerle kar≈üƒ±la≈ütƒ±r
    if (!foundFix && products.length > 0) {
        for (const product of products) {
            const productNameLower = product.name.toLowerCase();
            if (productName && productNameLower.includes(productName) || productName.includes(productNameLower)) {
                productName = product.name;
                console.log(`‚úÖ √úr√ºn listesinden e≈üle≈üme: "${product.name}"`);
                break;
            }
        }
    }

    // SON KONTROL - KESƒ∞N
    if (!productName || productName.trim() === '') {
        console.log('‚ùå √úr√ºn adƒ± √ßƒ±karƒ±lamadƒ±');
        return null;
    }

    productName = productName.trim();

    console.log('üéØ SONU√á:', { productName, quantity, unit });
    return { productName, quantity, unit };
}
        
function testExtractProduct() {
    console.log('üß™ ACƒ∞L EXTRACT TESTƒ∞ BA≈ûLIYOR...');
    
    const testCases = [
        "1 kilo domates",
        "bir kilo soƒüan",
        "2 paket s√ºt",
        "domates",
        "1 kilo √ßarliston biber",
        "yarƒ±m kilo peynir",
        "3 adet ekmek"
    ];
    
    testCases.forEach((testCase, index) => {
        console.log(`\n--- TEST ${index + 1}: "${testCase}" ---`);
        const result = extractProductInfoFromCommand(testCase);
        console.log('üì¶ SONU√á:', result);
        
        if (result && products.length > 0) {
            const found = findProductByName(result.productName);
            console.log('üîç BULUNDU MU?:', found ? `EVET - ${found.name}` : 'HAYIR');
        }
    });
    
    console.log('\nüéØ TEST TAMAMLANDI');
}

// HEMEN √áALI≈ûTIRIN:
// testExtractProduct()


        
// Hemen kullanabileceƒüiniz basit versiyon
function setupVoiceRecognitionLearning() {
    console.log('üîß Ses tanƒ±ma √∂ƒürenme sistemi kuruluyor...');
    
    // Global fonksiyonlarƒ± g√ºncelle
    const originalProcessVoiceCommand = processVoiceCommand;
    
    processVoiceCommand = async function(transcript) {
        const message = transcript.toLowerCase().trim();
        
        try {
            // √ñnce tablodan d√ºzeltme var mƒ± kontrol et
            const { data: correction, error } = await supabase
                .from('product_voice_matches')
                .select('matched_product')
                .eq('user_input', message)
                .eq('success', true)
                .single();

            if (!error && correction) {
                console.log(`üéØ Tablo d√ºzeltmesi: "${message}" -> "${correction.matched_product}"`);
                // D√ºzeltilmi≈ü mesajla i≈üleme devam et
                await originalProcessVoiceCommand.call(this, correction.matched_product);
                
                // Ba≈üarƒ±yƒ± kaydet (match_count artƒ±rmak i√ßin)
                await supabase
                    .from('product_voice_matches')
                    .update({ 
                        attempted_match: correction.matched_product,
                        created_at: new Date().toISOString()
                    })
                    .eq('user_input', message);
                    
                return;
            }
            
            // Normal i≈üleme devam et
            await originalProcessVoiceCommand.call(this, transcript);
            
        } catch (error) {
            console.error('√ñƒürenen sistem hatasƒ±:', error);
            await originalProcessVoiceCommand.call(this, transcript);
        }
    };
    
    console.log('‚úÖ Ses tanƒ±ma √∂ƒürenme sistemi hazƒ±r');
}

// Uygulama ba≈ülangƒ±cƒ±nda √ßaƒüƒ±r
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        setupVoiceRecognitionLearning();
    }, 2000);
});
        
function testFixedExtraction() {
    console.log('üß™ D√úZELTƒ∞LMƒ∞≈û EXTRACT TESTƒ∞ BA≈ûLIYOR...');
    
    const testCases = [
        "1 kilo domates",
        "bir kilo soƒüan",
        "2 paket s√ºt",
        "domates",
        "1 kilo √ßarliston biber",
        "yarƒ±m kilo peynir",
        "3 adet ekmek",
        "iki kilo patates"
    ];
    
    testCases.forEach((testCase, index) => {
        console.log(`\n--- TEST ${index + 1}: "${testCase}" ---`);
        const result = extractProductInfoFromCommand(testCase);
        console.log('üì¶ SONU√á:', result);
    });
    
    console.log('\nüéØ TEST TAMAMLANDI');
}

// Console'da test etmek i√ßin:
// testFixedExtraction()
        
        // √úr√ºn bulunamadƒ± durumu
function handleDynamicProductNotFound(message, attemptedName) {
    debugLog(`‚ùå √úr√ºn bulunamadƒ±: "${attemptedName}"`);
    
    const availableProducts = products.slice(0, 5).map(p => p.name);
    
    if (availableProducts.length > 0) {
        speakToUser(`"${attemptedName}" bulunamadƒ±. Mevcut √ºr√ºnler: ${availableProducts.join(', ')}`);
    } else {
        speakToUser("Hen√ºz √ºr√ºn y√ºklenmedi. L√ºtfen bir kategori se√ßin.");
    }
}    
   
   
// G√úVENLƒ∞ voiceLearner
const voiceLearner = {
    cache: new Map(),
    initialized: false,

    async correctUserInput(userInput) {
        if (!userInput || typeof userInput !== 'string') {
            return userInput;
        }
        
        if (!this.initialized) return userInput;
        
        const lowerInput = userInput.toLowerCase().trim();
        
        if (this.cache.has(lowerInput)) {
            const corrected = this.cache.get(lowerInput);
            console.log(`üîÑ √ñƒürenilmi≈ü kural: "${userInput}" -> "${corrected}"`);
            return corrected;
        }
        
        return userInput;
    },

    async recordSuccess(userInput, matchedProduct, productId = null) {
        try {
            if (!userInput || !matchedProduct) return;

            // G√ºvenli Supabase sorgusu
            const { error } = await safeSupabaseQuery(
                supabase.from('product_voice_matches').insert([{
                    user_input: String(userInput).toLowerCase(),
                    matched_product: String(matchedProduct),
                    attempted_match: String(matchedProduct),
                    success: true,
                    created_at: new Date().toISOString()
                }])
            );

            if (!error) {
                console.log(`‚úÖ Ba≈üarƒ± kaydedildi: "${userInput}" -> "${matchedProduct}"`);
            }
        } catch (error) {
            console.log('üîá Ba≈üarƒ± kaydetme hatasƒ± (g√ºvenli):', error.message);
        }
    },

    async recordFailure(userInput, attemptedMatch = null) {
        try {
            if (!userInput) return;

            // G√ºvenli Supabase sorgusu
            const { error } = await safeSupabaseQuery(
                supabase.from('product_voice_matches').insert([{
                    user_input: String(userInput).toLowerCase(),
                    matched_product: null,
                    attempted_match: String(attemptedMatch || 'unknown'),
                    success: false,
                    created_at: new Date().toISOString()
                }])
            );

            if (!error) {
                console.log(`‚ùå Ba≈üarƒ±sƒ±zlƒ±k kaydedildi: "${userInput}"`);
            }
        } catch (error) {
            console.log('üîá Ba≈üarƒ±sƒ±zlƒ±k kaydetme hatasƒ± (g√ºvenli):', error.message);
        }
    },

    async initialize() {
        try {
            const { data: rules, error } = await safeSupabaseQuery(
                supabase.from('product_voice_matches')
                    .select('*')
                    .eq('success', true)
            );

            this.cache.clear();
            if (rules) {
                rules.forEach(rule => {
                    if (rule.user_input && rule.matched_product) {
                        this.cache.set(
                            String(rule.user_input).toLowerCase(), 
                            String(rule.matched_product)
                        );
                    }
                });
                console.log(`‚úÖ ${rules.length} √∂ƒürenilmi≈ü kural y√ºklendi`);
            }

            this.initialized = true;
        } catch (error) {
            console.log('üîá √ñƒürenen sistem ba≈ülatma hatasƒ± (g√ºvenli)');
        }
    }
};

// G√ºvenli Supabase sorgu yardƒ±mcƒ±sƒ±
async function safeSupabaseQuery(query, fallbackData = []) {
    try {
        const { data, error } = await query;
        
        if (error) {
            // 406 ve diƒüer hatalarƒ± yakala
            if (error.code === '406' || error.message.includes('406')) {
                console.log('‚ö†Ô∏è Supabase 406 hatasƒ±, fallback kullanƒ±lƒ±yor');
                return fallbackData;
            }
            console.log('üîá Supabase sorgu hatasƒ±:', error.message);
            return fallbackData;
        }
        
        return data || fallbackData;
    } catch (error) {
        console.log('üîá Supabase sorgu istisnasƒ±:', error.message);
        return fallbackData;
    }
}

        
        
 
// üî• G√ºncellenmi≈ü handleDynamicAddToCart
async function handleDynamicAddToCart(data) {
    console.log('üéØ handleDynamicAddToCart √ßaƒürƒ±ldƒ±:', data);

    const productInfo = await extractProductInfoFromCommand(data.message);

    if (!productInfo) {
        await voiceLearner.recordFailure(data.message, 'extraction_failed');
        speakToUser("√úr√ºn ismini anlayamadƒ±m.");
        return;
    }

    const { productName, quantity, unit } = productInfo;
    const product = findProductByName(productName);

    if (product) {
        addToCart(product, quantity);
        speakToUser(`${quantity} ${unit} ${product.name} sepete eklendi.`);

        await voiceLearner.recordSuccess(data.message, product.name, product.id);

    } else {
        await voiceLearner.recordFailure(data.message, productName);
        handleDynamicProductNotFound(data.message, productName);
    }
}

// Hata ayƒ±klama testi
function testAllFunctions() {
    console.log('üß™ T√úM FONKSƒ∞YONLAR TEST EDƒ∞Lƒ∞YOR...');
    
    const testInputs = [
        'domates',
        '3 kilo soƒüan', 
        '√ßarliston biber',
        '', // bo≈ü input
        null, // null input
        123, // sayƒ± input
        undefined // undefined input
    ];
    
    testInputs.forEach(input => {
        console.log(`\nüß™ Test input:`, input);
        
        // extractProductInfoFromCommand test
        try {
            const result = extractProductInfoFromCommand(input);
            console.log('‚úÖ extractProductInfoFromCommand:', result);
        } catch (e) {
            console.log('‚ùå extractProductInfoFromCommand hatasƒ±:', e.message);
        }
        
        // findProductByName test (sadece string i√ßin)
        if (typeof input === 'string' && input.trim()) {
            try {
                const result = findProductByName(input);
                console.log('‚úÖ findProductByName:', result ? result.name : 'Bulunamadƒ±');
            } catch (e) {
                console.log('‚ùå findProductByName hatasƒ±:', e.message);
            }
        }
    });
}

// Console'da test etmek i√ßin:
// testAllFunctions();
        
// Console'da test etmek i√ßin:
// testVoiceLearner();
// =============================================
// Dƒ∞NAMƒ∞K REYON Sƒ∞STEMƒ∞
// =============================================

async function handleDynamicCategorySelection(data) {
    if (!selectedSellerId) {
        speakToUser("√ñnce bir satƒ±cƒ± se√ßmelisiniz.");
        return;
    }
    
    const category = await findDynamicCategory(data.extractedData, data.message);
    if (category) {
        await selectDynamicCategory(category);
        currentRoot = "5:0";
    } else {
        const availableCategories = await getAvailableCategories();
        speakToUser(`Reyon bulunamadƒ±. Mevcut reyonlar: ${availableCategories}`);
    }
}

        
// =============================================
// Dƒ∞NAMƒ∞K YARDIMCI FONKSƒ∞YONLAR
// =============================================

// Dinamik satƒ±cƒ± bulma
async function findDynamicSeller(extractedData, message) {
    // Index ile arama
    if (extractedData?.sellerIndex) {
        const index = parseInt(extractedData.sellerIndex) - 1;
        if (index >= 0 && index < sellers.length) {
            return sellers[index];
        }
    }
    
    // ƒ∞sim ile arama
    if (extractedData?.sellerName) {
        return sellers.find(s => 
            s.business_name.toLowerCase().includes(extractedData.sellerName.toLowerCase())
        );
    }
    
    // Mesajdan √ßƒ±karƒ±m
    const sellerName = await extractSellerFromMessage(message);
    if (sellerName) {
        return sellers.find(s => 
            s.business_name.toLowerCase().includes(sellerName.toLowerCase())
        );
    }
    
    return null;
}

// Dinamik reyon bulma
async function findDynamicCategory(extractedData, message) {
    // Index ile arama
    if (extractedData?.categoryIndex) {
        const index = parseInt(extractedData.categoryIndex) - 1;
        if (index >= 0 && index < categories.length) {
            return categories[index];
        }
    }
    
    // ƒ∞sim ile arama
    if (extractedData?.categoryName) {
        return categories.find(c => 
            c.name.toLowerCase().includes(extractedData.categoryName.toLowerCase())
        );
    }
    
    return null;
}

// Dinamik √ºr√ºn bilgisi √ßƒ±karƒ±mƒ±
function extractDynamicProductInfo(extractedData, message) {
    // √ñncelikle extractedData'dan al
    if (extractedData?.product && extractedData?.quantity) {
        return {
            productName: extractedData.product,
            quantity: parseInt(extractedData.quantity)
        };
    }
    
    // Fallback: mesajdan √ßƒ±kar
    return extractProductInfoFromCommand(message);
}

// =============================================
// Dƒ∞NAMƒ∞K EVENT HANDLER'LAR
// =============================================

function setupDynamicEventHandlers() {
    // Mikrofon
    if (microphoneToggle) {
        microphoneToggle.addEventListener('click', handleDynamicMicrophoneToggle);
    }
    
    // Konum
    setupDynamicLocationEvents();
    
    // Sepet
    if (orderSummary) {
        orderSummary.addEventListener('click', toggleDynamicCart);
    }
    if (cartClose) {
        cartClose.addEventListener('click', closeDynamicCart);
    }
    
    // √ñdeme butonlarƒ±
    if (payCashBtn) payCashBtn.addEventListener('click', () => finalizeDynamicOrder('nakit'));
    if (payCardBtn) payCardBtn.addEventListener('click', () => finalizeDynamicOrder('kart'));
    if (payBonusBtn) payBonusBtn.addEventListener('click', () => finalizeDynamicOrder('bonus'));
}

function handleDynamicMicrophoneToggle() {
    if (!selectedLocation) {
        showDynamicLocationModal();
        speakToUser("L√ºtfen √∂nce bir konum se√ßiniz.");
        return;
    }
    
    if (isListening) {
        disableDynamicMicrophone();
    } else {
        enableDynamicMicrophone();
    }
}

// =============================================
// Dƒ∞NAMƒ∞K FALLBACK ve AI Sƒ∞STEMƒ∞
// =============================================

async function handleUnknownDynamicAction(actionName, data) {
    const aiResponse = await queryDynamicAI(data.message, currentRoot);
    
    if (aiResponse.confidence > 0.7) {
        speakToUser(aiResponse.message);
        if (aiResponse.suggestedAction) {
            await executeDynamicAction(aiResponse.suggestedAction, data);
        }
    } else {
        const contextualHelp = await getDynamicContextualHelp(currentRoot);
        speakToUser(contextualHelp);
    }
}

// Ba≈üarƒ±lƒ± √ºr√ºn e≈üle≈ümesini kaydetme
async function saveSuccessfulProductMatch(spokenText, matchedProduct) {
    try {
        // √ñƒürenme verisini kaydet (ger√ßek uygulamada veritabanƒ±na kaydedebilirsiniz)
        const learningData = {
            spoken_text: spokenText,
            matched_product: matchedProduct,
            timestamp: new Date().toISOString(),
            root_code: currentRoot
        };
        
        console.log('üìö √ñƒürenme verisi kaydedildi:', learningData);
        
        // localStorage'a kaydet (ge√ßici √ß√∂z√ºm)
        const existingData = JSON.parse(localStorage.getItem('voice_learning_data') || '[]');
        existingData.push(learningData);
        localStorage.setItem('voice_learning_data', JSON.stringify(existingData));
        
    } catch (error) {
        console.error('√ñƒürenme verisi kaydetme hatasƒ±:', error);
    }
}

// Maƒüaza tipi √ßƒ±karƒ±mƒ±
async function extractStoreTypeFromMessage(message) {
    const lowerMessage = message.toLowerCase();
    
    const typeMappings = {
        'market': 'Market',
        's√ºpermarket': 'Market',
        'bakkal': 'Market',
        'restoran': 'Restoran',
        'lokanta': 'Restoran',
        'yemek': 'Restoran',
        'eczane': 'Eczane',
        'fƒ±rƒ±n': 'Fƒ±rƒ±n',
        'kafe': 'Kafe',
        'kahve': 'Kafe'
    };
    
    for (const [keyword, storeType] of Object.entries(typeMappings)) {
        if (lowerMessage.includes(keyword)) {
            return storeType;
        }
    }
    
    return null;
}

// Satƒ±cƒ± √ßƒ±karƒ±mƒ±
async function extractSellerFromMessage(message) {
    // Basit satƒ±cƒ± ismi √ßƒ±karƒ±mƒ±
    const sellers = filteredSellers.length > 0 ? filteredSellers : allSellersInLocation;
    
    for (const seller of sellers) {
        if (message.toLowerCase().includes(seller.business_name.toLowerCase())) {
            return seller.business_name;
        }
    }
    
    return null;
}

// Mevcut maƒüaza tiplerini getir
async function getAvailableStoreTypes() {
    return storeTypes.map(st => st.name).join(', ');
}

// Maƒüaza tipi bulma
async function findStoreTypeByName(storeTypeName) {
    return storeTypes.find(st => 
        st.name.toLowerCase().includes(storeTypeName.toLowerCase()) ||
        storeTypeName.toLowerCase().includes(st.name.toLowerCase())
    );
}
   // √ñdeme finalizasyonu
async function finalizeDynamicOrder(paymentMethod) {
    if (cart.length === 0) {
        speakToUser("Sepetiniz bo≈ü. √ñnce √ºr√ºn ekleyin.");
        return;
    }
    
    currentPaymentMethod = paymentMethod;
    
    const total = calculateTotal();
    const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
    
    speakToUser(`${itemCount} √ºr√ºn i√ßin ${money(total)} tutarƒ±ndaki sipari≈üiniz ${paymentMethod} ile √∂deme yapƒ±lƒ±yor. Sipari≈üiniz alƒ±ndƒ±, te≈üekk√ºr ederiz!`);
    
    // Sipari≈üi tamamla
    await completeDynamicOrder();
}     


        // Sipari≈üi tamamlama
async function completeDynamicOrder() {
    try {
        // Sipari≈ü verilerini hazƒ±rla
        const orderData = {
            customer_id: currentCustomer?.id || null,
            seller_id: selectedSellerId,
            total_amount: calculateTotal(),
            payment_method: currentPaymentMethod,
            location_type: selectedLocation,
            items: cart.map(item => ({
                product_id: item.id,
                quantity: item.quantity,
                unit_price: item.price,
                total_price: item.price * item.quantity
            })),
            order_date: new Date().toISOString()
        };
        
        console.log('‚úÖ Sipari≈ü tamamlandƒ±:', orderData);
        
        // Sipari≈üi sƒ±fƒ±rla
        cart = [];
        updateCartUI();
        closeDynamicCart();
        
        // K√∂k√º sƒ±fƒ±rla
        currentRoot = "0:0";
        
        speakToUser("Sipari≈üiniz ba≈üarƒ±yla alƒ±ndƒ±! Yeni bir sipari≈ü vermek i√ßin konum se√ßebilirsiniz.");
        
    } catch (error) {
        console.error('Sipari≈ü tamamlama hatasƒ±:', error);
        speakToUser("Sipari≈ü i≈ülemi sƒ±rasƒ±nda bir hata olu≈ütu. L√ºtfen tekrar deneyin.");
    }
}

        // Sepet y√∂netimi
async function handleDynamicCartManagement(data) {
    openDynamicCart();
    
    const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
    const total = calculateTotal();
    
    if (itemCount === 0) {
        speakToUser("Sepetiniz bo≈ü. √úr√ºn eklemek i√ßin alƒ±≈üveri≈üe devam edin.");
    } else {
        speakToUser(`Sepetinizde ${itemCount} √ºr√ºn bulunuyor. Toplam tutar: ${money(total)}. √ñdeme yapmak i√ßin '√∂deme yap' diyebilirsiniz.`);
    }
}

        // √ñdeme se√ßimi
async function handleDynamicPaymentSelection(data) {
    const paymentMethod = data.extractedData?.payment || data.message.toLowerCase();
    
    if (paymentMethod.includes('nakit') || paymentMethod.includes('para')) {
        await finalizeDynamicOrder('nakit');
    } else if (paymentMethod.includes('kart') || paymentMethod.includes('kredi')) {
        await finalizeDynamicOrder('kart');
    } else if (paymentMethod.includes('bonus')) {
        await finalizeDynamicOrder('bonus');
    } else {
        speakToUser("L√ºtfen √∂deme y√∂ntemi se√ßin: nakit, kart veya bonus.");
    }
}


// Navigasyon
async function handleDynamicNavigation(data) {
    // Basit geri navigasyonu
    const rootParts = currentRoot.split(':');
    const mainRoot = parseInt(rootParts[0]);
    
    if (mainRoot > 0) {
        currentRoot = `${mainRoot - 1}:0`;
        speakToUser("Bir √∂nceki adƒ±ma d√∂n√ºld√º.");
    } else {
        speakToUser("Zaten ba≈ülangƒ±√ß konumundasƒ±nƒ±z.");
    }
}

  // Yardƒ±m
async function handleDynamicHelp(data) {
    const helpMessage = getContextualHelpMessage(currentRoot);
    speakToUser(helpMessage);
}      
        
// Mevcut kategorileri getir
async function getAvailableCategories() {
    return categories.map(c => c.name).join(', ');
}        
async function getDynamicContextualHelp(rootCode) {
    const { data } = await supabase
        .from('voice_context_help')
        .select('help_message')
        .eq('root_code', rootCode)
        .eq('is_active', true)
        .single();
        
    return data?.help_message || "Nasƒ±l yardƒ±mcƒ± olabilirim? Sesli olarak sipari≈ü verebilir veya 'yardƒ±m' diyebilirsiniz.";
}

        // StoreTypes y√ºkleme fonksiyonunu g√ºncelle
async function loadStoreTypes() {
    try {
        console.log('üõçÔ∏è StoreTypes y√ºkleniyor...');
        
        const { data, error } = await supabase
            .from('store_type')
            .select('*')
            .eq('status', 'Active')
            .order('sort_code');

        if (error) {
            console.error('‚ùå StoreTypes API hatasƒ±:', error);
            // Fallback: Demo veriler
            storeTypes = getDemoStoreTypes();
            displayStoreTypes(storeTypes);
            return;
        }

        if (data && data.length > 0) {
            storeTypes = data;
            displayStoreTypes(storeTypes);
            console.log(`‚úÖ StoreTypes y√ºklendi: ${data.length} adet`);
        } else {
            // Veri yoksa demo verileri kullan
            storeTypes = getDemoStoreTypes();
            displayStoreTypes(storeTypes);
            console.log('‚ö†Ô∏è StoreTypes bulunamadƒ±, demo veriler kullanƒ±lƒ±yor');
        }

    } catch (error) {
        console.error('‚ùå StoreTypes y√ºkleme hatasƒ±:', error);
        storeTypes = getDemoStoreTypes();
        displayStoreTypes(storeTypes);
    }
}

// Demo store types
function getDemoStoreTypes() {
    return [
        { id: 1, name: 'Market', status: 'Active', sort_code: 1 },
        { id: 2, name: 'Restoran', status: 'Active', sort_code: 2 },
        { id: 3, name: 'Eczane', status: 'Active', sort_code: 3 },
        { id: 4, name: 'Fƒ±rƒ±n', status: 'Active', sort_code: 4 },
        { id: 5, name: 'Kafe', status: 'Active', sort_code: 5 }
    ];
}

// API hatalarƒ±nƒ± √∂nleme
async function safeSupabaseQuery(query, fallbackData = []) {
    try {
        const { data, error } = await query;
        
        if (error) {
            console.error('Supabase sorgu hatasƒ±:', error);
            return fallbackData;
        }
        
        return data || fallbackData;
    } catch (error) {
        console.error('Supabase sorgu istisnasƒ±:', error);
        return fallbackData;
    }
}


// =============================================
// BA≈ûLANGI√á FONKSƒ∞YONLARI
// =============================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM y√ºklendi, dinamik uygulama ba≈ülatƒ±lƒ±yor...');
    initApp();
});

// Dinamik acil durum modu
function dynamicEmergencyFallback() {
    debugLog('üÜò Dinamik acil durum modu aktif');
    setupDynamicLocationEvents();
    
    if (!selectedLocation) {
        setTimeout(() => {
            showDynamicLocationModal();
        }, 2000);
    }
}

// =============================================
// EKSƒ∞K FONKSƒ∞YONLARI TAMAMLAMA
// =============================================

// Dil se√ßeneklerini y√ºkle
async function loadLanguageOptions() {
    try {
        console.log('üåê Dil se√ßenekleri y√ºkleniyor...');
        
        // √ñnce languages tablosunun var olup olmadƒ±ƒüƒ±nƒ± kontrol et
        const { data, error } = await supabase
            .from('languages')
            .select('iso_code, name, flag, is_active')
            .eq('is_active', true)
            .order('sort_order');

        if (error) {
            console.log('‚ùå Languages tablosu hatasƒ±, fallback kullanƒ±lƒ±yor:', error);
            return getFallbackLanguages();
        }

        if (data && data.length > 0) {
            console.log(`‚úÖ ${data.length} dil se√ßeneƒüi y√ºklendi`);
            return data;
        } else {
            console.log('‚ö†Ô∏è Languages tablosu bo≈ü, fallback kullanƒ±lƒ±yor');
            return getFallbackLanguages();
        }
    } catch (error) {
        console.error('üí• Dil se√ßenekleri y√ºkleme hatasƒ±:', error);
        return getFallbackLanguages();
    }
}        
// Dinamik konum event'lerini ayarla
function setupDynamicLocationEvents() {
    const locationMarker = document.getElementById('locationMarker');
    if (locationMarker) {
        locationMarker.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            showDynamicLocationModal();
        });
        locationMarker.style.cursor = 'pointer';
    }
}

// Dinamik modal kapatma event'leri
function setupDynamicModalCloseEvents() {
    const closeLocationModal = document.getElementById('closeLocationModal');
    if (closeLocationModal) {
        closeLocationModal.addEventListener('click', function(e) {
            e.stopPropagation();
            hideDynamicLocationModal();
        });
    }
    
    const locationModal = document.getElementById('locationModal');
    if (locationModal) {
        locationModal.addEventListener('click', function(e) {
            if (e.target === locationModal) {
                speakToUser("L√ºtfen bir konum se√ßiniz. Konum se√ßmeden devam edemezsiniz.");
            }
        });
    }
}
        function getFallbackLanguages() {
    debugLog('üîÑ Fallback dil se√ßenekleri kullanƒ±lƒ±yor');
    return [
        { 
            code: 'tr', 
            name: 'T√ºrk√ße', 
            flag: 'üáπüá∑', 
            is_active: true,
            sort_order: 1
        },
        { 
            code: 'en', 
            name: 'English', 
            flag: 'üá∫üá∏', 
            is_active: true,
            sort_order: 2
        },
        { 
            code: 'de', 
            name: 'Deutsch', 
            flag: 'üá©üá™', 
            is_active: true,
            sort_order: 3
        }
    ];
}
        // =============================================
// √áOKLU Dƒ∞L DESTEƒûƒ∞ - BASƒ∞T VERSƒ∞YON
// =============================================

const translations = {
    tr: {
        app_name: "Sesli Sipari≈ü",
        select_location: "Konum Se√ßin",
        order: "Sipari≈ü:",
        profile: "Profilim",
        microphone_off: "Mikrofon (Kapalƒ±)",
        banner_title: "Sesli Sipari≈ü ile Kolay Alƒ±≈üveri≈ü",
        banner_description: "Sadece konu≈üun, sipari≈üiniz kapƒ±nƒ±zda!",
        what_to_eat: "Ne yemek istersiniz?",
        nearest_places: "Size En Yakƒ±n Yerler",
        categories: "Kategoriler",
        products: "√úr√ºnler",
        your_cart: "Sepetiniz",
        empty_cart: "Sepetiniz bo≈ü",
        subtotal: "Ara Toplam:",
        discount: "ƒ∞ndirim:",
        vat: "KDV (%18):",
        total: "Toplam:",
        pay_cash: "Nakit √ñde",
        pay_card: "Kartla √ñde",
        pay_bonus: "Bonus ile √ñde"
    },
    en: {
        app_name: "Voice Order",
        select_location: "Select Location",
        order: "Order:",
        profile: "My Profile",
        microphone_off: "Microphone (Off)",
        banner_title: "Easy Shopping with Voice Order",
        banner_description: "Just speak, your order is at your door!",
        what_to_eat: "What would you like to eat?",
        nearest_places: "Nearest Places to You",
        categories: "Categories",
        products: "Products",
        your_cart: "Your Cart",
        empty_cart: "Your cart is empty",
        subtotal: "Subtotal:",
        discount: "Discount:",
        vat: "VAT (%18):",
        total: "Total:",
        pay_cash: "Pay Cash",
        pay_card: "Pay by Card",
        pay_bonus: "Pay with Bonus"
    },
    de: {
        app_name: "Sprachbestellung",
        select_location: "Standort ausw√§hlen",
        order: "Bestellung:",
        profile: "Mein Profil",
        microphone_off: "Mikrofon (Aus)",
        banner_title: "Einfaches Einkaufen mit Sprachbestellung",
        banner_description: "Einfach sprechen, Ihre Bestellung ist vor Ihrer T√ºr!",
        what_to_eat: "Was m√∂chten Sie essen?",
        nearest_places: "N√§chste Orte zu Ihnen",
        categories: "Kategorien",
        products: "Produkte",
        your_cart: "Ihr Warenkorb",
        empty_cart: "Ihr Warenkorb ist leer",
        subtotal: "Zwischensumme:",
        discount: "Rabatt:",
        vat: "MwSt (%18):",
        total: "Gesamt:",
        pay_cash: "Bar bezahlen",
        pay_card: "Mit Karte bezahlen",
        pay_bonus: "Mit Bonus bezahlen"
    }
};

let currentLanguage = 'tr';

// Sayfayƒ± √ßevir
function translatePage(lang) {
    currentLanguage = lang;
    
    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        if (translations[lang] && translations[lang][key]) {
            if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                element.placeholder = translations[lang][key];
            } else {
                element.textContent = translations[lang][key];
            }
        }
    });
    
    // Dil d√ºƒümesini g√ºncelle
    const currentLang = getFallbackLanguages().find(l => l.code === lang);
    if (currentLang && document.getElementById('currentLanguage')) {
        document.getElementById('currentLanguage').textContent = currentLang.flag;
    }
    
    debugLog(`‚úÖ Dil deƒüi≈ütirildi: ${lang}`);
}

        // =============================================
// Dƒ∞L SELECTOR UI
// =============================================

function setupLanguageSelector() {
    const languageBtn = document.getElementById('languageBtn');
    const languageDropdown = document.getElementById('languageDropdown');
    
    if (!languageBtn || !languageDropdown) return;
    
    // Dil se√ßeneklerini olu≈ütur
    populateLanguageDropdown();
    
    // Dil deƒüi≈ütirme event'i
    languageBtn.addEventListener('click', function() {
        languageDropdown.classList.toggle('show');
    });
    
    // Dƒ±≈üarƒ± tƒ±klayƒ±nca kapat
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.language-selector')) {
            languageDropdown.classList.remove('show');
        }
    });
}

        function populateLanguageDropdown() {
    const languageDropdown = document.getElementById('languageDropdown');
    if (!languageDropdown) return;
    
    languageDropdown.innerHTML = '';
    
    const languages = getFallbackLanguages();
    
    languages.forEach(lang => {
        const option = document.createElement('div');
        option.className = `language-option ${lang.code === currentLanguage ? 'active' : ''}`;
        option.setAttribute('data-lang', lang.code);
        
        option.innerHTML = `
            <span class="flag">${lang.flag}</span>
            <span>${lang.name}</span>
            ${lang.code === currentLanguage ? '<i class="fas fa-check"></i>' : ''}
        `;
        
        option.addEventListener('click', function() {
            translatePage(lang.code);
            languageDropdown.classList.remove('show');
        });
        
        languageDropdown.appendChild(option);
    });
}
        
// Dinamik konum se√ßenekleri event'leri
function setupDynamicLocationOptionEvents() {
    document.querySelectorAll('.location-option').forEach(option => {
        option.addEventListener('click', function() {
            const locationType = this.getAttribute('data-location');
            
            document.querySelectorAll('.location-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            this.classList.add('selected');
            
            if (locationType === 'inside' || locationType === 'takeaway') {
                selectDynamicLocation(locationType);
            } else {
                // Adrese teslim i√ßin konum tespiti
                detectUserLocation().then(success => {
                    if (success) {
                        selectDynamicLocation('delivery');
                    }
                });
            }
        });
    });
    
    const detectBtn = document.getElementById('detectLocationBtn');
    if (detectBtn) {
        detectBtn.addEventListener('click', function() {
            detectUserLocation().then(success => {
                if (success) {
                    const deliveryOption = document.querySelector('.location-option[data-location="delivery"]');
                    if (deliveryOption) {
                        document.querySelectorAll('.location-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        deliveryOption.classList.add('selected');
                        selectDynamicLocation('delivery');
                    }
                }
            });
        });
    }
}

// Konum tespiti
async function detectUserLocation() {
    const resultDiv = document.getElementById('locationResult');
    const detectBtn = document.getElementById('detectLocationBtn');
    
    if (!navigator.geolocation) {
        showLocationError("Tarayƒ±cƒ±nƒ±z konum servisini desteklemiyor.");
        return false;
    }
    
    if (detectBtn) {
        detectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Konumunuz Belirleniyor...';
        detectBtn.disabled = true;
    }
    
    if (resultDiv) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div style="color: #007bff;"><i class="fas fa-spinner fa-spin"></i> Konumunuz belirleniyor...</div>';
    }
    
    try {
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            });
        });
        
        const { latitude, longitude } = position.coords;
        const address = await reverseGeocode(latitude, longitude);
        
        userLocation = {
            latitude,
            longitude,
            address: address.display_name,
            city: address.address?.city || address.address?.town || address.address?.village || 'Bilinmeyen',
            district: address.address?.suburb || address.address?.county || address.address?.state_district || 'Bilinmeyen',
            fullAddress: address.display_name
        };
        
        isLocationDetected = true;
        
        if (resultDiv) {
            resultDiv.innerHTML = `
                <div style="color: var(--success);">
                    <i class="fas fa-check-circle"></i> 
                    <strong>Konumunuz Belirlendi!</strong>
                    <div style="font-size: 12px; margin-top: 5px;">
                        ${userLocation.district}, ${userLocation.city}
                    </div>
                </div>
            `;
        }
        
        debugLog('üìç Konum tespit edildi:', userLocation);
        return true;
        
    } catch (error) {
        console.error('Konum tespit hatasƒ±:', error);
        showLocationError("Konumunuz belirlenemedi. L√ºtfen tarayƒ±cƒ± ayarlarƒ±nƒ±zdan konum eri≈üimine izin verin.");
        return false;
    } finally {
        if (detectBtn) {
            detectBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Konumumu Otomatik Belirle';
            detectBtn.disabled = false;
        }
    }
}

// Reverse geocoding
async function reverseGeocode(lat, lon) {
    try {
        const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1&zoom=18`
        );
        
        if (!response.ok) {
            throw new Error('Adres √ß√∂z√ºmleme hatasƒ±');
        }
        
        return await response.json();
    } catch (error) {
        console.error('Reverse geocoding hatasƒ±:', error);
        return {
            display_name: `Konum: ${lat.toFixed(6)}, ${lon.toFixed(6)}`,
            address: {
                city: 'Bilinmeyen',
                town: 'Bilinmeyen',
                village: 'Bilinmeyen',
                suburb: 'Bilinmeyen'
            }
        };
    }
}

// Konum hatasƒ± g√∂ster
function showLocationError(message) {
    const resultDiv = document.getElementById('locationResult');
    if (resultDiv) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div style="color: #dc3545;">
                <i class="fas fa-exclamation-triangle"></i> 
                ${message}
            </div>
        `;
    }
    speakToUser("Konumunuz tespit edilemedi.");
}

// Konum modalƒ±nƒ± gizle
function hideDynamicLocationModal() {
    const modal = document.getElementById('locationModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    }
}

// Konum metnini g√ºncelle
function updateDynamicLocationText() {
    if (locationText && selectedLocation) {
        const locationNames = {
            'inside': 'Restoran i√ßinde',
            'takeaway': 'Paket servis', 
            'delivery': 'Adrese teslim'
        };
        
        let locationTextContent = locationNames[selectedLocation] || selectedLocation;
        
        if (selectedLocation === 'delivery' && userLocation.city) {
            locationTextContent += ` - ${userLocation.district}, ${userLocation.city}`;
        }
        
        locationText.textContent = locationTextContent;
    }
}

// Dinamik konum y√∂netimi
function initializeDynamicLocation() {
    debugLog('üìç Dinamik konum y√∂netimi ba≈ülatƒ±lƒ±yor...');
    
    // Kayƒ±tlƒ± konumu kontrol et
    const savedLocation = localStorage.getItem('selectedLocation');
    const savedUserLocation = localStorage.getItem('userLocation');
    
    if (savedLocation) {
        selectedLocation = savedLocation;
        if (savedUserLocation) {
            userLocation = JSON.parse(savedUserLocation);
            isLocationDetected = true;
        }
        updateDynamicLocationText();
        currentRoot = "2:0";
        loadAllSellersByLocation();
    } else {
        // Konum modalƒ±nƒ± g√∂ster
        setTimeout(() => {
            showDynamicLocationModal();
        }, 1000);
    }
}

// Satƒ±cƒ±larƒ± store type'a g√∂re filtrele
function filterSellersByStoreType(storeTypeId) {
    if (!allSellersInLocation || allSellersInLocation.length === 0) {
        debugLog('‚ö†Ô∏è Filtrelenecek satƒ±cƒ± yok');
        filteredSellers = [];
        updateSellersGrid();
        return;
    }
    
    filteredSellers = allSellersInLocation.filter(seller => seller.store_type_id === storeTypeId);
    sellers = filteredSellers;
    
    debugLog(`üìä Store type filtresi: ${filteredSellers.length} satƒ±cƒ±`);
    updateSellersGrid();
}

// T√ºm satƒ±cƒ±larƒ± konuma g√∂re y√ºkle
async function loadAllSellersByLocation() {
    try {
        debugLog(`üîç Konumdaki t√ºm satƒ±cƒ±lar y√ºkleniyor`);
        
        let query = supabase
            .from('seller_profiles')
            .select('*')
            .eq('status', 'True');

        // Konum bilgisi varsa filtrele
        if (userLocation.city && userLocation.district) {
            const customerCity = userLocation.city;
            const customerDistrict = userLocation.district;
            
            query = query.or(`city.ilike.%${customerCity}%,district.ilike.%${customerDistrict}%,address.ilike.%${customerCity}%,address.ilike.%${customerDistrict}%`);
        }

        const { data, error } = await query.order('business_name');

        if (error) throw error;

        debugLog(`üìä Konumdaki t√ºm satƒ±cƒ±lar: ${data?.length || 0} adet`);

        if (data && data.length > 0) {
            allSellersInLocation = data;
            await addDeliveryInfoToSellers(allSellersInLocation);
            
            debugLog(`‚úÖ T√ºm satƒ±cƒ±lar y√ºklendi: ${allSellersInLocation.length} adet`);
            
            // T√ºm satƒ±cƒ±larƒ± g√∂ster
            showAllSellers();
            
            speakToUser(`Konumunuzda ${allSellersInLocation.length} satƒ±cƒ± bulundu. Hangi maƒüaza tipini se√ßmek istersiniz?`);
            
        } else {
            debugLog('‚ö†Ô∏è Bu konumda satƒ±cƒ± bulunamadƒ±');
            allSellersInLocation = [];
            showAllSellers();
            speakToUser("Bu konumda satƒ±cƒ± bulunamadƒ±. L√ºtfen konumunuzu deƒüi≈ütirin.");
        }

    } catch (error) {
        console.error('‚ùå T√ºm satƒ±cƒ±lar y√ºkleme hatasƒ±:', error);
        allSellersInLocation = getDemoSellers();
        showAllSellers();
        speakToUser("Satƒ±cƒ±lar y√ºklenirken hata olu≈ütu. Demo satƒ±cƒ±lar g√∂steriliyor.");
    }
}

// T√ºm satƒ±cƒ±larƒ± g√∂ster
function showAllSellers() {
    sellers = allSellersInLocation;
    filteredSellers = [...allSellersInLocation];
    updateSellersGrid();
    
    if (sellersSection) sellersSection.style.display = 'block';
    if (categoriesSection) categoriesSection.style.display = 'none';
    if (productsSection) productsSection.style.display = 'none';
    
    resetStoreTypeSelection();
    debugLog(`‚úÖ T√ºm satƒ±cƒ±lar g√∂steriliyor: ${sellers.length} adet`);
}

// Store type se√ßimini sƒ±fƒ±rla
function resetStoreTypeSelection() {
    document.querySelectorAll('.seller-type-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    selectedStoreTypeId = null;
    selectedStoreTypeName = null;
    debugLog('üîÑ Store type se√ßimi sƒ±fƒ±rlandƒ±');
}

// Satƒ±cƒ±lara teslimat bilgisi ekle
async function addDeliveryInfoToSellers(sellers) {
    if (!sellers || sellers.length === 0) return;
    
    debugLog(`üìç Teslimat bilgileri ekleniyor: ${sellers.length} satƒ±cƒ±`);
    
    for (const seller of sellers) {
        try {
            const { data: deliveryAreas, error } = await supabase
                .from('seller_delivery_areas')
                .select('city, district, delivery_fee, min_order_amount')
                .eq('seller_id', seller.id)
                .eq('is_active', true);

            if (error) continue;

            if (!deliveryAreas || deliveryAreas.length === 0) {
                seller.delivery_fee = 0;
                seller.min_order_amount = 0;
                seller.delivery_available = true;
                continue;
            }

            const matchedArea = deliveryAreas.find(area => {
                const areaCity = (area.city || '').toLowerCase();
                const areaDistrict = (area.district || '').toLowerCase();
                const userCity = (userLocation.city || '').toLowerCase();
                const userDistrict = (userLocation.district || '').toLowerCase();
                
                const cityMatch = areaCity.includes(userCity) || userCity.includes(areaCity);
                const districtMatch = areaDistrict.includes(userDistrict) || userDistrict.includes(areaDistrict);
                
                return cityMatch && districtMatch;
            });

            if (matchedArea) {
                seller.delivery_fee = matchedArea.delivery_fee || 0;
                seller.min_order_amount = matchedArea.min_order_amount || 0;
                seller.delivery_available = true;
            } else {
                seller.delivery_fee = null;
                seller.min_order_amount = null;
                seller.delivery_available = false;
            }

        } catch (error) {
            console.error(`Teslimat bilgisi ekleme hatasƒ± (${seller.business_name}):`, error);
            seller.delivery_fee = 0;
            seller.min_order_amount = 0;
            seller.delivery_available = true;
        }
    }
}

// Demo satƒ±cƒ±lar
function getDemoSellers() {
    return [
        { 
            id: '1', 
            business_name: "Demo Market", 
            city: userLocation.city || "ƒ∞stanbul", 
            district: userLocation.district || "Kadƒ±k√∂y",
            store_image: "https://via.placeholder.com/200x120?text=Demo+Market",
            rating: "4.5",
            delivery_fee: 5.99,
            min_order_amount: 50,
            delivery_available: true,
            store_type_id: 1
        }
    ];
}

// Reyonalarƒ± y√ºkle
async function loadReyonsBySeller(sellerId) {
    try {
        debugLog(`üì¶ Satƒ±cƒ±ya g√∂re reyonlar y√ºkleniyor: ${sellerId}`);
        
        const { data, error } = await supabase
            .from('reyon')
            .select('*')
            .order('name');

        if (error) throw error;

        debugLog(`üìä REYON SONU√á: ${data?.length || 0} reyon bulundu`);
        
        categories = data || [];
        displayCategories(categories);
        
        debugLog(`‚úÖ Satƒ±cƒ± reyonlarƒ± y√ºklendi: ${categories.length} adet`);
        
        if (categories.length === 0) {
            speakToUser("Bu satƒ±cƒ±da reyon bulunamadƒ±.");
        }

    } catch (error) {
        console.error('‚ùå Reyon y√ºkleme hatasƒ±:', error);
        categories = getDemoReyons();
        displayCategories(categories);
        speakToUser("Reyonlar y√ºklenirken hata olu≈ütu. Demo reyonlar g√∂steriliyor.");
    }
}

// Demo reyonlar
function getDemoReyons() {
    return [
        { id: 1, name: 'Meyve & Sebze' },
        { id: 2, name: 'S√ºt √úr√ºnleri' },
        { id: 3, name: 'Et & Tavuk' },
        { id: 4, name: 'Temel Gƒ±da' }
    ];
}

// √úr√ºnleri y√ºkle
async function loadProductsByReyon(reyonId) {
    try {
        debugLog(`üõí Reyona g√∂re √ºr√ºnler y√ºkleniyor: ${reyonId}, Satƒ±cƒ±: ${selectedSellerId}`);
        
        if (!selectedSellerId) {
            speakToUser("√ñnce bir satƒ±cƒ± se√ßmelisiniz.");
            return;
        }
        
        const { data, error } = await supabase
            .from('products')
            .select('*')
            .eq('reyon_id', reyonId)
            .eq('is_active', true)
            .order('name');

        if (error) throw error;

        debugLog(`üìä √úR√úN SONU√á: ${data?.length || 0} √ºr√ºn bulundu`);

        products = (data || []).map(product => ({
            id: product.id,
            name: product.name,
            price: product.price,
            discount_price: product.discount_price,
            imgurl: product.imgurl,
            reyon_id: product.reyon_id,
            unit_type: product.unit_type,
            description: product.description
        }));

        debugLog(`‚úÖ √úr√ºnler y√ºklendi: ${products.length} adet`);
        
        displayProducts(products);
        
        if (productsSection) productsSection.style.display = 'block';
        if (categoriesSection) categoriesSection.style.display = 'none';
        
        if (products.length === 0) {
            speakToUser("Bu reyonda √ºr√ºn bulunamadƒ±.");
        } else {
            speakToUser(`${products.length} √ºr√ºn bulundu. Sesli olarak sipari≈ü verebilirsiniz.`);
        }

    } catch (error) {
        console.error('‚ùå √úr√ºn y√ºkleme hatasƒ±:', error);
        products = getDemoProducts();
        displayProducts(products);
        speakToUser("√úr√ºnler y√ºklenirken hata olu≈ütu. Demo √ºr√ºnler g√∂steriliyor.");
    }
}

// Demo √ºr√ºnler
function getDemoProducts() {
    return [
        { 
            id: 'demo-1', 
            name: "S√ºt 1L", 
            price: 15.90, 
            discount_price: 12.90,
            imgurl: "https://via.placeholder.com/150x100?text=S√ºt",
            unit_type: "adet"
        },
        { 
            id: 'demo-2', 
            name: "Ekmek", 
            price: 5.50, 
            discount_price: null,
            imgurl: "https://via.placeholder.com/150x100?text=Ekmek",
            unit_type: "adet"
        }
    ];
}

// UI temizleme
function resetProductAndCategoryUI() {
    if (categoriesGrid) {
        categoriesGrid.innerHTML = '<div class="text-center">Y√ºkleniyor...</div>';
    }
    if (productsGrid) {
        productsGrid.innerHTML = '<div class="text-center">Bir reyon se√ßin</div>';
    }
    if (productsSection) productsSection.style.display = 'none';
}

// Sepet i≈ülemleri
function toggleDynamicCart() {
    if (cartContainer.classList.contains('open')) {
        closeDynamicCart();
    } else {
        openDynamicCart();
    }
}

function openDynamicCart() {
    if (cartContainer) {
        cartContainer.classList.add('open');
    }
}

function closeDynamicCart() {
    if (cartContainer) {
        cartContainer.classList.remove('open');
    }
}

// G√ºncellenmi≈ü restoreSession
async function restoreSession() {
    try {
        const savedCustomer = localStorage.getItem('currentCustomer');
        if (savedCustomer) {
            currentCustomer = JSON.parse(savedCustomer);
        }
        
        const savedCart = localStorage.getItem('cart');
        if (savedCart) {
            cart = JSON.parse(savedCart);
            console.log('üì¶ Oturumdan sepet y√ºklendi:', cart.length, '√ºr√ºn');
        } else {
            cart = []; // Emin olmak i√ßin bo≈ü array
            console.log('üì¶ Sepet oturumda bulunamadƒ±, bo≈ü array olu≈üturuldu');
        }
        
        // Kilit durumunu geri y√ºkle
        const savedLock = localStorage.getItem('isSellerLocked');
        isSellerLocked = savedLock === 'true';
        
        console.log('üîí Oturum kilit durumu:', isSellerLocked);
        
        // HEMEN G√úNCELLE - oturum y√ºklendikten sonra
        updateCartUI();
        
        debugLog('‚úÖ Oturum geri y√ºklendi');
    } catch (error) {
        console.error('Oturum geri y√ºkleme hatasƒ±:', error);
        cart = []; // Hata durumunda bo≈ü sepet
        isSellerLocked = false; // Hata durumunda kilit kapalƒ±
    }
}
        
        // UI g√ºncelleme
function updateUIAfterDynamicLogin() {
    if (currentCustomer) {
        if (userName) userName.textContent = currentCustomer.name || 'Profilim';
    }
    
    updateDynamicLocationText();
}

// Sesli komutlara sepeti bo≈üaltma ekle
function setupClearCartVoiceCommand() {
    // handleDynamicAIRequest i√ßinde veya ayrƒ± bir fonksiyonda
    const clearCartCommands = [
        'sepeti bo≈üalt', 'sepeti temizle', 'her ≈üeyi sil', 'sƒ±fƒ±rla',
        'clear cart', 'empty cart', 'reset cart'
    ];
    
    // processVoiceCommand i√ßinde kontrol et
    if (clearCartCommands.some(cmd => message.includes(cmd))) {
        clearCart();
        return true;
    }
    
    return false;
}

        
// Acil durum modu
function dynamicEmergencyFallback() {
    debugLog('üÜò Dinamik acil durum modu aktif');
    setupDynamicLocationEvents();
    
    if (!selectedLocation) {
        setTimeout(() => {
            showDynamicLocationModal();
        }, 2000);
    }
}

// DOM elementlerini bekle
function waitForDOMElements() {
    return new Promise((resolve) => {
        const elements = {
            'microphoneToggle': document.getElementById('microphoneToggle'),
            'locationModal': document.getElementById('locationModal'),
            'locationMarker': document.getElementById('locationMarker')
        };

        let attempts = 0;
        const maxAttempts = 50;

        const checkElements = () => {
            attempts++;
            const loaded = Object.values(elements).filter(el => el !== null).length;
            const total = Object.keys(elements).length;

            debugLog(`DOM y√ºkleme: ${loaded}/${total} (deneme ${attempts})`);

            if (loaded >= 2 || attempts >= maxAttempts) {
                debugLog('‚úÖ Minimum DOM elementleri y√ºklendi');
                resolve();
                return;
            }

            setTimeout(checkElements, 100);
        };

        checkElements();
    });
}



        // Kƒ±sa √∂rnek - geri kalanlar √∂nceki cevaptan alƒ±nacak
        async function loadStoreTypes() {
            try {
                const { data, error } = await supabase
                    .from('store_type')
                    .select('*')
                    .eq('status', 'Active')
                    .order('sort_code');

                if (error) throw error;

                if (data && data.length > 0) {
                    storeTypes = data;
                    displayStoreTypes(storeTypes);
                    debugLog(`‚úÖ StoreTypes y√ºklendi: ${data.length} adet`);
                }
            } catch (error) {
                console.error('‚ùå StoreTypes y√ºkleme hatasƒ±:', error);
            }
        }

        // Sayfa y√ºklendiƒüinde uygulamayƒ± ba≈ülat
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM y√ºklendi, dinamik uygulama ba≈ülatƒ±lƒ±yor...');
            initApp();
        });

    </script>
</body>
</html>



































