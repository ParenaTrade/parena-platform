<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sesli Sipari≈ü - Dinamik Sistem</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
       :root {
            --primary: #5d3ebc;
            --primary-light: #7849f7;
            --secondary: #ffd300;
            --accent: #ff6b00;
            --dark: #1a1a1a;
            --light: #f8f9fa;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --success: #28a745;
            --danger: #dc3545;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            line-height: 1.6;
        }
        
        /* Header Styles */
        header {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 22px;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .logo-icon::after {
            content: "";
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--secondary);
            border-radius: 50%;
            bottom: 5px;
            right: 5px;
        }
        
       /* HEADER ACTIONS - MESAFE AZALTILDI */
.header-actions {
    display: flex;
    align-items: center;
    gap: 8px !important; /* AZALTILDI: 15px -> 8px */
    height: 100%;
}
        
        .action-btn {
            background: none;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: var(--transition);
            color: var(--dark);
            font-weight: 500;
            font-size: 14px;
        }
        
        .action-btn:hover {
            background: var(--gray-light);
        }

 /* √úR√úN GRID HEADER SABƒ∞T SLIDER STƒ∞LLERƒ∞ - D√úZELTƒ∞LMƒ∞≈û */
.command-slider-header {
    position: fixed;
    top: 120px;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 800px;
    background: var(--primary); /* Mavi zemin */
    border: 3px solid var(--secondary); /* Sarƒ± √ßer√ßeve */
    border-radius: 15px;
    padding: 15px 20px;
    margin-top: 15px;
    display: flex !important;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    z-index: 10000;
    opacity: 1 !important;
    visibility: visible !important;
}

        
/* Products section'dan tamamen baƒüƒ±msƒ±z */
.products-section {
    position: relative;
}

        /* SADECE BUNU EKLEYƒ∞N - Products section gizli olsa bile slider g√∂z√ºks√ºn */
.products-section .command-slider-header {
    display: flex !important;
    opacity: 1 !important;
    visibility: visible !important;
}

.slider-content {
    display: flex;
    align-items: center;
    justify-content: center; /* ƒ∞√ßeriƒüi ortala */
    gap: 20px;
    font-size: 15px;
    font-weight: 700;
    color: var(--dark);
    width: 100%;
    text-align: center; /* Metinleri ortala */
}
.slider-icon {
    color: var(--secondary); /* Sarƒ± icon */
    font-size: 20px;
    filter: drop-shadow(0 2px 3px rgba(0,0,0,0.4));
}

.slider-title {
    position: absolute;
    top: -30px; /* Slider'ƒ±n √ºst√ºne ta≈üƒ± */
    left: 50%;
    transform: translateX(-50%);
    font-weight: 800;
    color: var(--secondary);
    font-size: 16px;
    white-space: nowrap;
    background: var(--primary); /* Arka plan rengi */
    padding: 5px 15px;
    border-radius: 10px;
    border: 2px solid var(--secondary);
    z-index: 100;
}
.slider-examples-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    flex: 1;
    min-height: 50px;
    position: relative;
}

.slider-example-group {
    display: flex;
    align-items: center;
    gap: 15px;
    opacity: 0;
    transform: translateX(20px);
    transition: all 0.8s ease-in-out;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    justify-content: center;
}

.slider-example-group.active {
    opacity: 1;
    transform: translateX(0);
}

.slider-example {
    display: flex;
    align-items: center;
    gap: 10px;
    white-space: nowrap;
    font-size: 14px;
    font-weight: 700;
    padding: 10px 16px;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.95); /* Beyaz/gri i√ß zemin */
    color: var(--dark);
    border: 2px solid var(--secondary);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.25);
    min-width: max-content;
    transition: all 0.3s ease;
    position: relative;
}

.slider-example i {
    color: var(--accent); /* Turuncu icon */
    font-size: 16px;
}

.slider-example.active-example {
    background: white;
    border-color: var(--accent);
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(255, 107, 0, 0.3);
    z-index: 2;
}

.slider-example.active-example::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    border: 2px solid var(--secondary);
    border-radius: 12px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
}

/* Slider kontrol butonlarƒ± */
.slider-controls {
    display: flex;
    gap: 10px;
    margin-left: 15px;
}

.slider-btn {
    background: var(--secondary);
    color: var(--dark);
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.slider-btn:hover {
    background: var(--accent);
    color: white;
    transform: scale(1.1);
}

/* üÜï SESLƒ∞ KOMUT Bƒ∞LDƒ∞Rƒ∞Mƒ∞ STƒ∞LLERƒ∞ */
.voice-command-notification {
    position: relative; /* ‚≠ê DEƒûƒ∞≈ûTƒ∞: absolute yerine relative */
    width: 100%;
    margin: 0;
    padding: 0 10px;
    animation: pulseGlow 2s infinite;
    z-index: 10;
}
/* SADECE Bƒ∞LDƒ∞Rƒ∞M CONTAINER'I ƒ∞√áƒ∞N */
.voice-notification-container {
    width: 100%;
    text-align: center;
    margin-top: 5px; /* Slider ile arasƒ±na k√º√ß√ºk bo≈üluk */
    padding: 0 10px;
}

.voice-notification-content {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: linear-gradient(135deg, #fff3cd, #ffeb3b);
    color: #856404;
    border: 2px solid #ffc107;
    border-radius: 20px;
    font-weight: 600;
    font-size: 13px;
    box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
    animation: pulseGlow 2s infinite;
}


.voice-notification-content {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: linear-gradient(135deg, #fff3cd, #ffeb3b);
    color: #856404;
    border: 2px solid #ffc107;
    border-radius: 20px;
    font-weight: 600;
    font-size: 13px;
    box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
    width: auto;
    max-width: 100%;
}

.voice-notification-content i {
    color: #ff5722;
    animation: bounce 1s infinite;
}

.voice-notification-text {
    font-weight: 700;
}

/* Yanƒ±p S√∂nme Animasyonu */
@keyframes pulseGlow {
    0%, 100% { 
        opacity: 1;
        transform: scale(1);
    }
    50% { 
        opacity: 0.9;
        transform: scale(1.02);
    }
}

/* Mikrofon Bounce Animasyonu */
@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-2px); }
}
        
   .order-summary {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    background: var(--primary); /* her zaman mavi */
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    box-shadow: var(--shadow);
    line-height: 1;
}

/* Hover durumunda da mavi kalsƒ±n */
.order-summary:hover {
    background: var(--primary); /* aynƒ± mavi renk */
    transform: translateY(-1px); /* sadece hafif kaldƒ±rma efekti */
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15); /* g√∂lgeyi biraz artƒ±r */
}

/* Sayƒ± yuvarlak ve ortalanmƒ±≈ü g√∂r√ºn√ºm */
.order-count {
    background: white;
    color: var(--primary);
    border-radius: 50%;
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 12px;
}

/* ORDER SUMMARY BUTON - Dƒ∞ƒûER BUTONLARLA AYNI Hƒ∞ZADA */
.header-actions .order-summary {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 10px !important;
    background: var(--primary) !important;
    color: white !important;
    padding: 8px 16px !important; /* Dikey padding'i biraz artƒ±rdƒ±k */
    border-radius: 20px !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    transition: var(--transition) !important;
    box-shadow: var(--shadow) !important;
    line-height: 1 !important;
    height: 40px !important; /* Sabit y√ºkseklik */
    margin: 0 !important; /* Margin sƒ±fƒ±rla */
    border: none !important;
    vertical-align: middle !important; /* Dikey hizalama */
}

/* Hover durumu */
.header-actions .order-summary:hover {
    background: var(--primary) !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15) !important;
}

.header-actions .order-summary .order-count {
    background: white !important;
    color: var(--primary) !important;
    border-radius: 50% !important;
    width: 18px !important; /* DAHA K√ú√á√úK */
    height: 18px !important; /* DAHA K√ú√á√úK */
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-weight: 700 !important;
    font-size: 10px !important; /* DAHA K√ú√á√úK */
    border: none !important;
}        
.store-type-number {
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--primary);
    color: var(--secondary);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    border: 2px solid var(--secondary);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}


/* √úR√úN NUMARASI - SOL √úST */
.product-number {
    position: absolute;
    top: 10px;
    left: 10px;
    background: var(--primary);
    color: var(--secondary);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    border: 2px solid var(--secondary);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 3; /* Daha y√ºksek */
}



        
        .language-selector {
            position: relative;
        }
        
        .language-btn {
            background: none;
            border: none;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 10px 0;
            width: 200px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 10;
        }
        
        .language-dropdown.show {
            display: block;
        }
        
        .language-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .language-option:hover {
            background: var(--gray-light);
        }
        
        .language-option.active {
            background: var(--primary);
            color: white;
        }
        
        /* Banner Styles */
        .banner {
            position: relative;
            height: 300px;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 0 20px;
        }
        
        .banner-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.2;
        }
        
        .banner-content {
            position: relative;
            z-index: 2;
            max-width: 600px;
        }
        
        .banner h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            font-weight: 700;
        }
        
        .banner p {
            font-size: 1.1rem;
            margin-bottom: 20px;
            opacity: 0.9;
        }
        
        /* Main Content */
        .main-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            flex: 1;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: var(--primary);
        }
        
        /* Horizontal Scroll Containers */
        .scroll-container {
            position: relative;
            margin-bottom: 30px;
        }
        
        .scroll-content {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
            scroll-behavior: smooth;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scroll-content::-webkit-scrollbar {
            display: none;
        }
        
        .scroll-btn {
            position: absolute;
            top: 70%;
            transform: translateY(-50%);
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            z-index: 10;
            transition: var(--transition);
        }
        
        .scroll-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .scroll-btn.left {
            left: -50px;
        }
        
        .scroll-btn.right {
            right: -50px;
        }

        
        /* Store Type Cards (Horizontal) */
        .seller-type-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            min-width: 150px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            position: relative; /* Numarayƒ± konumlandƒ±rmak i√ßin */
        }
        
        .seller-type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .seller-type-card.selected {
            border-color: var(--primary);
            background: rgba(93, 62, 188, 0.05);
        }
        
        .seller-type-icon {
            font-size: 32px;
            color: var(--primary);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(93, 62, 188, 0.1);
        }
        
        .seller-type-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        /* Seller Cards (Horizontal) */
       /* Satƒ±cƒ± Kartƒ± Konteyneri */
.seller-card {
    background: white;
    border-radius: var(--border-radius);
    overflow: hidden;
    cursor: pointer;
    transition: var(--transition);
    box-shadow: var(--shadow);
    border: 2px solid transparent;
    min-width: 280px;
    flex-shrink: 0;
    position: relative; /* Numarayƒ± konumlandƒ±rmak i√ßin */
    padding-top: 10px; /* √ústteki elementler i√ßin bo≈üluk */
}

 .seller-number-badge {
    display: flex;
    align-items: center;
    gap: 6px; /* 1 ile Market arasƒ±nda bo≈üluk */
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 5;
}
        
   /* Satƒ±cƒ± Numarasƒ± - SOL √úST */

.seller-number {
    background: var(--primary);
    color: var(--secondary);
    font-weight: bold;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}        
        
        .seller-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }


        .seller-card.selected {
            border-color: var(--success);
        }
        
        .seller-image {
            width: 100%;
            height: 160px;
            margin-top: 32px; /* Yakla≈üƒ±k 2 satƒ±r bo≈üluk */
            object-fit: cover;
        }
        
        .seller-info {
            padding: 15px;
        }
        
        .seller-name {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 18px;
        }
        
        .seller-details {
            font-size: 14px;
            color: var(--gray);
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .seller-rating {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--secondary);
        }
        
        .delivery-info {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--gray-light);
        }
        
        .delivery-fee {
            font-size: 14px;
            color: var(--primary);
            font-weight: 600;
        }
        
        .delivery-fee.free {
            color: var(--success);
        }
        
        .min-order {
            font-size: 12px;
            color: var(--gray);
            margin-top: 2px;
        }
        
        /* Category Cards (Horizontal) */
        .category-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            min-width: 150px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            position: relative; /* Numarayƒ± konumlandƒ±rmak i√ßin */
        }
    .category-number {
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--primary);
    color: var(--secondary);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    border: 2px solid var(--secondary);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 2;
}
        
        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .category-card.selected {
            border-color: var(--success);
            background: rgba(40, 167, 69, 0.05);
        }
        
        .category-icon {
            font-size: 32px;
            color: var(--success);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(40, 167, 69, 0.1);
        }
        
        .category-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        /* Product Cards (Horizontal) */
        .products-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }
        
        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .product-card {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-light);
            min-width: 200px;
            flex-shrink: 0;
        }
        
        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .product-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .product-image {
            width: 100%;
            height: 140px;
            object-fit: cover;
        }
        
        .product-info {
            padding: 15px;
        }
        
        .product-name {
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
            height: 40px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .product-price {
            font-weight: 600;
            color: var(--primary);
            font-size: 16px;
        }
        
        .product-discount {
            color: var(--danger);
            font-size: 12px;
            text-decoration: line-through;
            margin-left: 5px;
        }

/* Sesli komut ipucu stili - D√úZELTƒ∞LMƒ∞≈û */
.voice-command-hint {
    position: absolute;
    bottom: clamp(60px, 15%, 60px); /* Min 30px, ideal 15%, max 60px */
    right: 10px;
    background: rgba(93, 62, 188, 0.9);
    color: white;
    padding: 5px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 3;
}

.product-card:hover .voice-command-hint {
    opacity: 1;
}
/* SEPETTEKƒ∞ √úR√úN SAYACI */
.product-cart-count {
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--success);
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 12px;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 2;
}

/* KOMUT SLIDER STƒ∞LLERƒ∞ */
.command-slider {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.95);
    padding: 12px 20px;
    border-radius: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 15px;
    font-size: 14px;
    font-weight: 500;
    color: var(--primary);
    border: 2px solid var(--primary-light);
}

.command-example {
    display: flex;
    align-items: center;
    gap: 8px;
    opacity: 0.7;
    transition: opacity 0.3s ease;
    white-space: nowrap;
}

.command-example.active {
    opacity: 1;
    font-weight: 600;
}

.command-examples-container {
    display: flex;
    gap: 15px;
    overflow: hidden;
    width: 300px;
}

/* Responsive d√ºzenlemeler */
@media (max-width: 768px) {
    .command-slider {
        bottom: 70px;
        padding: 10px 15px;
        font-size: 12px;
    }
    
    .command-examples-container {
        width: 200px;
    }
    
    .command-example {
        font-size: 11px;
    }
}
        
        .add-to-cart-btn {
            margin-top: 10px;
            width: 100%;
            padding: 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .add-to-cart-btn:hover {
            background: var(--primary-light);
        }
        
        /* Cart Section */
        .cart-container {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background: white;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .cart-container.open {
            right: 0;
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .cart-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray);
        }
        
        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .cart-item-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .cart-item-image {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .cart-item-details {
            font-size: 14px;
        }
        
        .cart-item-name {
            font-weight: 500;
        }
        
        .cart-item-price {
            color: var(--gray);
            font-size: 12px;
        }
        
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid var(--gray-light);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .quantity-btn:hover {
            background: var(--gray-light);
        }
        
        .cart-totals {
            border-top: 1px solid var(--gray-light);
            padding: 20px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .total-final {
            font-weight: 600;
            font-size: 18px;
            border-top: 1px solid var(--gray-light);
            padding-top: 10px;
        }
        
        .payment-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
            padding: 0 20px 20px;
        }
        
        .payment-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .payment-btn.cash {
            background: var(--success);
            color: white;
        }
        
        .payment-btn.card {
            background: var(--primary);
            color: white;
        }
        
        .payment-btn.bonus {
            background: var(--accent);
            color: white;
            grid-column: 1 / -1;
        }
        
        .payment-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .payment-methods {
    text-align: center;
    margin: 20px 0;
}

.payment-btn {
    display: block;
    width: 200px;
    margin: 10px auto;
    padding: 15px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s;
}

.cash-btn {
    background: #28a745;
    color: white;
}

.card-btn {
    background: #007bff;
    color: white;
}

.payment-btn:hover {
    opacity: 0.8;
    transform: scale(1.05);
}
        /* Footer */
        footer {
            background: var(--dark);
            color: white;
            padding: 40px 0 20px;
            margin-top: auto;
        }
        
        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
        }
        
        .footer-section h3 {
            margin-bottom: 20px;
            font-size: 18px;
            color: var(--secondary);
        }
        
        .footer-links {
            list-style: none;
        }
        
        .footer-links li {
            margin-bottom: 10px;
        }
        
        .footer-links a {
            color: #ccc;
            text-decoration: none;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .footer-links a:hover {
            color: white;
        }
        
        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .social-link {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            transition: var(--transition);
        }
        
        .social-link:hover {
            background: var(--primary);
            transform: translateY(-3px);
        }
        
        .partner-login {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .partner-login:hover {
            background: var(--primary-light);
        }
        
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            margin-top: 20px;
            border-top: 1px solid #444;
            font-size: 14px;
            color: #aaa;
        }
        
        /* Voice Assistant */
        .voice-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 300px;
            z-index: 100;
            display: block;
        }
        
        .status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .status-title {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: var(--dark);
        }
        
        .status-title i {
            margin-right: 8px;
            color: var(--accent);
        }
        
        .status-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--gray);
        }
        
        .status-content {
            margin-bottom: 15px;
        }
        
/* Display mesaj stilleri */
.assistant-message {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    font-size: 14px;
    line-height: 1.4;
    transition: all 0.3s ease;
    border-left: 4px solid var(--primary);
    background: rgba(93, 62, 188, 0.1);
    color: var(--dark);
}
        
 .assistant-message.success {
    background: rgba(40, 167, 69, 0.1);
    color: var(--success);
    border-left-color: var(--success);
}   

        .assistant-message.error {
    background: rgba(220, 53, 69, 0.1);
    color: var(--danger);
    border-left-color: var(--danger);
}
        .user-message {
            padding: 12px;
            background: rgba(255, 107, 0, 0.1);
            border-radius: 8px;
            text-align: right;
            color: var(--accent);
        }
        
        .voice-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 30px;
            margin-top: 10px;
        }
        
        .voice-bar {
            width: 6px;
            height: 10px;
            background: #ddd;
            margin: 0 3px;
            border-radius: 3px;
        }
        
        .listening .voice-bar {
            animation: voiceIndicator 0.8s infinite;
        }
        
        @keyframes voiceIndicator {
            0%, 100% { height: 10px; background: #ddd; }
            50% { height: 30px; background: var(--accent); }
        }
        
        /* Location Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 100%;
            box-shadow: var(--shadow);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .close-modal {
            cursor: pointer;
            font-size: 24px;
            color: var(--gray);
        }
        
        .location-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .location-option {
            padding: 20px;
            border: 2px solid var(--gray-light);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .location-option:hover {
            border-color: var(--primary);
            background: rgba(93, 62, 188, 0.05);
        }
        
        .location-option.selected {
            border-color: var(--primary);
            background: rgba(93, 62, 188, 0.1);
        }
        
        .location-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .location-details h4 {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .location-details p {
            color: var(--gray);
            font-size: 14px;
        }
        
        .location-detect-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 20px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: var(--transition);
        }
        
        .location-detect-btn:hover {
            background: var(--primary-light);
        }
        
        .location-detect-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }
        
        .location-result {
            border-left: 4px solid var(--primary);
            padding: 15px;
            background: rgba(93, 62, 188, 0.05);
            border-radius: 8px;
            margin-top: 15px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .logo {
                font-size: 20px;
            }
        
            
            .banner {
                height: 250px;
            }
            
            .banner h1 {
                font-size: 2rem;
            }
            
            .banner p {
                font-size: 1rem;
            }
            
            .scroll-btn {
                display: none;
            }
            
            .cart-container {
                width: 100%;
                right: -100%;
            }
            
            .voice-status {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
            }
            
            .footer-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        
        /* Animation for logo */
        @keyframes logoPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .logo-icon {
            animation: logoPulse 2s infinite;
        }

  #sellerTypeGrid {
   display: flex;
   gap: 15px;
   overflow-x: auto;
}
  /* ============================================= */
/* √ñDEME MODAL STƒ∞LLERƒ∞ */
/* ============================================= */

.payment-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
}

.payment-modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    animation: slideInUp 0.3s ease-out;
}

@keyframes slideInUp {
    from {
        transform: translateY(50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.payment-modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.payment-modal-header h3 {
    margin: 0;
    font-size: 1.4rem;
    font-weight: 600;
}

.close-payment-modal {
    font-size: 24px;
    cursor: pointer;
    background: none;
    border: none;
    color: white;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.3s;
}

.close-payment-modal:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

.payment-modal-body {
    padding: 20px;
    max-height: 400px;
    overflow-y: auto;
}

.payment-modal-footer {
    padding: 15px 20px;
    border-top: 1px solid #eee;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

/* ============================================= */
/* √ñDEME ADIM STƒ∞LLERƒ∞ */
/* ============================================= */

.payment-step {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    background: #f8f9fa;
    border-left: 4px solid #667eea;
}

.payment-step.active {
    background: #e3f2fd;
    border-left-color: #2196f3;
}

.step-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
    flex-shrink: 0;
}

.step-content {
    flex: 1;
}

.step-content h4 {
    margin: 0 0 5px 0;
    color: #333;
    font-size: 1.1rem;
}

.step-content p {
    margin: 0 0 10px 0;
    color: #666;
    font-size: 0.9rem;
}

.input-display {
    background: white;
    padding: 10px 15px;
    border-radius: 6px;
    border: 1px solid #ddd;
    font-weight: 500;
    color: #333;
    min-height: 40px;
    display: flex;
    align-items: center;
}

/* ============================================= */
/* ONAY BUTONLARI */
/* ============================================= */

.confirmation-buttons {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.confirm-btn {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.yes-btn {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
}

.yes-btn:hover {
    background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
}

.no-btn {
    background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
    color: white;
}

.no-btn:hover {
    background: linear-gradient(135deg, #da190b 0%, #c62828 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
}

/* ============================================= */
/* MANUEL FORM STƒ∞LLERƒ∞ */
/* ============================================= */

.manual-payment-form {
    padding: 10px 0;
}

.manual-payment-form h4 {
    margin: 0 0 20px 0;
    color: #333;
    font-size: 1.2rem;
    text-align: center;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #555;
    font-size: 0.9rem;
}

.form-group input,
.form-group textarea {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.9rem;
    transition: border-color 0.3s, box-shadow 0.3s;
    box-sizing: border-box;
}

.form-group input:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group textarea {
    resize: vertical;
    min-height: 80px;
}

.payment-methods {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.payment-method {
    flex: 1;
    min-width: 80px;
}

.payment-method input[type="radio"] {
    display: none;
}

.payment-method span {
    display: block;
    padding: 10px 15px;
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    font-weight: 500;
}

.payment-method input[type="radio"]:checked + span {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: #667eea;
}

.payment-method span:hover {
    border-color: #667eea;
    transform: translateY(-1px);
}

.order-summary {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 6px;
    margin-top: 20px;
    border-left: 4px solid #28a745;
}

.order-summary h5 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 1rem;
}

.order-summary p {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: #28a745;
}

/* ============================================= */
/* BUTON STƒ∞LLERƒ∞ */
/* ============================================= */

.manual-edit-btn,
.save-payment-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.manual-edit-btn {
    background: #6c757d;
    color: white;
}

.manual-edit-btn:hover {
    background: #5a6268;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
}

.save-payment-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
}

.save-payment-btn:hover {
    background: linear-gradient(135deg, #218838 0%, #1e9e8a 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

/* ============================================= */
/* Sƒ∞PARƒ∞≈û √ñZETƒ∞ STƒ∞LLERƒ∞ */
/* ============================================= */

.order-summary-details {
    background: white;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    margin-bottom: 15px;
}

.order-summary-details p {
    margin: 8px 0;
    font-size: 0.9rem;
    color: #555;
}

.order-summary-details strong {
    color: #333;
}

/* ============================================= */
/* RESPONSIVE TASARIM */
/* ============================================= */

@media (max-width: 768px) {
    .payment-modal-content {
        width: 95%;
        margin: 10px;
    }
    
    .payment-modal-body {
        padding: 15px;
        max-height: 50vh;
    }
    
    .payment-step {
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }
    
    .step-icon {
        align-self: center;
    }
    
    .confirmation-buttons {
        flex-direction: column;
    }
    
    .payment-methods {
        flex-direction: column;
    }
    
    .payment-modal-footer {
        flex-direction: column;
    }
    
    .manual-edit-btn,
    .save-payment-btn {
        width: 100%;
        justify-content: center;
    }
}

/* ============================================= */
/* ANƒ∞MASYONLAR */
/* ============================================= */

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
    }
}

.payment-step.active .step-icon {
    animation: pulse 2s infinite;
}

/* ============================================= */
/* SCROLLBAR STƒ∞LLERƒ∞ */
/* ============================================= */

.payment-modal-body::-webkit-scrollbar {
    width: 6px;
}

.payment-modal-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.payment-modal-body::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 3px;
}

.payment-modal-body::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
}     

const storeTypeFilterStyles = `

/* Maƒüaza Tipi Rozeti */
.store-type-badge {
    background: var(--primary, #007bff);
    color: white;
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 600;
    white-space: nowrap;
}
    .seller-type-card[data-type-id="all"] .seller-type-icon {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.seller-type-card[data-type-id="all"] .store-type-number {
    background: #667eea;
}

.filter-info {
    background: #e3f2fd;
    padding: 10px 15px;
    border-radius: 8px;
    margin: 10px 0;
    font-size: 14px;
    color: #1976d2;
    border-left: 4px solid #2196f3;
}

.show-all-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    margin-top: 10px;
    transition: all 0.3s ease;
}

.show-all-btn:hover {
    background: var(--primary-light);
    transform: translateY(-1px);
}

        const sellerStatusStyles = `
        
.seller-closed {
    opacity: 0.7;
    filter: grayscale(0.3);
    position: relative;
}

.seller-closed::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.1);
    pointer-events: none;
    border-radius: var(--border-radius);
}

/* Satƒ±cƒ± Durum Rozeti - SAƒû √úST */
.seller-status-badge {
    position: absolute;
    top: 10px;
    right: 10px; /* Saƒü tarafa ta≈üƒ±ndƒ± */
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    z-index: 3;
    /* transform: none !important; kaldƒ±rƒ±ldƒ± */
    white-space: nowrap;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
}

.seller-status-badge.open {
    background: var(--success);
    color: white;
}

.seller-status-badge.closed {
    background: var(--danger);
    color: white;
}

.working-hours {
    font-size: 12px;
    color: var(--gray);
    margin: 5px 0;
    display: flex;
    align-items: center;
    gap: 5px;
}

        /* Kilit ƒ∞konu */
.seller-lock-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    z-index: 10;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 10px;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}
        
/* Manuel Kapalƒ± Uyarƒ±sƒ± */
.manual-closed-notice {
    position: absolute;
    top: 40px; /* Durum rozetinin altƒ±na */
    right: 10px;
    background: var(--danger);
    color: white;
    padding: 3px 8px;
    border-radius: 8px;
    font-size: 10px;
    font-weight: 600;
    z-index: 2;
}

.seller-card {
    transition: all 0.3s ease;
}

.seller-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.seller-closed:hover {
    transform: none;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

/* ============================================= */
/* YENƒ∞ DURUM STƒ∞LLERƒ∞ */
/* ============================================= */

.seller-status-badge.manual-closed {
    background: #ff6b00;
    color: white;
}

.seller-status-message {
    font-size: 12px;
    color: #666;
    margin: 3px 0;
    font-style: italic;
}

.seller-card.seller-closed {
    opacity: 0.6;
    filter: grayscale(0.5);
}

.seller-card.seller-closed .seller-image {
    filter: brightness(0.8);
}

/* Manuel kapalƒ± durumu i√ßin √∂zel stil */
.seller-card .seller-status-badge.manual-closed {
    background: linear-gradient(135deg, #ff6b00, #ff8c00);
}    

/* Seller Status Styles */
.seller-status-open { color: green; font-weight: bold; }
.seller-status-closed { color: red; font-weight: bold; }
.seller-status-icon { margin-right: 5px; }

/* Store Type Filter Styles */
.store-type-filter { 
    margin: 15px 0; 
    padding: 10px;
    background: #f5f5f5;
    border-radius: 8px;
}
.store-type-buttons { 
    display: flex; 
    gap: 10px; 
    flex-wrap: wrap;
}
.store-type-btn { 
    padding: 8px 16px;
    border: 1px solid #ddd;
    border-radius: 20px;
    background: white;
    cursor: pointer;
}
.store-type-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

/* Seller Card Styles */
.seller-card {
    background: white;
    border-radius: 12px;
    padding: 15px;
    margin: 10px 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 2px solid transparent;
    transition: all 0.3s ease;
}
.seller-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}
.seller-card.selected {
    border-color: #28a745;
    background: rgba(40, 167, 69, 0.05);
}
.seller-card.closed {
    opacity: 0.6;
    filter: grayscale(0.3);
}

/* Working Hours Styles */
.working-hours {
    font-size: 14px;
    color: #666;
    margin: 8px 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Status Badges */
.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    margin: 5px 0;
}
.status-open {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}
.status-closed {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
.status-manual-closed {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

/* Delivery Info Styles */
.delivery-info {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #eee;
}
.delivery-fee {
    font-size: 14px;
    color: #28a745;
    font-weight: 600;
}
.delivery-unavailable {
    font-size: 14px;
    color: #dc3545;
    font-weight: 600;
}

/* Lock System Styles */
.lock-indicator {
    position: fixed;
    top: 80px;
    right: 20px;
    background: #28a745;
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}
.locked-card {
    opacity: 0.6;
    pointer-events: none;
    position: relative;
}
.locked-card::before {
    content: "üîí";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    z-index: 2;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 10px;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Responsive Design */
@media (max-width: 768px) {
    .store-type-buttons {
        flex-direction: column;
    }
    .store-type-btn {
        width: 100%;
        text-align: center;
    }
    .seller-card {
        margin: 8px 0;
        padding: 12px;
    }
    .lock-indicator {
        top: 60px;
        right: 10px;
        left: 10px;
        text-align: center;
    }
}

/* Animation Styles */
@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
    }
}

.seller-card.selected {
    animation: pulse 2s infinite;
}

/* Scrollbar Styles */
.seller-grid::-webkit-scrollbar {
    width: 6px;
}
.seller-grid::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}
.seller-grid::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 3px;
}

        /* SESLƒ∞ INPUT STƒ∞LLERƒ∞ */
.voice-input-success {
    border: 2px solid var(--success) !important;
    background-color: rgba(40, 167, 69, 0.05) !important;
    animation: voicePulseSuccess 2s infinite;
}

.voice-input-error {
    border: 2px solid var(--danger) !important;
    background-color: rgba(220, 53, 69, 0.05) !important;
    animation: voicePulseError 2s infinite;
}

.voice-field-highlight {
    border: 2px solid var(--primary) !important;
    box-shadow: 0 0 0 3px rgba(93, 62, 188, 0.2) !important;
    animation: voiceFieldPulse 1.5s infinite;
}

@keyframes voicePulseSuccess {
    0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
}

@keyframes voicePulseError {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}

@keyframes voiceFieldPulse {
    0%, 100% { box-shadow: 0 0 0 3px rgba(93, 62, 188, 0.2); }
    50% { box-shadow: 0 0 0 6px rgba(93, 62, 188, 0.1); }
}

/* √ñdeme Y√∂ntemi Se√ßimi */
.payment-method-selection {
    text-align: center;
    padding: 20px;
}

.payment-method-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 20px;
}

.payment-method-btn {
    padding: 15px 25px;
    border: 2px solid #ddd;
    border-radius: 10px;
    background: white;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    min-width: 120px;
}

.cash-btn {
    border-color: #28a745;
    color: #28a745;
}

.cash-btn:hover {
    background: #28a745;
    color: white;
}

.card-btn {
    border-color: #007bff;
    color: #007bff;
}

.card-btn:hover {
    background: #007bff;
    color: white;
}

/* Onay Dialog */
.confirmation-dialog {
    text-align: center;
    padding: 20px;
}

.confirmation-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 20px;
}

.confirm-btn {
    padding: 12px 25px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    min-width: 100px;
}

.yes-btn {
    background: #28a745;
    color: white;
}

.yes-btn:hover {
    background: #218838;
}

.no-btn {
    background: #dc3545;
    color: white;
}

.no-btn:hover {
    background: #c82333;
}

/* √ñdeme Se√ßenekleri Grid */
.payment-options-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-top: 20px;
}

.payment-option {
    padding: 20px 15px;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    background: white;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
}

.payment-option:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.payment-icon {
    font-size: 24px;
    margin-bottom: 8px;
}

.payment-text {
    font-weight: 600;
    color: #495057;
}

/* Bonus √ñdeme B√∂l√ºm√º */
.bonus-payment-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin: 20px 0;
    border-left: 4px solid #ff6b00;
}

.bonus-info {
    margin-bottom: 20px;
}

.bonus-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding: 8px 0;
    border-bottom: 1px solid #dee2e6;
}

.bonus-balance {
    color: #28a745;
    font-weight: bold;
}

.remaining-balance.negative {
    color: #dc3545;
    font-weight: bold;
}

.remaining-balance.positive {
    color: #28a745;
    font-weight: bold;
}

.remaining-payment-options {
    background: white;
    padding: 20px;
    border-radius: 8px;
    border: 2px solid #e9ecef;
}

.remaining-payment-title {
    font-weight: 600;
    margin-bottom: 15px;
    text-align: center;
    color: #495057;
}

.payment-buttons-remaining {
    display: flex;
    gap: 15px;
    justify-content: center;
}

.payment-option-btn {
    flex: 1;
    padding: 15px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 500;
}

.payment-option-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.payment-option-btn.selected {
    border-color: #007bff;
    background: #007bff;
    color: white;
}

.cash-option.selected {
    border-color: #28a745;
    background: #28a745;
}

.card-option.selected {
    border-color: #17a2b8;
    background: #17a2b8;
}

.full-bonus-success {
    text-align: center;
    padding: 20px;
    background: #d4edda;
    border-radius: 8px;
    border: 1px solid #c3e6cb;
}

.success-badge {
    color: #155724;
    font-weight: bold;
    margin-bottom: 10px;
    font-size: 16px;
}

.new-balance-info {
    color: #155724;
    font-size: 14px;
}

.payment-confirmed-badge {
    background: #d4edda;
    color: #155724;
    padding: 12px;
    border-radius: 6px;
    text-align: center;
    font-weight: 600;
    margin-top: 15px;
}

/* Manuel D√ºzenleme */
.manual-edit-section {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
}

.manual-edit-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-control {
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.manual-edit-btn {
    width: 100%;
    padding: 12px;
    background: #6c757d;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 15px;
    transition: all 0.3s;
    font-weight: 500;
}

.manual-edit-btn:hover {
    background: #5a6268;
}

        
</style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-container">
            <a href="#" class="logo">
                <div class="logo-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <span>Sesli Sipari≈ü</span>
            </a>
            
            <div class="header-actions">
                <div class="language-selector">
                    <button class="language-btn" id="languageBtn">
                        <i class="fas fa-globe"></i>
                        <span id="currentLanguage">TR</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="language-dropdown" id="languageDropdown"></div>
                </div>
                
                <div class="location-marker action-btn" id="locationMarker">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="locationText">Konum Se√ßin</span>
                </div>
                
                <div class="order-summary" id="orderSummary">
                    <div class="order-count" id="orderCount">0</div>
                    <div>Sipari≈ü: <span id="orderTotal">0 ‚Ç∫</span></div>
                </div>
               
                <button id="microphoneToggle" class="action-btn">
                    <i class="fas fa-microphone-slash"></i>
                    <span>Mikrofon (Kapalƒ±)</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Banner -->
    <div class="banner" id="banner">
        <video class="banner-video" id="bannerVideo" loop muted autoplay></video>
        <div class="banner-content">
            <h1 id="bannerTitle">Sesli Sipari≈ü ile Kolay Alƒ±≈üveri≈ü</h1>
            <p id="bannerDescription">Sadece konu≈üun, sipari≈üiniz kapƒ±nƒ±zda!</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Store Type Selection -->
        <section>
            <h2 class="section-title">Ne yemek istersiniz?</h2>
            <div class="scroll-container">
                <button class="scroll-btn left" id="scrollStoreTypesLeft">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="scroll-content" id="sellerTypeGrid"></div>
                <button class="scroll-btn right" id="scrollStoreTypesRight">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>

        <!-- Sellers Grid -->
        <section id="sellersSection" style="display: none;">
            <h2 class="section-title">
                <i class="fas fa-store"></i>
                Size En Yakƒ±n Yerler
            </h2>
            <div class="scroll-container">
                <button class="scroll-btn left" id="scrollSellersLeft">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="scroll-content" id="sellerGrid"></div>
                <button class="scroll-btn right" id="scrollSellersRight">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>

        <!-- Categories Grid -->
        <section id="categoriesSection" style="display: none;">
            <h2 class="section-title">
                <i class="fas fa-layer-group"></i>
                Kategoriler
            </h2>
            <div class="scroll-container">
                <button class="scroll-btn left" id="scrollCategoriesLeft">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="scroll-content" id="categoriesGrid"></div>
                <button class="scroll-btn right" id="scrollCategoriesRight">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>

        <!-- Products Grid -->
        <section class="products-section" id="productsSection" style="display: none;">
            <div class="products-header">
                <h2 class="section-title" style="margin-bottom: 0;">
                    <i class="fas fa-box-open"></i>
                    √úr√ºnler
                </h2>
                <div id="selectedSellerInfo">Satƒ±cƒ± se√ßilmedi</div>
            </div>
            <div class="scroll-container">
                <button class="scroll-btn left" id="scrollProductsLeft">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="scroll-content" id="productsGrid"></div>
                <button class="scroll-btn right" id="scrollProductsRight">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>
    </div>

    <!-- Location Modal -->
    <div id="locationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Konum Se√ßiniz</h3>
                <span class="close-modal" id="closeLocationModal">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Dinamik i√ßerik JavaScript ile doldurulacak -->
            </div>
        </div>
    </div>

    <!-- Cart Section -->
    <div class="cart-container" id="cartContainer">
        <div class="cart-header">
            <h2>Sepetiniz</h2>
            <button class="cart-close" id="cartClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="cart-items" id="cartItems">
            <div class="text-center" style="padding: 30px; color: var(--gray);">
                <i class="fas fa-shopping-cart fa-2x mb-3"></i>
                <p>Sepetiniz bo≈ü</p>
            </div>
        </div>
        <div class="cart-totals">
            <div class="total-row">
                <span>Ara Toplam:</span>
                <span id="subtotal">0 ‚Ç∫</span>
            </div>
            <div class="total-row">
                <span>ƒ∞ndirim:</span>
                <span id="discount">0 ‚Ç∫</span>
            </div>
            <div class="total-row">
                <span>KDV (%18):</span>
                <span id="vatAmount">0 ‚Ç∫</span>
            </div>
            <div class="total-row total-final">
                <span>Toplam:</span>
                <span id="totalAmount">0 ‚Ç∫</span>
            </div>
        </div>
        <div class="payment-buttons">
            <button class="payment-btn cash" id="payCash">Nakit √ñde</button>
            <button class="payment-btn card" id="payCard">Kartla √ñde</button>
            <button class="payment-btn bonus" id="payBonus">Bonus ile √ñde</button>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <div class="footer-section">
                <h3 data-translate="app_name">Sesli Sipari≈ü</h3>
                <p data-translate="footer_description">Sesli komutlarla kolayca sipari≈ü verin. Hƒ±zlƒ±, g√ºvenli ve pratik alƒ±≈üveri≈ü deneyimi.</p>
                <div class="social-links">
                    <a href="#" class="social-link"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
                    <a href="https://wa.me/?text=Merhaba!%20Sesli%20Sipari≈ü%20sisteminden%20alƒ±≈üveri≈ü%20yapmak%20istiyorum." class="social-link" target="_blank"><i class="fab fa-whatsapp"></i></a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3 data-translate="quick_links">Hƒ±zlƒ± Baƒülantƒ±lar</h3>
                <ul class="footer-links">
                    <li><a href="#" id="referralLink"><i class="fas fa-link"></i> <span data-translate="referral_link">Referans Linki</span></a></li>
                    <li><a href="#" id="whatsappOrder"><i class="fab fa-whatsapp"></i> <span data-translate="whatsapp_order">WhatsApp ile Sipari≈ü</span></a></li>
                    <li><a href="#"><i class="fas fa-shopping-bag"></i> <span data-translate="my_orders">Sipari≈ülerim</span></a></li>
                    <li><a href="#"><i class="fas fa-question-circle"></i> <span data-translate="help">Yardƒ±m</span></a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3 data-translate="contact">ƒ∞leti≈üim</h3>
                <ul class="footer-links">
                    <li><a href="tel:08501234567"><i class="fas fa-phone"></i> 0850 123 45 67</a></li>
                    <li><a href="mailto:info@seslisiparis.com"><i class="fas fa-envelope"></i> info@seslisiparis.com</a></li>
                    <li><a href="#"><i class="fas fa-map-marker-alt"></i> <span data-translate="location">ƒ∞stanbul, T√ºrkiye</span></a></li>
                </ul>
                <a href="#" class="partner-login" data-translate="partner_login">Partner Giri≈üi</a>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy; 2023 Sesli Sipari≈ü Sistemi. <span data-translate="all_rights_reserved">T√ºm haklarƒ± saklƒ±dƒ±r.</span></p>
        </div>
    </footer>
    <!-- Voice Assistant -->
    <div class="voice-status" id="voiceStatusPanel">
        <div class="status-header">
            <div class="status-title">
                <i class="fas fa-microphone"></i>
                <span>Sesli Asistan</span>
            </div>
            <button class="status-close" id="closeVoiceStatus">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="status-content">
            <div class="assistant-message" id="assistantMessage">Merhaba! Sipari≈ü vermek i√ßin mikrofonu a√ßƒ±n ve konu≈üun.</div>
            <div class="user-message" id="userMessage"></div>
        </div>
        <div class="voice-indicator" id="voiceIndicator">
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
        </div>
    </div>

    <script>
       
        // Supabase configuration
        const SUPABASE_URL = "https://xliutvspwodhoaxvysks.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsaXV0dnNwd29kaG9heHZ5c2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTgyOTksImV4cCI6MjA3MjkzNDI5OX0.Zodisa_ifP8t2Q4X0ecnB56RiR_Bg4QS5gvPn5ZLK_w";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);



// =============================================
// TAMAMEN Dƒ∞NAMƒ∞K SESLƒ∞ Sƒ∞PARƒ∞≈û Sƒ∞STEMƒ∞
// =============================================

// Global state - Dinamik
let currentCustomer = null;
let sellers = [];
let products = [];
let categories = [];
let storeTypes = [];
let cart = [];
let recognition = null;
let isListening = false;
let isMicrophoneEnabled = false;
let conversationStep = 0;
let currentPaymentMethod = null;
let selectedSellerId = null;
let selectedSellerType = null;
let selectedStoreTypeId = null;
let selectedStoreTypeName = null;
let selectedCategoryId = null;
let isSellerLocked = false;
let selectedLocation = null;
let referralCode = null;
let referralGroupCode = null;
let allSellersInLocation = [];
let filteredSellers = [];
let pendingCart = [];
let isGuestMode = false;
let pendingOrder = null;
let currentRoot = "0:0";
let pendingResponse = null;
let commandRules = new Map();
let lastRecognizedProduct = null;
let lastSpokenMessage = "";
let lastSpeakTime = 0;
let isLocationDetected = false;   
let isSpeaking = false;
let customerPhone = null;        
let customerName = null;
let buildingNumber = null;        
let apartmentNumber = null;
let useRegisteredAddress = false;
let sellerWorkingHours = new Map();
let sellerStatusCache = new Map();
let filteredSellersByStoreType = [];  
let referralDiscount = 0;
let pendingReferralCode = null;
let referralBonusBalance = 0;
let isWaitingForPhone = false;
let isWaitingForName = false;
let isWaitingForBuilding = false;
let isWaitingForApartment = false;
let isWaitingForAddressConfirm = false;
let isWaitingForNewBuilding = false;
let isWaitingForNewApartment = false;
let isWaitingForOrderConfirm = false;
let expectedInput = null;
let pendingPhone = null;
let pendingCustomerInfo = null;
let pendingAddressInfo = null;
let orderNotes = null;
let deliveryaddress = null;
let customers_full_Addrees = null;
let currentReferralGroup = null;
      

        
// Konum state
let userLocation = {
    latitude: null,
    longitude: null,
    address: null,
    city: null,
    district: null
};


// DOM Elements
        const profileBtn = document.getElementById('profileBtn');
        const profileDropdown = document.getElementById('profileDropdown');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profilePhone = document.getElementById('profilePhone');
        const profileCity = document.getElementById('profileCity');
        const profileAddress = document.getElementById('profileAddress');
        const profileBonus = document.getElementById('profileBonus');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const microphoneToggle = document.getElementById('microphoneToggle');
        const sellerTypeGrid = document.getElementById('sellerTypeGrid');
        const scrollSellerTypesLeft = document.getElementById('scrollSellerTypesLeft');
        const scrollSellerTypesRight = document.getElementById('scrollSellerTypesRight');
        const categoriesSection = document.getElementById('categoriesSection');
        const categoriesTitle = document.getElementById('categoriesTitle');
        const categoriesGrid = document.getElementById('categoriesGrid');
        const scrollCategoriesLeft = document.getElementById('scrollCategoriesLeft');
        const scrollCategoriesRight = document.getElementById('scrollCategoriesRight');
        const sellersSection = document.getElementById('sellersSection');
        const sellerGrid = document.getElementById('sellerGrid');
        const scrollSellersLeft = document.getElementById('scrollSellersLeft');
        const scrollSellersRight = document.getElementById('scrollSellersRight');
        const productsSection = document.getElementById('productsSection');
        const selectedSellerInfo = document.getElementById('selectedSellerInfo');
        const productsGrid = document.getElementById('productsGrid');
        const cartContainer = document.getElementById('cartContainer');
        const cartClose = document.getElementById('cartClose');
        const cartItems = document.getElementById('cartItems');
        const orderSummary = document.getElementById('orderSummary');
        const orderCount = document.getElementById('orderCount');
        const orderTotal = document.getElementById('orderTotal');
        const subtotalEl = document.getElementById('subtotal');
        const discountEl = document.getElementById('discount');
        const vatAmountEl = document.getElementById('vatAmount');
        const totalAmountEl = document.getElementById('totalAmount');
        const payCashBtn = document.getElementById('payCash');
        const payCardBtn = document.getElementById('payCard');
        const payBonusBtn = document.getElementById('payBonus');
        const assistantMessage = document.getElementById('assistantMessage');
        const userMessage = document.getElementById('userMessage');
        const voiceIndicator = document.getElementById('voiceIndicator');
        const closeVoiceStatus = document.getElementById('closeVoiceStatus');
        const voiceStatusPanel = document.getElementById('voiceStatusPanel');
        const howItWorks = document.getElementById('howItWorks');
        const locationMarker = document.getElementById('locationMarker');
        const locationText = document.getElementById('locationText');
        const locationModal = document.getElementById('locationModal');
        const referralLink = document.getElementById('referralLink');
        const whatsappOrder = document.getElementById('whatsappOrder');
        const SPEAK_COOLDOWN = 3000; // 3 saniye


        // Utility functions
        function money(n) { 
            return Number(n||0).toLocaleString('tr-TR',{minimumFractionDigits:2, maximumFractionDigits:2}) + ' ‚Ç∫'; 
        }

        // Debug modu
        const DEBUG_MODE = true;

        // Debug fonksiyonu
        function debugLog(message, data = null) {
            if (DEBUG_MODE) {
                console.log(`[DEBUG] ${new Date().toLocaleTimeString()}: ${message}`, data || '');
            }
        }

        
// =============================================
// PWA Y√ñNETƒ∞M FONKSƒ∞YONLARI
// =============================================
function initializePWA() {
  // Service Worker kaydƒ±
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(registration => {
          console.log('SW registered: ', registration);
        })
        .catch(registrationError => {
          console.log('SW registration failed: ', registrationError);
        });
    });
  }
  
  // PWA Install Prompt
  let deferredPrompt;
  const installButton = document.createElement('button');
  
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // Install butonunu g√∂ster
    installButton.style.cssText = `
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      font-weight: 600;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
    installButton.innerHTML = '<i class="fas fa-download"></i> Uygulamayƒ± Y√ºkle';
    installButton.addEventListener('click', installPWA);
    
    document.body.appendChild(installButton);
  });
  
  function installPWA() {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('Kullanƒ±cƒ± PWA y√ºklemeyi kabul etti');
          installButton.style.display = 'none';
        }
        deferredPrompt = null;
      });
    }
  }
  
  // Network durumu izleme
  window.addEventListener('online', updateOnlineStatus);
  window.addEventListener('offline', updateOnlineStatus);
  
  function updateOnlineStatus() {
    const status = navigator.onLine ? 'online' : 'offline';
    console.log(`Network durumu: ${status}`);
    
    // Network durumunu kullanƒ±cƒ±ya bildir
    if (status === 'offline') {
      showOfflineNotification();
    } else {
      hideOfflineNotification();
    }
  }
  
  function showOfflineNotification() {
    let offlineBar = document.getElementById('offline-bar');
    if (!offlineBar) {
      offlineBar = document.createElement('div');
      offlineBar.id = 'offline-bar';
      offlineBar.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; background: #dc3545; color: white; text-align: center; padding: 10px; z-index: 10000;">
          <i class="fas fa-wifi"></i> ƒ∞nternet baƒülantƒ±nƒ±z yok. √áevrimdƒ±≈üƒ± modda √ßalƒ±≈üƒ±yorsunuz.
        </div>
      `;
      document.body.appendChild(offlineBar);
    }
  }
  
  function hideOfflineNotification() {
    const offlineBar = document.getElementById('offline-bar');
    if (offlineBar) {
      offlineBar.remove();
    }
  }
}

// SES Sƒ∞STEMƒ∞ ƒ∞Yƒ∞LE≈ûTƒ∞RMELERƒ∞
function initializeEnhancedVoiceSystem() {
  // Cross-browser ses tanƒ±ma desteƒüi
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  
  if (!SpeechRecognition) {
    console.warn('Bu tarayƒ±cƒ± ses tanƒ±mayƒ± desteklemiyor');
    showVoiceNotSupportedMessage();
    return;
  }
  
  // Ses izinleri ve optimizasyonlar
  async function requestMicrophonePermission() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true,
          sampleRate: 16000,
          channelCount: 1
        } 
      });
      
      // Stream'i temizle (sadece izin i√ßin)
      stream.getTracks().forEach(track => track.stop());
      
      return true;
    } catch (error) {
      console.error('Mikrofon izni alƒ±namadƒ±:', error);
      showMicrophonePermissionError();
      return false;
    }
  }
  
  // Ses kalitesi optimizasyonu
  function optimizeVoiceRecognition(recognition) {
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.lang = 'tr-TR';
    
    // Performans iyile≈ütirmeleri
    if ('webkitSpeechRecognition' in window) {
      // WebKit-specific optimizations
      recognition.continuous = true;
    }
    
    return recognition;
  }
  
  // Hata y√∂netimi
  function setupVoiceErrorHandling(recognition) {
    recognition.onerror = function(event) {
      console.error('Ses tanƒ±ma hatasƒ±:', event.error);
      
      switch(event.error) {
        case 'not-allowed':
          showMicrophonePermissionError();
          break;
        case 'audio-capture':
          showMicrophoneNotFoundError();
          break;
        case 'network':
          showNetworkError();
          break;
        default:
          showGenericVoiceError();
      }
    };
  }
  
  // UI geri bildirimleri
  function showVoiceNotSupportedMessage() {
    const message = "Tarayƒ±cƒ±nƒ±z ses tanƒ±mayƒ± desteklemiyor. L√ºtfen Chrome, Edge veya Safari kullanƒ±n.";
    displayMessage(message);
    speakToUser("ses tanƒ±ma desteklenmiyor");
  }
  
  function showMicrophonePermissionError() {
    const message = "Mikrofon eri≈üimine izin vermeniz gerekiyor. L√ºtfen tarayƒ±cƒ± ayarlarƒ±ndan mikrofon iznini etkinle≈ütirin.";
    displayMessage(message);
    speakToUser("mikrofon izni gerekli");
  }
  
  // Ses sentezi optimizasyonu
  function optimizeSpeechSynthesis() {
    if ('speechSynthesis' in window) {
      // Ses sentezi ayarlarƒ±
      const voices = speechSynthesis.getVoices();
      const turkishVoice = voices.find(voice => 
        voice.lang.includes('tr') || voice.lang.includes('TR')
      );
      
      return turkishVoice || voices[0];
    }
    return null;
  }
  
  // Konu≈üma hƒ±zƒ± ve ton ayarlarƒ±
  function createSpeechUtterance(text) {
    const utterance = new SpeechSynthesisUtterance(text);
    const voice = optimizeSpeechSynthesis();
    
    if (voice) {
      utterance.voice = voice;
    }
    
    utterance.rate = 0.9;
    utterance.pitch = 1.0;
    utterance.volume = 0.8;
    utterance.lang = 'tr-TR';
    
    return utterance;
  }
  
  // ƒ∞lk ba≈ülatma
  requestMicrophonePermission();
}

// OFFLINE VERƒ∞ Y√ñNETƒ∞Mƒ∞
function setupOfflineDataManagement() {
  // Sepet verisini localStorage'da sakla
  function saveCartToStorage() {
    try {
      localStorage.setItem('voiceOrderCart', JSON.stringify(cart));
      localStorage.setItem('voiceOrderSeller', selectedSellerId);
      localStorage.setItem('voiceOrderStoreType', selectedStoreTypeId);
    } catch (error) {
      console.error('Sepet kaydetme hatasƒ±:', error);
    }
  }
  
  // Sepet verisini geri y√ºkle
  function loadCartFromStorage() {
    try {
      const savedCart = localStorage.getItem('voiceOrderCart');
      const savedSeller = localStorage.getItem('voiceOrderSeller');
      const savedStoreType = localStorage.getItem('voiceOrderStoreType');
      
      if (savedCart) {
        cart = JSON.parse(savedCart);
        selectedSellerId = savedSeller;
        selectedStoreTypeId = savedStoreType;
        updateCartUI();
      }
    } catch (error) {
      console.error('Sepet y√ºkleme hatasƒ±:', error);
    }
  }
  
  // Periyodik kaydetme
  setInterval(saveCartToStorage, 30000);
  
  // Sayfa y√ºklendiƒüinde geri y√ºkle
  window.addEventListener('load', loadCartFromStorage);
}

// PERFORMANS ƒ∞Yƒ∞LE≈ûTƒ∞RMELERƒ∞
function setupPerformanceOptimizations() {
  // Lazy loading i√ßin Intersection Observer
  const lazyLoadObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.src = img.dataset.src;
        img.classList.remove('lazy');
        lazyLoadObserver.unobserve(img);
      }
    });
  });
  
  // G√∂rseller i√ßin lazy loading
  document.querySelectorAll('img[data-src]').forEach(img => {
    lazyLoadObserver.observe(img);
  });
  
  // Bellek y√∂netimi
  window.addEventListener('beforeunload', () => {
    if (recognition) {
      recognition.stop();
    }
    if (window.speechSynthesis) {
      window.speechSynthesis.cancel();
    }
  });
}

// UYGULAMA BA≈ûLATMA
document.addEventListener('DOMContentLoaded', function() {
  // PWA √∂zelliklerini ba≈ülat
  initializePWA();
  
  // Ses sistemini ba≈ülat
  initializeEnhancedVoiceSystem();
  
  // Offline veri y√∂netimi
  setupOfflineDataManagement();
  
  // Performans iyile≈ütirmeleri
  setupPerformanceOptimizations();
  
  // Mevcut uygulama ba≈ülatma
  setTimeout(() => {
    initApp().catch(error => {
      console.error('Uygulama ba≈ülatma hatasƒ±:', error);
    });
  }, 1000);
});






        
// =============================================
// UYGULAMA BA≈ûLANGICI
// =============================================

// Uygulama ba≈üladƒ±ƒüƒ±nda otomatik g√ºncellemeyi ba≈ülat
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        startSellerStatusAutoUpdate();
        console.log('‚úÖ Satƒ±cƒ± durumu otomatik g√ºncelleme ba≈ülatƒ±ldƒ±');
    }, 3000);
});


// =============================================
// MAƒûAZA Tƒ∞Pƒ∞ SE√áƒ∞Mƒ∞ ƒ∞√áƒ∞N YARDIMCI FONKSƒ∞YONLAR
// =============================================

// Store type kartlarƒ±nƒ± g√ºncelle
function displayStoreTypes(types) {
    const sellerTypeGrid = document.getElementById('sellerTypeGrid');
    if (!sellerTypeGrid) return;
    
    sellerTypeGrid.innerHTML = '';
    
    // "T√ºm√º" se√ßeneƒüini ekle
    const allTypesCard = document.createElement('div');
    allTypesCard.className = 'seller-type-card';
    allTypesCard.dataset.typeId = 'all';
    allTypesCard.dataset.typeName = 'T√ºm√º';
    allTypesCard.dataset.typeIndex = 0;
    
    allTypesCard.innerHTML = `
        <div class="seller-type-icon">
            <i class="fas fa-th-large"></i>
        </div>
        <div class="seller-type-name">T√ºm√º</div>
        <div class="store-type-number">0</div>
    `;
    
    allTypesCard.addEventListener('click', () => {
        document.querySelectorAll('.seller-type-card').forEach(card => {
            card.classList.remove('selected');
        });
        allTypesCard.classList.add('selected');
        onStoreTypeSelected('all', 'T√ºm Maƒüazalar');
    });
    
    sellerTypeGrid.appendChild(allTypesCard);
    
    if (!types || types.length === 0) {
        sellerTypeGrid.innerHTML += `
            <div class="text-center" style="min-width: 100%; padding: 40px; color: #6c757d;">
                <i class="fas fa-store fa-3x mb-3"></i>
                <p>Maƒüaza tipi bulunamadƒ±</p>
            </div>
        `;
        return;
    }
    
    const iconMap = {
        'Market': 'fas fa-store',
        'Restoran': 'fas fa-utensils',
        'Eczane': 'fas fa-prescription-bottle',
        'Fƒ±rƒ±n': 'fas fa-bread-slice',
        'Kafe': 'fas fa-coffee',
        'Pastane': 'fas fa-birthday-cake',
        'Alkol': 'fas fa-wine-bottle',
        '√ái√ßek': 'fas fa-spa',
        '√áar≈üƒ±': 'fas fa-shopping-basket'
    };
    
    types.forEach((type, index) => {
        const typeCard = document.createElement('div');
        typeCard.className = 'seller-type-card';
        typeCard.dataset.typeId = type.id;
        typeCard.dataset.typeName = type.name;
        typeCard.dataset.typeIndex = index + 1;
        
        typeCard.innerHTML = `
            <div class="seller-type-icon">
                <i class="${iconMap[type.name] || 'fas fa-store'}"></i>
            </div>
            <div class="seller-type-name">${type.name}</div>
            <div class="store-type-number">${index + 1}</div>
        `;
        
        typeCard.addEventListener('click', () => {
            document.querySelectorAll('.seller-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            typeCard.classList.add('selected');
            onStoreTypeSelected(type.id, type.name);
        });
        
        sellerTypeGrid.appendChild(typeCard);
    });
}
 
// =============================================
// G√úNCELLENMƒ∞≈û SELLER KARTLARI
// =============================================

function updateSellersGrid() {
    const sellerGrid = document.getElementById('sellerGrid');
    if (!sellerGrid) return;
    
    sellerGrid.innerHTML = '';
    
    const sellersToShow = sellers;
    
    if (sellersToShow.length === 0) {
        sellerGrid.innerHTML = `
            <div class="text-center" style="min-width: 100%; padding: 40px; color: #6c757d;">
                <i class="fas fa-store fa-3x mb-3"></i>
                <p>Satƒ±cƒ± bulunamadƒ±</p>
            </div>
        `;
        return;
    }
    
    sellersToShow.forEach((seller, index) => {
        const sellerCard = document.createElement('div');
        sellerCard.className = `seller-card ${!seller.working_hours?.is_open ? 'seller-closed' : ''}`;
        sellerCard.dataset.sellerId = seller.id;
        sellerCard.dataset.sellerIndex = index + 1;
        sellerCard.dataset.storeTypeId = seller.store_type_id;
        
        // Kilit durumuna g√∂re stil
        if (isSellerLocked && seller.id !== selectedSellerId) {
            sellerCard.style.opacity = '0.6';
            sellerCard.style.pointerEvents = 'none';
            sellerCard.title = 'Sepet dolu - Ba≈üka satƒ±cƒ± se√ßemezsiniz';
        }
        
        if (selectedSellerId === seller.id) {
            sellerCard.classList.add('selected');
        }
        
        // A√áIK/KAPALI DURUMU
        const isOpen = seller.working_hours?.is_open;
        const isManualClosed = seller.working_hours?.status === false;
        
        let statusBadge = '';
        let statusMessage = '';
        
        if (isManualClosed) {
            statusBadge = `<div class="seller-status-badge manual-closed">üö´ MANUEL KAPALI</div>`;
            statusMessage = 'Bu maƒüaza ge√ßici olarak kapalƒ±dƒ±r';
        } else if (isOpen) {
            statusBadge = `<div class="seller-status-badge open">üü¢ A√áIK</div>`;
            statusMessage = 'Maƒüaza a√ßƒ±k - Hemen sipari≈ü verebilirsiniz';
        } else {
            statusBadge = `<div class="seller-status-badge closed">üî¥ KAPALI</div>`;
            statusMessage = 'Maƒüaza ≈üu anda kapalƒ±';
        }
        
        // √áALI≈ûMA SAATLERƒ∞
        const workingHours = seller.working_hours?.start_time && seller.working_hours?.end_time ?
            `<div class="working-hours">‚è∞ ${formatTimeDisplay(seller.working_hours.start_time)} - ${formatTimeDisplay(seller.working_hours.end_time)}</div>` :
            `<div class="working-hours">‚è∞ 7/24 A√ßƒ±k</div>`;
        
        // Maƒüaza tipi badge'i
        const storeTypeBadge = seller.store_type_name ?
            `<div class="store-type-badge">${seller.store_type_name}</div>` : '';
        
        // Kilit ikonu
        const lockIcon = (isSellerLocked && seller.id !== selectedSellerId) ?
            `<div class="seller-lock-icon">üîí</div>` : '';
        
        // TESLƒ∞MAT Bƒ∞LGƒ∞Sƒ∞
        let deliveryInfo = '';
        if (selectedLocation === 'delivery') {
            if (seller.delivery_available === false) {
                deliveryInfo = `<div class="delivery-fee" style="color: #dc3545;"><i class="fas fa-times-circle"></i> Teslimat Yok</div>`;
            } else if (seller.delivery_fee > 0) {
                deliveryInfo = `<div class="delivery-fee"><i class="fas fa-motorcycle"></i> Teslimat: ${money(seller.delivery_fee)}</div>`;
            } else if (seller.delivery_fee === 0) {
                deliveryInfo = `<div class="delivery-fee free"><i class="fas fa-motorcycle"></i> √úcretsiz Teslimat</div>`;
            }
            
            if (seller.min_order_amount > 0) {
                deliveryInfo += `<div class="min-order">Min. Sipari≈ü: ${money(seller.min_order_amount)}</div>`;
            }
        }
        
        sellerCard.innerHTML = `
    ${statusBadge}
    ${lockIcon}
    <div class="seller-number-badge">
        <div class="seller-number">${index + 1}</div>
        ${storeTypeBadge ? `<span class="store-type-badge">${seller.store_type_name}</span>` : ''}
    </div>
    <img src="${seller.store_image || getDefaultSellerImage(seller)}" 
         alt="${seller.business_name}" 
         class="seller-image"
         onerror="this.src='${getDefaultSellerImage(seller)}'">
    <div class="seller-info">
        <div class="seller-name">${seller.business_name}</div>
        ${workingHours}
        <div class="seller-status-message">${statusMessage}</div>
        <div class="seller-details">
            <span><i class="fas fa-map-marker-alt"></i> ${seller.district || ''}, ${seller.city || '≈ûehir belirtilmemi≈ü'}</span>
            <span><i class="fas fa-star" style="color: gold;"></i> ${seller.rating || '4.5'}</span>
        </div>
        ${deliveryInfo ? `<div class="delivery-info">${deliveryInfo}</div>` : ''}
    </div>
`;

        
        sellerCard.addEventListener('click', () => {
            // Kilit kontrol√º
            if (isSellerLocked && seller.id !== selectedSellerId) {
                const currentSeller = sellers.find(s => s.id === selectedSellerId);
                displayMessage(`‚ùå Sepet dolu. Sadece ${currentSeller?.business_name || 'mevcut satƒ±cƒ±'} ile alƒ±≈üveri≈ü yapabilirsiniz.`);
                speakToUser("Sepet dolu, satƒ±cƒ± deƒüi≈ütiremezsiniz");
                return;
            }
            
            // MANUEL KAPALI kontrol√º
            if (seller.working_hours?.status === false) {
                displayMessage(`‚ùå ${seller.business_name} ge√ßici olarak kapalƒ±dƒ±r.`);
                speakToUser("Bu maƒüaza ge√ßici olarak kapalƒ±");
                return;
            }
            
            // A√áIK/KAPALI kontrol√º
            if (!seller.working_hours?.is_open) {
                const hours = seller.working_hours?.start_time && seller.working_hours?.end_time ?
                    `√áalƒ±≈üma saatleri: ${formatTimeDisplay(seller.working_hours.start_time)} - ${formatTimeDisplay(seller.working_hours.end_time)}` :
                    '7/24 a√ßƒ±k';
                
                displayMessage(`‚ùå ${seller.business_name} ≈üu anda kapalƒ±. ${hours}`);
                speakToUser("Bu maƒüaza ≈üu anda kapalƒ±");
                return;
            }
            
            // Teslimat kontrol√º
            if (selectedLocation === 'delivery' && seller.delivery_available === false) {
                displayMessage(`‚ùå ${seller.business_name} konumunuza teslimat yapmƒ±yor.`);
                speakToUser("Bu satƒ±cƒ± konumunuza teslimat yapmƒ±yor");
                return;
            }
            
            // T√úM KONTROLLER GE√áTƒ∞ - SATICI SE√áƒ∞LEBƒ∞Lƒ∞R
            selectDynamicSeller(seller);
        });
        
        sellerGrid.appendChild(sellerCard);
    });
}
 // Zaman g√∂r√ºnt√ºleme formatƒ±
function formatTimeDisplay(timeString) {
    if (!timeString) return '--:--';
    
    try {
        const [hours, minutes] = timeString.split(':');
        return `${hours}:${minutes}`;
    } catch (error) {
        return timeString;
    }
}       
// =============================================
// TESLƒ∞MAT Bƒ∞LGƒ∞Sƒ∞ EKLEME
// =============================================

async function addDeliveryInfoToSellers(sellersList) {
    console.log('üöö Teslimat bilgileri ekleniyor...');
    
    // Paralel i≈ülem i√ßin Promise.all kullan
    const promises = sellersList.map(async (seller) => {
        try {
            // Teslimat b√∂lgesi kontrol√º
            if (selectedLocation === 'delivery' && userLocation.latitude && userLocation.longitude) {
                const deliveryCheck = await checkDeliveryArea(
                    seller.id, 
                    userLocation.latitude, 
                    userLocation.longitude
                );
                
                if (deliveryCheck.allowed) {
                    seller.delivery_fee = deliveryCheck.deliveryFee;
                    seller.delivery_distance = deliveryCheck.distance;
                    seller.delivery_available = true;
                } else {
                    seller.delivery_available = false;
                }
            } else {
                // Teslimat se√ßilmediyse veya konum yoksa varsayƒ±lan deƒüerler
                seller.delivery_available = seller.delivery_available !== false;
                seller.delivery_fee = seller.delivery_fee || 0;
            }
            
            return seller;
        } catch (error) {
            console.error(`‚ùå ${seller.business_name} teslimat bilgisi hatasƒ±:`, error);
            // Hata durumunda varsayƒ±lan deƒüerler
            seller.delivery_available = true;
            seller.delivery_fee = seller.delivery_fee || 5;
            return seller;
        }
    });
    
    try {
        await Promise.all(promises);
        console.log('‚úÖ Teslimat bilgileri eklendi');
    } catch (error) {
        console.error('‚ùå Teslimat bilgileri ekleme hatasƒ±:', error);
    }
}      


 // =============================================
// SUPABASE SORGULARI ƒ∞√áƒ∞N G√úVENLƒ∞ FONKSƒ∞YON
// =============================================

async function safeSupabaseQuery(queryFunction, fallbackData = []) {
    try {
        const { data, error } = await queryFunction;
        
        if (error) {
            console.error('‚ùå Supabase sorgu hatasƒ±:', error);
            throw error;
        }
        
        return data || fallbackData;
    } catch (error) {
        console.error('‚ùå Sorgu hatasƒ±:', error);
        return fallbackData;
    }
}

// G√ºvenli sƒ±ralama i√ßin yardƒ±mcƒ± fonksiyon
function safeOrder(query, column, direction = 'asc', foreignTable = null) {
    try {
        if (foreignTable) {
            return query.order(column, { 
                foreignTable: foreignTable,
                ascending: direction === 'asc' 
            });
        } else {
            return query.order(column, { ascending: direction === 'asc' });
        }
    } catch (error) {
        console.error('‚ùå Sƒ±ralama hatasƒ±:', error);
        return query;
    }
}     
        // Kategorileri g√∂ster
        function displayCategories(categoriesToShow) {
    const categoriesGrid = document.getElementById('categoriesGrid');
    if (!categoriesGrid) return;
    
    categoriesGrid.innerHTML = '';
    
    if (categoriesToShow.length === 0) {
        categoriesGrid.innerHTML = `
            <div class="text-center" style="min-width: 100%; padding: 40px; color: #6c757d;">
                <i class="fas fa-box-open fa-3x mb-3"></i>
                <p>Kategori bulunamadƒ±</p>
            </div>
        `;
        return;
    }
    
    const iconMap = {
        'Meyve & Sebze': 'fas fa-apple-alt',
        'S√ºt √úr√ºnleri': 'fas fa-cheese',
        'Et & Tavuk': 'fas fa-drumstick-bite',
        'Temel Gƒ±da': 'fas fa-wheat-alt',
        'ƒ∞√ßecekler': 'fas fa-wine-bottle'
    };
    
    categoriesToShow.forEach((category, index) => {
        const categoryCard = document.createElement('div');
        categoryCard.className = 'category-card';
        categoryCard.dataset.categoryId = category.id;
        categoryCard.dataset.categoryName = category.name;
        categoryCard.dataset.categoryIndex = index + 1; // Sƒ±ra numarasƒ± ekle
        
        categoryCard.innerHTML = `
            <div class="category-number">${index + 1}</div>
            <div class="category-icon">
                <i class="${iconMap[category.name] || 'fas fa-box'}"></i>
            </div>
            <div class="category-name">${category.name}</div>
        `;
        
        categoryCard.addEventListener('click', async function() {
            if (!selectedSellerId) {
                speakToUser("√ñnce bir satƒ±cƒ± se√ßmelisiniz.");
                return;
            }
            
            document.querySelectorAll('.category-card').forEach(c => {
                c.classList.remove('selected');
            });
            
            this.classList.add('selected');
            selectedCategoryId = category.id;
            await loadProductsByReyon(category.id);
            
            // Akƒ±llƒ± geri bildirim
            const categoryNumber = this.dataset.categoryIndex;
            speakToUser(`${categoryNumber}. ${category.name} reyonu se√ßildi.`);
        });
        
        categoriesGrid.appendChild(categoryCard);
    });
}

// =============================================
// VERƒ∞TABANI ODAKLI AKILLI Fƒ∞LTRELEME
// =============================================

async function findProductByNameForFilter(searchTerm) {
    if (!products || products.length === 0) return false;
    
    const cleanSearch = searchTerm.toLowerCase().trim();
    
    try {
        // ‚≠ê VERƒ∞TABANINDA AKILLI ARAMA
        const { data: categoryResults, error: categoryError } = await supabase
            .from('categories')
            .select('id, name')
            .ilike('name', `%${cleanSearch}%`);
        
        const { data: reyonResults, error: reyonError } = await supabase
            .from('reyon')
            .select('id, name') 
            .ilike('name', `%${cleanSearch}%`);
        
        // Mevcut products array'inde arama
        const productMatches = products.filter(product => 
            product.name.toLowerCase().includes(cleanSearch) ||
            (product.category_name && product.category_name.toLowerCase().includes(cleanSearch)) ||
            (product.reyon_name && product.reyon_name.toLowerCase().includes(cleanSearch))
        );
        
        // E≈üle≈üme varsa true d√∂nd√ºr
        const hasMatches = productMatches.length > 0 || 
                          (categoryResults && categoryResults.length > 0) ||
                          (reyonResults && reyonResults.length > 0);
        
        console.log(`üîç Veritabanƒ± arama: "${cleanSearch}" -> ${hasMatches ? 'E≈ûLE≈ûME' : 'E≈ûLE≈ûME YOK'}`);
        return hasMatches;
        
    } catch (error) {
        console.error('‚ùå Veritabanƒ± arama hatasƒ±:', error);
        
        // Fallback: Local array'de arama
        return products.some(product => 
            product.name.toLowerCase().includes(cleanSearch)
        );
    }
}

// =============================================
// GELƒ∞≈ûMƒ∞≈û Fƒ∞LTRELEME Sƒ∞STEMƒ∞
// =============================================

async function smartFilterProducts(searchTerm) {
    const cleanSearch = searchTerm.toLowerCase().trim();
    
    try {
        // ‚≠ê VERƒ∞TABANINDA KAPSAMLI ARAMA
        const { data: filteredProducts, error } = await supabase
            .from('products')
            .select(`
                *,
                categories (name),
                reyon (name),
                store_type (name)
            `)
            .or(`name.ilike.%${cleanSearch}%,description.ilike.%${cleanSearch}%,categories.name.ilike.%${cleanSearch}%,reyon.name.ilike.%${cleanSearch}%`)
            .eq('is_active', true);
        
        if (error) throw error;
        
        console.log(`üéØ Veritabanƒ± filtreleme: "${cleanSearch}" -> ${filteredProducts?.length || 0} √ºr√ºn`);
        return filteredProducts || [];
        
    } catch (error) {
        console.error('‚ùå Veritabanƒ± filtreleme hatasƒ±:', error);
        
        // ‚≠ê FALLBACK: Local array filtreleme
        return products.filter(product => 
            product.name.toLowerCase().includes(cleanSearch) ||
            (product.description && product.description.toLowerCase().includes(cleanSearch)) ||
            (product.category_name && product.category_name.toLowerCase().includes(cleanSearch)) ||
            (product.reyon_name && product.reyon_name.toLowerCase().includes(cleanSearch)) ||
            (product.brand && product.brand.toLowerCase().includes(cleanSearch))
        );
    }
}


// =============================================
// √úR√úN KARTI OLU≈ûTURMA (AYRI FONKSƒ∞YON)
// =============================================

function createProductCard(product, displayIndex) {
    const productCard = document.createElement('div');
    productCard.className = 'product-card';
    productCard.dataset.productId = product.id;
    productCard.dataset.productIndex = displayIndex;

    let badgeHTML = '';
    let priceHTML = '';
    let categoryInfo = '';

    // Kategori/Reyon bilgisi
    if (product.category_name || product.reyon_name) {
        categoryInfo = `<div class="product-category">${product.category_name || ''} ${product.reyon_name ? `‚Ä¢ ${product.reyon_name}` : ''}</div>`;
    }

    if (product.discount_price && product.discount_price < product.price) {
        badgeHTML = `<div class="product-badge">ƒ∞ndirim</div>`;
        priceHTML = `
            <span class="product-price">${money(product.discount_price)}</span>
            <span class="product-discount">${money(product.price)}</span>
        `;
    } else {
        priceHTML = `<span class="product-price">${money(product.price)}</span>`;
    }

    productCard.innerHTML = `
        ${badgeHTML}
        <div class="product-number">${displayIndex}</div>
        <div class="voice-command-hint">
            <i class="fas fa-microphone"></i>
            <span>"${displayIndex} numara"</span>
        </div>
        <img src="${product.imgurl || 'https://via.placeholder.com/150x100?text=√úr√ºn'}"
             alt="${product.name}" 
             class="product-image">
        <div class="product-info">
            <div class="product-name">${product.name}</div>
            ${categoryInfo}
            <div class="product-price">${priceHTML}</div>
            <button class="add-to-cart-btn" data-id="${product.id}">Sepete Ekle</button>
        </div>
    `;

    const addToCartBtn = productCard.querySelector('.add-to-cart-btn');
    addToCartBtn.addEventListener('click', function() {
        addToCart(product, 1, productCard);
    });

    return productCard;
}
        
// √úR√úN G√ñSTERƒ∞M FONKSƒ∞YONUNU G√úNCELLE (searchTerm parametresi eklendi)
function displayProducts(productsToShow, searchTerm = null) {
  const productsGrid = document.getElementById('productsGrid');
  if (!productsGrid) return;

  productsGrid.innerHTML = '';

  // Arama bilgisi i√ßin ba≈ülƒ±k
  let searchInfo = '';
  if (searchTerm && searchTerm.trim() !== '') {
    searchInfo = `<div style="text-align: center; margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 8px;">
                    <i class="fas fa-search"></i> 
                    <strong>"${searchTerm}"</strong> i√ßin ${productsToShow.length} √ºr√ºn bulundu
                    <button onclick="displayProducts(products, '')" 
                            style="margin-left: 10px; padding: 4px 8px; background: var(--primary); color: white; border: none; border-radius: 4px; font-size: 12px;">
                      T√ºm √úr√ºnler
                    </button>
                  </div>`;
  }

  if (productsToShow.length === 0) {
    productsGrid.innerHTML = `
      ${searchInfo}
      <div class="text-center" style="min-width: 100%; padding: 40px; color: #6c757d;">
        <i class="fas fa-box-open fa-3x mb-3"></i>
        <p>${searchTerm ? `"${searchTerm}" i√ßin √ºr√ºn bulunamadƒ±` : 'Bu kategoride √ºr√ºn bulunamadƒ±'}</p>
        ${searchTerm ? `
          <button class="add-to-cart-btn" onclick="displayProducts(products, '')" 
                  style="margin-top: 10px;">T√ºm √úr√ºnleri G√∂ster</button>
        ` : ''}
      </div>
    `;
    return;
  }

  // Arama bilgisini ekle
  if (searchInfo) {
    productsGrid.innerHTML = searchInfo;
  }

  productsToShow.forEach((product, index) => {
    const productCard = document.createElement('div');
    productCard.className = 'product-card';
    productCard.dataset.productId = product.id;
    productCard.dataset.productIndex = index + 1;

    let badgeHTML = '';
    let priceHTML = '';

    if (product.discount_price && product.discount_price < product.price) {
      badgeHTML = `<div class="product-badge">ƒ∞ndirim</div>`;
      priceHTML = `
        <span class="product-price">${money(product.discount_price)}</span>
        <span class="product-discount">${money(product.price)}</span>
      `;
    } else {
      priceHTML = `<span class="product-price">${money(product.price)}</span>`;
    }

    productCard.innerHTML = `
      ${badgeHTML}
      <div class="product-number">${index + 1}</div>
      <div class="voice-command-hint">
        <i class="fas fa-microphone"></i>
        <span>"${index + 1} numara 5 kilo"</span>
      </div>
      <img src="${product.imgurl || 'https://via.placeholder.com/150x100?text=√úr√ºn'}"
           alt="${product.name}" 
           class="product-image">
      <div class="product-info">
        <div class="product-name">${product.name}</div>
        <div class="product-price">${priceHTML}</div>
        <button class="add-to-cart-btn" data-id="${product.id}">Sepete Ekle</button>
      </div>
    `;

    const addToCartBtn = productCard.querySelector('.add-to-cart-btn');
    addToCartBtn.addEventListener('click', function() {
      addToCart(product, 1, productCard);
    });

    productsGrid.appendChild(productCard);
  });

  updateProductCartCounts();

  const slider = document.querySelector('.command-slider-header');
  if (slider) slider.style.display = 'block';
}

// SEPETTEKƒ∞ √úR√úN SAYILARINI G√úNCELLE
function updateProductCartCounts() {
    const productCards = document.querySelectorAll('.product-card');
    
    productCards.forEach(card => {
        const productId = card.dataset.productId;
        const existingCount = card.querySelector('.product-cart-count');
        
        // Eski sayacƒ± temizle
        if (existingCount) {
            existingCount.remove();
        }
        
        // Sepette bu √ºr√ºnden var mƒ± kontrol et
        const cartItem = cart.find(item => item.id === productId);
        if (cartItem && cartItem.quantity > 0) {
            const countBadge = document.createElement('div');
            countBadge.className = 'product-cart-count';
            countBadge.textContent = cartItem.quantity;
            card.appendChild(countBadge);
        }
    });
}

        function showProductsSection() {
    const productsSection = document.getElementById('productsSection');
    if (productsSection) {
        productsSection.style.display = 'block';
        
        // Slider'ƒ± g√∂ster
        const slider = document.querySelector('.command-slider-header');
        if (slider) {
            slider.style.display = 'block';
        }
    }
}
        
// D√úZELTƒ∞LMƒ∞≈û SLAYT FONKSƒ∞YONU - PRODUCTS SECTION'DAN BAƒûIMSIZ
function initCommandSlider() {
    console.log('üîÑ Slider ba≈ülatƒ±lƒ±yor...');
    
    // Eƒüer slider zaten varsa √ßƒ±k
    if (document.querySelector('.command-slider-header')) return;
    
    const examples = [
        { text: "1 numara 5 kilo", icon: "fas fa-weight" },
        { text: "1 numara 2,5 kilo", icon: "fas fa-balance-scale" },
        { text: "1 numara 500 gram", icon: "fas fa-weight-hanging" },
        { text: "1 numara Yarƒ±m kilo", icon: "fas fa-adjust" },
        { text: "1 numara 5 adet", icon: "fas fa-cube" },
        { text: "1 numara 5 paket", icon: "fas fa-box" },
        { text: "1 numara 3 litre", icon: "fas fa-wine-bottle" },
        { text: "1 numara 1 porsiyon", icon: "fas fa-utensils" },
        { text: "1 numara 1,5 porsiyon", icon: "fas fa-utensil-spoon" }
    ];
    
    // Products section'ƒ± bul
    const productsSection = document.getElementById('productsSection');
    if (!productsSection) return;

    // Products header'ƒ± bul
    const productsHeader = productsSection.querySelector('.products-header');
    if (!productsHeader) return;
    
    // √ñrnekleri 3'l√º gruplara ayƒ±r
    const exampleGroups = [];
    for (let i = 0; i < examples.length; i += 3) {
        exampleGroups.push(examples.slice(i, i + 3));
    }

    // ‚≠ê SADECE SLIDER'I EKLE (Bƒ∞LDƒ∞Rƒ∞MSƒ∞Z)
    const sliderContainer = document.createElement('div');
    sliderContainer.className = 'command-slider-header';
    sliderContainer.id = 'commandSlider';
    
    sliderContainer.innerHTML = `
        <div class="slider-content">
            <i class="fas fa-microphone-alt slider-icon"></i>
            <span class="slider-title">Sesli Komut √ñrnekleri:</span>
            <div class="slider-examples-container">
                ${exampleGroups.map((group, groupIndex) => `
                    <div class="slider-example-group ${groupIndex === 0 ? 'active' : ''}" data-group="${groupIndex}">
                        ${group.map((example, exampleIndex) => `
                            <div class="slider-example ${exampleIndex === 0 ? 'active-example' : ''}" 
                                 data-group="${groupIndex}" 
                                 data-example="${exampleIndex}">
                                <i class="${example.icon}"></i>
                                <span>${example.text}</span>
                            </div>
                        `).join('')}
                    </div>
                `).join('')}
            </div>
            <div class="slider-controls">
                <button class="slider-btn prev-btn" title="√ñnceki">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="slider-btn next-btn" title="Sonraki">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    `;

    // ‚≠ê Bƒ∞LDƒ∞Rƒ∞Mƒ∞ AYRI Bƒ∞R ELEMENT OLARAK EKLE
    const notificationContainer = document.createElement('div');
    notificationContainer.className = 'voice-notification-container';
    notificationContainer.id = 'voiceCommandNotification';
    notificationContainer.innerHTML = `
        <div class="voice-notification-content">
            <i class="fas fa-microphone"></i>
            <span class="voice-notification-text">"Sepeti bo≈üalt" veya "Sipari≈ü ver" diyebilirsiniz</span>
        </div>
    `;

    // ‚≠ê √ñNCE SLIDER'I EKLE, SONRA Bƒ∞LDƒ∞Rƒ∞Mƒ∞
    productsHeader.appendChild(sliderContainer);
    productsHeader.appendChild(notificationContainer); // ‚≠ê BURASI √ñNEMLƒ∞
    
    console.log('‚úÖ Slider ve bildirim ayrƒ± elementler olarak eklendi');
    
    // Slider fonksiyonlarƒ±nƒ± ba≈ülat
    initSliderControls();
    
    // Slider state
    let currentGroupIndex = 0;
    let autoSlideInterval;

    // Grup deƒüi≈ütirme fonksiyonu
    function showGroup(groupIndex) {
        const groups = sliderContainer.querySelectorAll('.slider-example-group');
        const examples = sliderContainer.querySelectorAll('.slider-example');
        
        // T√ºm gruplarƒ± ve √∂rnekleri gizle
        groups.forEach(group => group.classList.remove('active'));
        examples.forEach(example => example.classList.remove('active-example'));
        
        // Yeni grubu g√∂ster
        if (groups[groupIndex]) {
            groups[groupIndex].classList.add('active');
            
            // Grubun ilk √∂rneƒüini aktif et
            const groupExamples = sliderContainer.querySelectorAll(`.slider-example[data-group="${groupIndex}"]`);
            if (groupExamples[0]) {
                groupExamples[0].classList.add('active-example');
            }
        }
        
        currentGroupIndex = groupIndex;
    }

    // Otomatik slayt fonksiyonu
    function startAutoSlide() {
        autoSlideInterval = setInterval(() => {
            const nextGroupIndex = (currentGroupIndex + 1) % exampleGroups.length;
            showGroup(nextGroupIndex);
        }, 4000); // 4 saniyede bir deƒüi≈üim
    }

    // Manuel kontrol fonksiyonlarƒ±
    function nextGroup() {
        const nextIndex = (currentGroupIndex + 1) % exampleGroups.length;
        showGroup(nextIndex);
        resetAutoSlide();
    }

    function prevGroup() {
        const prevIndex = (currentGroupIndex - 1 + exampleGroups.length) % exampleGroups.length;
        showGroup(prevIndex);
        resetAutoSlide();
    }

    function resetAutoSlide() {
        clearInterval(autoSlideInterval);
        startAutoSlide();
    }

    // Event listener'larƒ± ekle
    const nextBtn = sliderContainer.querySelector('.next-btn');
    const prevBtn = sliderContainer.querySelector('.prev-btn');
    
    if (nextBtn) nextBtn.addEventListener('click', nextGroup);
    if (prevBtn) prevBtn.addEventListener('click', prevGroup);

    // ƒ∞lk grubu g√∂ster ve otomatik slaytƒ± ba≈ülat
    showGroup(0);
    startAutoSlide();

    console.log('‚úÖ 3\'l√º grup komut slider ba≈ülatƒ±ldƒ±');
}

// Slider kontrollerini ba≈ülatan fonksiyon
function initSliderControls() {
    console.log('üéõÔ∏è Slider kontrolleri ba≈ülatƒ±lƒ±yor...');
    // Bu fonksiyon artƒ±k ana fonksiyonun i√ßinde, burada bo≈ü bƒ±rakabiliriz
    // veya gerekiyorsa ek kontroller ekleyebiliriz
}

// HEMEN √áALI≈ûTIR - DOM y√ºklenir y√ºklenmez
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM y√ºklendi, slider ba≈ülatƒ±lƒ±yor...');
    initCommandSlider();
});

// Sayfa tamamen y√ºklendiƒüinde de kontrol et
window.addEventListener('load', function() {
    console.log('üìÑ Sayfa tamamen y√ºklendi');
    // Slider'ƒ±n g√∂r√ºn√ºr olup olmadƒ±ƒüƒ±nƒ± kontrol et
    const slider = document.getElementById('commandSlider');
    if (!slider || slider.style.display === 'none') {
        console.log('‚ö†Ô∏è Slider g√∂r√ºnm√ºyor, yeniden ba≈ülatƒ±lƒ±yor...');
        initCommandSlider();
    }
});



    
        
        // =============================================
        // SEPET Y√ñNETƒ∞M FONKSƒ∞YONLARI
        // =============================================

// üõí √úr√ºn ekleme
async function addToCart(product, quantity, productCard = null) {
  console.log('üõí addToCart √ßaƒürƒ±ldƒ±:', product.name, quantity);

  // üîπ 1. Satƒ±cƒ± kilit kontrol√º
  if (isSellerLocked && cart.length > 0) {
    const firstCartItem = cart[0];
    if (firstCartItem && firstCartItem.seller_id !== selectedSellerId) {
      const currentSeller = sellers.find(s => s.id === firstCartItem.seller_id);
      speakToUser(`Sepet dolu. Sadece ${currentSeller?.business_name || 'mevcut satƒ±cƒ±'} ile alƒ±≈üveri≈ü yapabilirsiniz.`);
      return;
    }
  }

  const wasCartEmpty = cart.length === 0;
  const existingItem = cart.find(item => item.id === product.id);

  // üîπ 2. Fiyat & vergi oranƒ±
  let unitPrice = product.discount_price || product.price || null;
  let taxRate = product.tax_rate ? Number(product.tax_rate) : null;
  let productPriceId = product.product_price_id || null;

  // Eksikse veritabanƒ±ndan √ßek
  if (!unitPrice || taxRate === null) {
    console.log('üí° √úr√ºn fiyatƒ± Supabase √ºzerinden alƒ±nƒ±yor...');
    const { data: priceData, error } = await supabase
      .from('product_prices')
      .select(`
        id,
        price,
        discount_price,
        seller_id,
        product_id,
        products ( id, name, tax_rate )
      `)
      .eq('product_id', product.id)
      .eq('seller_id', selectedSellerId)
      .limit(1)
      .single();

    if (error || !priceData) {
      console.error('‚ùå Fiyat alƒ±namadƒ±:', error);
      speakToUser('√úr√ºn fiyat bilgisi alƒ±namadƒ±.');
      return;
    }

    productPriceId = priceData.id;
    unitPrice = parseFloat(priceData.discount_price || priceData.price);
    taxRate = parseFloat(priceData.products.tax_rate || 0);
  }

  // üîπ 3. Vergi dahil hesaplama
  const taxDecimal = taxRate / 100;
  const itemTotal = unitPrice * quantity; // KDV dahil fiyat
  const itemSubtotal = itemTotal / (1 + taxDecimal);
  const itemTax = itemTotal - itemSubtotal;

  if (existingItem) {
    existingItem.quantity += quantity;
  } else {
    cart.push({
      id: product.id,
      name: product.name,
      price: unitPrice,
      quantity,
      unit_type: product.unit_type || 'adet',
      image: product.imgurl,
      product_price_id: productPriceId,
      seller_id: selectedSellerId,
      category_id: selectedCategoryId,
      tax_rate: taxRate,
      subtotal: itemSubtotal,
      tax_amount: itemTax,
      total: itemTotal
    });
  }

  updateCartUI();

  if (wasCartEmpty && cart.length > 0) lockStoreAndSeller();

  if (productCard) {
    productCard.style.transform = 'scale(1.05)';
    setTimeout(() => (productCard.style.transform = 'scale(1)'), 300);
  }
}

// Bu fonksiyonu en √ºste ekleyin:
function setupEmergencyFallbacks() {
    console.log('üîß Acil durum fallbackleri aktif');
    // Basit fallback - hi√ßbir ≈üey yapma
}
        
// üîí Maƒüaza ve satƒ±cƒ± kilitleme
function lockStoreAndSeller() {
  isSellerLocked = true;
  localStorage.setItem('isSellerLocked', 'true');
  updateLockUI();

  const currentSeller = sellers.find(s => s.id === selectedSellerId);
  speakToUser(`ƒ∞lk √ºr√ºn sepete eklendi. Artƒ±k sadece ${currentSeller?.business_name || 'bu maƒüaza'} ile alƒ±≈üveri≈ü yapabilirsiniz.`);
}

// üîì Kilidi kaldƒ±rma
function unlockStoreAndSeller() {
  isSellerLocked = false;
  localStorage.setItem('isSellerLocked', 'false');
  updateLockUI();
}

// üîê Kilit UI
function updateLockUI() {
  document.querySelectorAll('.seller-type-card, .seller-card').forEach(card => {
    card.style.opacity = isSellerLocked ? '0.5' : '1';
    card.style.pointerEvents = isSellerLocked ? 'none' : 'auto';
  });

  const indicator = document.getElementById('lockIndicator');
  if (isSellerLocked) {
    if (!indicator) {
      const el = document.createElement('div');
      el.id = 'lockIndicator';
      el.innerHTML = `<div style="position: fixed; top: 72px; right: 20px; background: var(--success); color: white; padding: 10px; border-radius: 8px; z-index: 1000; box-shadow: var(--shadow);">
        <i class="fas fa-lock"></i> Sepet Aktif - Maƒüaza Kilitli
      </div>`;
      document.body.appendChild(el);
    }
  } else if (indicator) indicator.remove();
}

// üßÆ KDV dahil / hari√ß hesaplama
function updateCartTotals() {
  let subtotal = 0, totalTax = 0, total = 0;
  cart.forEach(item => {
    const taxDecimal = (item.tax_rate || 0) / 100;
    const itemTotal = (item.price || 0) * (item.quantity || 0);
    const itemSubtotal = itemTotal / (1 + taxDecimal);
    const itemTax = itemTotal - itemSubtotal;

    item.subtotal = itemSubtotal;
    item.tax_amount = itemTax;
    item.total = itemTotal;

    subtotal += itemSubtotal;
    totalTax += itemTax;
    total += itemTotal;
  });

  if (subtotalEl) subtotalEl.textContent = money(subtotal);
  if (vatAmountEl) vatAmountEl.textContent = money(totalTax);
  if (totalAmountEl) totalAmountEl.textContent = money(total);
}

// üîπ Genel toplam (KDV dahil)
function calculateTotal() {
  return cart.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 0)), 0);
}

// üß© Sepet √ºr√ºn satƒ±rlarƒ±
function updateCartItems() {
  const cartContainer = document.getElementById('cartItems');
  if (!cartContainer) return;

  if (cart.length === 0) {
    cartContainer.innerHTML = `<div class="empty-cart"><i class="fas fa-shopping-cart fa-2x mb-2"></i><p>Sepetiniz bo≈ü.</p></div>`;
    return;
  }

  cartContainer.innerHTML = cart.map((item, index) => {
    const taxDecimal = (item.tax_rate || 0) / 100;
    const itemTotal = (item.price || 0) * (item.quantity || 0);
    const itemSubtotal = itemTotal / (1 + taxDecimal);
    const itemTax = itemTotal - itemSubtotal;

    return `
      <div class="cart-item">
        <div class="cart-item-info">
          <img src="${item.image || 'https://via.placeholder.com/60'}" class="cart-item-image">
          <div class="cart-item-details">
            <div class="cart-item-name">${item.name}</div>
            <div class="cart-item-price">${money(item.price)} √ó ${item.quantity} = ${money(itemTotal)}</div>
            <div class="cart-item-tax">Matrah: ${money(itemSubtotal)} | KDV: ${money(itemTax)}</div>
          </div>
        </div>
        <div class="cart-item-actions">
          <button class="quantity-btn decrease" data-index="${index}">‚àí</button>
          <span class="cart-item-quantity">${item.quantity}</span>
          <button class="quantity-btn increase" data-index="${index}">+</button>
          <button class="quantity-btn remove" data-index="${index}"><i class="fas fa-trash"></i></button>
        </div>
      </div>`;
  }).join('');

  setupCartItemEvents();
}

// üéØ Sepet √ºr√ºn butonlarƒ±
function setupCartItemEvents() {
  document.querySelectorAll('.quantity-btn.decrease').forEach(btn =>
    btn.onclick = () => { const i = +btn.dataset.index; cart[i].quantity > 1 ? cart[i].quantity-- : cart.splice(i, 1); updateCartUI(); }
  );
  document.querySelectorAll('.quantity-btn.increase').forEach(btn =>
    btn.onclick = () => { cart[+btn.dataset.index].quantity++; updateCartUI(); }
  );
  document.querySelectorAll('.quantity-btn.remove').forEach(btn =>
    btn.onclick = () => { cart.splice(+btn.dataset.index, 1); updateCartUI(); }
  );
}

// üîÅ Ana UI g√ºncelleme
function updateCartUI() {
  const totalItems = cart.reduce((s, i) => s + (i.quantity || 0), 0);
  if (orderCount) orderCount.textContent = totalItems;

  updateCartItems();
  updateCartTotals();

  const total = calculateTotal();
  if (orderTotal) orderTotal.textContent = money(total);

  updateProductCartCounts();

  if (totalItems === 0) unlockStoreAndSeller();
  else if (!isSellerLocked && selectedSellerId) lockStoreAndSeller();

  updateLockUI();
}

        // =============================================
        // YARDIMCI FONKSƒ∞YONLAR
        // =============================================

        // Money fonksiyonunu g√ºncelle (k√ºs√ºratlarƒ± d√ºzg√ºn g√∂stersin)
    function money(n) { 
    const number = Number(n || 0);
    // K√ºs√ºratlƒ± sayƒ±larƒ± d√ºzg√ºn formatla
    if (number % 1 !== 0) {
        return number.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 3}) + ' ‚Ç∫';
    } else {
        return number.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' ‚Ç∫';
    }
}

        function getDefaultSellerImage(seller) {
            return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGVlMmYzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY3Njc2NyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPlNhdMSxY8SxPC90ZXh0Pjwvc3ZnPg==';
        }

        function debugLog(message, data = null) {
            if (true) { // DEBUG_MODE
                console.log(`[DEBUG] ${new Date().toLocaleTimeString()}: ${message}`, data || '');
            }
        }

// =============================================
// SESSƒ∞Z ASƒ∞STAN MESAJLARI
// =============================================
// speakToUser fonksiyonunu g√ºncelle - √ñDEME MESAJLARI ƒ∞√áƒ∞N SESLƒ∞ OLSUN
// ‚úÖ YENƒ∞ DEƒûƒ∞≈ûKENLER EKLEYƒ∞N
let isAssistantSpeaking = false;
let speechQueue = [];
let speechSynthesisSupported = 'speechSynthesis' in window;
const SIMILARITY_THRESHOLD = 0.6;

// ‚úÖ ƒ∞Zƒ∞N VERƒ∞LEN SESLƒ∞ MESAJLAR
const allowedVoiceMessages = [
    "maƒüaza se√ßin", "satƒ±cƒ± se√ßin", "reyon se√ßin", "√ºr√ºn se√ßin",
    "hangi maƒüaza", "hangi satƒ±cƒ±", "hangi reyon", "hangi √ºr√ºn",
    "numara s√∂yleyin", "isim s√∂yleyin",
    "se√ßildi", "eklendi", "bulundu",
    "hata", "bulunamadƒ±", "sepet dolu", "se√ßilmedi",
    "mikrofon a√ßƒ±ldƒ±", "mikrofon kapandƒ±", "ho≈ü geldiniz",
    "telefon numaranƒ±zƒ± s√∂yleyin", "telefon numarasƒ±",
    "adƒ±nƒ±zƒ± ve soyadƒ±nƒ±zƒ± s√∂yleyin", "ad soyad",
    "bina numarasƒ±nƒ± s√∂yleyin", "bina numarasƒ±",
    "daire numarasƒ±nƒ± s√∂yleyin", "daire numarasƒ±",
    "kayƒ±tlƒ± adresinize teslimat", "adres", "teslimat",
    "√∂deme y√∂ntemi se√ßin", "nakit", "kart", "bonus",
    "sipari≈üi onaylƒ±yor musunuz", "onay",
    "kaydƒ±nƒ±z tamamlandƒ±", "ho≈ü geldiniz",
    "ge√ßersiz telefon numarasƒ±", "ge√ßersiz bina numarasƒ±", "ge√ßersiz daire numarasƒ±",
    "sistem hatasƒ±", "kayƒ±t hatasƒ±",
    "evet", "hayƒ±r", "onaylƒ±yorum", "onaylamƒ±yorum", // ‚úÖ √ñNEMLƒ∞: Onay komutlarƒ± eklendi
    "tamam", "devam", "ileri", "geri"
];

// ‚úÖ SESLƒ∞ KONU≈ûMA Sƒ∞STEMƒ∞
function speakToUser(message, priority = false) {
    console.log(`üó£Ô∏è Asistan (SESLƒ∞): ${message}`);
    
    const cleanMessage = message.trim();
    if (!cleanMessage) return;
    
    const now = Date.now();
    
    // 1Ô∏è‚É£ Aynƒ± mesajƒ± tekrarlama kontrol√º
    if (cleanMessage === lastSpokenMessage && !priority) {
        console.log("üõë Aynƒ± sesli mesaj tekrarƒ± engellendi:", cleanMessage);
        return;
    }

    // 2Ô∏è‚É£ Cooldown kontrol√º (priority mesajlar i√ßin deƒüil)
    if (now - lastSpeakTime < SPEAK_COOLDOWN && !priority) {
        console.log("üõë Sƒ±k sesli mesaj engellendi (cooldown):", cleanMessage);
        return;
    }

    // 3Ô∏è‚É£ Ses sentez destek kontrol√º
    if (!speechSynthesisSupported) {
        console.log("üîá Ses sentez desteklenmiyor, mesaj g√∂sterilecek:", cleanMessage);
        return;
    }

    // 4Ô∏è‚É£ ƒ∞Zƒ∞N KONTROL√ú - Sadece allowedVoiceMessages'taki mesajlar sesli s√∂ylensin
    const isAllowed = allowedVoiceMessages.some(allowedMsg =>
        cleanMessage.toLowerCase().includes(allowedMsg.toLowerCase())
    );
    
    if (!isAllowed && !priority) {
        console.log("üîá ƒ∞zin verilmeyen mesaj t√ºr√º (sadece g√∂sterilecek):", cleanMessage);
        return; // ‚ùå SESLƒ∞ S√ñYLEME, sadece ekranda g√∂ster
    }

    // 5Ô∏è‚É£ Asistan zaten konu≈üuyorsa kuyruƒüa ekle
    if (isAssistantSpeaking) {
        console.log("‚è≥ Asistan konu≈üuyor, kuyruƒüa eklendi:", cleanMessage);
        if (priority) {
            speechQueue.unshift(cleanMessage);
        } else {
            speechQueue.push(cleanMessage);
        }
        return;
    }

    // 6Ô∏è‚É£ Konu≈üma izin kontrol√º
    if (!isMicrophoneEnabled) {
        console.log("üîá Mikrofon kapalƒ±, sesli mesaj iptal:", cleanMessage);
        return;
    }

    // 7Ô∏è‚É£ √ñNEMLƒ∞: Dinlemeyi DURDURMA, sadece konu≈üma durumunu g√ºncelle
    isAssistantSpeaking = true;
    
    try {
        console.log("üé§ Asistan konu≈üuyor (dinleme aktif):", cleanMessage);
        
        const speech = new SpeechSynthesisUtterance(cleanMessage);
        speech.lang = 'tr-TR';
        speech.volume = 0.7;
        speech.rate = 0.9;
        speech.pitch = 1.0;

        // Konu≈üma ba≈üladƒ±ƒüƒ±nda
        speech.onstart = function() {
            console.log("‚úÖ Asistan konu≈ümaya ba≈üladƒ±");
            updateSpeakingIndicator(true);
        };

        // Konu≈üma bittiƒüinde
        speech.onend = function() {
            console.log("‚úÖ Asistan konu≈ümasƒ± bitti");
            isAssistantSpeaking = false;
            updateSpeakingIndicator(false);
            
            lastSpokenMessage = cleanMessage;
            lastSpeakTime = Date.now();
            
            // Kuyruktaki bir sonraki mesajƒ± i≈üle
            processNextSpeech();
        };

        // Hata durumunda
        speech.onerror = function(event) {
            console.error("‚ùå Konu≈üma hatasƒ±:", event.error);
            isAssistantSpeaking = false;
            updateSpeakingIndicator(false);
            processNextSpeech();
        };

        // √ñnceki konu≈ümalarƒ± temizle ve ba≈ülat
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(speech);

    } catch (error) {
        console.error("‚ùå Konu≈üma ba≈ülatma hatasƒ±:", error);
        isAssistantSpeaking = false;
        updateSpeakingIndicator(false);
        processNextSpeech();
    }
}

function processNextSpeech() {
    if (speechQueue.length > 0 && !isAssistantSpeaking) {
        const nextMessage = speechQueue.shift();
        console.log("üì£ Kuyruktaki mesaj i≈üleniyor:", nextMessage);
        
        setTimeout(() => {
            speakToUser(nextMessage);
        }, 500);
    }
}

function speakToUserForce(message) {
    console.log("üö® ZORLA KONU≈ûMA:", message);
    
    speechQueue = [];
    lastSpokenMessage = "";
    lastSpeakTime = 0;
    
    speakToUser(message, true);
}

// ‚úÖ Konu≈üma indikat√∂r√º g√ºncelleme
function updateSpeakingIndicator(speaking) {
    // Mevcut indikat√∂r√º bul veya olu≈ütur
    let indicator = document.getElementById('speaking-indicator');
    
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'speaking-indicator';
        indicator.style.cssText = `
            position: fixed;
            top: 33px;
            right: 10px;
            background: #4CAF50;
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        `;
        document.body.appendChild(indicator);
    }
    
    if (speaking) {
        indicator.textContent = 'üó£Ô∏è Asistan Konu≈üuyor...';
        indicator.style.background = '#ffeb3b';
        indicator.style.color = '#333';
    } else {
        indicator.textContent = 'üé§ Dinliyorum...';
        indicator.style.background = '#4CAF50';
        indicator.style.color = 'white';
    }
    
    indicator.style.display = 'block';
}

// ‚úÖ Zorla konu≈üma fonksiyonu (√∂nemli mesajlar i√ßin)
function speakToUserForce(message) {
    console.log("üö® ZORLA KONU≈ûMA:", message);
    
    // Kuyruƒüu temizle ve √∂ncelikli konu≈ü
    speechQueue = [];
    lastSpokenMessage = "";
    lastSpeakTime = 0;
    
    speakToUser(message, true); // priority = true
}
// ‚úÖ YARDIMCI FONKSƒ∞YONLAR
function isSimilarMessage(newMessage, oldMessage) {
    if (!oldMessage) return false;
    
    const newWords = newMessage.toLowerCase().split(' ');
    const oldWords = oldMessage.toLowerCase().split(' ');
    
    const commonWords = newWords.filter(word => 
        oldWords.includes(word) && word.length > 3
    );
    
    const similarity = commonWords.length / Math.max(newWords.length, oldWords.length);
    
    console.log(`üîç Benzerlik kontrol: ${similarity.toFixed(2)} (${commonWords.join(', ')})`);
    
    return similarity > SIMILARITY_THRESHOLD;
}
        
// =============================================
// Mƒ∞KROFON ve SES TANIMA
// =============================================
// ‚úÖ Mƒ∞KROFON Y√ñNETƒ∞Mƒ∞
async function enableDynamicMicrophone() {
    console.log('üé§ Mikrofon a√ßƒ±lmak isteniyor...');
    
    // Konum kontrol√º
    if (!selectedLocation) {
        showDynamicLocationModal();
        displayMessage("L√ºtfen √∂nce bir konum se√ßiniz.");
        speakToUser("konum se√ßin");
        return;
    }
    
    // Zaten a√ßƒ±ksa kapat
    if (isMicrophoneEnabled) {
        disableDynamicMicrophone();
        return;
    }
    
    try {
        console.log('üîê Mikrofon izni isteniyor...');
        
        // Mikrofon stream'ini al
        window.microphoneStream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true,
                sampleRate: 16000
            }
        });
        
        console.log('‚úÖ Mikrofon izni alƒ±ndƒ±');
        
        // Durumu g√ºncelle
        isMicrophoneEnabled = true;
        
        // UI g√ºncelleme
        updateMicrophoneUI(true);
        
        // Ses tanƒ±mayƒ± ba≈ülat
        setTimeout(() => {
            initializeDynamicSpeechRecognition();
        }, 500);
        
        // Ba≈üarƒ± mesajƒ±
        setTimeout(() => {
            displayMessage("Mikrofon a√ßƒ±ldƒ±. Hangi maƒüaza tipinden alƒ±≈üveri≈ü yapmak istersiniz?");
            speakToUser("mikrofon a√ßƒ±ldƒ±");
        }, 1000);
        
    } catch (error) {
        console.error('‚ùå Mikrofon hatasƒ±:', error);
        displayMessage("Mikrofon eri≈üimi saƒülanamadƒ±.");
        speakToUser("mikrofon hatasƒ±");
        disableDynamicMicrophone();
    }
}

function disableDynamicMicrophone() {
    console.log('üîá Mikrofon kapatƒ±lƒ±yor...');
    
    isMicrophoneEnabled = false;
    isListening = false;
    isAssistantSpeaking = false;
    
    // Stream'i temizle
    if (window.microphoneStream) {
        window.microphoneStream.getTracks().forEach(track => track.stop());
        window.microphoneStream = null;
    }
    
    // Recognition'ƒ± temizle
    if (recognition) {
        try {
            recognition.stop();
        } catch (error) {
            console.log('Recognition stop hatasƒ±:', error);
        }
        recognition = null;
    }
    
    // Konu≈ümayƒ± durdur
    if (speechSynthesisSupported) {
        window.speechSynthesis.cancel();
    }
    
    // Kuyruƒüu temizle
    speechQueue = [];
    
    // UI g√ºncelleme
    updateMicrophoneUI(false);
    
    console.log('‚úÖ Mikrofon kapatƒ±ldƒ±');
}

function updateMicrophoneUI(enabled) {
    const microphoneToggle = document.getElementById('microphoneToggle');
    const voiceIndicator = document.getElementById('voiceIndicator');
    const assistantMessage = document.getElementById('assistantMessage');
    
    if (microphoneToggle) {
        if (enabled) {
            microphoneToggle.innerHTML = '<i class="fas fa-microphone"></i> <span>Mikrofon (A√áIK)</span>';
            microphoneToggle.style.color = 'var(--success)';
        } else {
            microphoneToggle.innerHTML = '<i class="fas fa-microphone-slash"></i> <span>Mikrofon (KAPALI)</span>';
            microphoneToggle.style.color = 'var(--danger)';
        }
    }
    
    if (voiceIndicator) {
        if (enabled) {
            voiceIndicator.classList.add('listening');
        } else {
            voiceIndicator.classList.remove('listening');
        }
    }
    
    if (assistantMessage) {
        assistantMessage.textContent = enabled ? 
            "Mikrofon a√ßƒ±ldƒ±. Konu≈üabilirsiniz..." : 
            "Mikrofon kapalƒ±. A√ßmak i√ßin mikrofon butonuna tƒ±klayƒ±n.";
    }
}

// ‚úÖ SESLƒ∞ KONU≈ûMA Sƒ∞STEMƒ∞
function speakToUser(message, priority = false) {
    console.log(`üó£Ô∏è Asistan (SESLƒ∞): ${message}`);
    
    const cleanMessage = message.trim();
    if (!cleanMessage) return;
    
    const now = Date.now();
    
    // 1Ô∏è‚É£ Aynƒ± mesajƒ± tekrarlama kontrol√º
    if (cleanMessage === lastSpokenMessage && !priority) {
        console.log("üõë Aynƒ± sesli mesaj tekrarƒ± engellendi:", cleanMessage);
        return;
    }

    // 2Ô∏è‚É£ Cooldown kontrol√º (priority mesajlar i√ßin deƒüil)
    if (now - lastSpeakTime < SPEAK_COOLDOWN && !priority) {
        console.log("üõë Sƒ±k sesli mesaj engellendi (cooldown):", cleanMessage);
        return;
    }

    // 3Ô∏è‚É£ Ses sentez destek kontrol√º
    if (!speechSynthesisSupported) {
        console.log("üîá Ses sentez desteklenmiyor, mesaj g√∂sterilecek:", cleanMessage);
        return;
    }

    // 4Ô∏è‚É£ Asistan zaten konu≈üuyorsa kuyruƒüa ekle
    if (isAssistantSpeaking) {
        console.log("‚è≥ Asistan konu≈üuyor, kuyruƒüa eklendi:", cleanMessage);
        if (priority) {
            speechQueue.unshift(cleanMessage);
        } else {
            speechQueue.push(cleanMessage);
        }
        return;
    }

    // 5Ô∏è‚É£ Konu≈üma izin kontrol√º
    if (!isMicrophoneEnabled) {
        console.log("üîá Mikrofon kapalƒ±, sesli mesaj iptal:", cleanMessage);
        return;
    }

    // 6Ô∏è‚É£ √ñNEMLƒ∞: Dinlemeyi DURDURMA, sadece konu≈üma durumunu g√ºncelle
    isAssistantSpeaking = true;
    
    try {
        console.log("üé§ Asistan konu≈üuyor (dinleme aktif):", cleanMessage);
        
        const speech = new SpeechSynthesisUtterance(cleanMessage);
        speech.lang = 'tr-TR';
        speech.volume = 0.7;
        speech.rate = 0.9;
        speech.pitch = 1.0;

        // Konu≈üma ba≈üladƒ±ƒüƒ±nda
        speech.onstart = function() {
            console.log("‚úÖ Asistan konu≈ümaya ba≈üladƒ±");
            updateSpeakingIndicator(true);
        };

        // Konu≈üma bittiƒüinde
        speech.onend = function() {
            console.log("‚úÖ Asistan konu≈ümasƒ± bitti");
            isAssistantSpeaking = false;
            updateSpeakingIndicator(false);
            
            lastSpokenMessage = cleanMessage;
            lastSpeakTime = Date.now();
            
            // Kuyruktaki bir sonraki mesajƒ± i≈üle
            processNextSpeech();
        };

        // Hata durumunda
        speech.onerror = function(event) {
            console.error("‚ùå Konu≈üma hatasƒ±:", event.error);
            isAssistantSpeaking = false;
            updateSpeakingIndicator(false);
            processNextSpeech();
        };

        // √ñnceki konu≈ümalarƒ± temizle ve ba≈ülat
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(speech);

    } catch (error) {
        console.error("‚ùå Konu≈üma ba≈ülatma hatasƒ±:", error);
        isAssistantSpeaking = false;
        updateSpeakingIndicator(false);
        processNextSpeech();
    }
}

function processNextSpeech() {
    if (speechQueue.length > 0 && !isAssistantSpeaking) {
        const nextMessage = speechQueue.shift();
        console.log("üì£ Kuyruktaki mesaj i≈üleniyor:", nextMessage);
        
        setTimeout(() => {
            speakToUser(nextMessage);
        }, 500);
    }
}

function speakToUserForce(message) {
    console.log("üö® ZORLA KONU≈ûMA:", message);
    
    speechQueue = [];
    lastSpokenMessage = "";
    lastSpeakTime = 0;
    
    speakToUser(message, true);
}


// ‚úÖ SES TANIMA Sƒ∞STEMƒ∞
function initializeDynamicSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (!SpeechRecognition) {
        console.error('‚ùå Ses tanƒ±ma desteklenmiyor');
        displayMessage("Tarayƒ±cƒ±nƒ±z ses tanƒ±mayƒ± desteklemiyor.");
        setupManualMode();
        return false;
    }
    
    // Eski recognition'ƒ± temizle
    if (recognition) {
        try {
            recognition.stop();
        } catch (e) {}
        recognition = null;
    }
    
    recognition = new SpeechRecognition();
    recognition.continuous = true; // ‚úÖ S√úREKLƒ∞ Dƒ∞NLEME
    recognition.interimResults = true; // ‚úÖ ANLIK SONU√áLAR
    recognition.lang = 'tr-TR';
    recognition.maxAlternatives = 3;
    
    let restartTimeout = null;
    let errorCount = 0;
    const MAX_ERROR_COUNT = 5;
    let lastFinalResult = '';
    
    recognition.onstart = function() {
        console.log('‚úÖ Ses tanƒ±ma ba≈üladƒ±');
        isListening = true;
        errorCount = 0;
        updateRecognitionStatus('listening');
        
        if (restartTimeout) {
            clearTimeout(restartTimeout);
            restartTimeout = null;
        }
    };
    
    recognition.onresult = function(event) {
        // Asistan konu≈üuyorsa i≈üleme
        if (isAssistantSpeaking) {
            console.log('‚è∏Ô∏è Asistan konu≈üuyor, ses i≈üleme pasif');
            return;
        }
        
        let interimTranscript = '';
        let finalTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
                finalTranscript += event.results[i][0].transcript;
            } else {
                interimTranscript += event.results[i][0].transcript;
            }
        }
        
        // Anlƒ±k sonu√ßlarƒ± g√∂ster (debug i√ßin)
        if (interimTranscript !== '') {
            console.log('üé§ Dinleniyor:', interimTranscript);
        }
        
        // Final sonucu i≈üle
        if (finalTranscript !== '' && finalTranscript !== lastFinalResult) {
            console.log('üéØ Tanƒ±nan komut:', finalTranscript);
            lastFinalResult = finalTranscript;
            
            // Sistem kendi sesini filtrele
            const ignoredPhrases = [
                "bina numarasƒ±nƒ± s√∂yleyin", "daire numarasƒ±nƒ± s√∂yleyin",
                "adresinize teslimat", "evet veya hayƒ±r", "kayƒ±sƒ±",
                "teslimat adresi", "ge√ßersiz bina numarasƒ±"
            ];
            
            if (!ignoredPhrases.some(p => finalTranscript.includes(p))) {
                processVoiceCommand(finalTranscript);
            }
            
            // Sessizlik timeout'unu sƒ±fƒ±rla
            clearTimeout(restartTimeout);
            restartTimeout = setTimeout(() => {
                lastFinalResult = '';
            }, 2000);
        }
    };
    
    recognition.onerror = function(event) {
        console.log('‚ö†Ô∏è Ses tanƒ±ma hatasƒ±:', event.error);
        isListening = false;
        errorCount++;
        
        updateRecognitionStatus('error');
        
        // Kritik hatalarda mikrofonu kapat
        const criticalErrors = ['not-allowed', 'service-not-allowed'];
        if (criticalErrors.includes(event.error)) {
            console.error('‚ùå Kritik hata, ses tanƒ±ma durduruluyor:', event.error);
            disableDynamicMicrophone();
            return;
        }
        
        // √áok fazla hata alƒ±ndƒ±ysa bekle
        if (errorCount > MAX_ERROR_COUNT) {
            console.log('üîÑ √áok fazla hata, 5 saniye bekleniyor...');
            setTimeout(() => {
                if (isMicrophoneEnabled) {
                    startRecognition();
                }
            }, 5000);
            return;
        }
        
        // Normal hatalarda kontroll√º yeniden ba≈ülat
        if (isMicrophoneEnabled && !isListening) {
            restartTimeout = setTimeout(() => {
                startRecognition();
            }, 1500);
        }
    };
    
    recognition.onend = function() {
        console.log('üîö Ses tanƒ±ma sonlandƒ±');
        isListening = false;
        updateRecognitionStatus('waiting');
        
        // Sadece aktifse ve asistan konu≈ümuyorsa yeniden ba≈ülat
        if (isMicrophoneEnabled && !isAssistantSpeaking) {
            restartTimeout = setTimeout(() => {
                startRecognition();
            }, 1000);
        }
    };
    
    // Hemen ba≈ülat
    startRecognition();
    return true;
}

function startRecognition() {
    if (!recognition) {
        console.log('üîÑ Recognition objesi yok, yeniden olu≈üturuluyor...');
        if (!initializeDynamicSpeechRecognition()) return;
    }

    if (!isMicrophoneEnabled) {
        console.log('‚è∏Ô∏è Mikrofon kapalƒ±');
        return;
    }

    if (isAssistantSpeaking) {
        console.log('‚è∏Ô∏è Asistan konu≈üuyor, ses tanƒ±ma ertelendi');
        setTimeout(() => {
            if (isMicrophoneEnabled && !isAssistantSpeaking) {
                startRecognition();
            }
        }, 2000);
        return;
    }

    if (isListening) {
        console.log('‚ÑπÔ∏è Zaten dinleniyor');
        return; // Zaten dinliyorsa tekrar ba≈ülatma
    }

    try {
        console.log('üöÄ Ses tanƒ±ma ba≈ülatƒ±lƒ±yor...');
        recognition.start();
        console.log('‚úÖ Ses tanƒ±ma ba≈ülatma komutu g√∂nderildi');
    } catch (error) {
        console.error('‚ùå Ses tanƒ±ma ba≈ülatma hatasƒ±:', error);

        if (error.toString().includes('already started')) {
            console.log('‚ÑπÔ∏è Ses tanƒ±ma zaten ba≈ülamƒ±≈ü, state g√ºncelleniyor');
            isListening = true; // State'i manuel g√ºncelle
            return;
        }
        
        if (error.toString().includes('not running') || error.toString().includes('invalid state')) {
            console.log('üîÑ Recognition objesi bozuk, yeniden olu≈üturuluyor...');
            recognition = null;
            setTimeout(() => {
                if (isMicrophoneEnabled) {
                    initializeDynamicSpeechRecognition();
                }
            }, 1000);
            return;
        }

        setTimeout(() => {
            if (isMicrophoneEnabled && !isListening && !isAssistantSpeaking) {
                console.log('üîÑ Hata sonrasƒ± yeniden deneme...');
                startRecognition();
            }
        }, 3000);
    }
}

function restartRecognition() {
    console.log('üîÑ Ses tanƒ±ma yeniden ba≈ülatƒ±lƒ±yor...');
    
    if (recognition && isListening) {
        try {
            recognition.stop();
        } catch (e) {
            console.log('Stop hatasƒ± (normal):', e);
        }
    }
    
    setTimeout(() => {
        if (isMicrophoneEnabled && !isListening) {
            startRecognition();
        }
    }, 600);
}

// ‚úÖ DURUM G√ñSTERGE FONKSƒ∞YONLARI
function updateRecognitionStatus(status) {
    const statusMessages = {
        'listening': 'üé§ Dinliyorum... Konu≈üun!',
        'processing': '‚è≥ ƒ∞≈üleniyor...',
        'waiting': 'üîç Ses bekleniyor...',
        'error': '‚ùå Ses tanƒ±namadƒ±'
    };
    
    const assistantMessage = document.getElementById('assistantMessage');
    if (assistantMessage) {
        assistantMessage.textContent = statusMessages[status] || 'Mikrofon hazƒ±r';
    }
}

// ‚úÖ YARDIMCI FONKSƒ∞YONLAR
function isSimilarMessage(newMessage, oldMessage) {
    if (!oldMessage) return false;
    
    const newWords = newMessage.toLowerCase().split(' ');
    const oldWords = oldMessage.toLowerCase().split(' ');
    
    const commonWords = newWords.filter(word => 
        oldWords.includes(word) && word.length > 3
    );
    
    const similarity = commonWords.length / Math.max(newWords.length, oldWords.length);
    
    console.log(`üîç Benzerlik kontrol: ${similarity.toFixed(2)} (${commonWords.join(', ')})`);
    
    return similarity > SIMILARITY_THRESHOLD;
}

function setupManualMode() {
    console.log('üîß Manuel mod etkinle≈ütiriliyor...');
    
    document.addEventListener('click', function(e) {
        const target = e.target;
        const card = target.closest('.seller-type-card, .seller-card, .category-card, .product-card');
        
        if (card) {
            const nameElement = card.querySelector('.seller-type-name, .seller-name, .category-name, .product-name');
            if (nameElement) {
                speakToUser(nameElement.textContent + " se√ßildi");
            }
        }
    });
}

function initializeDynamicVoiceAssistant() {
    setTimeout(() => {
        if (!currentCustomer) {
            displayMessage("Merhaba! Sesli sipari≈ü sistemine ho≈ü geldiniz. L√ºtfen konumunuzu se√ßin.");
            speakToUser("ho≈ü geldiniz");
        } else {
            displayMessage(`Ho≈ü geldiniz ${currentCustomer.name}! Ne satƒ±n almak istersiniz?`);
            speakToUser("ho≈ü geldiniz");
        }
    }, 1000);
}




        


// =============================================
// MOD√úLER UYGULAMA BA≈ûLATMA Sƒ∞STEMƒ∞
// =============================================

class AppInitializer {
    constructor() {
        this.initializationSteps = [];
        this.isInitialized = false;
        this.initStartTime = null;
    }

    // Ba≈ülatma adƒ±mlarƒ±nƒ± kaydet
    registerStep(name, stepFunction, dependencies = []) {
        this.initializationSteps.push({
            name,
            function: stepFunction,
            dependencies,
            executed: false,
            success: false
        });
    }

    // Baƒüƒ±mlƒ±lƒ±klarƒ± kontrol et
    checkDependencies(step) {
        return step.dependencies.every(dep => {
            const depStep = this.initializationSteps.find(s => s.name === dep);
            return depStep && depStep.success;
        });
    }

    // Ba≈ülatma adƒ±mlarƒ±nƒ± y√ºr√ºt - D√úZELTƒ∞LDƒ∞: function anahtar kelimesi kaldƒ±rƒ±ldƒ±
    async executeSteps() {
        this.initStartTime = Date.now();
        console.log('üöÄ Uygulama ba≈ülatma ba≈ülƒ±yor...');

        let executedCount = 0;
        let maxAttempts = this.initializationSteps.length * 3; // Daha fazla deneme hakkƒ±

        while (executedCount < this.initializationSteps.length && maxAttempts > 0) {
            let stepExecuted = false;

            for (const step of this.initializationSteps) {
                if (!step.executed && this.checkDependencies(step)) {
                    try {
                        console.log(`‚ö° ${step.name} ba≈ülatƒ±lƒ±yor...`);
                        await step.function();
                        step.executed = true;
                        step.success = true;
                        executedCount++;
                        stepExecuted = true;
                        
                        console.log(`‚úÖ ${step.name} tamamlandƒ±`);
                    } catch (error) {
                        console.error(`‚ùå ${step.name} hatasƒ±:`, error);
                        step.executed = true;
                        step.success = false;
                        executedCount++;
                        
                        // Kritik olmayan hatalarda devam et
                        if (!this.isCriticalStep(step.name)) {
                            console.warn(`‚ö†Ô∏è ${step.name} hatasƒ± atlanƒ±yor...`);
                        } else {
                            console.warn(`‚ö†Ô∏è Kritik hata ama devam ediliyor: ${step.name}`);
                            // Kritik hatalarda bile uygulamayƒ± durdurma, devam et
                        }
                    }
                }
            }

            if (!stepExecuted) {
                maxAttempts--;
                console.log(`‚è≥ Baƒüƒ±mlƒ±lƒ±klar bekleniyor... (${maxAttempts} deneme kaldƒ±)`);
                await this.delay(500); // Daha kƒ±sa bekleme s√ºresi
            }
        }

        if (maxAttempts <= 0) {
            console.warn('‚ö†Ô∏è Ba≈ülatma zaman a≈üƒ±mƒ±, ancak uygulama devam edecek');
            // Zaman a≈üƒ±mƒ±nda bile uygulamayƒ± durdurma
        }

        const initTime = Date.now() - this.initStartTime;
        console.log(`üéâ Uygulama ba≈ülatma tamamlandƒ± (${initTime}ms)`);
        this.isInitialized = true;
    }

    isCriticalStep(stepName) {
        const criticalSteps = [
            'loadCoreData',
            'setupEventHandlers', 
            'initializeVoiceSystem'
        ];
        return criticalSteps.includes(stepName);
    }

    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

// Global initializer instance
const appInitializer = new AppInitializer();

// =============================================
// BA≈ûLATMA ADIMLARINI TANIMLA
// =============================================

function setupInitializationSteps() {
    // 1. Temel veri y√ºkleme
    appInitializer.registerStep('loadCoreData', async () => {
        await loadAllDynamicData();
        await loadReferralRules();
    });

    // 2. DOM hazƒ±rlƒ±ƒüƒ±
    appInitializer.registerStep('waitForDOM', async () => {
        await waitForDOMElements();
    }, ['loadCoreData']);

    // 3. Event handler'larƒ± kur
    appInitializer.registerStep('setupEventHandlers', async () => {
        setupDynamicEventHandlers();
        setupPaymentButtons();
        setupBonusPayment();
    }, ['waitForDOM']);

    // 4. Ses sistemi ba≈ülatma
    appInitializer.registerStep('initializeVoiceSystem', async () => {
        if (window.voiceLearner) {
            await voiceLearner.initialize();
        }
        initializeDynamicVoiceAssistant();
    }, ['setupEventHandlers']);

    // 5. Oturum y√∂netimi
    appInitializer.registerStep('restoreSession', async () => {
        await restoreSession();
    }, ['loadCoreData']);

    // 6. Konum servisleri
    appInitializer.registerStep('initializeLocation', async () => {
        initializeDynamicLocation();
    }, ['restoreSession']);

    // 7. Referral sistemi
    appInitializer.registerStep('initializeReferralSystem', async () => {
        await initializeReferralSystem();
    }, ['restoreSession']);

    // 8. UI g√ºncelleme
    appInitializer.registerStep('updateUI', async () => {
        updateUIAfterDynamicLogin();
        
        // Kilit durumunu kontrol et
        if (cart.length > 0 && selectedSellerId) {
            lockStoreAndSeller();
        }
    }, ['initializeReferralSystem', 'initializeLocation']);

    // 9. Performans optimizasyonlarƒ±
    appInitializer.registerStep('performanceOptimization', async () => {
        setupPerformanceOptimizations();
        initializePWA();
    }, ['updateUI']);

    // 10. Son kontroller
    appInitializer.registerStep('finalChecks', async () => {
        await performFinalChecks();
        debugLog('üéâ === MOD√úLER UYGULAMA BA≈ûLATMA TAMAMLANDI ===');
    }, ['performanceOptimization']);
}

// =============================================
// YENƒ∞ initApp FONKSƒ∞YONU
// =============================================

async function initApp() {
    try {
        console.log('üöÄ Uygulama ba≈ülatƒ±lƒ±yor...');

        // Ba≈ülatma adƒ±mlarƒ±nƒ± tanƒ±mla
        setupInitializationSteps();

        // Adƒ±mlarƒ± y√ºr√ºt
        await appInitializer.executeSteps();

        // Ba≈üarƒ±lƒ± ba≈ülatma sonrasƒ±
        await onAppInitialized();

    } catch (error) {
        console.error('üí• Uygulama ba≈ülatma hatasƒ±:', error);
        
        // Hata durumunda kurtarma
        await handleInitializationError(error);
        
        // Acil durum moduna ge√ß
        dynamicEmergencyFallback();
    }
}

// =============================================
// YARDIMCI FONKSƒ∞YONLAR
// =============================================

async function performFinalChecks() {
    const checks = [
        { name: 'Supabase Baƒülantƒ±sƒ±', check: checkSupabaseConnection },
        { name: 'Ses Sistemi', check: checkVoiceSystem },
        { name: 'Konum Servisi', check: checkLocationService },
        { name: '√ñdeme Sistemi', check: checkPaymentSystem }
    ];

    for (const check of checks) {
        try {
            const result = await check.check();
            console.log(`‚úÖ ${check.name}: ${result ? 'Hazƒ±r' : 'Hata'}`);
        } catch (error) {
            console.warn(`‚ö†Ô∏è ${check.name} kontrol√º ba≈üarƒ±sƒ±z:`, error);
        }
    }
}

async function checkSupabaseConnection() {
    try {
        const { data, error } = await supabase
            .from('customers')
            .select('count')
            .limit(1);
        
        return !error;
    } catch (error) {
        return false;
    }
}

function checkVoiceSystem() {
    return !!(window.SpeechRecognition || window.webkitSpeechRecognition);
}

function checkLocationService() {
    return !!navigator.geolocation;
}

function checkPaymentSystem() {
    return typeof setupPaymentButtons === 'function';
}

async function onAppInitialized() {
    // Ba≈üarƒ±lƒ± ba≈ülatma sonrasƒ± yapƒ±lacaklar
    console.log('üéØ Uygulama hazƒ±r!');
    
    // Kullanƒ±cƒ±ya ho≈ü geldin mesajƒ±
    if (currentCustomer) {
        displayMessage(`Ho≈ü geldiniz ${currentCustomer.name}! Sesli asistan hazƒ±r.`);
        speakToUser("Sistem hazƒ±r, sipari≈üe ba≈ülayabilirsiniz");
    } else {
        displayMessage("Sesli sipari≈ü sistemine ho≈ü geldiniz! L√ºtfen konumunuzu se√ßin.");
        speakToUser("Ho≈ü geldiniz, konum se√ßin");
    }

    // Performans metrikleri
    const loadTime = Date.now() - (appInitializer.initStartTime || Date.now());
    console.log(`üìä Uygulama y√ºkleme s√ºresi: ${loadTime}ms`);
}

async function handleInitializationError(error) {
    console.error('üîÑ Ba≈ülatma hatasƒ± i≈üleniyor:', error);
    
    // Hata raporlama
    await reportErrorToAnalytics(error);
    
    // Kullanƒ±cƒ±ya bilgi ver
    displayMessage("Sistem y√ºklenirken bir hata olu≈ütu. Bazƒ± √∂zellikler kƒ±sƒ±tlƒ± √ßalƒ±≈üabilir.");
    
    // Temel i≈ülevleri etkinle≈ütir
    enableBasicFunctionality();
}

function enableBasicFunctionality() {
    // Temel i≈ülevleri etkinle≈ütir
    console.log('üîß Temel i≈ülevler etkinle≈ütiriliyor...');
    
    // Manuel modu etkinle≈ütir
    setupManualMode();
    
    // Yerel depolamayƒ± kullan
    setupOfflineDataManagement();
    
    // Acil durum UI'ƒ±
    showEmergencyUI();
}

function showEmergencyUI() {
    const emergencyBar = document.createElement('div');
    emergencyBar.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; background: #ffc107; color: #333; text-align: center; padding: 10px; z-index: 10000;">
            <i class="fas fa-exclamation-triangle"></i> 
            Kƒ±sƒ±tlƒ± mod: Bazƒ± √∂zellikler √ßalƒ±≈ümayabilir. 
            <button onclick="location.reload()" style="margin-left: 10px; padding: 5px 10px; background: #333; color: white; border: none; border-radius: 4px;">
                Yeniden Dene
            </button>
        </div>
    `;
    document.body.appendChild(emergencyBar);
}

// =============================================
// EKSƒ∞K FONKSƒ∞YONLAR
// =============================================

// reportErrorToAnalytics fonksiyonunu ekleyin
async function reportErrorToAnalytics(error) {
    console.error('Hata raporu:', error);
    // ƒ∞sterseniz buraya analytics servisi entegrasyonu ekleyebilirsiniz
    return Promise.resolve();
}

// initializeDemoMode fonksiyonunu ekleyin
function initializeDemoMode() {
    console.log('üîß Demo modu ba≈ülatƒ±lƒ±yor...');
    
    // Temel i≈ülevleri etkinle≈ütir
    setupManualMode();
    setupOfflineDataManagement();
    
    // Demo verileri y√ºkle
    loadDemoData();
    
    displayMessage("Demo modu aktif. Temel i≈ülevler kullanƒ±labilir.");
    speakToUser("Demo modu ba≈ülatƒ±ldƒ±");
}

function loadDemoData() {
    // Demo maƒüaza tipleri
    const demoStoreTypes = [
        { id: 1, name: 'Market' },
        { id: 2, name: 'Restoran' },
        { id: 3, name: 'Eczane' }
    ];
    displayStoreTypes(demoStoreTypes);
    
    // Demo kategoriler
    const demoCategories = [
        { id: 1, name: 'Meyve & Sebze' },
        { id: 2, name: 'S√ºt √úr√ºnleri' },
        { id: 3, name: 'ƒ∞√ßecekler' }
    ];
    displayCategories(demoCategories);
}

        
// =============================================
// UYGULAMA DURUM Y√ñNETƒ∞Mƒ∞
// =============================================

const AppState = {
    INITIALIZING: 'initializing',
    READY: 'ready',
    ERROR: 'error',
    OFFLINE: 'offline'
};

let currentAppState = AppState.INITIALIZING;

function setAppState(newState) {
    console.log(`üîÑ Uygulama durumu: ${currentAppState} -> ${newState}`);
    currentAppState = newState;
    updateAppStateUI();
}

function updateAppStateUI() {
    const stateIndicators = {
        [AppState.INITIALIZING]: 'üîÑ Y√ºkleniyor...',
        [AppState.READY]: '‚úÖ Hazƒ±r',
        [AppState.ERROR]: '‚ùå Hata',
        [AppState.OFFLINE]: 'üîå √áevrimdƒ±≈üƒ±'
    };

    // Header'da durum g√∂stergesi
    const stateElement = document.getElementById('appStateIndicator') || createStateIndicator();
    stateElement.textContent = stateIndicators[currentAppState] || '‚ùì Bilinmeyen';
}

function createStateIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'appStateIndicator';
    indicator.style.cssText = `
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        z-index: 10000;
    `;
    document.body.appendChild(indicator);
    return indicator;
}

// =============================================
// G√úNCELLENMƒ∞≈û loadAllDynamicData
// =============================================

async function loadAllDynamicData() {
    const dataLoaders = [
        { name: 'Komut Kurallarƒ±', loader: loadCommandRules },
        { name: 'Maƒüaza Tipleri', loader: loadStoreTypes },
        { name: 'Dil Se√ßenekleri', loader: loadLanguageOptions },
        { name: 'Referral Kurallar', loader: loadReferralRules }
    ];

    const results = await Promise.allSettled(
        dataLoaders.map(async ({ name, loader }) => {
            try {
                await loader();
                console.log(`‚úÖ ${name} y√ºklendi`);
                return { name, success: true };
            } catch (error) {
                console.error(`‚ùå ${name} y√ºkleme hatasƒ±:`, error);
                return { name, success: false, error };
            }
        })
    );

    const failedLoads = results.filter(r => r.status === 'rejected' || !r.value.success);
    if (failedLoads.length > 0) {
        console.warn(`‚ö†Ô∏è ${failedLoads.length} veri y√ºkleyici ba≈üarƒ±sƒ±z`);
    }

    debugLog('‚úÖ T√ºm dinamik veriler y√ºklendi');
}

async function loadAllDynamicData() {
    await loadCommandRules();
    await loadStoreTypes();
    
    // Dil se√ßeneklerini y√ºkle (hata olsa bile devam et)
    try {
        await loadLanguageOptions();
    } catch (error) {
        console.log('Dil y√ºkleme hatasƒ±, fallback kullanƒ±lƒ±yor:', error);
    }
    
    debugLog('‚úÖ T√ºm dinamik veriler y√ºklendi');
}

// Uygulama ba≈ülatƒ±ldƒ±ƒüƒ±nda dil selector'√º kur
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        setupLanguageSelector();
        translatePage('tr'); // Varsayƒ±lan dil
    }, 1000);
});

        // Sayfa y√ºklendiƒüinde
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM y√ºklendi, uygulama ba≈ülatƒ±lƒ±yor...');
    
    // Acil durum fallback'lerini kur
    setupEmergencyFallbacks();
    
    // Uygulamayƒ± ba≈ülat
    setTimeout(() => {
        initApp().catch(error => {
            console.error('üí• Uygulama ba≈ülatma hatasƒ±:', error);
            speakToUser("Sistem y√ºklenirken hata olu≈ütu. Demo modunda devam ediyorum.");
            initializeDemoMode();
        });
    }, 1000);
});

// =============================================
// Dƒ∞NAMƒ∞K KOMUT Sƒ∞STEMƒ∞ - VERƒ∞TABANI ODAKLI
// =============================================

async function loadCommandRules() {
    try {
        const { data, error } = await supabase
            .from('voice_command_rules')
            .select('*')
            .eq('is_active', true)
            .order('priority', { ascending: false });

        if (error) throw error;

        commandRules.clear();
        data.forEach(rule => {
            if (!commandRules.has(rule.root_code)) {
                commandRules.set(rule.root_code, []);
            }
            commandRules.get(rule.root_code).push(rule);
        });

        debugLog(`‚úÖ ${data.length} komut kuralƒ± y√ºklendi`);
    } catch (error) {
        console.error('Komut kurallarƒ± y√ºkleme hatasƒ±:', error);
        await createDefaultCommandRules();
    }
}

// Varsayƒ±lan komut kurallarƒ±nƒ± olu≈ütur
async function createDefaultCommandRules() {
    const defaultRules = [
        // Ba≈ülangƒ±√ß komutlarƒ±
        {
            root_code: '0:0',
            input_patterns: 'merhaba|selam|ba≈üla|hello|start',
            output_text: 'Merhaba! Sesli sipari≈ü sistemine ho≈ü geldiniz. L√ºtfen konumunuzu se√ßin.',
            next_root: '1:0',
            action_name: 'show_location_modal',
            priority: 10
        },
        
        // Konum komutlarƒ±
        {
            root_code: '1:0',
            input_patterns: 'restoran i√ßi|i√ßerde|yerinde',
            output_text: 'Restoran i√ßi se√ßildi.',
            next_root: '2:0',
            action_name: 'select_location',
            priority: 10
        },
        {
            root_code: '1:0',
            input_patterns: 'paket servis|paket|g√∂t√ºr',
            output_text: 'Paket servis se√ßildi.',
            next_root: '2:0',
            action_name: 'select_location',
            priority: 10
        },
        {
            root_code: '1:0',
            input_patterns: 'adrese teslim|teslimat|evime',
            output_text: 'Adrese teslim se√ßildi.',
            next_root: '2:0',
            action_name: 'select_location',
            priority: 10
        },
        
        // Maƒüaza tipi komutlarƒ±
        {
            root_code: '2:0',
            input_patterns: 'regex:(?<storeType>market|restoran|pastane|eczane|alkol|√ßi√ßek|√ßar≈üƒ±)',
            output_text: '{storeType} se√ßiliyor...',
            next_root: '3:0',
            action_name: 'select_store_type',
            priority: 10
        },
        
        // Satƒ±cƒ± komutlarƒ±
        {
            root_code: '3:0',
            input_patterns: 'regex:birinci|ilk|1',
            output_text: 'Birinci satƒ±cƒ± se√ßiliyor...',
            next_root: '4:0',
            action_name: 'select_seller',
            priority: 10
        },
        {
            root_code: '3:0',
            input_patterns: 'regex:ikinci|2',
            output_text: 'ƒ∞kinci satƒ±cƒ± se√ßiliyor...',
            next_root: '4:0',
            action_name: 'select_seller',
            priority: 9
        },
        
        // Reyon komutlarƒ±
        {
            root_code: '4:0',
            input_patterns: 'meyve|sebze|meyve sebze',
            output_text: 'Meyve ve sebze reyonu se√ßildi.',
            next_root: '5:0',
            action_name: 'select_category',
            priority: 10
        },
        {
            root_code: '4:0',
            input_patterns: 's√ºt|peynir|yoƒüurt|s√ºt √ºr√ºn',
            output_text: 'S√ºt √ºr√ºnleri reyonu se√ßildi.',
            next_root: '5:0',
            action_name: 'select_category',
            priority: 10
        },
        
        // √úr√ºn komutlarƒ±
        {
            root_code: '5:0',
            input_patterns: 'regex:(?<quantity>\d+)\s*(?<product>.*)',
            output_text: '{quantity} adet {product} sepete ekleniyor...',
            next_root: '5:0',
            action_name: 'add_to_cart',
            priority: 10
        },
        {
            root_code: '5:0',
            input_patterns: 'sepete git|sepetim|sepet',
            output_text: 'Sepetiniz a√ßƒ±lƒ±yor...',
            next_root: '6:0',
            action_name: 'manage_cart',
            priority: 9
        },
        
        // Sepet komutlarƒ±
        {
            root_code: '6:0',
            input_patterns: '√∂deme yap|√∂de|satƒ±n al',
            output_text: '√ñdeme y√∂ntemi se√ßiliyor...',
            next_root: '7:0',
            action_name: 'select_payment',
            priority: 10
        },
        
        // √ñdeme komutlarƒ±
        {
            root_code: '7:0',
            input_patterns: 'nakit|para',
            output_text: 'Nakit √∂deme se√ßildi.',
            next_root: '8:0',
            action_name: 'select_payment',
            priority: 10
        },
        {
            root_code: '7:0',
            input_patterns: 'kart|kredi|bank',
            output_text: 'Kart ile √∂deme se√ßildi.',
            next_root: '8:0',
            action_name: 'select_payment',
            priority: 10
        }
    ];

    // Varsayƒ±lan kurallarƒ± veritabanƒ±na kaydet
    for (const rule of defaultRules) {
        const { error } = await supabase
            .from('voice_command_rules')
            .insert([rule]);
        
        if (error) {
            console.error('Varsayƒ±lan kural ekleme hatasƒ±:', error);
        }
    }

    // Belleƒüe y√ºkle
    defaultRules.forEach(rule => {
        if (!commandRules.has(rule.root_code)) {
            commandRules.set(rule.root_code, []);
        }
        commandRules.get(rule.root_code).push(rule);
    });
}


// =============================================
// Dƒ∞NAMƒ∞K SES KOMUT ƒ∞≈ûLEME
// =============================================

// product_voice_matches tablosu i√ßin g√ºvenli sorgu fonksiyonu
// G√ºvenli ses e≈üle≈ütirme sorgusu
// G√ºvenli ses e≈üle≈ütirme sorgusunu g√ºncelleyin
async function safeVoiceMatchQuery(userInput) {
    try {
        const cleanInput = userInput.toLowerCase()
            .replace(/√∂rneƒüin|mesela/g, '')
            .trim();
            
        // Daha g√ºvenli sorgu - ilike yerine text arama
        const { data, error } = await supabase
            .from('product_voice_matches')
            .select('matched_product')
            .textSearch('user_input', cleanInput) // ilike yerine textSearch
            .eq('success', true)
            .limit(1);

        if (error) {
            console.log('‚ö†Ô∏è Voice match sorgu hatasƒ±:', error.message);
            return null;
        }
        
        return data && data.length > 0 ? data[0] : null;
        
    } catch (error) {
        console.log('üîá Voice match sorgu hatasƒ± (g√ºvenli):', error.message);
        return null;
    }
}
        

async function processVoiceCommand(transcript) {
    const message = transcript.toLowerCase().trim();
    console.log(`üîä Sesli komut: "${message}" | K√∂k: ${currentRoot}`);

    // KENDƒ∞ MESAJIMIZI TEKRAR ALGILAMA KONTROL√ú
    if (transcript.trim() === lastSpokenMessage.trim()) {
        console.log("‚ö†Ô∏è Kendi cevabƒ±mƒ±z tekrar algƒ±landƒ±, atlandƒ±");
        return;
    }

    // GEREKSƒ∞Z KELƒ∞MELERƒ∞ Fƒ∞LTRELE
    const filteredMessage = filterUnnecessaryWords(message);
    if (!filteredMessage) {
        console.log("üîá Gereksiz mesaj filtrelendi");
        return;
    }
    
    console.log(`üéØ Filtrelenmi≈ü komut: "${filteredMessage}"`);

    try {
        // =============================================
        // 1. √ñZEL: EVET/HAYIR KONTROL√ú (EN √ñNCELƒ∞KLƒ∞)
        // =============================================
        
        // Adres onayƒ± bekleniyorsa
        if (isWaitingForAddressConfirm && (message === 'evet' || message === 'hayƒ±r')) {
            console.log('üè† Adres onayƒ± i√ßin evet/hayƒ±r algƒ±landƒ±');
            await processAddressConfirmation(message);
            return;
        }
        
        // Sipari≈ü onayƒ± bekleniyorsa
        if (isWaitingForOrderConfirm && (message === 'evet' || message === 'hayƒ±r')) {
            console.log('‚úÖ Sipari≈ü onayƒ± i√ßin evet/hayƒ±r algƒ±landƒ±');
            await processOrderConfirmation(message);
            return;
        }

        // =============================================
        // 2. √ñDEME S√úRECƒ∞ INPUT KONTROLLERƒ∞
        // =============================================
        
        // Telefon numarasƒ± bekleniyor
        if (isWaitingForPhone && expectedInput === 'phone') {
            await processPhoneNumber(message);
            return;
        }
        
        // M√º≈üteri adƒ± bekleniyor
        if (isWaitingForName && expectedInput === 'name') {
            await processCustomerName(message);
            return;
        }
        
        // Bina numarasƒ± bekleniyor
        if (isWaitingForBuilding && expectedInput === 'building') {
            await processBuildingInfo(message);
            return;
        }
        
        // Daire numarasƒ± bekleniyor
        if (isWaitingForApartment && expectedInput === 'apartment') {
            await processApartmentInfo(message);
            return;
        }
        
        // Yeni bina numarasƒ± bekleniyor
        if (isWaitingForNewBuilding && expectedInput === 'new_building') {
            await processNewBuildingInfo(message);
            return;
        }
        
        // Yeni daire numarasƒ± bekleniyor
        if (isWaitingForNewApartment && expectedInput === 'new_apartment') {
            await processNewApartmentInfo(message);
            return;
        }

        // =============================================
        // 3. √ñDEME KOMUTLARI (checkPaymentCommands KULLANARAK)
        // =============================================
        
        // √ñDEME MODALI A√áMA
        if (message.includes('√∂deme') || message.includes('√∂de') || message.includes('satƒ±n al')) {
            if (cart.length === 0) {
                displayMessage("‚ùå Sepetiniz bo≈ü. √ñdeme yapabilmek i√ßin sepete √ºr√ºn ekleyin.");
                speakToUser("Sepetiniz bo≈ü");
                return;
            }
            
            showPaymentModal();
            displayMessage("üí≥ √ñdeme y√∂ntemi se√ßin: Nakit, Kart veya Bonus");
            speakToUser("√ñdeme y√∂ntemi se√ßin");
            return;
        }
        
        // checkPaymentCommands ƒ∞LE √ñDEME Y√ñNTEMƒ∞ SE√áƒ∞Mƒ∞
        const paymentMethod = checkPaymentCommands(message);
        if (paymentMethod) {
            if (cart.length === 0) {
                displayMessage("‚ùå Sepetiniz bo≈ü. √ñdeme yapabilmek i√ßin sepete √ºr√ºn ekleyin.");
                speakToUser("Sepetiniz bo≈ü");
                return;
            }
            console.log(`üí∞ √ñdeme komutu algƒ±landƒ±: ${paymentMethod}`);
            startPaymentProcess(paymentMethod);
            return;
        }

        // =============================================
        // 4. REFERRAL KOMUTLARI
        // =============================================
        
        const referralHandled = await handleReferralVoiceCommand(message);
        if (referralHandled) return;

        // =============================================
        // 5. SEPET Y√ñNETƒ∞Mƒ∞ KOMUTLARI
        // =============================================
        
        // SEPETƒ∞ TEMƒ∞ZLEME
        const clearCartCommands = [
            'sepeti bo≈üalt', 'sepeti temizle', 'her ≈üeyi sil', 'sƒ±fƒ±rla',
            'clear cart', 'empty cart', 'reset cart', 'temizle',
            'hepsini sil', '√ºr√ºnleri kaldƒ±r', 'sepetten kaldƒ±r', 'bo≈üalt'
        ];
        
        if (clearCartCommands.some(cmd => message.includes(cmd))) {
            console.log('üõí Sepeti bo≈üaltma komutu algƒ±landƒ±');
            clearCart();
            return;
        }
        
        // SEPET G√ñR√úNT√úLEME
        if (message.includes('sepet') || message.includes('sepetim') || message.includes('sepeti g√∂ster')) {
            if (cart.length === 0) {
                displayMessage("üõí Sepetiniz bo≈ü");
                speakToUser("Sepetiniz bo≈ü");
            } else {
                openDynamicCart();
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                displayMessage(`üõí Sepetinizde ${cart.length} √ºr√ºn bulunuyor`);
                speakToUser(`Sepetinizde ${totalItems} adet √ºr√ºn var`);
            }
            return;
        }

        // =============================================
        // 6. TESLƒ∞MAT KONTROL KOMUTLARI
        // =============================================
        
        if (message.includes('mesafe') || message.includes('uzaklƒ±k') || message.includes('ka√ß km')) {
            if (selectedSellerId && userLocation.latitude) {
                await showDeliveryDistanceInfo();
                return;
            } else {
                displayMessage("‚ùå Mesafe bilgisi i√ßin √∂nce satƒ±cƒ± se√ßin ve konumunuzu belirleyin.");
                speakToUser("√ñnce satƒ±cƒ± se√ßin");
                return;
            }
        }
        
        if (message.includes('teslimat √ºcreti') || message.includes('kargo √ºcreti')) {
            if (selectedSellerId) {
                await showDeliveryFeeInfo();
                return;
            } else {
                displayMessage("‚ùå Teslimat √ºcreti i√ßin √∂nce bir satƒ±cƒ± se√ßin.");
                speakToUser("√ñnce satƒ±cƒ± se√ßin");
                return;
            }
        }

        // =============================================
        // 7. √úR√úN Fƒ∞LTRELEME VE EKLEME
        // =============================================
        
        // AKILLI √úR√úN Fƒ∞LTRELEME
        if ((currentRoot === "5:0" || selectedCategoryId) && products.length > 0 && !message.includes('numara')) {
            console.log('üîç Akƒ±llƒ± filtreleme deneniyor:', message);
            
            // "evet" ve "hayƒ±r" √ºr√ºn olarak algƒ±lanmasƒ±n
            if (message === 'evet' || message === 'hayƒ±r') {
                console.log('üö´ "evet/hayƒ±r" √ºr√ºn olarak algƒ±lanmadƒ±');
                displayMessage("‚ùå L√ºtfen √ºr√ºn ismi s√∂yleyin");
                speakToUser("√úr√ºn ismi s√∂yleyin");
                return;
            }
            
            const hasMatches = await findProductByNameForFilter(message);
            
            if (hasMatches) {
                const filteredProducts = await smartFilterProducts(message);
                
                if (filteredProducts.length > 0) {
                    displayProducts(filteredProducts, message);
                    displayMessage(`üîç "${message}" i√ßin ${filteredProducts.length} √ºr√ºn bulundu. L√ºtfen numara s√∂yleyin.`);
                    speakToUser(`${filteredProducts.length} √ºr√ºn bulundu, numara s√∂yleyin`);
                    return;
                }
            }
            
            console.log(`‚ùå "${message}" i√ßin e≈üle≈üme bulunamadƒ±, normal akƒ±≈üa devam`);
        }

        // √úR√úN EKLEME
        if ((currentRoot === "5:0" || selectedCategoryId) && products.length > 0) {
            console.log('üõí √úr√ºn ekleme komutu kontrol ediliyor...');
            
            const success = await handleVoiceProductAdd(filteredMessage);
            if (success) {
                console.log('‚úÖ √úr√ºn ba≈üarƒ±yla eklendi');
                return;
            }
        }

        // =============================================
        // 8. ALI≈ûVERƒ∞≈û AKI≈ûI KOMUTLARI
        // =============================================

        // MAƒûAZA Tƒ∞Pƒ∞ SE√áƒ∞Mƒ∞
        if ((currentRoot === "2:0" || currentRoot === "2:1") && hasStoreTypeKeywords(filteredMessage)) {
            console.log('üè™ Maƒüaza se√ßim komutu algƒ±landƒ±');
            const success = await handleVoiceStoreSelection(filteredMessage);
            if (success) {
                console.log('‚úÖ Maƒüaza se√ßildi, k√∂k sabit:', currentRoot);
                return;
            }
        }
        
        // T√úM SATICILARI G√ñSTER
        if (message.includes('t√ºm satƒ±cƒ±lar') || message.includes('t√ºm maƒüazalar') || message.includes('hepsini g√∂ster')) {
            showAllSellers();
            speakToUser("T√ºm satƒ±cƒ±lar g√∂steriliyor");
            return;
        }

        // SATICI SE√áƒ∞Mƒ∞
        if ((currentRoot === "2:0" || currentRoot === "2:1" || currentRoot === "3:0") && hasSellerKeywords(filteredMessage)) {
            console.log('üè¨ Satƒ±cƒ± se√ßim komutu algƒ±landƒ±');
            const success = await handleVoiceSellerSelection(filteredMessage);
            if (success) return;
        }

        // SATICI DURUMU
        if (message.includes('a√ßƒ±k maƒüaza') || message.includes('a√ßƒ±k satƒ±cƒ±') || message.includes('hangi maƒüaza a√ßƒ±k')) {
            await showOpenSellers();
            return;
        }
        
        if (message.includes('maƒüaza durumu') || message.includes('satƒ±cƒ± durumu')) {
            if (selectedSellerId) {
                await showCurrentSellerStatus();
            } else {
                displayMessage("‚ùå √ñnce bir satƒ±cƒ± se√ßin.");
                speakToUser("√ñnce satƒ±cƒ± se√ßin");
            }
            return;
        }

        // REYON SE√áƒ∞Mƒ∞
        if ((currentRoot === "3:0" || currentRoot === "4:0" || (selectedSellerId && !selectedCategoryId)) && hasCategoryKeywords(filteredMessage)) {
            console.log('üì¶ Reyon se√ßim komutu algƒ±landƒ±');
            const success = await handleVoiceCategorySelection(filteredMessage);
            if (success) return;
        }

        // =============================================
        // 9. NAVƒ∞GASYON KOMUTLARI
        // =============================================
        
        // GERƒ∞ Gƒ∞TME
        if (message.includes('geri') || message.includes('geri git') || message.includes('back')) {
            await handleBackNavigation();
            return;
        }
        
        // ANA SAYFA
        if (message.includes('ana sayfa') || message.includes('ba≈ülangƒ±√ß') || message.includes('home')) {
            resetToHome();
            return;
        }
        
        // YARDIM
        if (message.includes('yardƒ±m') || message.includes('help') || message.includes('nasƒ±l')) {
            showHelp();
            return;
        }

        // =============================================
        // 10. Sƒ∞STEM KOMUTLARI
        // =============================================
        
        // Mƒ∞KROFON KONTROL√ú
        if (message.includes('mikrofon') || message.includes('ses')) {
            if (message.includes('a√ß') || message.includes('ba≈ülat')) {
                if (!isMicrophoneEnabled) {
                    enableDynamicMicrophone();
                }
                return;
            } else if (message.includes('kapat') || message.includes('durdur')) {
                if (isMicrophoneEnabled) {
                    disableDynamicMicrophone();
                }
                return;
            }
        }
        
        // KONUM DEƒûƒ∞≈ûTƒ∞RME
        if (message.includes('konum') || message.includes('yer') || message.includes('location')) {
            showDynamicLocationModal();
            return;
        }

        // =============================================
        // 11. FALLBACK MESAJI (SON √áARE)
        // =============================================
        
        console.log('‚ùå Hi√ßbir komut i≈ülenemedi, fallback kontrol√º...');
        const fallbackMessage = getSmartFallback();
        if (fallbackMessage) {
            displayMessage(fallbackMessage);
            speakToUser(fallbackMessage);
        }

    } catch (error) {
        console.error('‚ùå Komut i≈üleme hatasƒ±:', error);
        if (Date.now() - lastSpeakTime > SPEAK_COOLDOWN) {
            displayMessage("‚ùå Bir hata olu≈ütu, l√ºtfen tekrar deneyin.");
            speakToUser("Bir hata olu≈ütu, tekrar deneyin.");
        }
    }
}
          

// =============================================
// YENƒ∞ REFERRAL VE BONUS Sƒ∞STEMƒ∞
// =============================================

// =============================================
// REFERRAL VERƒ∞TABANI ƒ∞≈ûLEMLERƒ∞
// =============================================

// Referral kurallarƒ±nƒ± y√ºkle
async function loadReferralRules() {
    try {
        const { data, error } = await supabase
            .from('referral_rules')
            .select('*')
            .eq('is_active', true);

        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Referral kurallarƒ± y√ºkleme hatasƒ±:', error);
        return createDefaultReferralRules();
    }
}

// Varsayƒ±lan referral kurallarƒ±
async function createDefaultReferralRules() {
    const defaultRules = [
        {
            name: 'Referans Bonusu',
            bonus_amount: 10.00,
            bonus_type: 'fixed',
            description: 'Her ba≈üarƒ±lƒ± referral i√ßin sabit bonus',
            is_active: true
        },
        {
            name: 'Sipari≈ü Bonusu',
            bonus_amount: 2.00,
            bonus_type: 'percentage',
            description: 'Sipari≈ü tutarƒ± √ºzerinden %2 bonus',
            is_active: true
        }
    ];

    try {
        const { error } = await supabase
            .from('referral_rules')
            .insert(defaultRules);

        if (error) throw error;
        return defaultRules;
    } catch (error) {
        console.error('Varsayƒ±lan kurallar olu≈üturma hatasƒ±:', error);
        return defaultRules;
    }
}

// =============================================
// GRUP Y√ñNETƒ∞Mƒ∞
// =============================================

// Grup kodu olu≈ütur
function generateGroupCode() {
    return Math.random().toString(36).substring(2, 10).toUpperCase();
}

// Lider kontrol√º
async function checkGroupLeader(userId) {
    try {
        const { data, error } = await supabase
            .from('customers')
            .select('role, group_code')
            .eq('id', userId)
            .single();

        if (error) throw error;
        return data && data.role === 'Lider' ? data.group_code : null;
    } catch (error) {
        console.error('Lider kontrol hatasƒ±:', error);
        return null;
    }
}

// Grup olu≈ütur
async function createReferralGroup(leaderUserId, groupName) {
    try {
        const groupCode = generateGroupCode();
        
        const { data, error } = await supabase
            .from('referral_groups')
            .insert([{
                name: groupName,
                group_code: groupCode,
                leader_user_id: leaderUserId,
                created_at: new Date().toISOString()
            }])
            .select()
            .single();

        if (error) throw error;

        // M√º≈üteri kaydƒ±nƒ± g√ºncelle
        await supabase
            .from('customers')
            .update({ group_code: groupCode })
            .eq('id', leaderUserId);

        return data;
    } catch (error) {
        console.error('Grup olu≈üturma hatasƒ±:', error);
        return null;
    }
}

// =============================================
// REFERRAL Lƒ∞NK Y√ñNETƒ∞Mƒ∞
// =============================================

// Referral link olu≈ütur
async function generateReferralLink(ownerUserId, groupCode = null) {
    try {
        const referralCode = generateGroupCode(); // Benzersiz kod
        
        const linkData = {
            owner_user_id: ownerUserId,
            referral_code: referralCode,
            created_at: new Date().toISOString()
        };

        if (groupCode) {
            linkData.group_code = groupCode;
        }

        const { data, error } = await supabase
            .from('referral_links')
            .insert([linkData])
            .select()
            .single();

        if (error) throw error;

        const baseUrl = window.location.origin;
        const referralLink = groupCode 
            ? `${baseUrl}?group_code=${groupCode}&ref=${referralCode}`
            : `${baseUrl}?ref=${referralCode}`;

        return {
            link: referralLink,
            code: referralCode,
            id: data.id
        };
    } catch (error) {
        console.error('Referral link olu≈üturma hatasƒ±:', error);
        return null;
    }
}

// URL'den referral bilgilerini al
function getReferralFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    const referralCode = urlParams.get('ref');
    const groupCode = urlParams.get('group_code');

    return { referralCode, groupCode };
}

// =============================================
// REFERRAL TAKƒ∞P
// =============================================

// Referral tracking kaydƒ± olu≈ütur
async function createReferralTracking(referralCode, groupCode, referrerUserId) {
    try {
        const { data, error } = await supabase
            .from('referral_tracking')
            .insert([{
                referral_code: referralCode,
                group_code: groupCode,
                referrer_user_id: referrerUserId,
                created_at: new Date().toISOString()
            }])
            .select()
            .single();

        if (error) throw error;
        return data;
    } catch (error) {
        console.error('Referral tracking hatasƒ±:', error);
        return null;
    }
}

// Yeni kullanƒ±cƒ± i√ßin referral tracking'i g√ºncelle
async function updateReferralTrackingWithNewUser(referralCode, newUserId) {
    try {
        const { error } = await supabase
            .from('referral_tracking')
            .update({ new_user_id: newUserId })
            .eq('referral_code', referralCode);

        if (error) throw error;
        return true;
    } catch (error) {
        console.error('Tracking g√ºncelleme hatasƒ±:', error);
        return false;
    }
}

// =============================================
// BONUS HESAPLAMA VE DAƒûITIM
// =============================================

// Referans bonusu uygula
async function applyReferralBonus(referralTrackingId) {
    try {
        const referralRule = await getReferralRuleByName('Referans Bonusu');
        if (!referralRule) return false;

        const { data, error } = await supabase
            .from('referral_bonus')
            .insert([{
                referral_tracking_id: referralTrackingId,
                bonus_amount: referralRule.bonus_amount,
                created_at: new Date().toISOString()
            }])
            .select()
            .single();

        if (error) throw error;

        // Referrer'ƒ±n bonus bakiyesini g√ºncelle
        await updateUserBonusBalance(data.referrer_user_id, referralRule.bonus_amount);

        return true;
    } catch (error) {
        console.error('Referral bonus uygulama hatasƒ±:', error);
        return false;
    }
}

// Sipari≈ü bonusu hesapla ve uygula
async function calculateOrderBonus(orderId, userId, orderAmount) {
    try {
        const referralRule = await getReferralRuleByName('Sipari≈ü Bonusu');
        if (!referralRule) return false;

        let bonusAmount = 0;
        
        if (referralRule.bonus_type === 'percentage') {
            bonusAmount = (orderAmount * referralRule.bonus_amount) / 100;
        } else {
            bonusAmount = referralRule.bonus_amount;
        }

        // Bonus kullanƒ±m kaydƒ±
        const { data, error } = await supabase
            .from('referral_bonus_usage')
            .insert([{
                user_id: userId,
                amount: bonusAmount,
                description: `Sipari≈ü bonusu - Sipari≈ü #${orderId}`,
                order_id: orderId,
                group_code: currentCustomer?.group_code,
                order_bonus: bonusAmount,
                bonus_type: referralRule.name,
                ratio: referralRule.bonus_amount,
                created_at: new Date().toISOString()
            }])
            .select()
            .single();

        if (error) throw error;

        // Kullanƒ±cƒ± bonus bakiyesini g√ºncelle
        await updateUserBonusBalance(userId, bonusAmount);

        return bonusAmount;
    } catch (error) {
        console.error('Sipari≈ü bonusu hesaplama hatasƒ±:', error);
        return 0;
    }
}

// Kullanƒ±cƒ± bonus bakiyesini g√ºncelle
async function updateUserBonusBalance(userId, bonusAmount) {
    try {
        // Mevcut bakiyeyi al
        const { data: customer, error: fetchError } = await supabase
            .from('customers')
            .select('bonus_balance')
            .eq('id', userId)
            .single();

        if (fetchError) throw fetchError;

        const newBalance = (customer.bonus_balance || 0) + bonusAmount;

        const { error } = await supabase
            .from('customers')
            .update({ bonus_balance: newBalance })
            .eq('id', userId);

        if (error) throw error;

        return newBalance;
    } catch (error) {
        console.error('Bonus bakiye g√ºncelleme hatasƒ±:', error);
        return null;
    }
}

// Bonus kullanƒ±mƒ± (√∂deme sƒ±rasƒ±nda)
async function useBonusForPayment(userId, usedAmount, orderId) {
    try {
        const { data, error } = await supabase
            .from('referral_payouts')
            .insert([{
                user_id: userId,
                amount: usedAmount,
                order_id: orderId,
                status: 'used',
                paid_at: new Date().toISOString()
            }])
            .select()
            .single();

        if (error) throw error;

        // Bakiyeden d√º≈ü
        const { data: customer, error: fetchError } = await supabase
            .from('customers')
            .select('bonus_balance')
            .eq('id', userId)
            .single();

        if (fetchError) throw fetchError;

        const newBalance = (customer.bonus_balance || 0) - usedAmount;

        await supabase
            .from('customers')
            .update({ bonus_balance: newBalance })
            .eq('id', userId);

        return true;
    } catch (error) {
        console.error('Bonus kullanƒ±m hatasƒ±:', error);
        return false;
    }
}

// =============================================
// YARDIMCI FONKSƒ∞YONLAR
// =============================================

// ƒ∞simden referral kuralƒ±nƒ± getir
// URL encode sorununu √ß√∂zmek i√ßin
async function getReferralRuleByName(ruleName) {
    try {
        // URL encode problemi i√ßin daha basit sorgu
        const { data, error } = await supabase
            .from('referral_rules')
            .select('*')
            .eq('is_active', true);

        if (error) throw error;
        
        // ƒ∞stemci tarafƒ±nda filtrele
        const rule = data.find(r => r.name === ruleName);
        return rule || null;
        
    } catch (error) {
        console.error('Kural getirme hatasƒ±:', error);
        return null;
    }
}
// Kullanƒ±cƒ±nƒ±n bonus bakiyesini getir
async function getUserBonusBalance(userId) {
    try {
        const { data, error } = await supabase
            .from('customers')
            .select('bonus_balance')
            .eq('id', userId)
            .single();

        if (error) throw error;
        return data.bonus_balance || 0;
    } catch (error) {
        console.error('Bonus bakiye getirme hatasƒ±:', error);
        return 0;
    }
}


// =============================================
// REFERRAL Sƒ∞STEMƒ∞ BA≈ûLATMA
// =============================================

async function initializeReferralSystem() {
    try {
        // Referral kurallarƒ±nƒ± y√ºkle
        await loadReferralRules();
        
        // URL'den referral kontrol√º
        const { referralCode, groupCode } = getReferralFromUrl();
        
        if (referralCode) {
            pendingReferralCode = referralCode;
            currentReferralGroup = groupCode;
            
            console.log(`üéØ Referral algƒ±landƒ±: ${referralCode}, Grup: ${groupCode}`);
            
            if (currentCustomer) {
                // Kullanƒ±cƒ± giri≈ü yapmƒ±≈üsa hemen i≈üle
                await processPendingReferral();
            }
        }

        // Bonus bakiyesini y√ºkle
        if (currentCustomer) {
            referralBonusBalance = await getUserBonusBalance(currentCustomer.id);
            updateBonusUI();
        }

        console.log('‚úÖ Referral sistemi ba≈ülatƒ±ldƒ±');
    } catch (error) {
        console.error('Referral sistem ba≈ülatma hatasƒ±:', error);
    }
}

// Bekleyen referral'ƒ± i≈üle
async function processPendingReferral() {
    if (!pendingReferralCode || !currentCustomer) return;

    try {
        // Referral tracking olu≈ütur
        const tracking = await createReferralTracking(
            pendingReferralCode, 
            currentReferralGroup, 
            null // Referrer ID sonradan g√ºncellenecek
        );

        if (tracking) {
            // Yeni kullanƒ±cƒ± ID'sini g√ºncelle
            await updateReferralTrackingWithNewUser(pendingReferralCode, currentCustomer.id);
            
            // Referrer ID'yi bul ve g√ºncelle
            const { data: linkData, error } = await supabase
                .from('referral_links')
                .select('owner_user_id')
                .eq('referral_code', pendingReferralCode)
                .single();

            if (!error && linkData) {
                await supabase
                    .from('referral_tracking')
                    .update({ referrer_user_id: linkData.owner_user_id })
                    .eq('id', tracking.id);

                // Bonus uygula
                await applyReferralBonus(tracking.id);
            }

            displayMessage(`‚úÖ Referral kodu ba≈üarƒ±yla uygulandƒ±! ${money(10)} bonus hesabƒ±nƒ±za eklendi.`);
            speakToUser("Referans kodu ba≈üarƒ±yla uygulandƒ±");
        }

        // Temizle
        pendingReferralCode = null;
        currentReferralGroup = null;

    } catch (error) {
        console.error('Bekleyen referral i≈üleme hatasƒ±:', error);
    }
}

// =============================================
// UI G√úNCELLEMELERƒ∞
// =============================================

function updateBonusUI() {
    // Bonus bakiyesini header'da g√∂ster
    const bonusElement = document.getElementById('bonusBalance');
    if (bonusElement) {
        bonusElement.textContent = money(referralBonusBalance);
    }

    // √ñdeme modalƒ±nda bonus se√ßeneƒüini g√ºncelle
    const bonusPaymentBtn = document.getElementById('payBonus');
    if (bonusPaymentBtn) {
        if (referralBonusBalance > 0) {
            bonusPaymentBtn.innerHTML = `<i class="fas fa-gift"></i> Bonus ile √ñde (${money(referralBonusBalance)})`;
            bonusPaymentBtn.disabled = false;
        } else {
            bonusPaymentBtn.innerHTML = `<i class="fas fa-gift"></i> Bonus Yok`;
            bonusPaymentBtn.disabled = true;
        }
    }
}

// √ñdeme i≈ülemine bonus ekle
function setupBonusPayment() {
    const bonusPaymentBtn = document.getElementById('payBonus');
    if (bonusPaymentBtn) {
        bonusPaymentBtn.addEventListener('click', async function() {
            if (referralBonusBalance > 0 && cart.length > 0) {
                const totalAmount = calculateTotal();
                const usedBonus = Math.min(referralBonusBalance, totalAmount);
                
                if (await useBonusForPayment(currentCustomer.id, usedBonus, null)) {
                    referralBonusBalance -= usedBonus;
                    updateBonusUI();
                    
                    displayMessage(`‚úÖ ${money(usedBonus)} bonus kullanƒ±ldƒ±! Kalan bakiye: ${money(referralBonusBalance)}`);
                    speakToUser("Bonus kullanƒ±ldƒ±");
                    
                    // Kalan tutar i√ßin diƒüer √∂deme y√∂ntemlerini g√∂ster
                    const remainingAmount = totalAmount - usedBonus;
                    if (remainingAmount > 0) {
                        displayMessage(`üìã Kalan tutar: ${money(remainingAmount)}. L√ºtfen √∂deme y√∂ntemi se√ßin.`);
                        showPaymentOptions();
                    } else {
                        // Tamamƒ± bonus ile √∂dendi
                        completeOrderWithBonus();
                    }
                }
            }
        });
    }
}
























        
// =============================================
// SESLƒ∞ KOMUT ENTEGRASYONU
// =============================================

// Referral komutlarƒ±nƒ± i≈üle
async function handleReferralVoiceCommand(message) {
    const cleanMessage = message.toLowerCase().trim();

    // Referral kodu uygulama
    if (cleanMessage.includes('referans') || cleanMessage.includes('tavsiye') || cleanMessage.includes('ref')) {
        const codeMatch = cleanMessage.match(/(ref|kod|referans)[:\s]*([a-zA-Z0-9]{4,8})/i);
        if (codeMatch && codeMatch[2]) {
            const referralCode = codeMatch[2].toUpperCase();
            await applyReferralCodeManually(referralCode);
            return true;
        } else {
            displayMessage("üéØ Referral kodunu s√∂yleyin: 'Referans kodu ABC123' ≈üeklinde");
            speakToUser("Referans kodunu s√∂yleyin");
            return true;
        }
    }

    // Bonus sorgulama
    if (cleanMessage.includes('bonus') || cleanMessage.includes('puan') || cleanMessage.includes('bakiyem')) {
        if (currentCustomer) {
            const balance = await getUserBonusBalance(currentCustomer.id);
            displayMessage(`üéÅ Bonus Bakiyeniz: ${money(balance)}`);
            speakToUser(`Bonus bakiyeniz ${money(balance)}`);
        } else {
            displayMessage("‚ùå Bonus bakiyenizi g√∂rmek i√ßin giri≈ü yapmalƒ±sƒ±nƒ±z.");
            speakToUser("Giri≈ü yapmalƒ±sƒ±nƒ±z");
        }
        return true;
    }

    // Referral linki olu≈üturma
    if (cleanMessage.includes('referans linki') || cleanMessage.includes('davet linki')) {
        await generateAndShowReferralLink();
        return true;
    }

    return false;
}

// Manuel referral kodu uygulama
async function applyReferralCodeManually(referralCode) {
    try {
        const { data: linkData, error } = await supabase
            .from('referral_links')
            .select('*')
            .eq('referral_code', referralCode)
            .single();

        if (error || !linkData) {
            displayMessage("‚ùå Ge√ßersiz referral kodu!");
            speakToUser("Ge√ßersiz referans kodu");
            return;
        }

        if (currentCustomer) {
            // Tracking olu≈ütur
            const tracking = await createReferralTracking(
                referralCode,
                linkData.group_code,
                linkData.owner_user_id
            );

            if (tracking) {
                await updateReferralTrackingWithNewUser(referralCode, currentCustomer.id);
                await applyReferralBonus(tracking.id);
                
                displayMessage(`‚úÖ Referral kodu ba≈üarƒ±yla uygulandƒ±! ${money(10)} bonus eklendi.`);
                speakToUser("Referans kodu ba≈üarƒ±yla uygulandƒ±");
                
                // Bonus bakiyesini yenile
                referralBonusBalance = await getUserBonusBalance(currentCustomer.id);
                updateBonusUI();
            }
        } else {
            // Kullanƒ±cƒ± giri≈ü yapana kadar sakla
            pendingReferralCode = referralCode;
            currentReferralGroup = linkData.group_code;
            displayMessage("üéØ Referral kodu kaydedildi. Giri≈ü yaptƒ±ƒüƒ±nƒ±zda otomatik uygulanacak.");
            speakToUser("Referans kodu kaydedildi");
        }

    } catch (error) {
        console.error('Manuel referral uygulama hatasƒ±:', error);
        displayMessage("‚ùå Referral kodu uygulanƒ±rken hata olu≈ütu.");
        speakToUser("Referans hatasƒ±");
    }
}


// =============================================
// G√úNCELLENMƒ∞≈û UI G√úNCELLEME FONKSƒ∞YONU
// =============================================

async function updateUIAfterDynamicLogin() {
    try {
        console.log('üé® UI g√ºncelleniyor...');
        
        if (currentCustomer) {
            // 1. Temel kullanƒ±cƒ± bilgilerini g√ºncelle
            updateBasicUserInfo();
            
            // 2. Bekleyen referral'ƒ± i≈üle
            if (pendingReferralCode) {
                await processPendingReferral();
            }
            
            // 3. Bonus sistemini y√ºkle
            await loadBonusSystem();
            
            // 4. Referral sistemi ba≈ülat
            await initializeReferralSystem();
            
            // 5. Konum bilgisini g√ºncelle
            updateDynamicLocationText();
            
            // 6. Sepet durumunu kontrol et
            checkCartState();
            
            // 7. Ho≈ü geldin mesajƒ± g√∂ster
            showWelcomeMessage();
            
            console.log('‚úÖ UI g√ºncelleme tamamlandƒ±');
        } else {
            // Misafir modu
            updateGuestUI();
        }
        
    } catch (error) {
        console.error('‚ùå UI g√ºncelleme hatasƒ±:', error);
        // Hata durumunda temel UI g√ºncellemesi yap
        updateBasicUI();
    }
}

// =============================================
// YARDIMCI FONKSƒ∞YONLAR
// =============================================

function updateBasicUserInfo() {
    // Kullanƒ±cƒ± adƒ±nƒ± g√ºncelle
    if (userName) {
        userName.textContent = currentCustomer.name || 'Profilim';
    }
    
    // Avatar g√ºncelleme (eƒüer varsa)
    if (profileAvatar && currentCustomer.avatar_url) {
        profileAvatar.src = currentCustomer.avatar_url;
        profileAvatar.style.display = 'block';
    }
    
    // Telefon numarasƒ± (eƒüer varsa)
    if (profilePhone && currentCustomer.phone) {
        profilePhone.textContent = currentCustomer.phone;
    }
    
    // Bonus bakiyesi header'da g√∂ster
    updateBonusUI();
}

async function loadBonusSystem() {
    try {
        // Bonus bakiyesini y√ºkle
        referralBonusBalance = await getUserBonusBalance(currentCustomer.id);
        
        // Bonus UI'ƒ±nƒ± g√ºncelle
        updateBonusUI();
        
        // Grup lideri kontrol√º
        const groupCode = await checkGroupLeader(currentCustomer.id);
        if (groupCode) {
            currentReferralGroup = groupCode;
            console.log(`üéØ Grup lideri tespit edildi: ${groupCode}`);
            // Grup lideri i√ßin ekstra UI √∂ƒüeleri
            showGroupLeaderFeatures();
        }
        
    } catch (error) {
        console.error('Bonus sistemi y√ºkleme hatasƒ±:', error);
        referralBonusBalance = 0;
    }
}


function createBonusElement() {
    // Bonus elementi yoksa olu≈ütur
    const bonusElement = document.createElement('div');
    bonusElement.id = 'bonusBalance';
    bonusElement.className = 'bonus-indicator';
    bonusElement.innerHTML = `
        <i class="fas fa-gift"></i>
        <span>${money(referralBonusBalance)}</span>
    `;
    bonusElement.style.cssText = `
        display: flex;
        align-items: center;
        gap: 5px;
        background: var(--primary);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 14px;
        font-weight: 600;
    `;
    
    // Header actions'a ekle
    const headerActions = document.querySelector('.header-actions');
    if (headerActions) {
        headerActions.insertBefore(bonusElement, headerActions.firstChild);
    }
    
    return bonusElement;
}

function updatePaymentButtons() {
    const bonusPaymentBtn = document.getElementById('payBonus');
    if (bonusPaymentBtn) {
        if (referralBonusBalance > 0) {
            bonusPaymentBtn.innerHTML = `
                <i class="fas fa-gift"></i> 
                Bonus ile √ñde (${money(referralBonusBalance)})
            `;
            bonusPaymentBtn.disabled = false;
            bonusPaymentBtn.style.display = 'block';
        } else {
            bonusPaymentBtn.innerHTML = `
                <i class="fas fa-gift"></i> 
                Bonus Yok
            `;
            bonusPaymentBtn.disabled = true;
            bonusPaymentBtn.style.display = 'none';
        }
    }
}

function showGroupLeaderFeatures() {
    // Grup lideri i√ßin √∂zel butonlar
    const referralBtn = document.createElement('button');
    referralBtn.className = 'action-btn';
    referralBtn.innerHTML = `
        <i class="fas fa-user-plus"></i>
        <span>Davet G√∂nder</span>
    `;
    referralBtn.onclick = async () => {
        await generateAndShowReferralLink();
    };
    
    // Header'a ekle
    const headerActions = document.querySelector('.header-actions');
    if (headerActions) {
        headerActions.insertBefore(referralBtn, headerActions.querySelector('.order-summary'));
    }
    
    // Grup istatistiklerini g√∂ster
    showGroupStats();
}

async function showGroupStats() {
    try {
        const { data, error } = await supabase
            .from('referral_groups')
            .select(`
                *,
                referral_tracking(count),
                referral_bonus(sum:bonus_amount)
            `)
            .eq('group_code', currentReferralGroup)
            .single();
            
        if (!error && data) {
            console.log('üìä Grup istatistikleri:', data);
            // ƒ∞statistikleri profil dropdown'da g√∂sterebilirsiniz
        }
    } catch (error) {
        console.error('Grup istatistikleri hatasƒ±:', error);
    }
}

function checkCartState() {
    // Sepet kilit durumunu kontrol et
    if (cart.length > 0 && selectedSellerId) {
        lockStoreAndSeller();
    } else {
        unlockStoreAndSeller();
    }
    
    // Sepet UI'ƒ±nƒ± g√ºncelle
    updateCartUI();
}

function showWelcomeMessage() {
    const welcomeMessage = `
        üéâ Ho≈ü geldiniz ${currentCustomer.name}!
        
        ‚Ä¢ Bonus bakiyeniz: ${money(referralBonusBalance)}
        ‚Ä¢ ${currentReferralGroup ? 'Grup lideri modu aktif' : 'Sipari≈üe ba≈ülayabilirsiniz'}
    `;
    
    displayMessage(welcomeMessage);
    
    // Sesli ho≈ü geldin
    if (isMicrophoneEnabled) {
        setTimeout(() => {
            speakToUser(`Ho≈ü geldiniz ${currentCustomer.name}. Bonus bakiyeniz ${money(referralBonusBalance)}`);
        }, 1000);
    }
}

function updateGuestUI() {
    // Misafir modu UI
    if (userName) {
        userName.textContent = 'Giri≈ü Yap';
    }
    
    // Bonus'u gizle
    const bonusElement = document.getElementById('bonusBalance');
    if (bonusElement) {
        bonusElement.style.display = 'none';
    }
    
    // √ñdeme butonlarƒ±nƒ± g√ºncelle
    updatePaymentButtons();
}

function updateBasicUI() {
    // Temel UI g√ºncellemesi (hata durumunda)
    if (currentCustomer && userName) {
        userName.textContent = currentCustomer.name || 'Profilim';
    }
    updateDynamicLocationText();
}

// M√º≈üteri giri≈ü yaptƒ±ƒüƒ±nda √ßaƒürƒ±lacak fonksiyon
function handleCustomerLogin(customer) {
    currentCustomer = customer;
    updateUIAfterDynamicLogin();
}

// Oturum geri y√ºklendiƒüinde
async function restoreSession() {
    try {
        const savedCustomer = localStorage.getItem('currentCustomer');
        if (savedCustomer) {
            currentCustomer = JSON.parse(savedCustomer);
            await updateUIAfterDynamicLogin();
            return true;
        }
        return false;
    } catch (error) {
        console.error('Oturum geri y√ºkleme hatasƒ±:', error);
        return false;
    }
}


// =============================================
// TESLƒ∞MAT Bƒ∞LGƒ∞Sƒ∞ G√ñSTERME
// =============================================

async function showDeliveryDistanceInfo() {
    if (!selectedSellerId || !userLocation.latitude) {
        displayMessage("‚ùå Mesafe bilgisi i√ßin satƒ±cƒ± se√ßili ve konumunuz belirli olmalƒ±.");
        return;
    }
    
    const seller = sellers.find(s => s.id === selectedSellerId);
    if (!seller || !seller.latitude) {
        displayMessage("‚ùå Bu satƒ±cƒ±nƒ±n konum bilgisi bulunamadƒ±.");
        return;
    }
    
    const distance = calculateDistance(
        seller.latitude, seller.longitude,
        userLocation.latitude, userLocation.longitude
    );
    
    const deliveryCheck = await checkDeliveryArea(
        selectedSellerId,
        userLocation.latitude,
        userLocation.longitude
    );
    
    let message = `üìç MESAFE Bƒ∞LGƒ∞Sƒ∞\n\n`;
    message += `üè™ ${seller.business_name}\n`;
    message += `üìè Mesafe: ${distance.toFixed(1)} km\n`;
    message += `‚úÖ Durum: ${deliveryCheck.allowed ? 'Teslimat Var' : 'Teslimat Yok'}\n`;
    
    if (deliveryCheck.allowed) {
        message += `üí∞ Teslimat √úcreti: ${money(deliveryCheck.deliveryFee || 0)}`;
        if (deliveryCheck.areaName) {
            message += `\nüèòÔ∏è B√∂lge: ${deliveryCheck.areaName}`;
        }
    } else {
        message += `\n‚ùå ${deliveryCheck.message}`;
    }
    
    displayMessage(message);
    speakToUser(`Mesafe ${distance.toFixed(1)} kilometre. ${deliveryCheck.allowed ? 'Teslimat var' : 'Teslimat yok'}`);
}     

async function showDeliveryFeeInfo() {
    if (!selectedSellerId) {
        displayMessage("‚ùå Teslimat √ºcreti i√ßin √∂nce bir satƒ±cƒ± se√ßin.");
        return;
    }
    
    const seller = sellers.find(s => s.id === selectedSellerId);
    if (!seller) return;
    
    let message = `üí∞ TESLƒ∞MAT √úCRETƒ∞\n\n`;
    message += `üè™ ${seller.business_name}\n`;
    
    if (selectedLocation === 'delivery') {
        if (userLocation.latitude) {
            const deliveryCheck = await checkDeliveryArea(
                selectedSellerId,
                userLocation.latitude,
                userLocation.longitude
            );
            
            message += `üìè Mesafe: ${deliveryCheck.distance ? deliveryCheck.distance.toFixed(1) + ' km' : 'Bilinmiyor'}\n`;
            message += `üí∞ √úcret: ${money(deliveryCheck.deliveryFee || 0)}`;
            
            if (deliveryCheck.areaName) {
                message += `\nüèòÔ∏è B√∂lge: ${deliveryCheck.areaName}`;
            }
        } else {
            message += `‚ÑπÔ∏è Konumunuz belirlenmediƒüi i√ßin ortalama teslimat √ºcreti: ${money(5)}`;
        }
    } else {
        message += `‚ÑπÔ∏è Teslimat se√ßilmedi. Restoran i√ßi veya paket servis.`;
    }
    
    displayMessage(message);
    speakToUser(`Teslimat √ºcreti ${money(seller.delivery_fee || 5)}`);
}

// =============================================
// YARDIMCI FONKSƒ∞YONLAR
// =============================================

// Navigasyon yardƒ±mcƒ± fonksiyonlarƒ±
async function handleBackNavigation() {
    console.log('‚Ü©Ô∏è Geri navigasyonu');
    
    if (currentRoot === "5:0" && selectedCategoryId) {
        // √úr√ºnlerden kategorilere geri d√∂n
        currentRoot = "4:0";
        selectedCategoryId = null;
        products = [];
        displayCategories(categories);
        displayMessage("üì¶ Kategoriler sayfasƒ±na d√∂n√ºld√º");
        speakToUser("Kategoriler");
        
    } else if (currentRoot === "4:0" && selectedSellerId) {
        // Kategorilerden satƒ±cƒ±lara geri d√∂n
        currentRoot = "3:0";
        selectedCategoryId = null;
        categories = [];
        displayMessage("üè¨ Satƒ±cƒ±lar sayfasƒ±na d√∂n√ºld√º");
        speakToUser("Satƒ±cƒ±lar");
        
    } else if (currentRoot === "3:0" && selectedStoreTypeId) {
        // Satƒ±cƒ±lardan maƒüaza tiplerine geri d√∂n
        currentRoot = "2:0";
        selectedSellerId = null;
        sellers = [];
        displayMessage("üè™ Maƒüaza tipleri sayfasƒ±na d√∂n√ºld√º");
        speakToUser("Maƒüaza tipleri");
        
    } else {
        // Ana sayfaya d√∂n
        resetToHome();
    }
}
        
function resetToHome() {
    console.log('üè† Ana sayfaya d√∂n√ºl√ºyor');
    
    currentRoot = "2:0";
    selectedStoreTypeId = null;
    selectedSellerId = null;
    selectedCategoryId = null;
    products = [];
    categories = [];
    
    // UI'ƒ± sƒ±fƒ±rla
    document.querySelectorAll('.seller-type-card, .seller-card, .category-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    if (categoriesSection) categoriesSection.style.display = 'none';
    if (productsSection) productsSection.style.display = 'none';
    if (sellersSection) sellersSection.style.display = 'none';
    
    displayMessage("üè† Ana sayfaya d√∂n√ºld√º. Hangi maƒüaza tipinden alƒ±≈üveri≈ü yapmak istersiniz?");
    speakToUser("Ana sayfaya d√∂n√ºld√º");
}

function showHelp() {
    const helpMessage = `
ü§ñ SESLƒ∞ Sƒ∞PARƒ∞≈û Sƒ∞STEMƒ∞ - YARDIM

üè™ MAƒûAZA SE√áƒ∞Mƒ∞: "Market", "Restoran", "Eczane"
üè¨ SATICI SE√áƒ∞Mƒ∞: "Birinci satƒ±cƒ±", "Migros", "≈ûok"
üì¶ REYON SE√áƒ∞Mƒ∞: "Manav", "S√ºt √ºr√ºnleri", "ƒ∞√ßecekler"
üõí √úR√úN EKLEME: "1 kilo domates", "2 paket s√ºt"
üí≥ √ñDEME: "√ñdeme yap", "Nakit √∂de", "Kartla √∂de"
üóëÔ∏è SEPET: "Sepeti bo≈üalt", "Sepetim"
‚Ü©Ô∏è NAVƒ∞GASYON: "Geri git", "Ana sayfa"

Sesli komutlarƒ±nƒ±zƒ± net ve anla≈üƒ±lƒ±r ≈üekilde s√∂yleyin!
    `;
    
    displayMessage(helpMessage);
    speakToUser("Yardƒ±m men√ºs√º a√ßƒ±ldƒ±. Ekrandaki talimatlarƒ± okuyabilirsiniz.");
}

        
// Gereksiz kelimeleri filtreleme
function filterUnnecessaryWords(message) {
    const unnecessary = [
        'l√ºtfen', 'rica', 'ediyorum', 'istiyorum', '√∂rneƒüin', 'mesela',
        '≈üey', 'falan', 'filan', 'gibi', 'yani', 'acaba', 'belki',
        'sanƒ±rƒ±m', 'galiba', 'herhalde', 'tamam', 'peki', 'hƒ±mm'
    ];
    
    let filtered = message;
    unnecessary.forEach(word => {
        const regex = new RegExp(`\\b${word}\\b`, 'gi');
        filtered = filtered.replace(regex, '');
    });
    
    return filtered.replace(/\s+/g, ' ').trim();
}

        
function shouldShowFallback(message) {
    // Sadece belirli aralƒ±klarla fallback g√∂ster
    const now = Date.now();
    const lastFallbackTime = window.lastFallbackTime || 0;
    
    if (now - lastFallbackTime < 5000) { // 5 saniyede bir
        return false;
    }
    
    window.lastFallbackTime = now;
    return true;
}

    function getSmartFallback() {
    const now = Date.now();
    
    // Fallback'ler arasƒ±nda da cooldown
    if (now - lastSpeakTime < SPEAK_COOLDOWN * 2) {
        return null; // Mesaj g√∂sterme
    }

    // ‚úÖ MAƒûAZA SE√áƒ∞Mƒ∞ DURUMU - current:2
    if (currentRoot === "2:0" && selectedStoreTypeId) {
        const sellerCards = document.querySelectorAll('.seller-card');
        if (sellerCards.length > 0) {
            const sellerList = Array.from(sellerCards)
                .slice(0, 3)
                .map(card => `${card.dataset.sellerIndex}. ${card.querySelector('.seller-name')?.textContent}`)
                .join(', ');
            return `Hangi satƒ±cƒ±? ${sellerList} Veya ba≈üka maƒüaza i√ßin maƒüaza ismi s√∂yleyin.`;
        }
        return "Bu maƒüazada satƒ±cƒ± bulunamadƒ±. Ba≈üka maƒüaza se√ßmek i√ßin maƒüaza ismi s√∂yleyin.";
    }
        
    if (!selectedStoreTypeId) {
        const storeCards = document.querySelectorAll('.seller-type-card');
        if (storeCards.length > 0) {
            const storeList = Array.from(storeCards)
                .slice(0, 3)
                .map(card => `${card.dataset.typeIndex}. ${card.querySelector('.seller-type-name')?.textContent}`)
                .join(', ');
            return `Hangi maƒüaza tipi? ${storeList}`;
        }
        return "Maƒüaza tipi se√ßin:...";
    }
    
    if (!selectedSellerId) {
        return "Bir satƒ±cƒ± se√ßin. ƒ∞sim veya numara s√∂yleyin.";
    }
    
    if (!selectedCategoryId) {
        return "Bir reyon se√ßin: Manav, S√ºt √úr√ºnleri...";
    }
    
    if (selectedCategoryId && products.length > 0) {
        const productCards = document.querySelectorAll('.product-card');
        if (productCards.length > 0) {
            const productList = Array.from(productCards)
                .slice(0, 2) // Sadece 2 √ºr√ºn g√∂ster
                .map(card => `${card.dataset.productIndex}. ${card.querySelector('.product-name')?.textContent}`)
                .join(', ');
            return `√úr√ºn se√ßin: ${productList}`;
        }
    }
    
    return "Nasƒ±l yardƒ±mcƒ± olabilirim?";
}
        
// YARDIMCI FONKSƒ∞YONLAR
// Anahtar kelime kontrol fonksiyonlarƒ±
function hasStoreTypeKeywords(message) {
    const keywords = ['market', 'restoran', 'eczane', 'pastane', 'alkol', '√ßi√ßek', '√ßar≈üƒ±', 'maƒüaza', 'tip', 'd√ºkkan'];
    return keywords.some(keyword => message.includes(keyword));
}

function hasSellerKeywords(message) {
    const keywords = ['satƒ±cƒ±', 'yer', 'd√ºkkan', 'market', 'birinci', 'ikinci', '√º√ß√ºnc√º', 'd√∂rd√ºnc√º', 'be≈üinci'];
    return keywords.some(keyword => message.includes(keyword)) || /\d/.test(message);
}

function hasCategoryKeywords(message) {
    const keywords = ['reyon', 'manav', 'kasap', 'fƒ±rƒ±n', '≈üark√ºteri', 'i√ßecek', 's√ºt', 'meyve', 'sebze', 'kategori'];
    return keywords.some(keyword => message.includes(keyword));
}

function hasProductKeywords(message) {
    const keywords = ['kilo', 'gram', 'paket', 'adet', 'tane', 'litre', 'lt', 'yarƒ±m', '√ßeyrek'];
    return keywords.some(keyword => message.includes(keyword)) || 
           /\d+\s*\w+/.test(message);
}

// Akƒ±llƒ± fallback mesajƒ±
function getSmartFallback() {
    const now = Date.now();
    
    // Fallback'ler arasƒ±nda cooldown
    if (now - lastSpeakTime < SPEAK_COOLDOWN * 2) {
        return null;
    }

    // Mevcut duruma g√∂re akƒ±llƒ± mesaj
    if (!selectedStoreTypeId) {
        const storeCards = document.querySelectorAll('.seller-type-card');
        if (storeCards.length > 0) {
            const storeList = Array.from(storeCards)
                .slice(0, 3)
                .map(card => `${card.dataset.typeIndex}. ${card.querySelector('.seller-type-name')?.textContent}`)
                .join(', ');
            return `Hangi maƒüaza tipi? ${storeList}`;
        }
        return "Maƒüaza tipi se√ßin: Market, Restoran, Eczane...";
    }
    
    if (!selectedSellerId) {
        const sellerCards = document.querySelectorAll('.seller-card');
        if (sellerCards.length > 0) {
            const sellerList = Array.from(sellerCards)
                .slice(0, 3)
                .map(card => `${card.dataset.sellerIndex}. ${card.querySelector('.seller-name')?.textContent}`)
                .join(', ');
            return `Hangi satƒ±cƒ±? ${sellerList}`;
        }
        return "Bir satƒ±cƒ± se√ßin. ƒ∞sim veya numara s√∂yleyin.";
    }
    
    if (!selectedCategoryId) {
        const categoryCards = document.querySelectorAll('.category-card');
        if (categoryCards.length > 0) {
            const categoryList = Array.from(categoryCards)
                .slice(0, 3)
                .map(card => `${card.dataset.categoryIndex}. ${card.querySelector('.category-name')?.textContent}`)
                .join(', ');
            return `Hangi reyon? ${categoryList}`;
        }
        return "Bir reyon se√ßin: Manav, S√ºt √úr√ºnleri...";
    }
    
    if (selectedCategoryId && products.length > 0) {
        const productCards = document.querySelectorAll('.product-card');
        if (productCards.length > 0) {
            const productList = Array.from(productCards)
                .slice(0, 2)
                .map(card => `${card.dataset.productIndex}. ${card.querySelector('.product-name')?.textContent}`)
                .join(', ');
            return `√úr√ºn se√ßin: ${productList}`;
        }
    }
    
    return "Nasƒ±l yardƒ±mcƒ± olabilirim? 'Yardƒ±m' diyerek t√ºm komutlarƒ± g√∂rebilirsiniz.";
}
        
function getCurrentStatus() {
    let status = "Mevcut durum: ";
    
    if (!selectedStoreTypeId) {
        status += "Maƒüaza tipi se√ßilmedi. ";
    } else {
        status += `Maƒüaza tipi: ${selectedStoreTypeName}. `;
    }
    
    if (!selectedSellerId) {
        status += "Satƒ±cƒ± se√ßilmedi. ";
    } else {
        const seller = sellers.find(s => s.id === selectedSellerId);
        status += `Satƒ±cƒ±: ${seller?.business_name}. `;
    }
    
    if (!selectedCategoryId) {
        status += "Kategori se√ßilmedi.";
    } else {
        const category = categories.find(c => c.id === selectedCategoryId);
        status += `Kategori: ${category?.name}.`;
    }
    
    return status;
}

// G√úNCELLENMƒ∞≈û getContextualFallback - Daha az tekrarlayan mesaj
function getContextualFallback() {
    // Mevcut durumu kontrol et
    const status = getCurrentStatus();
    
    if (!selectedStoreTypeId) {
        const availableTypes = storeTypes.map(st => st.name).join(', ');
        return `Hangi maƒüaza tipinden alƒ±≈üveri≈ü yapmak istersiniz? ${availableTypes}`;
    }
    
    if (!selectedSellerId) {
        return "L√ºtfen bir satƒ±cƒ± se√ßin. Satƒ±cƒ± ismi veya numarasƒ± s√∂yleyebilirsiniz.";
    }
    
    if (!selectedCategoryId) {
        const categoryList = categories.slice(0, 3).map(c => c.name).join(', ');
        return `Hangi reyondan alƒ±≈üveri≈ü yapmak istersiniz? ${categoryList}`;
    }
    
    // √úr√ºn ekleme a≈üamasƒ±nda √∂rnek verme
    if (products.length > 0) {
        const sampleProducts = products.slice(0, 2).map(p => p.name).join(', ');
        return `√úr√ºn sipari≈üi verebilirsiniz. √ñrneƒüin: "1 kilo ${sampleProducts.split(',')[0]}"`;
    }
    
    return "Nasƒ±l yardƒ±mcƒ± olabilirim?";
}

// Basit durum mesajƒ±
function getCurrentStatus() {
    let status = [];
    if (selectedStoreTypeId) status.push(`Maƒüaza: ${selectedStoreTypeName}`);
    if (selectedSellerId) {
        const seller = sellers.find(s => s.id === selectedSellerId);
        if (seller) status.push(`Satƒ±cƒ±: ${seller.business_name}`);
    }
    if (selectedCategoryId) {
        const category = categories.find(c => c.id === selectedCategoryId);
        if (category) status.push(`Reyon: ${category.name}`);
    }
    return status.join(' | ');
}


        
// Yardƒ±mcƒ± fonksiyonlar
function hasProductKeywords(message) {
    const keywords = ['kilo', 'gram', 'paket', 'adet', 'tane', 'litre', 'lt', 'yarƒ±m', '√ßeyrek'];
    return keywords.some(keyword => message.includes(keyword)) || 
           /\d+\s*\w+/.test(message); // Sayƒ± + kelime pattern'i
}
        
// Ekranda detaylƒ± mesaj g√∂sterme fonksiyonu
function displayMessage(msg) {
    // Mevcut assistantMessage elementini kullan
    if (assistantMessage) {
        assistantMessage.textContent = msg;
        
        // Mesaj stilini ayarla (ba≈üarƒ±/ba≈üarƒ±sƒ±zlƒ±k)
        if (msg.includes('‚úÖ') || msg.includes('Eklendi')) {
            assistantMessage.style.background = 'rgba(40, 167, 69, 0.1)';
            assistantMessage.style.color = 'var(--success)';
            assistantMessage.style.borderLeft = '4px solid var(--success)';
        } else if (msg.includes('‚ùå') || msg.includes('Hata')) {
            assistantMessage.style.background = 'rgba(220, 53, 69, 0.1)';
            assistantMessage.style.color = 'var(--danger)';
            assistantMessage.style.borderLeft = '4px solid var(--danger)';
        } else {
            assistantMessage.style.background = 'rgba(93, 62, 188, 0.1)';
            assistantMessage.style.color = 'var(--dark)';
            assistantMessage.style.borderLeft = '4px solid var(--primary)';
        }
    }
    
    // Ayrƒ±ca console'da da g√∂ster
    console.log('üì± Display Message:', msg);
}

// üõí Sepet kontrol
function cartHasItems() {
    return cart && cart.length > 0;
}

// Sepet temizleme komutlarƒ±nƒ± tespit et
function isClearCartCommand(message) {
    const clearCommands = [
        'sepeti bo≈üalt', 'sepeti temizle', 'her ≈üeyi sil', 'sƒ±fƒ±rla',
        'clear cart', 'empty cart', 'reset cart', 'temizle'
    ];
    
    return clearCommands.some(cmd => message.includes(cmd));
}

// Maƒüaza deƒüi≈ütirme komutlarƒ±nƒ± tespit et
function isStoreChangeCommand(message) {
    const changeCommands = [
        'market', 'restoran', 'eczane', 'pastane', 'alkol', '√ßi√ßek', '√ßar≈üƒ±', 'fƒ±rƒ±n', 'kafe',
        'maƒüaza', 'd√ºkkan', 'satƒ±cƒ±', 'yer',
        'deƒüi≈ütir', 'ba≈üka', 'diƒüer', 'farklƒ±', 'yeni',
        'birinci', 'ikinci', '√º√ß√ºnc√º', 'd√∂rd√ºnc√º', 'be≈üinci', 'altƒ±ncƒ±', 'yedinci',
        '1.', '2.', '3.', '4.', '5.', '6.', '7.', '1 ', '2 ', '3 ', '4 ', '5 ', '6 ', '7 '
    ];
    
    return changeCommands.some(cmd => message.includes(cmd));
}

// G√úNCELLENMƒ∞≈û handleContextualCommand - Store Type kontrol√º ekle
// GELƒ∞≈ûTƒ∞Rƒ∞LMƒ∞≈û handleContextualCommand - Detaylƒ± Debug
async function handleContextualCommand(message) {
    console.log(`üîç Baƒülamsal komut kontrol√º: "${message}"`);
    
    // Kontroller
    if (!selectedStoreTypeId) {
        speakToUser("√ñnce bir maƒüaza tipi se√ßmelisiniz.");
        return false;
    }
    
    if (!selectedSellerId) {
        speakToUser("L√ºtfen bir satƒ±cƒ± se√ßin.");
        return false;
    }
    
    if (!selectedCategoryId || products.length === 0) {
        speakToUser("√ñnce bir kategori se√ßmelisiniz.");
        return false;
    }
    
    try {
        console.log('üì¶ √úr√ºn bilgisi √ßƒ±karƒ±lƒ±yor...');
        const productInfo = await extractProductInfoFromCommand(message);
        
        if (!productInfo || !productInfo.productName) {
            console.log('‚ùå √úr√ºn bilgisi √ßƒ±karƒ±lamadƒ±');
            // HATA AYIKLAMA: Neden √ßƒ±karƒ±lamadƒ±?
            console.log('üí° HATA NEDENLERƒ∞:');
            console.log('   - "√∂rneƒüin" kelimesi var mƒ±?', message.includes('√∂rneƒüin'));
            console.log('   - Temiz mesaj:', message.toLowerCase().replace(/√∂rneƒüin/g, '').trim());
            console.log('   - Mevcut √ºr√ºnler:', products.map(p => p.name));
            return false;
        }

        console.log('‚úÖ √áƒ±karƒ±lan √ºr√ºn bilgisi:', productInfo);
        console.log('üîç √úr√ºn aranƒ±yor:', productInfo.productName);

        const product = findProductByName(productInfo.productName);
        
        if (product) {
            console.log('üéØ √úr√ºn bulundu:', product.name);
            
            // Kilit kontrol√º
            if (isSellerLocked) {
                const firstCartItem = cart[0];
                if (firstCartItem && firstCartItem.seller_id !== selectedSellerId) {
                    const currentSeller = sellers.find(s => s.id === firstCartItem.seller_id);
                    speakToUser(`Sepet dolu. Sadece ${currentSeller?.business_name} ile alƒ±≈üveri≈üe devam edebilirsiniz.`);
                    return true;
                }
            }
            
            // SEPETE EKLE
            console.log('üõí Sepete ekleniyor:', `${productInfo.quantity} ${productInfo.unit} ${product.name}`);
            addToCart(product, productInfo.quantity);
            speakToUser(`${productInfo.quantity} ${productInfo.unit} ${product.name} sepete eklendi.`);
            
            return true;
        } else {
            console.log('‚ùå √úr√ºn bulunamadƒ±:', productInfo.productName);
            console.log('üí° Mevcut √ºr√ºnler:', products.map(p => p.name));
            handleDynamicProductNotFound(message, productInfo.productName);
            return true;
        }
    } catch (error) {
        console.error('‚ùå Baƒülamsal komut hatasƒ±:', error);
        return false;
    }
}
        
// ACƒ∞L TEST FONKSƒ∞YONU - Hemen √ßalƒ±≈ütƒ±rƒ±n!
function emergencyTest() {
    console.log('üö® ACƒ∞L TEST BA≈ûLIYOR...');
    
    const testCases = [
        "1 kilo domates",
        "√∂rneƒüin 1 kilo domates", 
        "2 paket s√ºt",
        "bir kilo soƒüan",
        "domates",
        "√∂rneƒüin domates",
        "3 kilo √ßarliston biber",
        "yarƒ±m kilo peynir"
    ];
    
    testCases.forEach((testCase, index) => {
        console.log(`\n--- TEST ${index + 1}: "${testCase}" ---`);
        
        const result = extractProductInfoFromCommand(testCase);
        console.log('üì¶ SONU√á:', result);
        
        if (result && products.length > 0) {
            const found = findProductByName(result.productName);
            console.log('üîç BULUNDU MU?:', found ? `EVET - ${found.name}` : 'HAYIR');
            
            if (found) {
                console.log('üõí SEPETE EKLENEBƒ∞Lƒ∞R:', `${result.quantity} ${result.unit} ${found.name}`);
            }
        }
    });
    
    console.log('\nüéØ TEST TAMAMLANDI');
}

// HEMEN √áALI≈ûTIR: Console'da ≈üunu yazƒ±n:
// emergencyTest()

// ACƒ∞L MANUEL √á√ñZ√úM - Hemen test edin
function manualProductAddTest() {
    console.log('üõ†Ô∏è MANUEL √úR√úN EKLEME TESTƒ∞');
    
    if (products.length === 0) {
        console.log('‚ùå √úr√ºn listesi bo≈ü');
        return;
    }
    
    console.log('üì¶ Mevcut √ºr√ºnler:', products.map(p => p.name));
    
    // Manuel olarak "domates" √ºr√ºn√ºn√º bul ve sepete ekle
    const product = findProductByName("domates");
    
    if (product) {
        console.log('‚úÖ Domates bulundu, sepete ekleniyor...');
        addToCart(product, 1);
        console.log('üéâ Domates sepete eklendi!');
        speakToUser("1 adet domates sepete eklendi.");
    } else {
        console.log('‚ùå Domates bulunamadƒ±');
    }
}

// HEMEN √áALI≈ûTIR: Console'da ≈üunu yazƒ±n:
// manualProductAddTest()

// FALLBACK: Eƒüer hala √ßalƒ±≈ümazsa bu fonksiyonu kullanƒ±n
function superSimpleExtract(message) {
    console.log('üîÑ S√úPER BASƒ∞T √á√ñZ√úM:', message);
    
    // Sadece sayƒ±larƒ± ve √ºr√ºn adƒ±nƒ± ayƒ±r
    const numberMatch = message.match(/\d+/);
    const quantity = numberMatch ? parseInt(numberMatch[0]) : 1;
    
    // √úr√ºn adƒ±nƒ± bul (sayƒ±larƒ± ve birimleri temizle)
    let productName = message
        .replace(/\d+/g, '')
        .replace(/kilo|kg|paket|adet|tane|litre|lt|yarƒ±m|√ßeyrek|√∂rneƒüin|mesela/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    
    // Temel d√ºzeltmeler
    const fixes = {
        'domat': 'domates', 'sogan': 'soƒüan', 'salatalik': 'salatalƒ±k',
        'patat': 'patates', 'carliston': '√ßarliston biber', 'viber': '√ßarliston biber'
    };
    
    for (const [wrong, correct] of Object.entries(fixes)) {
        if (productName.includes(wrong)) {
            productName = productName.replace(wrong, correct);
        }
    }
    
    console.log('üéØ S√úPER BASƒ∞T SONU√á:', { productName, quantity, unit: 'adet' });
    return { productName, quantity, unit: 'adet' };
}

 function clearCart() {
    console.log('üóëÔ∏è Sepet tamamen bo≈üaltƒ±lƒ±yor...');
    console.log('üìä √ñnceki sepet:', cart.length, '√ºr√ºn');
    
    cart = [];
    updateCartUI();
    showClearCartNotification();
    unlockStoreAndSeller();
    speakToUser("Sepet bo≈üaltƒ±ldƒ±. Artƒ±k ba≈üka maƒüazalardan alƒ±≈üveri≈ü yapabilirsiniz.");
    closeDynamicCart();
    console.log('‚úÖ Sepet tamamen bo≈üaltƒ±ldƒ±');     
}

        let notificationTimeout = null;

function updateVoiceNotification(message, type = 'info', autoReset = true, resetDelay = 3000) {
    const notification = document.getElementById('voiceCommandNotification');
    if (!notification) return;
    
    // ‚≠ê √ñNCEKƒ∞ ZAMANLAYICIYI TEMƒ∞ZLE
    if (notificationTimeout) {
        clearTimeout(notificationTimeout);
        notificationTimeout = null;
    }
    
    const notificationText = notification.querySelector('.voice-notification-text');
    const icon = notification.querySelector('i');
    
    if (notificationText) {
        notificationText.textContent = message;
    }
    
    // Stil g√ºncelleme
    const types = {
        info: { 
            bg: 'linear-gradient(135deg, #fff3cd, #ffeb3b)', 
            color: '#856404', 
            border: '#ffc107',
            icon: 'fas fa-microphone'
        },
        success: { 
            bg: 'linear-gradient(135deg, #d4edda, #28a745)', 
            color: '#155724', 
            border: '#28a745',
            icon: 'fas fa-check-circle'
        },
        error: { 
            bg: 'linear-gradient(135deg, #f8d7da, #dc3545)', 
            color: '#721c24', 
            border: '#dc3545',
            icon: 'fas fa-exclamation-circle'
        },
        listening: { 
            bg: 'linear-gradient(135deg, #cce7ff, #007bff)', 
            color: '#004085', 
            border: '#007bff',
            icon: 'fas fa-microphone-alt'
        }
    };
    
    const style = types[type] || types.info;
    const notificationContent = notification.querySelector('.voice-notification-content');
    
    if (notificationContent) {
        notificationContent.style.background = style.bg;
        notificationContent.style.color = style.color;
        notificationContent.style.borderColor = style.border;
    }
    
    if (icon) {
        icon.className = style.icon;
    }
    
    // ‚≠ê OTOMATƒ∞K GERƒ∞ D√ñN√ú≈û
    if (autoReset && type !== 'info') {
        notificationTimeout = setTimeout(() => {
            updateVoiceNotification('"Sepeti bo≈üalt" veya "Sipari≈ü ver" diyebilirsiniz', 'info', false);
        }, resetDelay);
    }
}


// ‚≠ê BASƒ∞TLE≈ûTƒ∞Rƒ∞LMƒ∞≈û Bƒ∞LDƒ∞Rƒ∞M FONKSƒ∞YONLARI
function showClearCartNotification() {
    updateVoiceNotification('üóëÔ∏è Sepet ba≈üarƒ±yla bo≈üaltƒ±ldƒ±!', 'success', true, 3000);
}
        
function showListeningNotification() {
    updateVoiceNotification('üé§ Dinliyorum... Konu≈üun!', 'listening', true, 5000);
}

function showCommandReceivedNotification(command) {
    updateVoiceNotification(`‚úÖ "${command}"`, 'success', true, 2000);
}
        

function showErrorNotification() {
    updateVoiceNotification('‚ùå Ses anla≈üƒ±lamadƒ±, l√ºtfen tekrar deneyin', 'error', true, 2000);
}

        

// ‚≠ê initSliderControls FONKSƒ∞YONU AYRI Bƒ∞R FONKSƒ∞YON OLARAK TANIMLANDI
function initSliderControls() {
    const slider = document.getElementById('commandSlider');
    if (!slider) return;
    
    const prevBtn = slider.querySelector('.prev-btn');
    const nextBtn = slider.querySelector('.next-btn');
    const groups = slider.querySelectorAll('.slider-example-group');
    
    let currentGroup = 0;
    
    function showGroup(index) {
        groups.forEach((group, i) => {
            group.classList.toggle('active', i === index);
        });
        currentGroup = index;
    }
    
    prevBtn.addEventListener('click', () => {
        let newIndex = currentGroup - 1;
        if (newIndex < 0) newIndex = groups.length - 1;
        showGroup(newIndex);
    });
    
    nextBtn.addEventListener('click', () => {
        let newIndex = currentGroup + 1;
        if (newIndex >= groups.length) newIndex = 0;
        showGroup(newIndex);
    });
    
    // Otomatik slider (opsiyonel)
    setInterval(() => {
        let newIndex = currentGroup + 1;
        if (newIndex >= groups.length) newIndex = 0;
        showGroup(newIndex);
    }, 5000);
}

        
// Sepet UI'sƒ±na temizleme butonu ekle
function addClearCartButton() {
    const cartItems = document.getElementById('cartItems');
    if (!cartItems) return;
    
    // Temizleme butonu yoksa ekle
    if (!document.getElementById('clearCartBtn') && cart.length > 0) {
        const clearBtn = document.createElement('button');
        clearBtn.id = 'clearCartBtn';
        clearBtn.innerHTML = '<i class="fas fa-trash"></i> Sepeti Bo≈üalt';
        clearBtn.style.cssText = `
            width: 100%;
            padding: 12px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            margin-top: 10px;
            cursor: pointer;
            font-weight: 600;
        `;
        
        clearBtn.addEventListener('click', function() {
            if (confirm('Sepeti tamamen bo≈üaltmak istediƒüinizden emin misiniz?')) {
                clearCart();
            }
        });
        
        cartItems.parentNode.insertBefore(clearBtn, cartItems.nextSibling);
    }
    
    // Sepet bo≈üsa butonu kaldƒ±r
    if (document.getElementById('clearCartBtn') && cart.length === 0) {
        document.getElementById('clearCartBtn').remove();
    }
}


        // Kategori ismine g√∂re bulma
function findCategoryByName(categoryName) {
    const cleanName = categoryName.toLowerCase().trim();
    
    // Tam e≈üle≈üme
    let category = categories.find(cat => 
        cat.name.toLowerCase() === cleanName
    );
    
    if (category) return category;
    
    // Kƒ±smi e≈üle≈üme
    category = categories.find(cat => 
        cat.name.toLowerCase().includes(cleanName) ||
        cleanName.includes(cat.name.toLowerCase())
    );
    
    if (category) return category;
    
    // Anahtar kelime e≈üle≈ümesi
    const keywordMap = {
        'meyve': 'Manav',
        'sebze': 'Manav', 
        'manav': 'Manav',
        's√ºt': 'S√ºt √úr√ºnleri',
        'peynir': 'S√ºt √úr√ºnleri',
        'yoƒüurt': 'S√ºt √úr√ºnleri',
        'et': 'Kasap',
        'tavuk': 'Kasap',
        'balƒ±k': 'Balƒ±k',
        'i√ßecek': 'ƒ∞√ßecekler',
        'su': 'ƒ∞√ßecekler',
        'me≈ürubat': 'ƒ∞√ßecekler'
    };
    
    for (const [keyword, categoryName] of Object.entries(keywordMap)) {
        if (cleanName.includes(keyword)) {
            return categories.find(cat => cat.name === categoryName);
        }
    }
    
    return null;
}

// Satƒ±cƒ±yƒ± komuta g√∂re bulma
function findSellerByCommand(message) {
    const cleanMessage = message.toLowerCase().trim();
    
    // Sayƒ±sal se√ßim (birinci, ikinci, 1., 2. vb.)
    const numberMatch = cleanMessage.match(/(birinci|ikinci|√º√ß√ºnc√º|d√∂rd√ºnc√º|1\.|2\.|3\.|4\.|1|2|3|4)/);
    if (numberMatch) {
        const numbers = {
            'birinci': 0, '1.': 0, '1': 0,
            'ikinci': 1, '2.': 1, '2': 1, 
            '√º√ß√ºnc√º': 2, '3.': 2, '3': 2,
            'd√∂rd√ºnc√º': 3, '4.': 3, '4': 3
        };
        const index = numbers[numberMatch[0]];
        if (index < sellers.length) {
            return sellers[index];
        }
    }
    
    // ƒ∞simle arama
    for (const seller of sellers) {
        if (cleanMessage.includes(seller.business_name.toLowerCase())) {
            return seller;
        }
    }
    
    return null;
}
        
// Dinamik kural e≈üle≈ütirme
async function findDynamicRuleMatch(message, root) {
    const rules = commandRules.get(root) || [];
    
    for (const rule of rules) {
        const patterns = rule.input_patterns.split('|');
        for (const pattern of patterns) {
            const matchResult = matchesDynamicPattern(message, pattern);
            if (matchResult.matches) {
                return { 
                    rule, 
                    pattern, 
                    extractedData: matchResult.extractedData 
                };
            }
        }
    }
    return null;
}

// Dinamik pattern e≈üle≈ütirme
function matchesDynamicPattern(message, pattern) {
    const result = { matches: false, extractedData: {} };
    
    if (pattern.startsWith('regex:')) {
        const regexPattern = pattern.replace('regex:', '');
        const regex = new RegExp(regexPattern, 'i');
        const match = message.match(regex);
        
        if (match) {
            result.matches = true;
            if (match.groups) {
                result.extractedData = match.groups;
            }
        }
    } else if (message.includes(pattern)) {
        result.matches = true;
        result.extractedData = { text: pattern };
    }
    
    return result;
}

// E≈üle≈üen kuralƒ± √ßalƒ±≈ütƒ±r
async function executeDynamicMatchedRule(match, message) {
    const { rule, extractedData } = match;
    
    // Dinamik √ßƒ±ktƒ± hazƒ±rla
    let output = rule.output_text;
    for (const [key, value] of Object.entries(extractedData)) {
        output = output.replace(`{${key}}`, value);
    }
    
    // Sesli cevap ver
    speakToUser(output);
    
    // Dinamik aksiyonu √ßalƒ±≈ütƒ±r
    if (rule.action_name) {
        await executeDynamicAction(rule.action_name, { 
            extractedData, 
            message 
        });
    }
    
    // K√∂k ge√ßi≈üini y√∂net
    if (rule.next_root) {
        if (rule.next_root.includes('?')) {
            pendingResponse = { nextRoot: rule.next_root, context: extractedData };
        } else {
            currentRoot = rule.next_root;
        }
    }
}

// =============================================
// Dƒ∞NAMƒ∞K AKSƒ∞YON FONKSƒ∞YONLARI
// =============================================

async function executeDynamicAction(actionName, data) {
    console.log(`‚ö° Dinamik Aksiyon: ${actionName}`, data);
    
    try {
        switch(actionName) {
            // KONUM AKSƒ∞YONLARI
            case 'show_location_modal':
                showDynamicLocationModal();
                break;
                
            case 'select_location':
                await handleDynamicLocationSelection(data);
                break;
                
            // MAƒûAZA Tƒ∞Pƒ∞ AKSƒ∞YONLARI
            case 'select_store_type':
                await handleDynamicStoreTypeSelection(data);
                break;
                
            // SATICI AKSƒ∞YONLARI
            case 'select_seller':
                await handleDynamicSellerSelection(data);
                break;
                
            // REYON AKSƒ∞YONLARI
            case 'select_category':
                await handleDynamicCategorySelection(data);
                break;
                
            // √úR√úN AKSƒ∞YONLARI
            case 'add_to_cart':
                await handleDynamicAddToCart(data);
                break;
                
            // SEPET AKSƒ∞YONLARI
            case 'manage_cart':
                await handleDynamicCartManagement(data);
                break;
                
            // √ñDEME AKSƒ∞YONLARI
            case 'select_payment':
                await handleDynamicPaymentSelection(data);
                break;
                
            // Sƒ∞STEM AKSƒ∞YONLARI
            case 'navigate_back':
                await handleDynamicNavigation(data);
                break;
                
            case 'show_help':
                await handleDynamicHelp(data);
                break;
                
            default:
                await handleUnknownDynamicAction(actionName, data);
        }
    } catch (error) {
        console.error(`Dinamik aksiyon hatasƒ± (${actionName}):`, error);
        speakToUser("√úzg√ºn√ºm, bir hata olu≈ütu. L√ºtfen tekrar deneyin.");
    }
}

// =============================================
// Dƒ∞NAMƒ∞K KONUM Sƒ∞STEMƒ∞
// =============================================

function showDynamicLocationModal() {
    const modal = document.getElementById('locationModal');
    if (!modal) return;

    document.body.classList.add('modal-open');
    modal.style.display = 'flex';
    modal.style.zIndex = '10000';
    
    updateDynamicLocationModal();
    setupDynamicModalCloseEvents();
    
    debugLog('üìç Dinamik konum modalƒ± g√∂sterildi');
    speakToUser("L√ºtfen konumunuzu se√ßin: restoran i√ßi, paket servis veya adrese teslim.");
}

function updateDynamicLocationModal() {
    const locationModal = document.getElementById('locationModal');
    if (!locationModal) return;
    
    locationModal.querySelector('.modal-body').innerHTML = `
        <div class="modal-header">
            <h3>Konum Se√ßiniz</h3>
            <span class="close-modal" id="closeLocationModal">&times;</span>
        </div>
        <p>Sipari≈üiniz i√ßin l√ºtfen konumunuzu belirleyin:</p>
        
        <div class="location-options">
            <div class="location-option" data-location="inside">
                <div class="location-icon">
                    <i class="fas fa-utensils"></i>
                </div>
                <div class="location-details">
                    <h4>Restoran i√ßinde</h4>
                    <p>Yemeƒüinizi restoranda yiyin</p>
                </div>
            </div>
            
            <div class="location-option" data-location="takeaway">
                <div class="location-icon">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <div class="location-details">
                    <h4>Paket servis</h4>
                    <p>Yemeƒüinizi kendiniz alƒ±n</p>
                </div>
            </div>
            
            <div class="location-option" data-location="delivery">
                <div class="location-icon">
                    <i class="fas fa-motorcycle"></i>
                </div>
                <div class="location-details">
                    <h4>Adrese teslim</h4>
                    <p>Yemeƒüiniz adresinize gelsin</p>
                </div>
            </div>
        </div>

        <button id="detectLocationBtn" class="location-detect-btn">
            <i class="fas fa-location-arrow"></i>
            Konumumu Otomatik Belirle
        </button>
        
        <div id="locationResult" class="location-result" style="display: none;"></div>
    `;
    
    setupDynamicLocationOptionEvents();
}

async function handleDynamicLocationSelection(data) {
    const locationType = data.extractedData?.location;
    
    if (!locationType) {
        speakToUser("Konum tipi belirtilmedi. L√ºtfen restoran i√ßi, paket servis veya adrese teslim se√ßin.");
        return;
    }
    
    // Adrese teslim i√ßin konum tespiti gerekli
    if (locationType === 'delivery' && !isLocationDetected) {
        const success = await detectUserLocation();
        if (!success) {
            speakToUser("Adrese teslim i√ßin konumunuzu tespit edemiyorum. L√ºtfen manuel olarak konumunuzu belirleyin.");
            return;
        }
    }
    
    selectDynamicLocation(locationType);
}

// Konum se√ßildiƒüinde doƒüru akƒ±≈üƒ± ba≈ülat
function selectDynamicLocation(locationType) {
    selectedLocation = locationType;
    localStorage.setItem('selectedLocation', locationType);
    
    if (userLocation) {
        localStorage.setItem('userLocation', JSON.stringify(userLocation));
    }
    
    updateDynamicLocationText();
    hideDynamicLocationModal();
    
    // DOƒûRU K√ñK BA≈ûLANGICI - Store Type se√ßimine y√∂nlendir
    currentRoot = "2:0";
    
    // Konum se√ßildiƒüinde t√ºm satƒ±cƒ±larƒ± y√ºkle ama store type se√ßimini bekle
    loadAllSellersByLocation();
    
    const locationNames = {
        'inside': 'Restoran i√ßinde',
        'takeaway': 'Paket servis', 
        'delivery': 'Adrese teslim'
    };
    
    let locationMessage = `${locationNames[locationType]} se√ßildi.`;
    if (locationType === 'delivery' && userLocation.city) {
        locationMessage += ` Konumunuz: ${userLocation.district}, ${userLocation.city}.`;
    }
    
    locationMessage += " Hangi maƒüaza tipinden alƒ±≈üveri≈ü yapmak istersiniz?";
    
    speakToUser(locationMessage);
}
// =============================================
// Dƒ∞NAMƒ∞K MAƒûAZA Tƒ∞Pƒ∞ Sƒ∞STEMƒ∞
// =============================================

async function handleDynamicStoreTypeSelection(data) {
    const storeTypeName = data.extractedData?.storeType || await extractStoreTypeFromMessage(data.message);
    
    if (!storeTypeName) {
        const availableStoreTypes = await getAvailableStoreTypes();
        speakToUser(`Hangi maƒüaza tipini se√ßmek istiyorsunuz? ${availableStoreTypes}`);
        return;
    }
    
    const storeType = await findStoreTypeByName(storeTypeName);
    if (storeType) {
        await onStoreTypeSelected(storeType.id, storeType.name);
    } else {
        const availableStoreTypes = await getAvailableStoreTypes();
        speakToUser(`"${storeTypeName}" bulunamadƒ±. Mevcut maƒüaza tipleri: ${availableStoreTypes}`);
    }
}

// Store Type se√ßildiƒüinde otomatik satƒ±cƒ± se√ßimini engelle
// =============================================
// MAƒûAZA Tƒ∞Pƒ∞NE G√ñRE Fƒ∞LTRELE
// =============================================

async function onStoreTypeSelected(storeTypeId, storeTypeName) {
    // Kilit kontrol√º
    if (isSellerLocked) {
        const currentSeller = sellers.find(s => s.id === selectedSellerId);
        speakToUser(`Sepet dolu. Sadece ${currentSeller?.business_name || 'mevcut maƒüaza'} ile alƒ±≈üveri≈üe devam edebilirsiniz.`);
        return;
    }
    
    debugLog("üõçÔ∏è Store type se√ßildi:", storeTypeName, "ID:", storeTypeId);
   
    selectedStoreTypeId = storeTypeId;
    selectedStoreTypeName = storeTypeName;
    
    // Se√ßilen maƒüaza tipine g√∂re satƒ±cƒ±larƒ± filtrele
    filterSellersByStoreType(storeTypeId);
    
    // Kategori ve √ºr√ºnleri temizle - yeni se√ßim i√ßin
    selectedSellerId = null;
    selectedCategoryId = null;
    products = [];
    resetProductAndCategoryUI();
    
    // K√∂k√º g√ºncelle
    currentRoot = "2:0";
    debugLog(`üîÑ K√∂k SABƒ∞T: 2:0 (Store type se√ßildi: ${storeTypeName})`);
    
    // Filtrelenmi≈ü satƒ±cƒ± sayƒ±sƒ±nƒ± g√∂ster
    const filteredCount = filteredSellersByStoreType.length;
    displayMessage(`${storeTypeName} se√ßildi. ${filteredCount} satƒ±cƒ± bulundu. L√ºtfen bir satƒ±cƒ± se√ßin.`);
    speakToUser(`Maƒüaza se√ßildi. ${filteredCount} satƒ±cƒ± bulundu. L√ºtfen bir satƒ±cƒ± se√ßin.`);
}
        
// Sesli maƒüaza tipi se√ßimi
async function handleVoiceStoreSelection(message) {
    console.log('üè™ Sesli maƒüaza tipi se√ßimi:', message);
    
    const storeCards = document.querySelectorAll('.seller-type-card');
    if (!storeCards.length) {
        displayMessage("‚ùå Maƒüaza listesi y√ºkleniyor, l√ºtfen bekleyin.");
        speakToUser("maƒüaza se√ßin");
        return false;
    }

    const storeInfo = extractStoreInfoFromCommand(message);
    if (!storeInfo) {
        const availableStores = Array.from(storeCards)
            .slice(0, 5)
            .map(card => `${card.dataset.typeIndex}. ${card.querySelector('.seller-type-name')?.textContent}`)
            .filter(name => name)
            .join(', ');
        
        displayMessage(`‚ùå Maƒüaza anla≈üƒ±lamadƒ±. Mevcut maƒüazalar: ${availableStores}`);
        speakToUser("maƒüaza se√ßin");
        return false;
    }

    console.log('üì¶ √áƒ±karƒ±lan maƒüaza bilgisi:', storeInfo);

    let selectedCard = null;

    // "T√ºm√º" se√ßeneƒüi
    if (storeInfo.type === 'name' && (storeInfo.storeName.includes('t√ºm') || storeInfo.storeName.includes('hepsi'))) {
        selectedCard = document.querySelector('.seller-type-card[data-type-id="all"]');
    }
    
    // NUMARA ƒ∞LE ARAMA
    if (!selectedCard && storeInfo.type === 'number' && storeInfo.storeNumber) {
        selectedCard = Array.from(storeCards).find(card => 
            parseInt(card.dataset.typeIndex) === storeInfo.storeNumber
        );
    }

    // ƒ∞Sƒ∞M ƒ∞LE ARAMA
    if (!selectedCard && storeInfo.type === 'name' && storeInfo.storeName) {
        const searchName = storeInfo.storeName.toLowerCase();
        
        // Tam e≈üle≈üme
        selectedCard = Array.from(storeCards).find(card => {
            const cardName = card.querySelector('.seller-type-name')?.textContent.toLowerCase();
            return cardName === searchName;
        });

        // ƒ∞√ßerme e≈üle≈ümesi
        if (!selectedCard) {
            selectedCard = Array.from(storeCards).find(card => {
                const cardName = card.querySelector('.seller-type-name')?.textContent.toLowerCase();
                return cardName.includes(searchName) || searchName.includes(cardName);
            });
        }

        // Anahtar kelime e≈üle≈ümesi
        if (!selectedCard) {
            const keywordMap = {
                'market': 'Market',
                'restoran': 'Restoran', 
                'pastane': 'Pastane',
                'eczane': 'Eczane',
                'kafe': 'Kafe',
                'alkol': 'Alkol',
                '√ßi√ßek': '√ái√ßek',
                '√ßar≈üƒ±': '√áar≈üƒ±'
            };

            for (const [keyword, storeType] of Object.entries(keywordMap)) {
                if (searchName.includes(keyword)) {
                    selectedCard = Array.from(storeCards).find(card => 
                        card.querySelector('.seller-type-name')?.textContent === storeType
                    );
                    if (selectedCard) break;
                }
            }
        }
    }

    if (selectedCard) {
        try {
            selectedCard.click();
            
            const storeTypeName = selectedCard.querySelector('.seller-type-name')?.textContent || 'Maƒüaza';
            const storeNumber = selectedCard.dataset.typeIndex;
            
            displayMessage(`‚úÖ ${storeNumber}. ${storeTypeName} filtresi uygulandƒ±. ≈ûimdi bir satƒ±cƒ± se√ßin.`);
            speakToUser("filtre uygulandƒ±");
            
            return true;
            
        } catch (error) {
            console.error('‚ùå Maƒüaza tipi se√ßim hatasƒ±:', error);
            displayMessage("‚ùå Maƒüaza filtresi uygulanamadƒ±.");
            speakToUser("hata");
            return false;
        }
    }

    // Bulunamadƒ±ysa
    const availableStores = Array.from(storeCards)
        .slice(0, 8)
        .map(card => `${card.dataset.typeIndex}. ${card.querySelector('.seller-type-name')?.textContent}`)
        .filter(name => name)
        .join(', ');
    
    displayMessage(`‚ùå "${message}" maƒüazasƒ± bulunamadƒ±. Mevcut maƒüazalar: ${availableStores}`);
    speakToUser("maƒüaza se√ßin");
    return false;
}       

async function handleVoiceProductAdd(message) {
    console.log('üéØ Sesli √ºr√ºn ekleme:', message);
    
    // Kontroller
    if (!selectedStoreTypeId) {
        displayMessage("‚ùå √ñnce bir maƒüaza tipi se√ßmelisiniz.");
        speakToUser("maƒüaza se√ßin");
        return false;
    }
    
    if (!selectedSellerId) {
        displayMessage("‚ùå L√ºtfen bir satƒ±cƒ± se√ßin.");
        speakToUser("satƒ±cƒ± se√ßin");
        return false;
    }
    
    if (!selectedCategoryId || products.length === 0) {
        displayMessage("‚ùå √ñnce bir kategori se√ßmelisiniz.");
        speakToUser("reyon se√ßin");
        return false;
    }
    
    try {
        const productInfo = extractProductInfoFromCommand(message);
        
        if (!productInfo) {
            displayMessage("‚ùå √úr√ºn ismini anlayamadƒ±m.");
            speakToUser("√ºr√ºn se√ßin");
            return false;
        }

        const { productName, quantity, unit } = productInfo;
        console.log('üîç Aranan √ºr√ºn:', productName);

        // √ñZEL: "X numara" pattern'i i√ßin √ºr√ºn bulma
        let selectedProduct = null;

        // "X numara" pattern'i i√ßin √∂zel kontrol
        const numaraMatch = productName.match(/^(\d+)\s*numara$/);
        if (numaraMatch) {
            const targetNumber = parseInt(numaraMatch[1]);
            console.log(`üî¢ Numara ile √ºr√ºn aranƒ±yor: ${targetNumber}. √ºr√ºn`);
            
            // Sayƒ±sal se√ßim - DOM'dan √ºr√ºn√º bul
            const productCard = document.querySelector(`.product-card[data-product-index="${targetNumber}"]`);
            if (productCard) {
                const productId = productCard.dataset.productId;
                selectedProduct = products.find(p => p.id === productId);
                if (selectedProduct) {
                    console.log(`‚úÖ Numara ile √ºr√ºn bulundu: ${selectedProduct.name}`);
                }
            }
        }

        // Eƒüer numara ile bulunamadƒ±ysa, normal arama yap
        if (!selectedProduct) {
            // 1. √ñnce tam e≈üle≈üme
            selectedProduct = products.find(p => 
                p.name.toLowerCase() === productName.toLowerCase()
            );

            // 2. ƒ∞√ßerme e≈üle≈ümesi
            if (!selectedProduct) {
                selectedProduct = products.find(p => 
                    p.name.toLowerCase().includes(productName.toLowerCase()) ||
                    productName.toLowerCase().includes(p.name.toLowerCase())
                );
            }

            // 3. Kelime e≈üle≈ümesi
            if (!selectedProduct) {
                const searchWords = productName.toLowerCase().split(' ').filter(word => word.length > 2);
                selectedProduct = products.find(product => {
                    const productWords = product.name.toLowerCase().split(' ');
                    return searchWords.some(searchWord => 
                        productWords.some(pWord => pWord.includes(searchWord))
                    );
                });
            }
        }

        // SONU√á
        if (selectedProduct) {
            console.log('üéØ √úr√ºn bulundu:', selectedProduct.name);
            
            // Kilit kontrol√º
            if (isSellerLocked) {
                const firstCartItem = cart[0];
                if (firstCartItem && firstCartItem.seller_id !== selectedSellerId) {
                    const currentSeller = sellers.find(s => s.id === firstCartItem.seller_id);
                    displayMessage(`‚ùå Sepet dolu. Sadece ${currentSeller?.business_name} ile alƒ±≈üveri≈üe devam edebilirsiniz.`);
                    speakToUser("sepet dolu");
                    return true;
                }
            }
            
            // SEPETE EKLE - Mƒ∞KTARI DOƒûRU KULLAN
            console.log('üõí Sepete ekleniyor:', `${quantity} ${unit} ${selectedProduct.name}`);
            addToCart(selectedProduct, quantity);
            
            // ‚úÖ EKRANDA DETAYLI G√ñSTER
            if (numaraMatch) {
                const targetNumber = parseInt(numaraMatch[1]);
                
                 // Unit'e g√∂re √∂zel mesajlar
                let unitText = unit;
                if (unit === 'kg' && quantity < 1) {
                unitText = (quantity * 1000) + ' gram'; // 0.5 kg -> 500 gram
                }
                
                displayMessage(`‚úÖ ${targetNumber}. √ºr√ºnden ${quantity} ${unit} sepete eklendi: ${selectedProduct.name}`);
            } else {
                displayMessage(`‚úÖ ${quantity} ${unit} ${selectedProduct.name} sepete eklendi`);
            }
            
            // ‚úÖ SESLƒ∞: Sadece temel onay
            speakToUser("eklendi");
            
            return true;
        } else {
            console.log('‚ùå √úr√ºn bulunamadƒ±:', productName);
            
            // ‚úÖ EKRANDA DETAYLI G√ñSTER
            const productCards = document.querySelectorAll('.product-card');
            if (productCards.length > 0) {
                const productList = Array.from(productCards)
                    .slice(0, 3)
                    .map(card => `${card.dataset.productIndex}. ${card.querySelector('.product-name')?.textContent}`)
                    .join(', ');
                
                displayMessage(`‚ùå "${productName}" bulunamadƒ±. Mevcut √ºr√ºnler: ${productList}`);
            } else {
                displayMessage(`‚ùå "${productName}" bulunamadƒ±. L√ºtfen √ºr√ºn ismini veya numarasƒ±nƒ± s√∂yleyin.`);
            }
            
            // ‚úÖ SESLƒ∞: Sadece temel uyarƒ±
            speakToUser("√ºr√ºn se√ßin");
            
            return true;
        }
    } catch (error) {
        console.error('‚ùå √úr√ºn ekleme hatasƒ±:', error);
        displayMessage("‚ùå √úr√ºn eklenirken bir hata olu≈ütu.");
        speakToUser("hata");
        return false;
    }
}
        
        function testAllFixed() {
    console.log('üß™ TUM PATTERN TESTI');
    
    const testCases = [
        "1 numara 3 kilo",
        "1 numara 5 adet",
        "3 kilo domates", 
        "yarƒ±m kilo domates",
        "500 gram domates",
        "yarƒ±m adet domates",
        "2 numara",
        "domates",
        "1 numara 2 kilo biber"
    ];
    
    testCases.forEach((testCase, index) => {
        console.log(`\n--- TEST ${index + 1}: "${testCase}" ---`);
        const result = extractProductInfoFromCommand(testCase);
        
        if (result) {
            console.log('‚úÖ BASARILI:', {
                productName: result.productName,
                quantity: result.quantity, 
                unit: result.unit
            });
        } else {
            console.log('‚ùå BASARISIZ');
        }
    });
}

// HEMEN CALISTIRIN:
// testAllFixed()
        
        function emergencyDebug() {
    console.log('üö® ACƒ∞L DEBUG BA≈ûLIYOR...');
    
    // Mevcut durumu kontrol et
    console.log('üìä MEVCUT DURUM:');
    console.log('- Store Type:', selectedStoreTypeId, selectedStoreTypeName);
    console.log('- Seller:', selectedSellerId);
    console.log('- Category:', selectedCategoryId);
    console.log('- Products:', products.length);
    console.log('- Products List:', products.map(p => p.name));
    
    // extractProductInfoFromCommand test
    const testCommands = [
        "1 kilo domates",
        "bir kilo soƒüan", 
        "2 paket s√ºt",
        "domates",
        "1 kilo √ßarliston biber"
    ];
    
    testCommands.forEach((testCommand, index) => {
        console.log(`\n--- TEST ${index + 1}: "${testCommand}" ---`);
        const result = extractProductInfoFromCommand(testCommand);
        console.log('üì¶ √áƒ±karƒ±m sonucu:', result);
        
        if (result && products.length > 0) {
            const found = findProductByName(result.productName);
            console.log('üîç √úr√ºn bulundu mu?:', found ? `EVET - ${found.name}` : 'HAYIR');
            
            if (found) {
                console.log('üõí Sepete eklenebilir:', `${result.quantity} ${result.unit} ${found.name}`);
            }
        }
    });
    
    console.log('\nüéØ DEBUG TAMAMLANDI');
}

// HEMEN √áALI≈ûTIRIN:
// emergencyDebug()
        
// =============================================
// Dƒ∞NAMƒ∞K SATICI Sƒ∞STEMƒ∞
// =============================================

async function handleDynamicSellerSelection(data) {
    if (!selectedStoreTypeId) {
        speakToUser("√ñnce bir maƒüaza tipi se√ßmelisiniz.");
        return;
    }
    
    const seller = await findDynamicSeller(data.extractedData, data.message);
    if (seller) {
        await selectDynamicSeller(seller);
        currentRoot = "4:0";
    } else {
        speakToUser("Satƒ±cƒ± bulunamadƒ±. L√ºtfen numarasƒ±nƒ± veya ismini s√∂yleyin.");
    }
}

// =============================================
// SATICI SE√áƒ∞Mƒ∞NDE A√áIK/KAPALI KONTROL√ú
// =============================================

async function selectDynamicSeller(seller) {
    console.log(`üéØ Satƒ±cƒ± se√ßiliyor: ${seller.business_name}`);
    
    // A√ßƒ±k/kapalƒ± durumu kontrol√º
    if (!seller.working_hours.is_open) {
        const message = `‚ùå ${seller.business_name} ≈üu anda kapalƒ±. `;
        const hoursMessage = seller.working_hours.start_time && seller.working_hours.end_time ? 
            `√áalƒ±≈üma saatleri: ${formatTimeDisplay(seller.working_hours.start_time)} - ${formatTimeDisplay(seller.working_hours.end_time)}` :
            '√áalƒ±≈üma saati belirtilmemi≈ü';
        
        displayMessage(message + hoursMessage);
        speakToUser("Bu maƒüaza ≈üu anda kapalƒ±");
        return;
    }
    
    // Manuel kapalƒ± kontrol√º
    if (seller.working_hours.status === false) {
        displayMessage(`‚ùå ${seller.business_name} ge√ßici olarak kapalƒ±dƒ±r.`);
        speakToUser("Bu maƒüaza ge√ßici olarak kapalƒ±");
        return;
    }
    
    // Teslimat se√ßilmi≈üse mesafe kontrol√º yap
    if (selectedLocation === 'delivery' && userLocation.latitude && userLocation.longitude) {
        console.log('üìç Teslimat i√ßin konum kontrol√º yapƒ±lƒ±yor...');
        
        const deliveryCheck = await checkDeliveryArea(
            seller.id, 
            userLocation.latitude, 
            userLocation.longitude
        );
        
        if (!deliveryCheck.allowed) {
            displayMessage(`‚ùå ${deliveryCheck.message}`);
            speakToUser("Bu konuma teslimat yapƒ±lmƒ±yor");
            return;
        }
        
        // Teslimat √ºcretini satƒ±cƒ± bilgisine ekle
        seller.delivery_fee = deliveryCheck.deliveryFee;
        seller.delivery_distance = deliveryCheck.distance;
        
        displayMessage(`‚úÖ ${deliveryCheck.message}`);
        speakToUser("Teslimat uygun");
    }
    
    // Kilit kontrol√º
    if (isSellerLocked && seller.id !== selectedSellerId) {
        const currentSeller = sellers.find(s => s.id === selectedSellerId);
        speakToUser(`Sepet dolu. Sadece ${currentSeller?.business_name || 'mevcut satƒ±cƒ±'} ile alƒ±≈üveri≈üe devam edebilirsiniz.`);
        return;
    }
    
    // Teslimat kontrol√º
    if (selectedLocation === 'delivery' && seller.delivery_available === false) {
        speakToUser("Bu satƒ±cƒ± konumunuza teslimat yapmƒ±yor. L√ºtfen ba≈üka bir satƒ±cƒ± se√ßin.");
        return;
    }
    
    // √ñnceki se√ßimleri temizle
    document.querySelectorAll('.seller-card, .category-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    const sellerCard = document.querySelector(`[data-seller-id="${seller.id}"]`);
    if (sellerCard) {
        sellerCard.classList.add('selected');
    }
    
    selectedSellerId = seller.id;
    selectedCategoryId = null;
    products = [];
    
    // K√∂k√º g√ºncelle
    currentRoot = "3:0";
    debugLog(`üîÑ K√∂k g√ºncellendi: 2:0 -> 3:0 (Satƒ±cƒ± se√ßildi)`);
    
    // UI temizleme
    if (categoriesGrid) {
        categoriesGrid.innerHTML = '<div class="text-center">Y√ºkleniyor...</div>';
    }
    if (productsGrid) {
        productsGrid.innerHTML = '<div class="text-center">Bir reyon se√ßin</div>';
    }
    
    // Satƒ±cƒ± bilgisini g√ºncelle
    if (selectedSellerInfo) {
        selectedSellerInfo.innerHTML = `
            <i class="fas fa-store"></i> ${seller.business_name} 
            <small style="color: var(--gray);">- ${seller.city || ''}</small>
            ${seller.delivery_fee ? `<small style="color: var(--success);"> - Teslimat: ${money(seller.delivery_fee)}</small>` : ''}
            <small style="color: var(--success);"> - üü¢ A√áIK</small>
        `;
    }

// A√ßƒ±k satƒ±cƒ±larƒ± g√∂ster
async function showOpenSellers() {
    const openSellers = sellers.filter(seller => seller.working_hours.is_open);
    
    if (openSellers.length === 0) {
        displayMessage("üî¥ ≈ûu anda hi√ß a√ßƒ±k maƒüaza bulunmuyor.");
        speakToUser("A√ßƒ±k maƒüaza yok");
        return;
    }
    
    let message = `üü¢ A√áIK MAƒûAZALAR (${openSellers.length} adet)\n\n`;
    
    openSellers.slice(0, 5).forEach((seller, index) => {
        const hours = seller.working_hours.start_time && seller.working_hours.end_time ?
            `${formatTimeDisplay(seller.working_hours.start_time)}-${formatTimeDisplay(seller.working_hours.end_time)}` :
            '√áalƒ±≈üma saati belirtilmemi≈ü';
        
        message += `${index + 1}. ${seller.business_name}\n`;
        message += `   ‚è∞ ${hours}\n`;
        message += `   üìç ${seller.district || ''}, ${seller.city || ''}\n\n`;
    });
    
    if (openSellers.length > 5) {
        message += `... ve ${openSellers.length - 5} maƒüaza daha`;
    }
    
    displayMessage(message);
    speakToUser(`${openSellers.length} a√ßƒ±k maƒüaza bulundu`);
}

// Mevcut satƒ±cƒ± durumunu g√∂ster
async function showCurrentSellerStatus() {
    const seller = sellers.find(s => s.id === selectedSellerId);
    if (!seller) return;
    
    const status = seller.working_hours.is_open ? 'üü¢ A√áIK' : 'üî¥ KAPALI';
    const hours = seller.working_hours.start_time && seller.working_hours.end_time ?
        `√áalƒ±≈üma Saatleri: ${formatTimeDisplay(seller.working_hours.start_time)} - ${formatTimeDisplay(seller.working_hours.end_time)}` :
        '√áalƒ±≈üma saati belirtilmemi≈ü';
    
    const manualStatus = seller.working_hours.status === false ? '\nüö´ Manuel Kapalƒ±' : '';
    
    const message = `üè™ ${seller.business_name}\n\n${status}\n${hours}${manualStatus}`;
    
    displayMessage(message);
    speakToUser(seller.working_hours.is_open ? "Maƒüaza a√ßƒ±k" : "Maƒüaza kapalƒ±");
}


    
    
    // Kategorileri y√ºkle
    await loadCategoriesBySeller(seller.id);
    
    // B√∂l√ºm g√∂r√ºn√ºrl√ºƒü√ºn√º ayarla
    if (categoriesSection) categoriesSection.style.display = 'block';
    if (productsSection) productsSection.style.display = 'none';

    debugLog(`‚úÖ Satƒ±cƒ± se√ßildi: ${seller.business_name}`);
    
    // Teslimat durumuna g√∂re mesaj
    let deliveryMsg = "";
    if (selectedLocation === 'delivery' && seller.delivery_available !== false) {
        if (seller.delivery_fee > 0) {
            deliveryMsg = ` Teslimat √ºcreti: ${money(seller.delivery_fee)}.`;
        } else {
            deliveryMsg = " √úcretsiz teslimat.";
        }
        
        if (seller.delivery_distance) {
            deliveryMsg += ` Mesafe: ${seller.delivery_distance.toFixed(1)}km.`;
        }
    }
    
    speakToUser(`${seller.business_name} se√ßildi.${deliveryMsg} ≈ûimdi bir reyon se√ßin.`);
}
        
// =============================================
// OTOMATƒ∞K DURUM G√úNCELLEME
// =============================================

// Periyodik olarak satƒ±cƒ± durumlarƒ±nƒ± g√ºncelle
function startSellerStatusAutoUpdate() {
    // Her 5 dakikada bir durumu kontrol et
    setInterval(async () => {
        console.log('üîÑ Satƒ±cƒ± durumlarƒ± kontrol ediliyor...');
        await updateAllSellersStatus();
    }, 5 * 60 * 1000); // 5 dakika
    
    // Ayrƒ±ca her dakika hƒ±zlƒ± kontrol (sadece a√ßƒ±k/kapalƒ± durumu)
    setInterval(() => {
        updateSellersOpenStatus();
    }, 60 * 1000); // 1 dakika
}

// T√ºm satƒ±cƒ±larƒ±n durumunu g√ºncelle (veritabanƒ±ndan)
async function updateAllSellersStatus() {
    try {
        const { data: sellersData, error } = await supabase
            .from('seller_profiles')
            .select('*')  // sadece seller_profiles field'larƒ±
            .eq('is_active', true);  // seller_profiles.is_active

        if (error) throw error;

        // √áalƒ±≈üma saatlerini g√ºncelle  
        sellersData.forEach(seller => {
            sellerWorkingHours.set(seller.id, {  // seller.seller_id deƒüil seller.id
                start_time: seller.start_time,
                end_time: seller.end_time,
                status: seller.status
            });
        });

        // A√ßƒ±k/kapalƒ± durumunu g√ºncelle
        updateSellersOpenStatus();
        
        console.log('‚úÖ Satƒ±cƒ± durumlarƒ± g√ºncellendi');

    } catch (error) {
        console.error('‚ùå Satƒ±cƒ± durum g√ºncelleme hatasƒ±:', error);
    }
}
// Satƒ±cƒ±larƒ±n a√ßƒ±k/kapalƒ± durumunu g√ºncelle (cache'den)
function updateSellersOpenStatus() {
    const now = new Date();
    const currentDay = now.getDay();
    const currentTime = now.getHours() * 60 + now.getMinutes();

    sellers.forEach(seller => {
        const workingHours = sellerWorkingHours.get(seller.id);
        if (workingHours) {
            const isOpen = calculateStoreOpenStatus(
                { 
                    sellers: seller, 
                    start_time: workingHours.start_time, 
                    end_time: workingHours.end_time,
                    status: workingHours.status
                }, 
                currentDay, 
                currentTime
            );
            
            seller.working_hours.is_open = isOpen;
        }
    });

    // UI'ƒ± g√ºncelle
    updateSellersGrid();
}
        
        
  async function loadCategoriesBySeller(sellerId) {
    try {
        debugLog(`üì¶ Satƒ±cƒ±ya g√∂re kategoriler y√ºkleniyor: ${sellerId}`);
        
        // √ñnce satƒ±cƒ±nƒ±n √ºr√ºnlerinden kategorileri bul
        const { data: productsData, error: productsError } = await supabase
            .from('products')
            .select('reyon_id, reyon(name)')
            .eq('is_active', true)
            .not('reyon_id', 'is', null);

        if (productsError) throw productsError;

        // Benzersiz kategorileri topla
        const uniqueCategories = [];
        const seenCategoryIds = new Set();
        
        if (productsData && productsData.length > 0) {
            productsData.forEach(item => {
                if (item.reyon && item.reyon_id && !seenCategoryIds.has(item.reyon_id)) {
                    seenCategoryIds.add(item.reyon_id);
                    uniqueCategories.push({
                        id: item.reyon_id,
                        name: item.reyon.name
                    });
                }
            });
        }

        // Eƒüer kategori bulunamazsa t√ºm kategorileri getir
        if (uniqueCategories.length === 0) {
            const { data: allCategories, error: categoriesError } = await supabase
                .from('reyon')
                .select('*')
                .eq('is_active', true)
                .order('name');
                
            if (categoriesError) throw categoriesError;
            
            categories = allCategories || [];
        } else {
            categories = uniqueCategories;
        }

        debugLog(`üìä KATEGORƒ∞ SONU√á: ${categories.length} kategori bulundu`);
        
        // Kategorileri g√∂ster
        displayCategories(categories);
        
        debugLog(`‚úÖ Satƒ±cƒ± kategorileri y√ºklendi: ${categories.length} adet`);
        
        if (categories.length === 0) {
            speakToUser("Bu satƒ±cƒ±da kategori bulunamadƒ±.");
        }

    } catch (error) {
        console.error('‚ùå Kategori y√ºkleme hatasƒ±:', error);
        categories = getDemoCategories();
        displayCategories(categories);
        speakToUser("Kategoriler y√ºklenirken hata olu≈ütu. Demo kategoriler g√∂steriliyor.");
    }
}
// SESLƒ∞ SATICI SE√áƒ∞M - REYON Y√úKLEME 
async function handleVoiceSellerSelection(message) {
    console.log('üéØ Sesli satƒ±cƒ± se√ßimi:', message);
    
    // Store Type kontrol√º
    if (!selectedStoreTypeId) {
        displayMessage("‚ùå √ñnce bir maƒüaza tipi se√ßmelisiniz.");
        speakToUser("maƒüaza se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
        return false;
    }

    const sellerCards = document.querySelectorAll("#sellerGrid .seller-card");
    if (!sellerCards.length) {
        displayMessage("‚ùå Satƒ±cƒ± listesi y√ºklenmedi. L√ºtfen bekleyin.");
        speakToUser("satƒ±cƒ± se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
        return false;
    }

    const cleanMessage = message.toLowerCase().trim();
    let selectedCard = null;

    // SAYISAL SE√áƒ∞M KONTROL√ú
    const numberMap = {
        'birinci': 1, 'bir': 1, '1': 1, '1.': 1,
        'ikinci': 2, 'iki': 2, '2': 2, '2.': 2,
        '√º√ß√ºnc√º': 3, '√º√ß': 3, '3': 3, '3.': 3,
        'd√∂rd√ºnc√º': 4, 'd√∂rt': 4, '4': 4, '4.': 4,
        'be≈üinci': 5, 'be≈ü': 5, '5': 5, '5.': 5
    };

    // 1. Sayƒ±sal se√ßim
    if (numberMap[cleanMessage] !== undefined) {
        const targetNumber = numberMap[cleanMessage];
        selectedCard = Array.from(sellerCards).find(card => 
            parseInt(card.dataset.sellerIndex) === targetNumber
        );
        
        if (selectedCard) {
            console.log(`‚úÖ Sayƒ±sal satƒ±cƒ± se√ßimi: ${targetNumber}. satƒ±cƒ±`);
        }
    }

    // 2. ƒ∞simle arama
    if (!selectedCard) {
        for (const card of sellerCards) {
            const sellerName = card.querySelector('.seller-name')?.textContent.toLowerCase() || '';
            const sellerId = card.dataset.sellerId;
            const seller = sellers.find(s => s.id === sellerId);
            
            if (seller && (
                seller.business_name.toLowerCase().includes(cleanMessage) ||
                cleanMessage.includes(seller.business_name.toLowerCase()) ||
                sellerName.includes(cleanMessage) ||
                cleanMessage.includes(sellerName)
            )) {
                selectedCard = card;
                break;
            }
        }
    }

    if (!selectedCard) {
        const sellerList = Array.from(sellerCards)
            .slice(0, 3)
            .map(card => `${card.dataset.sellerIndex}. ${card.querySelector('.seller-name')?.textContent}`)
            .filter(name => name)
            .join(', ');
        
        displayMessage(`‚ùå Satƒ±cƒ± bulunamadƒ±. Mevcut satƒ±cƒ±lar: ${sellerList}`);
        speakToUser("satƒ±cƒ± se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
        return false;
    }

    // Satƒ±cƒ±yƒ± se√ß
    const sellerId = selectedCard.dataset.sellerId;
    const seller = sellers.find(s => s.id === sellerId);
    
    if (seller) {
        await selectDynamicSeller(seller);
        
        const sellerNumber = selectedCard.dataset.sellerIndex;
        
        // ‚úÖ EKRANDA DETAYLI G√ñSTER
        displayMessage(`‚úÖ ${sellerNumber}. ${seller.business_name} se√ßildi. ≈ûimdi bir reyon se√ßin.`);
        
        // ‚úÖ SESLƒ∞: Sadece temel onay
        speakToUser("se√ßildi");
        
        return true;
    }

    displayMessage("‚ùå Satƒ±cƒ± bulunamadƒ±.");
    speakToUser("satƒ±cƒ± se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
    return false;
}


// =============================================
// SATICI √áALI≈ûMA SAATLERƒ∞ Y√ñNETƒ∞Mƒ∞
// =============================================

// Satƒ±cƒ±larƒ±n a√ßƒ±k/kapalƒ± durumunu kontrol et
async function checkSellersOpenStatus(sellersData) {
    const now = new Date();
    const currentDay = now.getDay(); // 0: Pazar, 1: Pazartesi, ..., 6: Cumartesi
    const currentTime = now.getHours() * 60 + now.getMinutes(); // Dakika cinsinden

    return sellersData.map(seller => {
        const isOpen = calculateStoreOpenStatus(seller, currentDay, currentTime);
        return {
            ...seller,
            is_open: isOpen
        };
    });
}

// Maƒüaza a√ßƒ±k/kapalƒ± durumu hesaplama
function calculateStoreOpenStatus(seller, currentDay, currentTime) {
    // Manuel kapalƒ± durumu kontrol√º (status = false)
    if (seller.status === false) {
        console.log(`üî¥ ${seller.sellers.business_name} - Manuel kapalƒ±`);
        return false;
    }

    // √áalƒ±≈üma saatleri kontrol√º
    if (!seller.start_time || !seller.end_time) {
        console.log(`üü° ${seller.sellers.business_name} - √áalƒ±≈üma saati tanƒ±mlƒ± deƒüil`);
        return true; // √áalƒ±≈üma saati tanƒ±mlƒ± deƒüilse a√ßƒ±k kabul et
    }

    // Zaman formatƒ±nƒ± parse et
    const startTime = parseTimeString(seller.start_time);
    const endTime = parseTimeString(seller.end_time);

    if (!startTime || !endTime) {
        console.log(`üü° ${seller.sellers.business_name} - Ge√ßersiz zaman formatƒ±`);
        return true;
    }

    // Gece yarƒ±sƒ±nƒ± a≈üan √ßalƒ±≈üma saatleri i√ßin kontrol
    let isOpen = false;
    
    if (endTime > startTime) {
        // Normal √ßalƒ±≈üma saati (aynƒ± g√ºn i√ßinde)
        isOpen = currentTime >= startTime && currentTime <= endTime;
    } else {
        // Gece yarƒ±sƒ±nƒ± a≈üan √ßalƒ±≈üma saati
        isOpen = currentTime >= startTime || currentTime <= endTime;
    }

    console.log(`üè™ ${seller.sellers.business_name} - ${isOpen ? 'üü¢ A√áIK' : 'üî¥ KAPALI'} (${formatTime(startTime)}-${formatTime(endTime)})`);
    
    return isOpen;
}

// Zaman parse fonksiyonu
function parseTimeString(timeString) {
    if (!timeString) return null;
    try {
        // "08:00:00+03" formatƒ±nƒ± "08:00" formatƒ±na √ßevir
        const timePart = timeString.split('+')[0].split('.')[0];
        const [hours, minutes] = timePart.split(':').map(Number);
        return hours * 60 + minutes;
    } catch (error) {
        console.error('Zaman parse hatasƒ±:', error);
        return null;
    }
}
// Dakikayƒ± zaman formatƒ±na √ßevir
function formatTime(minutes) {
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
}
        
      
// =============================================
// KATEGORƒ∞ SE√áƒ∞Mƒ∞NDE √úR√úNLERƒ∞ Y√úKLE
// =============================================

// Kategori se√ßildiƒüinde k√∂k√º g√ºncelle
async function selectDynamicCategory(category) {
    const categoryCard = document.querySelector(`[data-category-id="${category.id}"]`);
    if (categoryCard) {
        document.querySelectorAll('.category-card').forEach(c => {
            c.classList.remove('selected');
        });
        
        categoryCard.classList.add('selected');
        selectedCategoryId = category.id;
        
        // K√ñK√ú G√úNCELLE - KATEGORƒ∞ SE√áƒ∞LDƒ∞
        currentRoot = "5:0";
        debugLog(`üîÑ K√∂k g√ºncellendi: 4:0 -> 5:0 (Kategori se√ßildi: ${category.name})`);
        
        await loadProductsByCategory(category.id);
        
        debugLog(`üõí Kategori se√ßildi: ${category.name}`);
        speakToUser(`${category.name} kategorisi se√ßildi. √úr√ºnler listeleniyor. Sesli olarak √ºr√ºn sipari≈üi verebilirsiniz.`);
    }
}      

// =============================================
// KATEGORƒ∞ SE√á √úR√úNLERƒ∞ Y√úKLE
// =============================================

// üéØ Sesli Reyon Se√ßimi (Tƒ±klama Sim√ºlasyonlu)
async function handleVoiceCategorySelection(message) {
    console.log(`üéØ Sesli Reyon Se√ßimi: ${message}`);

    const categoryCards = document.querySelectorAll('.category-card');
    if (!categoryCards.length) {
        displayMessage("‚ö†Ô∏è Reyonlar y√ºklenmemi≈ü g√∂r√ºn√ºyor.");
        speakToUser("reyon se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
        return false;
    }

    const cleanMessage = message.toLowerCase();
    let bestMatch = null;

    // SAYISAL SE√áƒ∞M KONTROL√ú
    const numberMap = {
        'birinci': 1, 'bir': 1, '1': 1, '1.': 1,
        'ikinci': 2, 'iki': 2, '2': 2, '2.': 2,
        '√º√ß√ºnc√º': 3, '√º√ß': 3, '3': 3, '3.': 3,
        'd√∂rd√ºnc√º': 4, 'd√∂rt': 4, '4': 4, '4.': 4,
        'be≈üinci': 5, 'be≈ü': 5, '5': 5, '5.': 5
    };

    // 1. Sayƒ±sal se√ßim
    if (numberMap[cleanMessage] !== undefined) {
        const targetNumber = numberMap[cleanMessage];
        bestMatch = Array.from(categoryCards).find(card => 
            parseInt(card.dataset.categoryIndex) === targetNumber
        );
        
        if (bestMatch) {
            console.log(`‚úÖ Sayƒ±sal reyon se√ßimi: ${targetNumber}. reyon`);
        }
    }

    // 2. ƒ∞simle arama
    if (!bestMatch) {
        categoryCards.forEach(card => {
            const categoryName = card.dataset.categoryName?.toLowerCase() || '';
            if (cleanMessage.includes(categoryName)) {
                bestMatch = card;
            }
        });
    }

    if (bestMatch) {
        // Sim√ºle tƒ±klama
        bestMatch.click();
        
        // Akƒ±llƒ± geri bildirim
        const categoryNumber = bestMatch.dataset.categoryIndex;
        const categoryName = bestMatch.dataset.categoryName;
        console.log(`‚úÖ Sesli olarak "${categoryNumber}. ${categoryName}" reyonu se√ßildi.`);
        
 // ‚úÖ EKRANDA DETAYLI G√ñSTER
        displayMessage(`‚úÖ ${categoryNumber}. ${categoryName} reyonu se√ßildi. ≈ûimdi √ºr√ºn se√ßin.`);
        
        // ‚úÖ SESLƒ∞: Sadece temel onay
        speakToUser("se√ßildi");
        currentRoot = "5:0";
        return true;
    } else {
        const categoryList = Array.from(categoryCards)
            .slice(0, 3)
            .map(card => `${card.dataset.categoryIndex}. ${card.dataset.categoryName}`)
            .join(', ');
        
         displayMessage(`‚ùå Reyon bulunamadƒ±. Mevcut reyonlar: ${categoryList}`);
        speakToUser("reyon se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
        return false;
    }
}
// =============================================
// SATICININ T√úM √úR√úNLERƒ∞Nƒ∞ Y√úKLE (YEDEK)
// =============================================

async function loadAllProductsBySeller() {
    try {
        debugLog(`üõí Satƒ±cƒ±nƒ±n t√ºm √ºr√ºnleri y√ºkleniyor: ${selectedSellerId}`);
        
        const { data: allProducts, error } = await supabase
            .from('products')
            .select('*')
            .eq('is_active', true)
            .order('name');

        if (error) throw error;

        products = (allProducts || []).map(product => ({
            id: product.id,
            name: product.name,
            price: product.price,
            discount_price: product.discount_price,
            imgurl: product.imgurl,
            reyon_id: product.reyon_id,
            unit_type: product.unit_type || 'adet',
            description: product.description
        }));

        debugLog(`‚úÖ T√ºm √ºr√ºnler y√ºklendi: ${products.length} adet`);
        
        displayProducts(products);
        
        if (productsSection) productsSection.style.display = 'block';
        if (categoriesSection) categoriesSection.style.display = 'none';

    } catch (error) {
        console.error('‚ùå T√ºm √ºr√ºn y√ºkleme hatasƒ±:', error);
        products = getDemoProducts();
        displayProducts(products);
    }
}
// =============================================
// YARDIMCI FONKSƒ∞YONLAR
// =============================================
// Basit ve etkili ana sesli se√ßim fonksiyonu
async function handleVoiceSelection(message, currentRoot) {
    console.log(`üéØ Sesli se√ßim i≈üleniyor: "${message}" | K√∂k: ${currentRoot}`);
    
    switch(currentRoot) {
        case '2:0': // Maƒüaza tipi se√ßimi
            return await handleVoiceStoreSelection(message);
            
        case '3:0': // Satƒ±cƒ± se√ßimi
            return await handleVoiceSellerSelection(message);
            
        case '4:0': // Reyon se√ßimi
            return await handleVoiceCategorySelection(message);
            
        case '5:0': // √úr√ºn ekleme
            return await handleVoiceProductAdd(message);
            
        default:
            return false;
    }
}

        // G√∂rsel feedback sistemi
function addVisualFeedback(element, type = 'primary') {
    const colors = {
        'primary': 'var(--primary)',
        'success': 'var(--success)',
        'accent': 'var(--accent)',
        'warning': 'var(--warning)'
    };
    
    const color = colors[type] || colors.primary;
    
    element.style.transition = 'all 0.3s ease';
    element.style.transform = 'scale(1.05)';
    element.style.boxShadow = `0 0 20px ${color}`;
    
    setTimeout(() => {
        element.style.transform = 'scale(1)';
        element.style.boxShadow = '';
    }, 1000);
}

// Kartlarƒ± vurgula
function highlightCards(selector, text) {
    const kartlar = document.querySelectorAll(selector);
    kartlar.forEach(kart => {
        const isimElementi = kart.querySelector('.seller-type-name, .seller-name, .category-name, .product-name');
        if (isimElementi) {
            const isim = isimElementi.textContent.toLowerCase();
            if (isim.includes(text) || text.includes(isim)) {
                addVisualFeedback(kart, 'success');
            }
        }
    });
}

// Mevcut kartlarƒ± listeleyen debug fonksiyonu
function listCurrentCards() {
    console.log('üìã MEVCUT KART Lƒ∞STESƒ∞:');
    
    const maƒüazaKartlarƒ± = document.querySelectorAll('.seller-type-card');
    if (maƒüazaKartlarƒ±.length > 0) {
        console.log('üè™ Maƒüaza Kartlarƒ±:');
        maƒüazaKartlarƒ±.forEach((kart, index) => {
            const isim = kart.querySelector('.seller-type-name').textContent;
            console.log(`  ${index + 1}. ${isim}`);
        });
    }
    
    const satƒ±cƒ±Kartlarƒ± = document.querySelectorAll('.seller-card');
    if (satƒ±cƒ±Kartlarƒ±.length > 0) {
        console.log('üè¨ Satƒ±cƒ± Kartlarƒ±:');
        satƒ±cƒ±Kartlarƒ±.forEach((kart, index) => {
            const isim = kart.querySelector('.seller-name').textContent;
            console.log(`  ${index + 1}. ${isim}`);
        });
    }
    
    const reyonKartlarƒ± = document.querySelectorAll('.category-card');
    if (reyonKartlarƒ±.length > 0) {
        console.log('üì¶ Reyon Kartlarƒ±:');
        reyonKartlarƒ±.forEach((kart, index) => {
            const isim = kart.querySelector('.category-name').textContent;
            console.log(`  ${index + 1}. ${isim}`);
        });
    }
    
    const √ºr√ºnKartlarƒ± = document.querySelectorAll('.product-card');
    if (√ºr√ºnKartlarƒ±.length > 0) {
        console.log('üõí √úr√ºn Kartlarƒ±:');
        √ºr√ºnKartlarƒ±.forEach((kart, index) => {
            const isim = kart.querySelector('.product-name').textContent;
            console.log(`  ${index + 1}. ${isim}`);
        });
    }
}

// Console'da test etmek i√ßin:
// listCurrentCards()
        
// Demo kategoriler
function getDemoCategories() {
    return [
        { id: 1, name: 'Meyve & Sebze' },
        { id: 2, name: 'S√ºt √úr√ºnleri' },
        { id: 3, name: 'Et & Tavuk' },
        { id: 4, name: 'Temel Gƒ±da' },
        { id: 5, name: 'ƒ∞√ßecekler' }
    ];
}

// Kategori ismine g√∂re se√ßim
async function selectCategoryByName(categoryName) {
    const category = categories.find(cat => cat.name === categoryName);
    if (category) {
        await selectDynamicCategory(category);
    }
}

        
// ACƒ∞L DEBUG - Hemen √ßalƒ±≈ütƒ±rƒ±n!
function debugExtractProduct() {
    console.log('üêõ ACƒ∞L DEBUG: extractProductInfoFromCommand Testi');
    
    const testCases = [
        "1 kilo domates",
        "bir kilo soƒüan",
        "2 paket s√ºt", 
        "domates",
        "1 kilo √ßarliston biber",
        "yarƒ±m kilo peynir"
    ];
    
    testCases.forEach((testCase, index) => {
        console.log(`\n--- TEST ${index + 1}: "${testCase}" ---`);
        const result = extractProductInfoFromCommand(testCase);
        console.log('üì¶ SONU√á:', result);
        
        if (result && products.length > 0) {
            const found = findProductByName(result.productName);
            console.log('üîç BULUNDU MU?:', found ? `EVET - ${found.name}` : 'HAYIR');
            
            if (found) {
                console.log('üõí Sepete eklenebilir:', `${result.quantity} ${result.unit} ${found.name}`);
            }
        }
    });
}

        function manualProductAdd() {
    console.log('üõ†Ô∏è MANUEL √úR√úN EKLEME TESTƒ∞');
    
    if (products.length === 0) {
        console.log('‚ùå √úr√ºn listesi bo≈ü');
        return;
    }
    
    console.log('üì¶ Mevcut √ºr√ºnler:', products.map(p => p.name));
    
    // Manuel olarak ilk √ºr√ºn√º sepete ekle
    const product = products[0];
    
    if (product) {
        console.log('‚úÖ √úr√ºn bulundu, sepete ekleniyor...');
        addToCart(product, 1);
        console.log('üéâ √úr√ºn sepete eklendi!');
        speakToUser(`1 adet ${product.name} sepete eklendi.`);
    } else {
        console.log('‚ùå √úr√ºn bulunamadƒ±');
    }
}

// HEMEN √áALI≈ûTIRIN:
// manualProductAdd()

        
// HEMEN √áALI≈ûTIRIN:
debugExtractProduct();
        
// DEBUG: Sepete ekleme s√ºrecini manuel test et
function debugProductAdd() {
    console.log('üêõ DEBUG: Sepete Ekleme S√ºreci');
    
    // 1. Mevcut durum
    console.log('üìä Mevcut Durum:');
    console.log('- Products:', products.length);
    console.log('- Selected Category:', selectedCategoryId);
    console.log('- Selected Seller:', selectedSellerId);
    
    // 2. Manuel extract test
    const testCommand = "1 kilo domates";
    console.log(`üß™ Test komutu: "${testCommand}"`);
    
    const extracted = extractProductInfoFromCommand(testCommand);
    console.log('üì¶ √áƒ±karƒ±lan:', extracted);
    
    if (extracted) {
        // 3. √úr√ºn bulma testi
        const found = findProductByName(extracted.productName);
        console.log('üîç Bulunan √ºr√ºn:', found);
        
        if (found) {
            // 4. Sepete ekleme testi
            console.log('üõí Sepete ekleniyor...');
            addToCart(found, extracted.quantity);
            console.log('‚úÖ Sepete eklendi!');
        }
    }
}

// HEMEN √áALI≈ûTIR:
// debugProductAdd() 
        
// TEST FONKSƒ∞YONU - Hemen √ßalƒ±≈ütƒ±rƒ±n
function testProductExtraction() {
    console.log('üß™ √úR√úN √áIKARIM TESTƒ∞ BA≈ûLIYOR...');
    
    const testCases = [
        "√∂rneƒüin 1 kilo domates",
        "mesela 2 paket s√ºt", 
        "1 kilo domates",
        "√∂rneƒüin domates",
        "√∂rneƒüin bir kilo soƒüan"
    ];
    
    testCases.forEach((testCase, index) => {
        console.log(`\n--- TEST ${index + 1}: "${testCase}" ---`);
        const result = extractProductInfoFromCommand(testCase);
        console.log('üì¶ SONU√á:', result);
    });
    
    console.log('\nüéØ TEST TAMAMLANDI');
}

// Console'da √ßalƒ±≈ütƒ±rƒ±n:
// testProductExtraction();
        
// Sayfa y√ºklendiƒüinde test et
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        // Test etmek i√ßin a≈üaƒüƒ±daki satƒ±rƒ±n yorumunu kaldƒ±rƒ±n:
        // testProductExtraction();
    }, 3000);
});

        function manualTest() {
    console.log('üõ†Ô∏è MANUEL TEST BA≈ûLIYOR...');
    
    if (products.length === 0) {
        console.log('‚ùå √úr√ºn listesi bo≈ü');
        return;
    }
    
    console.log('üì¶ Mevcut √ºr√ºnler:', products.map(p => p.name));
    
    // Manuel extract test
    const testCommand = "1 kilo domates";
    console.log('üß™ Test komutu:', testCommand);
    const result = extractProductInfoFromCommand(testCommand);
    console.log('üì¶ √áƒ±karƒ±m sonucu:', result);
    
    if (result) {
        // Manuel √ºr√ºn bulma
        const found = findProductByName(result.productName);
        console.log('üîç √úr√ºn bulundu:', found ? found.name : 'HAYIR');
        
        if (found) {
            // Manuel sepete ekleme
            console.log('üõí Sepete ekleniyor...');
            addToCart(found, result.quantity);
            console.log('üéâ √úr√ºn sepete eklendi!');
            speakToUser(`${result.quantity} ${result.unit} ${found.name} sepete eklendi.`);
        }
    }
}

// HEMEN √áALI≈ûTIRIN:
// manualTest()
        
function simpleProductMatch(productName) {
    if (!products || products.length === 0) return null;
    
    const cleanName = productName.toLowerCase().trim();
    
    // Basit e≈üle≈ütirme
    for (const product of products) {
        const productNameClean = product.name.toLowerCase();
        
        // Tam e≈üle≈üme
        if (productNameClean === cleanName) {
            return product;
        }
        
        // ƒ∞√ßerme
        if (productNameClean.includes(cleanName) || cleanName.includes(productNameClean)) {
            return product;
        }
        
        // Kelime e≈üle≈ümesi
        const searchWords = cleanName.split(' ');
        const productWords = productNameClean.split(' ');
        
        if (searchWords.some(word => productWords.some(pWord => pWord.includes(word)))) {
            return product;
        }
    }
    
    return null;
}     

// Basit √ßƒ±karƒ±m fonksiyonu
function simpleExtractProduct(message) {
    const cleanMessage = message.toLowerCase()
        .replace(/ekle|sepete|al|istiyorum|l√ºtfen/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    
    // Sayƒ±yƒ± bul
    const numbers = message.match(/\d+/g);
    const quantity = numbers ? parseInt(numbers[0]) : 1;
    
    // √úr√ºn adƒ±nƒ± bul
    let productName = cleanMessage;
    if (numbers) {
        productName = cleanMessage.replace(numbers[0], '').trim();
    }
    
    return productName ? { productName, quantity, unit: 'adet' } : null;
}
        
function findProductBySimilarity(searchName) {
    let bestMatch = null;
    let bestScore = 0;
    
    const searchWords = searchName.split(' ').filter(word => word.length > 2);
    
    products.forEach(product => {
        const productName = product.name.toLowerCase().replace(/[^\w\sƒü√º≈üƒ±√∂√ßƒû√ú≈ûƒ∞√ñ√á]/g, '');
        
        // Kelime bazlƒ± benzerlik
        let wordScore = 0;
        searchWords.forEach(searchWord => {
            let maxWordSimilarity = 0;
            productName.split(' ').forEach(productWord => {
                const similarity = calculateSimilarity(searchWord, productWord);
                if (similarity > maxWordSimilarity) {
                    maxWordSimilarity = similarity;
                }
            });
            wordScore += maxWordSimilarity;
        });
        
        const averageWordScore = wordScore / searchWords.length;
        
        // Tam isim benzerliƒüi
        const fullNameScore = calculateSimilarity(searchName, productName);
        
        // Kombine skor
        const combinedScore = (averageWordScore + fullNameScore) / 2;
        
        if (combinedScore > bestScore && combinedScore > 0.6) {
            bestScore = combinedScore;
            bestMatch = product;
        }
    });
    
    return bestMatch;
}

function calculateSimilarity(str1, str2) {
    if (!str1 || !str2) return 0;
    
    const longer = str1.length > str2.length ? str1 : str2;
    const shorter = str1.length > str2.length ? str2 : str1;
    
    if (longer.length === 0) return 1.0;
    
    // Levenshtein distance
    const distance = levenshteinDistance(str1, str2);
    return (longer.length - distance) / longer.length;
}       

function levenshteinDistance(str1, str2) {
    const matrix = [];
    
    for (let i = 0; i <= str2.length; i++) {
        matrix[i] = [i];
    }
    
    for (let j = 0; j <= str1.length; j++) {
        matrix[0][j] = j;
    }
    
    for (let i = 1; i <= str2.length; i++) {
        for (let j = 1; j <= str1.length; j++) {
            if (str2.charAt(i-1) === str1.charAt(j-1)) {
                matrix[i][j] = matrix[i-1][j-1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i-1][j-1] + 1,
                    matrix[i][j-1] + 1,
                    matrix[i-1][j] + 1
                );
            }
        }
    }
    
    return matrix[str2.length][str1.length];
}

async function handleDynamicAIRequest(message, root) {
    console.log(`ü§ñ AI ƒ∞steƒüi: "${message}" | K√∂k: ${root}`);
    try {
        const response = await processAILogic(message, root);

        // AI kararlƒ±lƒ±ƒüƒ± y√ºksekse
        if (response?.confidence > 0.7) {
            speakToUser(response.message);
            if (response.action) await executeDynamicAction(response.action, { message });
            if (response.nextRoot) {
                console.log(`üîÑ AI nextRoot: ${response.nextRoot}`);
                currentRoot = response.nextRoot;
            }
        } else {
            // Eƒüer currentRoot baƒülamƒ± belirleyebiliyorsa AI fallback yapma
            if (!root || root === "root") {
                speakToUser("Nasƒ±l yardƒ±mcƒ± olabilirim? √úr√ºn, satƒ±cƒ± veya reyon se√ßebilirsiniz.");
            } else {
                console.log("‚ö†Ô∏è AI fallback atlandƒ±, currentRoot:", root);
            }
        }
    } catch (error) {
        console.error('AI i≈üleme hatasƒ±:', error);
        speakToUser("√úzg√ºn√ºm, bir hata olu≈ütu. L√ºtfen tekrar deneyin.");
    }
}

        
   // G√ºncellenmi≈ü AI yardƒ±m mesajƒ±
async function processAILogic(message, root) {
    const lowerMessage = message.toLowerCase();
    
    // Kilit durumunda √∂zel yardƒ±m mesajƒ±
    if (isSellerLocked && lowerMessage.includes('yardƒ±m')) {
        const firstCartItem = cart[0];
        const currentSeller = firstCartItem ? sellers.find(s => s.id === firstCartItem.seller_id) : null;
        
        return {
            message: `Sepet dolu ve ${currentSeller?.business_name || 'mevcut maƒüaza'} kilitli. Sadece bu maƒüazadan √ºr√ºn ekleyebilirsiniz. "Sepeti bo≈üalt" diyerek kilidi kaldƒ±rabilir veya √∂deme yaparak sipari≈üi tamamlayabilirsiniz.`,
            confidence: 0.9
        };
    }
    
    debugLog(`ü§ñ AI ƒ∞≈üleme: "${message}" | K√∂k: ${root} | Satƒ±cƒ±: ${selectedSellerId} | Kategori: ${selectedCategoryId}`);
    
    // Baƒülamsal AI yanƒ±tlarƒ±
    if (selectedCategoryId && products.length > 0) {
        // √úr√ºn ekleme durumu
        if (lowerMessage.includes('ekle') || lowerMessage.includes('al') || lowerMessage.includes('istiyorum')) {
            const productInfo = extractProductInfoFromCommand(message);
            if (productInfo) {
                return {
                    message: `√úr√ºn ekleme komutu algƒ±landƒ±: ${productInfo.quantity} ${productInfo.unit} ${productInfo.productName}`,
                    confidence: 0.8,
                    action: 'add_to_cart'
                };
            }
        }
        
        // √úr√ºn listesi
        if (lowerMessage.includes('ne var') || lowerMessage.includes('√ºr√ºnler') || lowerMessage.includes('liste')) {
            const productList = products.slice(0, 5).map(p => p.name).join(', ');
            return {
                message: `Mevcut √ºr√ºnler: ${productList}. "iki ekmek" veya "bir kilo domates" gibi sipari≈ü verebilirsiniz.`,
                confidence: 0.9
            };
        }
    }
    
    if (selectedSellerId && categories.length > 0 && !selectedCategoryId) {
        // Kategori se√ßimi durumu
        const category = findCategoryByName(message);
        if (category) {
            return {
                message: `${category.name} kategorisi se√ßiliyor...`,
                confidence: 0.8,
                action: 'select_category'
            };
        }
        
        if (lowerMessage.includes('kategori') || lowerMessage.includes('reyon')) {
            const categoryList = categories.slice(0, 5).map(c => c.name).join(', ');
            return {
                message: `Mevcut kategoriler: ${categoryList}. Bir kategori se√ßin.`,
                confidence: 0.9
            };
        }
    }

 // Kilit durumunu g√∂steren debug paneli
function addLockStatusPanel() {
    if (document.getElementById('lockStatusPanel')) return;
    
    const panel = document.createElement('div');
    panel.id = 'lockStatusPanel';
    panel.style.cssText = `
        position: fixed;
        top: 60px;
        right: 20px;
        background: ${isSellerLocked ? '#ff6b6b' : '#51cf66'};
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        z-index: 10000;
        font-weight: bold;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    `;
    
    panel.innerHTML = `
        ${isSellerLocked ? 'üîí Kƒ∞Lƒ∞TLƒ∞' : 'üîì A√áIK'} 
        | Sepet: ${cart.length} √ºr√ºn
        <br>Satƒ±cƒ±: ${selectedSellerId ? 'Se√ßili' : 'Yok'}
    `;
    
    document.body.appendChild(panel);
    
    // Her UI g√ºncellemesinde paneli yenile
    setInterval(() => {
        if (document.getElementById('lockStatusPanel')) {
            document.getElementById('lockStatusPanel').innerHTML = `
                ${isSellerLocked ? 'üîí Kƒ∞Lƒ∞TLƒ∞' : 'üîì A√áIK'} 
                | Sepet: ${cart.length} √ºr√ºn
                <br>Satƒ±cƒ±: ${selectedSellerId ? 'Se√ßili' : 'Yok'}
            `;
            document.getElementById('lockStatusPanel').style.background = 
                isSellerLocked ? '#ff6b6b' : '#51cf66';
        }
    }, 2000);
}

// Sayfa y√ºklendiƒüinde debug panelini ekle
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        addLockStatusPanel();
    }, 3000);
});

    
    // K√∂k bazlƒ± AI yanƒ±tlarƒ±
    switch(root) {
        case '0:0': // Ba≈ülangƒ±√ß
            if (lowerMessage.includes('yardƒ±m') || lowerMessage.includes('help')) {
                return {
                    message: "Sesli sipari≈ü sistemine ho≈ü geldiniz. Konum se√ßerek ba≈ülayabilir, maƒüaza tipi se√ßebilir veya direkt 'market' veya 'restoran' diyerek alƒ±≈üveri≈üe ba≈ülayabilirsiniz.",
                    confidence: 0.9,
                    nextRoot: '1:0'
                };
            }
            break;
            
        case '1:0': // Konum se√ßimi
            if (lowerMessage.includes('nerede') || lowerMessage.includes('konum')) {
                return {
                    message: "Konumunuzu se√ßmeniz gerekiyor: restoran i√ßi, paket servis veya adrese teslim. Hangisini tercih edersiniz?",
                    confidence: 0.8,
                    action: 'show_location_modal'
                };
            }
            break;
            
        case '2:0': // Maƒüaza tipi
            if (lowerMessage.includes('ne var') || lowerMessage.includes('se√ßenek')) {
                const availableTypes = storeTypes.map(st => st.name).join(', ');
                return {
                    message: `Mevcut maƒüaza tipleri: ${availableTypes}. Hangisini se√ßmek istersiniz?`,
                    confidence: 0.9
                };
            }
            break;
            
        case '3:0': // Satƒ±cƒ± se√ßimi
            if (lowerMessage.includes('liste') || lowerMessage.includes('satƒ±cƒ±')) {
                const sellerList = sellers.slice(0, 3).map((s, i) => `${i+1}. ${s.business_name}`).join(', ');
                return {
                    message: `Mevcut satƒ±cƒ±lar: ${sellerList}. Numara s√∂yleyerek se√ßim yapabilirsiniz.`,
                    confidence: 0.8
                };
            }
            break;
            
        case '4:0': // Kategori se√ßimi
            if (lowerMessage.includes('kategori') || lowerMessage.includes('reyon')) {
                const categoryList = categories.slice(0, 5).map(c => c.name).join(', ');
                return {
                    message: `Mevcut kategoriler: ${categoryList}. Bir kategori se√ßin.`,
                    confidence: 0.8
                };
            }
            break;
            
        case '5:0': // √úr√ºn se√ßimi
            if (lowerMessage.includes('√ºr√ºn') || lowerMessage.includes('ne var')) {
                const productList = products.slice(0, 5).map(p => p.name).join(', ');
                return {
                    message: `Mevcut √ºr√ºnler: ${productList}. √úr√ºn adƒ± ve miktar s√∂yleyerek sepete ekleyebilirsiniz.`,
                    confidence: 0.8
                };
            }
            break;
            
        case '6:0': // Sepet y√∂netimi
            if (lowerMessage.includes('sepet') || lowerMessage.includes('√∂deme')) {
                const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
                const total = calculateTotal();
                return {
                    message: `Sepetinizde ${itemCount} √ºr√ºn bulunuyor. Toplam tutar: ${money(total)}. √ñdeme yapmak i√ßin '√∂deme yap' diyebilirsiniz.`,
                    confidence: 0.9,
                    action: 'manage_cart'
                };
            }
            break;
    }
    
    // Genel komutlar
    if (lowerMessage.includes('geri') || lowerMessage.includes('back')) {
        return {
            message: "Bir √∂nceki adƒ±ma d√∂n√ºl√ºyor.",
            confidence: 0.8,
            action: 'navigate_back'
        };
    }
    
    if (lowerMessage.includes('yardƒ±m') || lowerMessage.includes('help')) {
        return {
            message: "Sesli komutlarla alƒ±≈üveri≈ü yapabilirsiniz. 'market se√ß', 'ilk satƒ±cƒ±', 'meyve sebze reyonu', 'iki ekmek' gibi komutlar kullanabilirsiniz.",
            confidence: 0.9
        };
    }
    
    if (lowerMessage.includes('te≈üekk√ºr') || lowerMessage.includes('thanks')) {
        return {
            message: "Rica ederim! Size nasƒ±l yardƒ±mcƒ± olabilirim?",
            confidence: 0.9
        };
    }
    
         // Anla≈üƒ±lamayan mesaj i√ßin baƒülamsal yardƒ±m
    const contextualHelp = getContextualHelp();
    return {
        message: contextualHelp,
        confidence: 0.5
    };
}


// Akƒ±llƒ± yardƒ±m mesajlarƒ±
function getContextualHelp() {
    if (!selectedStoreTypeId) {
        const availableTypes = storeTypes.map(st => st.name).join(', ');
        displayMessage(`Hangi maƒüaza tipinden alƒ±≈üveri≈ü yapmak istersiniz? ${availableTypes}`);
        speakToUser("maƒüaza se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
        return "maƒüaza se√ßin";
    }
    
    if (!selectedSellerId) {
        displayMessage("L√ºtfen bir satƒ±cƒ± se√ßin. Satƒ±cƒ± ismi veya numarasƒ± s√∂yleyebilirsiniz.");
        speakToUser("satƒ±cƒ± se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
        return "satƒ±cƒ± se√ßin";
    }
    
    if (!selectedCategoryId) {
        const categoryList = categories.slice(0, 3).map(c => c.name).join(', ');
        displayMessage(`Hangi reyondan alƒ±≈üveri≈ü yapmak istersiniz? ${categoryList}`);
        speakToUser("reyon se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
        return "reyon se√ßin";
    }
    
    if (products.length > 0) {
        const sampleProducts = products.slice(0, 2).map(p => p.name).join(', ');
        displayMessage(`√úr√ºn sipari≈üi verebilirsiniz. √ñrneƒüin: "1 kilo ${sampleProducts.split(',')[0]}"`);
        speakToUser("√ºr√ºn se√ßin"); // SESLƒ∞: Se√ßim √∂ncesi
        return "√ºr√ºn se√ßin";
    }
    
    displayMessage("Nasƒ±l yardƒ±mcƒ± olabilirim?");
    return "yardƒ±m";
}
        


        // Askƒ±daki yanƒ±tƒ± i≈üleme
async function handlePendingDynamicResponse(message) {
    if (!pendingResponse) return;
    
    const { nextRoot, context } = pendingResponse;
    pendingResponse = null;
    
    // Basit onay/red mantƒ±ƒüƒ±
    const lowerMessage = message.toLowerCase();
    
    if (lowerMessage.includes('evet') || lowerMessage.includes('tamam') || lowerMessage.includes('onay')) {
        currentRoot = nextRoot.split('?')[0]; // Soru i≈üaretinden sonrasƒ±nƒ± kaldƒ±r
        speakToUser("Tamam, devam ediyorum.");
    } else if (lowerMessage.includes('hayƒ±r') || lowerMessage.includes('iptal') || lowerMessage.includes('geri')) {
        speakToUser("Anladƒ±m, iptal edildi.");
    } else {
        speakToUser("L√ºtfen evet veya hayƒ±r ≈üeklinde yanƒ±t verin.");
        pendingResponse = { nextRoot, context }; // Yanƒ±t beklemeye devam et
    }
}
        function testVoiceProductAdd() {
    const testCases = [
        "5 kilo domates",
        "3 ekmek",
        "iki s√ºt",
        "bir peynir",
        "yarƒ±m kilo kƒ±yma",
        "10 yumurta",
        "iki litre s√ºt",
        "500 gram zeytin",
        "bir paket makarna",
        "5 domates"
    ];
    
    testCases.forEach(testCase => {
        console.log(`üß™ Test: "${testCase}"`);
        const result = extractProductInfoFromCommand(testCase);
        if (result) {
            console.log(`‚úÖ √áƒ±karƒ±m: ${result.quantity} ${result.unit} ${result.productName}`);
            
            // √úr√ºn bulma testi
            if (products.length > 0) {
                const foundProduct = findProductByName(result.productName);
                console.log(`üîç Bulunan: ${foundProduct ? foundProduct.name : 'Bulunamadƒ±'}`);
            }
        } else {
            console.log(`‚ùå √áƒ±karƒ±m ba≈üarƒ±sƒ±z`);
        }
        console.log('---');
    });
}
 // Sayfa y√ºklendiƒüinde test et
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        // Test modu aktifse testleri √ßalƒ±≈ütƒ±r
        if (DEBUG_MODE) {
            // testVoiceProductAdd(); // Testleri a√ßmak i√ßin yorumu kaldƒ±rƒ±n
        }
    }, 3000);
});       


function extractProductInfoFromCommand(message) {
    console.log('üéß extractProductInfoFromCommand √ßaƒürƒ±ldƒ±:', message);

    if (!message || message.trim() === '') {
        console.log('‚ùå Bo≈ü mesaj');
        return null;
    }

    // TEMƒ∞ZLEME
    let cleanMessage = message.toLowerCase().trim();
    cleanMessage = cleanMessage.replace(/√∂rneƒüin|mesela|ekle|sepete|al|istiyorum|l√ºtfen/g, '');
    cleanMessage = cleanMessage.replace(/\s+/g, ' ').trim();

    console.log('üßπ Temizlenmi≈ü mesaj:', cleanMessage);

    // "numara" ifadesi ge√ßmiyorsa sesli bildirim i√ßin null d√∂nd√ºr
    if (!cleanMessage.includes('numara')) {
        console.log('‚ùå "numara" ifadesi bulunamadƒ±');
        // Sesli bildirim: "L√ºtfen ge√ßerli √ºr√ºn ekleme komutu s√∂yleyiniz!!!"
        // Display: "√ñrneƒüin: '1 numara 5 kilo' ≈üeklinde kullanƒ±nƒ±z!!!"
        return null;
    }

    let quantity = 1;
    let unit = 'adet';
    let productName = '';

    console.log('üîç Pattern kontrol√º ba≈ülƒ±yor...');

    // 1. √ñNCE "numara kilo" PATTERN'ƒ∞ - EN √ñNCELƒ∞KLƒ∞
    const numaraKiloMatch = cleanMessage.match(/(\d+)\s*numara\s*(\d+[,.]?\d*)\s*kilo/);
    if (numaraKiloMatch) {
        const targetNumber = parseInt(numaraKiloMatch[1]);
        quantity = parseFloat(numaraKiloMatch[2].replace(',', '.'));
        productName = targetNumber + ' numara';
        unit = 'kg';
        console.log(`‚úÖ Numara-kilo pattern e≈üle≈üti: ${quantity} ${unit} ${productName}`);
        return { productName, quantity, unit };
    }

    // 2. "numara gram" PATTERN'ƒ∞
    const numaraGramMatch = cleanMessage.match(/(\d+)\s*numara\s*(\d+)\s*gram/);
    if (numaraGramMatch) {
        const targetNumber = parseInt(numaraGramMatch[1]);
        const gram = parseInt(numaraGramMatch[2]);
        quantity = gram / 1000; // gram'ƒ± kg'ya √ßevir
        productName = targetNumber + ' numara';
        unit = 'kg';
        console.log(`‚úÖ Numara-gram pattern e≈üle≈üti: ${gram} gram = ${quantity} kg ${productName}`);
        return { productName, quantity, unit };
    }

    // 3. "numara yarƒ±m kilo" PATTERN'ƒ∞
    const numaraYarimKiloMatch = cleanMessage.match(/(\d+)\s*numara\s*yarƒ±m\s*kilo/);
    if (numaraYarimKiloMatch) {
        const targetNumber = parseInt(numaraYarimKiloMatch[1]);
        quantity = 0.5;
        productName = targetNumber + ' numara';
        unit = 'kg';
        console.log(`‚úÖ Numara-yarƒ±m kilo pattern e≈üle≈üti: ${quantity} ${unit} ${productName}`);
        return { productName, quantity, unit };
    }

    // 4. "numara adet" PATTERN'ƒ∞
    const numaraAdetMatch = cleanMessage.match(/(\d+)\s*numara\s*(\d+)\s*(adet|tane)/);
    if (numaraAdetMatch) {
        const targetNumber = parseInt(numaraAdetMatch[1]);
        quantity = parseInt(numaraAdetMatch[2]);
        productName = targetNumber + ' numara';
        unit = 'adet';
        console.log(`‚úÖ Numara-adet pattern e≈üle≈üti: ${quantity} ${unit} ${productName}`);
        return { productName, quantity, unit };
    }

    // 5. "numara paket" PATTERN'ƒ∞
    const numaraPaketMatch = cleanMessage.match(/(\d+)\s*numara\s*(\d+)\s*paket/);
    if (numaraPaketMatch) {
        const targetNumber = parseInt(numaraPaketMatch[1]);
        quantity = parseInt(numaraPaketMatch[2]);
        productName = targetNumber + ' numara';
        unit = 'paket';
        console.log(`‚úÖ Numara-paket pattern e≈üle≈üti: ${quantity} ${unit} ${productName}`);
        return { productName, quantity, unit };
    }

    // 6. "numara litre" PATTERN'ƒ∞
    const numaraLitreMatch = cleanMessage.match(/(\d+)\s*numara\s*(\d+[,.]?\d*)\s*litre/);
    if (numaraLitreMatch) {
        const targetNumber = parseInt(numaraLitreMatch[1]);
        quantity = parseFloat(numaraLitreMatch[2].replace(',', '.'));
        productName = targetNumber + ' numara';
        unit = 'litre';
        console.log(`‚úÖ Numara-litre pattern e≈üle≈üti: ${quantity} ${unit} ${productName}`);
        return { productName, quantity, unit };
    }

    // 7. "numara porsiyon" PATTERN'ƒ∞
    const numaraPorsiyonMatch = cleanMessage.match(/(\d+)\s*numara\s*(\d+[,.]?\d*)\s*porsiyon/);
    if (numaraPorsiyonMatch) {
        const targetNumber = parseInt(numaraPorsiyonMatch[1]);
        quantity = parseFloat(numaraPorsiyonMatch[2].replace(',', '.'));
        productName = targetNumber + ' numara';
        unit = 'porsiyon';
        console.log(`‚úÖ Numara-porsiyon pattern e≈üle≈üti: ${quantity} ${unit} ${productName}`);
        return { productName, quantity, unit };
    }

    // 8. SADECE NUMARA (numara olmadan) - MEVCUT
    const sadeceNumaraMatch = cleanMessage.match(/^(\d+)\s*numara$/);
    if (sadeceNumaraMatch) {
        quantity = 1;
        productName = sadeceNumaraMatch[1] + ' numara';
        unit = 'adet';
        console.log(`‚úÖ Sadece numara pattern e≈üle≈üti: ${quantity} ${unit} ${productName}`);
        return { productName, quantity, unit };
    }

    // Hi√ßbir pattern e≈üle≈ümezse
    console.log('‚ùå Hi√ßbir numara patterni e≈üle≈ümedi');
    return null;
}

        
  // Yardƒ±mcƒ± fonksiyon
function findProductByName(productName) {
    if (!products || products.length === 0) {
        console.log('‚ùå √úr√ºn listesi bo≈ü');
        return null;
    }
    
    const cleanName = productName.toLowerCase().trim();
    
    // Tam e≈üle≈üme
    const exactMatch = products.find(p => p.name.toLowerCase() === cleanName);
    if (exactMatch) return exactMatch;
    
    // Kƒ±smi e≈üle≈üme
    const partialMatch = products.find(p => p.name.toLowerCase().includes(cleanName));
    if (partialMatch) return partialMatch;
    
    // √úr√ºn adƒ± komutun i√ßinde ge√ßiyor mu?
    const containedMatch = products.find(p => cleanName.includes(p.name.toLowerCase()));
    if (containedMatch) return containedMatch;
    
    return null;
}      

        
// Hemen kullanabileceƒüiniz basit versiyon
function setupVoiceRecognitionLearning() {
    console.log('üîß Ses tanƒ±ma √∂ƒürenme sistemi kuruluyor...');
    
    // Global fonksiyonlarƒ± g√ºncelle
    const originalProcessVoiceCommand = processVoiceCommand;
    
    processVoiceCommand = async function(transcript) {
        const message = transcript.toLowerCase().trim();
        
        try {
            // √ñnce tablodan d√ºzeltme var mƒ± kontrol et
            const { data: correction, error } = await supabase
                .from('product_voice_matches')
                .select('matched_product')
                .eq('user_input', message)
                .eq('success', true)
                .single();

            if (!error && correction) {
                console.log(`üéØ Tablo d√ºzeltmesi: "${message}" -> "${correction.matched_product}"`);
                // D√ºzeltilmi≈ü mesajla i≈üleme devam et
                await originalProcessVoiceCommand.call(this, correction.matched_product);
                
                // Ba≈üarƒ±yƒ± kaydet (match_count artƒ±rmak i√ßin)
                await supabase
                    .from('product_voice_matches')
                    .update({ 
                        attempted_match: correction.matched_product,
                        created_at: new Date().toISOString()
                    })
                    .eq('user_input', message);
                    
                return;
            }
            
            // Normal i≈üleme devam et
            await originalProcessVoiceCommand.call(this, transcript);
            
        } catch (error) {
            console.error('√ñƒürenen sistem hatasƒ±:', error);
            await originalProcessVoiceCommand.call(this, transcript);
        }
    };
    
    console.log('‚úÖ Ses tanƒ±ma √∂ƒürenme sistemi hazƒ±r');
}

// Uygulama ba≈ülangƒ±cƒ±nda √ßaƒüƒ±r
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        setupVoiceRecognitionLearning();
    }, 2000);
});
        
function testFixedExtraction() {
    console.log('üß™ D√úZELTƒ∞LMƒ∞≈û EXTRACT TESTƒ∞ BA≈ûLIYOR...');
    
    const testCases = [
        "1 kilo domates",
        "bir kilo soƒüan",
        "2 paket s√ºt",
        "domates",
        "1 kilo √ßarliston biber",
        "yarƒ±m kilo peynir",
        "3 adet ekmek",
        "iki kilo patates"
    ];
    
    testCases.forEach((testCase, index) => {
        console.log(`\n--- TEST ${index + 1}: "${testCase}" ---`);
        const result = extractProductInfoFromCommand(testCase);
        console.log('üì¶ SONU√á:', result);
    });
    
    console.log('\nüéØ TEST TAMAMLANDI');
}

// Console'da test etmek i√ßin:
// testFixedExtraction()
        
        // √úr√ºn bulunamadƒ± durumu
function handleDynamicProductNotFound(message, attemptedName) {
    debugLog(`‚ùå √úr√ºn bulunamadƒ±: "${attemptedName}"`);
    
    const availableProducts = products.slice(0, 5).map(p => p.name);
    
    if (availableProducts.length > 0) {
        speakToUser(`"${attemptedName}" bulunamadƒ±. Mevcut √ºr√ºnler: ${availableProducts.join(', ')}`);
    } else {
        speakToUser("Hen√ºz √ºr√ºn y√ºklenmedi. L√ºtfen bir kategori se√ßin.");
    }
}    
   
   
// G√úVENLƒ∞ voiceLearner
const voiceLearner = {
    cache: new Map(),
    initialized: false,

    async correctUserInput(userInput) {
        if (!userInput || typeof userInput !== 'string') {
            return userInput;
        }
        
        if (!this.initialized) return userInput;
        
        const lowerInput = userInput.toLowerCase().trim();
        
        if (this.cache.has(lowerInput)) {
            const corrected = this.cache.get(lowerInput);
            console.log(`üîÑ √ñƒürenilmi≈ü kural: "${userInput}" -> "${corrected}"`);
            return corrected;
        }
        
        return userInput;
    },

    async recordSuccess(userInput, matchedProduct, productId = null) {
        try {
            if (!userInput || !matchedProduct) return;

            // G√ºvenli Supabase sorgusu
            const { error } = await safeSupabaseQuery(
                supabase.from('product_voice_matches').insert([{
                    user_input: String(userInput).toLowerCase(),
                    matched_product: String(matchedProduct),
                    attempted_match: String(matchedProduct),
                    success: true,
                    created_at: new Date().toISOString()
                }])
            );

            if (!error) {
                console.log(`‚úÖ Ba≈üarƒ± kaydedildi: "${userInput}" -> "${matchedProduct}"`);
            }
        } catch (error) {
            console.log('üîá Ba≈üarƒ± kaydetme hatasƒ± (g√ºvenli):', error.message);
        }
    },

    async recordFailure(userInput, attemptedMatch = null) {
        try {
            if (!userInput) return;

            // G√ºvenli Supabase sorgusu
            const { error } = await safeSupabaseQuery(
                supabase.from('product_voice_matches').insert([{
                    user_input: String(userInput).toLowerCase(),
                    matched_product: null,
                    attempted_match: String(attemptedMatch || 'unknown'),
                    success: false,
                    created_at: new Date().toISOString()
                }])
            );

            if (!error) {
                console.log(`‚ùå Ba≈üarƒ±sƒ±zlƒ±k kaydedildi: "${userInput}"`);
            }
        } catch (error) {
            console.log('üîá Ba≈üarƒ±sƒ±zlƒ±k kaydetme hatasƒ± (g√ºvenli):', error.message);
        }
    },

    async initialize() {
        try {
            const { data: rules, error } = await safeSupabaseQuery(
                supabase.from('product_voice_matches')
                    .select('*')
                    .eq('success', true)
            );

            this.cache.clear();
            if (rules) {
                rules.forEach(rule => {
                    if (rule.user_input && rule.matched_product) {
                        this.cache.set(
                            String(rule.user_input).toLowerCase(), 
                            String(rule.matched_product)
                        );
                    }
                });
                console.log(`‚úÖ ${rules.length} √∂ƒürenilmi≈ü kural y√ºklendi`);
            }

            this.initialized = true;
        } catch (error) {
            console.log('üîá √ñƒürenen sistem ba≈ülatma hatasƒ± (g√ºvenli)');
        }
    }
};

// G√ºvenli Supabase sorgu yardƒ±mcƒ±sƒ±
async function safeSupabaseQuery(query, fallbackData = []) {
    try {
        const { data, error } = await query;
        
        if (error) {
            // 406 ve diƒüer hatalarƒ± yakala
            if (error.code === '406' || error.message.includes('406')) {
                console.log('‚ö†Ô∏è Supabase 406 hatasƒ±, fallback kullanƒ±lƒ±yor');
                return fallbackData;
            }
            console.log('üîá Supabase sorgu hatasƒ±:', error.message);
            return fallbackData;
        }
        
        return data || fallbackData;
    } catch (error) {
        console.log('üîá Supabase sorgu istisnasƒ±:', error.message);
        return fallbackData;
    }
}

        
        
 
// üî• G√ºncellenmi≈ü handleDynamicAddToCart
async function handleDynamicAddToCart(data) {
    console.log('üéØ handleDynamicAddToCart √ßaƒürƒ±ldƒ±:', data);

    const productInfo = await extractProductInfoFromCommand(data.message);

    if (!productInfo) {
        await voiceLearner.recordFailure(data.message, 'extraction_failed');
        speakToUser("√úr√ºn ismini anlayamadƒ±m.");
        return;
    }

    const { productName, quantity, unit } = productInfo;
    const product = findProductByName(productName);

    if (product) {
        addToCart(product, quantity);
        speakToUser(`${quantity} ${unit} ${product.name} sepete eklendi.`);

        await voiceLearner.recordSuccess(data.message, product.name, product.id);

    } else {
        await voiceLearner.recordFailure(data.message, productName);
        handleDynamicProductNotFound(data.message, productName);
    }
}

// Hata ayƒ±klama testi
function testAllFunctions() {
    console.log('üß™ T√úM FONKSƒ∞YONLAR TEST EDƒ∞Lƒ∞YOR...');
    
    const testInputs = [
        'domates',
        '3 kilo soƒüan', 
        '√ßarliston biber',
        '', // bo≈ü input
        null, // null input
        123, // sayƒ± input
        undefined // undefined input
    ];
    
    testInputs.forEach(input => {
        console.log(`\nüß™ Test input:`, input);
        
        // extractProductInfoFromCommand test
        try {
            const result = extractProductInfoFromCommand(input);
            console.log('‚úÖ extractProductInfoFromCommand:', result);
        } catch (e) {
            console.log('‚ùå extractProductInfoFromCommand hatasƒ±:', e.message);
        }
        
        // findProductByName test (sadece string i√ßin)
        if (typeof input === 'string' && input.trim()) {
            try {
                const result = findProductByName(input);
                console.log('‚úÖ findProductByName:', result ? result.name : 'Bulunamadƒ±');
            } catch (e) {
                console.log('‚ùå findProductByName hatasƒ±:', e.message);
            }
        }
    });
}

// Console'da test etmek i√ßin:
// testAllFunctions();
        
// Console'da test etmek i√ßin:
// testVoiceLearner();
// =============================================
// Dƒ∞NAMƒ∞K REYON Sƒ∞STEMƒ∞
// =============================================

async function handleDynamicCategorySelection(data) {
    if (!selectedSellerId) {
        speakToUser("√ñnce bir satƒ±cƒ± se√ßmelisiniz.");
        return;
    }
    
    const category = await findDynamicCategory(data.extractedData, data.message);
    if (category) {
        await selectDynamicCategory(category);
        currentRoot = "5:0";
    } else {
        const availableCategories = await getAvailableCategories();
        speakToUser(`Reyon bulunamadƒ±. Mevcut reyonlar: ${availableCategories}`);
    }
}

        
// =============================================
// Dƒ∞NAMƒ∞K YARDIMCI FONKSƒ∞YONLAR
// =============================================

// Dinamik satƒ±cƒ± bulma
async function findDynamicSeller(extractedData, message) {
    // Index ile arama
    if (extractedData?.sellerIndex) {
        const index = parseInt(extractedData.sellerIndex) - 1;
        if (index >= 0 && index < sellers.length) {
            return sellers[index];
        }
    }
    
    // ƒ∞sim ile arama
    if (extractedData?.sellerName) {
        return sellers.find(s => 
            s.business_name.toLowerCase().includes(extractedData.sellerName.toLowerCase())
        );
    }
    
    // Mesajdan √ßƒ±karƒ±m
    const sellerName = await extractSellerFromMessage(message);
    if (sellerName) {
        return sellers.find(s => 
            s.business_name.toLowerCase().includes(sellerName.toLowerCase())
        );
    }
    
    return null;
}

// Dinamik reyon bulma
async function findDynamicCategory(extractedData, message) {
    // Index ile arama
    if (extractedData?.categoryIndex) {
        const index = parseInt(extractedData.categoryIndex) - 1;
        if (index >= 0 && index < categories.length) {
            return categories[index];
        }
    }
    
    // ƒ∞sim ile arama
    if (extractedData?.categoryName) {
        return categories.find(c => 
            c.name.toLowerCase().includes(extractedData.categoryName.toLowerCase())
        );
    }
    
    return null;
}

// Dinamik √ºr√ºn bilgisi √ßƒ±karƒ±mƒ±
function extractDynamicProductInfo(extractedData, message) {
    // √ñncelikle extractedData'dan al
    if (extractedData?.product && extractedData?.quantity) {
        return {
            productName: extractedData.product,
            quantity: parseInt(extractedData.quantity)
        };
    }
    
    // Fallback: mesajdan √ßƒ±kar
    return extractProductInfoFromCommand(message);
}

// =============================================
// Dƒ∞NAMƒ∞K EVENT HANDLER'LAR
// =============================================

function setupDynamicEventHandlers() {
    // Mikrofon
    if (microphoneToggle) {
        microphoneToggle.addEventListener('click', handleDynamicMicrophoneToggle);
    }
    
    // Konum
    setupDynamicLocationEvents();
    
    // Sepet
    if (orderSummary) {
        orderSummary.addEventListener('click', toggleDynamicCart);
    }
    if (cartClose) {
        cartClose.addEventListener('click', closeDynamicCart);
    }
    
    // √ñdeme butonlarƒ±
    if (payCashBtn) payCashBtn.addEventListener('click', () => finalizeDynamicOrder('nakit'));
    if (payCardBtn) payCardBtn.addEventListener('click', () => finalizeDynamicOrder('kart'));
    if (payBonusBtn) payBonusBtn.addEventListener('click', () => finalizeDynamicOrder('bonus'));
}

function handleDynamicMicrophoneToggle() {
    if (!selectedLocation) {
        showDynamicLocationModal();
        speakToUser("L√ºtfen √∂nce bir konum se√ßiniz.");
        return;
    }
    
    if (isListening) {
        disableDynamicMicrophone();
    } else {
        enableDynamicMicrophone();
    }
}

// =============================================
// Dƒ∞NAMƒ∞K FALLBACK ve AI Sƒ∞STEMƒ∞
// =============================================

async function handleUnknownDynamicAction(actionName, data) {
    const aiResponse = await queryDynamicAI(data.message, currentRoot);
    
    if (aiResponse.confidence > 0.7) {
        speakToUser(aiResponse.message);
        if (aiResponse.suggestedAction) {
            await executeDynamicAction(aiResponse.suggestedAction, data);
        }
    } else {
        const contextualHelp = await getDynamicContextualHelp(currentRoot);
        speakToUser(contextualHelp);
    }
}

// Ba≈üarƒ±lƒ± √ºr√ºn e≈üle≈ümesini kaydetme
async function saveSuccessfulProductMatch(spokenText, matchedProduct) {
    try {
        // √ñƒürenme verisini kaydet (ger√ßek uygulamada veritabanƒ±na kaydedebilirsiniz)
        const learningData = {
            spoken_text: spokenText,
            matched_product: matchedProduct,
            timestamp: new Date().toISOString(),
            root_code: currentRoot
        };
        
        console.log('üìö √ñƒürenme verisi kaydedildi:', learningData);
        
        // localStorage'a kaydet (ge√ßici √ß√∂z√ºm)
        const existingData = JSON.parse(localStorage.getItem('voice_learning_data') || '[]');
        existingData.push(learningData);
        localStorage.setItem('voice_learning_data', JSON.stringify(existingData));
        
    } catch (error) {
        console.error('√ñƒürenme verisi kaydetme hatasƒ±:', error);
    }
}

function extractStoreInfoFromCommand(message) {
    console.log('üîç Maƒüaza bilgisi √ßƒ±karƒ±lƒ±yor:', message);
    
    const cleanMessage = message.toLowerCase()
        .replace(/√∂rneƒüin|mesela|maƒüaza|tip|se√ß|ekle|al|istiyorum|l√ºtfen/g, '')
        .replace(/\s+/g, ' ')
        .trim();

    // 1. "X numara" pattern'i - "1 numara", "2 numara" vb.
    const numaraMatch = cleanMessage.match(/(\d+)\s*numara/);
    if (numaraMatch) {
        const storeNumber = parseInt(numaraMatch[1]);
        console.log(`‚úÖ Numara pattern: ${storeNumber}. maƒüaza`);
        return { storeNumber, storeName: null, type: 'number' };
    }

    // 2. Sayƒ±sal se√ßim - "bir", "iki", "1", "2" vb.
    const numberMap = {
        'bir': 1, 'birinci': 1, '1': 1, '1.': 1,
        'iki': 2, 'ikinci': 2, '2': 2, '2.': 2,
        '√º√ß': 3, '√º√ß√ºnc√º': 3, '3': 3, '3.': 3,
        'd√∂rt': 4, 'd√∂rd√ºnc√º': 4, '4': 4, '4.': 4,
        'be≈ü': 5, 'be≈üinci': 5, '5': 5, '5.': 5,
        'altƒ±': 6, 'altƒ±ncƒ±': 6, '6': 6, '6.': 6,
        'yedi': 7, 'yedinci': 7, '7': 7, '7.': 7,
        'sekiz': 8, 'sekizinci': 8, '8': 8, '8.': 8,
        'dokuz': 9, 'dokuzuncu': 9, '9': 9, '9.': 9,
        'on': 10, 'onuncu': 10, '10': 10, '10.': 10
    };

    for (const [numberWord, storeNumber] of Object.entries(numberMap)) {
        if (cleanMessage === numberWord || cleanMessage.includes(numberWord)) {
            console.log(`‚úÖ Sayƒ±sal se√ßim: ${storeNumber}. maƒüaza (${numberWord})`);
            return { storeNumber, storeName: null, type: 'number' };
        }
    }

    // 3. Saf sayƒ± - "1", "2", "3" vb.
    const pureNumberMatch = cleanMessage.match(/^\d+$/);
    if (pureNumberMatch) {
        const storeNumber = parseInt(pureNumberMatch[0]);
        console.log(`‚úÖ Saf sayƒ±: ${storeNumber}. maƒüaza`);
        return { storeNumber, storeName: null, type: 'number' };
    }

    // 4. Maƒüaza ismi - "market", "pastane", "alkol" vb.
    const storeNameMap = {
        'market': 'Market',
        's√ºpermarket': 'Market',
        'bakkal': 'Market',
        'restoran': 'Restoran',
        'lokanta': 'Restoran',
        'yemek': 'Restoran',
        'fast food': 'Fast Food',
        'fastfood': 'Fast Food',
        'pastane': 'Pastane',
        'fƒ±rƒ±n': 'Pastane',
        'eczane': 'Eczane',
        'ila√ß': 'Eczane',
        'kafe': 'Kafe',
        'kahve': 'Kafe',
        'alkol': 'Alkol',
        'i√ßki': 'Alkol',
        'pet shop': 'Pet Shop',
        'pet': 'Pet Shop',
        'hayvan': 'Pet Shop',
        '√ßi√ßek': '√ái√ßek',
        '√ßi√ßek√ßi': '√ái√ßek',
        '√ßar≈üƒ±': '√áar≈üƒ±',
        'avm': '√áar≈üƒ±'
    };

    for (const [keyword, storeName] of Object.entries(storeNameMap)) {
        if (cleanMessage.includes(keyword)) {
            console.log(`‚úÖ Maƒüaza ismi: "${keyword}" -> "${storeName}"`);
            return { storeNumber: null, storeName, type: 'name' };
        }
    }

    // 5. Doƒürudan maƒüaza ismi
    const directStoreName = cleanMessage.trim();
    if (directStoreName && directStoreName.length > 1) {
        console.log(`‚úÖ Doƒürudan maƒüaza ismi: "${directStoreName}"`);
        return { storeNumber: null, storeName: directStoreName, type: 'name' };
    }

    console.log('‚ùå Maƒüaza bilgisi √ßƒ±karƒ±lamadƒ±');
    return null;
}
        

// Maƒüaza tipi √ßƒ±karƒ±mƒ±
async function extractStoreTypeFromMessage(message) {
    const lowerMessage = message.toLowerCase();
    
    const typeMappings = {
        'market': 'Market',
        's√ºpermarket': 'Market',
        'bakkal': 'Market',
        'restoran': 'Restoran',
        'lokanta': 'Restoran',
        'yemek': 'Restoran',
        'eczane': 'Eczane',
        'fƒ±rƒ±n': 'Fƒ±rƒ±n',
        'kafe': 'Kafe',
        'kahve': 'Kafe'
    };
    
    for (const [keyword, storeType] of Object.entries(typeMappings)) {
        if (lowerMessage.includes(keyword)) {
            return storeType;
        }
    }
    
    return null;
}

// Satƒ±cƒ± √ßƒ±karƒ±mƒ±
async function extractSellerFromMessage(message) {
    // Basit satƒ±cƒ± ismi √ßƒ±karƒ±mƒ±
    const sellers = filteredSellers.length > 0 ? filteredSellers : allSellersInLocation;
    
    for (const seller of sellers) {
        if (message.toLowerCase().includes(seller.business_name.toLowerCase())) {
            return seller.business_name;
        }
    }
    
    return null;
}

// Mevcut maƒüaza tiplerini getir
async function getAvailableStoreTypes() {
    return storeTypes.map(st => st.name).join(', ');
}

// Maƒüaza tipi bulma
async function findStoreTypeByName(storeTypeName) {
    return storeTypes.find(st => 
        st.name.toLowerCase().includes(storeTypeName.toLowerCase()) ||
        storeTypeName.toLowerCase().includes(st.name.toLowerCase())
    );
}
   // √ñdeme finalizasyonu
async function finalizeDynamicOrder(paymentMethod) {
    if (cart.length === 0) {
        speakToUser("Sepetiniz bo≈ü. √ñnce √ºr√ºn ekleyin.");
        return;
    }
    
    currentPaymentMethod = paymentMethod;
    
    const total = calculateTotal();
    const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
    
    speakToUser(`${itemCount} √ºr√ºn i√ßin ${money(total)} tutarƒ±ndaki sipari≈üiniz ${paymentMethod} ile √∂deme yapƒ±lƒ±yor. Sipari≈üiniz alƒ±ndƒ±, te≈üekk√ºr ederiz!`);
    
    // Sipari≈üi tamamla
    await completeDynamicOrder();
}     


        // Sipari≈üi tamamlama
async function completeDynamicOrder() {
    try {
        // Sipari≈ü verilerini hazƒ±rla
        const orderData = {
            customer_id: currentCustomer?.id || null,
            seller_id: selectedSellerId,
            total_amount: calculateTotal(),
            payment_method: currentPaymentMethod,
            location_type: selectedLocation,
            items: cart.map(item => ({
                product_id: item.id,
                quantity: item.quantity,
                unit_price: item.price,
                total_price: item.price * item.quantity
            })),
            order_date: new Date().toISOString()
        };
        
        console.log('‚úÖ Sipari≈ü tamamlandƒ±:', orderData);
        
        // Sipari≈üi sƒ±fƒ±rla
        cart = [];
        updateCartUI();
        closeDynamicCart();
        
        // K√∂k√º sƒ±fƒ±rla
        currentRoot = "0:0";
        
        speakToUser("Sipari≈üiniz ba≈üarƒ±yla alƒ±ndƒ±! Yeni bir sipari≈ü vermek i√ßin konum se√ßebilirsiniz.");
        
    } catch (error) {
        console.error('Sipari≈ü tamamlama hatasƒ±:', error);
        speakToUser("Sipari≈ü i≈ülemi sƒ±rasƒ±nda bir hata olu≈ütu. L√ºtfen tekrar deneyin.");
    }
}

        // Sepet y√∂netimi
async function handleDynamicCartManagement(data) {
    openDynamicCart();
    
    const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
    const total = calculateTotal();
    
    if (itemCount === 0) {
        speakToUser("Sepetiniz bo≈ü. √úr√ºn eklemek i√ßin alƒ±≈üveri≈üe devam edin.");
    } else {
        speakToUser(`Sepetinizde ${itemCount} √ºr√ºn bulunuyor. Toplam tutar: ${money(total)}. √ñdeme yapmak i√ßin '√∂deme yap' diyebilirsiniz.`);
    }
}

        // √ñdeme se√ßimi
async function handleDynamicPaymentSelection(data) {
    const paymentMethod = data.extractedData?.payment || data.message.toLowerCase();
    
    if (paymentMethod.includes('nakit') || paymentMethod.includes('para')) {
        await finalizeDynamicOrder('nakit');
    } else if (paymentMethod.includes('kart') || paymentMethod.includes('kredi')) {
        await finalizeDynamicOrder('kart');
    } else if (paymentMethod.includes('bonus')) {
        await finalizeDynamicOrder('bonus');
    } else {
        speakToUser("L√ºtfen √∂deme y√∂ntemi se√ßin: nakit, kart veya bonus.");
    }
}


// Navigasyon
async function handleDynamicNavigation(data) {
    // Basit geri navigasyonu
    const rootParts = currentRoot.split(':');
    const mainRoot = parseInt(rootParts[0]);
    
    if (mainRoot > 0) {
        currentRoot = `${mainRoot - 1}:0`;
        speakToUser("Bir √∂nceki adƒ±ma d√∂n√ºld√º.");
    } else {
        speakToUser("Zaten ba≈ülangƒ±√ß konumundasƒ±nƒ±z.");
    }
}

  // Yardƒ±m
async function handleDynamicHelp(data) {
    const helpMessage = getContextualHelpMessage(currentRoot);
    speakToUser(helpMessage);
}      
        
// Mevcut kategorileri getir
async function getAvailableCategories() {
    return categories.map(c => c.name).join(', ');
}        
async function getDynamicContextualHelp(rootCode) {
    const { data } = await supabase
        .from('voice_context_help')
        .select('help_message')
        .eq('root_code', rootCode)
        .eq('is_active', true)
        .single();
        
    return data?.help_message || "Nasƒ±l yardƒ±mcƒ± olabilirim? Sesli olarak sipari≈ü verebilir veya 'yardƒ±m' diyebilirsiniz.";
}

        // StoreTypes y√ºkleme fonksiyonunu g√ºncelle
async function loadStoreTypes() {
    try {
        console.log('üõçÔ∏è StoreTypes y√ºkleniyor...');
        
        const { data, error } = await supabase
            .from('store_type')
            .select('*')
            .eq('status', 'Active')
            .order('sort_code');

        if (error) {
            console.error('‚ùå StoreTypes API hatasƒ±:', error);
            // Fallback: Demo veriler
            storeTypes = getDemoStoreTypes();
            displayStoreTypes(storeTypes);
            return;
        }

        if (data && data.length > 0) {
            storeTypes = data;
            displayStoreTypes(storeTypes);
            console.log(`‚úÖ StoreTypes y√ºklendi: ${data.length} adet`);
        } else {
            // Veri yoksa demo verileri kullan
            storeTypes = getDemoStoreTypes();
            displayStoreTypes(storeTypes);
            console.log('‚ö†Ô∏è StoreTypes bulunamadƒ±, demo veriler kullanƒ±lƒ±yor');
        }

    } catch (error) {
        console.error('‚ùå StoreTypes y√ºkleme hatasƒ±:', error);
        storeTypes = getDemoStoreTypes();
        displayStoreTypes(storeTypes);
    }
}

// Demo store types
function getDemoStoreTypes() {
    return [
        { id: 1, name: 'Market', status: 'Active', sort_code: 1 },
        { id: 2, name: 'Restoran', status: 'Active', sort_code: 2 },
        { id: 3, name: 'Eczane', status: 'Active', sort_code: 3 },
        { id: 4, name: 'Fƒ±rƒ±n', status: 'Active', sort_code: 4 },
        { id: 5, name: 'Kafe', status: 'Active', sort_code: 5 }
    ];
}

// API hatalarƒ±nƒ± √∂nleme
async function safeSupabaseQuery(query, fallbackData = []) {
    try {
        const { data, error } = await query;
        
        if (error) {
            console.error('Supabase sorgu hatasƒ±:', error);
            return fallbackData;
        }
        
        return data || fallbackData;
    } catch (error) {
        console.error('Supabase sorgu istisnasƒ±:', error);
        return fallbackData;
    }
}


// =============================================
// BA≈ûLANGI√á FONKSƒ∞YONLARI
// =============================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM y√ºklendi, dinamik uygulama ba≈ülatƒ±lƒ±yor...');
    initApp();
});

// Dinamik acil durum modu
function dynamicEmergencyFallback() {
    debugLog('üÜò Dinamik acil durum modu aktif');
    setupDynamicLocationEvents();
    
    if (!selectedLocation) {
        setTimeout(() => {
            showDynamicLocationModal();
        }, 2000);
    }
}

// =============================================
// EKSƒ∞K FONKSƒ∞YONLARI TAMAMLAMA
// =============================================

// Dil se√ßeneklerini y√ºkle
async function loadLanguageOptions() {
    try {
        console.log('üåê Dil se√ßenekleri y√ºkleniyor...');
        
        // √ñnce languages tablosunun var olup olmadƒ±ƒüƒ±nƒ± kontrol et
        const { data, error } = await supabase
            .from('languages')
            .select('iso_code, name, flag, is_active')
            .eq('is_active', true)
            .order('sort_order');

        if (error) {
            console.log('‚ùå Languages tablosu hatasƒ±, fallback kullanƒ±lƒ±yor:', error);
            return getFallbackLanguages();
        }

        if (data && data.length > 0) {
            console.log(`‚úÖ ${data.length} dil se√ßeneƒüi y√ºklendi`);
            return data;
        } else {
            console.log('‚ö†Ô∏è Languages tablosu bo≈ü, fallback kullanƒ±lƒ±yor');
            return getFallbackLanguages();
        }
    } catch (error) {
        console.error('üí• Dil se√ßenekleri y√ºkleme hatasƒ±:', error);
        return getFallbackLanguages();
    }
}        
// Dinamik konum event'lerini ayarla
function setupDynamicLocationEvents() {
    const locationMarker = document.getElementById('locationMarker');
    if (locationMarker) {
        locationMarker.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            showDynamicLocationModal();
        });
        locationMarker.style.cursor = 'pointer';
    }
}

// Dinamik modal kapatma event'leri
function setupDynamicModalCloseEvents() {
    const closeLocationModal = document.getElementById('closeLocationModal');
    if (closeLocationModal) {
        closeLocationModal.addEventListener('click', function(e) {
            e.stopPropagation();
            hideDynamicLocationModal();
        });
    }
    
    const locationModal = document.getElementById('locationModal');
    if (locationModal) {
        locationModal.addEventListener('click', function(e) {
            if (e.target === locationModal) {
                speakToUser("L√ºtfen bir konum se√ßiniz. Konum se√ßmeden devam edemezsiniz.");
            }
        });
    }
}
        function getFallbackLanguages() {
    debugLog('üîÑ Fallback dil se√ßenekleri kullanƒ±lƒ±yor');
    return [
        { 
            code: 'tr', 
            name: 'T√ºrk√ße', 
            flag: 'üáπüá∑', 
            is_active: true,
            sort_order: 1
        },
        { 
            code: 'en', 
            name: 'English', 
            flag: 'üá∫üá∏', 
            is_active: true,
            sort_order: 2
        },
        { 
            code: 'de', 
            name: 'Deutsch', 
            flag: 'üá©üá™', 
            is_active: true,
            sort_order: 3
        }
    ];
}
        
// =============================================
// √áOKLU Dƒ∞L DESTEƒûƒ∞ - BASƒ∞T VERSƒ∞YON
// =============================================

const translations = {
    tr: {
        app_name: "Sesli Sipari≈ü",
        select_location: "Konum Se√ßin",
        order: "Sipari≈ü:",
        profile: "Profilim",
        microphone_off: "Mikrofon (Kapalƒ±)",
        banner_title: "Sesli Sipari≈ü ile Kolay Alƒ±≈üveri≈ü",
        banner_description: "Sadece konu≈üun, sipari≈üiniz kapƒ±nƒ±zda!",
        what_to_eat: "Ne yemek istersiniz?",
        nearest_places: "Size En Yakƒ±n Yerler",
        categories: "Kategoriler",
        products: "√úr√ºnler",
        your_cart: "Sepetiniz",
        empty_cart: "Sepetiniz bo≈ü",
        subtotal: "Ara Toplam:",
        discount: "ƒ∞ndirim:",
        vat: "KDV (%18):",
        total: "Toplam:",
        pay_cash: "Nakit √ñde",
        pay_card: "Kartla √ñde",
        pay_bonus: "Bonus ile √ñde"
    },
    en: {
        app_name: "Voice Order",
        select_location: "Select Location",
        order: "Order:",
        profile: "My Profile",
        microphone_off: "Microphone (Off)",
        banner_title: "Easy Shopping with Voice Order",
        banner_description: "Just speak, your order is at your door!",
        what_to_eat: "What would you like to eat?",
        nearest_places: "Nearest Places to You",
        categories: "Categories",
        products: "Products",
        your_cart: "Your Cart",
        empty_cart: "Your cart is empty",
        subtotal: "Subtotal:",
        discount: "Discount:",
        vat: "VAT (%18):",
        total: "Total:",
        pay_cash: "Pay Cash",
        pay_card: "Pay by Card",
        pay_bonus: "Pay with Bonus"
    },
    de: {
        app_name: "Sprachbestellung",
        select_location: "Standort ausw√§hlen",
        order: "Bestellung:",
        profile: "Mein Profil",
        microphone_off: "Mikrofon (Aus)",
        banner_title: "Einfaches Einkaufen mit Sprachbestellung",
        banner_description: "Einfach sprechen, Ihre Bestellung ist vor Ihrer T√ºr!",
        what_to_eat: "Was m√∂chten Sie essen?",
        nearest_places: "N√§chste Orte zu Ihnen",
        categories: "Kategorien",
        products: "Produkte",
        your_cart: "Ihr Warenkorb",
        empty_cart: "Ihr Warenkorb ist leer",
        subtotal: "Zwischensumme:",
        discount: "Rabatt:",
        vat: "MwSt (%18):",
        total: "Gesamt:",
        pay_cash: "Bar bezahlen",
        pay_card: "Mit Karte bezahlen",
        pay_bonus: "Mit Bonus bezahlen"
    }
};

let currentLanguage = 'tr';

// Sayfayƒ± √ßevir
function translatePage(lang) {
    currentLanguage = lang;
    
    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        if (translations[lang] && translations[lang][key]) {
            if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                element.placeholder = translations[lang][key];
            } else {
                element.textContent = translations[lang][key];
            }
        }
    });
    
    // Dil d√ºƒümesini g√ºncelle
    const currentLang = getFallbackLanguages().find(l => l.code === lang);
    if (currentLang && document.getElementById('currentLanguage')) {
        document.getElementById('currentLanguage').textContent = currentLang.flag;
    }
    
    debugLog(`‚úÖ Dil deƒüi≈ütirildi: ${lang}`);
}

// =============================================
// Dƒ∞L SELECTOR UI
// =============================================

function setupLanguageSelector() {
    const languageBtn = document.getElementById('languageBtn');
    const languageDropdown = document.getElementById('languageDropdown');
    
    if (!languageBtn || !languageDropdown) return;
    
    // Dil se√ßeneklerini olu≈ütur
    populateLanguageDropdown();
    
    // Dil deƒüi≈ütirme event'i
    languageBtn.addEventListener('click', function() {
        languageDropdown.classList.toggle('show');
    });
    
    // Dƒ±≈üarƒ± tƒ±klayƒ±nca kapat
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.language-selector')) {
            languageDropdown.classList.remove('show');
        }
    });
}

        function populateLanguageDropdown() {
    const languageDropdown = document.getElementById('languageDropdown');
    if (!languageDropdown) return;
    
    languageDropdown.innerHTML = '';
    
    const languages = getFallbackLanguages();
    
    languages.forEach(lang => {
        const option = document.createElement('div');
        option.className = `language-option ${lang.code === currentLanguage ? 'active' : ''}`;
        option.setAttribute('data-lang', lang.code);
        
        option.innerHTML = `
            <span class="flag">${lang.flag}</span>
            <span>${lang.name}</span>
            ${lang.code === currentLanguage ? '<i class="fas fa-check"></i>' : ''}
        `;
        
        option.addEventListener('click', function() {
            translatePage(lang.code);
            languageDropdown.classList.remove('show');
        });
        
        languageDropdown.appendChild(option);
    });
}
        
// Dinamik konum se√ßenekleri event'leri
function setupDynamicLocationOptionEvents() {
    document.querySelectorAll('.location-option').forEach(option => {
        option.addEventListener('click', function() {
            const locationType = this.getAttribute('data-location');
            
            document.querySelectorAll('.location-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            this.classList.add('selected');
            
            if (locationType === 'inside' || locationType === 'takeaway') {
                selectDynamicLocation(locationType);
            } else {
                // Adrese teslim i√ßin konum tespiti
                detectUserLocation().then(success => {
                    if (success) {
                        selectDynamicLocation('delivery');
                    }
                });
            }
        });
    });
    
    const detectBtn = document.getElementById('detectLocationBtn');
    if (detectBtn) {
        detectBtn.addEventListener('click', function() {
            detectUserLocation().then(success => {
                if (success) {
                    const deliveryOption = document.querySelector('.location-option[data-location="delivery"]');
                    if (deliveryOption) {
                        document.querySelectorAll('.location-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        deliveryOption.classList.add('selected');
                        selectDynamicLocation('delivery');
                    }
                }
            });
        });
    }
}

// Konum tespiti
async function detectUserLocation() {
    const resultDiv = document.getElementById('locationResult');
    const detectBtn = document.getElementById('detectLocationBtn');
    
    if (!navigator.geolocation) {
        showLocationError("Tarayƒ±cƒ±nƒ±z konum servisini desteklemiyor.");
        return false;
    }
    
    if (detectBtn) {
        detectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Konumunuz Belirleniyor...';
        detectBtn.disabled = true;
    }
    
    if (resultDiv) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div style="color: #007bff;"><i class="fas fa-spinner fa-spin"></i> Konumunuz belirleniyor...</div>';
    }
    
    try {
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            });
        });
        
        const { latitude, longitude } = position.coords;
        const address = await reverseGeocode(latitude, longitude);
        
        userLocation = {
            latitude,
            longitude,
            address: address.display_name,
            city: address.address?.city || address.address?.town || address.address?.village || 'Bilinmeyen',
            district: address.address?.suburb || address.address?.county || address.address?.state_district || 'Bilinmeyen',
            fullAddress: address.display_name
        };
        
        isLocationDetected = true;
        
        if (resultDiv) {
            resultDiv.innerHTML = `
                <div style="color: var(--success);">
                    <i class="fas fa-check-circle"></i> 
                    <strong>Konumunuz Belirlendi!</strong>
                    <div style="font-size: 12px; margin-top: 5px;">
                        ${userLocation.district}, ${userLocation.city}
                    </div>
                </div>
            `;
        }
        
        debugLog('üìç Konum tespit edildi:', userLocation);
        return true;
        
    } catch (error) {
        console.error('Konum tespit hatasƒ±:', error);
        showLocationError("Konumunuz belirlenemedi. L√ºtfen tarayƒ±cƒ± ayarlarƒ±nƒ±zdan konum eri≈üimine izin verin.");
        return false;
    } finally {
        if (detectBtn) {
            detectBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Konumumu Otomatik Belirle';
            detectBtn.disabled = false;
        }
    }
}

// Reverse geocoding
async function reverseGeocode(lat, lon) {
    try {
        const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1&zoom=18`
        );
        
        if (!response.ok) {
            throw new Error('Adres √ß√∂z√ºmleme hatasƒ±');
        }
        
        return await response.json();
    } catch (error) {
        console.error('Reverse geocoding hatasƒ±:', error);
        return {
            display_name: `Konum: ${lat.toFixed(6)}, ${lon.toFixed(6)}`,
            address: {
                city: 'Bilinmeyen',
                town: 'Bilinmeyen',
                village: 'Bilinmeyen',
                suburb: 'Bilinmeyen'
            }
        };
    }
}

// Konum hatasƒ± g√∂ster
function showLocationError(message) {
    const resultDiv = document.getElementById('locationResult');
    if (resultDiv) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div style="color: #dc3545;">
                <i class="fas fa-exclamation-triangle"></i> 
                ${message}
            </div>
        `;
    }
    speakToUser("Konumunuz tespit edilemedi.");
}

// Konum modalƒ±nƒ± gizle
function hideDynamicLocationModal() {
    const modal = document.getElementById('locationModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    }
}

// Konum metnini g√ºncelle
function updateDynamicLocationText() {
    if (locationText && selectedLocation) {
        const locationNames = {
            'inside': 'Restoran i√ßinde',
            'takeaway': 'Paket servis', 
            'delivery': 'Adrese teslim'
        };
        
        let locationTextContent = locationNames[selectedLocation] || selectedLocation;
        
        if (selectedLocation === 'delivery' && userLocation.city) {
            locationTextContent += ` - ${userLocation.district}, ${userLocation.city}`;
        }
        
        locationText.textContent = locationTextContent;
    }
}

// Dinamik konum y√∂netimi
function initializeDynamicLocation() {
    debugLog('üìç Dinamik konum y√∂netimi ba≈ülatƒ±lƒ±yor...');
    
    // Kayƒ±tlƒ± konumu kontrol et
    const savedLocation = localStorage.getItem('selectedLocation');
    const savedUserLocation = localStorage.getItem('userLocation');
    
    if (savedLocation) {
        selectedLocation = savedLocation;
        if (savedUserLocation) {
            userLocation = JSON.parse(savedUserLocation);
            isLocationDetected = true;
        }
        updateDynamicLocationText();
        currentRoot = "2:0";
        loadAllSellersByLocation();
    } else {
        // Konum modalƒ±nƒ± g√∂ster
        setTimeout(() => {
            showDynamicLocationModal();
        }, 1000);
    }
}

// Maƒüaza tipine g√∂re satƒ±cƒ±larƒ± filtrele
function filterSellersByStoreType(storeTypeId) {
    console.log(`üîç Maƒüaza tipine g√∂re filtreleme: ${storeTypeId}`);
    
    if (storeTypeId === 'all') {
        // T√ºm satƒ±cƒ±larƒ± g√∂ster
        filteredSellersByStoreType = [...allSellersInLocation];
    } else {
        // Se√ßilen maƒüaza tipine g√∂re filtrele
        filteredSellersByStoreType = allSellersInLocation.filter(seller => 
            seller.store_type_id == storeTypeId
        );
    }
    
    // Filtrelenmi≈ü satƒ±cƒ±larƒ± ana listeye ata
    sellers = filteredSellersByStoreType;
    
    // UI'ƒ± g√ºncelle
    updateSellersGrid();
    
    // Ba≈ülƒ±ƒüƒ± g√ºncelle
    if (sellersSection) {
        const storeTypeName = getStoreTypeName(storeTypeId);
        sellersSection.querySelector('.section-title').innerHTML = `
            <i class="fas fa-store"></i>
            ${storeTypeName} Satƒ±cƒ±larƒ± (${filteredSellersByStoreType.length} adet)
        `;
    }
    
    console.log(`‚úÖ Filtrelenmi≈ü satƒ±cƒ±lar: ${filteredSellersByStoreType.length} adet`);
}
// Maƒüaza tipi adƒ±nƒ± getir
function getStoreTypeName(storeTypeId) {
    if (storeTypeId === 'all') return 'T√ºm';
    
    const storeType = storeTypes.find(st => st.id == storeTypeId);
    return storeType ? storeType.name : 'Se√ßilen';
}
        
// =============================================
// T√úM SATICILARI KONUMA G√ñRE Y√úKLE - D√úZELTƒ∞LMƒ∞≈û
// =============================================
async function loadAllSellersByLocation() {
    try {
        debugLog(`üîç T√ºm satƒ±cƒ±lar y√ºkleniyor (filtresiz)`);
        
        // store_types deƒüil store_type ili≈ükisi var
        let query = supabase
            .from('seller_profiles')
            .select(`
                *,
                store_type(*)  // TEKƒ∞L - store_types deƒüil store_type
            `)
            .eq('status', true);

        // Konum bilgisi varsa filtrele
        if (userLocation.city && userLocation.district) {
            const customerCity = userLocation.city;
            const customerDistrict = userLocation.district;
            
            query = query.or(`city.ilike.%${customerCity}%,district.ilike.%${customerDistrict}%,address.ilike.%${customerCity}%,address.ilike.%${customerDistrict}%`);
        }

        query = query.order('business_name', { ascending: true });

        const { data: sellersData, error } = await query;

        if (error) {
            console.error('‚ùå Satƒ±cƒ±lar y√ºkleme hatasƒ±:', error);
            throw error;
        }

        debugLog(`üìä T√ºm satƒ±cƒ±lar: ${sellersData?.length || 0} adet`);

        if (sellersData && sellersData.length > 0) {
            // √áalƒ±≈üma saatlerini cache'le
            sellersData.forEach(seller => {
                if (seller.id) {
                    sellerWorkingHours.set(seller.id, {
                        start_time: seller.start_time,
                        end_time: seller.end_time,
                        status: seller.status,
                        is_open: false
                    });
                }
            });

            // A√ßƒ±k/kapalƒ± durumunu HESAPLA
            const sellersWithStatus = await calculateSellersOpenStatus(sellersData);

            // YENƒ∞ - D√úZELTƒ∞LMƒ∞≈û (doƒürudan item kullan)
            allSellersInLocation = sellersWithStatus.map(seller => ({
            ...seller,  // doƒürudan seller objesi
            store_type_id: seller.store_type?.id || seller.store_type_id,
            store_type_name: seller.store_type?.name,
            working_hours: {
                start_time: seller.start_time,
                end_time: seller.end_time,
                status: seller.status,
                is_open: seller.is_open
    }
}));

            // Teslimat bilgilerini ekle
            await addDeliveryInfoToSellers(allSellersInLocation);
            
            debugLog(`‚úÖ T√ºm satƒ±cƒ±lar y√ºklendi: ${allSellersInLocation.length} adet`);
            
            // T√ºm satƒ±cƒ±larƒ± g√∂ster
            showAllSellers();
            
            speakToUser(`Sistemde ${allSellersInLocation.length} satƒ±cƒ± bulundu.`);
            
        } else {
            debugLog('‚ö†Ô∏è Hi√ß satƒ±cƒ± bulunamadƒ±');
            allSellersInLocation = [];
            showAllSellers();
            speakToUser("Sistemde satƒ±cƒ± bulunamadƒ±.");
        }

    } catch (error) {
        console.error('‚ùå T√ºm satƒ±cƒ±lar y√ºkleme hatasƒ±:', error);
        
        // Fallback: Demo satƒ±cƒ±lar
        allSellersInLocation = getDemoSellers();
        showAllSellers();
        speakToUser("Satƒ±cƒ±lar y√ºklenirken hata olu≈ütu. Demo satƒ±cƒ±lar g√∂steriliyor.");
    }
}

// =============================================
// A√áIK/KAPALI DURUMU HESAPLAMA
// =============================================
    
async function calculateSellersOpenStatus(sellersData) {
    const now = new Date();
    const currentDay = now.getDay(); // 0: Pazar, 1: Pazartesi, ..., 6: Cumartesi
    const currentTime = now.getHours() * 60 + now.getMinutes(); // Dakika cinsinden

    return sellersData.map(seller => {
        // MANUEL KAPALI kontrol√º (seller_profiles.status = false)
        if (seller.status === false) {
            console.log(`üî¥ ${seller.business_name} - MANUEL KAPALI`);
            return {
                ...seller,
                is_open: false
            };
        }

        // √áALI≈ûMA SAATLERƒ∞ kontrol√º
        const isOpenByHours = calculateOpenByWorkingHours(seller, currentDay, currentTime);
        
        return {
            ...seller,
            is_open: isOpenByHours
        };
    });
}

// √áalƒ±≈üma saatlerine g√∂re a√ßƒ±k/kapalƒ± hesapla
function calculateOpenByWorkingHours(seller, currentDay, currentTime) {
    // √áalƒ±≈üma saati yoksa varsayƒ±lan olarak A√áIK
    if (!seller.start_time || !seller.end_time) {
        console.log(`üü° ${seller.business_name} - √áalƒ±≈üma saati tanƒ±mlƒ± deƒüil, A√áIK kabul ediliyor`);
        return true;
    }

    // Zaman formatƒ±nƒ± parse et
    const startTime = parseTimeString(seller.start_time);
    const endTime = parseTimeString(seller.end_time);

    if (!startTime || !endTime) {
        console.log(`üü° ${seller.business_name} - Ge√ßersiz zaman formatƒ±, A√áIK kabul ediliyor`);
        return true;
    }

    // Gece yarƒ±sƒ±nƒ± a≈üan √ßalƒ±≈üma saatleri i√ßin kontrol
    let isOpen = false;
    
    if (endTime > startTime) {
        // Normal √ßalƒ±≈üma saati (aynƒ± g√ºn i√ßinde)
        isOpen = currentTime >= startTime && currentTime <= endTime;
    } else {
        // Gece yarƒ±sƒ±nƒ± a≈üan √ßalƒ±≈üma saati
        isOpen = currentTime >= startTime || currentTime <= endTime;
    }

    const status = isOpen ? 'üü¢ A√áIK' : 'üî¥ KAPALI';
    console.log(`üè™ ${seller.business_name} - ${status} (${formatTime(startTime)}-${formatTime(endTime)})`);
    
    return isOpen;
}
// =============================================
// T√úM SATICILARI G√ñSTER
// =============================================

function showAllSellers() {
    console.log('üè™ T√ºm satƒ±cƒ±lar g√∂steriliyor:', allSellersInLocation.length);
    
    // T√ºm satƒ±cƒ±larƒ± g√∂ster (hen√ºz maƒüaza tipi se√ßilmedi)
    sellers = allSellersInLocation;
    filteredSellersByStoreType = [...allSellersInLocation];
    
    // Satƒ±cƒ± grid'ini g√ºncelle
    updateSellersGrid();
    
    // B√∂l√ºm√º g√∂ster
    if (sellersSection) {
        sellersSection.style.display = 'block';
        sellersSection.querySelector('.section-title').innerHTML = `
            <i class="fas fa-store"></i>
            Konumunuzdaki T√ºm Satƒ±cƒ±lar (${allSellersInLocation.length} adet)
        `;
    }
    
    // Kategori ve √ºr√ºn b√∂l√ºmlerini gizle
    if (categoriesSection) categoriesSection.style.display = 'none';
    if (productsSection) productsSection.style.display = 'none';
    
    displayMessage(`üìç Konumunuzda ${allSellersInLocation.length} satƒ±cƒ± bulundu. Maƒüaza tipi se√ßerek filtreleyebilirsiniz.`);
}
        
// Store type se√ßimini sƒ±fƒ±rla
function resetStoreTypeSelection() {
    document.querySelectorAll('.seller-type-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    selectedStoreTypeId = null;
    selectedStoreTypeName = null;
    debugLog('üîÑ Store type se√ßimi sƒ±fƒ±rlandƒ±');
}

// Satƒ±cƒ±lara teslimat bilgisi ekle
async function addDeliveryInfoToSellers(sellers) {
    if (!sellers || sellers.length === 0) return;
    
    debugLog(`üìç Teslimat bilgileri ekleniyor: ${sellers.length} satƒ±cƒ±`);
    
    for (const seller of sellers) {
        try {
            const { data: deliveryAreas, error } = await supabase
                .from('seller_delivery_areas')
                .select('city, district, delivery_fee, min_order_amount')
                .eq('seller_id', seller.id)
                .eq('is_active', true);

            if (error) continue;

            if (!deliveryAreas || deliveryAreas.length === 0) {
                seller.delivery_fee = 0;
                seller.min_order_amount = 0;
                seller.delivery_available = true;
                continue;
            }

            const matchedArea = deliveryAreas.find(area => {
                const areaCity = (area.city || '').toLowerCase();
                const areaDistrict = (area.district || '').toLowerCase();
                const userCity = (userLocation.city || '').toLowerCase();
                const userDistrict = (userLocation.district || '').toLowerCase();
                
                const cityMatch = areaCity.includes(userCity) || userCity.includes(areaCity);
                const districtMatch = areaDistrict.includes(userDistrict) || userDistrict.includes(areaDistrict);
                
                return cityMatch && districtMatch;
            });

            if (matchedArea) {
                seller.delivery_fee = matchedArea.delivery_fee || 0;
                seller.min_order_amount = matchedArea.min_order_amount || 0;
                seller.delivery_available = true;
            } else {
                seller.delivery_fee = null;
                seller.min_order_amount = null;
                seller.delivery_available = false;
            }

        } catch (error) {
            console.error(`Teslimat bilgisi ekleme hatasƒ± (${seller.business_name}):`, error);
            seller.delivery_fee = 0;
            seller.min_order_amount = 0;
            seller.delivery_available = true;
        }
    }
}

// =============================================
// DEMO SATICILAR (FALLBACK)
// =============================================

function getDemoSellers() {
    return [
        {
            id: "demo-1",
            business_name: "Demo Market",
            city: "Batum",
            district: "Merkez",
            store_image: null,
            delivery_available: true,
            delivery_fee: 5,
            min_order_amount: 20,
            rating: 4.5,
            store_type_id: 1,
            store_type_name: "Market",
            working_hours: {
                start_time: "08:00",
                end_time: "22:00",
                status: true,
                is_open: true
            }
        },
        {
            id: "demo-2",
            business_name: "Demo Restoran",
            city: "Batum", 
            district: "Sahil",
            store_image: null,
            delivery_available: true,
            delivery_fee: 8,
            min_order_amount: 25,
            rating: 4.2,
            store_type_id: 2,
            store_type_name: "Restoran",
            working_hours: {
                start_time: "10:00",
                end_time: "23:00",
                status: true,
                is_open: true
            }
        }
    ];
}
        // Reyonalarƒ± y√ºkle
async function loadReyonsBySeller(sellerId) {
    try {
        debugLog(`üì¶ Satƒ±cƒ±ya g√∂re reyonlar y√ºkleniyor: ${sellerId}`);
        
        const { data, error } = await supabase
            .from('reyon')
            .select('*')
            .order('name');

        if (error) throw error;

        debugLog(`üìä REYON SONU√á: ${data?.length || 0} reyon bulundu`);
        
        categories = data || [];
        displayCategories(categories);
        
        debugLog(`‚úÖ Satƒ±cƒ± reyonlarƒ± y√ºklendi: ${categories.length} adet`);
        
        if (categories.length === 0) {
            speakToUser("Bu satƒ±cƒ±da reyon bulunamadƒ±.");
        }

    } catch (error) {
        console.error('‚ùå Reyon y√ºkleme hatasƒ±:', error);
        categories = getDemoReyons();
        displayCategories(categories);
        speakToUser("Reyonlar y√ºklenirken hata olu≈ütu. Demo reyonlar g√∂steriliyor.");
    }
}

// Demo reyonlar
function getDemoReyons() {
    return [
        { id: 1, name: 'Meyve & Sebze' },
        { id: 2, name: 'S√ºt √úr√ºnleri' },
        { id: 3, name: 'Et & Tavuk' },
        { id: 4, name: 'Temel Gƒ±da' }
    ];
}

// √úr√ºnleri y√ºkle
// √úr√ºnleri satƒ±cƒ± ve reyon bazlƒ± y√ºkle
async function loadProductsByReyon(reyonId) {
  try {
    debugLog(`üõí Reyona g√∂re √ºr√ºnler y√ºkleniyor: ${reyonId}, Satƒ±cƒ±: ${selectedSellerId}`);

    if (!selectedSellerId) {
      speakToUser("√ñnce bir satƒ±cƒ± se√ßmelisiniz.");
      return;
    }

    // product_prices + products JOIN sorgusu
    const { data, error } = await supabase
      .from('product_prices')
      .select(`
        id,
        price,
        discount_price,
        stock,
        currency,
        seller_id,
        product_id,
        products (
          id,
          name,
          description,
          imgurl,
          reyon_id,
          unit_type,
          tax_rate,
          is_active
        )
      `)
      .eq('seller_id', selectedSellerId)
      .order('created', { ascending: false });

    if (error) throw error;

    // Gelen √ºr√ºnleri filtrele (aktif + doƒüru reyon)
    const filtered = (data || []).filter(
      p => p.products?.is_active && p.products?.reyon_id === reyonId
    );

    debugLog(`üìä √úR√úN SONU√á: ${filtered.length} √ºr√ºn bulundu`);

    // Ekrana basƒ±lacak √ºr√ºn listesi
    products = filtered.map(p => ({
      id: p.products.id,
      name: p.products.name,
      description: p.products.description,
      price: parseFloat(p.price),
      discount_price: parseFloat(p.discount_price) || null,
      imgurl: p.products.imgurl,
      reyon_id: p.products.reyon_id,
      unit_type: p.products.unit_type,
      tax_rate: parseFloat(p.products.tax_rate) || 0,
      product_price_id: p.id,
      seller_id: p.seller_id,
      currency: p.currency
    }));

    debugLog(`‚úÖ √úr√ºnler y√ºklendi: ${products.length} adet`);
    displayProducts(products);

    if (productsSection) productsSection.style.display = 'block';
    if (categoriesSection) categoriesSection.style.display = 'none';

    if (products.length === 0) {
      speakToUser("Bu reyonda √ºr√ºn bulunamadƒ±.");
    } else {
      speakToUser(`${products.length} √ºr√ºn bulundu. Sesli olarak sipari≈ü verebilirsiniz.`);
    }

  } catch (error) {
    console.error('‚ùå √úr√ºn y√ºkleme hatasƒ±:', error);
    products = getDemoProducts();
    displayProducts(products);
    speakToUser("√úr√ºnler y√ºklenirken hata olu≈ütu. Demo √ºr√ºnler g√∂steriliyor.");
  }
}

// Demo √ºr√ºnler
function getDemoProducts() {
    return [
        { 
            id: 'demo-1', 
            name: "S√ºt 1L", 
            price: 15.90, 
            discount_price: 12.90,
            imgurl: "https://via.placeholder.com/150x100?text=S√ºt",
            unit_type: "adet"
        },
        { 
            id: 'demo-2', 
            name: "Ekmek", 
            price: 5.50, 
            discount_price: null,
            imgurl: "https://via.placeholder.com/150x100?text=Ekmek",
            unit_type: "adet"
        }
    ];
}

// UI temizleme
function resetProductAndCategoryUI() {
    if (categoriesGrid) {
        categoriesGrid.innerHTML = '<div class="text-center">Y√ºkleniyor...</div>';
    }
    if (productsGrid) {
        productsGrid.innerHTML = '<div class="text-center">Bir reyon se√ßin</div>';
    }
    if (productsSection) productsSection.style.display = 'none';
}

// Sepet i≈ülemleri
function toggleDynamicCart() {
    if (cartContainer.classList.contains('open')) {
        closeDynamicCart();
    } else {
        openDynamicCart();
    }
}

function openDynamicCart() {
    if (cartContainer) {
        cartContainer.classList.add('open');
    }
}

function closeDynamicCart() {
    if (cartContainer) {
        cartContainer.classList.remove('open');
    }
}

// G√ºncellenmi≈ü restoreSession
async function restoreSession() {
    try {
        const savedCustomer = localStorage.getItem('currentCustomer');
        if (savedCustomer) {
            currentCustomer = JSON.parse(savedCustomer);
        }
        
        const savedCart = localStorage.getItem('cart');
        if (savedCart) {
            cart = JSON.parse(savedCart);
            console.log('üì¶ Oturumdan sepet y√ºklendi:', cart.length, '√ºr√ºn');
        } else {
            cart = []; // Emin olmak i√ßin bo≈ü array
            console.log('üì¶ Sepet oturumda bulunamadƒ±, bo≈ü array olu≈üturuldu');
        }
        
        // Kilit durumunu geri y√ºkle
        const savedLock = localStorage.getItem('isSellerLocked');
        isSellerLocked = savedLock === 'true';
        
        console.log('üîí Oturum kilit durumu:', isSellerLocked);
        
        // HEMEN G√úNCELLE - oturum y√ºklendikten sonra
        updateCartUI();
        
        debugLog('‚úÖ Oturum geri y√ºklendi');
    } catch (error) {
        console.error('Oturum geri y√ºkleme hatasƒ±:', error);
        cart = []; // Hata durumunda bo≈ü sepet
        isSellerLocked = false; // Hata durumunda kilit kapalƒ±
    }
}
        


// Sesli komutlara sepeti bo≈üaltma ekle
function setupClearCartVoiceCommand() {
    // handleDynamicAIRequest i√ßinde veya ayrƒ± bir fonksiyonda
    const clearCartCommands = [
        'sepeti bo≈üalt', 'sepeti temizle', 'her ≈üeyi sil', 'sƒ±fƒ±rla',
        'clear cart', 'empty cart', 'reset cart'
    ];
    
    // processVoiceCommand i√ßinde kontrol et
    if (clearCartCommands.some(cmd => message.includes(cmd))) {
        clearCart();
        return true;
    }
    
    return false;
}


        
        
// Acil durum modu
function dynamicEmergencyFallback() {
    debugLog('üÜò Dinamik acil durum modu aktif');
    setupDynamicLocationEvents();
    
    if (!selectedLocation) {
        setTimeout(() => {
            showDynamicLocationModal();
        }, 2000);
    }
}

// DOM elementlerini bekle
function waitForDOMElements() {
    return new Promise((resolve) => {
        const elements = {
            'microphoneToggle': document.getElementById('microphoneToggle'),
            'locationModal': document.getElementById('locationModal'),
            'locationMarker': document.getElementById('locationMarker')
        };

        let attempts = 0;
        const maxAttempts = 50;

        const checkElements = () => {
            attempts++;
            const loaded = Object.values(elements).filter(el => el !== null).length;
            const total = Object.keys(elements).length;

            debugLog(`DOM y√ºkleme: ${loaded}/${total} (deneme ${attempts})`);

            if (loaded >= 2 || attempts >= maxAttempts) {
                debugLog('‚úÖ Minimum DOM elementleri y√ºklendi');
                resolve();
                return;
            }

            setTimeout(checkElements, 100);
        };

        checkElements();
    });
}



        // Kƒ±sa √∂rnek - geri kalanlar √∂nceki cevaptan alƒ±nacak
        async function loadStoreTypes() {
            try {
                const { data, error } = await supabase
                    .from('store_type')
                    .select('*')
                    .eq('status', 'Active')
                    .order('sort_code');

                if (error) throw error;

                if (data && data.length > 0) {
                    storeTypes = data;
                    displayStoreTypes(storeTypes);
                    debugLog(`‚úÖ StoreTypes y√ºklendi: ${data.length} adet`);
                }
            } catch (error) {
                console.error('‚ùå StoreTypes y√ºkleme hatasƒ±:', error);
            }
        }

        // Sayfa y√ºklendiƒüinde uygulamayƒ± ba≈ülat
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM y√ºklendi, dinamik uygulama ba≈ülatƒ±lƒ±yor...');
            initApp();
        });

        
// =============================================
// √ñDEME ve Sƒ∞PARƒ∞≈û TAMAMLAMA Sƒ∞STEMƒ∞ (SESLƒ∞ + TIKLAMA)
// =============================================

function checkProductCommands(command) {
    // Eƒüer √∂deme s√ºrecindeysek, √ºr√ºn komutlarƒ±nƒ± i≈üleme
    if (currentPaymentMethod) {
        console.log('‚è∏Ô∏è √ñdeme s√ºrecinde, √ºr√ºn komutlarƒ± pasif');
        return false;
    }
    
    // Mevcut √ºr√ºn ekleme mantƒ±ƒüƒ±nƒ± buraya ta≈üƒ±
    const productMatch = extractProductInfoFromCommand(command);
    if (productMatch) {
        addToCart(productMatch.product, productMatch.quantity, productMatch.unitType);
        return true;
    }
    
    return false;
}
        
// √ñdeme butonlarƒ±na event listener EKLE - HEM SESLƒ∞ HEM TIKLAMA
// setupPaymentButtons fonksiyonunu deƒüi≈ütir - yeni fonksiyon
function setupPaymentButtons() {
    console.log('üí≥ √ñdeme butonlarƒ± kuruluyor...');
    
    const payCashBtn = document.getElementById('payCash');
    const payCardBtn = document.getElementById('payCard');
    const payBonusBtn = document.getElementById('payBonus');
    
    if (payCashBtn) {
        payCashBtn.addEventListener('click', () => {
            console.log('üí≥ Nakit √∂deme butonuna tƒ±klandƒ±');
            startPaymentProcess('cash');
        });
    }
    if (payCardBtn) {
        payCardBtn.addEventListener('click', () => {
            console.log('üí≥ Kart √∂deme butonuna tƒ±klandƒ±');
            startPaymentProcess('card');
        });
    }
    if (payBonusBtn) {
        payBonusBtn.addEventListener('click', () => {
            console.log('üí≥ Bonus √∂deme butonuna tƒ±klandƒ±');
            startPaymentProcess('bonus');
        });
    }
    
    console.log('üí≥ √ñdeme butonlarƒ± aktif: Sesli + Tƒ±klama');
}

// √ñdeme y√∂ntemi isimlerini getir
function getPaymentMethodName(method) {
    const names = {
        'cash': 'Nakit',
        'card': 'Kart', 
        'bonus': 'Bonus'
    };
    return names[method] || '√ñdeme';
}

// =============================================
// EKSƒ∞K FONKSƒ∞YON: showPaymentModal
// =============================================
// √ñDEME MODALI A√áMA FONKSƒ∞YONU
function showPaymentModal() {
    console.log('üí∞ √ñdeme modalƒ± a√ßƒ±lƒ±yor...');
    
    try {
        // Modal i√ßeriƒüini olu≈ütur
        const modalContent = `
            <div class="payment-modal" id="paymentModal">
                <div class="modal-content">
                    <span class="close-btn" onclick="closePaymentModal()">&times;</span>
                    <h3>üí≥ √ñdeme Y√∂ntemi Se√ßin</h3>
                    <div class="payment-options">
                        <button onclick="selectPaymentMethod('cash')" class="payment-btn">
                            üíµ Nakit
                        </button>
                        <button onclick="selectPaymentMethod('card')" class="payment-btn">
                            üí≥ Kart ile √ñde
                        </button>
                        <button onclick="selectPaymentMethod('bonus')" class="payment-btn">
                            üéÅ Bonus ile √ñde
                        </button>
                    </div>
                    <p class="voice-hint">"Nakit", "Kart" veya "Bonus" diyebilirsiniz</p>
                </div>
            </div>
        `;
        
        // Modalƒ± g√∂ster
        document.body.insertAdjacentHTML('beforeend', modalContent);
        console.log('‚úÖ √ñdeme modalƒ± olu≈üturuldu');
        
        // Sesli komutlarƒ± kur
        setupPaymentVoiceCommands();
        
    } catch (error) {
        console.error('‚ùå √ñdeme modalƒ± hatasƒ±:', error);
        displayMessage("‚ùå √ñdeme sistemi ge√ßici olarak kullanƒ±lamƒ±yor.");
    }
}

// √ñDEME Y√ñNTEMƒ∞ SE√áƒ∞Mƒ∞
function selectPaymentMethod(method) {
    console.log(`üí∞ √ñdeme y√∂ntemi se√ßildi: ${method}`);
    
    try {
        currentPaymentMethod = method;
        
        if (method === 'bonus') {
            showBonusPaymentSelection();
        } else {
            // Nakit veya kart i√ßin direkt telefon numarasƒ± iste
            requestPhoneNumber();
        }
        
        // Modalƒ± kapat
        closePaymentModal();
        
    } catch (error) {
        console.error('‚ùå √ñdeme y√∂ntemi se√ßim hatasƒ±:', error);
        displayMessage("‚ùå √ñdeme y√∂ntemi se√ßilemedi. L√ºtfen tekrar deneyin.");
    }
}

// =============================================
// Dƒ∞ƒûER EKSƒ∞K FONKSƒ∞YONLAR (SADECE EKSƒ∞K OLANLAR)
// =============================================

function selectPaymentMethod(method) {
    console.log(`üí∞ √ñdeme y√∂ntemi se√ßildi: ${method}`);
    currentPaymentMethod = method;
    closePaymentModal();
    
    if (method === 'bonus') {
        showBonusPaymentSelection();
    } else {
        requestPhoneNumber();
    }
}

function closePaymentModal() {
    console.log('‚ùå √ñdeme modalƒ± kapatƒ±lƒ±yor...');
    
    try {
        const modal = document.getElementById('paymentModal');
        if (modal) {
            modal.style.display = 'none';
            modal.remove(); // DOM'dan tamamen kaldƒ±r
            console.log('‚úÖ Modal DOMdan kaldƒ±rƒ±ldƒ±');
        }
        
        // Sesli komutlarƒ± temizle
        if (typeof window.restoreBonusCommands === 'function') {
            window.restoreBonusCommands();
            console.log('‚úÖ Bonus komutlarƒ± temizlendi');
        }
        
        // √ñdeme durumunu sƒ±fƒ±rla
        resetPaymentState();
        
    } catch (error) {
        console.error('‚ùå Modal kapatma hatasƒ±:', error);
    }
}

function requestPhoneNumber() {
    console.log('üìû Telefon numarasƒ± isteniyor...');
    displayMessage("üìû L√ºtfen telefon numarasƒ± s√∂yleyin:");
    speakToUser("Telefon numaranƒ±zƒ± s√∂yleyin");
    isWaitingForPhone = true;
    expectedInput = 'phone';
}

// EKSƒ∞K FONKSƒ∞YONU EKLEYELƒ∞M
function formatPhoneNumber(phoneInput) {
    console.log('üìû formatPhoneNumber √ßaƒürƒ±ldƒ±:', phoneInput);
    
    // Mevcut cleanPhoneNumber fonksiyonunu kullan
    const cleanedNumber = cleanPhoneNumber(phoneInput);
    
    if (!cleanedNumber) {
        console.log('‚ùå cleanPhoneNumber ge√ßersiz numara d√∂nd√º');
        return {
            success: false,
            formatted: phoneInput,
            raw: null
        };
    }
    
    console.log('üîß Temizlenmi≈ü numara:', cleanedNumber);
    
    // Formatlƒ± numara olu≈ütur
    const formatted = `+90 ${cleanedNumber.substring(0, 3)} ${cleanedNumber.substring(3, 6)} ${cleanedNumber.substring(6, 8)} ${cleanedNumber.substring(8, 10)}`;
    
    console.log('‚úÖ Formatlanmƒ±≈ü numara:', formatted);
    return {
        success: true,
        formatted: formatted,
        raw: cleanedNumber
    };
}


        

    // EƒûER cleanPhoneNumber YOKSA BUNU EKLEYƒ∞N
function cleanPhoneNumber(phone) {
    console.log('üßπ cleanPhoneNumber √ßaƒürƒ±ldƒ±:', phone);
    
    // Rakamlarƒ± al
    let cleaned = phone.replace(/\D/g, '');
    
    // "nakit", "kart" gibi √∂deme kelimelerini filtrele
    const paymentWords = ['nakit', 'kart', 'bonus', '√∂deme', '√∂de', 'toplam', 'tutar'];
    if (paymentWords.some(word => phone.toLowerCase().includes(word))) {
        console.log('‚ùå √ñdeme kelimesi i√ßeriyor, ge√ßersiz');
        return null;
    }
    
    // 10 haneli (5416337291)
    if (cleaned.length === 10 && cleaned.startsWith('5')) {
        return cleaned;
    }
    
    // 11 haneli (05416337291) - ba≈ütaki 0'ƒ± kaldƒ±r
    if (cleaned.length === 11 && cleaned.startsWith('05')) {
        return cleaned.substring(1);
    }
    
    console.log('‚ùå Ge√ßersiz telefon formatƒ±');
    return null;
}    
        
// =============================================
// TESLƒ∞MAT MESAFE HESAPLAMA Sƒ∞STEMƒ∞
// =============================================

// Mesafe hesaplama fonksiyonu (Haversine form√ºl√º)
function calculateDistance(lat1, lon1, lat2, lon2) {
    console.log('üìç Mesafe hesaplanƒ±yor:', { lat1, lon1, lat2, lon2 });
    
    const R = 6371; // D√ºnya yarƒ±√ßapƒ± (km)
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
    
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R * c; // Kilometre cinsinden mesafe
    
    console.log(`üìè Hesaplanan mesafe: ${distance.toFixed(2)} km`);
    return distance;
}

// Teslimat b√∂lgesi kontrol√º
async function checkDeliveryArea(sellerId, userLat, userLon) {
    console.log(`üè™ Teslimat b√∂lgesi kontrol√º: Satƒ±cƒ± ${sellerId}`);
    
    try {
        // UUID formatƒ±nƒ± kontrol et ve d√ºzelt
        let validSellerId = sellerId;
        
        // Eƒüer sellerId string deƒüilse veya UUID formatƒ±nda deƒüilse
        if (typeof sellerId !== 'string' || !sellerId.includes('-')) {
            console.log('‚ö†Ô∏è Seller ID UUID formatƒ±nda deƒüil, stringe √ßevriliyor:', sellerId);
            validSellerId = sellerId.toString();
        }
        
        // Satƒ±cƒ±nƒ±n teslimat b√∂lgelerini getir
        const { data: deliveryAreas, error } = await supabase
            .from('seller_delivery_areas')
            .select('*')
            .eq('seller_id', validSellerId)
            .eq('is_active', true);

        if (error) {
            console.error('‚ùå Teslimat b√∂lgeleri sorgu hatasƒ±:', error);
            // Hata durumunda devam et
        }

        // Satƒ±cƒ± bilgilerini getir
        const { data: seller, error: sellerError } = await supabase
            .from('seller_profiles')
            .select('latitude, longitude, max_delivery_distance')
            .eq('id', validSellerId)
            .single();

        if (sellerError) {
            console.error('‚ùå Satƒ±cƒ± bilgisi sorgu hatasƒ±:', sellerError);
            // Hata durumunda varsayƒ±lan deƒüerlerle devam et
        }

        // 1. √ñzel teslimat b√∂lgeleri kontrol√º
        if (deliveryAreas && deliveryAreas.length > 0) {
            for (const area of deliveryAreas) {
                // Eƒüer b√∂lge koordinatlarƒ± yoksa atla
                if (!area.latitude || !area.longitude) continue;
                
                const distance = calculateDistance(
                    area.latitude, area.longitude,
                    userLat, userLon
                );
                
                if (distance <= (area.radius_km || 10)) {
                    console.log(`‚úÖ Teslimat b√∂lgesi i√ßinde: ${area.area_name || 'Bilinmeyen B√∂lge'}`);
                    return {
                        allowed: true,
                        distance: distance,
                        areaName: area.area_name,
                        deliveryFee: area.delivery_fee || 0,
                        message: `${area.area_name || 'B√∂lge'} - Teslimat √ºcreti: ${money(area.delivery_fee || 0)}`
                    };
                }
            }
            
            console.log('‚ùå Hi√ßbir teslimat b√∂lgesi i√ßinde deƒüil');
            return {
                allowed: false,
                distance: null,
                message: "Maalesef, bu konum satƒ±cƒ±nƒ±n teslimat b√∂lgesi dƒ±≈üƒ±nda."
            };
        }

        // 2. Genel mesafe kontrol√º (max_delivery_distance)
        if (seller && seller.latitude && seller.longitude) {
            const distance = calculateDistance(
                seller.latitude, seller.longitude,
                userLat, userLon
            );
            
            const maxDistance = seller.max_delivery_distance || 10; // Varsayƒ±lan 10km
            
            if (distance <= maxDistance) {
                console.log(`‚úÖ Teslimat mesafesi uygun: ${distance.toFixed(2)}/${maxDistance}km`);
                
                // Mesafe bazlƒ± teslimat √ºcreti hesapla
                const deliveryFee = calculateDeliveryFeeByDistance(distance, validSellerId);
                
                return {
                    allowed: true,
                    distance: distance,
                    deliveryFee: deliveryFee,
                    message: `Teslimat mesafesi: ${distance.toFixed(1)}km - √úcret: ${money(deliveryFee)}`
                };
            } else {
                console.log(`‚ùå Teslimat mesafesi a≈üƒ±ldƒ±: ${distance.toFixed(2)}/${maxDistance}km`);
                return {
                    allowed: false,
                    distance: distance,
                    message: `Maalesef, konumunuz √ßok uzak (${distance.toFixed(1)}km). Maksimum teslimat mesafesi: ${maxDistance}km.`
                };
            }
        }

        // 3. Konum bilgisi yoksa varsayƒ±lan olarak kabul et
        console.log('‚ö†Ô∏è Konum bilgisi yok, varsayƒ±lan teslimat √ºcreti uygulanƒ±yor');
        return {
            allowed: true,
            distance: null,
            deliveryFee: 5, // Varsayƒ±lan teslimat √ºcreti
            message: "Teslimat √ºcreti: 5 TL"
        };

    } catch (error) {
        console.error('‚ùå Teslimat b√∂lgesi kontrol hatasƒ±:', error);
        // Hata durumunda teslimatƒ± kabul et (g√ºvenli mod)
        return {
            allowed: true,
            distance: null,
            deliveryFee: 5,
            message: "Teslimat √ºcreti: 5 TL"
        };
    }
}
// Mesafe bazlƒ± teslimat √ºcreti hesaplama
function calculateDeliveryFeeByDistance(distance, sellerId) {
    console.log(`üí∞ Mesafe bazlƒ± teslimat √ºcreti: ${distance.toFixed(2)}km`);
    
    // Varsayƒ±lan √ºcret tablosu
    const feeStructure = [
        { maxDistance: 2, fee: 0 },    // 0-2 km: √úcretsiz
        { maxDistance: 5, fee: 5 },    // 2-5 km: 5 TL
        { maxDistance: 10, fee: 10 },  // 5-10 km: 10 TL
        { maxDistance: 15, fee: 15 },  // 10-15 km: 15 TL
        { maxDistance: 20, fee: 20 }   // 15-20 km: 20 TL
    ];
    
    for (const tier of feeStructure) {
        if (distance <= tier.maxDistance) {
            return tier.fee;
        }
    }
    
    // 20km'den fazla ise mesafe ba≈üƒ±na 2 TL
    return 20 + Math.ceil((distance - 20)) * 2;
}
        
// =============================================
// √ñDEME BUTONLARI ƒ∞√áƒ∞N MANUEL ƒ∞≈ûLEYƒ∞≈û
// =============================================        
function checkPaymentCommands(command) {
    const paymentKeywords = {
        'nakit': 'cash',
        'kart': 'card', 
        'bonus': 'bonus',
        '√∂deme': 'cash',
        '√∂de': 'cash'
    };
    
    for (const [keyword, method] of Object.entries(paymentKeywords)) {
        if (command.includes(keyword)) {
            console.log(`üí∞ √ñdeme komutu algƒ±landƒ±: ${keyword} -> ${method}`);
            
            // Eƒüer √∂deme s√ºrecinde deƒüilsek ba≈ülat
            if (!currentPaymentMethod) {
                startPaymentProcess(method);
            }
            return true;
        }
    }
    
    return false;
}
        
    function startPaymentProcess(paymentMethod) {
    console.log(`üí∞ √ñdeme s√ºreci ba≈ülatƒ±lƒ±yor: ${paymentMethod}`);
    
    if (cart.length === 0) {
        displayMessage("‚ùå Sepetiniz bo≈ü. √ñdeme yapabilmek i√ßin sepete √ºr√ºn ekleyin.");
        speakToUser("Sepetiniz bo≈ü");
        return;
    }
    
    currentPaymentMethod = paymentMethod;
    
    // √ñdeme modalƒ±nƒ± g√∂ster
    showPaymentModal();
    
    // BONUS √ñDEME ƒ∞SE √ñNCE BONUS SE√áƒ∞Mƒ∞, SONRA TELEFON
    if (paymentMethod === 'bonus') {
        showBonusPaymentSelection();
    } else {
        // NAKƒ∞T/KART ƒ∞SE DOƒûRUDAN TELEFON SOR
        requestPhoneNumber();
    }
}


        
// BONUS √ñDEME SE√áƒ∞Mƒ∞NDE HATA AYIKLAMA
function showBonusPaymentSelection() {
    console.log('üéÅ Bonus √∂deme se√ßimi g√∂steriliyor...');
    
    try {
        const totalAmount = calculateTotal();
        const bonusBalance = currentCustomer ? (currentCustomer.bonus_balance || 0) : 0;
        const remainingAfterBonus = Math.max(0, totalAmount - bonusBalance);
        
        const modalBody = document.getElementById('paymentModalBody');
        if (!modalBody) {
            console.error('‚ùå paymentModalBody bulunamadƒ±!');
            displayMessage("‚ùå √ñdeme sistemi hatasƒ±. L√ºtfen tekrar deneyin.");
            return;
        }
        
        console.log('‚úÖ Modal body bulundu, i√ßerik g√ºncelleniyor...');
        
        // Modal i√ßeriƒüini g√ºncelle (MEVCUT KODUNUZ AYNI)
        modalBody.innerHTML = `
            <div class="bonus-payment-selection">
                <h3>üéÅ Bonus √ñdeme Se√ßimi</h3>
                
                <div class="bonus-info-section">
                    <div class="bonus-summary">
                        <div class="summary-row">
                            <span>Toplam Tutar:</span>
                            <strong>${money(totalAmount)}</strong>
                        </div>
                        <div class="summary-row">
                            <span>Bonus Bakiyeniz:</span>
                            <strong class="bonus-balance">${money(bonusBalance)}</strong>
                        </div>
                        <div class="summary-row">
                            <span>Kalan Bakiye:</span>
                            <strong class="remaining-balance ${remainingAfterBonus > 0 ? 'negative' : 'positive'}">
                                ${money(remainingAfterBonus)}
                            </strong>
                        </div>
                    </div>
                </div>
                
                ${remainingAfterBonus > 0 ? `
                <div class="bonus-payment-options">
                    <h4>${money(remainingAfterBonus)} nasƒ±l √∂demek istersiniz?</h4>
                    <div class="payment-buttons-container">
                        <button type="button" class="payment-option-btn cash-option" onclick="selectBonusRemainingPayment('cash')">
                            üíµ Nakit ile √ñde
                        </button>
                        <button type="button" class="payment-option-btn card-option" onclick="selectBonusRemainingPayment('card')">
                            üí≥ Kart ile √ñde
                        </button>
                    </div>
                </div>
                ` : `
                <div class="full-bonus-success">
                    <div class="success-badge">‚úÖ Tamamƒ± bonus ile √∂denebilir</div>
                    <div class="bonus-action">
                        <button type="button" class="confirm-full-bonus-btn" onclick="confirmFullBonusPayment()">
                            ‚úÖ Tamamƒ± Bonus ile √ñde
                        </button>
                    </div>
                </div>
                `}
                
                <div class="action-buttons">
                    <button type="button" class="btn btn-secondary" onclick="cancelBonusPayment()">
                        ‚ùå ƒ∞ptal
                    </button>
                </div>
            </div>
        `;
        
        console.log('‚úÖ Modal i√ßeriƒüi g√ºncellendi');
        
        // SESLƒ∞ KOMUTLARI AYARLA
        setupBonusPaymentVoiceCommands();
        
    } catch (error) {
        console.error('‚ùå Bonus √∂deme se√ßimi hatasƒ±:', error);
        displayMessage("‚ùå Bonus √∂deme i≈ülemi sƒ±rasƒ±nda hata olu≈ütu.");
        closePaymentModal();
    }
}
        

// BONUS √ñDEME ƒ∞≈ûLEMLERƒ∞Nƒ∞ G√ú√áLENDƒ∞RELƒ∞M
function selectBonusRemainingPayment(method) {
    console.log(`üí∞ Kalan √∂deme y√∂ntemi se√ßildi: ${method}`);
    
    try {
        const totalAmount = calculateTotal();
        const bonusBalance = currentCustomer ? (currentCustomer.bonus_balance || 0) : 0;
        
        window.usedBonusAmount = Math.min(bonusBalance, totalAmount);
        window.remainingPaymentMethod = method;
        
        console.log('‚úÖ Bonus ayarlarƒ± kaydedildi:', {
            usedBonus: window.usedBonusAmount,
            remainingMethod: window.remainingPaymentMethod
        });
        
        // Modalƒ± KESƒ∞NLƒ∞KLE kapat
        closePaymentModal();
        
        // Telefon numarasƒ± iste (biraz gecikmeyle)
        setTimeout(() => {
            requestPhoneNumber();
        }, 300);
        
    } catch (error) {
        console.error('‚ùå Bonus √∂deme se√ßim hatasƒ±:', error);
        displayMessage("‚ùå √ñdeme y√∂ntemi se√ßilemedi.");
        closePaymentModal();
    }
}
function confirmFullBonusPayment() {
    console.log('‚úÖ Tam bonus √∂deme onaylandƒ±');
    
    try {
        const totalAmount = calculateTotal();
        window.usedBonusAmount = totalAmount;
        window.remainingPaymentMethod = null;
        
        console.log('‚úÖ Tam bonus √∂deme ayarlarƒ±:', {
            usedBonus: window.usedBonusAmount,
            remainingMethod: window.remainingPaymentMethod
        });
        
        // Modalƒ± KESƒ∞NLƒ∞KLE kapat
        closePaymentModal();
        
        // Telefon numarasƒ± iste (biraz gecikmeyle)
        setTimeout(() => {
            requestPhoneNumber();
        }, 300);
        
    } catch (error) {
        console.error('‚ùå Tam bonus √∂deme hatasƒ±:', error);
        displayMessage("‚ùå Bonus √∂deme i≈ülemi ba≈üarƒ±sƒ±z.");
        closePaymentModal();
    }
}

        // ACƒ∞L DEBUG FONKSƒ∞YONLARI
function debugPaymentState() {
    console.log('üîç √ñDEME DURUMU DEBUG:');
    console.log('currentPaymentMethod:', currentPaymentMethod);
    console.log('usedBonusAmount:', window.usedBonusAmount);
    console.log('remainingPaymentMethod:', window.remainingPaymentMethod);
    console.log('Modal durumu:', document.getElementById('paymentModal'));
    console.log('Modal body durumu:', document.getElementById('paymentModalBody'));
}

function forceCloseAllModals() {
    console.log('üö® T√úM MODALLARI ZORLA KAPAT');
    
    const modals = document.querySelectorAll('[id*="modal"], [class*="modal"]');
    modals.forEach(modal => {
        modal.style.display = 'none';
        modal.remove();
        console.log('‚úÖ Kapatƒ±lan modal:', modal);
    });
    
    resetPaymentState();
    console.log('‚úÖ T√ºm modallar kapatƒ±ldƒ± ve durum sƒ±fƒ±rlandƒ±');
}        
function proceedToPhoneVerification() {
    console.log('üìû Telefon doƒürulamasƒ±na ge√ßiliyor...');
    
    // Sesli komutlarƒ± temizle
    if (typeof window.restoreBonusCommands === 'function') {
        window.restoreBonusCommands();
    }
    
    // Telefon sorma ekranƒ±na ge√ß
    requestPhoneNumber();
}
        
function closePaymentModal() {
    const paymentModal = document.getElementById('paymentModal');
    if (paymentModal) {
        paymentModal.style.display = 'none';
        resetPaymentState();
    }
}

function resetPaymentState() {
    isWaitingForPhone = false;
    isWaitingForName = false;
    isWaitingForBuilding = false;
    isWaitingForApartment = false;
    isWaitingForAddressConfirm = false;
    isWaitingForNewBuilding = false;
    isWaitingForNewApartment = false;
    isWaitingForOrderConfirm = false;
    expectedInput = null;
    customerPhone = null;
    customerName = null;
    buildingNumber = null;
    apartmentNumber = null;
    useRegisteredAddress = false;
}
        
function checkExpectedInput(command) {
    console.log('üîç Beklenen input kontrol√º:', { 
        command, 
        isWaitingForAddressConfirm, 
        isWaitingForOrderConfirm,
        expectedInput 
    });
    
    // Adres onayƒ± bekleniyorsa
    if (isWaitingForAddressConfirm) {
        console.log('üè† Adres onayƒ± bekleniyor, komut:', command);
        
        if (command.includes('evet') || command === 'evet') {
            processAddressConfirmation('evet');
            return true;
        } else if (command.includes('hayƒ±r') || command === 'hayƒ±r') {
            processAddressConfirmation('hayƒ±r');
            return true;
        } else {
            displayMessage("‚ùå L√ºtfen 'evet' veya 'hayƒ±r' olarak cevap verin");
            speakToUser("evet veya hayƒ±r");
            return true; // Yine de true d√∂n ki √ºr√ºn ekleme kƒ±smƒ±na ge√ßmesin
        }
    }
    
    // Sipari≈ü onayƒ± bekleniyorsa
    if (isWaitingForOrderConfirm) {
        console.log('‚úÖ Sipari≈ü onayƒ± bekleniyor, komut:', command);
        
        if (command.includes('evet') || command === 'evet') {
            processOrderConfirmation('evet');
            return true;
        } else if (command.includes('hayƒ±r') || command === 'hayƒ±r') {
            processOrderConfirmation('hayƒ±r');
            return true;
        } else {
            displayMessage("‚ùå L√ºtfen 'evet' veya 'hayƒ±r' olarak cevap verin");
            speakToUser("evet veya hayƒ±r");
            return true;
        }
    }
    
    // Telefon bekleniyorsa
    if (isWaitingForPhone && expectedInput === 'phone') {
        processPhoneNumber(command);
        return true;
    }
    
    // ƒ∞sim bekleniyorsa
    if (isWaitingForName && expectedInput === 'name') {
        processCustomerName(command);
        return true;
    }
    
    // Bina numarasƒ± bekleniyorsa
    if (isWaitingForBuilding && expectedInput === 'building') {
        processBuildingInfo(command);
        return true;
    }
    
    // Daire numarasƒ± bekleniyorsa
    if (isWaitingForApartment && expectedInput === 'apartment') {
        processApartmentInfo(command);
        return true;
    }
    
    return false;
}


        // SESLƒ∞ VERƒ∞Yƒ∞ INPUT'TA G√ñSTERME FONKSƒ∞YONLARI
function showVoiceInputInField(inputId, value, isSuccess = true) {
    const input = document.getElementById(inputId);
    if (input) {
        input.value = value;
        
        // G√∂rsel feedback
        input.classList.remove('voice-input-success', 'voice-input-error');
        input.classList.add(isSuccess ? 'voice-input-success' : 'voice-input-error');
        
        // 3 saniye sonra normal haline d√∂n
        setTimeout(() => {
            input.classList.remove('voice-input-success', 'voice-input-error');
        }, 3000);
    }
}

   // VEYA processOrderConfirmation YENƒ∞DEN TANIMLAYALIM
async function processOrderConfirmation(response) {
    console.log('‚úÖ Sipari≈ü onayƒ± i≈üleniyor:', response);
    
    // Butonlarƒ± devre dƒ±≈üƒ± bƒ±rak (√ßift tƒ±klamayƒ± √∂nle)
    const yesBtn = document.querySelector('.yes-btn');
    const noBtn = document.querySelector('.no-btn');
    
    if (yesBtn) yesBtn.disabled = true;
    if (noBtn) noBtn.disabled = true;
    
    if (response === 'evet') {
        displayMessage("‚è≥ Sipari≈üiniz onaylanƒ±yor...");
        speakToUser("Sipari≈ü onaylanƒ±yor");
        
        // Bonus √∂deme validasyonu
        if (currentPaymentMethod === 'bonus') {
            const totalAmount = calculateTotal();
            const bonusBalance = currentCustomer ? (currentCustomer.bonus_balance || 0) : 0;
            const usedBonus = window.usedBonusAmount || Math.min(bonusBalance, totalAmount);
            const remainingAmount = totalAmount - usedBonus;
            
            if (remainingAmount > 0 && !window.remainingPaymentMethod) {
                displayMessage("‚ùå L√ºtfen kalan √∂deme y√∂ntemini se√ßin!");
                speakToUser("Kalan √∂deme y√∂ntemi se√ßilmedi");
                
                // Butonlarƒ± tekrar aktif et
                if (yesBtn) yesBtn.disabled = false;
                if (noBtn) noBtn.disabled = false;
                return;
            }
        }
        
        // Sesli komutlarƒ± temizle
        if (typeof window.restoreVoiceCommands === 'function') {
            window.restoreVoiceCommands();
        }
        
        // Sipari≈üi onayla
        try {
            await completeOrder();
            displayMessage("üéâ Sipari≈üiniz onaylandƒ±! Te≈üekk√ºr ederiz.");
            speakToUser("Sipari≈üiniz onaylandƒ±, te≈üekk√ºr ederiz");
        } catch (error) {
            console.error('‚ùå Sipari≈ü tamamlama hatasƒ±:', error);
            displayMessage("‚ùå Sipari≈ü i≈ülenirken hata olu≈ütu.");
            speakToUser("Teknik bir hata olu≈ütu");
        }
        
    } else {
        displayMessage("‚ùå Sipari≈ü iptal edildi.");
        speakToUser("Sipari≈ü iptal edildi");
        
        // Sesli komutlarƒ± temizle
        if (typeof window.restoreVoiceCommands === 'function') {
            window.restoreVoiceCommands();
        }
        
        // Modalƒ± kapat ve temizle
        setTimeout(() => {
            closePaymentModal();
            resetPaymentState();
        }, 2000);
    }
    
    isWaitingForOrderConfirm = false;
}

// EKSƒ∞K FONKSƒ∞YONLARI TANIMLAYALIM (eƒüer yoksa)
if (typeof completeOrder === 'undefined') {
    async function completeOrder() {
        console.log('‚úÖ Sipari≈ü tamamlanƒ±yor...');
        
        try {
            // Sipari≈ü verilerini hazƒ±rla
            const orderData = {
                customer_id: currentCustomer?.id,
                seller_id: selectedSellerId,
                products: cart,
                total_amount: calculateTotal(),
                payment_method: currentPaymentMethod,
                used_bonus: window.usedBonusAmount || 0,
                remaining_payment_method: window.remainingPaymentMethod,
                address: currentAddress
            };
            
            // API'ye g√∂nder
            const response = await submitOrderToAPI(orderData);
            
            if (response.success) {
                console.log('üéâ Sipari≈ü ba≈üarƒ±yla olu≈üturuldu:', response.order_id);
                
                // Sepeti temizle
                clearCart();
                
                // √ñdeme durumunu sƒ±fƒ±rla
                resetPaymentState();
                
                return response;
            } else {
                throw new Error(response.message || 'Sipari≈ü olu≈üturulamadƒ±');
            }
            
        } catch (error) {
            console.error('‚ùå Sipari≈ü tamamlama hatasƒ±:', error);
            throw error;
        }
    }
}

if (typeof resetPaymentState === 'undefined') {
    function resetPaymentState() {
        console.log('üîÑ √ñdeme durumu sƒ±fƒ±rlanƒ±yor...');
        currentPaymentMethod = null;
        window.usedBonusAmount = 0;
        window.remainingPaymentMethod = null;
        isWaitingForOrderConfirm = false;
        isWaitingForAddressConfirm = false;
    }
}

if (typeof closePaymentModal === 'undefined') {
    function closePaymentModal() {
        console.log('‚ùå √ñdeme modalƒ± kapatƒ±lƒ±yor...');
        const modal = document.getElementById('paymentModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }
}

function highlightVoiceField(inputId) {
    // √ñnceki vurgularƒ± temizle
    document.querySelectorAll('.voice-field-highlight').forEach(el => {
        el.classList.remove('voice-field-highlight');
    });
    
    // Yeni input'u vurgula
    const input = document.getElementById(inputId);
    if (input) {
        input.classList.add('voice-field-highlight');
        
        // Input g√∂r√ºn√ºr alana getir
        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // 5 saniye sonra vurguyu kaldƒ±r
        setTimeout(() => {
            input.classList.remove('voice-field-highlight');
        }, 5000);
    }
}

function showVoiceFeedback(message, isSuccess = true) {
    // Mevcut feedback'i temizle
    const existingFeedback = document.getElementById('voice-input-feedback');
    if (existingFeedback) {
        existingFeedback.remove();
    }
    
    // Yeni feedback olu≈ütur
    const feedback = document.createElement('div');
    feedback.id = 'voice-input-feedback';
    feedback.textContent = message;
    feedback.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        background: ${isSuccess ? 'var(--success)' : 'var(--danger)'};
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        z-index: 10000;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
    
    document.body.appendChild(feedback);
    
    // 3 saniye sonra kaldƒ±r
    setTimeout(() => {
        if (feedback.parentNode) {
            feedback.parentNode.removeChild(feedback);
        }
    }, 3000);
}
function requestPhoneNumber() {
    console.log('üìû Telefon numarasƒ± isteniyor...');
    
    isWaitingForPhone = true;
    expectedInput = 'phone';
    
    const modalBody = document.getElementById('paymentModalBody');
    if (modalBody) {
        modalBody.innerHTML = `
            <div class="payment-step active">
                <div class="step-icon">
                    <i class="fas fa-phone"></i>
                </div>
                <div class="step-content">
                    <h4>Telefon Numaranƒ±z</h4>
                    <p>L√ºtfen telefon numaranƒ±zƒ± s√∂yleyin</p>
                    <div class="input-display" id="phoneDisplay"></div>
                </div>
            </div>
        `;
    }
    
    displayMessage("üìû L√ºtfen telefon numaranƒ±zƒ± s√∂yleyin (05XX XXX XX XX formatƒ±nda)");
    speakToUser("telefon numaranƒ±zƒ± s√∂yleyin");
}
        
// =============================================
// TELEFON NUMARASI ƒ∞≈ûLEME
// =============================================

async function processPhoneNumber(message) {
    console.log('üìû Telefon numarasƒ± i≈üleniyor:', message);
    
    // Telefon numarasƒ±nƒ± temizle ve formatla
    let phone = message.replace(/\D/g, ''); // Sadece rakamlarƒ± al
    
    // 10 haneli numara kontrol√º (5XXXXXXXXX)
    if (phone.length === 10 && phone.startsWith('5')) {
        phone = '0' + phone; // 05XXXXXXXX formatƒ±na √ßevir
    }
    
    // 11 haneli numara kontrol√º (05XXXXXXXXX)
    if (phone.length === 11 && phone.startsWith('05')) {
        customerPhone = phone;
        
        // M√º≈üteri kontrol√º
        const customer = await checkCustomerByPhone(phone);
        
        if (customer) {
            // Kayƒ±tlƒ± m√º≈üteri
            currentCustomer = customer;
            displayMessage(`‚úÖ Kayƒ±tlƒ± m√º≈üteri: ${customer.name}`);
            speakToUser(`Ho≈ü geldiniz ${customer.name}`);
            
            // Adres onayƒ± iste
            requestAddressConfirmation();
        } else {
            // Yeni m√º≈üteri
            displayMessage("üìù Yeni m√º≈üteri kaydƒ± olu≈üturulacak");
            speakToUser("Yeni kayƒ±t olu≈üturuluyor");
            
            // ƒ∞sim bilgisi iste
            requestCustomerName();
        }
        
        isWaitingForPhone = false;
        expectedInput = null;
        
    } else {
        displayMessage("‚ùå Ge√ßersiz telefon numarasƒ±. L√ºtfen 05XX XXX XX XX formatƒ±nda s√∂yleyin.");
        speakToUser("ge√ßersiz telefon numarasƒ±");
    }
}

// =============================================
// M√ú≈ûTERƒ∞ ADI ƒ∞≈ûLEME
// =============================================

function requestCustomerName() {
    console.log('üë§ M√º≈üteri adƒ± isteniyor...');
    
    isWaitingForName = true;
    expectedInput = 'name';
    
    const modalBody = document.getElementById('paymentModalBody');
    if (modalBody) {
        modalBody.innerHTML = `
            <div class="payment-step active">
                <div class="step-icon">
                    <i class="fas fa-user"></i>
                </div>
                <div class="step-content">
                    <h4>Adƒ±nƒ±z ve Soyadƒ±nƒ±z</h4>
                    <p>L√ºtfen adƒ±nƒ±zƒ± ve soyadƒ±nƒ±zƒ± s√∂yleyin</p>
                    <div class="input-display" id="nameDisplay"></div>
                </div>
            </div>
        `;
    }
    
    displayMessage("üë§ L√ºtfen adƒ±nƒ±zƒ± ve soyadƒ±nƒ±zƒ± s√∂yleyin");
    speakToUser("adƒ±nƒ±zƒ± ve soyadƒ±nƒ±zƒ± s√∂yleyin");
}

async function processCustomerName(message) {
    console.log('üë§ M√º≈üteri adƒ± i≈üleniyor:', message);
    
    if (message.trim().length < 2) {
        displayMessage("‚ùå Ge√ßersiz isim. L√ºtfen adƒ±nƒ±zƒ± ve soyadƒ±nƒ±zƒ± s√∂yleyin.");
        speakToUser("ge√ßersiz isim");
        return;
    }
    
    customerName = message.trim();
    
    // Modal g√ºncelleme
    const nameDisplay = document.getElementById('nameDisplay');
    if (nameDisplay) {
        nameDisplay.textContent = customerName;
    }
    
    displayMessage(`‚úÖ ƒ∞sim kaydedildi: ${customerName}`);
    speakToUser(`ƒ∞sim kaydedildi`);
    
    isWaitingForName = false;
    expectedInput = null;
    
    // Bina numarasƒ± iste
    requestBuildingInfo();
}

// =============================================
// Bƒ∞NA NUMARASI ƒ∞≈ûLEME
// =============================================

function requestBuildingInfo() {
    console.log('üè¢ Bina numarasƒ± isteniyor...');
    
    isWaitingForBuilding = true;
    expectedInput = 'building';
    
    const modalBody = document.getElementById('paymentModalBody');
    if (modalBody) {
        modalBody.innerHTML = `
            <div class="payment-step active">
                <div class="step-icon">
                    <i class="fas fa-building"></i>
                </div>
                <div class="step-content">
                    <h4>Bina Numarasƒ±</h4>
                    <p>L√ºtfen bina numaranƒ±zƒ± s√∂yleyin</p>
                    <div class="input-display" id="buildingDisplay"></div>
                </div>
            </div>
        `;
    }
    
    displayMessage("üè¢ L√ºtfen bina numaranƒ±zƒ± s√∂yleyin");
    speakToUser("bina numarasƒ±nƒ± s√∂yleyin");
}

async function processBuildingInfo(message) {
    console.log('üè¢ Bina numarasƒ± i≈üleniyor:', message);
    
    // Bina numarasƒ±nƒ± temizle
    let building = message.replace(/\D/g, '');
    
    if (building && building.length > 0) {
        buildingNumber = building;
        
        // Modal g√ºncelleme
        const buildingDisplay = document.getElementById('buildingDisplay');
        if (buildingDisplay) {
            buildingDisplay.textContent = buildingNumber;
        }
        
        displayMessage(`‚úÖ Bina numarasƒ± kaydedildi: ${buildingNumber}`);
        speakToUser(`bina numarasƒ± kaydedildi`);
        
        isWaitingForBuilding = false;
        expectedInput = null;
        
        // Daire numarasƒ± iste
        requestApartmentInfo();
    } else {
        displayMessage("‚ùå Ge√ßersiz bina numarasƒ±. L√ºtfen rakamlarla bina numaranƒ±zƒ± s√∂yleyin.");
        speakToUser("ge√ßersiz bina numarasƒ±");
    }
}

// =============================================
// DAƒ∞RE NUMARASI ƒ∞≈ûLEME
// =============================================

function requestApartmentInfo() {
    console.log('üö™ Daire numarasƒ± isteniyor...');
    
    isWaitingForApartment = true;
    expectedInput = 'apartment';
    
    const modalBody = document.getElementById('paymentModalBody');
    if (modalBody) {
        modalBody.innerHTML = `
            <div class="payment-step active">
                <div class="step-icon">
                    <i class="fas fa-door-closed"></i>
                </div>
                <div class="step-content">
                    <h4>Daire Numarasƒ±</h4>
                    <p>L√ºtfen daire numaranƒ±zƒ± s√∂yleyin</p>
                    <div class="input-display" id="apartmentDisplay"></div>
                </div>
            </div>
        `;
    }
    
    displayMessage("üö™ L√ºtfen daire numaranƒ±zƒ± s√∂yleyin");
    speakToUser("daire numarasƒ±nƒ± s√∂yleyin");
}

async function processApartmentInfo(message) {
    console.log('üö™ Daire numarasƒ± i≈üleniyor:', message);
    
    // Daire numarasƒ±nƒ± temizle
    let apartment = message.replace(/\D/g, '');
    
    if (apartment && apartment.length > 0) {
        apartmentNumber = apartment;
        
        // Modal g√ºncelleme
        const apartmentDisplay = document.getElementById('apartmentDisplay');
        if (apartmentDisplay) {
            apartmentDisplay.textContent = apartmentNumber;
        }
        
        displayMessage(`‚úÖ Daire numarasƒ± kaydedildi: ${apartmentNumber}`);
        speakToUser(`daire numarasƒ± kaydedildi`);
        
        isWaitingForApartment = false;
        expectedInput = null;
        
        // M√º≈üteri kaydƒ±nƒ± tamamla
        await completeCustomerRegistration();
        
    } else {
        displayMessage("‚ùå Ge√ßersiz daire numarasƒ±. L√ºtfen rakamlarla daire numaranƒ±zƒ± s√∂yleyin.");
        speakToUser("ge√ßersiz daire numarasƒ±");
    }
}

// =============================================
// ADRES ONAY ƒ∞≈ûLEME (KAYITLI M√ú≈ûTERƒ∞ ƒ∞√áƒ∞N)
// =============================================

function requestAddressConfirmation() {
    console.log('üè† Adres onayƒ± isteniyor...');
    
    isWaitingForAddressConfirm = true;
    expectedInput = 'address_confirm';
    
    const modalBody = document.getElementById('paymentModalBody');
    if (modalBody) {
        modalBody.innerHTML = `
            <div class="payment-step active">
                <div class="step-icon">
                    <i class="fas fa-home"></i>
                </div>
                <div class="step-content">
                    <h4>Kayƒ±tlƒ± Adresinize Teslimat</h4>
                    <p>${currentCustomer.address}</p>
                    <p>Bu adrese teslimat yapƒ±lsƒ±n mƒ±?</p>
                    <div class="confirmation-buttons">
                        <button class="confirm-btn yes-btn" data-response="evet">Evet</button>
                        <button class="confirm-btn no-btn" data-response="hayƒ±r">Hayƒ±r</button>
                    </div>
                </div>
            </div>
        `;
        
        // Manuel onay butonlarƒ±
        const yesBtn = modalBody.querySelector('.yes-btn');
        const noBtn = modalBody.querySelector('.no-btn');
        
        if (yesBtn) {
            yesBtn.addEventListener('click', function() {
                processAddressConfirmation('evet');
            });
        }
        
        if (noBtn) {
            noBtn.addEventListener('click', function() {
                processAddressConfirmation('hayƒ±r');
            });
        }
    }
    
    displayMessage(`üè† Kayƒ±tlƒ± adresiniz: ${currentCustomer.address}. Bu adrese teslimat yapƒ±lsƒ±n mƒ±?`);
    speakToUser("kayƒ±tlƒ± adresinize teslimat yapƒ±lsƒ±n mƒ± evet veya hayƒ±r");
}

async function processAddressConfirmation(message) {
    console.log('üè† Adres onayƒ± i≈üleniyor:', message);
    
    const response = message.toLowerCase().trim();
    
    if (response.includes('evet') || response === 'evet') {
        useRegisteredAddress = true;
        displayMessage("‚úÖ Kayƒ±tlƒ± adresinize teslimat yapƒ±lacak");
        speakToUser("kayƒ±tlƒ± adresinize teslimat yapƒ±lacak");
        
        isWaitingForAddressConfirm = false;
        expectedInput = null;
        
        // Sipari≈ü onayƒ± iste
        requestOrderConfirmation();
        
    } else if (response.includes('hayƒ±r') || response === 'hayƒ±r') {
        useRegisteredAddress = false;
        displayMessage("üîÑ Yeni teslimat adresi alƒ±nƒ±yor...");
        speakToUser("yeni teslimat adresi");
        
        isWaitingForAddressConfirm = false;
        expectedInput = null;
        
        // Yeni bina numarasƒ± iste
        requestNewBuildingInfo();
    } else {
        displayMessage("‚ùå L√ºtfen 'evet' veya 'hayƒ±r' olarak cevap verin");
        speakToUser("evet veya hayƒ±r");
    }
}

// =============================================
// YENƒ∞ ADRES Bƒ∞LGƒ∞LERƒ∞ (KAYITLI M√ú≈ûTERƒ∞ ƒ∞√áƒ∞N)
// =============================================

function requestNewBuildingInfo() {
    console.log('üè¢ Yeni bina numarasƒ± isteniyor...');
    
    isWaitingForNewBuilding = true;
    expectedInput = 'new_building';
    
    const modalBody = document.getElementById('paymentModalBody');
    if (modalBody) {
        modalBody.innerHTML = `
            <div class="payment-step active">
                <div class="step-icon">
                    <i class="fas fa-building"></i>
                </div>
                <div class="step-content">
                    <h4>Yeni Bina Numarasƒ±</h4>
                    <p>L√ºtfen yeni bina numaranƒ±zƒ± s√∂yleyin</p>
                    <div class="input-display" id="newBuildingDisplay"></div>
                </div>
            </div>
        `;
    }
    
    displayMessage("üè¢ L√ºtfen yeni bina numaranƒ±zƒ± s√∂yleyin");
    speakToUser("yeni bina numarasƒ±nƒ± s√∂yleyin");
}

async function processNewBuildingInfo(message) {
    console.log('üè¢ Yeni bina numarasƒ± i≈üleniyor:', message);
    
    let building = message.replace(/\D/g, '');
    
    if (building && building.length > 0) {
        buildingNumber = building;
        
        const newBuildingDisplay = document.getElementById('newBuildingDisplay');
        if (newBuildingDisplay) {
            newBuildingDisplay.textContent = buildingNumber;
        }
        
        displayMessage(`‚úÖ Yeni bina numarasƒ± kaydedildi: ${buildingNumber}`);
        speakToUser(`yeni bina numarasƒ± kaydedildi`);
        
        isWaitingForNewBuilding = false;
        expectedInput = null;
        
        // Yeni daire numarasƒ± iste
        requestNewApartmentInfo();
    } else {
        displayMessage("‚ùå Ge√ßersiz bina numarasƒ±. L√ºtfen rakamlarla bina numaranƒ±zƒ± s√∂yleyin.");
        speakToUser("ge√ßersiz bina numarasƒ±");
    }
}

function requestNewApartmentInfo() {
    console.log('üö™ Yeni daire numarasƒ± isteniyor...');
    
    isWaitingForNewApartment = true;
    expectedInput = 'new_apartment';
    
    const modalBody = document.getElementById('paymentModalBody');
    if (modalBody) {
        modalBody.innerHTML = `
            <div class="payment-step active">
                <div class="step-icon">
                    <i class="fas fa-door-closed"></i>
                </div>
                <div class="step-content">
                    <h4>Yeni Daire Numarasƒ±</h4>
                    <p>L√ºtfen yeni daire numaranƒ±zƒ± s√∂yleyin</p>
                    <div class="input-display" id="newApartmentDisplay"></div>
                </div>
            </div>
        `;
    }
    
    displayMessage("üö™ L√ºtfen yeni daire numaranƒ±zƒ± s√∂yleyin");
    speakToUser("yeni daire numarasƒ±nƒ± s√∂yleyin");
}

async function processNewApartmentInfo(message) {
    console.log('üö™ Yeni daire numarasƒ± i≈üleniyor:', message);
    
    let apartment = message.replace(/\D/g, '');
    
    if (apartment && apartment.length > 0) {
        apartmentNumber = apartment;
        
        const newApartmentDisplay = document.getElementById('newApartmentDisplay');
        if (newApartmentDisplay) {
            newApartmentDisplay.textContent = apartmentNumber;
        }
        
        displayMessage(`‚úÖ Yeni daire numarasƒ± kaydedildi: ${apartmentNumber}`);
        speakToUser(`yeni daire numarasƒ± kaydedildi`);
        
        isWaitingForNewApartment = false;
        expectedInput = null;
        
        // M√º≈üteri adresini g√ºncelle
        await updateCustomerAddress();
        
        // Sipari≈ü onayƒ± iste
        requestOrderConfirmation();
    } else {
        displayMessage("‚ùå Ge√ßersiz daire numarasƒ±. L√ºtfen rakamlarla daire numaranƒ±zƒ± s√∂yleyin.");
        speakToUser("ge√ßersiz daire numarasƒ±");
    }
}

// =============================================
// M√ú≈ûTERƒ∞ KAYIT ƒ∞≈ûLEMLERƒ∞
// =============================================

async function completeCustomerRegistration() {
    console.log('üë§ M√º≈üteri kaydƒ± tamamlanƒ±yor...');
    
    try {
        // M√º≈üteri kaydƒ± olu≈ütur
        const customerData = {
            phone: customerPhone,
            name: customerName,
            address: formatDeliveryAddress(),
            created_at: new Date().toISOString()
        };
        
        const { data, error } = await supabase
            .from('customers')
            .insert([customerData])
            .select()
            .single();
            
        if (error) throw error;
        
        currentCustomer = data;
        displayMessage("‚úÖ M√º≈üteri kaydƒ± tamamlandƒ±");
        speakToUser("kaydƒ±nƒ±z tamamlandƒ±");
        
        // Sipari≈ü onayƒ± iste
        requestOrderConfirmation();
        
    } catch (error) {
        console.error('‚ùå M√º≈üteri kayƒ±t hatasƒ±:', error);
        displayMessage("‚ùå M√º≈üteri kaydƒ± sƒ±rasƒ±nda hata olu≈ütu");
        speakToUser("kayƒ±t hatasƒ±");
    }
}

async function updateCustomerAddress() {
    console.log('üè† M√º≈üteri adresi g√ºncelleniyor...');
    
    try {
        const newAddress = formatDeliveryAddress();
        
        // Local storage'a kaydet (customers tablosu yoksa)
        if (currentCustomer) {
            currentCustomer.address = newAddress;
            currentCustomer.updated_at = new Date().toISOString();
            
            // Local storage'a kaydet
            localStorage.setItem('currentCustomer', JSON.stringify(currentCustomer));
        }
        
        displayMessage("‚úÖ M√º≈üteri adresi g√ºncellendi");
        speakToUser("adres g√ºncellendi");
        
    } catch (error) {
        console.error('‚ùå M√º≈üteri adres g√ºncelleme hatasƒ±:', error);
        displayMessage("‚ùå Adres g√ºncelleme sƒ±rasƒ±nda hata olu≈ütu");
        speakToUser("adres g√ºncelleme hatasƒ±");
    }
}
// =============================================
// TESLƒ∞MAT ADRESƒ∞ FORMATLAMA
// =============================================

function formatDeliveryAddress() {
    let fullAddress = '';
    
    if (useRegisteredAddress && currentCustomer) {
        // Kayƒ±tlƒ± adres kullanƒ±lƒ±yor
        fullAddress = currentCustomer.address;
    } else {
        // Yeni adres olu≈ütur
        if (userLocation && userLocation.address) {
            fullAddress = userLocation.address;
            
            if (buildingNumber) {
                fullAddress += ` Bina: ${buildingNumber}`;
            }
            
            if (apartmentNumber) {
                fullAddress += ` Daire: ${apartmentNumber}`;
            }
        } else {
            // Konum bilgisi yoksa sadece bina/daire
            if (buildingNumber) {
                fullAddress = `Bina: ${buildingNumber}`;
            }
            
            if (apartmentNumber) {
                fullAddress += fullAddress ? ` Daire: ${apartmentNumber}` : `Daire: ${apartmentNumber}`;
            }
        }
    }
    
    return fullAddress;
}
  
// =============================================
// Sƒ∞PARƒ∞≈û ONAY ƒ∞STEƒûƒ∞ (T√úM SESLƒ∞ KOMUTLAR ƒ∞LE)
// =============================================

function requestOrderConfirmation() {
    console.log('üìã Sipari≈ü onayƒ± isteniyor...');
    
    const totalAmount = calculateTotal();
    const deliveryAddress = formatDeliveryAddress();
    
    // Bonus bakiyesini al
    const bonusBalance = currentCustomer ? (currentCustomer.bonus_balance || 0) : 0;
    const remainingAfterBonus = Math.max(0, totalAmount - bonusBalance);
    
    const modalBody = document.getElementById('paymentModalBody');
    if (modalBody) {
        modalBody.innerHTML = `
            <div class="order-summary-container">
                <h3>üìã Sipari≈ü √ñzeti</h3>
                
                <div class="summary-section">
                    <div class="summary-row">
                        <span>M√º≈üteri:</span>
                        <strong>${currentCustomer ? currentCustomer.name : customerName}</strong>
                    </div>
                    <div class="summary-row">
                        <span>Telefon:</span>
                        <strong>${currentCustomer ? currentCustomer.phone : customerPhone}</strong>
                    </div>
                    <div class="summary-row">
                        <span>Teslimat Adresi:</span>
                        <strong>${deliveryAddress}</strong>
                    </div>
                    <div class="summary-row">
                        <span>√ñdeme Y√∂ntemi:</span>
                        <strong class="payment-method-badge">${getPaymentMethodName(currentPaymentMethod)}</strong>
                    </div>
                </div>
                
                <div class="amount-section">
                    <div class="total-amount">
                        <span>Toplam Tutar:</span>
                        <strong class="total-price">${money(totalAmount)}</strong>
                    </div>
                    
                    ${currentPaymentMethod === 'bonus' ? `
                    <!-- BONUS √ñDEME DURUMU -->
                    <div class="bonus-payment-section">
                        <div class="bonus-info">
                            <div class="bonus-row">
                                <span>Bonus Bakiyeniz:</span>
                                <strong class="bonus-balance">${money(bonusBalance)}</strong>
                            </div>
                            <div class="bonus-row">
                                <span>Kalan Bakiye:</span>
                                <strong class="remaining-balance ${remainingAfterBonus > 0 ? 'negative' : 'positive'}">
                                    ${money(remainingAfterBonus)}
                                </strong>
                            </div>
                        </div>
                        
                        ${remainingAfterBonus > 0 ? `
                        <div class="remaining-payment-options">
                            <p class="remaining-payment-title">${money(remainingAfterBonus)} nasƒ±l √∂demek istersiniz?</p>
                            <div class="payment-buttons-remaining">
                                <button type="button" class="payment-option-btn cash-option" onclick="handlePaymentSelection('cash')">
                                    üíµ Nakit ile √ñde
                                </button>
                                <button type="button" class="payment-option-btn card-option" onclick="handlePaymentSelection('card')">
                                    üí≥ Kart ile √ñde
                                </button>
                            </div>
                        </div>
                        ` : `
                        <div class="full-bonus-success">
                            <div class="success-badge">‚úÖ Tamamƒ± bonus ile √∂dendi</div>
                            <div class="new-balance-info">
                                Yeni bonus bakiyeniz: <strong>${money(bonusBalance - totalAmount)}</strong>
                            </div>
                        </div>
                        `}
                    </div>
                    ` : ''}
                </div>
                
                <!-- MANUEL D√úZENLEME ALANI -->
                <div class="manual-edit-section" id="manualEditSection" style="display: none;">
                    <h4>‚úèÔ∏è Manuel Bonus D√ºzenleme</h4>
                    <div class="manual-edit-form">
                        <div class="form-group">
                            <label>Kullanƒ±lacak Bonus:</label>
                            <input type="number" id="manualBonusAmount" value="${Math.min(bonusBalance, totalAmount)}" 
                                   min="0" max="${bonusBalance}" step="1" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Kalan Tutar √ñdeme Y√∂ntemi:</label>
                            <select id="manualPaymentMethod" class="form-control">
                                <option value="cash">üíµ Nakit</option>
                                <option value="card">üí≥ Kart</option>
                            </select>
                        </div>
                        <button type="button" class="btn btn-success btn-sm" onclick="handleManualPaymentApply()">
                            ‚úÖ Uygula
                        </button>
                    </div>
                </div>
                
                <!-- ONAY BUTONLARI -->
                <div class="confirmation-section">
                    <p class="confirmation-question">Sipari≈üi onaylƒ±yor musunuz?</p>
                    <div class="confirmation-buttons">
                        <button class="confirm-btn yes-btn" onclick="handleOrderConfirmation('evet')">
                            ‚úÖ Evet, Onayla
                        </button>
                        <button class="confirm-btn no-btn" onclick="handleOrderConfirmation('hayƒ±r')">
                            ‚ùå Hayƒ±r, ƒ∞ptal
                        </button>
                    </div>
                    
                    <button type="button" id="manualEditBtn" class="manual-edit-btn" onclick="handleManualEditToggle()">
                        <i class="fas fa-edit"></i> Manuel D√ºzenle
                    </button>
                </div>
            </div>
        `;
    }
    
    // SESLƒ∞ KOMUTLARI AYARLA
    setupVoiceCommandsForOrderConfirmation();
    
    // Sesli bildirim
    if (currentPaymentMethod === 'bonus') {
        if (remainingAfterBonus > 0) {
            speakToUser(`Bonus bakiyeniz ${money(bonusBalance)}. ${money(remainingAfterBonus)} nakit veya kart ile √∂denecek. "Nakit" veya "Kart" diyerek se√ßim yapabilirsiniz. Sipari≈üi onaylamak i√ßin "Evet" iptal i√ßin "Hayƒ±r" diyebilirsiniz.`);
        } else {
            speakToUser(`Tamamƒ± bonus ile √∂dendi. Yeni bakiyeniz ${money(bonusBalance - totalAmount)}. Sipari≈üi onaylamak i√ßin "Evet" iptal i√ßin "Hayƒ±r" diyebilirsiniz.`);
        }
    } else {
        speakToUser(`Sipari≈ü √∂zetiniz hazƒ±r. Toplam tutar ${money(totalAmount)}. Onaylamak i√ßin "Evet" iptal i√ßin "Hayƒ±r" diyebilirsiniz.`);
    }
    
    isWaitingForOrderConfirm = true;
}

// =============================================
// T√úM SESLƒ∞ KOMUTLAR TEK FONKSƒ∞YONDA
// =============================================

// MEVCUT KOD - AYNI KALSIN
function setupBonusPaymentVoiceCommands() {
    console.log('üé§ Bonus √∂deme sesli komutlarƒ± kuruluyor...');
    
    // Mevcut komutlarƒ± yedekle
    const currentCommands = [...voiceCommands];
    voiceCommands.length = 0;
    
    // 1. √ñDEME Y√ñNTEMƒ∞ KOMUTLARI
    const totalAmount = calculateTotal();
    const bonusBalance = currentCustomer ? (currentCustomer.bonus_balance || 0) : 0;
    const remainingAfterBonus = Math.max(0, totalAmount - bonusBalance);
    
    if (remainingAfterBonus > 0) {
        voiceCommands.push({
            command: ['nakit', 'nakit √∂de', 'nakit ile', 'cash', 'para'],
            callback: () => {
                console.log('üé§ Sesli komut: Nakit - Bonus √∂deme');
                selectBonusRemainingPayment('cash');
                return true;
            }
        });
        
        voiceCommands.push({
            command: ['kart', 'kart ile', 'kartla', 'kredi kartƒ±', 'bank kartƒ±', 'card', 'credit'],
            callback: () => {
                console.log('üé§ Sesli komut: Kart - Bonus √∂deme');
                selectBonusRemainingPayment('card');
                return true;
            }
        });
    } else {
        voiceCommands.push({
            command: ['tamam', 'onayla', 'evet', '√∂de', 'bonus ile √∂de'],
            callback: () => {
                console.log('üé§ Sesli komut: Tamamƒ± bonus ile √∂de');
                confirmFullBonusPayment();
                return true;
            }
        });
    }
    
    // 2. MANUEL D√úZENLEME KOMUTLARI
    voiceCommands.push({
        command: ['manuel', 'd√ºzenle', 'edit', 'manuel d√ºzenle', 'ayar'],
        callback: () => {
            console.log('üé§ Sesli komut: Manuel d√ºzenleme');
            toggleBonusManualEdit();
            return true;
        }
    });
    
    voiceCommands.push({
        command: ['uygula', 'kaydet', 'apply', 'save'],
        callback: () => {
            console.log('üé§ Sesli komut: Uygula');
            const manualSection = document.getElementById('manualBonusEditSection');
            if (manualSection && manualSection.style.display !== 'none') {
                applyManualBonusSettings();
                return true;
            }
            return false;
        }
    });
    
    // 3. Bƒ∞LGƒ∞ KOMUTLARI
    voiceCommands.push({
        command: ['bakiyem', 'bonus', 'bonusum', 'bakiye'],
        callback: () => {
            speakToUser(`Bonus bakiyeniz ${money(bonusBalance)}`);
            return true;
        }
    });
    
    voiceCommands.push({
        command: ['toplam', 'tutar', 'ne kadar'],
        callback: () => {
            speakToUser(`Toplam tutar ${money(totalAmount)}`);
            return true;
        }
    });
    
    // 4. ƒ∞PTAL KOMUTU
    voiceCommands.push({
        command: ['iptal', 'vazge√ß', 'geri', 'cancel'],
        callback: () => {
            console.log('üé§ Sesli komut: ƒ∞ptal');
            cancelBonusPayment();
            return true;
        }
    });
    
    // Geri y√ºkleme fonksiyonu
    window.restoreBonusCommands = function() {
        voiceCommands.length = 0;
        voiceCommands.push(...currentCommands);
        delete window.restoreBonusCommands;
    };
    
    console.log(`‚úÖ ${voiceCommands.length} bonus √∂deme komutu eklendi`);
}
        
function toggleBonusManualEdit() {
    const manualSection = document.getElementById('manualBonusEditSection');
    const toggleBtn = document.querySelector('.manual-edit-toggle-btn');
    
    if (manualSection.style.display === 'none') {
        manualSection.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-times"></i> Manuel D√ºzenlemeyi Kapat';
        speakToUser("Manuel bonus ayarlarƒ± a√ßƒ±ldƒ±");
    } else {
        manualSection.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-edit"></i> Manuel D√ºzenle';
    }
}

function applyManualBonusSettings() {
    const manualBonusAmount = parseFloat(document.getElementById('manualBonusInput').value) || 0;
    const manualPaymentMethod = document.getElementById('manualPaymentSelect').value;
    const totalAmount = calculateTotal();
    const bonusBalance = currentCustomer ? (currentCustomer.bonus_balance || 0) : 0;
    
    // Validasyon
    if (manualBonusAmount > bonusBalance) {
        displayMessage("‚ùå Girdiƒüiniz bonus miktarƒ± bakiyenizden fazla!");
        return;
    }
    
    if (manualBonusAmount > totalAmount) {
        displayMessage("‚ùå Girdiƒüiniz bonus miktarƒ± sipari≈ü tutarƒ±ndan fazla!");
        return;
    }
    
    const remainingAmount = totalAmount - manualBonusAmount;
    
    // Manuel se√ßimi kaydet
    window.usedBonusAmount = manualBonusAmount;
    window.remainingPaymentMethod = remainingAmount > 0 ? manualPaymentMethod : null;
    
    // Manuel b√∂l√ºm√º kapat
    document.getElementById('manualBonusEditSection').style.display = 'none';
    document.querySelector('.manual-edit-toggle-btn').innerHTML = '<i class="fas fa-edit"></i> Manuel D√ºzenle';
    
    // Ba≈üarƒ± mesajƒ±
    let successMessage = `‚úÖ Manuel ayar: ${money(manualBonusAmount)} bonus`;
    if (remainingAmount > 0) {
        successMessage += ` + ${money(remainingAmount)} ${manualPaymentMethod === 'cash' ? 'nakit' : 'kart'}`;
    }
    
    displayMessage(successMessage);
    speakToUser("Manuel ayar uygulandƒ±");
    
    // 2 SANƒ∞YE SONRA TELEFON SORMAYA GE√á
    setTimeout(() => {
        proceedToPhoneVerification();
    }, 2000);
}

function cancelBonusPayment() {
    console.log('‚ùå Bonus √∂deme iptal edildi');
    
    // Sesli komutlarƒ± temizle
    if (typeof window.restoreBonusCommands === 'function') {
        window.restoreBonusCommands();
    }
    
    // Modalƒ± kapat
    closePaymentModal();
    resetPaymentState();
}
        
function setupVoiceCommandsForOrderConfirmation() {
    console.log('üé§ Sipari≈ü onayƒ± sesli komutlarƒ± kuruluyor...');
    
    // voiceCommands'ƒ±n var olduƒüunu kontrol et
    if (typeof voiceCommands === 'undefined') {
        console.error('‚ùå voiceCommands tanƒ±mlƒ± deƒüil!');
        return;
    }
    
    console.log(`üìä Mevcut komut sayƒ±sƒ±: ${voiceCommands.length}`);
    
    // √ñnce mevcut sesli komutlarƒ± yedekle
    const currentCommands = [...voiceCommands];
    
    // Komutlarƒ± temizle
    voiceCommands.length = 0;
    console.log('üßπ Mevcut komutlar temizlendi');
    
    // 1. ONAY KOMUTLARI
    voiceCommands.push({
        command: ['evet', 'onayla', 'tamam', 'kabul', '√∂de', 'confirm', 'yes'],
        callback: () => {
            console.log('üé§ Sesli komut: Evet - Sipari≈ü onaylanƒ±yor');
            handleOrderConfirmation('evet');
            return true;
        }
    });
    
    voiceCommands.push({
        command: ['hayƒ±r', 'iptal', 'vazge√ß', 'geri', 'durdur', 'cancel', 'no'],
        callback: () => {
            console.log('üé§ Sesli komut: Hayƒ±r - Sipari≈ü iptal ediliyor');
            handleOrderConfirmation('hayƒ±r');
            return true;
        }
    });
    
    // 2. √ñDEME Y√ñNTEMƒ∞ KOMUTLARI (Sadece bonus √∂demede aktif)
    if (currentPaymentMethod === 'bonus') {
        const totalAmount = calculateTotal();
        const bonusBalance = currentCustomer ? (currentCustomer.bonus_balance || 0) : 0;
        const remainingAfterBonus = Math.max(0, totalAmount - bonusBalance);
        
        console.log(`üí∞ Bonus durumu: ${bonusBalance} TL, Kalan: ${remainingAfterBonus} TL`);
        
        if (remainingAfterBonus > 0) {
            voiceCommands.push({
                command: ['nakit', 'nakit √∂de', 'nakit ile', 'cash', 'para'],
                callback: () => {
                    console.log('üé§ Sesli komut: Nakit - Kalan √∂deme se√ßiliyor');
                    handlePaymentSelection('cash');
                    return true;
                }
            });
            
            voiceCommands.push({
                command: ['kart', 'kart ile', 'kartla', 'kredi kartƒ±', 'bank kartƒ±', 'card', 'credit'],
                callback: () => {
                    console.log('üé§ Sesli komut: Kart - Kalan √∂deme se√ßiliyor');
                    handlePaymentSelection('card');
                    return true;
                }
            });
            
            console.log('‚úÖ Nakit/Kart komutlarƒ± eklendi');
        }
    }
    
    // 3. MANUEL D√úZENLEME KOMUTLARI
    voiceCommands.push({
        command: ['manuel', 'd√ºzenle', 'edit', 'manuel d√ºzenle', 'ayar', 'adjust'],
        callback: () => {
            console.log('üé§ Sesli komut: Manuel D√ºzenleme');
            handleManualEditToggle();
            return true;
        }
    });
    
    voiceCommands.push({
        command: ['uygula', 'kaydet', 'apply', 'save'],
        callback: () => {
            console.log('üé§ Sesli komut: Uygula');
            const manualSection = document.getElementById('manualEditSection');
            if (manualSection && manualSection.style.display !== 'none') {
                handleManualPaymentApply();
                return true;
            }
            return false;
        }
    });
    
    // 4. Bƒ∞LGƒ∞ KOMUTLARI
    voiceCommands.push({
        command: ['bakiyem', 'bonus', 'bonusum', 'balance', 'bakiye'],
        callback: () => {
            const bonusBalance = currentCustomer ? (currentCustomer.bonus_balance || 0) : 0;
            const totalAmount = calculateTotal();
            speakToUser(`Bonus bakiyeniz ${money(bonusBalance)}. Toplam tutar ${money(totalAmount)}`);
            displayMessage(`üí∞ Bonus bakiyeniz: ${money(bonusBalance)} | Toplam: ${money(totalAmount)}`);
            return true;
        }
    });
    
    voiceCommands.push({
        command: ['toplam', 'tutar', 'ne kadar', 'amount', 'total'],
        callback: () => {
            const totalAmount = calculateTotal();
            speakToUser(`Toplam tutar ${money(totalAmount)}`);
            displayMessage(`üí∞ Toplam tutar: ${money(totalAmount)}`);
            return true;
        }
    });
    
    // Geri y√ºkleme fonksiyonu
    window.restoreVoiceCommands = function() {
        console.log('üîÑ Sesli komutlar geri y√ºkleniyor...');
        voiceCommands.length = 0;
        voiceCommands.push(...currentCommands);
        console.log(`‚úÖ ${currentCommands.length} komut geri y√ºklendi`);
        
        // Global fonksiyonu temizle
        delete window.restoreVoiceCommands;
    };
    
    console.log(`‚úÖ ${voiceCommands.length} yeni komut eklendi`);
}

// Yardƒ±mcƒ± fonksiyon - Manuel d√ºzenleme kapatƒ±ldƒ±ƒüƒ±nda komutlarƒ± geri y√ºkle
function restoreDefaultVoiceCommands() {
    if (typeof window.restoreVoiceCommands === 'function') {
        window.restoreVoiceCommands();
    }
}
// =============================================
// TIKLAMA ve SESLƒ∞ KOMUT ORTAK FONKSƒ∞YONLARI
// =============================================

function handleOrderConfirmation(response) {
    console.log('‚úÖ Sipari≈ü onayƒ± i≈üleniyor:', response);
    
    // Butonlarƒ± devre dƒ±≈üƒ± bƒ±rak (√ßift tƒ±klamayƒ± √∂nle)
    const yesBtn = document.querySelector('.yes-btn');
    const noBtn = document.querySelector('.no-btn');
    
    if (yesBtn) yesBtn.disabled = true;
    if (noBtn) noBtn.disabled = true;
    
    if (response === 'evet') {
        displayMessage("‚è≥ Sipari≈üiniz onaylanƒ±yor...");
        speakToUser("Sipari≈ü onaylanƒ±yor");
        
        // Bonus √∂deme validasyonu
        if (currentPaymentMethod === 'bonus') {
            const totalAmount = calculateTotal();
            const bonusBalance = currentCustomer ? (currentCustomer.bonus_balance || 0) : 0;
            const usedBonus = window.usedBonusAmount || Math.min(bonusBalance, totalAmount);
            const remainingAmount = totalAmount - usedBonus;
            
            if (remainingAmount > 0 && !window.remainingPaymentMethod) {
                displayMessage("‚ùå L√ºtfen kalan √∂deme y√∂ntemini se√ßin!");
                speakToUser("Kalan √∂deme y√∂ntemi se√ßilmedi");
                
                // Butonlarƒ± tekrar aktif et
                if (yesBtn) yesBtn.disabled = false;
                if (noBtn) noBtn.disabled = false;
                return;
            }
        }
        
        // Sesli komutlarƒ± temizle
        if (typeof window.restoreVoiceCommands === 'function') {
            window.restoreVoiceCommands();
        }
        
        // Sipari≈üi onayla
        confirmOrder();
        
    } else {
        displayMessage("‚ùå Sipari≈ü iptal edildi.");
        speakToUser("Sipari≈ü iptal edildi");
        
        // Sesli komutlarƒ± temizle
        if (typeof window.restoreVoiceCommands === 'function') {
            window.restoreVoiceCommands();
        }
        
        // Modalƒ± kapat ve temizle
        setTimeout(() => {
            closePaymentModal();
            resetPaymentState();
        }, 2000);
    }
    
    isWaitingForOrderConfirm = false;
}
        
function handlePaymentSelection(method) {
    const totalAmount = calculateTotal();
    const bonusBalance = currentCustomer ? (currentCustomer.bonus_balance || 0) : 0;
    const usedBonus = window.usedBonusAmount || Math.min(bonusBalance, totalAmount);
    const remainingAmount = totalAmount - usedBonus;
    
    console.log(`üí∞ √ñdeme se√ßildi: ${method}, Tutar: ${remainingAmount}`);
    
    // Se√ßimi kaydet
    window.remainingPaymentMethod = method;
    
    // UI g√ºncelle
    updatePaymentSummary(usedBonus, remainingAmount, method);
    
    // Sesli bildirim
    speakToUser(`${money(remainingAmount)} ${method === 'cash' ? 'nakit' : 'kart'} ile √∂denecek. Sipari≈üi onaylamak i√ßin "Evet" diyebilirsiniz.`);
    
    // Butonlarƒ± g√ºncelle
    document.querySelectorAll('.payment-option-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    const selectedBtn = document.querySelector(`.${method}-option`);
    if (selectedBtn) {
        selectedBtn.classList.add('selected');
    }
}

function handleManualEditToggle() {
    const manualSection = document.getElementById('manualEditSection');
    const manualEditBtn = document.getElementById('manualEditBtn');
    
    if (manualSection.style.display === 'none') {
        manualSection.style.display = 'block';
        manualEditBtn.innerHTML = '<i class="fas fa-times"></i> Manuel D√ºzenlemeyi Kapat';
        speakToUser("Manuel bonus d√ºzenleme a√ßƒ±ldƒ±. Kullanƒ±lacak bonus miktarƒ±nƒ± ve √∂deme y√∂ntemini ayarlayabilirsiniz.");
    } else {
        manualSection.style.display = 'none';
        manualEditBtn.innerHTML = '<i class="fas fa-edit"></i> Manuel D√ºzenle';
        speakToUser("Manuel d√ºzenleme kapatƒ±ldƒ±");
    }
}

function handleManualPaymentApply() {
    const manualBonusAmount = parseFloat(document.getElementById('manualBonusAmount').value) || 0;
    const manualPaymentMethod = document.getElementById('manualPaymentMethod').value;
    const totalAmount = calculateTotal();
    const bonusBalance = currentCustomer ? (currentCustomer.bonus_balance || 0) : 0;
    
    // Validasyon
    if (manualBonusAmount > bonusBalance) {
        displayMessage("‚ùå Girdiƒüiniz bonus miktarƒ± bakiyenizden fazla!");
        speakToUser("Bonus miktarƒ± ge√ßersiz");
        return;
    }
    
    if (manualBonusAmount > totalAmount) {
        displayMessage("‚ùå Girdiƒüiniz bonus miktarƒ± sipari≈ü tutarƒ±ndan fazla!");
        speakToUser("Bonus miktarƒ± sipari≈ü tutarƒ±ndan fazla");
        return;
    }
    
    const remainingAmount = totalAmount - manualBonusAmount;
    
    // Manuel se√ßimi uygula
    window.usedBonusAmount = manualBonusAmount;
    window.remainingPaymentMethod = manualPaymentMethod;
    
    // UI g√ºncelle
    updatePaymentSummary(manualBonusAmount, remainingAmount, manualPaymentMethod);
    
    // Manuel b√∂l√ºm√º kapat
    document.getElementById('manualEditSection').style.display = 'none';
    document.getElementById('manualEditBtn').innerHTML = '<i class="fas fa-edit"></i> Manuel D√ºzenle';
    
    displayMessage(`‚úÖ Manuel ayar uygulandƒ±: ${money(manualBonusAmount)} bonus + ${money(remainingAmount)} ${manualPaymentMethod === 'cash' ? 'nakit' : 'kart'}`);
    speakToUser(`Manuel ayar uygulandƒ±. ${money(remainingAmount)} ${manualPaymentMethod === 'cash' ? 'nakit' : 'kart'} ile √∂denecek.`);
}


        // Fallback fonksiyonu
function handleVoiceCommandError(error, transcript) {
    console.error('Sesli komut hatasƒ±:', {
        error: error.message,
        transcript: transcript,
        timestamp: new Date().toISOString()
    });
    
    // Kullanƒ±cƒ±ya anlamlƒ± mesaj ver
    const errorMessage = "Teknik bir hata olu≈ütu. L√ºtfen tekrar deneyin.";
    if (Date.now() - lastSpeakTime > SPEAK_COOLDOWN) {
        displayMessage(`‚ùå ${errorMessage}`);
        speakToUser("Teknik bir hata olu≈ütu");
    }
}
// =============================================
// YARDIMCI FONKSƒ∞YON
// =============================================

function updatePaymentSummary(usedBonus, remainingAmount, paymentMethod) {
    const summaryElement = document.querySelector('.bonus-payment-section');
    if (summaryElement) {
        summaryElement.innerHTML = `
            <div class="bonus-info">
                <div class="bonus-row">
                    <span>Kullanƒ±lan Bonus:</span>
                    <strong>${money(usedBonus)}</strong>
                </div>
                <div class="bonus-row">
                    <span>Kalan √ñdeme:</span>
                    <strong>${money(remainingAmount)} (${paymentMethod === 'cash' ? 'Nakit' : 'Kart'})</strong>
                </div>
                <div class="bonus-row">
                    <span>Yeni Bonus Bakiyeniz:</span>
                    <strong>${money((currentCustomer?.bonus_balance || 0) - usedBonus)}</strong>
                </div>
            </div>
            <div class="payment-confirmed-badge">
                ‚úÖ √ñdeme planƒ± onaylandƒ±
            </div>
        `;
    }
}



        

// =============================================
// Sƒ∞PARƒ∞≈û KAYDETME
// =============================================

async function saveOrder() {
    console.log('üíæ Sipari≈ü kaydediliyor...');
    
    try {
        const totalAmount = calculateTotal();
        const deliveryAddress = formatDeliveryAddress();
        
        // √ñdeme detaylarƒ±nƒ± hazƒ±rla
        let paymentNotes = `Teslimat adresi: ${deliveryAddress}. √ñdeme: ${getPaymentMethodName(currentPaymentMethod)}`;
        let usedBonus = 0;
        let remainingPaymentMethod = null;
        let remainingAmount = 0;
        
        // Manuel √∂deme verilerini kontrol et
        if (window.manualPaymentData) {
            usedBonus = window.manualPaymentData.bonus;
            remainingAmount = window.manualPaymentData.cash + window.manualPaymentData.card;
            remainingPaymentMethod = window.manualPaymentData.cash > 0 ? 'cash' : 'card';
        } else if (currentPaymentMethod === 'bonus') {
            const bonusBalance = currentCustomer ? (currentCustomer.bonus_balance || 0) : 0;
            usedBonus = window.usedBonusAmount || Math.min(bonusBalance, totalAmount);
            remainingAmount = totalAmount - usedBonus;
            remainingPaymentMethod = window.remainingPaymentMethod;
        }
        
        // Orders tablosu i√ßin √∂deme y√∂ntemi metnini hazƒ±rla
        let paymentMethodText = getPaymentMethodName(currentPaymentMethod);
        if (usedBonus > 0 && remainingAmount > 0) {
            paymentMethodText = `(bonus): ${money(usedBonus)} √ñdendi, (${remainingPaymentMethod}): ${money(remainingAmount)} √ñdenecek`;
        } else if (usedBonus > 0) {
            paymentMethodText = `(bonus): ${money(usedBonus)} √ñdendi`;
        }
        
        if (usedBonus > 0) {
            paymentNotes += `, Kullanƒ±lan Bonus: ${money(usedBonus)}`;
        }
        if (remainingPaymentMethod) {
            paymentNotes += `, Kalan √ñdeme: ${money(remainingAmount)} ${remainingPaymentMethod === 'cash' ? 'Nakit' : 'Kart'}`;
        }
        
        // Sipari≈ü verilerini hazƒ±rla
        const orderData = {
            customer_id: currentCustomer ? currentCustomer.id : null,
            customer_name: currentCustomer ? currentCustomer.name : customerName,
            customer_phone: currentCustomer ? currentCustomer.phone : customerPhone,
            seller_id: selectedSellerId,
            total_amount: totalAmount,
            payment_method: paymentMethodText,
            delivery_address: deliveryAddress,
            order_notes: paymentNotes,
            status: 'pending',
            created_at: new Date().toISOString()
        };
        
        console.log('üì¶ Sipari≈ü verisi:', orderData);
        
        // 1Ô∏è‚É£ Sƒ∞PARƒ∞≈ûƒ∞ KAYDET
        const { data: order, error: orderError } = await supabase
            .from('orders')
            .insert([orderData])
            .select()
            .single();
            
        if (orderError) {
            console.error('‚ùå Sipari≈ü kaydetme hatasƒ±:', orderError);
            throw new Error(`Sipari≈ü kaydedilemedi: ${orderError.message}`);
        }
        
        console.log('‚úÖ Sipari≈ü kaydedildi:', order);
        
        // 2Ô∏è‚É£ Sƒ∞PARƒ∞≈û DETAYLARINI KAYDET
        if (cart.length === 0) {
            console.error('‚ùå Sepet bo≈ü, sipari≈ü detayƒ± kaydedilemedi');
            throw new Error('Sepet bo≈ü, sipari≈ü detayƒ± kaydedilemedi');
        }

        console.log('üì¶ Sipari≈ü detaylarƒ± hazƒ±rlanƒ±yor:', cart);

        const orderDetails = cart.map(item => {
            // Eksik alanlarƒ± kontrol et
            if (!item.id || !item.name || !item.price) {
                console.error('‚ùå Ge√ßersiz sepet √∂ƒüesi:', item);
                throw new Error(`Ge√ßersiz sepet √∂ƒüesi: ${item.name}`);
            }
            
            return {
                order_id: order.id,
                product_id: item.id,
                product_name: item.name,
                quantity: item.quantity || 1,
                unit_price: item.price,
                unit_type: item.unit_type || 'adet',
                discount: item.discount || 0,
                tax_rate: item.tax_rate || 0
            };
        });

        console.log('‚úÖ Sipari≈ü detaylarƒ± hazƒ±r:', orderDetails);        
        const { error: detailsError } = await supabase
            .from('order_details')
            .insert(orderDetails);
            
        if (detailsError) {
            console.error('‚ùå Sipari≈ü detaylarƒ± kaydetme hatasƒ±:', detailsError);
            throw new Error(`Sipari≈ü detaylarƒ± kaydedilemedi: ${detailsError.message}`);
        }
        
        console.log('‚úÖ Sipari≈ü detaylarƒ± kaydedildi');
        
        // 3Ô∏è‚É£ BONUS HESAPLA - ESKƒ∞ FONKSƒ∞YONDAN EKLENDƒ∞
        if (currentCustomer) {
            console.log('üéÅ Sipari≈ü bonusu hesaplanƒ±yor...');
            try {
                await calculateOrderBonus(order.id, currentCustomer.id, totalAmount);
                
                // Bonus bakiyesini yenile
                referralBonusBalance = await getUserBonusBalance(currentCustomer.id);
                updateBonusUI();
                
                console.log('‚úÖ Sipari≈ü bonusu hesaplandƒ±');
            } catch (bonusError) {
                console.warn('‚ö†Ô∏è Bonus hesaplama hatasƒ± (sipari≈ü devam ediyor):', bonusError);
                // Bonus hatasƒ± sipari≈üi durdurmasƒ±n
            }
        }
        
        // 4Ô∏è‚É£ √ñDEME KAYITLARINI OLU≈ûTUR - YENƒ∞ EKLENEN
        if (currentPaymentMethod === 'bonus' && usedBonus > 0) {
            await processBonusPayment(order.id, currentCustomer.id, totalAmount, usedBonus, remainingPaymentMethod);
        } else {
            await processRegularPayment(order.id, currentCustomer.id, totalAmount, currentPaymentMethod);
        }
        
        // 5Ô∏è‚É£ REFERRAL KAZAN√áLARINI ƒ∞≈ûLE - YENƒ∞ EKLENEN
        if (currentCustomer) {
            await processReferralPayouts(currentCustomer.id);
        }
        
        // 6Ô∏è‚É£ BA≈ûARILI MESAJ
        const bonusMessage = currentCustomer ? 
            ` Bonus bakiyeniz g√ºncellendi: ${money(referralBonusBalance)}` : 
            '';
            
        // √ñdeme detayƒ± mesajƒ± - YENƒ∞ EKLENEN
        let paymentDetailMessage = '';
        if (currentPaymentMethod === 'bonus' && usedBonus > 0) {
            paymentDetailMessage = ` ${money(usedBonus)} bonus kullanƒ±ldƒ±.`;
            if (remainingAmount > 0) {
                paymentDetailMessage += ` Kalan ${money(remainingAmount)} ${remainingPaymentMethod === 'cash' ? 'nakit' : 'kart'} ile √∂dendi.`;
            }
        }
            
        displayMessage(`üéâ Sipari≈üiniz ba≈üarƒ±yla olu≈üturuldu! Sipari≈ü numaranƒ±z: ${order.id}${paymentDetailMessage}${bonusMessage}`);
        speakToUser("sipari≈üiniz ba≈üarƒ±yla olu≈üturuldu" + (bonusMessage ? " bonusunuz eklendi" : ""));
        
        // 7Ô∏è‚É£ TEMƒ∞ZLƒ∞K
        resetAfterSuccessfulOrder();
        
        return order;
        
    } catch (error) {
        console.error('‚ùå Sƒ∞PARƒ∞≈û KAYDETME HATASI:', error);
        
        // NET HATA MESAJI - ESKƒ∞ FONKSƒ∞YONDAN EKLENDƒ∞
        const errorMessage = `
‚ùå Sƒ∞PARƒ∞≈û HATASI

Sipari≈üiniz kaydedilemedi:
${error.message}

L√ºtfen:
‚Ä¢ ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin
‚Ä¢ Bilgilerinizi kontrol edin  
‚Ä¢ Tekrar deneyin

Teknik Detay: ${error.code || 'Bilinmeyen hata'}
        `;
        
        displayMessage(errorMessage);
        speakToUser("Sipari≈üiniz kaydedilemedi. L√ºtfen tekrar deneyin.");
        
        // Sepeti koru, kullanƒ±cƒ± tekrar denesin - ESKƒ∞ FONKSƒ∞YONDAN EKLENDƒ∞
        console.log('‚ö†Ô∏è Sepet korunuyor, kullanƒ±cƒ± tekrar deneyebilir');
        
        throw error;
    }
}
        
// Ba≈üarƒ±lƒ± sipari≈ü sonrasƒ± reset
function resetAfterSuccessfulOrder() {
    console.log('üîÑ Sipari≈ü sonrasƒ± temizlik...');
    
    // Sepeti temizle
    cart = [];
    updateCartUI();
    
    // Kilitleri kaldƒ±r
    unlockStoreAndSeller();
    
    // √ñdeme s√ºrecini resetle
    resetPaymentProcess();
    
    // Modalƒ± kapat
    closePaymentModal();
    
    // Ana sayfaya d√∂n
    resetToHomepage();
    
    console.log('‚úÖ Sipari≈ü sonrasƒ± temizlik tamamlandƒ±');
}


// √ñdeme s√ºrecini resetle
function resetPaymentProcess() {
    isWaitingForPhone = false;
    isWaitingForName = false;
    isWaitingForBuilding = false;
    isWaitingForApartment = false;
    isWaitingForAddressConfirm = false;
    isWaitingForNewBuilding = false;
    isWaitingForNewApartment = false;
    isWaitingForOrderConfirm = false;
    expectedInput = null;
    
    customerPhone = null;
    customerName = null;
    buildingNumber = null;
    apartmentNumber = null;
    useRegisteredAddress = false;
    currentPaymentMethod = null;
    
    console.log('‚úÖ √ñdeme s√ºreci resetlendi');
}

// Ana sayfaya d√∂n
function resetToHomepage() {
    selectedStoreTypeId = null;
    selectedSellerId = null;
    selectedCategoryId = null;
    products = [];
    
    document.querySelectorAll('.seller-type-card, .seller-card, .category-card, .product-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    if (sellersSection) sellersSection.style.display = 'none';
    if (categoriesSection) categoriesSection.style.display = 'none';
    if (productsSection) productsSection.style.display = 'none';
    
    closeDynamicCart();
    
    displayMessage("üîÑ Ana sayfaya d√∂n√ºl√ºyor...");
    speakToUser("Ana sayfaya d√∂n√ºl√ºyor");
}

// Hata durumunda kullanƒ±cƒ±ya yardƒ±mcƒ± olacak fonksiyon
function showOrderRetryOptions() {
    const modalBody = document.getElementById('paymentModalBody');
    if (modalBody) {
        modalBody.innerHTML = `
            <div class="error-retry-section">
                <div class="error-icon">‚ùå</div>
                <h4>Sipari≈ü Kaydedilemedi</h4>
                <p>Sipari≈üiniz ≈üu anda kaydedilemiyor. L√ºtfen a≈üaƒüƒ±daki se√ßeneklerden birini deneyin:</p>
                
                <div class="retry-options">
                    <button class="retry-btn primary" onclick="retryOrder()">
                        <i class="fas fa-redo"></i> Tekrar Dene
                    </button>
                    <button class="retry-btn secondary" onclick="saveOrderForLater()">
                        <i class="fas fa-save"></i> Sipari≈üi Kaydet (Ge√ßici)
                    </button>
                    <button class="retry-btn danger" onclick="cancelOrder()">
                        <i class="fas fa-times"></i> ƒ∞ptal Et
                    </button>
                </div>
                
                <div class="error-help">
                    <p><strong>Yardƒ±m:</strong></p>
                    <ul>
                        <li>ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin</li>
                        <li>Sayfayƒ± yenileyip tekrar deneyin</li>
                        <li>M√º≈üteri hizmetlerini arayƒ±n</li>
                    </ul>
                </div>
            </div>
        `;
    }
}

// Tekrar deneme fonksiyonu
async function retryOrder() {
    displayMessage("üîÑ Sipari≈ü tekrar deneniyor...");
    speakToUser("Sipari≈ü tekrar deneniyor");
    await saveOrder();
}

// Ge√ßici kaydetme (sadece localStorage)
function saveOrderForLater() {
    const tempOrder = {
        customer: {
            name: customerName,
            phone: customerPhone
        },
        items: cart,
        total: calculateTotal(),
        delivery_address: formatDeliveryAddress(),
        timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('pendingOrder', JSON.stringify(tempOrder));
    displayMessage("üíæ Sipari≈ü ge√ßici olarak kaydedildi. Daha sonra tamamlayabilirsiniz.");
    speakToUser("Sipari≈ü ge√ßici kaydedildi");
    resetAfterSuccessfulOrder();
}

// ƒ∞ptal fonksiyonu
function cancelOrder() {
    displayMessage("‚ùå Sipari≈ü iptal edildi");
    speakToUser("Sipari≈ü iptal edildi");
    resetAfterSuccessfulOrder();
}
// =============================================
// YARDIMCI FONKSƒ∞YONLAR
// =============================================

function getPaymentMethodName(method) {
    const methods = {
        'cash': 'Nakit',
        'card': 'Kart',
        'bonus': 'Bonus'
    };
    return methods[method] || method;
}

async function checkCustomerByPhone(phone) {
    try {
        const { data, error } = await supabase
            .from('customers')
            .select('*')
            .eq('phone', phone)
            .single();
            
        if (error && error.code !== '406') {
            console.error('M√º≈üteri sorgulama hatasƒ±:', error);
        }
        
        return data || null;
    } catch (error) {
        console.error('M√º≈üteri kontrol hatasƒ±:', error);
        return null;
    }
}

// =============================================
// MANUEL √ñDEME FORM√ú
// =============================================

function showManualPaymentForm() {
    console.log('üìù Manuel √∂deme formu g√∂steriliyor...');
    
    const modalBody = document.getElementById('paymentModalBody');
    if (!modalBody) return;
    
    const totalAmount = calculateTotal();
    const currentAddress = currentCustomer ? currentCustomer.address : '';
    const bonusBalance = currentCustomer ? (currentCustomer.bonus_balance || 0) : 0;
    
    modalBody.innerHTML = `
        <div class="manual-payment-form">
            <h4>√ñdeme Bilgileri</h4>
            
            <div class="form-group">
                <label for="manualPhone">Telefon Numarasƒ±</label>
                <input type="tel" id="manualPhone" value="${customerPhone || ''}" 
                       placeholder="05XX XXX XX XX">
            </div>
            
            <div class="form-group">
                <label for="manualName">Ad Soyad</label>
                <input type="text" id="manualName" value="${currentCustomer ? currentCustomer.name : customerName || ''}" 
                       placeholder="Adƒ±nƒ±z ve soyadƒ±nƒ±z">
            </div>
            
            <div class="form-group">
                <label for="manualAddress">Teslimat Adresi</label>
                <textarea id="manualAddress" rows="3" placeholder="Teslimat adresiniz">${currentAddress}</textarea>
            </div>
            
            <div class="form-group">
                <label for="manualBuilding">Bina No</label>
                <input type="text" id="manualBuilding" value="${buildingNumber || ''}" 
                       placeholder="Bina numarasƒ±">
            </div>
            
            <div class="form-group">
                <label for="manualApartment">Daire No</label>
                <input type="text" id="manualApartment" value="${apartmentNumber || ''}" 
                       placeholder="Daire numarasƒ±">
            </div>
            
            <div class="form-group">
                <label>√ñdeme Y√∂ntemi</label>
                <div class="payment-methods">
                    <label class="payment-method">
                        <input type="radio" name="manualPayment" value="cash" ${currentPaymentMethod === 'cash' ? 'checked' : ''}>
                        <span>Nakit</span>
                    </label>
                    <label class="payment-method">
                        <input type="radio" name="manualPayment" value="card" ${currentPaymentMethod === 'card' ? 'checked' : ''}>
                        <span>Kart</span>
                    </label>
                    <label class="payment-method">
                        <input type="radio" name="manualPayment" value="bonus" ${currentPaymentMethod === 'bonus' ? 'checked' : ''}>
                        <span>Bonus</span>
                    </label>
                </div>
            </div>
            
            <!-- YENƒ∞ EKLENEN BONUS √ñDEME DETAYLARI -->
            <div id="bonusPaymentDetails" style="display: ${currentPaymentMethod === 'bonus' ? 'block' : 'none'};">
                <div class="bonus-payment-section">
                    <h5>üéÅ Bonus √ñdeme Detaylarƒ±</h5>
                    
                    <div class="bonus-info">
                        <div class="bonus-row">
                            <span>Bonus Bakiyeniz:</span>
                            <strong class="bonus-balance">${money(bonusBalance)}</strong>
                        </div>
                        <div class="bonus-row">
                            <span>Toplam Tutar:</span>
                            <strong>${money(totalAmount)}</strong>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="manualBonusAmount">Kullanƒ±lacak Bonus Miktarƒ±:</label>
                        <input type="number" id="manualBonusAmount" 
                               value="${Math.min(bonusBalance, totalAmount)}" 
                               min="0" max="${bonusBalance}" step="1" 
                               class="form-control">
                        <small>Maksimum kullanabileceƒüiniz: ${money(bonusBalance)}</small>
                    </div>
                    
                    <div class="form-group" id="remainingPaymentSection">
                        <label>Kalan Tutar √ñdeme Y√∂ntemi:</label>
                        <div class="payment-options">
                            <label class="payment-option">
                                <input type="radio" name="remainingPayment" value="cash" checked>
                                <span>üíµ Nakit</span>
                            </label>
                            <label class="payment-option">
                                <input type="radio" name="remainingPayment" value="card">
                                <span>üí≥ Kart</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="payment-summary" id="bonusPaymentSummary">
                        <div class="summary-row">
                            <span>Kullanƒ±lacak Bonus:</span>
                            <strong id="usedBonusDisplay">${money(Math.min(bonusBalance, totalAmount))}</strong>
                        </div>
                        <div class="summary-row">
                            <span>Kalan √ñdeme:</span>
                            <strong id="remainingAmountDisplay">${money(Math.max(0, totalAmount - Math.min(bonusBalance, totalAmount)))}</strong>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="order-summary">
                <h5>Sipari≈ü √ñzeti</h5>
                <p>Toplam Tutar: <strong>${money(totalAmount)}</strong></p>
            </div>
        </div>
    `;
    
    // √ñdeme y√∂ntemi deƒüi≈üikliklerini dinle
    setupManualPaymentListeners();
    
    // Kaydet butonunu g√∂ster
    const saveBtn = document.getElementById('savePaymentInfoBtn');
    if (saveBtn) {
        saveBtn.style.display = 'block';
    }
}
        
function setupManualFormListeners() {
    console.log('üéØ Manuel form dinleyicileri kuruluyor...');
    
    // √ñdeme y√∂ntemi radyo butonlarƒ±nƒ± dinle
    const paymentRadios = document.querySelectorAll('input[name="manualPayment"]');
    paymentRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            const selectedMethod = this.value;
            const bonusDetails = document.getElementById('bonusPaymentDetails');
            
            if (selectedMethod === 'bonus') {
                bonusDetails.style.display = 'block';
                updateBonusPaymentSummary();
            } else {
                bonusDetails.style.display = 'none';
            }
        });
    });
    
    // Bonus miktarƒ± deƒüi≈üikliklerini dinle
    const bonusAmountInput = document.getElementById('manualBonusAmount');
    if (bonusAmountInput) {
        bonusAmountInput.addEventListener('input', updateBonusPaymentSummary);
    }
    
    // Kalan √∂deme y√∂ntemi deƒüi≈üikliklerini dinle
    const remainingPaymentRadios = document.querySelectorAll('input[name="remainingPayment"]');
    remainingPaymentRadios.forEach(radio => {
        radio.addEventListener('change', updateBonusPaymentSummary);
    });
    
    // Telefon input'unu dinle (formatlama i√ßin)
    const phoneInput = document.getElementById('manualPhone');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0) {
                value = value.match(/.{1,4}/g).join(' ');
            }
            e.target.value = value;
        });
    }
}
function updateBonusPaymentSummary() {
    const totalAmount = calculateTotal();
    const bonusBalance = currentCustomer ? (currentCustomer.bonus_balance || 0) : 0;
    const bonusAmountInput = document.getElementById('manualBonusAmount');
    const usedBonusDisplay = document.getElementById('usedBonusDisplay');
    const remainingAmountDisplay = document.getElementById('remainingAmountDisplay');
    
    if (!bonusAmountInput || !usedBonusDisplay || !remainingAmountDisplay) return;
    
    let usedBonus = parseFloat(bonusAmountInput.value) || 0;
    
    // Validasyon
    if (usedBonus > bonusBalance) {
        usedBonus = bonusBalance;
        bonusAmountInput.value = bonusBalance;
    }
    
    if (usedBonus > totalAmount) {
        usedBonus = totalAmount;
        bonusAmountInput.value = totalAmount;
    }
    
    const remainingAmount = totalAmount - usedBonus;
    
    // UI g√ºncelle
    usedBonusDisplay.textContent = money(usedBonus);
    remainingAmountDisplay.textContent = money(remainingAmount);
    
    // Kalan √∂deme b√∂l√ºm√ºn√º g√∂ster/gizle
    const remainingSection = document.getElementById('remainingPaymentSection');
    if (remainingSection) {
        remainingSection.style.display = remainingAmount > 0 ? 'block' : 'none';
    }
}

function savePaymentInfoManually() {
    console.log('üíæ Manuel √∂deme bilgileri kaydediliyor...');
    
    try {
        // Temel bilgileri al
        const manualPhone = document.getElementById('manualPhone').value;
        const manualName = document.getElementById('manualName').value;
        const manualAddress = document.getElementById('manualAddress').value;
        const manualBuilding = document.getElementById('manualBuilding').value;
        const manualApartment = document.getElementById('manualApartment').value;
        const paymentMethod = document.querySelector('input[name="manualPayment"]:checked').value;
        
        // Validasyon
        if (!manualPhone || !manualName || !manualAddress) {
            displayMessage("‚ùå L√ºtfen zorunlu alanlarƒ± doldurun!");
            speakToUser("L√ºtfen telefon, ad ve adres bilgilerinizi girin");
            return;
        }
        
        // Telefon formatƒ±nƒ± kontrol et
        const phoneResult = formatPhoneNumber(manualPhone);
        if (!phoneResult.success) {
            displayMessage("‚ùå Ge√ßersiz telefon numarasƒ± formatƒ±!");
            speakToUser("Ge√ßersiz telefon numarasƒ±");
            return;
        }
        
        // Bilgileri kaydet
        customerPhone = phoneResult.raw;
        customerName = manualName;
        buildingNumber = manualBuilding;
        apartmentNumber = manualApartment;
        currentPaymentMethod = paymentMethod;
        
        // Bonus √∂deme detaylarƒ±nƒ± i≈üle
        if (paymentMethod === 'bonus') {
            handleManualBonusPayment();
        } else {
            // Diƒüer √∂deme y√∂ntemleri i√ßin bonus bilgilerini temizle
            window.usedBonusAmount = null;
            window.remainingPaymentMethod = null;
        }
        
        // Ba≈üarƒ± mesajƒ± ve y√∂nlendirme
        showSaveSuccessMessage(paymentMethod);
        
    } catch (error) {
        console.error('‚ùå Manuel √∂deme kaydetme hatasƒ±:', error);
        displayMessage("‚ùå Bilgiler kaydedilemedi!");
        speakToUser("Kayƒ±t sƒ±rasƒ±nda hata olu≈ütu");
    }
}

// YARDIMCI FONKSƒ∞YONLAR
function handleManualBonusPayment() {
    const bonusAmountInput = document.getElementById('manualBonusAmount');
    const remainingPaymentRadio = document.querySelector('input[name="remainingPayment"]:checked');
    
    if (!bonusAmountInput) return;
    
    const usedBonus = parseFloat(bonusAmountInput.value) || 0;
    const totalAmount = calculateTotal();
    const bonusBalance = currentCustomer ? (currentCustomer.bonus_balance || 0) : 0;
    
    // Bonus validasyonu
    if (usedBonus > bonusBalance) {
        displayMessage("‚ùå Girdiƒüiniz bonus miktarƒ± bakiyenizden fazla!");
        speakToUser("Bonus miktarƒ± ge√ßersiz");
        throw new Error("Bonus miktarƒ± fazla");
    }
    
    if (usedBonus > totalAmount) {
        displayMessage("‚ùå Girdiƒüiniz bonus miktarƒ± sipari≈ü tutarƒ±ndan fazla!");
        speakToUser("Bonus miktarƒ± sipari≈ü tutarƒ±ndan fazla");
        throw new Error("Bonus miktarƒ± fazla");
    }
    
    const remainingAmount = totalAmount - usedBonus;
    
    // Kalan √∂deme kontrol√º
    if (remainingAmount > 0 && !remainingPaymentRadio) {
        displayMessage("‚ùå L√ºtfen kalan √∂deme y√∂ntemini se√ßin!");
        speakToUser("Kalan √∂deme y√∂ntemi se√ßilmedi");
        throw new Error("Kalan √∂deme y√∂ntemi se√ßilmedi");
    }
    
    // Bonus bilgilerini kaydet
    window.usedBonusAmount = usedBonus;
    window.remainingPaymentMethod = remainingAmount > 0 ? remainingPaymentRadio.value : null;
    
    console.log(`üí∞ Manuel bonus ayarƒ±: ${usedBonus} bonus + ${remainingAmount} ${window.remainingPaymentMethod}`);
}

function showSaveSuccessMessage(paymentMethod) {
    let successMessage = `‚úÖ Bilgiler kaydedildi!`;
    
    if (paymentMethod === 'bonus' && window.usedBonusAmount) {
        const remainingAmount = calculateTotal() - window.usedBonusAmount;
        successMessage += ` ${money(window.usedBonusAmount)} bonus kullanƒ±lacak`;
        if (remainingAmount > 0) {
            successMessage += `, kalan ${money(remainingAmount)} ${window.remainingPaymentMethod === 'cash' ? 'nakit' : 'kart'} ile √∂denecek`;
        }
    }
    
    displayMessage(successMessage);
    speakToUser("Bilgileriniz kaydedildi");
    
    // Sipari≈ü √∂zetine ge√ß
    setTimeout(() => {
        requestOrderConfirmation();
    }, 2000);
}

        
function closeManualPaymentForm() {
    console.log('‚ùå Manuel √∂deme formu kapatƒ±lƒ±yor...');
    
    // Sesli komutlarƒ± geri y√ºkle
    restoreDefaultVoiceCommands();
    
    const modalBody = document.getElementById('paymentModalBody');
    if (modalBody) {
        // Sipari≈ü √∂zetine geri d√∂n
        requestOrderConfirmation();
    }
    
    // Butonlarƒ± eski haline getir
    const manualEditBtn = document.getElementById('manualEditBtn');
    const savePaymentInfoBtn = document.getElementById('savePaymentInfoBtn');
    
    if (manualEditBtn) manualEditBtn.style.display = 'block';
    if (savePaymentInfoBtn) savePaymentInfoBtn.style.display = 'none';
    
    // Bonus bilgilerini temizle
    window.usedBonusAmount = null;
    window.remainingPaymentMethod = null;
}


        // Debug i√ßin: Sesli komutlarƒ± konsolda g√∂ster
function debugVoiceCommands() {
    console.log('üîç SESLƒ∞ KOMUTLAR DURUMU:');
    console.log(`üìä Toplam komut: ${voiceCommands.length}`);
    voiceCommands.forEach((cmd, index) => {
        console.log(`  ${index + 1}. Komut: ${cmd.command.join(', ')}`);
    });
}
// =============================================
// M√ú≈ûTERƒ∞ BONUS BAKƒ∞YESƒ∞ G√úNCELLEME
// =============================================

async function updateCustomerBonusBalance(customerId) {
    try {
        console.log('üîÑ M√º≈üteri bonus bakiyesi g√ºncelleniyor:', customerId);
        
        // 1. √ñdenmemi≈ü referral kazan√ßlarƒ±nƒ± topla
        const { data: pendingPayouts, error: payoutError } = await supabase
            .from('referral_payouts')
            .select(`
                id,
                amount,
                status,
                referral_bonus:referral_bonus_id (
                    customer_id,
                    order_id,
                    bonus_type
                )
            `)
            .eq('referral_bonus.customer_id', customerId)
            .eq('status', 'pending')
            .is('paid_at', null);
            
        if (payoutError) {
            console.error('‚ùå Referral kazan√ßlarƒ± sorgu hatasƒ±:', payoutError);
            return { success: false, error: payoutError };
        }

        if (!pendingPayouts || pendingPayouts.length === 0) {
            console.log('‚ÑπÔ∏è √ñdenmemi≈ü referral kazancƒ± bulunamadƒ±');
            return { success: true, totalAdded: 0, message: '√ñdenmemi≈ü kazan√ß yok' };
        }

        // 2. Toplam bonus miktarƒ±nƒ± hesapla
        const totalBonus = pendingPayouts.reduce((sum, payout) => sum + payout.amount, 0);
        console.log(`üí∞ Toplam eklenecek bonus: ${totalBonus} TL`);

        // 3. Mevcut bakiyeyi al
        const { data: customer, error: customerError } = await supabase
            .from('customers')
            .select('bonus_balance, name')
            .eq('id', customerId)
            .single();

        if (customerError) {
            console.error('‚ùå M√º≈üteri bilgisi alma hatasƒ±:', customerError);
            return { success: false, error: customerError };
        }

        const previousBalance = customer.bonus_balance || 0;
        const newBalance = previousBalance + totalBonus;

        // 4. Bonus bakiyesini g√ºncelle
        const { error: updateError } = await supabase
            .from('customers')
            .update({ 
                bonus_balance: newBalance,
                updated_at: new Date().toISOString()
            })
            .eq('id', customerId);

        if (updateError) {
            console.error('‚ùå Bonus bakiye g√ºncelleme hatasƒ±:', updateError);
            return { success: false, error: updateError };
        }

        // 5. Referral kazan√ßlarƒ±nƒ± √∂dendi olarak i≈üaretle
        const payoutIds = pendingPayouts.map(p => p.id);
        const { error: markPaidError } = await supabase
            .from('referral_payouts')
            .update({ 
                status: 'completed',
                paid_at: new Date().toISOString()
            })
            .in('id', payoutIds);

        if (markPaidError) {
            console.error('‚ùå Referral √∂deme durumu g√ºncelleme hatasƒ±:', markPaidError);
            // Bu hata kritik deƒüil, devam et
        }

        console.log(`‚úÖ ${payoutIds.length} referral kazancƒ± bonus bakiyesine eklendi: +${totalBonus} TL`);
        console.log(`üí∞ Yeni bonus bakiyesi: ${previousBalance} ‚Üí ${newBalance}`);

        return {
            success: true,
            totalAdded: totalBonus,
            previousBalance: previousBalance,
            newBalance: newBalance,
            payoutsProcessed: payoutIds.length
        };

    } catch (error) {
        console.error('‚ùå Bonus bakiye g√ºncelleme hatasƒ±:', error);
        return { success: false, error: error.message };
    }
}
        
// Yardƒ±mcƒ± fonksiyon
async function getCustomerBonusBalance(customerId) {
    try {
        const { data: customer, error } = await supabase
            .from('customers')
            .select('bonus_balance')
            .eq('id', customerId)
            .single();
            
        if (error) throw error;
        return customer?.bonus_balance || 0;
    } catch (error) {
        console.error('‚ùå Bonus bakiye alma hatasƒ±:', error);
        return 0;
    }
}
// =============================================
// Sƒ∞PARƒ∞≈û DURUMU G√úNCELLEME
// =============================================

async function updateOrderStatus(orderId, status) {
    try {
        console.log(`üîÑ Sipari≈ü durumu g√ºncelleniyor: ${orderId} -> ${status}`);
        
        const validStatuses = ['pending', 'confirmed', 'preparing', 'on_delivery', 'delivered', 'cancelled'];
        
        if (!validStatuses.includes(status)) {
            throw new Error(`Ge√ßersiz sipari≈ü durumu: ${status}`);
        }

        const { error } = await supabase
            .from('orders')
            .update({ 
                status: status,
                updated_at: new Date().toISOString()
            })
            .eq('id', orderId);

        if (error) {
            console.error('‚ùå Sipari≈ü durumu g√ºncelleme hatasƒ±:', error);
            throw error;
        }

        console.log(`‚úÖ Sipari≈ü durumu g√ºncellendi: ${status}`);
        return { success: true, status: status };

    } catch (error) {
        console.error('‚ùå Sipari≈ü durumu g√ºncelleme hatasƒ±:', error);
        throw error;
    }
}
        
// =============================================
// √ñDEME YARDIMCI FONKSƒ∞YONLARI
// =============================================

async function askPaymentMethod(amount) {
    return new Promise((resolve) => {
        console.log(`üí≥ √ñdeme y√∂ntemi soruluyor: ${amount} TL`);
        
        // UI'da √∂deme y√∂ntemi se√ßim ekranƒ± g√∂ster
        const modalBody = document.getElementById('paymentModalBody');
        if (modalBody) {
            modalBody.innerHTML = `
                <div class="payment-method-selection">
                    <h4>üí≥ √ñdeme Y√∂ntemi Se√ßin</h4>
                    <p>${money(amount)} tutarƒ± i√ßin √∂deme y√∂ntemi se√ßin:</p>
                    <div class="payment-method-buttons">
                        <button class="payment-method-btn cash-btn" onclick="selectPaymentMethodUI('cash')">
                            üíµ Nakit
                        </button>
                        <button class="payment-method-btn card-btn" onclick="selectPaymentMethodUI('card')">
                            üí≥ Kart
                        </button>
                    </div>
                </div>
            `;
            
            // Global fonksiyon
            window.selectPaymentMethodUI = function(method) {
                console.log(`‚úÖ √ñdeme y√∂ntemi se√ßildi: ${method}`);
                resolve(method);
            };
        }
        
        // Sesli bildirim
        displayMessage(`üí≥ ${money(amount)} i√ßin √∂deme y√∂ntemi se√ßin: Nakit mi Kart mƒ±?`);
        speakToUser(`${money(amount)} i√ßin nakit mi kart mƒ±?`);
    });
}
        
async function askConfirmation(question) {
    return new Promise((resolve) => {
        console.log(`‚ùì Onay soruluyor: ${question}`);
        
        // UI'da onay butonlarƒ± g√∂ster
        const modalBody = document.getElementById('paymentModalBody');
        if (modalBody) {
            modalBody.innerHTML = `
                <div class="confirmation-dialog">
                    <h4>‚ùì Onay</h4>
                    <p>${question}</p>
                    <div class="confirmation-buttons">
                        <button class="confirm-btn yes-btn" onclick="confirmSelectionUI(true)">
                            ‚úÖ Evet
                        </button>
                        <button class="confirm-btn no-btn" onclick="confirmSelectionUI(false)">
                            ‚ùå Hayƒ±r
                        </button>
                    </div>
                </div>
            `;
            
            // Global fonksiyon
            window.confirmSelectionUI = function(response) {
                console.log(`‚úÖ Onay cevabƒ±: ${response}`);
                resolve(response);
            };
        }
        
        // Sesli bildirim
        displayMessage(`‚ùì ${question} (Evet/Hayƒ±r)`);
        speakToUser(question);
    });
}
        
function displayPaymentMethods(amount, callback) {
    console.log(`üí≥ √ñdeme y√∂ntemleri g√∂steriliyor: ${amount} TL`);
    
    const modalBody = document.getElementById('paymentModalBody');
    if (modalBody) {
        modalBody.innerHTML = `
            <div class="payment-methods-display">
                <h4>üí≥ √ñdeme Se√ßenekleri</h4>
                <p>${money(amount)} i√ßin √∂deme y√∂ntemi:</p>
                <div class="payment-options-grid">
                    <button class="payment-option" onclick="handlePaymentOptionSelect('cash')">
                        <div class="payment-icon">üíµ</div>
                        <div class="payment-text">Nakit</div>
                    </button>
                    <button class="payment-option" onclick="handlePaymentOptionSelect('card')">
                        <div class="payment-icon">üí≥</div>
                        <div class="payment-text">Kart</div>
                    </button>
                    <button class="payment-option" onclick="handlePaymentOptionSelect('bonus')">
                        <div class="payment-icon">üéÅ</div>
                        <div class="payment-text">Bonus</div>
                    </button>
                </div>
            </div>
        `;
        
        window.handlePaymentOptionSelect = function(method) {
            console.log(`‚úÖ √ñdeme se√ßeneƒüi se√ßildi: ${method}`);
            callback(method);
        };
    }
}
   // =============================================
// BONUS HAREKET KAYITLARI
// =============================================

async function createBonusTransaction(customerId, type, amount, referenceId = null, referenceType = null) {
    try {
        console.log(`üìù Bonus hareketi olu≈üturuluyor: ${type} - ${amount}`);
        
        // Mevcut bakiyeyi al
        const { data: customer, error: customerError } = await supabase
            .from('customers')
            .select('bonus_balance')
            .eq('id', customerId)
            .single();

        if (customerError) throw customerError;

        const previousBalance = customer.bonus_balance || 0;
        const newBalance = type === 'debit' ? previousBalance - amount : previousBalance + amount;

        // Hareket kaydƒ± olu≈ütur
        const transactionData = {
            customer_id: customerId,
            type: type,
            amount: amount,
            previous_balance: previousBalance,
            new_balance: newBalance,
            description: getTransactionDescription(type, amount),
            created_at: new Date().toISOString()
        };

        // Referans bilgileri
        if (referenceId) {
            transactionData.reference_id = referenceId;
            transactionData.reference_type = referenceType;
        }

        const { data: transaction, error: transactionError } = await supabase
            .from('bonus_transactions')
            .insert([transactionData])
            .select()
            .single();

        if (transactionError) throw transactionError;

        console.log(`‚úÖ Bonus hareketi kaydedildi: ${transaction.id}`);
        return transaction;

    } catch (error) {
        console.error('‚ùå Bonus hareketi kaydetme hatasƒ±:', error);
        throw error;
    }
}
function getTransactionDescription(type, amount) {
    const descriptions = {
        'referral_earning': `Referral kazancƒ±: +${money(amount)}`,
        'bonus_payment': `Bonus √∂demesi: -${money(amount)}`,
        'manual_adjustment': `Manual ayarlama: ${money(amount)}`,
        'refund': `Bonus iadesi: +${money(amount)}`,
        'order_bonus': `Sipari≈ü bonusu: +${money(amount)}`
    };
    
    return descriptions[type] || `${type}: ${money(amount)}`;
}

// =============================================
// SESLƒ∞ KOMUT TAMAMLAYICILARI
// =============================================
// =============================================
// SESLƒ∞ KOMUT TAMAMLAYICILARI
// =============================================

function setupBonusVoiceCommands() {
    console.log('üé§ Bonus sesli komutlarƒ± kuruluyor...');
    
    // Bonus bakiyesi sorgulama
    voiceCommands.push({
        command: ['bonus', 'bonusum', 'bakiyem', 'puan', 'puanƒ±m'],
        callback: async () => {
            if (currentCustomer) {
                const balance = await getCustomerBonusBalance(currentCustomer.id);
                speakToUser(`Bonus bakiyeniz ${money(balance)}`);
                displayMessage(`üí∞ Bonus bakiyeniz: ${money(balance)}`);
                return true;
            }
            return false;
        }
    });
    
    // Bonus g√ºncelleme
    voiceCommands.push({
        command: ['bonus g√ºncelle', 'bakiyemi g√ºncelle', 'puanlarƒ± kontrol et'],
        callback: async () => {
            if (currentCustomer) {
                const result = await updateCustomerBonusBalance(currentCustomer.id);
                if (result.success && result.totalAdded > 0) {
                    speakToUser(`${money(result.totalAdded)} bonus bakiyenize eklendi`);
                    displayMessage(`üéâ ${money(result.totalAdded)} bonus eklendi! Yeni bakiye: ${money(result.newBalance)}`);
                } else {
                    speakToUser("Yeni bonus kazancƒ±nƒ±z bulunmuyor");
                    displayMessage("‚ÑπÔ∏è Yeni bonus kazancƒ±nƒ±z bulunmuyor");
                }
                return true;
            }
            return false;
        }
    });
}

function cleanupVoiceCommands() {
    console.log('üßπ Sesli komutlar temizleniyor...');
    // √ñzel komutlarƒ± temizle (modal kapandƒ±ƒüƒ±nda)
    voiceCommands = voiceCommands.filter(cmd => 
        !['bonus', 'bonusum', 'bakiyem', 'bonus g√ºncelle', 'bakiyemi g√ºncelle'].some(keyword => 
            cmd.command.includes(keyword)
        )
    );
}

// =============================================
// ANA BONUS √ñDEME Sƒ∞STEMƒ∞ (EKSƒ∞K)
// =============================================

async function handleBonusPayment(orderId, customerId, totalAmount) {
    try {
        console.log(`üí∞ Bonus √∂deme i≈üleniyor: ${totalAmount} TL`);
        
        // 1. √ñnce bonus bakiyesini g√ºncelle
        await updateCustomerBonusBalance(customerId);
        
        // 2. G√ºncel bonus bakiyesini al
        const bonusBalance = await getCustomerBonusBalance(customerId);
        
        // 3. Bonus yeterli mi kontrol et
        if (bonusBalance >= totalAmount) {
            // Tam bonus √∂deme
            return await processFullBonusPayment(orderId, customerId, totalAmount, bonusBalance);
        } else if (bonusBalance > 0) {
            // Kƒ±smi bonus √∂deme
            return await processPartialPayment(orderId, customerId, totalAmount, bonusBalance);
        } else {
            // Bonus yok, normal √∂deme
            return await processNonBonusPayment(orderId, customerId, totalAmount);
        }
        
    } catch (error) {
        console.error('‚ùå Bonus √∂deme i≈üleme hatasƒ±:', error);
        throw error;
    }
}

  async function processFullBonusPayment(orderId, customerId, totalAmount, bonusBalance) {
    try {
        console.log(`üéØ Tam bonus √∂deme: ${totalAmount} TL`);
        
        // 1. Bonus bakiyesini g√ºncelle
        const newBalance = bonusBalance - totalAmount;
        const { error: updateError } = await supabase
            .from('customers')
            .update({ 
                bonus_balance: newBalance,
                updated_at: new Date().toISOString()
            })
            .eq('id', customerId);
            
        if (updateError) throw updateError;
        
        // 2. √ñdeme kaydƒ± olu≈ütur
        const paymentData = {
            order_id: orderId,
            customer_id: customerId,
            payment_method: 'bonus',
            payment_type: 'bonus_only',
            amount: totalAmount,
            bonus_amount: totalAmount,
            cash_amount: 0,
            card_amount: 0,
            status: 'completed',
            payment_date: new Date().toISOString()
        };
        
        const { error: paymentError } = await supabase
            .from('customer_payments')
            .insert([paymentData]);
            
        if (paymentError) throw paymentError;
        
        // 3. Bonus hareketi kaydet
        await createBonusTransaction(customerId, 'bonus_payment', totalAmount, orderId, 'order_payment');
        
        console.log(`‚úÖ Tam bonus √∂deme tamamlandƒ±: ${totalAmount} TL`);
        return { success: true, usedBonus: totalAmount, remainingAmount: 0 };
        
    } catch (error) {
        console.error('‚ùå Tam bonus √∂deme hatasƒ±:', error);
        throw error;
    }
}

async function processPartialPayment(orderId, customerId, totalAmount, bonusBalance) {
    try {
        const usedBonus = Math.min(bonusBalance, totalAmount);
        const remainingAmount = totalAmount - usedBonus;
        
        console.log(`üîÄ Kƒ±smi bonus √∂deme: ${usedBonus} bonus + ${remainingAmount} nakit/kart`);
        
        // 1. Kalan √∂deme y√∂ntemini sor
        const remainingPaymentMethod = await askPaymentMethod(remainingAmount);
        if (!remainingPaymentMethod) {
            throw new Error('√ñdeme y√∂ntemi se√ßilmedi');
        }
        
        // 2. Bonus bakiyesini g√ºncelle
        const newBalance = bonusBalance - usedBonus;
        const { error: updateError } = await supabase
            .from('customers')
            .update({ 
                bonus_balance: newBalance,
                updated_at: new Date().toISOString()
            })
            .eq('id', customerId);
            
        if (updateError) throw updateError;
        
        // 3. √ñdeme kaydƒ± olu≈ütur
        const paymentData = {
            order_id: orderId,
            customer_id: customerId,
            payment_method: 'mixed',
            payment_type: 'partial',
            amount: totalAmount,
            bonus_amount: usedBonus,
            status: 'completed',
            payment_date: new Date().toISOString()
        };
        
        // Kalan √∂deme y√∂ntemini ekle
        if (remainingPaymentMethod === 'cash') {
            paymentData.cash_amount = remainingAmount;
            paymentData.card_amount = 0;
        } else {
            paymentData.card_amount = remainingAmount;
            paymentData.cash_amount = 0;
        }
        
        const { error: paymentError } = await supabase
            .from('customer_payments')
            .insert([paymentData]);
            
        if (paymentError) throw paymentError;
        
        // 4. Bonus hareketi kaydet
        if (usedBonus > 0) {
            await createBonusTransaction(customerId, 'bonus_payment', usedBonus, orderId, 'order_payment');
        }
        
        console.log(`‚úÖ Kƒ±smi bonus √∂deme tamamlandƒ±: ${usedBonus} bonus + ${remainingAmount} ${remainingPaymentMethod}`);
        return { 
            success: true, 
            usedBonus: usedBonus, 
            remainingAmount: remainingAmount,
            remainingPaymentMethod: remainingPaymentMethod
        };
        
    } catch (error) {
        console.error('‚ùå Kƒ±smi bonus √∂deme hatasƒ±:', error);
        throw error;
    }
}

async function processNonBonusPayment(orderId, customerId, totalAmount) {
    try {
        console.log(`üí≥ Normal √∂deme: ${totalAmount} TL`);
        
        // √ñdeme y√∂ntemini sor
        const paymentMethod = await askPaymentMethod(totalAmount);
        if (!paymentMethod) {
            throw new Error('√ñdeme y√∂ntemi se√ßilmedi');
        }
        
        return await processRegularPayment(orderId, customerId, totalAmount, paymentMethod);
        
    } catch (error) {
        console.error('‚ùå Normal √∂deme hatasƒ±:', error);
        throw error;
    }
}

  // =============================================
// REFERRAL PAYOUT Sƒ∞STEMƒ∞
// =============================================

async function createReferralPayoutRecord(customerId, orderId, amount, payoutType) {
    try {
        console.log(`üéÅ Referral payout olu≈üturuluyor: ${amount} TL - ${payoutType}`);
        
        // 1. Referral bonus kaydƒ±nƒ± bul veya olu≈ütur
        const referralBonus = await findOrCreateReferralBonus(customerId, orderId, amount, payoutType);
        
        // 2. Referral payout kaydƒ± olu≈ütur
        const payoutData = {
            referral_bonus_id: referralBonus.id,
            amount: amount,
            status: 'pending', // √ñnce pending, sonra completed
            created_at: new Date().toISOString()
        };
        
        const { data: payout, error: payoutError } = await supabase
            .from('referral_payouts')
            .insert([payoutData])
            .select()
            .single();
            
        if (payoutError) {
            console.error('‚ùå Referral payout kaydƒ± hatasƒ±:', payoutError);
            throw payoutError;
        }
        
        console.log(`‚úÖ Referral payout olu≈üturuldu: ${payout.id}`);
        return payout;
        
    } catch (error) {
        console.error('‚ùå Referral payout olu≈üturma hatasƒ±:', error);
        throw error;
    }
}      
        
async function findOrCreateReferralBonus(customerId, orderId, amount, bonusType = 'order_payment') {
    try {
        console.log(`üîç Referral bonus aranƒ±yor/olu≈üturuluyor: ${customerId}`);
        
        // Mevcut referral bonus kaydƒ±nƒ± ara
        const { data: existingBonus, error: queryError } = await supabase
            .from('referral_bonus')
            .select('*')
            .eq('customer_id', customerId)
            .eq('order_id', orderId)
            .single();
            
        // Eƒüer varsa d√∂n
        if (!queryError && existingBonus) {
            console.log('‚úÖ Mevcut referral bonus bulundu:', existingBonus.id);
            return existingBonus;
        }
        
        // Yeni referral bonus kaydƒ± olu≈ütur
        const bonusData = {
            customer_id: customerId,
            order_id: orderId,
            amount: amount,
            bonus_type: bonusType,
            status: 'approved',
            created_at: new Date().toISOString()
        };
        
        const { data: newBonus, error: insertError } = await supabase
            .from('referral_bonus')
            .insert([bonusData])
            .select()
            .single();
            
        if (insertError) {
            console.error('‚ùå Yeni referral bonus olu≈üturma hatasƒ±:', insertError);
            throw insertError;
        }
        
        console.log('‚úÖ Yeni referral bonus olu≈üturuldu:', newBonus.id);
        return newBonus;
        
    } catch (error) {
        console.error('‚ùå Referral bonus bulma/olu≈üturma hatasƒ±:', error);
        throw error;
    }
}

async function processReferralPayouts(customerId) {
    try {
        console.log('üîÑ Referral kazan√ßlarƒ± i≈üleniyor...');
        
        // √ñdenmemi≈ü referral kazan√ßlarƒ±nƒ± getir
        const { data: pendingPayouts, error: payoutError } = await supabase
            .from('referral_payouts')
            .select(`
                id,
                amount,
                status,
                referral_bonus:referral_bonus_id (
                    customer_id,
                    order_id,
                    bonus_type
                )
            `)
            .eq('referral_bonus.customer_id', customerId)
            .eq('status', 'pending')
            .is('paid_at', null);
            
        if (payoutError) {
            console.error('‚ùå Referral kazan√ßlarƒ± sorgu hatasƒ±:', payoutError);
            return { success: false, error: payoutError };
        }
        
        if (!pendingPayouts || pendingPayouts.length === 0) {
            console.log('‚ÑπÔ∏è √ñdenmemi≈ü referral kazancƒ± bulunamadƒ±');
            return { success: true, totalAdded: 0, message: '√ñdenmemi≈ü kazan√ß yok' };
        }
        
        console.log(`üí∞ ${pendingPayouts.length} √∂denmemi≈ü referral kazancƒ± bulundu`);
        
        // Toplam bonus miktarƒ±nƒ± hesapla
        const totalBonus = pendingPayouts.reduce((sum, payout) => sum + payout.amount, 0);
        
        // M√º≈üteri bonus bakiyesini g√ºncelle
        const { data: customer, error: customerError } = await supabase
            .from('customers')
            .select('bonus_balance')
            .eq('id', customerId)
            .single();
            
        if (customerError) {
            console.error('‚ùå M√º≈üteri bilgisi alma hatasƒ±:', customerError);
            return { success: false, error: customerError };
        }
        
        const newBalance = (customer.bonus_balance || 0) + totalBonus;
        
        const { error: updateError } = await supabase
            .from('customers')
            .update({ 
                bonus_balance: newBalance,
                updated_at: new Date().toISOString()
            })
            .eq('id', customerId);
            
        if (updateError) {
            console.error('‚ùå Bonus bakiye g√ºncelleme hatasƒ±:', updateError);
            return { success: false, error: updateError };
        }
        
        // Referral kazan√ßlarƒ±nƒ± √∂dendi olarak i≈üaretle
        const payoutIds = pendingPayouts.map(p => p.id);
        const { error: markPaidError } = await supabase
            .from('referral_payouts')
            .update({ 
                status: 'completed',
                paid_at: new Date().toISOString()
            })
            .in('id', payoutIds);
            
        if (markPaidError) {
            console.error('‚ùå Referral √∂deme durumu g√ºncelleme hatasƒ±:', markPaidError);
            return { success: false, error: markPaidError };
        }
        
        // Bonus hareketleri olu≈ütur
        for (const payout of pendingPayouts) {
            await createBonusTransaction(
                customerId, 
                'referral_earning', 
                payout.amount, 
                payout.id, 
                'referral_payout'
            );
        }
        
        console.log(`‚úÖ ${payoutIds.length} referral kazancƒ± i≈ülendi: +${totalBonus} TL`);
        
        return {
            success: true,
            totalAdded: totalBonus,
            newBalance: newBalance,
            payoutsProcessed: payoutIds.length
        };
        
    } catch (error) {
        console.error('‚ùå Referral kazan√ß i≈üleme hatasƒ±:', error);
        return { success: false, error: error.message };
    }
}

// =============================================
// NORMAL √ñDEME ƒ∞≈ûLEMLERƒ∞
// =============================================

async function processRegularPayment(orderId, customerId, totalAmount, paymentMethod) {
    try {
        console.log(`üí≥ Normal √∂deme i≈üleniyor: ${paymentMethod} - ${totalAmount} TL`);
        
        // √ñdeme kaydƒ±nƒ± olu≈ütur
        const paymentData = {
            order_id: orderId,
            customer_id: customerId,
            payment_method: paymentMethod,
            payment_type: 'full',
            amount: totalAmount,
            bonus_amount: 0,
            status: 'completed',
            payment_date: new Date().toISOString(),
            created_at: new Date().toISOString()
        };
        
        // √ñdeme y√∂ntemine g√∂re alanlarƒ± doldur
        if (paymentMethod === 'cash') {
            paymentData.cash_amount = totalAmount;
            paymentData.card_amount = 0;
        } else if (paymentMethod === 'card') {
            paymentData.card_amount = totalAmount;
            paymentData.cash_amount = 0;
        }
        
        console.log('üí≥ √ñdeme kaydƒ±:', paymentData);
        
        const { data: payment, error: paymentError } = await supabase
            .from('customer_payments')
            .insert([paymentData])
            .select()
            .single();
            
        if (paymentError) {
            console.error('‚ùå Normal √∂deme kaydƒ± hatasƒ±:', paymentError);
            throw paymentError;
        }
        
        // Sipari≈ü durumunu g√ºncelle
        await updateOrderStatus(orderId, 'confirmed');
        
        console.log('‚úÖ Normal √∂deme kaydƒ± olu≈üturuldu:', payment.id);
        
        return {
            success: true,
            paymentId: payment.id,
            paymentMethod: paymentMethod,
            amount: totalAmount
        };
        
    } catch (error) {
        console.error('‚ùå Normal √∂deme i≈üleme hatasƒ±:', error);
        throw error;
    }
}


   

    
    </script>
</body>
</html>

















