<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sipariş Sayfası — Onur Market</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .fly { position:absolute; z-index:9999; transition: all 0.85s ease-in-out; pointer-events:none; }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0%{transform:rotate(0)}25%{transform:rotate(-8deg)}50%{transform:rotate(8deg)}75%{transform:rotate(-8deg)}100%{transform:rotate(0)}}
        .card { transition: transform .25s ease, box-shadow .25s ease; }
        .card:hover { transform: translateY(-6px) scale(1.02); box-shadow: 0 10px 25px rgba(0,0,0,0.12); }
        
        /* Mikrofon butonu ve sesli asistan stilleri */
        .voice-assistant {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #f59e0b;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
            z-index: 100;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
        
        .voice-assistant.listening {
            animation: listening 1.5s infinite;
        }
        
        @keyframes listening {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.6); }
            70% { box-shadow: 0 0 0 15px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
        
        .voice-status {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 300px;
            z-index: 100;
            display: none;
        }
        
        .status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .status-title {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #1f2937;
        }
        
        .status-title i {
            margin-right: 8px;
            color: #f59e0b;
        }
        
        .status-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #6b7280;
        }
        
        .status-content {
            margin-bottom: 15px;
        }
        
        .assistant-message {
            padding: 12px;
            background: #f0f9ff;
            border-radius: 8px;
            margin-bottom: 10px;
            color: #374151;
        }
        
        .user-message {
            padding: 12px;
            background: #dbeafe;
            border-radius: 8px;
            text-align: right;
            color: #2563eb;
        }
        
        .voice-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 30px;
            margin-top: 10px;
        }
        
        .voice-bar {
            width: 6px;
            height: 10px;
            background: #ddd;
            margin: 0 3px;
            border-radius: 3px;
            animation: voiceIndicator 1.5s infinite;
        }
        
        .voice-bar:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .voice-bar:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        .voice-bar:nth-child(4) {
            animation-delay: 0.6s;
        }
        
        .voice-bar:nth-child(5) {
            animation-delay: 0.8s;
        }
        
        @keyframes voiceIndicator {
            0%, 100% { height: 10px; background: #ddd; }
            50% { height: 30px; background: #f59e0b; }
        }
        
        .listening .voice-bar {
            animation: voiceIndicator 0.8s infinite;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

<div class="max-w-7xl mx-auto p-6">
  <header class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold">Sipariş Sayfası</h1>
      <p class="text-sm text-gray-500">Profilim → Bilgilerim / Bonuslarım / Siparişlerim / Ödemelerim</p>
    </div>
    <div id="userBox" class="text-right">
      <div id="userName" class="font-semibold">Giriş yapılmadı</div>
      <div id="userMeta" class="text-sm text-gray-500"></div>
    </div>
  </header>

  <main class="grid grid-cols-1 lg:grid-cols-4 gap-6">

    <!-- LEFT: Seller & Filters -->
    <aside class="col-span-1 bg-white rounded shadow p-4">
      <h2 class="font-semibold mb-2">Satıcı & Filtreler</h2>

      <div class="mb-3">
        <label class="block text-sm text-gray-600 mb-1">Satıcınız (lokasyona göre)</label>
        <select id="sellerSelect" class="w-full border rounded px-3 py-2">
          <option value="">-- Satıcı seçin --</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="block text-sm text-gray-600 mb-1">Reyon</label>
        <select id="reyonSelect" class="w-full border rounded px-3 py-2">
          <option value="">-- Reyon seçin --</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="block text-sm text-gray-600 mb-1">Kategori</label>
        <select id="categorySelect" class="w-full border rounded px-3 py-2">
          <option value="">-- Kategori seçin --</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="block text-sm text-gray-600 mb-1">Ürün</label>
        <select id="productSelect" class="w-full border rounded px-3 py-2">
          <option value="">-- Ürün seçin --</option>
        </select>
      </div>

      <div class="flex gap-2">
        <button id="btnLoadProducts" class="bg-green-600 text-white px-3 py-2 rounded">Ürünleri Yükle</button>
        <button id="btnShareRef" class="bg-blue-600 text-white px-3 py-2 rounded flex-1">Referans Linki Gönder</button>
      </div>

      <hr class="my-3" />

      <div>
        <h3 class="text-sm font-semibold mb-1">Profilim</h3>
        <div id="profileInfo" class="text-sm text-gray-700">
          <!-- doldurulacak -->
          <div>Adı Soyadı: <span id="p_name">-</span></div>
          <div>Telefon: <span id="p_phone">-</span></div>
          <div>Rol: <span id="p_role">-</span></div>
          <div>Adres / Şehir: <span id="p_address">-</span> / <span id="p_city">-</span></div>
          <div class="mt-2">Bonus Kalan: <strong id="p_bonus">0 ₺</strong></div>
        </div>
      </div>
    </aside>

    <!-- MIDDLE: Products -->
    <section class="col-span-2 bg-white rounded shadow p-4">
      <div class="flex items-center justify-between mb-4">
        <div>
          <input id="voiceBtn" type="button" class="px-3 py-2 bg-yellow-500 rounded text-white" value="Sesle Sipariş Başlat (Dinle)">
          <span id="voiceStatus" class="ml-3 text-sm text-gray-500"></span>
        </div>
        <div class="text-sm text-gray-600">Reyon → Kategori → Ürün seçerek veya sesle ürün ekleyin</div>
      </div>

      <div id="productsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        <!-- ürün kartları buraya -->
        <div class="flex flex-col items-center justify-center p-8 text-gray-400">
          <i class="fas fa-box-open text-4xl mb-3"></i>
          <p>Satıcı seçerek ürünleri görüntüleyin</p>
        </div>
      </div>
    </section>

    <!-- RIGHT: Cart -->
    <aside class="col-span-1 bg-white rounded shadow p-4">
      <h2 class="font-semibold mb-2">Sepet</h2>
      <div id="cartList" class="space-y-2 max-h-[420px] overflow-y-auto mb-3">
        <div class="text-sm text-gray-500">Sepete ürün ekleyin</div>
      </div>

      <div class="border-t pt-3">
        <div class="flex justify-between">
          <div>Ara Toplam</div><div id="subtotal">0 ₺</div>
        </div>
        <div class="flex justify-between">
          <div>İndirim</div><div id="discount">0 ₺</div>
        </div>
        <div class="flex justify-between">
          <div>KDV (<span id="vatRate">18</span>%)</div><div id="vatAmount">0 ₺</div>
        </div>
        <div class="flex justify-between font-bold mt-2">
          <div>Genel Toplam</div><div id="totalAmount">0 ₺</div>
        </div>

        <div class="mt-3 space-y-2">
          <button id="payCash" class="w-full bg-green-600 text-white py-2 rounded">Kapıda Nakit</button>
          <button id="payCard" class="w-full bg-blue-600 text-white py-2 rounded">Kapıda Kredi Kartı</button>
          <button id="payBonus" class="w-full bg-purple-600 text-white py-2 rounded">Bonus ile Ödeme</button>
        </div>
      </div>
    </aside>

  </main>
</div>

<!-- Sesli Asistan -->
<div class="voice-assistant" id="voiceAssistant">
    <i class="fas fa-microphone"></i>
</div>

<div class="voice-status" id="voiceStatusPanel">
    <div class="status-header">
        <div class="status-title">
            <i class="fas fa-microphone"></i>
            <span>Sesli Asistan</span>
        </div>
        <button class="status-close" id="closeVoiceStatus">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="status-content">
        <div class="assistant-message" id="assistantMessage">Mikrofon erişimi için lütfen butona tıklayın.</div>
        <div class="user-message" id="userMessage"></div>
    </div>
    <div class="voice-indicator" id="voiceIndicator">
        <div class="voice-bar"></div>
        <div class="voice-bar"></div>
        <div class="voice-bar"></div>
        <div class="voice-bar"></div>
        <div class="voice-bar"></div>
    </div>
</div>

<script>
/* ================== CONFIG ================== */
const SUPABASE_URL = "https://xliutvspwodhoaxvysks.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsaXV0dnNwd29kaG9heHZ5c2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTgyOTksImV4cCI6MjA3MjkzNDI5OX0.Zodisa_ifP8t2Q4X0ecnB56RiR_Bg4QS5gvPn5ZLK_w";
if (SUPABASE_URL.includes("YOUR_PROJECT") || SUPABASE_KEY.includes("YOUR_PUBLIC")) {
  alert("Supabase credentials missing. Update SUPABASE_URL and SUPABASE_KEY.");
  throw new Error("Supabase credentials missing");
}
const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ======== STATE ======== */
let currentUser = null;
let currentProfile = null;
let sellers = [];      // Role=market kullanıcılar (şubeler)
let reyonlar = [];     // Seçilen şubenin reyonları
let categories = [];   // Reyon bazlı kategoriler
let products = [];     // Şube ürünleri
let productPrices = {}; // product_id -> price
let cart = [];         // { product_id, name, img, price, qty }

const VAT_RATE = 18; // KDV %

// Ses tanıma değişkenleri
let recognition = null;
let isListening = false;

/* ======== DOM ELEMENTS ======== */
const userNameEl = document.getElementById("userName");
const userMetaEl = document.getElementById("userMeta");
const p_name = document.getElementById("p_name");
const p_phone = document.getElementById("p_phone");
const p_role = document.getElementById("p_role");
const p_address = document.getElementById("p_address");
const p_city = document.getElementById("p_city");
const p_bonus = document.getElementById("p_bonus");
const sellerSelect = document.getElementById("sellerSelect");
const reyonSelect = document.getElementById("reyonSelect");
const categorySelect = document.getElementById("categorySelect");
const productSelect = document.getElementById("productSelect");
const productsGrid = document.getElementById("productsGrid");
const cartList = document.getElementById("cartList");
const subtotalEl = document.getElementById("subtotal");
const discountEl = document.getElementById("discount");
const vatAmountEl = document.getElementById("vatAmount");
const totalAmountEl = document.getElementById("totalAmount");
const btnLoadProducts = document.getElementById("btnLoadProducts");
const btnShareRef = document.getElementById("btnShareRef");
const voiceBtn = document.getElementById("voiceBtn");
const voiceStatus = document.getElementById("voiceStatus");

// Sesli asistan elementleri
const voiceAssistant = document.getElementById("voiceAssistant");
const voiceStatusPanel = document.getElementById("voiceStatusPanel");
const assistantMessage = document.getElementById("assistantMessage");
const userMessage = document.getElementById("userMessage");
const voiceIndicator = document.getElementById("voiceIndicator");
const closeVoiceStatus = document.getElementById("closeVoiceStatus");

/* ======== HELPER ======== */
function money(n){ return Number(n||0).toLocaleString('tr-TR',{minimumFractionDigits:2, maximumFractionDigits:2}) + ' ₺'; }

/* ======== INIT ======== */
(async function init(){
  await loadSessionAndProfile();
  await loadSellersByLocation();
  setupEventHandlers();
  await loadReferralSummary();
  
  // Sesli asistanı başlat
  initVoiceAssistant();
})();

/* ======== SESLİ ASİSTAN ======== */
function initVoiceAssistant() {
    // Sesli asistan event listener'ları
    voiceAssistant.addEventListener('click', toggleMicrophone);
    closeVoiceStatus.addEventListener('click', hideVoiceStatus);
    
    // Sayfa yüklendiğinde sesli asistanı göster
    setTimeout(() => {
        showVoiceStatus();
        speakToUser("Merhaba! Onur Market Sesli Sipariş sistemine hoş geldiniz. Alttaki turuncu butona tıklayarak sesli sipariş verebilirsiniz.");
    }, 1000);
}

function toggleMicrophone() {
    if (isListening) {
        disableMicrophone();
    } else {
        enableMicrophone();
    }
}

async function enableMicrophone() {
    try {
        // Mikrofon erişim iznini iste
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Mikrofon etkin
        isListening = true;
        voiceAssistant.classList.add('listening');
        voiceAssistant.innerHTML = '<i class="fas fa-microphone"></i>';
        voiceStatus.textContent = "Dinleniyor...";
        
        // Ses tanıma başlat
        initializeSpeechRecognition();
        
        // Ses durumu kutusunu göster
        showVoiceStatus();
        
        // Kullanıcıya bildir
        speakToUser("Mikrofon erişimi sağlandı. Lütfen 'Merhaba' diyerek sistemi başlatın.");
        
        // Mikrofon stream'ini serbest bırak (sadece izin için kullandık)
        stream.getTracks().forEach(track => track.stop());
        
    } catch (error) {
        console.error("Mikrofon erişim hatası:", error);
        voiceStatus.textContent = "Mikrofon erişimi reddedildi";
        
        let errorMessage = "Mikrofon erişimi sağlanamadı. ";
        if (error.name === "NotAllowedError") {
            errorMessage += "Lütfen tarayıcı ayarlarınızdan mikrofon erişimine izin verin.";
        } else if (error.name === "NotFoundError") {
            errorMessage += "Mikrofon cihazı bulunamadı.";
        } else {
            errorMessage += "Beklenmeyen bir hata oluştu.";
        }
        
        assistantMessage.textContent = errorMessage;
        showVoiceStatus();
    }
}

function disableMicrophone() {
    isListening = false;
    voiceAssistant.classList.remove('listening');
    voiceAssistant.innerHTML = '<i class="fas fa-microphone"></i>';
    voiceStatus.textContent = "";
    
    // Ses tanımayı durdur
    if (recognition) {
        recognition.stop();
    }
    
    // Ses göstergesini sıfırla
    voiceIndicator.classList.remove('listening');
    
    // Kullanıcıya bildir
    assistantMessage.textContent = "Mikrofon erişimi kapalı. Sesli sipariş için lütfen mikrofon butonuna tıklayın.";
}

function initializeSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (!SpeechRecognition) {
        assistantMessage.textContent = "Tarayıcınız ses tanıma özelliğini desteklemiyor";
        voiceStatus.textContent = "Desteklenmeyen tarayıcı";
        return;
    }
    
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.lang = 'tr-TR';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    
    recognition.onstart = function() {
        isListening = true;
        voiceIndicator.classList.add('listening');
        voiceStatus.textContent = "Dinleniyor...";
        assistantMessage.textContent = "Dinliyorum...";
    };
    
    recognition.onresult = function(event) {
        const transcript = event.results[event.results.length - 1][0].transcript;
        userMessage.textContent = transcript;
        
        // Sesli komutları işle
        processVoiceCommand(transcript.toLowerCase());
    };
    
    recognition.onerror = function(event) {
        console.error('Ses tanıma hatası:', event.error);
        assistantMessage.textContent = "Üzgünüm, bir hata oluştu: " + event.error;
        
        if (event.error === 'network') {
            assistantMessage.textContent += ". Lütfen internet bağlantınızı kontrol edin.";
        }
        
        isListening = false;
        voiceIndicator.classList.remove('listening');
        voiceStatus.textContent = "Ses dinleme hatası";
    };
    
    recognition.onend = function() {
        isListening = false;
        voiceIndicator.classList.remove('listening');
        voiceStatus.textContent = "";
        
        // Mikrofon hala açıksa yeniden başlat
        if (voiceAssistant.classList.contains('listening')) {
            setTimeout(() => {
                if (!isListening) {
                    recognition.start();
                }
            }, 500);
        }
    };
    
    // Ses tanımayı başlat
    recognition.start();
}

function processVoiceCommand(transcript) {
    if (transcript.includes('merhaba')) {
        assistantMessage.textContent = "Merhaba! Size nasıl yardımcı olabilirim?";
        speakToUser("Merhaba! Hoş geldiniz. Size nasıl yardımcı olabilirim?");
    } else if (transcript.includes('teşekkür')) {
        assistantMessage.textContent = "Rica ederim! Size başka nasıl yardımcı olabilirim?";
        speakToUser("Rica ederim! Başka bir isteğiniz var mı?");
    } else if (transcript.includes('domates') || transcript.includes('ekmek') || transcript.includes('süt')) {
        // Basit ürün tanıma örneği
        let productName = "domates";
        let quantity = 1;
        
        if (transcript.includes('ekmek')) productName = "ekmek";
        if (transcript.includes('süt')) productName = "süt";
        
        const quantityMatch = transcript.match(/(\d+)/);
        if (quantityMatch) {
            quantity = parseInt(quantityMatch[1]);
        }
        
        // Sepete ekleme simülasyonu
        assistantMessage.textContent = `${quantity} adet ${productName} sepete eklendi.`;
        speakToUser(`${quantity} adet ${productName} sepete eklendi. Başka bir şey ister misiniz?`);
        
        // Sepeti güncelle
        updateCartUI();
    } else {
        assistantMessage.textContent = "Üzgünüm, anlayamadım. Lütfen tekrar söyler misiniz?";
        speakToUser("Üzgünüm, anlayamadım. Lütfen tekrar söyler misiniz?");
    }
}

function speakToUser(message) {
    if ('speechSynthesis' in window) {
        const speech = new SpeechSynthesisUtterance(message);
        speech.lang = 'tr-TR';
        speech.volume = 1;
        speech.rate = 1;
        speech.pitch = 1;
        
        window.speechSynthesis.speak(speech);
    }
}

function showVoiceStatus() {
    voiceStatusPanel.style.display = 'block';
}

function hideVoiceStatus() {
    voiceStatusPanel.style.display = 'none';
}

function updateCartUI() {
    // Sepet UI güncelleme simülasyonu
    const itemCount = cart.length + 1;
    cartList.innerHTML = `<div class="text-sm">${itemCount} ürün sepete eklendi</div>`;
    
    // Toplamı güncelle
    const total = itemCount * 15.75;
    subtotalEl.textContent = money(total);
    vatAmountEl.textContent = money(total * 0.18);
    totalAmountEl.textContent = money(total * 1.18);
}

/* ======== ORİJİNAL KOD ======== */
/* ======== LOAD SESSION & PROFILE ======== */
async function loadSessionAndProfile(){
  const { data: sessionData } = await supabase.auth.getSession();
  const session = sessionData?.session;
  if(!session?.user){
    userNameEl.textContent = "Giriş yapılmadı";
    userMetaEl.textContent = "Lütfen giriş yapın.";
    return;
  }
  currentUser = session.user;
  const { data: profile } = await supabase
    .from('profiles')
    .select('id, full_name, role, phone, address, city, location')
    .eq('id', currentUser.id)
    .maybeSingle();
  currentProfile = profile;
  userNameEl.textContent = profile?.full_name || currentUser.email || "Kullanıcı";
  userMetaEl.textContent = profile?.city ? `${profile.city} • ${profile.location || ''}` : '';
  p_name.textContent = profile?.full_name || '-';
  p_phone.textContent = profile?.phone || '-';
  p_role.textContent = profile?.role || '-';
  p_address.textContent = profile?.address || '-';
  p_city.textContent = profile?.city || '-';
}

/* ======== LOAD SELLERS BY LOCATION ======== */
async function loadSellersByLocation(){
  if(!currentProfile?.location){
    sellerSelect.innerHTML = '<option value="">-- Lokasyon yok --</option>';
    return;
  }
  const { data, error } = await supabase
    .from('profiles')
    .select('id, full_name, phone, city, location')
    .eq('role','market')
    .eq('location', currentProfile.location)
    .limit(100);
  if(error){ console.error(error); return; }
  sellers = data || [];
  sellerSelect.innerHTML = '<option value="">-- Satıcı seçin --</option>';
  sellers.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.id;
    opt.textContent = s.full_name || s.phone || s.id;
    sellerSelect.appendChild(opt);
  });
}

/* ======== LOAD REYON / CATEGORIES / PRODUCTS FOR SELLER ======== */
async function loadSellerData(sellerId){
  // Reyonlar
  const { data: reyonData, error: reyonErr } = await supabase
    .from('reyon')
    .select('id, name, image_url')
    .eq('seller_id', sellerId);
  reyonlar = reyonData || [];
  reyonSelect.innerHTML = '<option value="">-- Reyon seçin --</option>';
  reyonlar.forEach(r => {
    const o = document.createElement('option');
    o.value = r.id;
    o.textContent = r.name;
    reyonSelect.appendChild(o);
  });

  // Kategoriler
  const { data: catData } = await supabase
    .from('categories')
    .select('id, name, reyon_id')
    .in('reyon_id', reyonlar.map(r=>r.id))
    .limit(100);
  categories = catData || [];
  categorySelect.innerHTML = '<option value="">-- Kategori seçin --</option>';
  categories.forEach(c => {
    const o = document.createElement('option');
    o.value = c.id;
    o.textContent = c.name;
    categorySelect.appendChild(o);
  });

  // Ürünler
  await loadProductsForSeller(sellerId);
}

async function loadProductsForSeller(sellerId){
  const { data: pp } = await supabase
    .from('product_prices')
    .select('product_id, price')
    .eq('sube_id', sellerId);
  productPrices = {};
  (pp||[]).forEach(r=>productPrices[r.product_id]=r.price);

  const { data: prods } = await supabase
    .from('products')
    .select('id, name, imgurl, category_id')
    .eq('seller_id', sellerId);
  products = (prods||[]).map(p=>({
    id:p.id, name:p.name, img:p.imgurl||'', category_id:p.category_id, price: productPrices[p.id]||0
  }));

  renderProductsGrid(products);

  productSelect.innerHTML = '<option value="">-- Ürün seçin --</option>';
  products.forEach(pr => {
    const o = document.createElement('option');
    o.value = pr.id; o.textContent = pr.name;
    productSelect.appendChild(o);
  });
}

/* ======== RENDER PRODUCTS ======== */
function renderProductsGrid(list){
  productsGrid.innerHTML = '';
  if(!list || !list.length){ productsGrid.innerHTML = '<div class="text-gray-500">Ürün yok</div>'; return; }
  list.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'card bg-white rounded-lg p-3 flex flex-col items-center';
    card.innerHTML=`
      <img src="${p.img||'https://via.placeholder.com/120x80?text=Ürün'}" class="w-28 h-20 object-contain mb-2" alt="${p.name}">
      <div class="font-semibold text-sm text-center">${p.name}</div>
      <div class="text-sm text-gray-600 mt-1">${money(p.price)}</div>
      <button class="mt-3 px-3 py-1 bg-green-600 text-white rounded">Sepete Ekle</button>
    `;
    card.querySelector('button').addEventListener('click', ()=>addToCartByProduct(p,1,true));
    productsGrid.appendChild(card);
  });
}

/* ======== CART ======== */
function addToCartByProduct(prod, qty=1, animate=false){
  let item = cart.find(c=>c.product_id===prod.id);
  if(item) item.qty+=qty;
  else cart.push({ product_id:prod.id, name:prod.name, img:prod.img, price:prod.price, qty:qty });
  renderCart();
  if(animate) flyToCart(prod.img||'https://via.placeholder.com/100');
}

function renderCart(){
  cartList.innerHTML='';
  if(!cart.length){ 
    cartList.innerHTML='<div class="text-sm text-gray-500">Sepet boş</div>'; 
    updateTotals(); 
    return; 
  }
  cart.forEach((it,idx)=>{
    const row=document.createElement('div');
    row.className='flex items-center gap-2';
    row.innerHTML=`<img src="${it.img||'https://via.placeholder.com/48'}" class="w-12 h-12 object-cover rounded" />
      <div class="flex-1 text-sm">
        <div class="font-semibold">${it.name}</div>
        <div class="text-xs text-gray-500">Birim: ${money(it.price)} • x${it.qty}</div>
      </div>
      <div class="text-sm font-semibold">${money(it.price*it.qty)}</div>`;
    cartList.appendChild(row);
  });
  updateTotals();
}

function updateTotals(){
  const subtotal = cart.reduce((s,it)=>s+it.price*it.qty,0);
  const discount = 0; // şimdilik
  const vatAmount = ((subtotal-discount)*VAT_RATE)/100;
  const total = subtotal - discount + vatAmount;
  subtotalEl.textContent = money(subtotal);
  discountEl.textContent = money(discount);
  vatAmountEl.textContent = money(vatAmount);
  totalAmountEl.textContent = money(total);
}

/* ======== CLEAR CART ======== */
function clearCart(){
  cart=[];
  renderCart();
  updateTotals();
}

/* ======== REFERRAL & BONUS ======== */
async function loadReferralSummary(){
  if(!currentProfile?.id) return;
  const { data } = await supabase
    .from('referral_bonus_summary')
    .select('kalan_bonus')
    .eq('user_id', currentProfile.id)
    .maybeSingle();
  const kalan = data?.kalan_bonus||0;
  p_bonus.textContent = money(kalan);
}

/* ======== FINALIZE ORDER ======== */
async function finalizeOrder(method){
  if(!currentProfile?.id) return alert('Lütfen giriş yapın.');
  if(!cart.length) return alert('Sepet boş.');

  const items = cart.map(it=>({ product_id: it.product_id, quantity: it.qty, unit_price: it.price }));
  let bonusToUse = 0;
  if(method==='bonus'){
    const { data } = await supabase.from('referral_bonus_summary').select('kalan_bonus').eq('user_id', currentProfile.id).maybeSingle();
    const kalan = data?.kalan_bonus||0;
    if(kalan<=0) return alert('Yeterli bonus yok.');
    const subtotal = cart.reduce((s,it)=>s+it.price*it.qty,0);
    bonusToUse = Math.min(kalan,subtotal);
  }

  try{
    const { data: orderId, error } = await supabase.rpc('create_order_with_bonus',{
      p_user_id: currentProfile.id,
      p_items: items,
      p_bonus_used: bonusToUse,
      p_payment_type: bonusToUse>0 ? 'bonus+'+method : method
    });
    if(error){ console.error(error); alert('Sipariş kaydedilemedi: '+error.message); return; }
    alert('Sipariş kaydedildi. ID: '+orderId);
    clearCart();
    loadReferralSummary();
    openReceiptPrint(orderId);
  }catch(err){
    console.error(err); alert('Sipariş sırasında hata oluştu: '+(err.message||err));
  }
}

/* ======== PRINT RECEIPT ======== */
async function openReceiptPrint(orderId){
  let orderData;
  try{
    const q = await supabase.rpc('get_order_receipt', { p_order_id: orderId });
    orderData = q?.data;
  }catch(e){ console.warn('RPC çalışmadı, fallback'); }
  if(!orderData){
    const { data: order } = await supabase.from('orders').select('*').eq('id',orderId).maybeSingle();
    const { data: details } = await supabase.from('order_details').select('*').eq('order_id',orderId);
    const { data: profile } = await supabase.from('profiles').select('full_name, phone, address, city').eq('id',order.user_id).maybeSingle();
    orderData = { order, details, profile };
  }
  let html=`<div style="font-family: Arial; padding:10px; width:320px;">
    <h3>Onur Market</h3>
    <div>Sipariş No: ${orderId}</div>
    <div>Tarih: ${new Date().toLocaleString()}</div>
    <div>Müşteri: ${orderData.profile?.full_name||''}</div>
    <div>Tel: ${orderData.profile?.phone||''}</div>
    <hr/>`;
  (orderData.details||[]).forEach(d=>{
    html+=`<div style="display:flex; justify-content:space-between;">
      <div>${d.product_id}</div>
      <div>${d.quantity} x ${money(d.unit_price)}</div>
    </div>`;
  });
  html+=`<hr/><div>Toplam: ${money(orderData.order.total_amount)}</div></div>`;
  const w=window.open('','_blank','width=400,height=600');
  w.document.write(html); w.document.close(); w.print();
}

/* ======== EVENT HANDLERS ======== */
function setupEventHandlers(){
  sellerSelect.addEventListener('change', e=>{
    if(e.target.value) loadSellerData(e.target.value);
    else productsGrid.innerHTML='';
  });
  btnLoadProducts?.addEventListener('click', ()=>{ if(sellerSelect.value) loadSellerData(sellerSelect.value); });
  document.getElementById('payCash')?.addEventListener('click', ()=>finalizeOrder('nakit'));
  document.getElementById('payCard')?.addEventListener('click', ()=>finalizeOrder('kart'));
  document.getElementById('payBonus')?.addEventListener('click', ()=>finalizeOrder('bonus'));
}

/* ======== SIMPLE 2.5D FLY TO CART ANIMATION ======== */
function flyToCart(imgUrl){
  const img = document.createElement('img');
  img.src = imgUrl;
  img.style.position='fixed';
  img.style.width='60px';
  img.style.height='60px';
  img.style.borderRadius='6px';
  img.style.top='50%'; img.style.left='50%';
  img.style.transition='all 0.7s ease-in-out';
  document.body.appendChild(img);
  setTimeout(()=>{ img.style.top='80px'; img.style.left='90%'; img.style.opacity='0'; },50);
  setTimeout(()=>document.body.removeChild(img),800);
}

/* ======== VOICE ORDER (EXAMPLE) ======== */
voiceBtn?.addEventListener('click', ()=>{
  if(!('webkitSpeechRecognition' in window)) return alert('Tarayıcı desteklemiyor.');
  const recognition = new webkitSpeechRecognition();
  recognition.lang = 'tr-TR';
  recognition.start();
  voiceStatus.textContent = 'Dinleniyor...';
  recognition.onresult = (e)=>{
    const spoken = e.results[0][0].transcript.toLowerCase();
    const prod = products.find(p=>spoken.includes(p.name.toLowerCase()));
    if(prod){
      const qtyMatch = spoken.match(/(\d+)/);
      const qty = qtyMatch ? parseInt(qtyMatch[1]):1;
      addToCartByProduct(prod,qty,true);
      voiceStatus.textContent = `Sepete eklendi: ${prod.name} x${qty}`;
    }else voiceStatus.textContent = 'Ürün bulunamadı.';
  };
  recognition.onend = ()=>{ voiceStatus.textContent = 'Dinleme durdu'; };
});
</script>

</body>
</html>