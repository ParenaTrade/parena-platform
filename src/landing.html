<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sesli Sipari≈ü Sistemi - Onur Market</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
 .fly { position:absolute; z-index:9999; transition: all 0.85s ease-in-out; pointer-events:none; }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0%{transform:rotate(0)}25%{transform:rotate(-8deg)}50%{transform:rotate(8deg)}75%{transform:rotate(-8deg)}100%{transform:rotate(0)}}
        .card { transition: transform .25s ease, box-shadow .25s ease; }
        .card:hover { transform: translateY(-6px) scale(1.02); box-shadow: 0 10px 25px rgba(0,0,0,0.12); }
        
        /* Mikrofon butonu ve sesli asistan stilleri */
        .voice-assistant {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #f59e0b;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
            z-index: 100;
        }
        
        .voice-assistant.listening {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.6); }
            70% { box-shadow: 0 0 0 15px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
        
        .voice-status {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 300px;
            z-index: 100;
            display: none;
        }
        
        .status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .status-title {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #1f2937;
        }
        
        .status-title i {
            margin-right: 8px;
            color: #f59e0b;
        }
        
        .status-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #6b7280;
        }
        
        .status-content {
            margin-bottom: 15px;
        }
        
        .assistant-message {
            padding: 12px;
            background: #f0f9ff;
            border-radius: 8px;
            margin-bottom: 10px;
            color: #374151;
        }
        
        .user-message {
            padding: 12px;
            background: #dbeafe;
            border-radius: 8px;
            text-align: right;
            color: #2563eb;
        }
        
        .voice-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 30px;
            margin-top: 10px;
        }
        
        .voice-bar {
            width: 6px;
            height: 10px;
            background: #ddd;
            margin: 0 3px;
            border-radius: 3px;
        }
        
        .listening .voice-bar {
            animation: voiceIndicator 0.8s infinite;
        }
        
        @keyframes voiceIndicator {
            0%, 100% { height: 10px; background: #ddd; }
            50% { height: 30px; background: #f59e0b; }
        }
        
        .microphone-toggle {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .microphone-toggle.listening {
            animation: pulse 1.5s infinite;
        }

		:root {
            --primary: #2563eb;
            --secondary: #10b981;
            --accent: #f59e0b;
            --dark: #1f2937;
            --light: #f9fafb;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .logo i {
            margin-right: 10px;
        }
        
        .user-info {
            text-align: right;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background: #f1f5f9;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .status-item {
            display: flex;
            align-items: center;
        }
        
        .status-item i {
            margin-right: 8px;
            color: var(--primary);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            padding: 20px;
        }
        
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
            color: var(--primary);
        }
        
        .filters select, .filters input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .profile-info div {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
        }
        
        .profile-info span {
            font-weight: 500;
        }
        
        .product-card {
background: white;
border-radius: 8px;
overflow: hidden;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
transition: transform 0.2s;
cursor: pointer;
}

.product-card:hover {
transform: translateY(-5px);
box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
}

.product-image {
height: 120px;
width: 100%;
object-fit: cover;
background: #f3f4f6;
}

.status-content {
margin-bottom: 15px;
}

.status-close {
background: none;
border: none;
font-size: 16px;
cursor: pointer;
color: #6b7280;
}


.product-info {
padding: 10px;
}

.product-name {
font-size: 14px;
font-weight: 500;
margin-bottom: 5px;
}

.assistant-message {
padding: 12px;
background: #f0f9ff;
border-radius: 8px;
margin-bottom: 10px;
color: #374151;
}
.product-price {
color: var(--primary);
font-weight: bold;
}

.product-discount {
color: #ef4444;
font-size: 12px;
text-decoration: line-through;
margin-left: 5px;
}

.cart-items {
max-height: 300px;
overflow-y: auto;
margin-bottom: 20px;
}

.voice-indicator {
display: flex;
align-items: center;
justify-content: center;
height: 30px;
margin-top: 10px;
}

.cart-item {
display: flex;
justify-content: space-between;
padding: 10px 0;
border-bottom: 1px solid #e5e7eb;
}

.cart-item-info {
flex: 1;
}

.cart-item-name {
font-weight: 500;
}

.cart-item-quantity {
color: #6b7280;
font-size: 14px;
}

.cart-item-price {
font-weight: bold;
color: var(--primary);
}

.cart-totals {
border-top: 2px solid #e5e7eb;
padding-top: 15px;
}

.total-row {
display: flex;
justify-content: space-between;
margin-bottom: 10px;
}

.grand-total {
font-weight: bold;
font-size: 18px;
color: var(--dark);
border-top: 1px solid #d1d5db;
padding-top: 10px;
}

.payment-options {
display: grid;
grid-template-columns: 1fr;
gap: 10px;
margin-top: 20px;
}

.payment-btn {
padding: 12px;
border-radius: 6px;
border: none;
color: white;
font-weight: 500;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
transition: background 0.2s;
}

.payment-btn i {
margin-right: 8px;
}

.cash-btn {
background: var(--secondary);
}

.cash-btn:hover {
background: #0d9669;
}

.card-btn {
background: var(--primary);
}

.card-btn:hover {
background: #1d4ed8;
}

.bonus-btn {
background: #8b5cf6;
}

.bonus-btn:hover {
background: #7c3aed;
}

.voice-assistant {
position: fixed;
bottom: 20px;
right: 20px;
width: 60px;
height: 60px;
border-radius: 50%;
background: var(--accent);
color: white;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
z-index: 100;
animation: pulse 2s infinite;
}

@keyframes pulse {
0% { transform: scale(1); }
50% { transform: scale(1.05); }
100% { transform: scale(1); }
}

.listening .voice-assistant {
animation: listening 1.5s infinite;
}

@keyframes listening {
0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.6); }
70% { box-shadow: 0 0 0 15px rgba(245, 158, 11, 0); }
100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
}

.voice-status {
position: fixed;
bottom: 90px;
right: 20px;
background: white;
padding: 10px 15px;
border-radius: 8px;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
max-width: 300px;
display: none;
}

.assistant-message {
font-weight: 500;
color: var(--dark);
padding: 12px;
background: #f0f9ff;
border-radius: 8px;
margin-bottom: 10px;
color: #374151;
}

.user-message {
text-align: right;
color: var(--primary);
margin-top: 5px;
padding: 12px;
background: #dbeafe;
border-radius: 8px;
}

.selected {
border: 2px solid var(--secondary) !important;
background: #f0fdf4 !important;
}

.order-status {
margin-top: 20px;
padding: 15px;
background: #f0f9ff;
border-radius: 8px;
border-left: 4px solid var(--primary);
}

.status-title {
font-weight: 600;
margin-bottom: 10px;
display: flex;
align-items: center;
color: var(--dark);
}

.status-title i {
margin-right: 8px;
color: var(--primary);
}

.status-progress {
height: 6px;
background: #dbeafe;
border-radius: 3px;
overflow: hidden;
margin: 10px 0;
}

.status-progress-bar {
height: 100%;
background: var(--primary);
width: 0%;
transition: width 0.5s;
}

.status-steps {
display: flex;
justify-content: space-between;
font-size: 12px;
color: #6b7280;
}

.status-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 10px;
padding-bottom: 10px;
border-bottom: 1px solid #e5e7eb;
}

@media (max-width: 900px) {
.main-content {
grid-template-columns: 1fr;
}

.voice-bar {
width: 6px;
height: 10px;
background: #ddd;
margin: 0 3px;
border-radius: 3px;
animation: voiceIndicator 1.5s infinite;
}

.voice-bar:nth-child(2) {
animation-delay: 0.2s;
}

.voice-bar:nth-child(3) {
animation-delay: 0.4s;
}

.voice-bar:nth-child(4) {
animation-delay: 0.6s;
}

.voice-bar:nth-child(5) {
animation-delay: 0.8s;
}

@keyframes voiceIndicator {
0%, 100% { height: 10px; background: #ddd; }
50% { height: 30px; background: var(--accent); }
}

.listening .voice-bar {
animation: voiceIndicator 0.8s infinite;
}

.permission-help {
margin-top: 20px;
padding: 15px;
background: #fffbeb;
border-radius: 8px;
border-left: 4px solid var(--accent);
}

.help-title {
font-weight: 600;
margin-bottom: 10px;
color: var(--dark);
display: flex;
align-items: center;
}

.help-title i {
margin-right: 8px;
color: var(--accent);
}

.help-steps {
padding-left: 20px;
margin-bottom: 10px;
}

.help-steps li {
margin-bottom: 8px;
color: #6b7280;
}

.browser-support {
display: flex;
justify-content: space-around;
margin-top: 15px;
}

.browser-item {
display: flex;
flex-direction: column;
align-items: center;
font-size: 12px;
color: #6b7280;
}

.browser-item i {
font-size: 24px;
margin-bottom: 5px;
color: var(--primary);
   }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-store"></i>
                <span>Onur Market Sesli Sipari≈ü</span>
            </div>
             
			
	
		<div id="userBox" class="text-right">
      <div id="userName" class="font-semibold">Giri≈ü yapƒ±lmadƒ±</div>
      <div id="userMeta" class="text-sm text-gray-500"></div>
    </div>
			 <button id="microphoneToggle" class="microphone-toggle">
        <i class="fas fa-microphone-slash"></i>
        <span>Mikrofon (Kapalƒ±)</span>
    </button>
        </header>
        
       <main class="grid grid-cols-1 lg:grid-cols-4 gap-6">

    <!-- LEFT: Seller & Filter	s -->
    <aside class="col-span-1 bg-white rounded shadow p-4">
      <h2 class="font-semibold mb-2">Satƒ±cƒ± & Filtreler</h2>

      <div class="mb-3">
        <label class="block text-sm text-gray-600 mb-1">Satƒ±cƒ±nƒ±z (lokasyona g√∂re)</label>
        <select id="sellerSelect" class="w-full border rounded px-3 py-2">
          <option value="">-- Satƒ±cƒ± se√ßin --</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="block text-sm text-gray-600 mb-1">Reyon</label>
        <select id="reyonSelect" class="w-full border rounded px-3 py-2">
          <option value="">-- Reyon se√ßin --</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="block text-sm text-gray-600 mb-1">Kategori</label>
        <select id="categorySelect" class="w-full border rounded px-3 py-2">
          <option value="">-- Kategori se√ßin --</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="block text-sm text-gray-600 mb-1">√úr√ºn</label>
        <select id="productSelect" class="w-full border rounded px-3 py-2">
          <option value="">-- √úr√ºn se√ßin --</option>
        </select>
      </div>

      <div class="flex gap-2">
        <button id="btnLoadProducts" class="bg-green-600 text-white px-3 py-2 rounded">√úr√ºnleri Y√ºkle</button>
        <button id="btnShareRef" class="bg-blue-600 text-white px-3 py-2 rounded flex-1">Referans Linki G√∂nder</button>
      </div>

      <hr class="my-3" />

      <div>
        <h3 class="text-sm font-semibold mb-1">Profilim</h3>
        <div id="profileInfo" class="text-sm text-gray-700">
          <div>Adƒ± Soyadƒ±: <span id="p_name">-</span></div>
          <div>Telefon: <span id="p_phone">-</span></div>
          <div>Rol: <span id="p_role">-</span></div>
          <div>Adres / ≈ûehir: <span id="p_address">-</span> / <span id="p_city">-</span></div>
          <div class="mt-2">Bonus Kalan: <strong id="p_bonus">0 ‚Ç∫</strong></div>
        </div>
      </div>
    </aside>

    <!-- MIDDLE: Products -->
    <section class="col-span-2 bg-white rounded shadow p-4">
      <div class="flex items-center justify-between mb-4">
        <div>
          <input id="voiceBtn" type="button" class="px-3 py-2 bg-yellow-500 rounded text-white" value="Sesle Sipari≈ü Ba≈ülat (Dinle)">
          <span id="voiceStatus" class="ml-3 text-sm text-gray-500"></span>
        </div>
        <div class="text-sm text-gray-600">Reyon ‚Üí Kategori ‚Üí √úr√ºn se√ßerek veya sesle √ºr√ºn ekleyin</div>
      </div>

      <div id="productsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        <div class="flex flex-col items-center justify-center p-8 text-gray-400">
          <i class="fas fa-box-open text-4xl mb-3"></i>
          <p>Satƒ±cƒ± se√ßerek √ºr√ºnleri g√∂r√ºnt√ºleyin</p>
        </div>
      </div>
    </section>

    <!-- RIGHT: Cart -->
    <aside class="col-span-1 bg-white rounded shadow p-4">
      <h2 class="font-semibold mb-2">Sepet</h2>
      <div id="cartList" class="space-y-2 max-h-[420px] overflow-y-auto mb-3">
        <div class="text-sm text-gray-500">Sepete √ºr√ºn ekleyin</div>
      </div>

      <div class="border-t pt-3">
        <div class="flex justify-between">
          <div>Ara Toplam</div><div id="subtotal">0 ‚Ç∫</div>
        </div>
        <div class="flex justify-between">
          <div>ƒ∞ndirim</div><div id="discount">0 ‚Ç∫</div>
        </div>
        <div class="flex justify-between">
          <div>KDV (<span id="vatRate">18</span>%)</div><div id="vatAmount">0 ‚Ç∫</div>
        </div>
        <div class="flex justify-between font-bold mt-2">
          <div>Genel Toplam</div><div id="totalAmount">0 ‚Ç∫</div>
        </div>

        <div class="mt-3 space-y-2">
          <button id="payCash" class="w-full bg-green-600 text-white py-2 rounded">Kapƒ±da Nakit</button>
          <button id="payCard" class="w-full bg-blue-600 text-white py-2 rounded">Kapƒ±da Kredi Kartƒ±</button>
          <button id="payBonus" class="w-full bg-purple-600 text-white py-2 rounded">Bonus ile √ñdeme</button>
        </div>
      </div>
    </aside>

  </main>
</div>

<!-- Sesli Asistan -->
<div class="voice-status" id="voiceStatusPanel">
    <div class="status-header">
        <div class="status-title">
            <i class="fas fa-microphone"></i>
            <span>Sesli Asistan</span>
        </div>
        <button class="status-close" id="closeVoiceStatus">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="status-content">
        <div class="assistant-message" id="assistantMessage">Mikrofon eri≈üimi i√ßin l√ºtfen butona tƒ±klayƒ±n.</div>
        <div class="user-message" id="userMessage"></div>
    </div>
    <div class="voice-indicator" id="voiceIndicator">
        <div class="voice-bar"></div>
        <div class="voice-bar"></div>
        <div class="voice-bar"></div>
        <div class="voice-bar"></div>
        <div class="voice-bar"></div>
    </div>
</div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = "https://xliutvspwodhoaxvysks.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsaXV0dnNwd29kaG9heHZ5c2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTgyOTksImV4cCI6MjA3MjkzNDI5OX0.Zodisa_ifP8t2Q4X0ecnB56RiR_Bg4QS5gvPn5ZLK_w";

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Global state
        let currentCustomer = null;
        let sellers = [];
        let reyonlar = [];
        let categories = [];
        let products = [];
        let cart = [];
        let recognition = null;
        let isListening = false;
        let isMicrophoneEnabled = false;
        let conversationStep = 0;
        let currentPaymentMethod = null;
        let orderStatusInterval = null;
        let referralCode = null;
        let referralGroupCode = null;

        // DOM Elements
        const userNameEl = document.getElementById("userName");
        const userMetaEl = document.getElementById("userMeta");
        const p_name = document.getElementById("p_name");
        const p_phone = document.getElementById("p_phone");
        const p_role = document.getElementById("p_role");
        const p_address = document.getElementById("p_address");
        const p_city = document.getElementById("p_city");
        const p_bonus = document.getElementById("p_bonus");
        const sellerSelect = document.getElementById("sellerSelect");
        const reyonSelect = document.getElementById("reyonSelect");
        const categorySelect = document.getElementById("categorySelect");
        const productSelect = document.getElementById("productSelect");
        const productsGrid = document.getElementById("productsGrid");
        const cartList = document.getElementById("cartList");
        const subtotalEl = document.getElementById("subtotal");
        const discountEl = document.getElementById("discount");
        const vatAmountEl = document.getElementById("vatAmount");
        const totalAmountEl = document.getElementById("totalAmount");
        const btnLoadProducts = document.getElementById("btnLoadProducts");
        const btnShareRef = document.getElementById("btnShareRef");
        const voiceBtn = document.getElementById("voiceBtn");
        const voiceStatus = document.getElementById("voiceStatus");
        const microphoneToggle = document.getElementById('microphoneToggle');
        const assistantMessage = document.getElementById('assistantMessage');
        const userMessage = document.getElementById('userMessage');
        const voiceIndicator = document.getElementById('voiceIndicator');
        const closeVoiceStatus = document.getElementById('closeVoiceStatus');
        const voiceStatusPanel = document.getElementById('voiceStatusPanel');
        const payCashBtn = document.getElementById('payCash');
        const payCardBtn = document.getElementById('payCard');
        const payBonusBtn = document.getElementById('payBonus');
        const mainContent = document.getElementById('mainContent');

        // Utility functions
        function money(n){ return Number(n||0).toLocaleString('tr-TR',{minimumFractionDigits:2, maximumFractionDigits:2}) + ' ‚Ç∫'; }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        async function initApp() {
            // Check for referral code in URL
            const urlParams = new URLSearchParams(window.location.search);
            referralCode = urlParams.get('referral_code');
            referralGroupCode = urlParams.get('referral_groups');
            
            if (referralCode && referralGroupCode) {
                await processReferralCode(referralCode, referralGroupCode);
            }
            
            setupEventHandlers();
            
            // Sesli asistanƒ± ba≈ülat
            initVoiceAssistant();
        }

        // Ses durumu kutusunu gizle
        function hideVoiceStatus() {
            voiceStatusPanel.style.display = 'none';
        }

        // Referans kodu i≈üleme
        async function processReferralCode(code, groupCode) {
            try {
                const { data, error } = await supabase
                    .from('referral_links')
                    .select('owner_user_id, referral_code, group_code, is_used')
                    .eq('referral_code', code)
                    .eq('group_code', groupCode)
                    .single();
                
                if (error) throw error;
                
                if (data) {
                    if (data.is_used) {
                        assistantMessage.textContent = "Bu referans linki daha √∂nce kullanƒ±lmƒ±≈ü.";
                        return;
                    }
                    
                    referralGroupCode = data.group_code;
                    // Referans sahibinin bilgilerini al
                    const { data: ownerData } = await supabase
                        .from('profiles')
                        .select('full_name')
                        .eq('id', data.owner_user_id)
                        .single();
                    
                    if (ownerData) {
                        assistantMessage.textContent += ` Referans ile geldiniz: ${ownerData.full_name}`;
                    }
                }
            } catch (error) {
                console.error('Referans kodu i≈üleme hatasƒ±:', error);
            }
        }

        // Sesli asistanƒ± ba≈ülat
        function initVoiceAssistant() {
            // Sesli asistan event listener'larƒ±
            microphoneToggle.addEventListener('click', toggleMicrophone);
            closeVoiceStatus.addEventListener('click', hideVoiceStatus);
            
            // Mikrofonu otomatik olarak etkinle≈ütir
            setTimeout(() => {
                enableMicrophone();
            }, 1000);
        }

        // Mikrofonu a√ß/kapa
        function toggleMicrophone() {
            if (isMicrophoneEnabled) {
                disableMicrophone();
            } else {
                enableMicrophone();
            }
        }

        // Mikrofon iznini kontrol et
        async function checkMicrophonePermission() {
            try {
                // Mikrofon eri≈üim durumunu kontrol et
                if (navigator.permissions) {
                    const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
                    
                    if (permissionStatus.state === 'granted') {
                        // ƒ∞zin zaten verilmi≈ü
                        enableMicrophone();
                    } else {
                        // ƒ∞zin verilmemi≈ü veya sorulmamƒ±≈ü
                        disableMicrophone();
                    }
                    
                    // ƒ∞zin durumu deƒüi≈ütiƒüinde
                    permissionStatus.onchange = function() {
                        if (permissionStatus.state === 'granted') {
                            enableMicrophone();
                        } else {
                            disableMicrophone();
                        }
                    };
                }
            } catch (error) {
                console.error('Mikrofon izni kontrol hatasƒ±:', error);
                // Fallback: Doƒürudan mikrofon eri≈üimini dene
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    enableMicrophone();
                    stream.getTracks().forEach(track => track.stop());
                } catch (err) {
                    disableMicrophone();
                }
            }
        }

        // Mikrofonu etkinle≈ütir
        async function enableMicrophone() {
            try {
                // Mikrofon eri≈üim isteƒüi g√∂nder
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Mikrofon etkin
                isMicrophoneEnabled = true;
                microphoneToggle.innerHTML = '<i class="fas fa-microphone"></i> <span>Mikrofon (A√ßƒ±k)</span>';
                microphoneToggle.classList.add('listening');
                
                // Ses tanƒ±ma ba≈ülat
                initializeSpeechRecognition();
                
                // Kullanƒ±cƒ±ya bildir
                assistantMessage.textContent = "Mikrofon eri≈üimi saƒülandƒ±. L√ºtfen 'Evet' diyerek giri≈ü yapƒ±n.";
                
                // Mikrofon stream'ini serbest bƒ±rak (sadece izin i√ßin kullandƒ±k)
                stream.getTracks().forEach(track => track.stop());
                
            } catch (error) {
                console.error("Mikrofon eri≈üim hatasƒ±:", error);
                
                let errorMessage = "Mikrofon eri≈üimi saƒülanamadƒ±. ";
                if (error.name === "NotAllowedError") {
                    errorMessage += "L√ºtfen tarayƒ±cƒ± ayarlarƒ±nƒ±zdan mikrofon eri≈üimine izin verin.";
                } else if (error.name === "NotFoundError") {
                    errorMessage += "Mikrofon cihazƒ± bulunamadƒ±.";
                } else if (error.name === "NotReadableError") {
                    errorMessage += "Mikrofon ba≈üka bir uygulama tarafƒ±ndan kullanƒ±lƒ±yor.";
                } else {
                    errorMessage += "Beklenmeyen bir hata olu≈ütu.";
                }
                
                assistantMessage.textContent = errorMessage;
                disableMicrophone();
            }
        }

        // Mikrofonu devre dƒ±≈üƒ± bƒ±rak
        function disableMicrophone() {
            isMicrophoneEnabled = false;
            microphoneToggle.innerHTML = '<i class="fas fa-microphone-slash"></i> <span>Mikrofon (Kapalƒ±)</span>';
            microphoneToggle.classList.remove('listening');
            
            // Ses tanƒ±mayƒ± durdur
            if (recognition) {
                recognition.stop();
            }
            
            // Ses g√∂stergesini sƒ±fƒ±rla
            voiceIndicator.classList.remove('listening');
            
            // Kullanƒ±cƒ±ya bildir
            assistantMessage.textContent = "Mikrofon eri≈üimi kapalƒ±. Sesli sipari≈ü i√ßin l√ºtfen mikrofon eri≈üimine izin verin.";
        }

        // Ses tanƒ±ma sistemini ba≈ülat
        function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                assistantMessage.textContent = "Tarayƒ±cƒ±nƒ±z ses tanƒ±ma √∂zelliƒüini desteklemiyor";
                return;
            }
            
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.lang = 'tr-TR';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            
            recognition.onstart = function() {
                isListening = true;
                voiceIndicator.classList.add('listening');
                voiceStatus.textContent = "Dinleniyor...";
                assistantMessage.textContent = "Dinliyorum...";
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[event.results.length - 1][0].transcript;
                userMessage.textContent = transcript;
                
                // Sesli komutlarƒ± i≈üle
                processVoiceCommand(transcript.toLowerCase());
            };
            
            recognition.onerror = function(event) {
                console.error('Ses tanƒ±ma hatasƒ±:', event.error);
                
                if (event.error === 'not-allowed') {
                    assistantMessage.textContent = "Mikrofon eri≈üimine izin verilmedi. L√ºtfen tarayƒ±cƒ± ayarlarƒ±nƒ±zdan izin verin.";
                    disableMicrophone();
                } else if (event.error === 'no-speech') {
                    // "no-speech" hatasƒ±nƒ± g√∂rmezden gel, sessizlik normaldir
                    console.log('Ses algƒ±lanmadƒ±');
                } else {
                    assistantMessage.textContent = "Ses tanƒ±ma hatasƒ±: " + event.error;
                }
                
                isListening = false;
                voiceIndicator.classList.remove('listening');
            };
            
            recognition.onend = function() {
                isListening = false;
                voiceIndicator.classList.remove('listening');
                
                // Mikrofon hala a√ßƒ±ksa yeniden ba≈ülat
                if (isMicrophoneEnabled) {
                    setTimeout(() => {
                        if (!isListening) {
                            recognition.start();
                        }
                    }, 500);
                }
            };
            
            // Ses tanƒ±mayƒ± ba≈ülat
            recognition.start();
        }

        // Sesli komutlarƒ± i≈üle
        function processVoiceCommand(transcript) {
            switch(conversationStep) {
                case 0: // Giri≈ü sorusu
                    if (transcript.includes('evet') || transcript.includes('isterim') || transcript.includes('tabi') || transcript.includes('olur')) {
                        speakToUser("Harika! Telefon numaranƒ±zƒ± s√∂yler misiniz?");
                        conversationStep = 1;
                    } else if (transcript.includes('hayƒ±r') || transcript.includes('istemiyorum')) {
                        speakToUser("Peki, giri≈ü yapmak istediƒüiniz zaman bana 'Evet' deyin. Size nasƒ±l yardƒ±mcƒ± olabilirim?");
                    } else {
                        speakToUser("Giri≈ü yapmak istiyor musunuz? L√ºtfen 'Evet' veya 'Hayƒ±r' diyerek yanƒ±t verin.");
                    }
                    break;
                case 1: // Telefon numarasƒ± isteme
                    const phoneMatch = transcript.match(/\d+/g);
                    if (phoneMatch) {
                        const phone = phoneMatch.join('');
                        document.getElementById('p_phone').textContent = phone;
                        checkCustomerByPhone(phone);
                    } else {
                        speakToUser("Telefon numaranƒ±zƒ± anlayamadƒ±m. L√ºtfen numaranƒ±zƒ± s√∂yler misiniz?");
                    }
                    break;
                case 2: // Yeni kullanƒ±cƒ± kaydƒ± - ƒ∞sim
                    document.getElementById('p_name').textContent = transcript;
                    speakToUser("Te≈üekk√ºrler. Hangi ≈üehirden alƒ±≈üveri≈ü yapmak istiyorsunuz?");
                    conversationStep = 3;
                    break;
                case 3: // Yeni kullanƒ±cƒ± kaydƒ± - ≈ûehir
                    document.getElementById('p_city').textContent = transcript;
                    speakToUser("Tamam. Son olarak, adresinizi √∂ƒürenebilir miyim?");
                    conversationStep = 4;
                    break;
                case 4: // Yeni kullanƒ±cƒ± kaydƒ± - Adres
                    document.getElementById('p_address').textContent = transcript;
                    speakToUser("Te≈üekk√ºrler. Konumunuz belirleniyor ve profiliniz olu≈üturuluyor.");
                    // Konum bilgisini al ve profili kaydet
                    getLocationFromAddress(transcript);
                    conversationStep = 5;
                    break;
                case 5: // Profil olu≈üturuldu, satƒ±cƒ±lar y√ºkleniyor
                    // Satƒ±cƒ±larƒ± y√ºkle
                    loadSellersByLocation();
                    break;
                default:
                    // Normal sipari≈ü s√ºreci
                    processOrderCommand(transcript);
                    break;
            }
        }

        // Kullanƒ±cƒ±ya sesli yanƒ±t ver
        function speakToUser(message) {
            assistantMessage.textContent = message;
            
            // Tarayƒ±cƒ± ses sentezleme API'si
            if ('speechSynthesis' in window) {
                const speech = new SpeechSynthesisUtterance(message);
                speech.lang = 'tr-TR';
                speech.volume = 1;
                speech.rate = 1;
                speech.pitch = 1;
                
                window.speechSynthesis.speak(speech);
            }
        }

        // Telefon numarasƒ± ile kullanƒ±cƒ± kontrol√º
        async function checkCustomerByPhone(phone) {
            try {
                const { data, error } = await supabase
                    .from('customers')
                    .select('*')
                    .eq('phone', phone)
                    .single();
                
                if (error) {
                    // Kullanƒ±cƒ± bulunamadƒ±, yeni kayƒ±t moduna ge√ß
                    speakToUser("Telefon numaranƒ±z kayƒ±tlƒ± deƒüil. Yeni √ºyelik olu≈üturalƒ±m. L√ºtfen adƒ±nƒ±zƒ± ve soyadƒ±nƒ±zƒ± s√∂yler misiniz?");
                    conversationStep = 2;
                    return;
                }
                
                if (data) {
                    // Kullanƒ±cƒ± bulundu
                    currentCustomer = data;
                    updateCustomerUI();
                    speakToUser(`Ho≈ü geldiniz ${data.name}! Sisteminiz a√ßƒ±lmƒ±≈ütƒ±r, sipari≈ü i≈üleminize ba≈ülayabilirsiniz.`);
                    conversationStep = 10; // Normal sipari≈ü s√ºrecine ge√ß
                    
                    // Aray√ºz√º etkinle≈ütir
                    enableUI();
                }
                
            } catch (error) {
                console.error('Telefon ile kullanƒ±cƒ± kontrol hatasƒ±:', error);
                speakToUser("Telefon numaranƒ±z kayƒ±tlƒ± deƒüil. Yeni √ºyelik olu≈üturalƒ±m. L√ºtfen adƒ±nƒ±zƒ± ve soyadƒ±nƒ±zƒ± s√∂yler misiniz?");
                conversationStep = 2;
            }
        }

        // Adresden konum bilgisi al
        async function getLocationFromAddress(address) {
            try {
                // Basit bir konum belirleme (ger√ßek uygulamada Google Maps API kullanƒ±lmalƒ±)
                const location = address.includes('istanbul') ? 'ƒ∞stanbul' : 
                                address.includes('ankara') ? 'Ankara' : 
                                address.includes('izmir') ? 'ƒ∞zmir' : 
                                address.includes('bursa') ? 'Bursa' : 'T√ºrkiye';
                                address.includes('balƒ±kesir') ? 'Balƒ±kesir' : 'T√ºrkiye';
                
                // Profili kaydet
                await saveCustomerProfile(location);
                
            } catch (error) {
                console.error('Konum belirleme hatasƒ±:', error);
                // Varsayƒ±lan konum ile devam et
                await saveCustomerProfile('T√ºrkiye');
            }
        }

        // Kullanƒ±cƒ± profilini kaydet
        async function saveCustomerProfile(location) {
            try {
                const name = document.getElementById('p_name').textContent;
                const phone = document.getElementById('p_phone').textContent;
                const city = document.getElementById('p_city').textContent;
                const address = document.getElementById('p_address').textContent;
                
                const { data, error } = await supabase
                    .from('customers')
                    .insert([
                        {
                            name: name,
                            phone: phone,
                            city: city,
                            address: address,
                            location: location,
                            role: '√úye',
                            customer_type: 'Market M√º≈üterisi',
                            group_code: referralGroupCode,
                            bonus_amount: 0,
                            referrer_id: referralCode ? await getReferrerId(referralCode) : null,
                            created_at: new Date().toISOString()
                        }
                    ])
                    .select()
                    .single();
            
                   if (error) {
                    console.error('Profil kaydetme hatasƒ±:',  error);
                    throw error;
                }
                
                currentCustomer = data;
                updateCustomerUI();
                currentCustomer = data;
                updateCustomerUI();
                
                // Referans kodu varsa i≈üle
                if (referralCode) {
                    await processReferralAfterSignup();
                }
                
                speakToUser("Te≈üekk√ºrler efendim. Kullanƒ±cƒ± bilgileriniz tanƒ±mlanmƒ±≈ütƒ±r. Size en yakƒ±n satƒ±cƒ±lar y√ºkleniyor.");
                conversationStep = 5;
                
                // Aray√ºz√º etkinle≈ütir
                enableUI();
                
            } catch (error) {
                console.error('Profil kaydetme hatasƒ±:', error);
                speakToUser("Profil kaydedilirken bir hata olu≈ütu. L√ºtfen daha sonra tekrar deneyin.");
            }
        }

        // Referans kodundan referrer_id'yi al
        async function getReferrerId(referralCode) {
            try {
                const { data, error } = await supabase
                    .from('referral_links')
                    .select('owner_user_id')
                    .eq('referral_code', referralCode)
                    .single();
                
                if (error) throw error;
                
                return data.owner_user_id;
            } catch (error) {
                console.error('Referrer ID alma hatasƒ±:', error);
                return null;
            }
        }

        // √úyelik sonrasƒ± referans i≈üleme
        async function processReferralAfterSignup() {
            try {
                // Referans linkini kullanƒ±lmƒ±≈ü olarak i≈üaretle
                const { error: updateError } = await supabase
                    .from('referral_links')
                    .update({ is_used: true })
                    .eq('referral_code', referralCode);
                
                if (updateError) throw updateError;
                
                // Referans takip kaydƒ± olu≈ütur
                const { error: trackingError } = await supabase
                    .from('referral_tracking')
                    .insert([
                        {
                            referral_code: referralCode,
                            group_code: referralGroupCode,
                            referrer_user_id: await getReferrerId(referralCode),
                            new_user_id: currentCustomer.id,
                            created_at: new Date().toISOString()
                        }
                    ]);
                
                if (trackingError) throw trackingError;
                
                console.log('Referans kaydƒ± ba≈üarƒ±lƒ±');
                
            } catch (error) {
                console.error('Referans i≈üleme hatasƒ±:', error);
            }
        }

        // Profil UI g√ºncelleme
        function updateCustomerUI() {
            if (currentCustomer) {
                userNameEl.textContent = currentCustomer.name || "Kullanƒ±cƒ±";
                userMetaEl.textContent = currentCustomer.city ? `${currentCustomer.city} ‚Ä¢ ${currentCustomer.location || ''}` : '';
                p_name.textContent = currentCustomer.name || '-';
                p_phone.textContent = currentCustomer.phone || '-';
                p_role.textContent = currentCustomer.role || '-';
                p_address.textContent = currentCustomer.address || '-';
                p_city.textContent = currentCustomer.city || '-';
                p_bonus.textContent = money(currentCustomer.bonus_amount || 0);
            }
        }

        // Aray√ºz√º etkinle≈ütir
        function enableUI() {
            mainContent.classList.remove('section-disabled');
            userNameEl.textContent = currentCustomer.name;
            userMetaEl.textContent = `${currentCustomer.city} ‚Ä¢ ${currentCustomer.location || ''}`;
        }

        // Satƒ±cƒ±larƒ± konuma g√∂re y√ºkle
        async function loadSellersByLocation() {
            if (!currentCustomer?.location) {
                sellerSelect.innerHTML = '<option value="">-- Lokasyon yok --</option>';
                return;
            }
            
            try {
                // Profiles tablosundan seller rol√ºndeki kullanƒ±cƒ±larƒ± al
                const { data, error } = await supabase
                    .from('profiles')
                    .select('id, full_name, phone, city, address')
                    .eq('role', 'seller')
                    .ilike('address', `%${currentCustomer.location}%`)
                    .limit(100);
                
                if (error) {
                    console.error(error);
                    return;
                }
                
                sellers = data || [];
                sellerSelect.innerHTML = '<option value="">-- Satƒ±cƒ± se√ßin --</option>';
                sellers.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.full_name || s.phone || s.id;
                    sellerSelect.appendChild(opt);
                });
                
                speakToUser("Size en yakƒ±n satƒ±cƒ±lar y√ºklendi. ≈ûimdi sipari≈ü vermeye ba≈ülayabilirsiniz.");
                
            } catch (error) {
                console.error('Satƒ±cƒ± y√ºkleme hatasƒ±:', error);
                speakToUser("Satƒ±cƒ±lar y√ºklenirken bir hata olu≈ütu. L√ºtfen daha sonra tekrar deneyin.");
            }
        }

        function setupEventHandlers(){
            sellerSelect.addEventListener('change', e=>{
                if(e.target.value) loadSellerData(e.target.value);
                else productsGrid.innerHTML='';
            });
            btnLoadProducts?.addEventListener('click', ()=>{ if(sellerSelect.value) loadSellerData(sellerSelect.value); });
            payCashBtn?.addEventListener('click', ()=>finalizeOrder('nakit'));
            payCardBtn?.addEventListener('click', ()=>finalizeOrder('kart'));
            payBonusBtn?.addEventListener('click', ()=>finalizeOrder('bonus'));
            btnShareRef?.addEventListener('click', generateReferralLink);
            
            // Sesli sipari≈ü butonu
            voiceBtn?.addEventListener('click', ()=>{
                if(!('webkitSpeechRecognition' in window)) return alert('Tarayƒ±cƒ± desteklemiyor.');
                const recognition = new webkitSpeechRecognition();
                recognition.lang = 'tr-TR';
                recognition.start();
                voiceStatus.textContent = 'Dinleniyor...';
                recognition.onresult = (e)=>{
                    const spoken = e.results[0][0].transcript.toLowerCase();
                    const prod = products.find(p=>spoken.includes(p.name.toLowerCase()));
                    if(prod){
                        const qtyMatch = spoken.match(/(\d+)/);
                        const qty = qtyMatch ? parseInt(qtyMatch[1]):1;
                        addToCartByProduct(prod,qty,true);
                        voiceStatus.textContent = `Sepete eklendi: ${prod.name} x${qty}`;
                    }else voiceStatus.textContent = '√úr√ºn bulunamadƒ±.';
                };
                recognition.onend = ()=>{ voiceStatus.textContent = 'Dinleme durdu'; };
            });
        }

        async function loadBonusSummary(){
            if(!currentCustomer?.id) return;
            // Customers tablosundan bonus miktarƒ±nƒ± al
            const { data } = await supabase
                .from('customers')
                .select('bonus_amount')
                .eq('id', currentCustomer.id)
                .maybeSingle();
            const bonus = data?.bonus_amount||0;
            p_bonus.textContent = money(bonus);
        }

        // Referans linki olu≈ütur
        async function generateReferralLink() {
            if (!currentCustomer) {
                alert('√ñnce giri≈ü yapmalƒ±sƒ±nƒ±z');
                return;
            }
            
            try {
                // √ñnce mevcut bir referans linki var mƒ± kontrol et
                const { data: existingLink, error: checkError } = await supabase
                    .from('referral_links')
                    .select('referral_code, group_code')
                    .eq('owner_user_id', currentCustomer.id)
                    .maybeSingle();
                
                let referralCode, groupCode;
                
                if (existingLink) {
                    referralCode = existingLink.referral_code;
                    groupCode = existingLink.group_code;
                } else {
                    // Yeni referans kodu olu≈ütur
                    referralCode = generateReferralCode();
                    
                    // Grup kodu olu≈ütur veya mevcut kodu al
                    const { data: groupData, error: groupError } = await supabase
                        .from('referral_groups')
                        .select('group_code')
                        .eq('leader_user_id', currentCustomer.id)
                        .maybeSingle();
                    
                    if (groupData) {
                        groupCode = groupData.group_code;
                    } else {
                        groupCode = generateGroupCode();
                        
                        // Yeni grup olu≈ütur
                        const { error: groupCreateError } = await supabase
                            .from('referral_groups')
                            .insert([
                                {
                                    name: `${currentCustomer.name} Grubu`,
                                    leader_user_id: currentCustomer.id,
                                    group_code: groupCode,
                                    created_at: new Date().toISOString()
                                }
                            ]);
                        
                        if (groupCreateError) throw groupCreateError;
                    }
                    
                    // Yeni referans linki olu≈ütur
                    const { error: linkError } = await supabase
                        .from('referral_links')
                        .insert([
                            {
                                owner_user_id: currentCustomer.id,
                                owner_phone: currentCustomer.phone,
                                referral_code: referralCode,
                                group_code: groupCode,
                                created_at: new Date().toISOString()
                            }
                        ]);
                    
                    if (linkError) throw linkError;
                }
                
                // Referans linkini payla≈ü
                const referralLink = `${window.location.origin}${window.location.pathname}?referral_groups=${groupCode}&referral_code=${referralCode}`;
                
                if (navigator.share) {
                    // Web Share API desteƒüi varsa
                    navigator.share({
                        title: 'Onur Market Referans Linkim',
                        text: 'Onur Market\'ten alƒ±≈üveri≈ü yapmak i√ßin linkimi kullanabilirsiniz.',
                        url: referralLink
                    });
                } else {
                    // Web Share API desteklemiyorsa
                    navigator.clipboard.writeText(referralLink).then(() => {
                        alert('Referans linki panoya kopyalandƒ±: ' + referralLink);
                    });
                }
                
            } catch (error) {
                console.error('Referans linki olu≈üturma hatasƒ±:', error);
                alert('Referans linki olu≈üturulurken bir hata olu≈ütu.');
            }
        }

        // Benzersiz referans kodu olu≈ütur
        function generateReferralCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // Benzersiz grup kodu olu≈ütur
        function generateGroupCode() {
            return Math.random().toString(36).substring(2, 6).toUpperCase() + 
                   Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        // Sipari≈ü komutlarƒ±nƒ± i≈üle
        function processOrderCommand(transcript) {
            // √úr√ºn ekleme komutlarƒ±
            const productAddMatch = transcript.match(/(\d+)?\s*(kilo|gram|litre|adet|tane|paket)?\s*([a-z√ßƒüƒ±√∂≈ü√º\s]+)/i);
            
            if (productAddMatch) {
                const quantity = productAddMatch[1] ? parseInt(productAddMatch[1]) : 1;
                const unit = productAddMatch[2] || 'adet';
                const productName = productAddMatch[3].trim();
                
                // √úr√ºn√º bul
                const product = products.find(p => 
                    p.name.toLowerCase().includes(productName.toLowerCase())
                );
                
                if (product) {
                    addToCartByProduct(product, quantity, true);
                    speakToUser(`${quantity} ${unit} ${product.name} sepete eklendi.`);
                } else {
                    speakToUser("√úzg√ºn√ºm, istediƒüiniz √ºr√ºn√º bulamadƒ±m. L√ºtfen ba≈üka bir √ºr√ºn s√∂yleyin.");
                }
                return;
            }
            
            // Sepeti onaylama
            if (transcript.includes('sepeti onayla') || transcript.includes('sipari≈üi ver')) {
                if (cart.length === 0) {
                    speakToUser("Sepetiniz bo≈ü. L√ºtfen √∂nce √ºr√ºn ekleyin.");
                    return;
                }
                
                speakToUser(`Sepetinizde ${cart.length} √ºr√ºn bulunuyor. Toplam tutar ${totalAmountEl.textContent}. Nasƒ±l √∂demek istersiniz? Nakit, kart veya bonus?`);
                return;
            }
            
            // √ñdeme se√ßenekleri
            if (transcript.includes('nakit')) {
                selectPaymentMethod('nakit');
                speakToUser("Nakit √∂deme se√ßildi. Sipari≈üinizi onaylƒ±yor musunuz?");
                return;
            }
            
            if (transcript.includes('kart')) {
                selectPaymentMethod('kart');
                speakToUser("Kart ile √∂deme se√ßildi. Sipari≈üinizi onaylƒ±yor musunuz?");
                return;
            }
            
            if (transcript.includes('bonus')) {
                selectPaymentMethod('bonus');
                
                // Bonus bakiyesini kontrol et
                const bonusBalance = parseFloat(p_bonus.textContent.replace('‚Ç∫', '').replace(',', '.'));
                const totalAmount = parseFloat(totalAmountEl.textContent.replace('‚Ç∫', '').replace(',', '.'));
                
                if (bonusBalance < totalAmount) {
                    speakToUser(`Bonus bakiyeniz ${p_bonus.textContent}. Bu tutar toplam sipari≈ü tutarƒ±ndan az. Kalan ${money(totalAmount - bonusBalance)} tutarƒ± nasƒ±l √∂demek istersiniz? Nakit mi kart mƒ±?`);
                    return;
                }
                
                speakToUser("Bonus ile √∂deme se√ßildi. Sipari≈üinizi onaylƒ±yor musunuz?");
                return;
            }
            
            // Sipari≈ü onayƒ±
            if (transcript.includes('evet') || transcript.includes('onaylƒ±yorum')) {
                if (!currentPaymentMethod) {
                    speakToUser("√ñnce bir √∂deme y√∂ntemi se√ßmelisiniz.");
                    return;
                }
                
                finalizeOrder(currentPaymentMethod);
                return;
            }
            
            // Anlamayan yanƒ±t
            speakToUser("√úzg√ºn√ºm, anlayamadƒ±m. L√ºtfen tekrar s√∂yler misiniz?");
        }

        // √ñdeme y√∂ntemi se√ß
        function selectPaymentMethod(method) {
            currentPaymentMethod = method;
            
            // T√ºm √∂deme butonlarƒ±nƒ±n se√ßim durumunu sƒ±fƒ±rla
            payCashBtn.classList.remove('selected');
            payCardBtn.classList.remove('selected');
            payBonusBtn.classList.remove('selected');
            
            // Se√ßilen butonu i≈üaretle
            if (method === 'nakit') {
                payCashBtn.classList.add('selected');
            } else if (method === 'kart') {
                payCardBtn.classList.add('selected');
            } else if (method === 'bonus') {
                payBonusBtn.classList.add('selected');
            }
        }

        // Sipari≈üi tamamla
        async function finalizeOrder(paymentMethod) {
            try {
                if (cart.length === 0) {
                    speakToUser("Sepetiniz bo≈ü. L√ºtfen √∂nce √ºr√ºn ekleyin.");
                    return;
                }
                
                speakToUser("Sipari≈üiniz i≈üleniyor. L√ºtfen bekleyin...");
                
                // Sipari≈ü toplamlarƒ±nƒ± hesapla
                const subtotal = calculateSubtotal();
                const discount = calculateDiscount();
                const vatAmount = calculateVAT(subtotal - discount);
                const grandTotal = subtotal - discount + vatAmount;
                
                // Sipari≈üi veritabanƒ±na kaydet
                const { data: order, error: orderError } = await supabase
                    .from('orders')
                    .insert([
                        {
                            user_id: currentCustomer.id,
                            currency: 'TRY',
                            discount: discount,
                            tax_total: vatAmount,
                            grand_total: grandTotal,
                            bonus_used: paymentMethod === 'bonus' ? Math.min(parseFloat(p_bonus.textContent.replace('‚Ç∫', '').replace(',', '.')), grandTotal) : 0,
                            payment_type: paymentMethod,
                            shipping_company: 'Onur Market Kurye',
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }
                    ])
                    .select()
                    .single();
                
                if (orderError) throw orderError;
                
                // Sipari≈ü detaylarƒ±nƒ± kaydet
                const orderDetails = cart.map(item => ({
                    order_id: order.id,
                    product_id: item.id,
                    quantity: item.quantity,
                    unit_price: item.price,
                    discount: item.discount || 0,
                    tax_rate: 0.18,
                    tax_amount: item.price * item.quantity * 0.18,
                    total_price: (item.price * item.quantity) - (item.discount || 0),
                    created_at: new Date().toISOString()
                }));
                
                const { error: detailsError } = await supabase
                    .from('order_details')
                    .insert(orderDetails);
                
                if (detailsError) throw detailsError;
                
                // Bonus kullanƒ±ldƒ±ysa g√ºncelle
                if (paymentMethod === 'bonus') {
                    const bonusUsed = Math.min(parseFloat(p_bonus.textContent.replace('‚Ç∫', '').replace(',', '.')), grandTotal);
                    
                    // Bonus miktarƒ±nƒ± g√ºncelle
                    const { error: bonusUpdateError } = await supabase
                        .from('customers')
                        .update({ bonus_amount: (currentCustomer.bonus_amount || 0) - bonusUsed })
                        .eq('id', currentCustomer.id);
                    
                    if (bonusUpdateError) throw bonusUpdateError;
                    
                    // Bonus kullanƒ±m kaydƒ± olu≈ütur
                    const { error: bonusUsageError } = await supabase
                        .from('bonus_usage')
                        .insert([
                            {
                                user_id: currentCustomer.id,
                                amount: -bonusUsed,
                                description: `Sipari≈ü #${order.id} i√ßin bonus kullanƒ±mƒ±`,
                                order_id: order.id,
                                created_at: new Date().toISOString()
                            }
                        ]);
                    
                    if (bonusUsageError) throw bonusUsageError;
                    
                    // Bonus bakiyesini g√ºncelle
                    currentCustomer.bonus_amount = (currentCustomer.bonus_amount || 0) - bonusUsed;
                    p_bonus.textContent = money(currentCustomer.bonus_amount || 0);
                }
                
                // Sipari≈ü ba≈üarƒ±lƒ± mesajƒ±
                speakToUser(`Sipari≈üiniz ba≈üarƒ±yla olu≈üturuldu! Sipari≈ü numaranƒ±z: ${order.id}. Toplam tutar: ${money(grandTotal)}. Sipari≈üiniz en ge√ß 45 dakika i√ßinde adresinize teslim edilecektir. ƒ∞yi g√ºnler dileriz.`);
                
                // Sepeti temizle
                cart = [];
                updateCartUI();
                
                // Sipari≈ü durumunu sim√ºle et
                simulateOrderStatus(order.id);
                
            } catch (error) {
                console.error('Sipari≈ü olu≈üturma hatasƒ±:', error);
                speakToUser("Sipari≈ü olu≈üturulurken bir hata olu≈ütu. L√ºtfen daha sonra tekrar deneyin.");
            }
        }

        // Sipari≈ü durumunu sim√ºle et
        function simulateOrderStatus(orderId) {
            const statuses = [
                "Atama Bekliyor",
                "Kurye Atandƒ±",
                "Kurye Markette",
                "Kurye Yolda",
                "Kurye Adreste",
                "Kurye √úr√ºn√º Teslim Etti"
            ];
            
            let currentStatus = 0;
            
            // Sipari≈ü durumu g√ºncelleme interval'i
            orderStatusInterval = setInterval(() => {
                if (currentStatus < statuses.length) {
                    // Burada ger√ßek uygulamada veritabanƒ±na sipari≈ü durumunu g√ºncellemek gerekir
                    console.log(`Sipari≈ü #${orderId} durumu: ${statuses[currentStatus]}`);
                    currentStatus++;
                } else {
                    clearInterval(orderStatusInterval);
                }
            }, 10000); // Her 10 saniyede bir durum g√ºncelle
        }

        // Sepet toplamƒ±nƒ± hesapla
        function calculateSubtotal() {
            return cart.reduce((total, item) => total + (item.price * item.quantity), 0);
        }

        // ƒ∞ndirim toplamƒ±nƒ± hesapla
        function calculateDiscount() {
            return cart.reduce((total, item) => total + (item.discount || 0), 0);
        }

        // KDV hesapla
        function calculateVAT(amount) {
            return amount * 0.18;
        }

        // √úr√ºn√º sepete ekle
        function addToCartByProduct(product, quantity, updateUI = false) {
            const existingItem = cart.find(item => item.id === product.id);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    discount: product.discount_price ? (product.price - product.discount_price) * quantity : 0,
                    quantity: quantity
                });
            }
            
            if (updateUI) {
                updateCartUI();
            }
        }

        // Sepet UI g√ºncelle
        function updateCartUI() {
            cartList.innerHTML = '';
            
            if (cart.length === 0) {
                cartList.innerHTML = '<div class="text-sm text-gray-500">Sepete √ºr√ºn ekleyin</div>';
                subtotalEl.textContent = '0 ‚Ç∫';
                discountEl.textContent = '0 ‚Ç∫';
                vatAmountEl.textContent = '0 ‚Ç∫';
                totalAmountEl.textContent = '0 ‚Ç∫';
                return;
            }
            
            cart.forEach(item => {
                const cartItem = document.createElement('div');
                cartItem.className = 'flex justify-between items-center py-2 border-b';
                cartItem.innerHTML = `
                    <div class="flex-1">
                        <div class="font-medium">${item.name}</div>
                        <div class="text-sm text-gray-500">${item.quantity} adet x ${money(item.price)}</div>
                    </div>
                    <div class="font-semibold">${money(item.price * item.quantity)}</div>
                `;
                cartList.appendChild(cartItem);
            });
            
            const subtotal = calculateSubtotal();
            const discount = calculateDiscount();
            const vatAmount = calculateVAT(subtotal - discount);
            const total = subtotal - discount + vatAmount;
            
            subtotalEl.textContent = money(subtotal);
            discountEl.textContent = money(discount);
            vatAmountEl.textContent = money(vatAmount);
            totalAmountEl.textContent = money(total);
        }

        // Satƒ±cƒ± verilerini y√ºkle
        async function loadSellerData(sellerId) {
            try {
                // Reyonalarƒ± y√ºkle
                const { data: reyonData, error: reyonError } = await supabase
                    .from('reyon')
                    .select('id, name')
                    .order('name');
                
                if (reyonError) throw reyonError;
                
                reyonlar = reyonData || [];
                reyonSelect.innerHTML = '<option value="">-- Reyon se√ßin --</option>';
                reyonlar.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r.id;
                    opt.textContent = r.name;
                    reyonSelect.appendChild(opt);
                });
                
                // Kategorileri y√ºkle
                const { data: categoryData, error: categoryError } = await supabase
                    .from('categories')
                    .select('id, name')
                    .order('name');
                
                if (categoryError) throw categoryError;
                
                categories = categoryData || [];
                categorySelect.innerHTML = '<option value="">-- Kategori se√ßin --</option>';
                categories.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    categorySelect.appendChild(opt);
                });
                
                // √úr√ºnleri y√ºkle
                const { data: productData, error: productError } = await supabase
                    .from('products')
                    .select(`
                        id, name, description, price, stock, currency, 
                        gtip_code, imgurl, unit_type, barcode, brand, category_id, reyon_id,
                        product_prices (price, discount_price, sube_id)
                    `)
                    .eq('product_prices.sube_id', sellerId);
                
                if (productError) throw productError;
                
                products = productData || [];
                productSelect.innerHTML = '<option value="">-- √úr√ºn se√ßin --</option>';
                products.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = p.name;
                    productSelect.appendChild(opt);
                });
                
                // √úr√ºn grid'ini g√ºncelle
                updateProductsGrid();
                
            } catch (error) {
                console.error('Satƒ±cƒ± verileri y√ºkleme hatasƒ±:', error);
                alert('Satƒ±cƒ± verileri y√ºklenirken bir hata olu≈ütu.');
            }
        }

        // √úr√ºn grid'ini g√ºncelle
        function updateProductsGrid() {
            productsGrid.innerHTML = '';
            
            if (products.length === 0) {
                productsGrid.innerHTML = `
                    <div class="flex flex-col items-center justify-center p-8 text-gray-400 col-span-full">
                        <i class="fas fa-box-open text-4xl mb-3"></i>
                        <p>Bu satƒ±cƒ±ya ait √ºr√ºn bulunamadƒ±</p>
                    </div>
                `;
                return;
            }
            
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <img src="${product.imgurl || 'https://via.placeholder.com/150'}" alt="${product.name}" class="product-image">
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div>
                            <span class="product-price">${money(product.price)}</span>
                            ${product.product_prices && product.product_prices[0] && product.product_prices[0].discount_price ? 
                                `<span class="product-discount">${money(product.product_prices[0].discount_price)}</span>` : ''}
                        </div>
                        <button class="add-to-cart-btn mt-2 w-full bg-blue-600 text-white py-1 px-2 rounded text-sm" data-id="${product.id}">Sepete Ekle</button>
                    </div>
                `;
                
                productsGrid.appendChild(productCard);
            });
            
            // Sepete ekle butonlarƒ±na event listener ekle
            document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        addToCartByProduct(product, 1, true);
                        speakToUser(`${product.name} sepete eklendi.`);
                    }
                });
            });
        }

        // 10 saniye ses gelmezse soru sorma
        let silenceTimer;
        
        function resetSilenceTimer() {
            clearTimeout(silenceTimer);
            silenceTimer = setTimeout(() => {
                if (isMicrophoneEnabled && cart.length > 0) {
                    speakToUser("Alƒ±≈üveri≈üe devam etmek istiyor musunuz efendim?");
                }
            }, 10000);
        }

        // Ses tanƒ±ma ba≈üladƒ±ƒüƒ±nda timer'ƒ± sƒ±fƒ±rla
        if (recognition) {
            recognition.onstart = function() {
                resetSilenceTimer();
            };
        }
    </script>
</body>
</html>
