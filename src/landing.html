<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sipariş Sayfası — Onur Market</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #10b981;
            --accent: #f59e0b;
            --dark: #1f2937;
            --light: #f9fafb;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            min-height: 100vh;
        }
        
        .header-gradient {
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
        }
        
        .card {
            transition: all 0.3s ease;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            background: white;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .product-card {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .product-image {
            height: 140px;
            object-fit: contain;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .fly {
            position: fixed;
            z-index: 9999;
            transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .cart-item {
            transition: all 0.3s ease;
        }
        
        .cart-item:hover {
            background-color: #f9fafb;
        }
        
        .btn-primary {
            background-color: var(--primary);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background-color: #1d4ed8;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background-color: #059669;
            transform: translateY(-2px);
        }
        
        .btn-accent {
            background-color: var(--accent);
            transition: all 0.3s ease;
        }
        
        .btn-accent:hover {
            background-color: #d97706;
            transform: translateY(-2px);
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); }
            100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
        }
        
        .voice-listening {
            animation: voicePulse 1.5s infinite;
        }
        
        @keyframes voicePulse {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.6); }
            70% { box-shadow: 0 0 0 15px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
        
        .loading {
            position: relative;
            overflow: hidden;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            100% { left: 100%; }
        }
        
        .shake {
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0% { transform: translateX(0); }
            20% { transform: translateX(-10px); }
            40% { transform: translateX(10px); }
            60% { transform: translateX(-10px); }
            80% { transform: translateX(10px); }
            100% { transform: translateX(0); }
        }
        
        /* Scrollbar stilleri */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body class="min-h-screen py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <header class="header-gradient text-white rounded-xl shadow-lg mb-8 p-6">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="mb-4 md:mb-0 text-center md:text-left">
                    <h1 class="text-3xl font-bold mb-2">Sesli Sipariş Sistemi</h1>
                    <p class="opacity-90">Hızlı ve kolay alışveriş için sesinizi kullanın</p>
                </div>
                <div id="userBox" class="bg-white text-gray-800 rounded-lg p-4 shadow-md text-center md:text-right">
                    <div id="userName" class="font-semibold text-lg"><i class="fas fa-user-circle mr-2"></i>Giriş yapılmadı</div>
                    <div id="userMeta" class="text-sm text-gray-500 mt-1">Lütfen giriş yapın</div>
                </div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- LEFT: Seller & Filters -->
            <aside class="col-span-1 card p-5">
                <h2 class="font-semibold text-lg mb-4 text-gray-700 flex items-center">
                    <i class="fas fa-store mr-2 text-blue-500"></i> Satıcı & Filtreler
                </h2>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-600 mb-1"><i class="fas fa-map-marker-alt mr-1"></i> Satıcınız</label>
                    <select id="sellerSelect" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Satıcı seçin --</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-600 mb-1"><i class="fas fa-boxes mr-1"></i> Reyon</label>
                    <select id="reyonSelect" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Reyon seçin --</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-600 mb-1"><i class="fas fa-tags mr-1"></i> Kategori</label>
                    <select id="categorySelect" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Kategori seçin --</option>
                    </select>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-600 mb-1"><i class="fas fa-shopping-basket mr-1"></i> Ürün</label>
                    <select id="productSelect" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Ürün seçin --</option>
                    </select>
                </div>

                <div class="flex flex-col gap-3">
                    <button id="btnLoadProducts" class="btn-secondary py-3 rounded-lg font-medium flex items-center justify-center">
                        <i class="fas fa-sync-alt mr-2"></i> Ürünleri Yükle
                    </button>
                    <button id="btnShareRef" class="btn-primary py-3 rounded-lg font-medium flex items-center justify-center">
                        <i class="fas fa-share-alt mr-2"></i> Referans Linki Gönder
                    </button>
                </div>

                <hr class="my-5 border-gray-200" />

                <div>
                    <h3 class="text-md font-semibold mb-3 text-gray-700 flex items-center">
                        <i class="fas fa-user-circle mr-2 text-blue-500"></i> Profil Bilgilerim
                    </h3>
                    <div id="profileInfo" class="text-sm text-gray-700 space-y-2">
                        <div class="flex justify-between"><span class="font-medium">Adı Soyadı:</span> <span id="p_name">-</span></div>
                        <div class="flex justify-between"><span class="font-medium">Telefon:</span> <span id="p_phone">-</span></div>
                        <div class="flex justify-between"><span class="font-medium">Rol:</span> <span id="p_role">-</span></div>
                        <div class="flex justify-between"><span class="font-medium">Şehir:</span> <span id="p_city">-</span></div>
                        <div class="flex justify-between"><span class="font-medium">Adres:</span> <span id="p_address">-</span></div>
                        <div class="flex justify-between"><span class="font-medium">Lokasyon:</span> <span id="p_location">-</span></div>

                        <div class="mt-3 pt-2 border-t border-gray-200 flex justify-between">
                            <span class="font-medium">Bonus Kalan:</span> 
                            <strong id="p_bonus" class="text-green-600">0 ₺</strong>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- MIDDLE: Products -->
            <section class="col-span-2 card p-5">
                <div class="flex flex-col sm:flex-row items-center justify-between mb-6">
                    <div class="mb-3 sm:mb-0">
                        <button id="voiceBtn" class="btn-accent py-3 px-6 rounded-lg font-semibold flex items-center voice-listening">
                            <i class="fas fa-microphone mr-2"></i> Sesli Sipariş Başlat
                        </button>
                        <div id="voiceStatus" class="ml-1 text-sm text-gray-500 mt-2"></div>
                    </div>
                    <div class="text-sm text-gray-600 text-center sm:text-right">
                        Reyon → Kategori → Ürün seçerek veya sesle ürün ekleyin
                    </div>
                </div>

                <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="flex flex-col items-center justify-center p-8 text-gray-400">
                        <i class="fas fa-box-open text-4xl mb-3"></i>
                        <p>Satıcı seçerek ürünleri görüntüleyin</p>
                    </div>
                </div>
            </section>

            <!-- RIGHT: Cart -->
            <aside class="col-span-1 card p-5">
                <h2 class="font-semibold text-lg mb-4 text-gray-700 flex items-center">
                    <i class="fas fa-shopping-cart mr-2 text-blue-500"></i> Sepetim
                    <span id="cartCount" class="ml-2 bg-blue-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </h2>
                
                <div id="cartList" class="space-y-3 max-h-[320px] overflow-y-auto mb-4 py-1">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-shopping-basket text-2xl mb-2"></i>
                        <p>Sepetinizde ürün bulunmuyor</p>
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-4 space-y-3">
                    <div class="flex justify-between text-sm">
                        <div>Ara Toplam</div>
                        <div id="subtotal">0.00 ₺</div>
                    </div>
                    <div class="flex justify-between text-sm">
                        <div>İndirim</div>
                        <div id="discount">0.00 ₺</div>
                    </div>
                    <div class="flex justify-between text-sm">
                        <div>KDV (<span id="vatRate">18</span>%)</div>
                        <div id="vatAmount">0.00 ₺</div>
                    </div>
                    <div class="flex justify-between font-bold text-lg pt-2 border-t border-gray-200">
                        <div>Genel Toplam</div>
                        <div id="totalAmount">0.00 ₺</div>
                    </div>

                    <div class="mt-4 space-y-3">
                        <button id="payCash" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-medium transition-all">
                            <i class="fas fa-money-bill-wave mr-2"></i> Kapıda Nakit
                        </button>
                        <button id="payCard" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-all">
                            <i class="fas fa-credit-card mr-2"></i> Kapıda Kart
                        </button>
                        <button id="payBonus" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-medium transition-all">
                            <i class="fas fa-gift mr-2"></i> Bonus ile Ödeme
                        </button>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <div class="flex items-center">
            <i id="toastIcon" class="fas fa-info-circle mr-2"></i>
            <span id="toastMessage"></span>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = "https://xliutvspwodhoaxvysks.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsaXV0dnNwd29kaG9heHZ5c2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTgyOTksImV4cCI6MjA3MjkzNDI5OX0.Zodisa_ifP8t2Q4X0ecnB56RiR_Bg4QS5gvPn5ZLK_w";
        
        // Initialize Supabase client
        const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // State variables
        let currentUser = null;
        let currentProfile = null;
        let sellers = [];
        let reyonlar = [];
        let categories = [];
        let products = [];
        let productPrices = {};
        let cart = [];
        const VAT_RATE = 18;

        // DOM Elements
        const userNameEl = document.getElementById("userName");
        const userMetaEl = document.getElementById("userMeta");
        const p_name = document.getElementById("p_name");
        const p_phone = document.getElementById("p_phone");
        const p_role = document.getElementById("p_role");
        const p_address = document.getElementById("p_address");
        const p_city = document.getElementById("p_city");
        const p_bonus = document.getElementById("p_bonus");
        const sellerSelect = document.getElementById("sellerSelect");
        const reyonSelect = document.getElementById("reyonSelect");
        const categorySelect = document.getElementById("categorySelect");
        const productSelect = document.getElementById("productSelect");
        const productsGrid = document.getElementById("productsGrid");
        const cartList = document.getElementById("cartList");
        const subtotalEl = document.getElementById("subtotal");
        const discountEl = document.getElementById("discount");
        const vatAmountEl = document.getElementById("vatAmount");
        const totalAmountEl = document.getElementById("totalAmount");
        const btnLoadProducts = document.getElementById("btnLoadProducts");
        const btnShareRef = document.getElementById("btnShareRef");
        const voiceBtn = document.getElementById("voiceBtn");
        const voiceStatus = document.getElementById("voiceStatus");
        const cartCount = document.getElementById("cartCount");
        const toast = document.getElementById("toast");
        const toastIcon = document.getElementById("toastIcon");
        const toastMessage = document.getElementById("toastMessage");

        // Utility functions
        function money(amount) {
            return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(amount);
        }

        function showToast(message, type = 'info') {
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-600',
                info: 'bg-gray-800'
            };
            
            toastIcon.className = `fas ${icons[type]} mr-2`;
            toast.className = toast.className.replace(/bg-\w+-\d+/, colors[type]);
            toastMessage.textContent = message;
            
            toast.classList.remove('opacity-0', 'translate-y-20');
            toast.classList.add('opacity-100', 'translate-y-0');
            
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-20');
            }, 3000);
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', async function() {
            await initApp();
            setupEventListeners();
        });

        async function initApp() {
            await loadSessionAndProfile();
            await loadSellersByLocation();
            await loadReferralSummary();
        }

        async function loadSessionAndProfile() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('Session error:', error);
                    return;
                }
                
                if (!session?.user) {
                    userNameEl.textContent = "Giriş yapılmadı";
                    userMetaEl.textContent = "Lütfen giriş yapın";
                    return;
                }
                
                currentUser = session.user;
                
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('id, full_name, role, phone, address, city, location')
                    .eq('id', currentUser.id)
                    .single();
                    
                if (profileError) {
                    console.error('Profile error:', profileError);
                    showToast('Profil bilgileri yüklenirken hata oluştu', 'error');
                    return;
                }
                
                currentProfile = profile;
                userNameEl.textContent = profile.full_name || currentUser.email;
                userMetaEl.textContent = profile.city ? `${profile.city} • ${profile.location || ''}` : '';
                
                p_name.textContent = profile.full_name || '-';
                p_phone.textContent = profile.phone || '-';
                p_role.textContent = profile.role || '-';
                p_address.textContent = profile.address || '-';
                p_city.textContent = profile.city || '-';
                
            } catch (err) {
                console.error('Error in loadSessionAndProfile:', err);
                showToast('Bir hata oluştu: ' + err.message, 'error');
            }
        }

        async function loadSellersByLocation() {
            if (!currentProfile?.location) {
                sellerSelect.innerHTML = '<option value="">-- Lokasyonunuz belirlenemedi --</option>';
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('id, full_name, phone, city, location')
                    .eq('role', 'market')
                    .eq('location', currentProfile.location)
                    .limit(100);
                    
                if (error) {
                    console.error('Sellers error:', error);
                    showToast('Satıcılar yüklenirken hata oluştu', 'error');
                    return;
                }
                
                sellers = data || [];
                sellerSelect.innerHTML = '<option value="">-- Satıcı seçin --</option>';
                
                sellers.forEach(seller => {
                    const option = document.createElement('option');
                    option.value = seller.id;
                    option.textContent = seller.full_name || seller.phone || seller.id;
                    sellerSelect.appendChild(option);
                });
                
            } catch (err) {
                console.error('Error in loadSellersByLocation:', err);
                showToast('Satıcılar yüklenirken hata oluştu', 'error');
            }
        }

        async function loadSellerData(sellerId) {
            if (!sellerId) return;
            
            try {
                // Load reyonlar
                const { data: reyonData, error: reyonError } = await supabase
                    .from('reyon')
                    .select('id, name, image_url')
                    .eq('seller_id', sellerId);
                    
                if (reyonError) {
                    console.error('Reyon error:', reyonError);
                    showToast('Reyonlar yüklenirken hata oluştu', 'error');
                    return;
                }
                
                reyonlar = reyonData || [];
                reyonSelect.innerHTML = '<option value="">-- Reyon seçin --</option>';
                
                reyonlar.forEach(reyon => {
                    const option = document.createElement('option');
                    option.value = reyon.id;
                    option.textContent = reyon.name;
                    reyonSelect.appendChild(option);
                });
                
                // Load categories
                const { data: catData, error: catError } = await supabase
                    .from('categories')
                    .select('id, name, reyon_id')
                    .in('reyon_id', reyonlar.map(r => r.id))
                    .limit(100);
                    
                if (catError) {
                    console.error('Categories error:', catError);
                    showToast('Kategoriler yüklenirken hata oluştu', 'error');
                    return;
                }
                
                categories = catData || [];
                categorySelect.innerHTML = '<option value="">-- Kategori seçin --</option>';
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
                
                // Load products
                await loadProductsForSeller(sellerId);
                
            } catch (err) {
                console.error('Error in loadSellerData:', err);
                showToast('Satıcı verileri yüklenirken hata oluştu', 'error');
            }
        }

        async function loadProductsForSeller(sellerId) {
            try {
                // Load product prices
                const { data: priceData, error: priceError } = await supabase
                    .from('product_prices')
                    .select('product_id, price')
                    .eq('sube_id', sellerId);
                    
                if (priceError) {
                    console.error('Price error:', priceError);
                    showToast('Fiyat bilgileri yüklenirken hata oluştu', 'error');
                    return;
                }
                
                productPrices = {};
                (priceData || []).forEach(item => {
                    productPrices[item.product_id] = item.price;
                });
                
                // Load products
                const { data: productData, error: productError } = await supabase
                    .from('products')
                    .select('id, name, imgurl, category_id')
                    .eq('seller_id', sellerId);
                    
                if (productError) {
                    console.error('Product error:', productError);
                    showToast('Ürünler yüklenirken hata oluştu', 'error');
                    return;
                }
                
                products = (productData || []).map(product => ({
                    id: product.id,
                    name: product.name,
                    img: product.imgurl || 'https://via.placeholder.com/150x150?text=Ürün',
                    category_id: product.category_id,
                    price: productPrices[product.id] || 0
                }));
                
                renderProductsGrid(products);
                
                // Update product select
                productSelect.innerHTML = '<option value="">-- Ürün seçin --</option>';
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = product.name;
                    productSelect.appendChild(option);
                });
                
            } catch (err) {
                console.error('Error in loadProductsForSeller:', err);
                showToast('Ürünler yüklenirken hata oluştu', 'error');
            }
        }

        function renderProductsGrid(productsList) {
            productsGrid.innerHTML = '';
            
            if (!productsList || !productsList.length) {
                productsGrid.innerHTML = `
                    <div class="col-span-full text-center py-10 text-gray-500">
                        <i class="fas fa-box-open text-4xl mb-3"></i>
                        <p>Bu satıcıya ait ürün bulunamadı</p>
                    </div>
                `;
                return;
            }
            
            productsList.forEach(product => {
                const card = document.createElement('div');
                card.className = 'card product-card p-4';
                card.innerHTML = `
                    <div class="flex justify-center mb-3">
                        <img src="${product.img}" alt="${product.name}" class="product-image">
                    </div>
                    <h3 class="font-semibold text-sm text-center mb-2 h-10 overflow-hidden">${product.name}</h3>
                    <div class="text-center text-green-600 font-bold mb-3">${money(product.price)}</div>
                    <button class="mt-auto btn-primary py-2 rounded-lg text-sm add-to-cart-btn" data-product-id="${product.id}">
                        <i class="fas fa-cart-plus mr-1"></i> Sepete Ekle
                    </button>
                `;
                
                productsGrid.appendChild(card);
            });
            
            // Add event listeners to Add to Cart buttons
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = this.getAttribute('data-product-id');
                    const product = products.find(p => p.id == productId);
                    if (product) {
                        addToCartByProduct(product, 1, true);
                    }
                });
            });
        }

        function addToCartByProduct(product, quantity = 1, animate = false) {
            const existingItem = cart.find(item => item.product_id === product.id);
            
            if (existingItem) {
                existingItem.qty += quantity;
            } else {
                cart.push({
                    product_id: product.id,
                    name: product.name,
                    img: product.img,
                    price: product.price,
                    qty: quantity
                });
            }
            
            renderCart();
            updateCartCount();
            
            if (animate) {
                flyToCart(product.img);
            }
            
            showToast(`${product.name} sepete eklendi`, 'success');
        }

        function renderCart() {
            cartList.innerHTML = '';
            
            if (!cart.length) {
                cartList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-shopping-basket text-2xl mb-2"></i>
                        <p>Sepetinizde ürün bulunmuyor</p>
                    </div>
                `;
                updateTotals();
                return;
            }
            
            cart.forEach((item, index) => {
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item bg-gray-50 p-3 rounded-lg';
                cartItem.innerHTML = `
                    <div class="flex items-center gap-3">
                        <img src="${item.img}" class="w-12 h-12 object-cover rounded" alt="${item.name}">
                        <div class="flex-1">
                            <div class="font-medium text-sm">${item.name}</div>
                            <div class="text-xs text-gray-500">${money(item.price)} × ${item.qty}</div>
                        </div>
                        <div class="font-semibold">${money(item.price * item.qty)}</div>
                        <button class="remove-from-cart text-red-500 ml-2" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                cartList.appendChild(cartItem);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-from-cart').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    removeFromCart(index);
                });
            });
            
            updateTotals();
        }

        function updateCartCount() {
            const totalItems = cart.reduce((total, item) => total + item.qty, 0);
            cartCount.textContent = totalItems;
            
            if (totalItems > 0) {
                cartCount.classList.remove('hidden');
            } else {
                cartCount.classList.add('hidden');
            }
        }

        function removeFromCart(index) {
            if (index >= 0 && index < cart.length) {
                const removedItem = cart[index];
                cart.splice(index, 1);
                renderCart();
                updateCartCount();
                showToast(`${removedItem.name} sepetten çıkarıldı`, 'info');
            }
        }

        function updateTotals() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const discount = 0; // Could be implemented later
            const vatAmount = ((subtotal - discount) * VAT_RATE) / 100;
            const total = subtotal - discount + vatAmount;
            
            subtotalEl.textContent = money(subtotal);
            discountEl.textContent = money(discount);
            vatAmountEl.textContent = money(vatAmount);
            totalAmountEl.textContent = money(total);
        }

        function flyToCart(imgUrl) {
            const flyElement = document.createElement('img');
            flyElement.src = imgUrl;
            flyElement.className = 'fly w-12 h-12';
            
            // Get button position
            const rect = event.target.getBoundingClientRect();
            flyElement.style.left = `${rect.left}px`;
            flyElement.style.top = `${rect.top}px`;
            
            document.body.appendChild(flyElement);
            
            // Get cart position
            const cartRect = document.getElementById('cartCount').getBoundingClientRect();
            
            // Animate to cart
            setTimeout(() => {
                flyElement.style.left = `${cartRect.left}px`;
                flyElement.style.top = `${cartRect.top}px`;
                flyElement.style.width = '20px';
                flyElement.style.height = '20px';
                flyElement.style.opacity = '0';
            }, 50);
            
            // Remove element after animation
            setTimeout(() => {
                if (document.body.contains(flyElement)) {
                    document.body.removeChild(flyElement);
                }
            }, 850);
        }

        async function loadReferralSummary() {
            if (!currentProfile?.id) return;
            
            try {
                const { data, error } = await supabase
                    .from('referral_bonus_summary')
                    .select('kalan_bonus')
                    .eq('user_id', currentProfile.id)
                    .maybeSingle();
                    
                if (error) {
                    console.error('Referral error:', error);
                    return;
                }
                
                const bonus = data?.kalan_bonus || 0;
                p_bonus.textContent = money(bonus);
                
            } catch (err) {
                console.error('Error in loadReferralSummary:', err);
            }
        }

        function setupEventListeners() {
            // Seller selection change
            sellerSelect.addEventListener('change', function() {
                if (this.value) {
                    loadSellerData(this.value);
                } else {
                    productsGrid.innerHTML = '<div class="text-center text-gray-500 py-10">Lütfen bir satıcı seçin</div>';
                }
            });
            
            // Load products button
            btnLoadProducts.addEventListener('click', function() {
                if (sellerSelect.value) {
                    loadSellerData(sellerSelect.value);
                } else {
                    showToast('Lütfen önce bir satıcı seçin', 'warning');
                }
            });
            
            // Share referral button
            btnShareRef.addEventListener('click', function() {
                if (!currentProfile) {
                    showToast('Önce giriş yapmalısınız', 'warning');
                    return;
                }
                
                // Simple implementation - could be expanded
                const referralLink = `${window.location.origin}?ref=${currentProfile.id}`;
                navigator.clipboard.writeText(referralLink).then(() => {
                    showToast('Referans linki panoya kopyalandı', 'success');
                }).catch(err => {
                    showToast('Link kopyalanırken hata oluştu', 'error');
                    console.error('Copy error:', err);
                });
            });
            
            // Payment buttons
            document.getElementById('payCash').addEventListener('click', () => finalizeOrder('nakit'));
            document.getElementById('payCard').addEventListener('click', () => finalizeOrder('kart'));
            document.getElementById('payBonus').addEventListener('click', () => finalizeOrder('bonus'));
            
            // Voice order button
            voiceBtn.addEventListener('click', startVoiceRecognition);
        }

        function startVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                showToast('Tarayıcınız ses tanıma özelliğini desteklemiyor', 'error');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.lang = 'tr-TR';
            recognition.continuous = false;
            
            voiceBtn.classList.add('voice-listening');
            voiceStatus.textContent = 'Dinleniyor...';
            voiceStatus.className = 'ml-1 text-sm text-green-600 font-medium mt-2';
            
            recognition.start();
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript.toLowerCase();
                voiceStatus.textContent = `Söylenen: "${transcript}"`;
                
                // Try to find product matches
                const foundProducts = products.filter(product => 
                    transcript.includes(product.name.toLowerCase())
                );
                
                if (foundProducts.length > 0) {
                    // Try to extract quantity
                    const quantityMatch = transcript.match(/\d+/);
                    const quantity = quantityMatch ? parseInt(quantityMatch[0]) : 1;
                    
                    foundProducts.forEach(product => {
                        addToCartByProduct(product, quantity, true);
                    });
                    
                    voiceStatus.textContent += ` → ${foundProducts.length} ürün eklendi`;
                } else {
                    voiceStatus.className = 'ml-1 text-sm text-red-600 mt-2';
                    voiceStatus.textContent = 'Ürün bulunamadı: ' + transcript;
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error', event.error);
                voiceBtn.classList.remove('voice-listening');
                voiceStatus.className = 'ml-1 text-sm text-red-600 mt-2';
                
                if (event.error === 'no-speech') {
                    voiceStatus.textContent = 'Ses algılanamadı';
                } else {
                    voiceStatus.textContent = 'Hata: ' + event.error;
                }
            };
            
            recognition.onend = function() {
                voiceBtn.classList.remove('voice-listening');
                setTimeout(() => {
                    voiceStatus.textContent = '';
                }, 5000);
            };
        }

        async function finalizeOrder(paymentMethod) {
            if (!currentProfile?.id) {
                showToast('Sipariş için lütfen giriş yapın', 'warning');
                return;
            }
            
            if (!cart.length) {
                showToast('Sepetinizde ürün bulunmuyor', 'warning');
                return;
            }
            
            // Check if seller is selected
            if (!sellerSelect.value) {
                showToast('Lütfen bir satıcı seçin', 'warning');
                return;
            }
            
            const items = cart.map(item => ({
                product_id: item.product_id,
                quantity: item.qty,
                unit_price: item.price
            }));
            
            let bonusToUse = 0;
            
            if (paymentMethod === 'bonus') {
                const { data } = await supabase
                    .from('referral_bonus_summary')
                    .select('kalan_bonus')
                    .eq('user_id', currentProfile.id)
                    .maybeSingle();
                    
                const availableBonus = data?.kalan_bonus || 0;
                
                if (availableBonus <= 0) {
                    showToast('Yeterli bonusunuz bulunmuyor', 'warning');
                    return;
                }
                
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
                bonusToUse = Math.min(availableBonus, subtotal);
            }
            
            try {
                showToast('Siparişiniz işleniyor...', 'info');
                
                const { data: orderId, error } = await supabase.rpc('create_order_with_bonus', {
                    p_user_id: currentProfile.id,
                    p_items: items,
                    p_bonus_used: bonusToUse,
                    p_payment_type: paymentMethod
                });
                
                if (error) {
                    console.error('Order error:', error);
                    showToast('Sipariş oluşturulamadı: ' + error.message, 'error');
                    return;
                }
                
                showToast(`Siparişiniz alındı! Sipariş No: ${orderId}`, 'success');
                
                // Clear cart and update UI
                cart = [];
                renderCart();
                updateCartCount();
                await loadReferralSummary();
                
                // Print receipt (simulated)
                setTimeout(() => {
                    alert(`Siparişiniz başarıyla oluşturuldu!\nSipariş No: ${orderId}\nÖdeme Yöntemi: ${paymentMethod}\nToplam Tutar: ${totalAmountEl.textContent}`);
                }, 500);
                
            } catch (err) {
                console.error('Error in finalizeOrder:', err);
                showToast('Sipariş sırasında bir hata oluştu: ' + err.message, 'error');
            }
        }
    </script>
</body>
</html>
