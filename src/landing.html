<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sesli Sipari≈ü Sistemi - Onur Market</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
 .fly { position:absolute; z-index:9999; transition: all 0.85s ease-in-out; pointer-events:none; }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0%{transform:rotate(0)}25%{transform:rotate(-8deg)}50%{transform:rotate(8deg)}75%{transform:rotate(-8deg)}100%{transform:rotate(0)}}
        .card { transition: transform .25s ease, box-shadow .25s ease; }
        .card:hover { transform: translateY(-6px) scale(1.02); box-shadow: 0 10px 25px rgba(0,0,0,0.12); }
        
        /* Mikrofon butonu ve sesli asistan stilleri */
        .voice-assistant {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #f59e0b;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
            z-index: 100;
        }
        
        .voice-assistant.listening {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.6); }
            70% { box-shadow: 0 0 0 15px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
        
        .voice-status {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 300px;
            z-index: 100;
            display: none;
        }
        
        .status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .status-title {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #1f2937;
        }
        
        .status-title i {
            margin-right: 8px;
            color: #f59e0b;
        }
        
        .status-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #6b7280;
        }
        
        .status-content {
            margin-bottom: 15px;
        }
        
        .assistant-message {
            padding: 12px;
            background: #f0f9ff;
            border-radius: 8px;
            margin-bottom: 10px;
            color: #374151;
        }
        
        .user-message {
            padding: 12px;
            background: #dbeafe;
            border-radius: 8px;
            text-align: right;
            color: #2563eb;
        }
        
        .voice-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 30px;
            margin-top: 10px;
        }
        
        .voice-bar {
            width: 6px;
            height: 10px;
            background: #ddd;
            margin: 0 3px;
            border-radius: 3px;
        }
        
        .listening .voice-bar {
            animation: voiceIndicator 0.8s infinite;
        }
        
        @keyframes voiceIndicator {
            0%, 100% { height: 10px; background: #ddd; }
            50% { height: 30px; background: #f59e0b; }
        }
        
        .microphone-toggle {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .microphone-toggle.listening {
            animation: pulse 1.5s infinite;
        }

		:root {
            --primary: #2563eb;
            --secondary: #10b981;
            --accent: #f59e0b;
            --dark: #1f2937;
            --light: #f9fafb;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .logo i {
            margin-right: 10px;
        }
        
        .user-info {
            text-align: right;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background: #f1f5f9;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .status-item {
            display: flex;
            align-items: center;
        }
        
        .status-item i {
            margin-right: 8px;
            color: var(--primary);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            padding: 20px;
        }
        
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
            color: var(--primary);
        }
        
        .filters select, .filters input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .profile-info div {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
        }
        
        .profile-info span {
            font-weight: 500;
        }
        
        .product-card {
background: white;
border-radius: 8px;
overflow: hidden;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
transition: transform 0.2s;
cursor: pointer;
}

.product-card:hover {
transform: translateY(-5px);
box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
}

.product-image {
height: 120px;
width: 100%;
object-fit: cover;
background: #f3f4f6;
}

.status-content {
margin-bottom: 15px;
}

.status-close {
background: none;
border: none;
font-size: 16px;
cursor: pointer;
color: #6b7280;
}


.product-info {
padding: 10px;
}

.product-name {
font-size: 14px;
font-weight: 500;
margin-bottom: 5px;
}

.assistant-message {
padding: 12px;
background: #f0f9ff;
border-radius: 8px;
margin-bottom: 10px;
color: #374151;
}
.product-price {
color: var(--primary);
font-weight: bold;
}

.product-discount {
color: #ef4444;
font-size: 12px;
text-decoration: line-through;
margin-left: 5px;
}

.cart-items {
max-height: 300px;
overflow-y: auto;
margin-bottom: 20px;
}

.voice-indicator {
display: flex;
align-items: center;
justify-content: center;
height: 30px;
margin-top: 10px;
}

.cart-item {
display: flex;
justify-content: space-between;
padding: 10px 0;
border-bottom: 1px solid #e5e7eb;
}

.cart-item-info {
flex: 1;
}

.cart-item-name {
font-weight: 500;
}

.cart-item-quantity {
color: #6b7280;
font-size: 14px;
}

.cart-item-price {
font-weight: bold;
color: var(--primary);
}

.cart-totals {
border-top: 2px solid #e5e7eb;
padding-top: 15px;
}

.total-row {
display: flex;
justify-content: space-between;
margin-bottom: 10px;
}

.grand-total {
font-weight: bold;
font-size: 18px;
color: var(--dark);
border-top: 1px solid #d1d5db;
padding-top: 10px;
}

.payment-options {
display: grid;
grid-template-columns: 1fr;
gap: 10px;
margin-top: 20px;
}

.payment-btn {
padding: 12px;
border-radius: 6px;
border: none;
color: white;
font-weight: 500;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
transition: background 0.2s;
}

.payment-btn i {
margin-right: 8px;
}

.cash-btn {
background: var(--secondary);
}

.cash-btn:hover {
background: #0d9669;
}

.card-btn {
background: var(--primary);
}

.card-btn:hover {
background: #1d4ed8;
}

.bonus-btn {
background: #8b5cf6;
}

.bonus-btn:hover {
background: #7c3aed;
}

.voice-assistant {
position: fixed;
bottom: 20px;
right: 20px;
width: 60px;
height: 60px;
border-radius: 50%;
background: var(--accent);
color: white;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
z-index: 100;
animation: pulse 2s infinite;
}

@keyframes pulse {
0% { transform: scale(1); }
50% { transform: scale(1.05); }
100% { transform: scale(1); }
}

.listening .voice-assistant {
animation: listening 1.5s infinite;
}

@keyframes listening {
0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.6); }
70% { box-shadow: 0 0 0 15px rgba(245, 158, 11, 0); }
100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
}

.voice-status {
position: fixed;
bottom: 90px;
right: 20px;
background: white;
padding: 10px 15px;
border-radius: 8px;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
max-width: 300px;
display: none;
}

.assistant-message {
font-weight: 500;
color: var(--dark);
padding: 12px;
background: #f0f9ff;
border-radius: 8px;
margin-bottom: 10px;
color: #374151;
}

.user-message {
text-align: right;
color: var(--primary);
margin-top: 5px;
padding: 12px;
background: #dbeafe;
border-radius: 8px;
}

.selected {
border: 2px solid var(--secondary) !important;
background: #f0fdf4 !important;
}

.order-status {
margin-top: 20px;
padding: 15px;
background: #f0f9ff;
border-radius: 8px;
border-left: 4px solid var(--primary);
}

.status-title {
font-weight: 600;
margin-bottom: 10px;
display: flex;
align-items: center;
color: var(--dark);
}

.status-title i {
margin-right: 8px;
color: var(--primary);
}

.status-progress {
height: 6px;
background: #dbeafe;
border-radius: 3px;
overflow: hidden;
margin: 10px 0;
}

.status-progress-bar {
height: 100%;
background: var(--primary);
width: 0%;
transition: width 0.5s;
}

.status-steps {
display: flex;
justify-content: space-between;
font-size: 12px;
color: #6b7280;
}

.status-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 10px;
padding-bottom: 10px;
border-bottom: 1px solid #e5e7eb;
}

@media (max-width: 900px) {
.main-content {
grid-template-columns: 1fr;
}

.voice-bar {
width: 6px;
height: 10px;
background: #ddd;
margin: 0 3px;
border-radius: 3px;
animation: voiceIndicator 1.5s infinite;
}

.voice-bar:nth-child(2) {
animation-delay: 0.2s;
}

.voice-bar:nth-child(3) {
animation-delay: 0.4s;
}

.voice-bar:nth-child(4) {
animation-delay: 0.6s;
}

.voice-bar:nth-child(5) {
animation-delay: 0.8s;
}

@keyframes voiceIndicator {
0%, 100% { height: 10px; background: #ddd; }
50% { height: 30px; background: var(--accent); }
}

.listening .voice-bar {
animation: voiceIndicator 0.8s infinite;
}

.permission-help {
margin-top: 20px;
padding: 15px;
background: #fffbeb;
border-radius: 8px;
border-left: 4px solid var(--accent);
}

.help-title {
font-weight: 600;
margin-bottom: 10px;
color: var(--dark);
display: flex;
align-items: center;
}

.help-title i {
margin-right: 8px;
color: var(--accent);
}

.help-steps {
padding-left: 20px;
margin-bottom: 10px;
}

.help-steps li {
margin-bottom: 8px;
color: #6b7280;
}

.browser-support {
display: flex;
justify-content: space-around;
margin-top: 15px;
}

.browser-item {
display: flex;
flex-direction: column;
align-items: center;
font-size: 12px;
color: #6b7280;
}

.browser-item i {
font-size: 24px;
margin-bottom: 5px;
color: var(--primary);
   }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-store"></i>
                <span>Onur Market Sesli Sipari≈ü</span>
            </div>
             
			
	
		<div id="userBox" class="text-right">
      <div id="userName" class="font-semibold">Giri≈ü yapƒ±lmadƒ±</div>
      <div id="userMeta" class="text-sm text-gray-500"></div>
    </div>
			 <button id="microphoneToggle" class="microphone-toggle">
        <i class="fas fa-microphone-slash"></i>
        <span>Mikrofon (Kapalƒ±)</span>
    </button>
        </header>
        
       <main class="grid grid-cols-1 lg:grid-cols-4 gap-6">

    <!-- LEFT: Seller & Filter	s -->
    <aside class="col-span-1 bg-white rounded shadow p-4">
      <h2 class="font-semibold mb-2">Satƒ±cƒ± & Filtreler</h2>

      <div class="mb-3">
        <label class="block text-sm text-gray-600 mb-1">Satƒ±cƒ±nƒ±z (lokasyona g√∂re)</label>
        <select id="sellerSelect" class="w-full border rounded px-3 py-2">
          <option value="">-- Satƒ±cƒ± se√ßin --</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="block text-sm text-gray-600 mb-1">Reyon</label>
        <select id="reyonSelect" class="w-full border rounded px-3 py-2">
          <option value="">-- Reyon se√ßin --</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="block text-sm text-gray-600 mb-1">Kategori</label>
        <select id="categorySelect" class="w-full border rounded px-3 py-2">
          <option value="">-- Kategori se√ßin --</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="block text-sm text-gray-600 mb-1">√úr√ºn</label>
        <select id="productSelect" class="w-full border rounded px-3 py-2">
          <option value="">-- √úr√ºn se√ßin --</option>
        </select>
      </div>

      <div class="flex gap-2">
        <button id="btnLoadProducts" class="bg-green-600 text-white px-3 py-2 rounded">√úr√ºnleri Y√ºkle</button>
        <button id="btnShareRef" class="bg-blue-600 text-white px-3 py-2 rounded flex-1">Referans Linki G√∂nder</button>
      </div>

      <hr class="my-3" />

      <div>
        <h3 class="text-sm font-semibold mb-1">Profilim</h3>
        <div id="profileInfo" class="text-sm text-gray-700">
          <div>Adƒ± Soyadƒ±: <span id="p_name">-</span></div>
          <div>Telefon: <span id="p_phone">-</span></div>
          <div>Rol: <span id="p_role">-</span></div>
          <div>Adres / ≈ûehir: <span id="p_address">-</span> / <span id="p_city">-</span></div>
          <div class="mt-2">Bonus Kalan: <strong id="p_bonus">0 ‚Ç∫</strong></div>
        </div>
      </div>
    </aside>

    <!-- MIDDLE: Products -->
    <section class="col-span-2 bg-white rounded shadow p-4">
      <div class="flex items-center justify-between mb-4">
        <div>
          <input id="voiceBtn" type="button" class="px-3 py-2 bg-yellow-500 rounded text-white" value="Sesle Sipari≈ü Ba≈ülat (Dinle)">
          <span id="voiceStatus" class="ml-3 text-sm text-gray-500"></span>
        </div>
        <div class="text-sm text-gray-600">Reyon ‚Üí Kategori ‚Üí √úr√ºn se√ßerek veya sesle √ºr√ºn ekleyin</div>
      </div>

      <div id="productsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        <div class="flex flex-col items-center justify-center p-8 text-gray-400">
          <i class="fas fa-box-open text-4xl mb-3"></i>
          <p>Satƒ±cƒ± se√ßerek √ºr√ºnleri g√∂r√ºnt√ºleyin</p>
        </div>
      </div>
    </section>

    <!-- RIGHT: Cart -->
    <aside class="col-span-1 bg-white rounded shadow p-4">
      <h2 class="font-semibold mb-2">Sepet</h2>
      <div id="cartList" class="space-y-2 max-h-[420px] overflow-y-auto mb-3">
        <div class="text-sm text-gray-500">Sepete √ºr√ºn ekleyin</div>
      </div>

      <div class="border-t pt-3">
        <div class="flex justify-between">
          <div>Ara Toplam</div><div id="subtotal">0 ‚Ç∫</div>
        </div>
        <div class="flex justify-between">
          <div>ƒ∞ndirim</div><div id="discount">0 ‚Ç∫</div>
        </div>
        <div class="flex justify-between">
          <div>KDV (<span id="vatRate">18</span>%)</div><div id="vatAmount">0 ‚Ç∫</div>
        </div>
        <div class="flex justify-between font-bold mt-2">
          <div>Genel Toplam</div><div id="totalAmount">0 ‚Ç∫</div>
        </div>

        <div class="mt-3 space-y-2">
          <button id="payCash" class="w-full bg-green-600 text-white py-2 rounded">Kapƒ±da Nakit</button>
          <button id="payCard" class="w-full bg-blue-600 text-white py-2 rounded">Kapƒ±da Kredi Kartƒ±</button>
          <button id="payBonus" class="w-full bg-purple-600 text-white py-2 rounded">Bonus ile √ñdeme</button>
        </div>
      </div>
    </aside>

  </main>
</div>

<!-- Sesli Asistan -->
<div class="voice-status" id="voiceStatusPanel">
    <div class="status-header">
        <div class="status-title">
            <i class="fas fa-microphone"></i>
            <span>Sesli Asistan</span>
        </div>
        <button class="status-close" id="closeVoiceStatus">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="status-content">
        <div class="assistant-message" id="assistantMessage">Mikrofon eri≈üimi i√ßin l√ºtfen butona tƒ±klayƒ±n.</div>
        <div class="user-message" id="userMessage"></div>
    </div>
    <div class="voice-indicator" id="voiceIndicator">
        <div class="voice-bar"></div>
        <div class="voice-bar"></div>
        <div class="voice-bar"></div>
        <div class="voice-bar"></div>
        <div class="voice-bar"></div>
    </div>
</div>
<script>
// Supabase configuration
const SUPABASE_URL = "https://xliutvspwodhoaxvysks.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsaXV0dnNwd29kaG9heHZ5c2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTgyOTksImV4cCI6MjA3MjkzNDI5OX0.Zodisa_ifP8t2Q4X0ecnB56RiR_Bg4QS5gvPn5ZLK_w";

// Initialize Supabase client
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Global state
let currentUser = null;
let currentProfile = null;
let sellers = [];
let reyonlar = [];
let categories = [];
let products = [];
let cart = [];
let recognition = null;
let isListening = false;
let isMicrophoneEnabled = false;
let voiceCode = null;
let conversationStep = 0;
let currentPaymentMethod = null;
let orderStatusInterval = null;

// DOM Elements
const userNameEl = document.getElementById("userName");
const userMetaEl = document.getElementById("userMeta");
const p_name = document.getElementById("p_name");
const p_phone = document.getElementById("p_phone");
const p_role = document.getElementById("p_role");
const p_address = document.getElementById("p_address");
const p_city = document.getElementById("p_city");
const p_bonus = document.getElementById("p_bonus");
const sellerSelect = document.getElementById("sellerSelect");
const reyonSelect = document.getElementById("reyonSelect");
const categorySelect = document.getElementById("categorySelect");
const productSelect = document.getElementById("productSelect");
const productsGrid = document.getElementById("productsGrid");
const cartList = document.getElementById("cartList");
const subtotalEl = document.getElementById("subtotal");
const discountEl = document.getElementById("discount");
const vatAmountEl = document.getElementById("vatAmount");
const totalAmountEl = document.getElementById("totalAmount");
const btnLoadProducts = document.getElementById("btnLoadProducts");
const btnShareRef = document.getElementById("btnShareRef");
const voiceBtn = document.getElementById("voiceBtn");
const voiceStatus = document.getElementById("voiceStatus");
const microphoneToggle = document.getElementById('microphoneToggle');
const assistantMessage = document.getElementById('assistantMessage');
const userMessage = document.getElementById('userMessage');
const voiceIndicator = document.getElementById('voiceIndicator');
const closeVoiceStatus = document.getElementById('closeVoiceStatus');
const voiceStatusPanel = document.getElementById('voiceStatusPanel');

// Utility functions
function money(n){ return Number(n||0).toLocaleString('tr-TR',{minimumFractionDigits:2, maximumFractionDigits:2}) + ' ‚Ç∫'; }

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    initApp();
});

async function initApp() {
    await loadSessionAndProfile();
    await loadSellersByLocation();
    setupEventHandlers();
    await loadReferralSummary();
    
    // Sesli asistanƒ± ba≈ülat
    initVoiceAssistant();
}

// Sesli asistanƒ± ba≈ülat
function initVoiceAssistant() {
    // Sesli asistan event listener'larƒ±
    microphoneToggle.addEventListener('click', toggleMicrophone);
    closeVoiceStatus.addEventListener('click', hideVoiceStatus);
    
    // Sayfa y√ºklendiƒüinde sesli asistanƒ± g√∂ster
    setTimeout(() => {
        showVoiceStatus();
        speakToUser("Merhaba! Onur Market Sesli Sipari≈ü sistemine ho≈ü geldiniz. Mikrofon butonuna tƒ±klayarak sesli sipari≈ü verebilirsiniz.");
    }, 1000);
}

// Mikrofonu a√ß/kapa
function toggleMicrophone() {
    if (isMicrophoneEnabled) {
        disableMicrophone();
    } else {
        enableMicrophone();
    }
}

// Mikrofon iznini kontrol et
async function checkMicrophonePermission() {
    try {
        // Mikrofon eri≈üim durumunu kontrol et
        if (navigator.permissions) {
            const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
            
            if (permissionStatus.state === 'granted') {
                // ƒ∞zin zaten verilmi≈ü
                enableMicrophone();
            } else {
                // ƒ∞zin verilmemi≈ü veya sorulmamƒ±≈ü
                disableMicrophone();
            }
            
            // ƒ∞zin durumu deƒüi≈ütiƒüinde
            permissionStatus.onchange = function() {
                if (permissionStatus.state === 'granted') {
                    enableMicrophone();
                } else {
                    disableMicrophone();
                }
            };
        }
    } catch (error) {
        console.error('Mikrofon izni kontrol hatasƒ±:', error);
        // Fallback: Doƒürudan mikrofon eri≈üimini dene
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            enableMicrophone();
            stream.getTracks().forEach(track => track.stop());
        } catch (err) {
            disableMicrophone();
        }
    }
}

// Mikrofonu etkinle≈ütir
async function enableMicrophone() {
    try {
        // Mikrofon eri≈üim isteƒüi g√∂nder
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Mikrofon etkin
        isMicrophoneEnabled = true;
        microphoneToggle.innerHTML = '<i class="fas fa-microphone"></i> <span>Mikrofon (A√ßƒ±k)</span>';
        microphoneToggle.classList.add('listening');
        
        // Ses tanƒ±ma ba≈ülat
        initializeSpeechRecognition();
        
        // Kullanƒ±cƒ±ya bildir
        assistantMessage.textContent = "Mikrofon eri≈üimi saƒülandƒ±. L√ºtfen 'Merhaba' diyerek sistemi ba≈ülatƒ±n.";
        speakToUser("Mikrofon eri≈üimi saƒülandƒ±. L√ºtfen merhaba diyerek sistemi ba≈ülatƒ±n.");
        
        // Mikrofon stream'ini serbest bƒ±rak (sadece izin i√ßin kullandƒ±k)
        stream.getTracks().forEach(track => track.stop());
        
    } catch (error) {
        console.error("Mikrofon eri≈üim hatasƒ±:", error);
        
        let errorMessage = "Mikrofon eri≈üimi saƒülanamadƒ±. ";
        if (error.name === "NotAllowedError") {
            errorMessage += "L√ºtfen tarayƒ±cƒ± ayarlarƒ±nƒ±zdan mikrofon eri≈üimine izin verin.";
        } else if (error.name === "NotFoundError") {
            errorMessage += "Mikrofon cihazƒ± bulunamadƒ±.";
        } else if (error.name === "NotReadableError") {
            errorMessage += "Mikrofon ba≈üka bir uygulama tarafƒ±ndan kullanƒ±lƒ±yor.";
        } else {
            errorMessage += "Beklenmeyen bir hata olu≈ütu.";
        }
        
        assistantMessage.textContent = errorMessage;
        disableMicrophone();
    }
}

// Mikrofonu devre dƒ±≈üƒ± bƒ±rak
function disableMicrophone() {
    isMicrophoneEnabled = false;
    microphoneToggle.innerHTML = '<i class="fas fa-microphone-slash"></i> <span>Mikrofon (Kapalƒ±)</span>';
    microphoneToggle.classList.remove('listening');
    
    // Ses tanƒ±mayƒ± durdur
    if (recognition) {
        recognition.stop();
    }
    
    // Ses g√∂stergesini sƒ±fƒ±rla
    voiceIndicator.classList.remove('listening');
    
    // Kullanƒ±cƒ±ya bildir
    assistantMessage.textContent = "Mikrofon eri≈üimi kapalƒ±. Sesli sipari≈ü i√ßin l√ºtfen mikrofon eri≈üimine izin verin.";
}

// Ses tanƒ±ma sistemini ba≈ülat
function initializeSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (!SpeechRecognition) {
        assistantMessage.textContent = "Tarayƒ±cƒ±nƒ±z ses tanƒ±ma √∂zelliƒüini desteklemiyor";
        return;
    }
    
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.lang = 'tr-TR';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    
    recognition.onstart = function() {
        isListening = true;
        voiceIndicator.classList.add('listening');
        voiceStatus.textContent = "Dinleniyor...";
        assistantMessage.textContent = "Dinliyorum...";
    };
    
    recognition.onresult = function(event) {
        const transcript = event.results[event.results.length - 1][0].transcript;
        userMessage.textContent = transcript;
        
        // Sesli komutlarƒ± i≈üle
        processVoiceCommand(transcript.toLowerCase());
    };
    
    recognition.onerror = function(event) {
        console.error('Ses tanƒ±ma hatasƒ±:', event.error);
        
        if (event.error === 'not-allowed') {
            assistantMessage.textContent = "Mikrofon eri≈üimine izin verilmedi. L√ºtfen tarayƒ±cƒ± ayarlarƒ±nƒ±zdan izin verin.";
            disableMicrophone();
        } else {
            assistantMessage.textContent = "Ses tanƒ±ma hatasƒ±: " + event.error;
        }
        
        isListening = false;
        voiceIndicator.classList.remove('listening');
    };
    
    recognition.onend = function() {
        isListening = false;
        voiceIndicator.classList.remove('listening');
        
        // Mikrofon hala a√ßƒ±ksa yeniden ba≈ülat
        if (isMicrophoneEnabled) {
            setTimeout(() => {
                if (!isListening) {
                    recognition.start();
                }
            }, 500);
        }
    };
    
    // Ses tanƒ±mayƒ± ba≈ülat
    recognition.start();
}

// Sesli komutlarƒ± i≈üle
function processVoiceCommand(transcript) {
    switch(conversationStep) {
        case 0: // ƒ∞lk kar≈üƒ±lama
            if (transcript.includes('merhaba')) {
                speakToUser("Merhaba efendim! Ho≈ü geldiniz. Sesi tanƒ±yorum, profiliniz y√ºkleniyor.");
                // Ses kodu ile kullanƒ±cƒ±yƒ± bulmaya √ßalƒ±≈ü
                findUserByVoiceCode();
            } else {
                speakToUser("√ñnce 'Merhaba' diyerek ba≈ülayalƒ±m mƒ±?");
            }
            break;
        case 1: // Telefon numarasƒ± isteme
            const phoneMatch = transcript.match(/\d+/g);
            if (phoneMatch) {
                const phone = phoneMatch.join('');
                document.getElementById('p_phone').textContent = phone;
                checkUserByPhone(phone);
            } else {
                speakToUser("Telefon numaranƒ±zƒ± anlayamadƒ±m. L√ºtfen numaranƒ±zƒ± s√∂yler misiniz?");
            }
            break;
        case 2: // Yeni kullanƒ±cƒ± kaydƒ± - ƒ∞sim
            document.getElementById('p_name').textContent = transcript;
            speakToUser("Te≈üekk√ºrler. Hangi ≈üehirden alƒ±≈üveri≈ü yapmak istiyorsunuz?");
            conversationStep = 3;
            break;
        case 3: // Yeni kullanƒ±cƒ± kaydƒ± - ≈ûehir
            document.getElementById('p_city').textContent = transcript;
            speakToUser("Tamam. Son olarak, adresinizi √∂ƒürenebilir miyim?");
            conversationStep = 4;
            break;
        case 4: // Yeni kullanƒ±cƒ± kaydƒ± - Adres
            document.getElementById('p_address').textContent = transcript;
            speakToUser("Te≈üekk√ºrler. Konumunuz belirleniyor ve profiliniz olu≈üturuluyor.");
            // Konum bilgisini al ve profili kaydet
            getLocationFromAddress(transcript);
            conversationStep = 5;
            break;
        case 5: // Profil olu≈üturuldu, satƒ±cƒ±lar y√ºkleniyor
            // Satƒ±cƒ±larƒ± y√ºkle
            loadSellersByLocation();
            break;
        default:
            // Normal sipari≈ü s√ºreci
            processOrderCommand(transcript);
            break;
    }
}

// Kullanƒ±cƒ±ya sesli yanƒ±t ver
function speakToUser(message) {
    assistantMessage.textContent = message;
    
    // Tarayƒ±cƒ± ses sentezleme API'si
    if ('speechSynthesis' in window) {
        const speech = new SpeechSynthesisUtterance(message);
        speech.lang = 'tr-TR';
        speech.volume = 1;
        speech.rate = 1;
        speech.pitch = 1;
        
        window.speechSynthesis.speak(speech);
    }
}

// Ses durumu kutusunu g√∂ster
function showVoiceStatus() {
    voiceStatusPanel.style.display = 'block';
}

// Ses durumu kutusunu gizle
function hideVoiceStatus() {
    voiceStatusPanel.style.display = 'none';
}

// ORƒ∞Jƒ∞NAL FONKSƒ∞YONLAR
async function loadSessionAndProfile(){
    const { data: sessionData } = await supabase.auth.getSession();
    const session = sessionData?.session;
    if(!session?.user){
        userNameEl.textContent = "Giri≈ü yapƒ±lmadƒ±";
        userMetaEl.textContent = "L√ºtfen giri≈ü yapƒ±n.";
        return;
    }
    currentUser = session.user;
    const { data: profile } = await supabase
        .from('profiles')
        .select('id, full_name, role, phone, address, city, location')
        .eq('id', currentUser.id)
        .maybeSingle();
    currentProfile = profile;
    userNameEl.textContent = profile?.full_name || currentUser.email || "Kullanƒ±cƒ±";
    userMetaEl.textContent = profile?.city ? `${profile.city} ‚Ä¢ ${profile.location || ''}` : '';
    p_name.textContent = profile?.full_name || '-';
    p_phone.textContent = profile?.phone || '-';
    p_role.textContent = profile?.role || '-';
    p_address.textContent = profile?.address || '-';
    p_city.textContent = profile?.city || '-';
}

async function loadSellersByLocation(){
    if(!currentProfile?.location){
        sellerSelect.innerHTML = '<option value="">-- Lokasyon yok --</option>';
        return;
    }
    const { data, error } = await supabase
        .from('profiles')
        .select('id, full_name, phone, city, location')
        .eq('role','market')
        .eq('location', currentProfile.location)
        .limit(100);
    if(error){ console.error(error); return; }
    sellers = data || [];
    sellerSelect.innerHTML = '<option value="">-- Satƒ±cƒ± se√ßin --</option>';
    sellers.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.full_name || s.phone || s.id;
        sellerSelect.appendChild(opt);
    });
}

function setupEventHandlers(){
    sellerSelect.addEventListener('change', e=>{
        if(e.target.value) loadSellerData(e.target.value);
        else productsGrid.innerHTML='';
    });
    btnLoadProducts?.addEventListener('click', ()=>{ if(sellerSelect.value) loadSellerData(sellerSelect.value); });
    document.getElementById('payCash')?.addEventListener('click', ()=>finalizeOrder('nakit'));
    document.getElementById('payCard')?.addEventListener('click', ()=>finalizeOrder('kart'));
    document.getElementById('payBonus')?.addEventListener('click', ()=>finalizeOrder('bonus'));
    
    // Sesli sipari≈ü butonu
    voiceBtn?.addEventListener('click', ()=>{
        if(!('webkitSpeechRecognition' in window)) return alert('Tarayƒ±cƒ± desteklemiyor.');
        const recognition = new webkitSpeechRecognition();
        recognition.lang = 'tr-TR';
        recognition.start();
        voiceStatus.textContent = 'Dinleniyor...';
        recognition.onresult = (e)=>{
            const spoken = e.results[0][0].transcript.toLowerCase();
            const prod = products.find(p=>spoken.includes(p.name.toLowerCase()));
            if(prod){
                const qtyMatch = spoken.match(/(\d+)/);
                const qty = qtyMatch ? parseInt(qtyMatch[1]):1;
                addToCartByProduct(prod,qty,true);
                voiceStatus.textContent = `Sepete eklendi: ${prod.name} x${qty}`;
            }else voiceStatus.textContent = '√úr√ºn bulunamadƒ±.';
        };
        recognition.onend = ()=>{ voiceStatus.textContent = 'Dinleme durdu'; };
    });
}

async function loadReferralSummary(){
    if(!currentProfile?.id) return;
    const { data } = await supabase
        .from('referral_bonus_summary')
        .select('kalan_bonus')
        .eq('user_id', currentProfile.id)
        .maybeSingle();
    const kalan = data?.kalan_bonus||0;
    p_bonus.textContent = money(kalan);
}

// Diƒüer orijinal fonksiyonlar buraya gelecek...

// √ñrnek fonksiyonlar - ger√ßek uygulamada tam implementasyon gerekli
function findUserByVoiceCode() {
    console.log("Ses kodu ile kullanƒ±cƒ± bulunuyor...");
}

function checkUserByPhone(phone) {
    console.log("Telefon ile kullanƒ±cƒ± kontrol ediliyor...");
}

function getLocationFromAddress(address) {
    console.log("Adres konuma √ßevriliyor...");
}

function processOrderCommand(transcript) {
    console.log("Sipari≈ü komutu i≈üleniyor:", transcript);
}

function addToCart(product, quantity) {
    console.log("Sepete ekleniyor:", product, quantity);
}

function updateCartUI() {
    console.log("Sepet g√ºncelleniyor...");
}

function completeOrder() {
    console.log("Sipari≈ü tamamlanƒ±yor...");
}

function selectPaymentMethod(method) {
    console.log("√ñdeme y√∂ntemi se√ßiliyor:", method);
}

function simulateOrderStatus() {
    console.log("Sipari≈ü durumu sim√ºle ediliyor...");
}

function identifyUserByVoice() {
    console.log("Ses ile kullanƒ±cƒ± tanƒ±mlanƒ±yor...");
}
</script>
</body>
</html>
