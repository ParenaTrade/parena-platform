<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Deploy Silme</title>
<style>
table { border-collapse: collapse; width: 100%; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
</style>
</head>
<body>

<h2>Deploy Yönetimi</h2>

<label>Başlangıç Tarihi: <input type="date" id="startDate"></label>
<label>Bitiş Tarihi: <input type="date" id="endDate"></label>
<button id="filterBtn">Tarihe Göre Listele</button>
<button id="selectAllBtn">Hepsini Seç</button>
<button id="deselectAllBtn">Seçimleri Kaldır</button>
<button id="deleteBtn">Seçilenleri Sil</button>

<table id="deployTable">
  <thead>
    <tr>
      <th>Seç</th>
      <th>Deploy Adı</th>
      <th>Tarih</th>
      <th>Durum</th>
      <th>ID</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
async function fetchDeploys() {
  const res = await fetch("http://localhost:3000/deployments");
  return await res.json();
}

function renderDeployTable(deploys) {
  const tbody = document.querySelector("#deployTable tbody");
  tbody.innerHTML = "";
  deploys.forEach(d => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" class="deployCheckbox" data-id="${d.uid || d.id}"></td>
      <td>${d.name}</td>
      <td>${new Date(d.created).toLocaleString()}</td>
      <td>${d.state}</td>
      <td>${d.uid || d.id}</td>
    `;
    tbody.appendChild(tr);
  });
}

document.getElementById("filterBtn").addEventListener("click", async () => {
  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;
  if(!startDate || !endDate){ alert("Tarihleri seçin"); return; }

  const allDeploys = await fetchDeploys();
  const filtered = allDeploys.filter(d => {
    const date = new Date(d.created);
    return date >= new Date(startDate) && date <= new Date(endDate);
  });
  renderDeployTable(filtered);
});

document.getElementById("selectAllBtn").addEventListener("click", () => {
  document.querySelectorAll(".deployCheckbox").forEach(cb => cb.checked = true);
});

document.getElementById("deselectAllBtn").addEventListener("click", () => {
  document.querySelectorAll(".deployCheckbox").forEach(cb => cb.checked = false);
});

document.getElementById("deleteBtn").addEventListener("click", async () => {
  const selected = [...document.querySelectorAll(".deployCheckbox:checked")].map(cb => cb.dataset.id);
  if(!selected.length){ alert("Seçili deploy yok"); return; }

  const res = await fetch("http://localhost:3000/delete", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ids: selected })
  });
  const result = await res.json();
  alert(result.message);

  // Listeyi güncelle
  document.getElementById("filterBtn").click();
});
</script>

</body>
</html>
